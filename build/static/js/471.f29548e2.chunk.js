"use strict";(self.webpackChunkgmdevstore=self.webpackChunkgmdevstore||[]).push([[471],{3471:(t,e,r)=>{r.d(e,{A:()=>py});var n=r(9408);function i(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const r=null!==t[0].index,i=new Set(Object.keys(t[0].attributes)),o=new Set(Object.keys(t[0].morphAttributes)),s={},l={},h=t[0].morphTargetsRelative,c=new n.BufferGeometry;let u=0;for(let n=0;n<t.length;++n){const a=t[n];let d=0;if(r!==(null!==a.index))return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed with geometry at index "+n+". All geometries must have compatible attributes; make sure index attribute exists among all geometries, or in none of them."),null;for(const t in a.attributes){if(!i.has(t))return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed with geometry at index "+n+'. All geometries must have compatible attributes; make sure "'+t+'" attribute exists among all geometries, or in none of them.'),null;void 0===s[t]&&(s[t]=[]),s[t].push(a.attributes[t]),d++}if(d!==i.size)return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed with geometry at index "+n+". Make sure all geometries have the same number of attributes."),null;if(h!==a.morphTargetsRelative)return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed with geometry at index "+n+". .morphTargetsRelative must be consistent throughout all geometries."),null;for(const t in a.morphAttributes){if(!o.has(t))return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed with geometry at index "+n+".  .morphAttributes must be consistent throughout all geometries."),null;void 0===l[t]&&(l[t]=[]),l[t].push(a.morphAttributes[t])}if(c.userData.mergedUserData=c.userData.mergedUserData||[],c.userData.mergedUserData.push(a.userData),e){let t;if(r)t=a.index.count;else{if(void 0===a.attributes.position)return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed with geometry at index "+n+". The geometry must have either an index or a position attribute"),null;t=a.attributes.position.count}c.addGroup(u,t,n),u+=t}}if(r){let e=0;const r=[];for(let n=0;n<t.length;++n){const i=t[n].index;for(let t=0;t<i.count;++t)r.push(i.getX(t)+e);e+=t[n].attributes.position.count}c.setIndex(r)}for(const n in s){const t=a(s[n]);if(!t)return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed while trying to merge the "+n+" attribute."),null;c.setAttribute(n,t)}for(const n in l){const t=l[n][0].length;if(0===t)break;c.morphAttributes=c.morphAttributes||{},c.morphAttributes[n]=[];for(let e=0;e<t;++e){const t=[];for(let i=0;i<l[n].length;++i)t.push(l[n][i][e]);const r=a(t);if(!r)return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed while trying to merge the "+n+" morphAttribute."),null;c.morphAttributes[n].push(r)}}return c}function a(t){let e,r,i,a=0;for(let n=0;n<t.length;++n){const o=t[n];if(o.isInterleavedBufferAttribute)return console.error("THREE.BufferGeometryUtils: .mergeBufferAttributes() failed. InterleavedBufferAttributes are not supported."),null;if(void 0===e&&(e=o.array.constructor),e!==o.array.constructor)return console.error("THREE.BufferGeometryUtils: .mergeBufferAttributes() failed. BufferAttribute.array must be of consistent array types across matching attributes."),null;if(void 0===r&&(r=o.itemSize),r!==o.itemSize)return console.error("THREE.BufferGeometryUtils: .mergeBufferAttributes() failed. BufferAttribute.itemSize must be consistent across matching attributes."),null;if(void 0===i&&(i=o.normalized),i!==o.normalized)return console.error("THREE.BufferGeometryUtils: .mergeBufferAttributes() failed. BufferAttribute.normalized must be consistent across matching attributes."),null;a+=o.array.length}const o=new e(a);let s=0;for(let n=0;n<t.length;++n)o.set(t[n].array,s),s+=t[n].array.length;return new n.BufferAttribute(o,r,i)}const o=new WeakMap;class s extends n.Loader{constructor(t){super(t),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(t){return this.decoderPath=t,this}setDecoderConfig(t){return this.decoderConfig=t,this}setWorkerLimit(t){return this.workerLimit=t,this}load(t,e,r,i){const a=new n.FileLoader(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(t,(t=>{const r={attributeIDs:this.defaultAttributeIDs,attributeTypes:this.defaultAttributeTypes,useUniqueIDs:!1};this.decodeGeometry(t,r).then(e).catch(i)}),r,i)}decodeDracoFile(t,e,r,n){const i={attributeIDs:r||this.defaultAttributeIDs,attributeTypes:n||this.defaultAttributeTypes,useUniqueIDs:!!r};this.decodeGeometry(t,i).then(e)}decodeGeometry(t,e){for(const o in e.attributeTypes){const t=e.attributeTypes[o];void 0!==t.BYTES_PER_ELEMENT&&(e.attributeTypes[o]=t.name)}const r=JSON.stringify(e);if(o.has(t)){const e=o.get(t);if(e.key===r)return e.promise;if(0===t.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let n;const i=this.workerNextTaskID++,a=t.byteLength,s=this._getWorker(i,a).then((r=>(n=r,new Promise(((r,a)=>{n._callbacks[i]={resolve:r,reject:a},n.postMessage({type:"decode",id:i,taskConfig:e,buffer:t},[t])}))))).then((t=>this._createGeometry(t.geometry)));return s.catch((()=>!0)).then((()=>{n&&i&&this._releaseTask(n,i)})),o.set(t,{key:r,promise:s}),s}_createGeometry(t){const e=new n.BufferGeometry;t.index&&e.setIndex(new n.BufferAttribute(t.index.array,1));for(let r=0;r<t.attributes.length;r++){const i=t.attributes[r],a=i.name,o=i.array,s=i.itemSize;e.setAttribute(a,new n.BufferAttribute(o,s))}return e}_loadLibrary(t,e){const r=new n.FileLoader(this.manager);return r.setPath(this.decoderPath),r.setResponseType(e),r.setWithCredentials(this.withCredentials),new Promise(((e,n)=>{r.load(t,e,void 0,n)}))}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const t="object"!==typeof WebAssembly||"js"===this.decoderConfig.type,e=[];return t?e.push(this._loadLibrary("draco_decoder.js","text")):(e.push(this._loadLibrary("draco_wasm_wrapper.js","text")),e.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(e).then((e=>{const r=e[0];t||(this.decoderConfig.wasmBinary=e[1]);const n=l.toString(),i=["/* draco decoder */",r,"","/* worker */",n.substring(n.indexOf("{")+1,n.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([i]))})),this.decoderPending}_getWorker(t,e){return this._initDecoder().then((()=>{if(this.workerPool.length<this.workerLimit){const t=new Worker(this.workerSourceURL);t._callbacks={},t._taskCosts={},t._taskLoad=0,t.postMessage({type:"init",decoderConfig:this.decoderConfig}),t.onmessage=function(e){const r=e.data;switch(r.type){case"decode":t._callbacks[r.id].resolve(r);break;case"error":t._callbacks[r.id].reject(r);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+r.type+'"')}},this.workerPool.push(t)}else this.workerPool.sort((function(t,e){return t._taskLoad>e._taskLoad?-1:1}));const r=this.workerPool[this.workerPool.length-1];return r._taskCosts[t]=e,r._taskLoad+=e,r}))}_releaseTask(t,e){t._taskLoad-=t._taskCosts[e],delete t._callbacks[e],delete t._taskCosts[e]}debug(){console.log("Task load: ",this.workerPool.map((t=>t._taskLoad)))}dispose(){for(let t=0;t<this.workerPool.length;++t)this.workerPool[t].terminate();return this.workerPool.length=0,this}}function l(){let t,e;function r(t,e,r,n,i,a){const o=a.num_components(),s=r.num_points()*o,l=s*i.BYTES_PER_ELEMENT,h=function(t,e){switch(e){case Float32Array:return t.DT_FLOAT32;case Int8Array:return t.DT_INT8;case Int16Array:return t.DT_INT16;case Int32Array:return t.DT_INT32;case Uint8Array:return t.DT_UINT8;case Uint16Array:return t.DT_UINT16;case Uint32Array:return t.DT_UINT32}}(t,i),c=t._malloc(l);e.GetAttributeDataArrayForAllPoints(r,a,h,l,c);const u=new i(t.HEAPF32.buffer,c,s).slice();return t._free(c),{name:n,array:u,itemSize:o}}onmessage=function(n){const i=n.data;switch(i.type){case"init":t=i.decoderConfig,e=new Promise((function(e){t.onModuleLoaded=function(t){e({draco:t})},DracoDecoderModule(t)}));break;case"decode":const n=i.buffer,a=i.taskConfig;e.then((t=>{const e=t.draco,o=new e.Decoder,s=new e.DecoderBuffer;s.Init(new Int8Array(n),n.byteLength);try{const t=function(t,e,n,i){const a=i.attributeIDs,o=i.attributeTypes;let s,l;const h=e.GetEncodedGeometryType(n);if(h===t.TRIANGULAR_MESH)s=new t.Mesh,l=e.DecodeBufferToMesh(n,s);else{if(h!==t.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");s=new t.PointCloud,l=e.DecodeBufferToPointCloud(n,s)}if(!l.ok()||0===s.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+l.error_msg());const c={index:null,attributes:[]};for(const u in a){const n=self[o[u]];let l,h;if(i.useUniqueIDs)h=a[u],l=e.GetAttributeByUniqueId(s,h);else{if(h=e.GetAttributeId(s,t[a[u]]),-1===h)continue;l=e.GetAttribute(s,h)}c.attributes.push(r(t,e,s,u,n,l))}h===t.TRIANGULAR_MESH&&(c.index=function(t,e,r){const n=r.num_faces(),i=3*n,a=4*i,o=t._malloc(a);e.GetTrianglesUInt32Array(r,a,o);const s=new Uint32Array(t.HEAPF32.buffer,o,i).slice();return t._free(o),{array:s,itemSize:1}}(t,e,s));return t.destroy(s),c}(e,o,s,a),n=t.attributes.map((t=>t.array.buffer));t.index&&n.push(t.index.array.buffer),self.postMessage({type:"decode",id:i.id,geometry:t},n)}catch(l){console.error(l),self.postMessage({type:"error",id:i.id,error:l.message})}finally{e.destroy(s),e.destroy(o)}}))}}}var h=Object.create,c=Object.defineProperty,u=Object.getOwnPropertyDescriptor,d=Object.getOwnPropertyNames,p=Object.getPrototypeOf,f=Object.prototype.hasOwnProperty,m=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),v=(t,e,r)=>(r=null!=t?h(p(t)):{},((t,e,r,n)=>{if(e&&"object"==typeof e||"function"==typeof e)for(let i of d(e))!f.call(t,i)&&i!==r&&c(t,i,{get:()=>e[i],enumerable:!(n=u(e,i))||n.enumerable});return t})(!e&&t&&t.__esModule?r:c(r,"default",{value:t,enumerable:!0}),t)),g=(t,e,r)=>(((t,e,r)=>{e in t?c(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r})(t,"symbol"!=typeof e?e+"":e,r),r),y=m(((t,e)=>{var r,n;r=t,n=function(){return t.importState=function(e){var r=new t;return r.importState(e),r},t;function t(){return function(t){var e=0,r=0,n=0,i=1;0==t.length&&(t=[+new Date]);var a=function(){var t=4022871197,e=function(e){e=e.toString();for(var r=0;r<e.length;r++){var n=.02519603282416938*(t+=e.charCodeAt(r));n-=t=n>>>0,t=(n*=t)>>>0,t+=4294967296*(n-=t)}return 2.3283064365386963e-10*(t>>>0)};return e.version="Mash 0.9",e}();e=a(" "),r=a(" "),n=a(" ");for(var o=0;o<t.length;o++)(e-=a(t[o]))<0&&(e+=1),(r-=a(t[o]))<0&&(r+=1),(n-=a(t[o]))<0&&(n+=1);a=null;var s=function(){var t=2091639*e+2.3283064365386963e-10*i;return e=r,r=n,n=t-(i=0|t)};return s.next=s,s.uint32=function(){return 4294967296*s()},s.fract53=function(){return s()+11102230246251565e-32*(2097152*s()|0)},s.version="Alea 0.9",s.args=t,s.exportState=function(){return[e,r,n,i]},s.importState=function(t){e=+t[0]||0,r=+t[1]||0,n=+t[2]||0,i=+t[3]||0},s}(Array.prototype.slice.call(arguments))}},"object"==typeof t?e.exports=n():"function"==typeof define&&define.amd?define(n):r.Alea=n()})),b=m(((t,e)=>{var r,n;r=t,n=function(t){t.SVD=function(t,e,r,n,i){if(e=void 0===e||e,r=void 0===r||r,i=1e-64/(n=n||Math.pow(2,-52)),!t)throw new TypeError("Matrix a is not defined");var a,o,s,l,h,c,u,d,p,f,m,v,g=t[0].length,y=t.length;if(y<g)throw new TypeError("Invalid matrix: m < n");for(var b=[],x=[],w=[],_="f"===e?y:g,S=f=u=0;S<y;S++)x[S]=new Array(_).fill(0);for(S=0;S<g;S++)w[S]=new Array(g).fill(0);var A,M=new Array(g).fill(0);for(S=0;S<y;S++)for(a=0;a<g;a++)x[S][a]=t[S][a];for(S=0;S<g;S++){for(b[S]=u,p=0,s=S+1,a=S;a<y;a++)p+=Math.pow(x[a][S],2);if(p<i)u=0;else for(d=(c=x[S][S])*(u=c<0?Math.sqrt(p):-Math.sqrt(p))-p,x[S][S]=c-u,a=s;a<g;a++){for(p=0,o=S;o<y;o++)p+=x[o][S]*x[o][a];for(c=p/d,o=S;o<y;o++)x[o][a]=x[o][a]+c*x[o][S]}for(M[S]=u,p=0,a=s;a<g;a++)p+=Math.pow(x[S][a],2);if(p<i)u=0;else{for(d=(c=x[S][S+1])*(u=c<0?Math.sqrt(p):-Math.sqrt(p))-p,x[S][S+1]=c-u,a=s;a<g;a++)b[a]=x[S][a]/d;for(a=s;a<y;a++){for(p=0,o=s;o<g;o++)p+=x[a][o]*x[S][o];for(o=s;o<g;o++)x[a][o]=x[a][o]+p*b[o]}}f<(m=Math.abs(M[S])+Math.abs(b[S]))&&(f=m)}if(r)for(S=g-1;0<=S;S--){if(0!==u){for(d=x[S][S+1]*u,a=s;a<g;a++)w[a][S]=x[S][a]/d;for(a=s;a<g;a++){for(p=0,o=s;o<g;o++)p+=x[S][o]*w[o][a];for(o=s;o<g;o++)w[o][a]=w[o][a]+p*w[o][S]}}for(a=s;a<g;a++)w[S][a]=0,w[a][S]=0;w[S][S]=1,u=b[S],s=S}if(e){if("f"===e)for(S=g;S<y;S++){for(a=g;a<y;a++)x[S][a]=0;x[S][S]=1}for(S=g-1;0<=S;S--){for(s=S+1,u=M[S],a=s;a<_;a++)x[S][a]=0;if(0!==u){for(d=x[S][S]*u,a=s;a<_;a++){for(p=0,o=s;o<y;o++)p+=x[o][S]*x[o][a];for(c=p/d,o=S;o<y;o++)x[o][a]=x[o][a]+c*x[o][S]}for(a=S;a<y;a++)x[a][S]=x[a][S]/u}else for(a=S;a<y;a++)x[a][S]=0;x[S][S]=x[S][S]+1}}for(n*=f,o=g-1;0<=o;o--)for(var C=0;C<50;C++){for(A=!1,s=o;0<=s;s--){if(Math.abs(b[s])<=n){A=!0;break}if(Math.abs(M[s-1])<=n)break}if(!A)for(h=0,l=s-(p=1),S=s;S<o+1&&(c=p*b[S],b[S]=h*b[S],!(Math.abs(c)<=n));S++)if(u=M[S],M[S]=Math.sqrt(c*c+u*u),h=u/(d=M[S]),p=-c/d,e)for(a=0;a<y;a++)m=x[a][l],v=x[a][S],x[a][l]=m*h+v*p,x[a][S]=-m*p+v*h;if(v=M[o],s===o){if(v<0&&(M[o]=-v,r))for(a=0;a<g;a++)w[a][o]=-w[a][o];break}for(f=M[s],c=(((m=M[o-1])-v)*(m+v)+((u=b[o-1])-(d=b[o]))*(u+d))/(2*d*m),u=Math.sqrt(c*c+1),c=((f-v)*(f+v)+d*(m/(c<0?c-u:c+u)-d))/f,S=s+(p=h=1);S<o+1;S++){if(u=b[S],m=M[S],d=p*u,u*=h,v=Math.sqrt(c*c+d*d),c=f*(h=c/(b[S-1]=v))+u*(p=d/v),u=-f*p+u*h,d=m*p,m*=h,r)for(a=0;a<g;a++)f=w[a][S-1],v=w[a][S],w[a][S-1]=f*h+v*p,w[a][S]=-f*p+v*h;if(v=Math.sqrt(c*c+d*d),c=(h=c/(M[S-1]=v))*u+(p=d/v)*m,f=-p*u+h*m,e)for(a=0;a<y;a++)m=x[a][S-1],v=x[a][S],x[a][S-1]=m*h+v*p,x[a][S]=-m*p+v*h}b[s]=0,b[o]=c,M[o]=f}for(S=0;S<g;S++)M[S]<n&&(M[S]=0);return{u:x,q:M,v:w}},t.VERSION="1.1.1",Object.defineProperty(t,"__esModule",{value:!0})},"object"==typeof t&&typeof e<"u"?n(t):"function"==typeof define&&define.amd?define(["exports"],n):n((r=typeof globalThis<"u"?globalThis:r||self).SVDJS={})})),x=m(((t,e)=>{var r,n;r=t,n=function(){var t=function(t,r){if(void 0===t&&(t=[]),void 0===r&&(r=e),this.data=t,this.length=this.data.length,this.compare=r,this.length>0)for(var n=(this.length>>1)-1;n>=0;n--)this._down(n)};function e(t,e){return t<e?-1:t>e?1:0}return t.prototype.push=function(t){this.data.push(t),this.length++,this._up(this.length-1)},t.prototype.pop=function(){if(0!==this.length){var t=this.data[0],e=this.data.pop();return this.length--,this.length>0&&(this.data[0]=e,this._down(0)),t}},t.prototype.peek=function(){return this.data[0]},t.prototype._up=function(t){for(var e=this.data,r=this.compare,n=e[t];t>0;){var i=t-1>>1,a=e[i];if(r(n,a)>=0)break;e[t]=a,t=i}e[t]=n},t.prototype._down=function(t){for(var e=this.data,r=this.compare,n=this.length>>1,i=e[t];t<n;){var a=1+(t<<1),o=e[a],s=a+1;if(s<this.length&&r(e[s],o)<0&&(a=s,o=e[s]),r(o,i)>=0)break;e[t]=o,t=a}e[t]=i},t},"object"==typeof t&&typeof e<"u"?e.exports=n():"function"==typeof define&&define.amd?define(n):(r=r||self).TinyQueue=n()})),w=m(((t,e)=>{var r=x();function n(t,e,n){e=e||1;for(var o,s,l,h,c=0;c<t[0].length;c++){var u=t[0][c];(!c||u[0]<o)&&(o=u[0]),(!c||u[1]<s)&&(s=u[1]),(!c||u[0]>l)&&(l=u[0]),(!c||u[1]>h)&&(h=u[1])}var d=l-o,p=h-s,f=Math.min(d,p),m=f/2;if(0===f){var v=[o,s];return v.distance=0,v}for(var g=new r(void 0,i),y=o;y<l;y+=f)for(var b=s;b<h;b+=f)g.push(new a(y+m,b+m,m,t));var x=function(t){for(var e=0,r=0,n=0,i=t[0],o=0,s=i.length,l=s-1;o<s;l=o++){var h=i[o],c=i[l],u=h[0]*c[1]-c[0]*h[1];r+=(h[0]+c[0])*u,n+=(h[1]+c[1])*u,e+=3*u}return 0===e?new a(i[0][0],i[0][1],0,t):new a(r/e,n/e,0,t)}(t),w=new a(o+d/2,s+p/2,0,t);w.d>x.d&&(x=w);for(var _=g.length;g.length;){var S=g.pop();S.d>x.d&&(x=S,n&&console.log("found best %d after %d probes",Math.round(1e4*S.d)/1e4,_)),!(S.max-x.d<=e)&&(m=S.h/2,g.push(new a(S.x-m,S.y-m,m,t)),g.push(new a(S.x+m,S.y-m,m,t)),g.push(new a(S.x-m,S.y+m,m,t)),g.push(new a(S.x+m,S.y+m,m,t)),_+=4)}n&&(console.log("num probes: "+_),console.log("best distance: "+x.d));var A=[x.x,x.y];return A.distance=x.d,A}function i(t,e){return e.max-t.max}function a(t,e,r,n){this.x=t,this.y=e,this.h=r,this.d=function(t,e,r){for(var n=!1,i=1/0,a=0;a<r.length;a++)for(var s=r[a],l=0,h=s.length,c=h-1;l<h;c=l++){var u=s[l],d=s[c];u[1]>e!=d[1]>e&&t<(d[0]-u[0])*(e-u[1])/(d[1]-u[1])+u[0]&&(n=!n),i=Math.min(i,o(t,e,u,d))}return 0===i?0:(n?1:-1)*Math.sqrt(i)}(t,e,n),this.max=this.d+this.h*Math.SQRT2}function o(t,e,r,n){var i=r[0],a=r[1],o=n[0]-i,s=n[1]-a;if(0!==o||0!==s){var l=((t-i)*o+(e-a)*s)/(o*o+s*s);l>1?(i=n[0],a=n[1]):l>0&&(i+=o*l,a+=s*l)}return(o=t-i)*o+(s=e-a)*s}r.default&&(r=r.default),e.exports=n,e.exports.default=n})),_=m((t=>{!function(){var e=function(){this.init()};e.prototype={init:function(){var t=this||r;return t._counter=1e3,t._html5AudioPool=[],t.html5PoolSize=10,t._codecs={},t._howls=[],t._muted=!1,t._volume=1,t._canPlayEvent="canplaythrough",t._navigator=typeof window<"u"&&window.navigator?window.navigator:null,t.masterGain=null,t.noAudio=!1,t.usingWebAudio=!0,t.autoSuspend=!0,t.ctx=null,t.autoUnlock=!0,t._setup(),t},volume:function(t){var e=this||r;if(t=parseFloat(t),e.ctx||c(),typeof t<"u"&&t>=0&&t<=1){if(e._volume=t,e._muted)return e;e.usingWebAudio&&e.masterGain.gain.setValueAtTime(t,r.ctx.currentTime);for(var n=0;n<e._howls.length;n++)if(!e._howls[n]._webAudio)for(var i=e._howls[n]._getSoundIds(),a=0;a<i.length;a++){var o=e._howls[n]._soundById(i[a]);o&&o._node&&(o._node.volume=o._volume*t)}return e}return e._volume},mute:function(t){var e=this||r;e.ctx||c(),e._muted=t,e.usingWebAudio&&e.masterGain.gain.setValueAtTime(t?0:e._volume,r.ctx.currentTime);for(var n=0;n<e._howls.length;n++)if(!e._howls[n]._webAudio)for(var i=e._howls[n]._getSoundIds(),a=0;a<i.length;a++){var o=e._howls[n]._soundById(i[a]);o&&o._node&&(o._node.muted=!!t||o._muted)}return e},stop:function(){for(var t=this||r,e=0;e<t._howls.length;e++)t._howls[e].stop();return t},unload:function(){for(var t=this||r,e=t._howls.length-1;e>=0;e--)t._howls[e].unload();return t.usingWebAudio&&t.ctx&&typeof t.ctx.close<"u"&&(t.ctx.close(),t.ctx=null,c()),t},codecs:function(t){return(this||r)._codecs[t.replace(/^x-/,"")]},_setup:function(){var t=this||r;if(t.state=t.ctx&&t.ctx.state||"suspended",t._autoSuspend(),!t.usingWebAudio)if(typeof Audio<"u")try{typeof(new Audio).oncanplaythrough>"u"&&(t._canPlayEvent="canplay")}catch{t.noAudio=!0}else t.noAudio=!0;try{(new Audio).muted&&(t.noAudio=!0)}catch{}return t.noAudio||t._setupCodecs(),t},_setupCodecs:function(){var t=this||r,e=null;try{e=typeof Audio<"u"?new Audio:null}catch{return t}if(!e||"function"!=typeof e.canPlayType)return t;var n=e.canPlayType("audio/mpeg;").replace(/^no$/,""),i=t._navigator?t._navigator.userAgent:"",a=i.match(/OPR\/([0-6].)/g),o=a&&parseInt(a[0].split("/")[1],10)<33,s=-1!==i.indexOf("Safari")&&-1===i.indexOf("Chrome"),l=i.match(/Version\/(.*?) /),h=s&&l&&parseInt(l[1],10)<15;return t._codecs={mp3:!(o||!n&&!e.canPlayType("audio/mp3;").replace(/^no$/,"")),mpeg:!!n,opus:!!e.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!e.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!e.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!(e.canPlayType('audio/wav; codecs="1"')||e.canPlayType("audio/wav")).replace(/^no$/,""),aac:!!e.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!e.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(e.canPlayType("audio/x-m4a;")||e.canPlayType("audio/m4a;")||e.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(e.canPlayType("audio/x-m4b;")||e.canPlayType("audio/m4b;")||e.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(e.canPlayType("audio/x-mp4;")||e.canPlayType("audio/mp4;")||e.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!(h||!e.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),webm:!(h||!e.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),dolby:!!e.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(e.canPlayType("audio/x-flac;")||e.canPlayType("audio/flac;")).replace(/^no$/,"")},t},_unlockAudio:function(){var t=this||r;if(!t._audioUnlocked&&t.ctx){t._audioUnlocked=!1,t.autoUnlock=!1,!t._mobileUnloaded&&44100!==t.ctx.sampleRate&&(t._mobileUnloaded=!0,t.unload()),t._scratchBuffer=t.ctx.createBuffer(1,1,22050);var e=function(r){for(;t._html5AudioPool.length<t.html5PoolSize;)try{var n=new Audio;n._unlocked=!0,t._releaseHtml5Audio(n)}catch{t.noAudio=!0;break}for(var i=0;i<t._howls.length;i++)if(!t._howls[i]._webAudio)for(var a=t._howls[i]._getSoundIds(),o=0;o<a.length;o++){var s=t._howls[i]._soundById(a[o]);s&&s._node&&!s._node._unlocked&&(s._node._unlocked=!0,s._node.load())}t._autoResume();var l=t.ctx.createBufferSource();l.buffer=t._scratchBuffer,l.connect(t.ctx.destination),typeof l.start>"u"?l.noteOn(0):l.start(0),"function"==typeof t.ctx.resume&&t.ctx.resume(),l.onended=function(){l.disconnect(0),t._audioUnlocked=!0,document.removeEventListener("touchstart",e,!0),document.removeEventListener("touchend",e,!0),document.removeEventListener("click",e,!0),document.removeEventListener("keydown",e,!0);for(var r=0;r<t._howls.length;r++)t._howls[r]._emit("unlock")}};return document.addEventListener("touchstart",e,!0),document.addEventListener("touchend",e,!0),document.addEventListener("click",e,!0),document.addEventListener("keydown",e,!0),t}},_obtainHtml5Audio:function(){var t=this||r;if(t._html5AudioPool.length)return t._html5AudioPool.pop();var e=(new Audio).play();return e&&typeof Promise<"u"&&(e instanceof Promise||"function"==typeof e.then)&&e.catch((function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")})),new Audio},_releaseHtml5Audio:function(t){var e=this||r;return t._unlocked&&e._html5AudioPool.push(t),e},_autoSuspend:function(){var t=this;if(t.autoSuspend&&t.ctx&&!(typeof t.ctx.suspend>"u")&&r.usingWebAudio){for(var e=0;e<t._howls.length;e++)if(t._howls[e]._webAudio)for(var n=0;n<t._howls[e]._sounds.length;n++)if(!t._howls[e]._sounds[n]._paused)return t;return t._suspendTimer&&clearTimeout(t._suspendTimer),t._suspendTimer=setTimeout((function(){if(t.autoSuspend){t._suspendTimer=null,t.state="suspending";var e=function(){t.state="suspended",t._resumeAfterSuspend&&(delete t._resumeAfterSuspend,t._autoResume())};t.ctx.suspend().then(e,e)}}),3e4),t}},_autoResume:function(){var t=this;if(t.ctx&&!(typeof t.ctx.resume>"u")&&r.usingWebAudio)return"running"===t.state&&"interrupted"!==t.ctx.state&&t._suspendTimer?(clearTimeout(t._suspendTimer),t._suspendTimer=null):"suspended"===t.state||"running"===t.state&&"interrupted"===t.ctx.state?(t.ctx.resume().then((function(){t.state="running";for(var e=0;e<t._howls.length;e++)t._howls[e]._emit("resume")})),t._suspendTimer&&(clearTimeout(t._suspendTimer),t._suspendTimer=null)):"suspending"===t.state&&(t._resumeAfterSuspend=!0),t}};var r=new e,n=function(t){t.src&&0!==t.src.length?this.init(t):console.error("An array of source files must be passed with any new Howl.")};n.prototype={init:function(t){var e=this;return r.ctx||c(),e._autoplay=t.autoplay||!1,e._format="string"!=typeof t.format?t.format:[t.format],e._html5=t.html5||!1,e._muted=t.mute||!1,e._loop=t.loop||!1,e._pool=t.pool||5,e._preload="boolean"!=typeof t.preload&&"metadata"!==t.preload||t.preload,e._rate=t.rate||1,e._sprite=t.sprite||{},e._src="string"!=typeof t.src?t.src:[t.src],e._volume=void 0!==t.volume?t.volume:1,e._xhr={method:t.xhr&&t.xhr.method?t.xhr.method:"GET",headers:t.xhr&&t.xhr.headers?t.xhr.headers:null,withCredentials:!(!t.xhr||!t.xhr.withCredentials)&&t.xhr.withCredentials},e._duration=0,e._state="unloaded",e._sounds=[],e._endTimers={},e._queue=[],e._playLock=!1,e._onend=t.onend?[{fn:t.onend}]:[],e._onfade=t.onfade?[{fn:t.onfade}]:[],e._onload=t.onload?[{fn:t.onload}]:[],e._onloaderror=t.onloaderror?[{fn:t.onloaderror}]:[],e._onplayerror=t.onplayerror?[{fn:t.onplayerror}]:[],e._onpause=t.onpause?[{fn:t.onpause}]:[],e._onplay=t.onplay?[{fn:t.onplay}]:[],e._onstop=t.onstop?[{fn:t.onstop}]:[],e._onmute=t.onmute?[{fn:t.onmute}]:[],e._onvolume=t.onvolume?[{fn:t.onvolume}]:[],e._onrate=t.onrate?[{fn:t.onrate}]:[],e._onseek=t.onseek?[{fn:t.onseek}]:[],e._onunlock=t.onunlock?[{fn:t.onunlock}]:[],e._onresume=[],e._webAudio=r.usingWebAudio&&!e._html5,typeof r.ctx<"u"&&r.ctx&&r.autoUnlock&&r._unlockAudio(),r._howls.push(e),e._autoplay&&e._queue.push({event:"play",action:function(){e.play()}}),e._preload&&"none"!==e._preload&&e.load(),e},load:function(){var t=this,e=null;if(r.noAudio)t._emit("loaderror",null,"No audio support.");else{"string"==typeof t._src&&(t._src=[t._src]);for(var n=0;n<t._src.length;n++){var a,s;if(t._format&&t._format[n])a=t._format[n];else{if("string"!=typeof(s=t._src[n])){t._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}(a=/^data:audio\/([^;,]+);/i.exec(s))||(a=/\.([^.]+)$/.exec(s.split("?",1)[0])),a&&(a=a[1].toLowerCase())}if(a||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),a&&r.codecs(a)){e=t._src[n];break}}if(e)return t._src=e,t._state="loading","https:"===window.location.protocol&&"http:"===e.slice(0,5)&&(t._html5=!0,t._webAudio=!1),new i(t),t._webAudio&&o(t),t;t._emit("loaderror",null,"No codec support for selected audio sources.")}},play:function(t,e){var n=this,i=null;if("number"==typeof t)i=t,t=null;else{if("string"==typeof t&&"loaded"===n._state&&!n._sprite[t])return null;if(typeof t>"u"&&(t="__default",!n._playLock)){for(var a=0,o=0;o<n._sounds.length;o++)n._sounds[o]._paused&&!n._sounds[o]._ended&&(a++,i=n._sounds[o]._id);1===a?t=null:i=null}}var s=i?n._soundById(i):n._inactiveSound();if(!s)return null;if(i&&!t&&(t=s._sprite||"__default"),"loaded"!==n._state){s._sprite=t,s._ended=!1;var l=s._id;return n._queue.push({event:"play",action:function(){n.play(l)}}),l}if(i&&!s._paused)return e||n._loadQueue("play"),s._id;n._webAudio&&r._autoResume();var h=Math.max(0,s._seek>0?s._seek:n._sprite[t][0]/1e3),c=Math.max(0,(n._sprite[t][0]+n._sprite[t][1])/1e3-h),u=1e3*c/Math.abs(s._rate),d=n._sprite[t][0]/1e3,p=(n._sprite[t][0]+n._sprite[t][1])/1e3;s._sprite=t,s._ended=!1;var f=function(){s._paused=!1,s._seek=h,s._start=d,s._stop=p,s._loop=!(!s._loop&&!n._sprite[t][2])};if(!(h>=p)){var m=s._node;if(n._webAudio){var v=function(){n._playLock=!1,f(),n._refreshBuffer(s);var t=s._muted||n._muted?0:s._volume;m.gain.setValueAtTime(t,r.ctx.currentTime),s._playStart=r.ctx.currentTime,typeof m.bufferSource.start>"u"?s._loop?m.bufferSource.noteGrainOn(0,h,86400):m.bufferSource.noteGrainOn(0,h,c):s._loop?m.bufferSource.start(0,h,86400):m.bufferSource.start(0,h,c),u!==1/0&&(n._endTimers[s._id]=setTimeout(n._ended.bind(n,s),u)),e||setTimeout((function(){n._emit("play",s._id),n._loadQueue()}),0)};"running"===r.state&&"interrupted"!==r.ctx.state?v():(n._playLock=!0,n.once("resume",v),n._clearTimer(s._id))}else{var g=function(){m.currentTime=h,m.muted=s._muted||n._muted||r._muted||m.muted,m.volume=s._volume*r.volume(),m.playbackRate=s._rate;try{var i=m.play();if(i&&typeof Promise<"u"&&(i instanceof Promise||"function"==typeof i.then)?(n._playLock=!0,f(),i.then((function(){n._playLock=!1,m._unlocked=!0,e?n._loadQueue():n._emit("play",s._id)})).catch((function(){n._playLock=!1,n._emit("playerror",s._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),s._ended=!0,s._paused=!0}))):e||(n._playLock=!1,f(),n._emit("play",s._id)),m.playbackRate=s._rate,m.paused)return void n._emit("playerror",s._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");"__default"!==t||s._loop?n._endTimers[s._id]=setTimeout(n._ended.bind(n,s),u):(n._endTimers[s._id]=function(){n._ended(s),m.removeEventListener("ended",n._endTimers[s._id],!1)},m.addEventListener("ended",n._endTimers[s._id],!1))}catch(a){n._emit("playerror",s._id,a)}};"data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"===m.src&&(m.src=n._src,m.load());var y=window&&window.ejecta||!m.readyState&&r._navigator.isCocoonJS;if(m.readyState>=3||y)g();else{n._playLock=!0,n._state="loading";var b=function(){n._state="loaded",g(),m.removeEventListener(r._canPlayEvent,b,!1)};m.addEventListener(r._canPlayEvent,b,!1),n._clearTimer(s._id)}}return s._id}n._ended(s)},pause:function(t){var e=this;if("loaded"!==e._state||e._playLock)return e._queue.push({event:"pause",action:function(){e.pause(t)}}),e;for(var r=e._getSoundIds(t),n=0;n<r.length;n++){e._clearTimer(r[n]);var i=e._soundById(r[n]);if(i&&!i._paused&&(i._seek=e.seek(r[n]),i._rateSeek=0,i._paused=!0,e._stopFade(r[n]),i._node))if(e._webAudio){if(!i._node.bufferSource)continue;typeof i._node.bufferSource.stop>"u"?i._node.bufferSource.noteOff(0):i._node.bufferSource.stop(0),e._cleanBuffer(i._node)}else(!isNaN(i._node.duration)||i._node.duration===1/0)&&i._node.pause();arguments[1]||e._emit("pause",i?i._id:null)}return e},stop:function(t,e){var r=this;if("loaded"!==r._state||r._playLock)return r._queue.push({event:"stop",action:function(){r.stop(t)}}),r;for(var n=r._getSoundIds(t),i=0;i<n.length;i++){r._clearTimer(n[i]);var a=r._soundById(n[i]);a&&(a._seek=a._start||0,a._rateSeek=0,a._paused=!0,a._ended=!0,r._stopFade(n[i]),a._node&&(r._webAudio?a._node.bufferSource&&(typeof a._node.bufferSource.stop>"u"?a._node.bufferSource.noteOff(0):a._node.bufferSource.stop(0),r._cleanBuffer(a._node)):(!isNaN(a._node.duration)||a._node.duration===1/0)&&(a._node.currentTime=a._start||0,a._node.pause(),a._node.duration===1/0&&r._clearSound(a._node))),e||r._emit("stop",a._id))}return r},mute:function(t,e){var n=this;if("loaded"!==n._state||n._playLock)return n._queue.push({event:"mute",action:function(){n.mute(t,e)}}),n;if(typeof e>"u"){if("boolean"!=typeof t)return n._muted;n._muted=t}for(var i=n._getSoundIds(e),a=0;a<i.length;a++){var o=n._soundById(i[a]);o&&(o._muted=t,o._interval&&n._stopFade(o._id),n._webAudio&&o._node?o._node.gain.setValueAtTime(t?0:o._volume,r.ctx.currentTime):o._node&&(o._node.muted=!!r._muted||t),n._emit("mute",o._id))}return n},volume:function(){var t,e,n,i=this,a=arguments;if(0===a.length)return i._volume;1===a.length||2===a.length&&typeof a[1]>"u"?i._getSoundIds().indexOf(a[0])>=0?e=parseInt(a[0],10):t=parseFloat(a[0]):a.length>=2&&(t=parseFloat(a[0]),e=parseInt(a[1],10));if(!(typeof t<"u"&&t>=0&&t<=1))return(n=e?i._soundById(e):i._sounds[0])?n._volume:0;if("loaded"!==i._state||i._playLock)return i._queue.push({event:"volume",action:function(){i.volume.apply(i,a)}}),i;typeof e>"u"&&(i._volume=t),e=i._getSoundIds(e);for(var o=0;o<e.length;o++)(n=i._soundById(e[o]))&&(n._volume=t,a[2]||i._stopFade(e[o]),i._webAudio&&n._node&&!n._muted?n._node.gain.setValueAtTime(t,r.ctx.currentTime):n._node&&!n._muted&&(n._node.volume=t*r.volume()),i._emit("volume",n._id));return i},fade:function(t,e,n,i){var a=this;if("loaded"!==a._state||a._playLock)return a._queue.push({event:"fade",action:function(){a.fade(t,e,n,i)}}),a;t=Math.min(Math.max(0,parseFloat(t)),1),e=Math.min(Math.max(0,parseFloat(e)),1),n=parseFloat(n),a.volume(t,i);for(var o=a._getSoundIds(i),s=0;s<o.length;s++){var l=a._soundById(o[s]);if(l){if(i||a._stopFade(o[s]),a._webAudio&&!l._muted){var h=r.ctx.currentTime,c=h+n/1e3;l._volume=t,l._node.gain.setValueAtTime(t,h),l._node.gain.linearRampToValueAtTime(e,c)}a._startFadeInterval(l,t,e,n,o[s],typeof i>"u")}}return a},_startFadeInterval:function(t,e,r,n,i,a){var o=this,s=e,l=r-e,h=Math.abs(l/.01),c=Math.max(4,h>0?n/h:n),u=Date.now();t._fadeTo=r,t._interval=setInterval((function(){var i=(Date.now()-u)/n;u=Date.now(),s+=l*i,s=Math.round(100*s)/100,s=l<0?Math.max(r,s):Math.min(r,s),o._webAudio?t._volume=s:o.volume(s,t._id,!0),a&&(o._volume=s),(r<e&&s<=r||r>e&&s>=r)&&(clearInterval(t._interval),t._interval=null,t._fadeTo=null,o.volume(r,t._id),o._emit("fade",t._id))}),c)},_stopFade:function(t){var e=this,n=e._soundById(t);return n&&n._interval&&(e._webAudio&&n._node.gain.cancelScheduledValues(r.ctx.currentTime),clearInterval(n._interval),n._interval=null,e.volume(n._fadeTo,t),n._fadeTo=null,e._emit("fade",t)),e},loop:function(){var t,e,r,n=this,i=arguments;if(0===i.length)return n._loop;if(1===i.length){if("boolean"!=typeof i[0])return!!(r=n._soundById(parseInt(i[0],10)))&&r._loop;t=i[0],n._loop=t}else 2===i.length&&(t=i[0],e=parseInt(i[1],10));for(var a=n._getSoundIds(e),o=0;o<a.length;o++)(r=n._soundById(a[o]))&&(r._loop=t,n._webAudio&&r._node&&r._node.bufferSource&&(r._node.bufferSource.loop=t,t&&(r._node.bufferSource.loopStart=r._start||0,r._node.bufferSource.loopEnd=r._stop,n.playing(a[o])&&(n.pause(a[o],!0),n.play(a[o],!0)))));return n},rate:function(){var t,e,n,i=this,a=arguments;if(0===a.length)e=i._sounds[0]._id;else if(1===a.length){i._getSoundIds().indexOf(a[0])>=0?e=parseInt(a[0],10):t=parseFloat(a[0])}else 2===a.length&&(t=parseFloat(a[0]),e=parseInt(a[1],10));if("number"!=typeof t)return(n=i._soundById(e))?n._rate:i._rate;if("loaded"!==i._state||i._playLock)return i._queue.push({event:"rate",action:function(){i.rate.apply(i,a)}}),i;typeof e>"u"&&(i._rate=t),e=i._getSoundIds(e);for(var o=0;o<e.length;o++)if(n=i._soundById(e[o])){i.playing(e[o])&&(n._rateSeek=i.seek(e[o]),n._playStart=i._webAudio?r.ctx.currentTime:n._playStart),n._rate=t,i._webAudio&&n._node&&n._node.bufferSource?n._node.bufferSource.playbackRate.setValueAtTime(t,r.ctx.currentTime):n._node&&(n._node.playbackRate=t);var s=i.seek(e[o]),l=1e3*((i._sprite[n._sprite][0]+i._sprite[n._sprite][1])/1e3-s)/Math.abs(n._rate);(i._endTimers[e[o]]||!n._paused)&&(i._clearTimer(e[o]),i._endTimers[e[o]]=setTimeout(i._ended.bind(i,n),l)),i._emit("rate",n._id)}return i},seek:function(){var t,e,n=this,i=arguments;if(0===i.length)n._sounds.length&&(e=n._sounds[0]._id);else if(1===i.length){n._getSoundIds().indexOf(i[0])>=0?e=parseInt(i[0],10):n._sounds.length&&(e=n._sounds[0]._id,t=parseFloat(i[0]))}else 2===i.length&&(t=parseFloat(i[0]),e=parseInt(i[1],10));if(typeof e>"u")return 0;if("number"==typeof t&&("loaded"!==n._state||n._playLock))return n._queue.push({event:"seek",action:function(){n.seek.apply(n,i)}}),n;var a=n._soundById(e);if(a){if(!("number"==typeof t&&t>=0)){if(n._webAudio){var o=n.playing(e)?r.ctx.currentTime-a._playStart:0,s=a._rateSeek?a._rateSeek-a._seek:0;return a._seek+(s+o*Math.abs(a._rate))}return a._node.currentTime}var l=n.playing(e);l&&n.pause(e,!0),a._seek=t,a._ended=!1,n._clearTimer(e),!n._webAudio&&a._node&&!isNaN(a._node.duration)&&(a._node.currentTime=t);var h=function(){l&&n.play(e,!0),n._emit("seek",e)};if(l&&!n._webAudio){var c=function(){n._playLock?setTimeout(c,0):h()};setTimeout(c,0)}else h()}return n},playing:function(t){var e=this;if("number"==typeof t){var r=e._soundById(t);return!!r&&!r._paused}for(var n=0;n<e._sounds.length;n++)if(!e._sounds[n]._paused)return!0;return!1},duration:function(t){var e=this,r=e._duration,n=e._soundById(t);return n&&(r=e._sprite[n._sprite][1]/1e3),r},state:function(){return this._state},unload:function(){for(var t=this,e=t._sounds,n=0;n<e.length;n++)e[n]._paused||t.stop(e[n]._id),t._webAudio||(t._clearSound(e[n]._node),e[n]._node.removeEventListener("error",e[n]._errorFn,!1),e[n]._node.removeEventListener(r._canPlayEvent,e[n]._loadFn,!1),e[n]._node.removeEventListener("ended",e[n]._endFn,!1),r._releaseHtml5Audio(e[n]._node)),delete e[n]._node,t._clearTimer(e[n]._id);var i=r._howls.indexOf(t);i>=0&&r._howls.splice(i,1);var o=!0;for(n=0;n<r._howls.length;n++)if(r._howls[n]._src===t._src||t._src.indexOf(r._howls[n]._src)>=0){o=!1;break}return a&&o&&delete a[t._src],r.noAudio=!1,t._state="unloaded",t._sounds=[],t=null,null},on:function(t,e,r,n){var i=this["_on"+t];return"function"==typeof e&&i.push(n?{id:r,fn:e,once:n}:{id:r,fn:e}),this},off:function(t,e,r){var n=this,i=n["_on"+t],a=0;if("number"==typeof e&&(r=e,e=null),e||r)for(a=0;a<i.length;a++){var o=r===i[a].id;if(e===i[a].fn&&o||!e&&o){i.splice(a,1);break}}else if(t)n["_on"+t]=[];else{var s=Object.keys(n);for(a=0;a<s.length;a++)0===s[a].indexOf("_on")&&Array.isArray(n[s[a]])&&(n[s[a]]=[])}return n},once:function(t,e,r){return this.on(t,e,r,1),this},_emit:function(t,e,r){for(var n=this,i=n["_on"+t],a=i.length-1;a>=0;a--)(!i[a].id||i[a].id===e||"load"===t)&&(setTimeout(function(t){t.call(this,e,r)}.bind(n,i[a].fn),0),i[a].once&&n.off(t,i[a].fn,i[a].id));return n._loadQueue(t),n},_loadQueue:function(t){var e=this;if(e._queue.length>0){var r=e._queue[0];r.event===t&&(e._queue.shift(),e._loadQueue()),t||r.action()}return e},_ended:function(t){var e=this,n=t._sprite;if(!e._webAudio&&t._node&&!t._node.paused&&!t._node.ended&&t._node.currentTime<t._stop)return setTimeout(e._ended.bind(e,t),100),e;var i=!(!t._loop&&!e._sprite[n][2]);if(e._emit("end",t._id),!e._webAudio&&i&&e.stop(t._id,!0).play(t._id),e._webAudio&&i){e._emit("play",t._id),t._seek=t._start||0,t._rateSeek=0,t._playStart=r.ctx.currentTime;var a=1e3*(t._stop-t._start)/Math.abs(t._rate);e._endTimers[t._id]=setTimeout(e._ended.bind(e,t),a)}return e._webAudio&&!i&&(t._paused=!0,t._ended=!0,t._seek=t._start||0,t._rateSeek=0,e._clearTimer(t._id),e._cleanBuffer(t._node),r._autoSuspend()),!e._webAudio&&!i&&e.stop(t._id,!0),e},_clearTimer:function(t){var e=this;if(e._endTimers[t]){if("function"!=typeof e._endTimers[t])clearTimeout(e._endTimers[t]);else{var r=e._soundById(t);r&&r._node&&r._node.removeEventListener("ended",e._endTimers[t],!1)}delete e._endTimers[t]}return e},_soundById:function(t){for(var e=this,r=0;r<e._sounds.length;r++)if(t===e._sounds[r]._id)return e._sounds[r];return null},_inactiveSound:function(){var t=this;t._drain();for(var e=0;e<t._sounds.length;e++)if(t._sounds[e]._ended)return t._sounds[e].reset();return new i(t)},_drain:function(){var t=this,e=t._pool,r=0,n=0;if(!(t._sounds.length<e)){for(n=0;n<t._sounds.length;n++)t._sounds[n]._ended&&r++;for(n=t._sounds.length-1;n>=0;n--){if(r<=e)return;t._sounds[n]._ended&&(t._webAudio&&t._sounds[n]._node&&t._sounds[n]._node.disconnect(0),t._sounds.splice(n,1),r--)}}},_getSoundIds:function(t){if(typeof t>"u"){for(var e=[],r=0;r<this._sounds.length;r++)e.push(this._sounds[r]._id);return e}return[t]},_refreshBuffer:function(t){return t._node.bufferSource=r.ctx.createBufferSource(),t._node.bufferSource.buffer=a[this._src],t._panner?t._node.bufferSource.connect(t._panner):t._node.bufferSource.connect(t._node),t._node.bufferSource.loop=t._loop,t._loop&&(t._node.bufferSource.loopStart=t._start||0,t._node.bufferSource.loopEnd=t._stop||0),t._node.bufferSource.playbackRate.setValueAtTime(t._rate,r.ctx.currentTime),this},_cleanBuffer:function(t){var e=r._navigator&&r._navigator.vendor.indexOf("Apple")>=0;if(r._scratchBuffer&&t.bufferSource&&(t.bufferSource.onended=null,t.bufferSource.disconnect(0),e))try{t.bufferSource.buffer=r._scratchBuffer}catch{}return t.bufferSource=null,this},_clearSound:function(t){/MSIE |Trident\//.test(r._navigator&&r._navigator.userAgent)||(t.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var i=function(t){this._parent=t,this.init()};i.prototype={init:function(){var t=this,e=t._parent;return t._muted=e._muted,t._loop=e._loop,t._volume=e._volume,t._rate=e._rate,t._seek=0,t._paused=!0,t._ended=!0,t._sprite="__default",t._id=++r._counter,e._sounds.push(t),t.create(),t},create:function(){var t=this,e=t._parent,n=r._muted||t._muted||t._parent._muted?0:t._volume;return e._webAudio?(t._node=typeof r.ctx.createGain>"u"?r.ctx.createGainNode():r.ctx.createGain(),t._node.gain.setValueAtTime(n,r.ctx.currentTime),t._node.paused=!0,t._node.connect(r.masterGain)):r.noAudio||(t._node=r._obtainHtml5Audio(),t._errorFn=t._errorListener.bind(t),t._node.addEventListener("error",t._errorFn,!1),t._loadFn=t._loadListener.bind(t),t._node.addEventListener(r._canPlayEvent,t._loadFn,!1),t._endFn=t._endListener.bind(t),t._node.addEventListener("ended",t._endFn,!1),t._node.src=e._src,t._node.preload=!0===e._preload?"auto":e._preload,t._node.volume=n*r.volume(),t._node.load()),t},reset:function(){var t=this,e=t._parent;return t._muted=e._muted,t._loop=e._loop,t._volume=e._volume,t._rate=e._rate,t._seek=0,t._rateSeek=0,t._paused=!0,t._ended=!0,t._sprite="__default",t._id=++r._counter,t},_errorListener:function(){var t=this;t._parent._emit("loaderror",t._id,t._node.error?t._node.error.code:0),t._node.removeEventListener("error",t._errorFn,!1)},_loadListener:function(){var t=this,e=t._parent;e._duration=Math.ceil(10*t._node.duration)/10,0===Object.keys(e._sprite).length&&(e._sprite={__default:[0,1e3*e._duration]}),"loaded"!==e._state&&(e._state="loaded",e._emit("load"),e._loadQueue()),t._node.removeEventListener(r._canPlayEvent,t._loadFn,!1)},_endListener:function(){var t=this,e=t._parent;e._duration===1/0&&(e._duration=Math.ceil(10*t._node.duration)/10,e._sprite.__default[1]===1/0&&(e._sprite.__default[1]=1e3*e._duration),e._ended(t)),t._node.removeEventListener("ended",t._endFn,!1)}};var a={},o=function(t){var e=t._src;if(a[e])return t._duration=a[e].duration,void h(t);if(/^data:[^;]+;base64,/.test(e)){for(var r=atob(e.split(",")[1]),n=new Uint8Array(r.length),i=0;i<r.length;++i)n[i]=r.charCodeAt(i);l(n.buffer,t)}else{var o=new XMLHttpRequest;o.open(t._xhr.method,e,!0),o.withCredentials=t._xhr.withCredentials,o.responseType="arraybuffer",t._xhr.headers&&Object.keys(t._xhr.headers).forEach((function(e){o.setRequestHeader(e,t._xhr.headers[e])})),o.onload=function(){var e=(o.status+"")[0];"0"===e||"2"===e||"3"===e?l(o.response,t):t._emit("loaderror",null,"Failed loading audio file with status: "+o.status+".")},o.onerror=function(){t._webAudio&&(t._html5=!0,t._webAudio=!1,t._sounds=[],delete a[e],t.load())},s(o)}},s=function(t){try{t.send()}catch{t.onerror()}},l=function(t,e){var n=function(){e._emit("loaderror",null,"Decoding audio data failed.")},i=function(t){t&&e._sounds.length>0?(a[e._src]=t,h(e,t)):n()};typeof Promise<"u"&&1===r.ctx.decodeAudioData.length?r.ctx.decodeAudioData(t).then(i).catch(n):r.ctx.decodeAudioData(t,i,n)},h=function(t,e){e&&!t._duration&&(t._duration=e.duration),0===Object.keys(t._sprite).length&&(t._sprite={__default:[0,1e3*t._duration]}),"loaded"!==t._state&&(t._state="loaded",t._emit("load"),t._loadQueue())},c=function(){if(r.usingWebAudio){try{typeof AudioContext<"u"?r.ctx=new AudioContext:typeof webkitAudioContext<"u"?r.ctx=new webkitAudioContext:r.usingWebAudio=!1}catch{r.usingWebAudio=!1}r.ctx||(r.usingWebAudio=!1);var t=/iP(hone|od|ad)/.test(r._navigator&&r._navigator.platform),e=r._navigator&&r._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),n=e?parseInt(e[1],10):null;if(t&&n&&n<9){var i=/safari/.test(r._navigator&&r._navigator.userAgent.toLowerCase());r._navigator&&!i&&(r.usingWebAudio=!1)}r.usingWebAudio&&(r.masterGain=typeof r.ctx.createGain>"u"?r.ctx.createGainNode():r.ctx.createGain(),r.masterGain.gain.setValueAtTime(r._muted?0:r._volume,r.ctx.currentTime),r.masterGain.connect(r.ctx.destination)),r._setup()}};"function"==typeof define&&define.amd&&define([],(function(){return{Howler:r,Howl:n}})),typeof t<"u"&&(t.Howler=r,t.Howl=n),typeof global<"u"?(global.HowlerGlobal=e,global.Howler=r,global.Howl=n,global.Sound=i):typeof window<"u"&&(window.HowlerGlobal=e,window.Howler=r,window.Howl=n,window.Sound=i)}(),function(){var t;HowlerGlobal.prototype._pos=[0,0,0],HowlerGlobal.prototype._orientation=[0,0,-1,0,1,0],HowlerGlobal.prototype.stereo=function(t){var e=this;if(!e.ctx||!e.ctx.listener)return e;for(var r=e._howls.length-1;r>=0;r--)e._howls[r].stereo(t);return e},HowlerGlobal.prototype.pos=function(t,e,r){var n=this;return n.ctx&&n.ctx.listener?(e="number"!=typeof e?n._pos[1]:e,r="number"!=typeof r?n._pos[2]:r,"number"!=typeof t?n._pos:(n._pos=[t,e,r],typeof n.ctx.listener.positionX<"u"?(n.ctx.listener.positionX.setTargetAtTime(n._pos[0],Howler.ctx.currentTime,.1),n.ctx.listener.positionY.setTargetAtTime(n._pos[1],Howler.ctx.currentTime,.1),n.ctx.listener.positionZ.setTargetAtTime(n._pos[2],Howler.ctx.currentTime,.1)):n.ctx.listener.setPosition(n._pos[0],n._pos[1],n._pos[2]),n)):n},HowlerGlobal.prototype.orientation=function(t,e,r,n,i,a){var o=this;if(!o.ctx||!o.ctx.listener)return o;var s=o._orientation;return e="number"!=typeof e?s[1]:e,r="number"!=typeof r?s[2]:r,n="number"!=typeof n?s[3]:n,i="number"!=typeof i?s[4]:i,a="number"!=typeof a?s[5]:a,"number"!=typeof t?s:(o._orientation=[t,e,r,n,i,a],typeof o.ctx.listener.forwardX<"u"?(o.ctx.listener.forwardX.setTargetAtTime(t,Howler.ctx.currentTime,.1),o.ctx.listener.forwardY.setTargetAtTime(e,Howler.ctx.currentTime,.1),o.ctx.listener.forwardZ.setTargetAtTime(r,Howler.ctx.currentTime,.1),o.ctx.listener.upX.setTargetAtTime(n,Howler.ctx.currentTime,.1),o.ctx.listener.upY.setTargetAtTime(i,Howler.ctx.currentTime,.1),o.ctx.listener.upZ.setTargetAtTime(a,Howler.ctx.currentTime,.1)):o.ctx.listener.setOrientation(t,e,r,n,i,a),o)},Howl.prototype.init=(t=Howl.prototype.init,function(e){var r=this;return r._orientation=e.orientation||[1,0,0],r._stereo=e.stereo||null,r._pos=e.pos||null,r._pannerAttr={coneInnerAngle:typeof e.coneInnerAngle<"u"?e.coneInnerAngle:360,coneOuterAngle:typeof e.coneOuterAngle<"u"?e.coneOuterAngle:360,coneOuterGain:typeof e.coneOuterGain<"u"?e.coneOuterGain:0,distanceModel:typeof e.distanceModel<"u"?e.distanceModel:"inverse",maxDistance:typeof e.maxDistance<"u"?e.maxDistance:1e4,panningModel:typeof e.panningModel<"u"?e.panningModel:"HRTF",refDistance:typeof e.refDistance<"u"?e.refDistance:1,rolloffFactor:typeof e.rolloffFactor<"u"?e.rolloffFactor:1},r._onstereo=e.onstereo?[{fn:e.onstereo}]:[],r._onpos=e.onpos?[{fn:e.onpos}]:[],r._onorientation=e.onorientation?[{fn:e.onorientation}]:[],t.call(this,e)}),Howl.prototype.stereo=function(t,r){var n=this;if(!n._webAudio)return n;if("loaded"!==n._state)return n._queue.push({event:"stereo",action:function(){n.stereo(t,r)}}),n;var i=typeof Howler.ctx.createStereoPanner>"u"?"spatial":"stereo";if(typeof r>"u"){if("number"!=typeof t)return n._stereo;n._stereo=t,n._pos=[t,0,0]}for(var a=n._getSoundIds(r),o=0;o<a.length;o++){var s=n._soundById(a[o]);if(s){if("number"!=typeof t)return s._stereo;s._stereo=t,s._pos=[t,0,0],s._node&&(s._pannerAttr.panningModel="equalpower",(!s._panner||!s._panner.pan)&&e(s,i),"spatial"===i?typeof s._panner.positionX<"u"?(s._panner.positionX.setValueAtTime(t,Howler.ctx.currentTime),s._panner.positionY.setValueAtTime(0,Howler.ctx.currentTime),s._panner.positionZ.setValueAtTime(0,Howler.ctx.currentTime)):s._panner.setPosition(t,0,0):s._panner.pan.setValueAtTime(t,Howler.ctx.currentTime)),n._emit("stereo",s._id)}}return n},Howl.prototype.pos=function(t,r,n,i){var a=this;if(!a._webAudio)return a;if("loaded"!==a._state)return a._queue.push({event:"pos",action:function(){a.pos(t,r,n,i)}}),a;if(r="number"!=typeof r?0:r,n="number"!=typeof n?-.5:n,typeof i>"u"){if("number"!=typeof t)return a._pos;a._pos=[t,r,n]}for(var o=a._getSoundIds(i),s=0;s<o.length;s++){var l=a._soundById(o[s]);if(l){if("number"!=typeof t)return l._pos;l._pos=[t,r,n],l._node&&((!l._panner||l._panner.pan)&&e(l,"spatial"),typeof l._panner.positionX<"u"?(l._panner.positionX.setValueAtTime(t,Howler.ctx.currentTime),l._panner.positionY.setValueAtTime(r,Howler.ctx.currentTime),l._panner.positionZ.setValueAtTime(n,Howler.ctx.currentTime)):l._panner.setPosition(t,r,n)),a._emit("pos",l._id)}}return a},Howl.prototype.orientation=function(t,r,n,i){var a=this;if(!a._webAudio)return a;if("loaded"!==a._state)return a._queue.push({event:"orientation",action:function(){a.orientation(t,r,n,i)}}),a;if(r="number"!=typeof r?a._orientation[1]:r,n="number"!=typeof n?a._orientation[2]:n,typeof i>"u"){if("number"!=typeof t)return a._orientation;a._orientation=[t,r,n]}for(var o=a._getSoundIds(i),s=0;s<o.length;s++){var l=a._soundById(o[s]);if(l){if("number"!=typeof t)return l._orientation;l._orientation=[t,r,n],l._node&&(l._panner||(l._pos||(l._pos=a._pos||[0,0,-.5]),e(l,"spatial")),typeof l._panner.orientationX<"u"?(l._panner.orientationX.setValueAtTime(t,Howler.ctx.currentTime),l._panner.orientationY.setValueAtTime(r,Howler.ctx.currentTime),l._panner.orientationZ.setValueAtTime(n,Howler.ctx.currentTime)):l._panner.setOrientation(t,r,n)),a._emit("orientation",l._id)}}return a},Howl.prototype.pannerAttr=function(){var t,r,n,i=this,a=arguments;if(!i._webAudio)return i;if(0===a.length)return i._pannerAttr;if(1===a.length){if("object"!=typeof a[0])return(n=i._soundById(parseInt(a[0],10)))?n._pannerAttr:i._pannerAttr;t=a[0],typeof r>"u"&&(t.pannerAttr||(t.pannerAttr={coneInnerAngle:t.coneInnerAngle,coneOuterAngle:t.coneOuterAngle,coneOuterGain:t.coneOuterGain,distanceModel:t.distanceModel,maxDistance:t.maxDistance,refDistance:t.refDistance,rolloffFactor:t.rolloffFactor,panningModel:t.panningModel}),i._pannerAttr={coneInnerAngle:typeof t.pannerAttr.coneInnerAngle<"u"?t.pannerAttr.coneInnerAngle:i._coneInnerAngle,coneOuterAngle:typeof t.pannerAttr.coneOuterAngle<"u"?t.pannerAttr.coneOuterAngle:i._coneOuterAngle,coneOuterGain:typeof t.pannerAttr.coneOuterGain<"u"?t.pannerAttr.coneOuterGain:i._coneOuterGain,distanceModel:typeof t.pannerAttr.distanceModel<"u"?t.pannerAttr.distanceModel:i._distanceModel,maxDistance:typeof t.pannerAttr.maxDistance<"u"?t.pannerAttr.maxDistance:i._maxDistance,refDistance:typeof t.pannerAttr.refDistance<"u"?t.pannerAttr.refDistance:i._refDistance,rolloffFactor:typeof t.pannerAttr.rolloffFactor<"u"?t.pannerAttr.rolloffFactor:i._rolloffFactor,panningModel:typeof t.pannerAttr.panningModel<"u"?t.pannerAttr.panningModel:i._panningModel})}else 2===a.length&&(t=a[0],r=parseInt(a[1],10));for(var o=i._getSoundIds(r),s=0;s<o.length;s++)if(n=i._soundById(o[s])){var l=n._pannerAttr;l={coneInnerAngle:typeof t.coneInnerAngle<"u"?t.coneInnerAngle:l.coneInnerAngle,coneOuterAngle:typeof t.coneOuterAngle<"u"?t.coneOuterAngle:l.coneOuterAngle,coneOuterGain:typeof t.coneOuterGain<"u"?t.coneOuterGain:l.coneOuterGain,distanceModel:typeof t.distanceModel<"u"?t.distanceModel:l.distanceModel,maxDistance:typeof t.maxDistance<"u"?t.maxDistance:l.maxDistance,refDistance:typeof t.refDistance<"u"?t.refDistance:l.refDistance,rolloffFactor:typeof t.rolloffFactor<"u"?t.rolloffFactor:l.rolloffFactor,panningModel:typeof t.panningModel<"u"?t.panningModel:l.panningModel};var h=n._panner;h?(h.coneInnerAngle=l.coneInnerAngle,h.coneOuterAngle=l.coneOuterAngle,h.coneOuterGain=l.coneOuterGain,h.distanceModel=l.distanceModel,h.maxDistance=l.maxDistance,h.refDistance=l.refDistance,h.rolloffFactor=l.rolloffFactor,h.panningModel=l.panningModel):(n._pos||(n._pos=i._pos||[0,0,-.5]),e(n,"spatial"))}return i},Sound.prototype.init=function(t){return function(){var e=this,r=e._parent;e._orientation=r._orientation,e._stereo=r._stereo,e._pos=r._pos,e._pannerAttr=r._pannerAttr,t.call(this),e._stereo?r.stereo(e._stereo):e._pos&&r.pos(e._pos[0],e._pos[1],e._pos[2],e._id)}}(Sound.prototype.init),Sound.prototype.reset=function(t){return function(){var e=this,r=e._parent;return e._orientation=r._orientation,e._stereo=r._stereo,e._pos=r._pos,e._pannerAttr=r._pannerAttr,e._stereo?r.stereo(e._stereo):e._pos?r.pos(e._pos[0],e._pos[1],e._pos[2],e._id):e._panner&&(e._panner.disconnect(0),e._panner=void 0,r._refreshBuffer(e)),t.call(this)}}(Sound.prototype.reset);var e=function(t,e){"spatial"===(e=e||"spatial")?(t._panner=Howler.ctx.createPanner(),t._panner.coneInnerAngle=t._pannerAttr.coneInnerAngle,t._panner.coneOuterAngle=t._pannerAttr.coneOuterAngle,t._panner.coneOuterGain=t._pannerAttr.coneOuterGain,t._panner.distanceModel=t._pannerAttr.distanceModel,t._panner.maxDistance=t._pannerAttr.maxDistance,t._panner.refDistance=t._pannerAttr.refDistance,t._panner.rolloffFactor=t._pannerAttr.rolloffFactor,t._panner.panningModel=t._pannerAttr.panningModel,typeof t._panner.positionX<"u"?(t._panner.positionX.setValueAtTime(t._pos[0],Howler.ctx.currentTime),t._panner.positionY.setValueAtTime(t._pos[1],Howler.ctx.currentTime),t._panner.positionZ.setValueAtTime(t._pos[2],Howler.ctx.currentTime)):t._panner.setPosition(t._pos[0],t._pos[1],t._pos[2]),typeof t._panner.orientationX<"u"?(t._panner.orientationX.setValueAtTime(t._orientation[0],Howler.ctx.currentTime),t._panner.orientationY.setValueAtTime(t._orientation[1],Howler.ctx.currentTime),t._panner.orientationZ.setValueAtTime(t._orientation[2],Howler.ctx.currentTime)):t._panner.setOrientation(t._orientation[0],t._orientation[1],t._orientation[2])):(t._panner=Howler.ctx.createStereoPanner(),t._panner.pan.setValueAtTime(t._stereo,Howler.ctx.currentTime)),t._panner.connect(t._node),t._paused||t._parent.pause(t._id,!0).play(t._id,!0)}}()})),S=m(((t,e)=>{e.exports=function(t){for(var e=new Array(t),r=0;r<t;++r)e[r]=r;return e}})),A=m(((t,e)=>{function r(t){return!!t.constructor&&"function"==typeof t.constructor.isBuffer&&t.constructor.isBuffer(t)}e.exports=function(t){return null!=t&&(r(t)||function(t){return"function"==typeof t.readFloatLE&&"function"==typeof t.slice&&r(t.slice(0,0))}(t)||!!t._isBuffer)}})),M=m(((t,e)=>{var r=S(),n=A(),i=typeof Float64Array<"u";function a(t,e){return t[0]-e[0]}function o(){var t,e=this.stride,r=new Array(e.length);for(t=0;t<r.length;++t)r[t]=[Math.abs(e[t]),t];r.sort(a);var n=new Array(r.length);for(t=0;t<n.length;++t)n[t]=r[t][1];return n}function s(t,e){var n=["View",e,"d",t].join("");e<0&&(n="View_Nil"+t);var i="generic"===t;if(-1===e){var a="function "+n+"(a){this.data=a;};var proto="+n+".prototype;proto.dtype='"+t+"';proto.index=function(){return -1};proto.size=0;proto.dimension=-1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function(){return new "+n+"(this.data);};proto.get=proto.set=function(){};proto.pick=function(){return null};return function construct_"+n+"(a){return new "+n+"(a);}";return new Function(a)()}if(0===e){a="function "+n+"(a,d) {this.data = a;this.offset = d};var proto="+n+".prototype;proto.dtype='"+t+"';proto.index=function(){return this.offset};proto.dimension=0;proto.size=1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function "+n+"_copy() {return new "+n+"(this.data,this.offset)};proto.pick=function "+n+"_pick(){return TrivialArray(this.data);};proto.valueOf=proto.get=function "+n+"_get(){return "+(i?"this.data.get(this.offset)":"this.data[this.offset]")+"};proto.set=function "+n+"_set(v){return "+(i?"this.data.set(this.offset,v)":"this.data[this.offset]=v")+"};return function construct_"+n+"(a,b,c,d){return new "+n+"(a,d)}";return new Function("TrivialArray",a)(l[t][0])}a=["'use strict'"];var s=r(e),h=s.map((function(t){return"i"+t})),c="this.offset+"+s.map((function(t){return"this.stride["+t+"]*i"+t})).join("+"),u=s.map((function(t){return"b"+t})).join(","),d=s.map((function(t){return"c"+t})).join(",");a.push("function "+n+"(a,"+u+","+d+",d){this.data=a","this.shape=["+u+"]","this.stride=["+d+"]","this.offset=d|0}","var proto="+n+".prototype","proto.dtype='"+t+"'","proto.dimension="+e),a.push("Object.defineProperty(proto,'size',{get:function "+n+"_size(){return "+s.map((function(t){return"this.shape["+t+"]"})).join("*"),"}})"),1===e?a.push("proto.order=[0]"):(a.push("Object.defineProperty(proto,'order',{get:"),e<4?(a.push("function "+n+"_order(){"),2===e?a.push("return (Math.abs(this.stride[0])>Math.abs(this.stride[1]))?[1,0]:[0,1]}})"):3===e&&a.push("var s0=Math.abs(this.stride[0]),s1=Math.abs(this.stride[1]),s2=Math.abs(this.stride[2]);if(s0>s1){if(s1>s2){return [2,1,0];}else if(s0>s2){return [1,2,0];}else{return [1,0,2];}}else if(s0>s2){return [2,0,1];}else if(s2>s1){return [0,1,2];}else{return [0,2,1];}}})")):a.push("ORDER})")),a.push("proto.set=function "+n+"_set("+h.join(",")+",v){"),i?a.push("return this.data.set("+c+",v)}"):a.push("return this.data["+c+"]=v}"),a.push("proto.get=function "+n+"_get("+h.join(",")+"){"),i?a.push("return this.data.get("+c+")}"):a.push("return this.data["+c+"]}"),a.push("proto.index=function "+n+"_index(",h.join(),"){return "+c+"}"),a.push("proto.hi=function "+n+"_hi("+h.join(",")+"){return new "+n+"(this.data,"+s.map((function(t){return["(typeof i",t,"!=='number'||i",t,"<0)?this.shape[",t,"]:i",t,"|0"].join("")})).join(",")+","+s.map((function(t){return"this.stride["+t+"]"})).join(",")+",this.offset)}");var p=s.map((function(t){return"a"+t+"=this.shape["+t+"]"})),f=s.map((function(t){return"c"+t+"=this.stride["+t+"]"}));a.push("proto.lo=function "+n+"_lo("+h.join(",")+"){var b=this.offset,d=0,"+p.join(",")+","+f.join(","));for(var m=0;m<e;++m)a.push("if(typeof i"+m+"==='number'&&i"+m+">=0){d=i"+m+"|0;b+=c"+m+"*d;a"+m+"-=d}");a.push("return new "+n+"(this.data,"+s.map((function(t){return"a"+t})).join(",")+","+s.map((function(t){return"c"+t})).join(",")+",b)}"),a.push("proto.step=function "+n+"_step("+h.join(",")+"){var "+s.map((function(t){return"a"+t+"=this.shape["+t+"]"})).join(",")+","+s.map((function(t){return"b"+t+"=this.stride["+t+"]"})).join(",")+",c=this.offset,d=0,ceil=Math.ceil");for(m=0;m<e;++m)a.push("if(typeof i"+m+"==='number'){d=i"+m+"|0;if(d<0){c+=b"+m+"*(a"+m+"-1);a"+m+"=ceil(-a"+m+"/d)}else{a"+m+"=ceil(a"+m+"/d)}b"+m+"*=d}");a.push("return new "+n+"(this.data,"+s.map((function(t){return"a"+t})).join(",")+","+s.map((function(t){return"b"+t})).join(",")+",c)}");var v=new Array(e),g=new Array(e);for(m=0;m<e;++m)v[m]="a[i"+m+"]",g[m]="b[i"+m+"]";a.push("proto.transpose=function "+n+"_transpose("+h+"){"+h.map((function(t,e){return t+"=("+t+"===undefined?"+e+":"+t+"|0)"})).join(";"),"var a=this.shape,b=this.stride;return new "+n+"(this.data,"+v.join(",")+","+g.join(",")+",this.offset)}"),a.push("proto.pick=function "+n+"_pick("+h+"){var a=[],b=[],c=this.offset");for(m=0;m<e;++m)a.push("if(typeof i"+m+"==='number'&&i"+m+">=0){c=(c+this.stride["+m+"]*i"+m+")|0}else{a.push(this.shape["+m+"]);b.push(this.stride["+m+"])}");return a.push("var ctor=CTOR_LIST[a.length+1];return ctor(this.data,a,b,c)}"),a.push("return function construct_"+n+"(data,shape,stride,offset){return new "+n+"(data,"+s.map((function(t){return"shape["+t+"]"})).join(",")+","+s.map((function(t){return"stride["+t+"]"})).join(",")+",offset)}"),new Function("CTOR_LIST","ORDER",a.join("\n"))(l[t],o)}var l={float32:[],float64:[],int8:[],int16:[],int32:[],uint8:[],uint16:[],uint32:[],array:[],uint8_clamped:[],bigint64:[],biguint64:[],buffer:[],generic:[]};e.exports=function(t,e,r,a){if(void 0===t)return(0,l.array[0])([]);"number"==typeof t&&(t=[t]),void 0===e&&(e=[t.length]);var o=e.length;if(void 0===r){r=new Array(o);for(var h=o-1,c=1;h>=0;--h)r[h]=c,c*=e[h]}if(void 0===a){a=0;for(h=0;h<o;++h)r[h]<0&&(a-=(e[h]-1)*r[h])}for(var u=function(t){if(n(t))return"buffer";if(i)switch(Object.prototype.toString.call(t)){case"[object Float64Array]":return"float64";case"[object Float32Array]":return"float32";case"[object Int8Array]":return"int8";case"[object Int16Array]":return"int16";case"[object Int32Array]":return"int32";case"[object Uint8Array]":return"uint8";case"[object Uint16Array]":return"uint16";case"[object Uint32Array]":return"uint32";case"[object Uint8ClampedArray]":return"uint8_clamped";case"[object BigInt64Array]":return"bigint64";case"[object BigUint64Array]":return"biguint64"}return Array.isArray(t)?"array":"generic"}(t),d=l[u];d.length<=o+1;)d.push(s(u,d.length-1));return(0,d[o+1])(t,e,r,a)}})),C=m(((t,e)=>{e.exports=function(t,e,r){return 0===t.length?t:e?(r||t.sort(e),function(t,e){for(var r=1,n=t.length,i=t[0],a=t[0],o=1;o<n;++o)if(a=i,e(i=t[o],a)){if(o===r){r++;continue}t[r++]=i}return t.length=r,t}(t,e)):(r||t.sort(),function(t){for(var e=1,r=t.length,n=t[0],i=t[0],a=1;a<r;++a,i=n)if(i=n,(n=t[a])!==i){if(a===e){e++;continue}t[e++]=n}return t.length=e,t}(t))}})),O=m(((t,e)=>{var r=C();function n(t,e,r){var n,i,a=t.length,o=e.arrayArgs.length,s=e.indexArgs.length>0,l=[],h=[],c=0,u=0;for(n=0;n<a;++n)h.push(["i",n,"=0"].join(""));for(i=0;i<o;++i)for(n=0;n<a;++n)u=c,c=t[n],0===n?h.push(["d",i,"s",n,"=t",i,"p",c].join("")):h.push(["d",i,"s",n,"=(t",i,"p",c,"-s",u,"*t",i,"p",u,")"].join(""));for(h.length>0&&l.push("var "+h.join(",")),n=a-1;n>=0;--n)c=t[n],l.push(["for(i",n,"=0;i",n,"<s",c,";++i",n,"){"].join(""));for(l.push(r),n=0;n<a;++n){for(u=c,c=t[n],i=0;i<o;++i)l.push(["p",i,"+=d",i,"s",n].join(""));s&&(n>0&&l.push(["index[",u,"]-=s",u].join("")),l.push(["++index[",c,"]"].join(""))),l.push("}")}return l.join("\n")}function i(t,e,r){for(var n=t.body,i=[],a=[],o=0;o<t.args.length;++o){var s=t.args[o];if(!(s.count<=0)){var l=new RegExp(s.name,"g"),h="",c=e.arrayArgs.indexOf(o);switch(e.argTypes[o]){case"offset":var u=e.offsetArgIndex.indexOf(o);c=e.offsetArgs[u].array,h="+q"+u;case"array":h="p"+c+h;var d="l"+o,p="a"+c;if(0===e.arrayBlockIndices[c])1===s.count?"generic"===r[c]?s.lvalue?(i.push(["var ",d,"=",p,".get(",h,")"].join("")),n=n.replace(l,d),a.push([p,".set(",h,",",d,")"].join(""))):n=n.replace(l,[p,".get(",h,")"].join("")):n=n.replace(l,[p,"[",h,"]"].join("")):"generic"===r[c]?(i.push(["var ",d,"=",p,".get(",h,")"].join("")),n=n.replace(l,d),s.lvalue&&a.push([p,".set(",h,",",d,")"].join(""))):(i.push(["var ",d,"=",p,"[",h,"]"].join("")),n=n.replace(l,d),s.lvalue&&a.push([p,"[",h,"]=",d].join("")));else{for(var f=[s.name],m=[h],v=0;v<Math.abs(e.arrayBlockIndices[c]);v++)f.push("\\s*\\[([^\\]]+)\\]"),m.push("$"+(v+1)+"*t"+c+"b"+v);if(l=new RegExp(f.join(""),"g"),h=m.join("+"),"generic"===r[c])throw new Error("cwise: Generic arrays not supported in combination with blocks!");n=n.replace(l,[p,"[",h,"]"].join(""))}break;case"scalar":n=n.replace(l,"Y"+e.scalarArgs.indexOf(o));break;case"index":n=n.replace(l,"index");break;case"shape":n=n.replace(l,"shape")}}}return[i.join("\n"),n,a.join("\n")].join("\n").trim()}function a(t){for(var e=new Array(t.length),r=!0,n=0;n<t.length;++n){var i=t[n],a=i.match(/\d+/);a=a?a[0]:"",0===i.charAt(0)?e[n]="u"+i.charAt(1)+a:e[n]=i.charAt(0)+a,n>0&&(r=r&&e[n]===e[n-1])}return r?e[0]:e.join("")}e.exports=function(t,e){for(var o=e[1].length-Math.abs(t.arrayBlockIndices[0])|0,s=new Array(t.arrayArgs.length),l=new Array(t.arrayArgs.length),h=0;h<t.arrayArgs.length;++h)l[h]=e[2*h],s[h]=e[2*h+1];var c=[],u=[],d=[],p=[],f=[];for(h=0;h<t.arrayArgs.length;++h){t.arrayBlockIndices[h]<0?(d.push(0),p.push(o),c.push(o),u.push(o+t.arrayBlockIndices[h])):(d.push(t.arrayBlockIndices[h]),p.push(t.arrayBlockIndices[h]+o),c.push(0),u.push(t.arrayBlockIndices[h]));for(var m=[],v=0;v<s[h].length;v++)d[h]<=s[h][v]&&s[h][v]<p[h]&&m.push(s[h][v]-d[h]);f.push(m)}var g=["SS"],y=["'use strict'"],b=[];for(v=0;v<o;++v)b.push(["s",v,"=SS[",v,"]"].join(""));for(h=0;h<t.arrayArgs.length;++h){g.push("a"+h),g.push("t"+h),g.push("p"+h);for(v=0;v<o;++v)b.push(["t",h,"p",v,"=t",h,"[",d[h]+v,"]"].join(""));for(v=0;v<Math.abs(t.arrayBlockIndices[h]);++v)b.push(["t",h,"b",v,"=t",h,"[",c[h]+v,"]"].join(""))}for(h=0;h<t.scalarArgs.length;++h)g.push("Y"+h);if(t.shapeArgs.length>0&&b.push("shape=SS.slice(0)"),t.indexArgs.length>0){var x=new Array(o);for(h=0;h<o;++h)x[h]="0";b.push(["index=[",x.join(","),"]"].join(""))}for(h=0;h<t.offsetArgs.length;++h){var w=t.offsetArgs[h],_=[];for(v=0;v<w.offset.length;++v)0!==w.offset[v]&&(1===w.offset[v]?_.push(["t",w.array,"p",v].join("")):_.push([w.offset[v],"*t",w.array,"p",v].join("")));0===_.length?b.push("q"+h+"=0"):b.push(["q",h,"=",_.join("+")].join(""))}var S=r([].concat(t.pre.thisVars).concat(t.body.thisVars).concat(t.post.thisVars));for((b=b.concat(S)).length>0&&y.push("var "+b.join(",")),h=0;h<t.arrayArgs.length;++h)y.push("p"+h+"|=0");t.pre.body.length>3&&y.push(i(t.pre,t,l));var A=i(t.body,t,l),M=function(t){for(var e=0,r=t[0].length;e<r;){for(var n=1;n<t.length;++n)if(t[n][e]!==t[0][e])return e;++e}return e}(f);M<o?y.push(function(t,e,r,i){for(var a=e.length,o=r.arrayArgs.length,s=r.blockSize,l=r.indexArgs.length>0,h=[],c=0;c<o;++c)h.push(["var offset",c,"=p",c].join(""));for(c=t;c<a;++c)h.push(["for(var j"+c+"=SS[",e[c],"]|0;j",c,">0;){"].join("")),h.push(["if(j",c,"<",s,"){"].join("")),h.push(["s",e[c],"=j",c].join("")),h.push(["j",c,"=0"].join("")),h.push(["}else{s",e[c],"=",s].join("")),h.push(["j",c,"-=",s,"}"].join("")),l&&h.push(["index[",e[c],"]=j",c].join(""));for(c=0;c<o;++c){for(var u=["offset"+c],d=t;d<a;++d)u.push(["j",d,"*t",c,"p",e[d]].join(""));h.push(["p",c,"=(",u.join("+"),")"].join(""))}for(h.push(n(e,r,i)),c=t;c<a;++c)h.push("}");return h.join("\n")}(M,f[0],t,A)):y.push(n(f[0],t,A)),t.post.body.length>3&&y.push(i(t.post,t,l)),t.debug&&console.log("-----Generated cwise routine for ",e,":\n"+y.join("\n")+"\n----------");var C=[t.funcName||"unnamed","_cwise_loop_",s[0].join("s"),"m",M,a(l)].join("");return new Function(["function ",C,"(",g.join(","),"){",y.join("\n"),"} return ",C].join(""))()}})),D=m(((t,e)=>{var r=O();e.exports=function(t){var e=["'use strict'","var CACHED={}"],n=[],i=t.funcName+"_cwise_thunk";e.push(["return function ",i,"(",t.shimArgs.join(","),"){"].join(""));for(var a=[],o=[],s=[["array",t.arrayArgs[0],".shape.slice(",Math.max(0,t.arrayBlockIndices[0]),t.arrayBlockIndices[0]<0?","+t.arrayBlockIndices[0]+")":")"].join("")],l=[],h=[],c=0;c<t.arrayArgs.length;++c){var u=t.arrayArgs[c];n.push(["t",u,"=array",u,".dtype,","r",u,"=array",u,".order"].join("")),a.push("t"+u),a.push("r"+u),o.push("t"+u),o.push("r"+u+".join()"),s.push("array"+u+".data"),s.push("array"+u+".stride"),s.push("array"+u+".offset|0"),c>0&&(l.push("array"+t.arrayArgs[0]+".shape.length===array"+u+".shape.length+"+(Math.abs(t.arrayBlockIndices[0])-Math.abs(t.arrayBlockIndices[c]))),h.push("array"+t.arrayArgs[0]+".shape[shapeIndex+"+Math.max(0,t.arrayBlockIndices[0])+"]===array"+u+".shape[shapeIndex+"+Math.max(0,t.arrayBlockIndices[c])+"]"))}for(t.arrayArgs.length>1&&(e.push("if (!("+l.join(" && ")+")) throw new Error('cwise: Arrays do not all have the same dimensionality!')"),e.push("for(var shapeIndex=array"+t.arrayArgs[0]+".shape.length-"+Math.abs(t.arrayBlockIndices[0])+"; shapeIndex--\x3e0;) {"),e.push("if (!("+h.join(" && ")+")) throw new Error('cwise: Arrays do not all have the same shape!')"),e.push("}")),c=0;c<t.scalarArgs.length;++c)s.push("scalar"+t.scalarArgs[c]);return n.push(["type=[",o.join(","),"].join()"].join("")),n.push("proc=CACHED[type]"),e.push("var "+n.join(",")),e.push(["if(!proc){","CACHED[type]=proc=compile([",a.join(","),"])}","return proc(",s.join(","),")}"].join("")),t.debug&&console.log("-----Generated thunk:\n"+e.join("\n")+"\n----------"),new Function("compile",e.join("\n"))(r.bind(void 0,t))}})),P=m(((t,e)=>{var r=D();function n(){this.argTypes=[],this.shimArgs=[],this.arrayArgs=[],this.arrayBlockIndices=[],this.scalarArgs=[],this.offsetArgs=[],this.offsetArgIndex=[],this.indexArgs=[],this.shapeArgs=[],this.funcName="",this.pre=null,this.body=null,this.post=null,this.debug=!1}e.exports=function(t){var e=new n;e.pre=t.pre,e.body=t.body,e.post=t.post;var i=t.args.slice(0);e.argTypes=i;for(var a=0;a<i.length;++a){var o=i[a];if("array"===o||"object"==typeof o&&o.blockIndices){if(e.argTypes[a]="array",e.arrayArgs.push(a),e.arrayBlockIndices.push(o.blockIndices?o.blockIndices:0),e.shimArgs.push("array"+a),a<e.pre.args.length&&e.pre.args[a].count>0)throw new Error("cwise: pre() block may not reference array args");if(a<e.post.args.length&&e.post.args[a].count>0)throw new Error("cwise: post() block may not reference array args")}else if("scalar"===o)e.scalarArgs.push(a),e.shimArgs.push("scalar"+a);else if("index"===o){if(e.indexArgs.push(a),a<e.pre.args.length&&e.pre.args[a].count>0)throw new Error("cwise: pre() block may not reference array index");if(a<e.body.args.length&&e.body.args[a].lvalue)throw new Error("cwise: body() block may not write to array index");if(a<e.post.args.length&&e.post.args[a].count>0)throw new Error("cwise: post() block may not reference array index")}else if("shape"===o){if(e.shapeArgs.push(a),a<e.pre.args.length&&e.pre.args[a].lvalue)throw new Error("cwise: pre() block may not write to array shape");if(a<e.body.args.length&&e.body.args[a].lvalue)throw new Error("cwise: body() block may not write to array shape");if(a<e.post.args.length&&e.post.args[a].lvalue)throw new Error("cwise: post() block may not write to array shape")}else{if("object"!=typeof o||!o.offset)throw new Error("cwise: Unknown argument type "+i[a]);e.argTypes[a]="offset",e.offsetArgs.push({array:o.array,offset:o.offset}),e.offsetArgIndex.push(a)}}if(e.arrayArgs.length<=0)throw new Error("cwise: No array arguments specified");if(e.pre.args.length>i.length)throw new Error("cwise: Too many arguments in pre() block");if(e.body.args.length>i.length)throw new Error("cwise: Too many arguments in body() block");if(e.post.args.length>i.length)throw new Error("cwise: Too many arguments in post() block");return e.debug=!!t.printCode||!!t.debug,e.funcName=t.funcName||"cwise",e.blockSize=t.blockSize||64,r(e)}})),T=m((t=>{var e=P(),r={body:"",args:[],thisVars:[],localVars:[]};function n(t){if(!t)return r;for(var e=0;e<t.args.length;++e){var n=t.args[e];t.args[e]=0===e?{name:n,lvalue:!0,rvalue:!!t.rvalue,count:t.count||1}:{name:n,lvalue:!1,rvalue:!0,count:1}}return t.thisVars||(t.thisVars=[]),t.localVars||(t.localVars=[]),t}function i(t){for(var r=[],i=0;i<t.args.length;++i)r.push("a"+i);return new Function("P",["return function ",t.funcName,"_ndarrayops(",r.join(","),") {P(",r.join(","),");return a0}"].join(""))(function(t){return e({args:t.args,pre:n(t.pre),body:n(t.body),post:n(t.proc),funcName:t.funcName})}(t))}var a={add:"+",sub:"-",mul:"*",div:"/",mod:"%",band:"&",bor:"|",bxor:"^",lshift:"<<",rshift:">>",rrshift:">>>"};!function(){for(var e in a){var r=a[e];t[e]=i({args:["array","array","array"],body:{args:["a","b","c"],body:"a=b"+r+"c"},funcName:e}),t[e+"eq"]=i({args:["array","array"],body:{args:["a","b"],body:"a"+r+"=b"},rvalue:!0,funcName:e+"eq"}),t[e+"s"]=i({args:["array","array","scalar"],body:{args:["a","b","s"],body:"a=b"+r+"s"},funcName:e+"s"}),t[e+"seq"]=i({args:["array","scalar"],body:{args:["a","s"],body:"a"+r+"=s"},rvalue:!0,funcName:e+"seq"})}}();var o={not:"!",bnot:"~",neg:"-",recip:"1.0/"};!function(){for(var e in o){var r=o[e];t[e]=i({args:["array","array"],body:{args:["a","b"],body:"a="+r+"b"},funcName:e}),t[e+"eq"]=i({args:["array"],body:{args:["a"],body:"a="+r+"a"},rvalue:!0,count:2,funcName:e+"eq"})}}();var s={and:"&&",or:"||",eq:"===",neq:"!==",lt:"<",gt:">",leq:"<=",geq:">="};!function(){for(var e in s){var r=s[e];t[e]=i({args:["array","array","array"],body:{args:["a","b","c"],body:"a=b"+r+"c"},funcName:e}),t[e+"s"]=i({args:["array","array","scalar"],body:{args:["a","b","s"],body:"a=b"+r+"s"},funcName:e+"s"}),t[e+"eq"]=i({args:["array","array"],body:{args:["a","b"],body:"a=a"+r+"b"},rvalue:!0,count:2,funcName:e+"eq"}),t[e+"seq"]=i({args:["array","scalar"],body:{args:["a","s"],body:"a=a"+r+"s"},rvalue:!0,count:2,funcName:e+"seq"})}}();var l=["abs","acos","asin","atan","ceil","cos","exp","floor","log","round","sin","sqrt","tan"];!function(){for(var e=0;e<l.length;++e){var r=l[e];t[r]=i({args:["array","array"],pre:{args:[],body:"this_f=Math."+r,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(b)",thisVars:["this_f"]},funcName:r}),t[r+"eq"]=i({args:["array"],pre:{args:[],body:"this_f=Math."+r,thisVars:["this_f"]},body:{args:["a"],body:"a=this_f(a)",thisVars:["this_f"]},rvalue:!0,count:2,funcName:r+"eq"})}}();var h=["max","min","atan2","pow"];!function(){for(var e=0;e<h.length;++e){var r=h[e];t[r]=i({args:["array","array","array"],pre:{args:[],body:"this_f=Math."+r,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(b,c)",thisVars:["this_f"]},funcName:r}),t[r+"s"]=i({args:["array","array","scalar"],pre:{args:[],body:"this_f=Math."+r,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(b,c)",thisVars:["this_f"]},funcName:r+"s"}),t[r+"eq"]=i({args:["array","array"],pre:{args:[],body:"this_f=Math."+r,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(a,b)",thisVars:["this_f"]},rvalue:!0,count:2,funcName:r+"eq"}),t[r+"seq"]=i({args:["array","scalar"],pre:{args:[],body:"this_f=Math."+r,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(a,b)",thisVars:["this_f"]},rvalue:!0,count:2,funcName:r+"seq"})}}();var c=["atan2","pow"];!function(){for(var e=0;e<c.length;++e){var r=c[e];t[r+"op"]=i({args:["array","array","array"],pre:{args:[],body:"this_f=Math."+r,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(c,b)",thisVars:["this_f"]},funcName:r+"op"}),t[r+"ops"]=i({args:["array","array","scalar"],pre:{args:[],body:"this_f=Math."+r,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(c,b)",thisVars:["this_f"]},funcName:r+"ops"}),t[r+"opeq"]=i({args:["array","array"],pre:{args:[],body:"this_f=Math."+r,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(b,a)",thisVars:["this_f"]},rvalue:!0,count:2,funcName:r+"opeq"}),t[r+"opseq"]=i({args:["array","scalar"],pre:{args:[],body:"this_f=Math."+r,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(b,a)",thisVars:["this_f"]},rvalue:!0,count:2,funcName:r+"opseq"})}}(),t.any=e({args:["array"],pre:r,body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:1}],body:"if(a){return true}",localVars:[],thisVars:[]},post:{args:[],localVars:[],thisVars:[],body:"return false"},funcName:"any"}),t.all=e({args:["array"],pre:r,body:{args:[{name:"x",lvalue:!1,rvalue:!0,count:1}],body:"if(!x){return false}",localVars:[],thisVars:[]},post:{args:[],localVars:[],thisVars:[],body:"return true"},funcName:"all"}),t.sum=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:1}],body:"this_s+=a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"sum"}),t.prod=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=1"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:1}],body:"this_s*=a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"prod"}),t.norm2squared=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:2}],body:"this_s+=a*a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"norm2squared"}),t.norm2=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:2}],body:"this_s+=a*a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return Math.sqrt(this_s)"},funcName:"norm2"}),t.norminf=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:4}],body:"if(-a>this_s){this_s=-a}else if(a>this_s){this_s=a}",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"norminf"}),t.norm1=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:3}],body:"this_s+=a<0?-a:a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"norm1"}),t.sup=e({args:["array"],pre:{body:"this_h=-Infinity",args:[],thisVars:["this_h"],localVars:[]},body:{body:"if(_inline_1_arg0_>this_h)this_h=_inline_1_arg0_",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_h"],localVars:[]},post:{body:"return this_h",args:[],thisVars:["this_h"],localVars:[]}}),t.inf=e({args:["array"],pre:{body:"this_h=Infinity",args:[],thisVars:["this_h"],localVars:[]},body:{body:"if(_inline_1_arg0_<this_h)this_h=_inline_1_arg0_",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_h"],localVars:[]},post:{body:"return this_h",args:[],thisVars:["this_h"],localVars:[]}}),t.argmin=e({args:["index","array","shape"],pre:{body:"{this_v=Infinity;this_i=_inline_0_arg2_.slice(0)}",args:[{name:"_inline_0_arg0_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg1_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg2_",lvalue:!1,rvalue:!0,count:1}],thisVars:["this_i","this_v"],localVars:[]},body:{body:"{if(_inline_1_arg1_<this_v){this_v=_inline_1_arg1_;for(var _inline_1_k=0;_inline_1_k<_inline_1_arg0_.length;++_inline_1_k){this_i[_inline_1_k]=_inline_1_arg0_[_inline_1_k]}}}",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2},{name:"_inline_1_arg1_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_i","this_v"],localVars:["_inline_1_k"]},post:{body:"{return this_i}",args:[],thisVars:["this_i"],localVars:[]}}),t.argmax=e({args:["index","array","shape"],pre:{body:"{this_v=-Infinity;this_i=_inline_0_arg2_.slice(0)}",args:[{name:"_inline_0_arg0_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg1_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg2_",lvalue:!1,rvalue:!0,count:1}],thisVars:["this_i","this_v"],localVars:[]},body:{body:"{if(_inline_1_arg1_>this_v){this_v=_inline_1_arg1_;for(var _inline_1_k=0;_inline_1_k<_inline_1_arg0_.length;++_inline_1_k){this_i[_inline_1_k]=_inline_1_arg0_[_inline_1_k]}}}",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2},{name:"_inline_1_arg1_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_i","this_v"],localVars:["_inline_1_k"]},post:{body:"{return this_i}",args:[],thisVars:["this_i"],localVars:[]}}),t.random=i({args:["array"],pre:{args:[],body:"this_f=Math.random",thisVars:["this_f"]},body:{args:["a"],body:"a=this_f()",thisVars:["this_f"]},funcName:"random"}),t.assign=i({args:["array","array"],body:{args:["a","b"],body:"a=b"},funcName:"assign"}),t.assigns=i({args:["array","scalar"],body:{args:["a","b"],body:"a=b"},funcName:"assigns"}),t.equals=e({args:["array","array"],pre:r,body:{args:[{name:"x",lvalue:!1,rvalue:!0,count:1},{name:"y",lvalue:!1,rvalue:!0,count:1}],body:"if(x!==y){return false}",localVars:[],thisVars:[]},post:{args:[],localVars:[],thisVars:[],body:"return true"},funcName:"equals"})})),z=m(((t,e)=>{e.exports=function(t,e){for(var r=t.split("."),n=e.split("."),i=0;i<3;i++){var a=Number(r[i]),o=Number(n[i]);if(a>o)return 1;if(o>a)return-1;if(!isNaN(a)&&isNaN(o))return 1;if(isNaN(a)&&!isNaN(o))return-1}return 0}}));function E(t,e){return Object.setPrototypeOf(t,e),t}function I(t){return Array.isArray(t)?t:[t]}var L="object"==typeof global&&global&&global.Object===Object&&global,B="object"==typeof self&&self&&self.Object===Object&&self,k=L||B||Function("return this")(),V=k.Symbol,U=Object.prototype,j=U.hasOwnProperty,N=U.toString,R=V?V.toStringTag:void 0;var F=function(t){var e=j.call(t,R),r=t[R];try{t[R]=void 0;var n=!0}catch{}var i=N.call(t);return n&&(e?t[R]=r:delete t[R]),i},G=Object.prototype.toString;var q=function(t){return G.call(t)},H=V?V.toStringTag:void 0;var W=function(t){return null==t?void 0===t?"[object Undefined]":"[object Null]":H&&H in Object(t)?F(t):q(t)};var X=function(t){return null!=t&&"object"==typeof t};var Y=function(t){return"symbol"==typeof t||X(t)&&"[object Symbol]"==W(t)};var Q=function(t,e){for(var r=-1,n=null==t?0:t.length,i=Array(n);++r<n;)i[r]=e(t[r],r,t);return i},Z=Array.isArray,K=1/0,J=V?V.prototype:void 0,$=J?J.toString:void 0;var tt=function t(e){if("string"==typeof e)return e;if(Z(e))return Q(e,t)+"";if(Y(e))return $?$.call(e):"";var r=e+"";return"0"==r&&1/e==-K?"-0":r};var et=function(t){var e=typeof t;return null!=t&&("object"==e||"function"==e)};var rt=function(t){return t};var nt=function(t){if(!et(t))return!1;var e=W(t);return"[object Function]"==e||"[object GeneratorFunction]"==e||"[object AsyncFunction]"==e||"[object Proxy]"==e},it=k["__core-js_shared__"],at=function(){var t=/[^.]+$/.exec(it&&it.keys&&it.keys.IE_PROTO||"");return t?"Symbol(src)_1."+t:""}();var ot=function(t){return!!at&&at in t},st=Function.prototype.toString;var lt=function(t){if(null!=t){try{return st.call(t)}catch{}try{return t+""}catch{}}return""},ht=/^\[object .+?Constructor\]$/,ct=Function.prototype,ut=Object.prototype,dt=ct.toString,pt=ut.hasOwnProperty,ft=RegExp("^"+dt.call(pt).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");var mt=function(t){return!(!et(t)||ot(t))&&(nt(t)?ft:ht).test(lt(t))};var vt=function(t,e){return null===t||void 0===t?void 0:t[e]};var gt=function(t,e){var r=vt(t,e);return mt(r)?r:void 0},yt=gt(k,"WeakMap"),bt=Object.create,xt=function(){function t(){}return function(e){if(!et(e))return{};if(bt)return bt(e);t.prototype=e;var r=new t;return t.prototype=void 0,r}}(),wt=xt;var _t=function(t,e,r){switch(r.length){case 0:return t.call(e);case 1:return t.call(e,r[0]);case 2:return t.call(e,r[0],r[1]);case 3:return t.call(e,r[0],r[1],r[2])}return t.apply(e,r)};var St=function(t,e){var r=-1,n=t.length;for(e||(e=Array(n));++r<n;)e[r]=t[r];return e},At=Date.now;var Mt=function(t){var e=0,r=0;return function(){var n=At(),i=16-(n-r);if(r=n,i>0){if(++e>=800)return arguments[0]}else e=0;return t.apply(void 0,arguments)}};var Ct=function(t){return function(){return t}},Ot=function(){try{var t=gt(Object,"defineProperty");return t({},"",{}),t}catch{}}(),Dt=Ot,Pt=Dt?function(t,e){return Dt(t,"toString",{configurable:!0,enumerable:!1,value:Ct(e),writable:!0})}:rt,Tt=Mt(Pt);var zt=function(t,e){for(var r=-1,n=null==t?0:t.length;++r<n&&!1!==e(t[r],r,t););return t},Et=/^(?:0|[1-9]\d*)$/;var It=function(t,e){var r,n=typeof t;return!!(e=null!==(r=e)&&void 0!==r?r:9007199254740991)&&("number"==n||"symbol"!=n&&Et.test(t))&&t>-1&&t%1==0&&t<e};var Lt=function(t,e,r){"__proto__"==e&&Dt?Dt(t,e,{configurable:!0,enumerable:!0,value:r,writable:!0}):t[e]=r};var Bt=function(t,e){return t===e||t!==t&&e!==e},kt=Object.prototype.hasOwnProperty;var Vt=function(t,e,r){var n=t[e];(!kt.call(t,e)||!Bt(n,r)||void 0===r&&!(e in t))&&Lt(t,e,r)};var Ut=function(t,e,r,n){var i=!r;r||(r={});for(var a=-1,o=e.length;++a<o;){var s=e[a],l=n?n(r[s],t[s],s,r,t):void 0;void 0===l&&(l=t[s]),i?Lt(r,s,l):Vt(r,s,l)}return r},jt=Math.max;var Nt=function(t,e,r){return e=jt(void 0===e?t.length-1:e,0),function(){for(var n=arguments,i=-1,a=jt(n.length-e,0),o=Array(a);++i<a;)o[i]=n[e+i];i=-1;for(var s=Array(e+1);++i<e;)s[i]=n[i];return s[e]=r(o),_t(t,this,s)}};var Rt=function(t){return"number"==typeof t&&t>-1&&t%1==0&&t<=9007199254740991};var Ft=function(t){return null!=t&&Rt(t.length)&&!nt(t)},Gt=Object.prototype;var qt=function(t){var e=t&&t.constructor;return t===("function"==typeof e&&e.prototype||Gt)};var Ht=function(t,e){for(var r=-1,n=Array(t);++r<t;)n[r]=e(r);return n};var Wt=function(t){return X(t)&&"[object Arguments]"==W(t)},Xt=Object.prototype,Yt=Xt.hasOwnProperty,Qt=Xt.propertyIsEnumerable,Zt=Wt(function(){return arguments}())?Wt:function(t){return X(t)&&Yt.call(t,"callee")&&!Qt.call(t,"callee")},Kt=Zt;var Jt=function(){return!1},$t="object"==typeof exports&&exports&&!exports.nodeType&&exports,te=$t&&"object"==typeof module&&module&&!module.nodeType&&module,ee=te&&te.exports===$t?k.Buffer:void 0,re=(ee?ee.isBuffer:void 0)||Jt,ne={};ne["[object Float32Array]"]=ne["[object Float64Array]"]=ne["[object Int8Array]"]=ne["[object Int16Array]"]=ne["[object Int32Array]"]=ne["[object Uint8Array]"]=ne["[object Uint8ClampedArray]"]=ne["[object Uint16Array]"]=ne["[object Uint32Array]"]=!0,ne["[object Arguments]"]=ne["[object Array]"]=ne["[object ArrayBuffer]"]=ne["[object Boolean]"]=ne["[object DataView]"]=ne["[object Date]"]=ne["[object Error]"]=ne["[object Function]"]=ne["[object Map]"]=ne["[object Number]"]=ne["[object Object]"]=ne["[object RegExp]"]=ne["[object Set]"]=ne["[object String]"]=ne["[object WeakMap]"]=!1;var ie=function(t){return X(t)&&Rt(t.length)&&!!ne[W(t)]};var ae=function(t){return function(e){return t(e)}},oe="object"==typeof exports&&exports&&!exports.nodeType&&exports,se=oe&&"object"==typeof module&&module&&!module.nodeType&&module,le=se&&se.exports===oe&&L.process,he=function(){try{return se&&se.require&&se.require("util").types||le&&le.binding&&le.binding("util")}catch{}}(),ce=he&&he.isTypedArray,ue=ce?ae(ce):ie,de=Object.prototype.hasOwnProperty;var pe=function(t,e){var r=Z(t),n=!r&&Kt(t),i=!r&&!n&&re(t),a=!r&&!n&&!i&&ue(t),o=r||n||i||a,s=o?Ht(t.length,String):[],l=s.length;for(var h in t)(e||de.call(t,h))&&(!o||!("length"==h||i&&("offset"==h||"parent"==h)||a&&("buffer"==h||"byteLength"==h||"byteOffset"==h)||It(h,l)))&&s.push(h);return s};var fe=function(t,e){return function(r){return t(e(r))}},me=fe(Object.keys,Object),ve=Object.prototype.hasOwnProperty;var ge=function(t){if(!qt(t))return me(t);var e=[];for(var r in Object(t))ve.call(t,r)&&"constructor"!=r&&e.push(r);return e};var ye=function(t){return Ft(t)?pe(t):ge(t)};var be=function(t){var e=[];if(null!=t)for(var r in Object(t))e.push(r);return e},xe=Object.prototype.hasOwnProperty;var we=function(t){if(!et(t))return be(t);var e=qt(t),r=[];for(var n in t)"constructor"==n&&(e||!xe.call(t,n))||r.push(n);return r};var _e=function(t){return Ft(t)?pe(t,!0):we(t)},Se=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,Ae=/^\w*$/;var Me=function(t,e){if(Z(t))return!1;var r=typeof t;return!("number"!=r&&"symbol"!=r&&"boolean"!=r&&null!=t&&!Y(t))||(Ae.test(t)||!Se.test(t)||null!=e&&t in Object(e))},Ce=gt(Object,"create");var Oe=function(){this.__data__=Ce?Ce(null):{},this.size=0};var De=function(t){var e=this.has(t)&&delete this.__data__[t];return this.size-=e?1:0,e},Pe=Object.prototype.hasOwnProperty;var Te=function(t){var e=this.__data__;if(Ce){var r=e[t];return"__lodash_hash_undefined__"===r?void 0:r}return Pe.call(e,t)?e[t]:void 0},ze=Object.prototype.hasOwnProperty;var Ee=function(t){var e=this.__data__;return Ce?void 0!==e[t]:ze.call(e,t)};var Ie=function(t,e){var r=this.__data__;return this.size+=this.has(t)?0:1,r[t]=Ce&&void 0===e?"__lodash_hash_undefined__":e,this};function Le(t){var e=-1,r=null==t?0:t.length;for(this.clear();++e<r;){var n=t[e];this.set(n[0],n[1])}}Le.prototype.clear=Oe,Le.prototype.delete=De,Le.prototype.get=Te,Le.prototype.has=Ee,Le.prototype.set=Ie;var Be=Le;var ke=function(){this.__data__=[],this.size=0};var Ve=function(t,e){for(var r=t.length;r--;)if(Bt(t[r][0],e))return r;return-1},Ue=Array.prototype.splice;var je=function(t){var e=this.__data__,r=Ve(e,t);return!(r<0)&&(r==e.length-1?e.pop():Ue.call(e,r,1),--this.size,!0)};var Ne=function(t){var e=this.__data__,r=Ve(e,t);return r<0?void 0:e[r][1]};var Re=function(t){return Ve(this.__data__,t)>-1};var Fe=function(t,e){var r=this.__data__,n=Ve(r,t);return n<0?(++this.size,r.push([t,e])):r[n][1]=e,this};function Ge(t){var e=-1,r=null==t?0:t.length;for(this.clear();++e<r;){var n=t[e];this.set(n[0],n[1])}}Ge.prototype.clear=ke,Ge.prototype.delete=je,Ge.prototype.get=Ne,Ge.prototype.has=Re,Ge.prototype.set=Fe;var qe=Ge,He=gt(k,"Map");var We=function(){this.size=0,this.__data__={hash:new Be,map:new(He||qe),string:new Be}};var Xe=function(t){var e=typeof t;return"string"==e||"number"==e||"symbol"==e||"boolean"==e?"__proto__"!==t:null===t};var Ye=function(t,e){var r=t.__data__;return Xe(e)?r["string"==typeof e?"string":"hash"]:r.map};var Qe=function(t){var e=Ye(this,t).delete(t);return this.size-=e?1:0,e};var Ze=function(t){return Ye(this,t).get(t)};var Ke=function(t){return Ye(this,t).has(t)};var Je=function(t,e){var r=Ye(this,t),n=r.size;return r.set(t,e),this.size+=r.size==n?0:1,this};function $e(t){var e=-1,r=null==t?0:t.length;for(this.clear();++e<r;){var n=t[e];this.set(n[0],n[1])}}$e.prototype.clear=We,$e.prototype.delete=Qe,$e.prototype.get=Ze,$e.prototype.has=Ke,$e.prototype.set=Je;var tr=$e;function er(t,e){if("function"!=typeof t||null!=e&&"function"!=typeof e)throw new TypeError("Expected a function");var r=function(){var n=arguments,i=e?e.apply(this,n):n[0],a=r.cache;if(a.has(i))return a.get(i);var o=t.apply(this,n);return r.cache=a.set(i,o)||a,o};return r.cache=new(er.Cache||tr),r}er.Cache=tr;var rr=er;var nr=function(t){var e=rr(t,(function(t){return 500===r.size&&r.clear(),t})),r=e.cache;return e},ir=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,ar=/\\(\\)?/g,or=nr((function(t){var e=[];return 46===t.charCodeAt(0)&&e.push(""),t.replace(ir,(function(t,r,n,i){e.push(n?i.replace(ar,"$1"):r||t)})),e})),sr=or;var lr=function(t){return null==t?"":tt(t)};var hr=function(t,e){return Z(t)?t:Me(t,e)?[t]:sr(lr(t))},cr=1/0;var ur=function(t){if("string"==typeof t||Y(t))return t;var e=t+"";return"0"==e&&1/t==-cr?"-0":e};var dr=function(t,e){for(var r=0,n=(e=hr(e,t)).length;null!=t&&r<n;)t=t[ur(e[r++])];return r&&r==n?t:void 0};var pr=function(t,e){for(var r=-1,n=e.length,i=t.length;++r<n;)t[i+r]=e[r];return t},fr=V?V.isConcatSpreadable:void 0;var mr=function(t){return Z(t)||Kt(t)||!!(fr&&t&&t[fr])};var vr=function t(e,r,n,i,a){var o=-1,s=e.length;for(n||(n=mr),a||(a=[]);++o<s;){var l=e[o];r>0&&n(l)?r>1?t(l,r-1,n,i,a):pr(a,l):i||(a[a.length]=l)}return a};var gr=function(t){return(null==t?0:t.length)?vr(t,1):[]};var yr=function(t){return Tt(Nt(t,void 0,gr),t+"")},br=fe(Object.getPrototypeOf,Object),xr=Function.prototype,wr=Object.prototype,_r=xr.toString,Sr=wr.hasOwnProperty,Ar=_r.call(Object);var Mr=function(t){if(!X(t)||"[object Object]"!=W(t))return!1;var e=br(t);if(null===e)return!0;var r=Sr.call(e,"constructor")&&e.constructor;return"function"==typeof r&&r instanceof r&&_r.call(r)==Ar};var Cr=function(t,e,r){var n=-1,i=t.length;e<0&&(e=-e>i?0:i+e),(r=r>i?i:r)<0&&(r+=i),i=e>r?0:r-e>>>0,e>>>=0;for(var a=Array(i);++n<i;)a[n]=t[n+e];return a};var Or=function(){this.__data__=new qe,this.size=0};var Dr=function(t){var e=this.__data__,r=e.delete(t);return this.size=e.size,r};var Pr=function(t){return this.__data__.get(t)};var Tr=function(t){return this.__data__.has(t)};var zr=function(t,e){var r=this.__data__;if(r instanceof qe){var n=r.__data__;if(!He||n.length<199)return n.push([t,e]),this.size=++r.size,this;r=this.__data__=new tr(n)}return r.set(t,e),this.size=r.size,this};function Er(t){var e=this.__data__=new qe(t);this.size=e.size}Er.prototype.clear=Or,Er.prototype.delete=Dr,Er.prototype.get=Pr,Er.prototype.has=Tr,Er.prototype.set=zr;var Ir=Er;var Lr=function(t,e){return t&&Ut(e,ye(e),t)};var Br=function(t,e){return t&&Ut(e,_e(e),t)},kr="object"==typeof exports&&exports&&!exports.nodeType&&exports,Vr=kr&&"object"==typeof module&&module&&!module.nodeType&&module,Ur=Vr&&Vr.exports===kr?k.Buffer:void 0,jr=Ur?Ur.allocUnsafe:void 0;var Nr=function(t,e){if(e)return t.slice();var r=t.length,n=jr?jr(r):new t.constructor(r);return t.copy(n),n};var Rr=function(t,e){for(var r=-1,n=null==t?0:t.length,i=0,a=[];++r<n;){var o=t[r];e(o,r,t)&&(a[i++]=o)}return a};var Fr=function(){return[]},Gr=Object.prototype.propertyIsEnumerable,qr=Object.getOwnPropertySymbols,Hr=qr?function(t){return null==t?[]:(t=Object(t),Rr(qr(t),(function(e){return Gr.call(t,e)})))}:Fr,Wr=Hr;var Xr=function(t,e){return Ut(t,Wr(t),e)},Yr=Object.getOwnPropertySymbols?function(t){for(var e=[];t;)pr(e,Wr(t)),t=br(t);return e}:Fr,Qr=Yr;var Zr=function(t,e){return Ut(t,Qr(t),e)};var Kr=function(t,e,r){var n=e(t);return Z(t)?n:pr(n,r(t))};var Jr=function(t){return Kr(t,ye,Wr)};var $r=function(t){return Kr(t,_e,Qr)},tn=gt(k,"DataView"),en=gt(k,"Promise"),rn=gt(k,"Set"),nn="[object Map]",an="[object Promise]",on="[object Set]",sn="[object WeakMap]",ln="[object DataView]",hn=lt(tn),cn=lt(He),un=lt(en),dn=lt(rn),pn=lt(yt),fn=W;(tn&&fn(new tn(new ArrayBuffer(1)))!=ln||He&&fn(new He)!=nn||en&&fn(en.resolve())!=an||rn&&fn(new rn)!=on||yt&&fn(new yt)!=sn)&&(fn=function(t){var e=W(t),r="[object Object]"==e?t.constructor:void 0,n=r?lt(r):"";if(n)switch(n){case hn:return ln;case cn:return nn;case un:return an;case dn:return on;case pn:return sn}return e});var mn=fn,vn=Object.prototype.hasOwnProperty;var gn=function(t){var e=t.length,r=new t.constructor(e);return e&&"string"==typeof t[0]&&vn.call(t,"index")&&(r.index=t.index,r.input=t.input),r},yn=k.Uint8Array;var bn=function(t){var e=new t.constructor(t.byteLength);return new yn(e).set(new yn(t)),e};var xn=function(t,e){var r=e?bn(t.buffer):t.buffer;return new t.constructor(r,t.byteOffset,t.byteLength)},wn=/\w*$/;var _n=function(t){var e=new t.constructor(t.source,wn.exec(t));return e.lastIndex=t.lastIndex,e},Sn=V?V.prototype:void 0,An=Sn?Sn.valueOf:void 0;var Mn=function(t){return An?Object(An.call(t)):{}};var Cn=function(t,e){var r=e?bn(t.buffer):t.buffer;return new t.constructor(r,t.byteOffset,t.length)};var On=function(t,e,r){var n=t.constructor;switch(e){case"[object ArrayBuffer]":return bn(t);case"[object Boolean]":case"[object Date]":return new n(+t);case"[object DataView]":return xn(t,r);case"[object Float32Array]":case"[object Float64Array]":case"[object Int8Array]":case"[object Int16Array]":case"[object Int32Array]":case"[object Uint8Array]":case"[object Uint8ClampedArray]":case"[object Uint16Array]":case"[object Uint32Array]":return Cn(t,r);case"[object Map]":case"[object Set]":return new n;case"[object Number]":case"[object String]":return new n(t);case"[object RegExp]":return _n(t);case"[object Symbol]":return Mn(t)}};var Dn=function(t){return"function"!=typeof t.constructor||qt(t)?{}:wt(br(t))};var Pn=function(t){return X(t)&&"[object Map]"==mn(t)},Tn=he&&he.isMap,zn=Tn?ae(Tn):Pn;var En=function(t){return X(t)&&"[object Set]"==mn(t)},In=he&&he.isSet,Ln=In?ae(In):En,Bn="[object Arguments]",kn="[object Function]",Vn="[object Object]",Un={};Un[Bn]=Un["[object Array]"]=Un["[object ArrayBuffer]"]=Un["[object DataView]"]=Un["[object Boolean]"]=Un["[object Date]"]=Un["[object Float32Array]"]=Un["[object Float64Array]"]=Un["[object Int8Array]"]=Un["[object Int16Array]"]=Un["[object Int32Array]"]=Un["[object Map]"]=Un["[object Number]"]=Un[Vn]=Un["[object RegExp]"]=Un["[object Set]"]=Un["[object String]"]=Un["[object Symbol]"]=Un["[object Uint8Array]"]=Un["[object Uint8ClampedArray]"]=Un["[object Uint16Array]"]=Un["[object Uint32Array]"]=!0,Un["[object Error]"]=Un[kn]=Un["[object WeakMap]"]=!1;var jn=function t(e,r,n,i,a,o){var s,l=1&r,h=2&r,c=4&r;if(n&&(s=a?n(e,i,a,o):n(e)),void 0!==s)return s;if(!et(e))return e;var u=Z(e);if(u){if(s=gn(e),!l)return St(e,s)}else{var d=mn(e),p=d==kn||"[object GeneratorFunction]"==d;if(re(e))return Nr(e,l);if(d==Vn||d==Bn||p&&!a){if(s=h||p?{}:Dn(e),!l)return h?Zr(e,Br(s,e)):Xr(e,Lr(s,e))}else{if(!Un[d])return a?e:{};s=On(e,d,l)}}o||(o=new Ir);var f=o.get(e);if(f)return f;o.set(e,s),Ln(e)?e.forEach((function(i){s.add(t(i,r,n,i,e,o))})):zn(e)&&e.forEach((function(i,a){s.set(a,t(i,r,n,a,e,o))}));var m=u?void 0:(c?h?$r:Jr:h?_e:ye)(e);return zt(m||e,(function(i,a){m&&(i=e[a=i]),Vt(s,a,t(i,r,n,a,e,o))})),s};var Nn=function(t){return jn(t,5)};var Rn=function(t){return this.__data__.set(t,"__lodash_hash_undefined__"),this};var Fn=function(t){return this.__data__.has(t)};function Gn(t){var e=-1,r=null==t?0:t.length;for(this.__data__=new tr;++e<r;)this.add(t[e])}Gn.prototype.add=Gn.prototype.push=Rn,Gn.prototype.has=Fn;var qn=Gn;var Hn=function(t,e){for(var r=-1,n=null==t?0:t.length;++r<n;)if(e(t[r],r,t))return!0;return!1};var Wn=function(t,e){return t.has(e)};var Xn=function(t,e,r,n,i,a){var o=1&r,s=t.length,l=e.length;if(s!=l&&!(o&&l>s))return!1;var h=a.get(t),c=a.get(e);if(h&&c)return h==e&&c==t;var u=-1,d=!0,p=2&r?new qn:void 0;for(a.set(t,e),a.set(e,t);++u<s;){var f=t[u],m=e[u];if(n)var v=o?n(m,f,u,e,t,a):n(f,m,u,t,e,a);if(void 0!==v){if(v)continue;d=!1;break}if(p){if(!Hn(e,(function(t,e){if(!Wn(p,e)&&(f===t||i(f,t,r,n,a)))return p.push(e)}))){d=!1;break}}else if(f!==m&&!i(f,m,r,n,a)){d=!1;break}}return a.delete(t),a.delete(e),d};var Yn=function(t){var e=-1,r=Array(t.size);return t.forEach((function(t,n){r[++e]=[n,t]})),r};var Qn=function(t){var e=-1,r=Array(t.size);return t.forEach((function(t){r[++e]=t})),r},Zn=V?V.prototype:void 0,Kn=Zn?Zn.valueOf:void 0;var Jn=function(t,e,r,n,i,a,o){switch(r){case"[object DataView]":if(t.byteLength!=e.byteLength||t.byteOffset!=e.byteOffset)return!1;t=t.buffer,e=e.buffer;case"[object ArrayBuffer]":return!(t.byteLength!=e.byteLength||!a(new yn(t),new yn(e)));case"[object Boolean]":case"[object Date]":case"[object Number]":return Bt(+t,+e);case"[object Error]":return t.name==e.name&&t.message==e.message;case"[object RegExp]":case"[object String]":return t==e+"";case"[object Map]":var s=Yn;case"[object Set]":var l=1&n;if(s||(s=Qn),t.size!=e.size&&!l)return!1;var h=o.get(t);if(h)return h==e;n|=2,o.set(t,e);var c=Xn(s(t),s(e),n,i,a,o);return o.delete(t),c;case"[object Symbol]":if(Kn)return Kn.call(t)==Kn.call(e)}return!1},$n=Object.prototype.hasOwnProperty;var ti=function(t,e,r,n,i,a){var o=1&r,s=Jr(t),l=s.length;if(l!=Jr(e).length&&!o)return!1;for(var h=l;h--;){var c=s[h];if(!(o?c in e:$n.call(e,c)))return!1}var u=a.get(t),d=a.get(e);if(u&&d)return u==e&&d==t;var p=!0;a.set(t,e),a.set(e,t);for(var f=o;++h<l;){var m=t[c=s[h]],v=e[c];if(n)var g=o?n(v,m,c,e,t,a):n(m,v,c,t,e,a);if(!(void 0===g?m===v||i(m,v,r,n,a):g)){p=!1;break}f||(f="constructor"==c)}if(p&&!f){var y=t.constructor,b=e.constructor;y!=b&&"constructor"in t&&"constructor"in e&&!("function"==typeof y&&y instanceof y&&"function"==typeof b&&b instanceof b)&&(p=!1)}return a.delete(t),a.delete(e),p},ei="[object Arguments]",ri="[object Array]",ni="[object Object]",ii=Object.prototype.hasOwnProperty;var ai=function(t,e,r,n,i,a){var o=Z(t),s=Z(e),l=o?ri:mn(t),h=s?ri:mn(e),c=(l=l==ei?ni:l)==ni,u=(h=h==ei?ni:h)==ni,d=l==h;if(d&&re(t)){if(!re(e))return!1;o=!0,c=!1}if(d&&!c)return a||(a=new Ir),o||ue(t)?Xn(t,e,r,n,i,a):Jn(t,e,l,r,n,i,a);if(!(1&r)){var p=c&&ii.call(t,"__wrapped__"),f=u&&ii.call(e,"__wrapped__");if(p||f){var m=p?t.value():t,v=f?e.value():e;return a||(a=new Ir),i(m,v,r,n,a)}}return!!d&&(a||(a=new Ir),ti(t,e,r,n,i,a))};var oi=function t(e,r,n,i,a){return e===r||(null==e||null==r||!X(e)&&!X(r)?e!==e&&r!==r:ai(e,r,n,i,t,a))};var si=function(t,e){return null!=t&&e in Object(t)};var li=function(t,e,r){for(var n=-1,i=(e=hr(e,t)).length,a=!1;++n<i;){var o=ur(e[n]);if(!(a=null!=t&&r(t,o)))break;t=t[o]}return a||++n!=i?a:!!(i=null==t?0:t.length)&&Rt(i)&&It(o,i)&&(Z(t)||Kt(t))};var hi=function(t,e){return null!=t&&li(t,e,si)};var ci=function(t){var e=null==t?0:t.length;return e?t[e-1]:void 0};var ui=function(t,e){return e.length<2?t:dr(t,Cr(e,0,-1))};var di=function(t,e){return oi(t,e)};var pi=function(t,e){return e=hr(e,t),null==(t=ui(t,e))||delete t[ur(ci(e))]};var fi=function(t){return Mr(t)?void 0:t},mi=yr((function(t,e){var r={};if(null==t)return r;var n=!1;e=Q(e,(function(e){return e=hr(e,t),n||(n=e.length>1),e})),Ut(t,$r(t),r),n&&(r=jn(r,7,fi));for(var i=e.length;i--;)pi(r,e[i]);return r})),vi=mi;var gi=function(t,e,r,n){if(!et(t))return t;for(var i=-1,a=(e=hr(e,t)).length,o=a-1,s=t;null!=s&&++i<a;){var l=ur(e[i]),h=r;if("__proto__"===l||"constructor"===l||"prototype"===l)return t;if(i!=o){var c=s[l];void 0===(h=n?n(c,l,s):void 0)&&(h=et(c)?c:It(e[i+1])?[]:{})}Vt(s,l,h),s=s[l]}return t};var yi=function(t,e,r){for(var n=-1,i=e.length,a={};++n<i;){var o=e[n],s=dr(t,o);r(s,o)&&gi(a,hr(o,t),s)}return a};var bi=function(t,e){return yi(t,e,(function(e,r){return hi(t,r)}))},xi=yr((function(t,e){return null==t?{}:bi(t,e)})),wi=xi,_i=class{modifyById(t,e){let r=this;if(void 0===r[t])throw new Error("not expected");{let n={...r,[t]:e};return Object.setPrototypeOf(n,_i.prototype),n}}add(t,e){var r,n;return null!==(r=null===(n=this.runOp({type:1,id:t,data:e}))||void 0===n?void 0:n.data)&&void 0!==r?r:this}runOp(t){let e=this;if(1===t.type){let r,n=e[t.id];r=void 0===n?{type:2,id:t.id}:{type:1,id:t.id,data:n};let{id:i,data:a}=t,o={...e,[i]:a};return Object.setPrototypeOf(o,_i.prototype),{data:o,actual:t,reverse:r}}if(2===t.type){let{id:r}=t,n=e[r];if(void 0===n)return null;{let i={...e};return Object.setPrototypeOf(i,_i.prototype),delete i[r],{data:i,actual:t,reverse:{type:1,id:r,data:n}}}}return null}};function Si(t){if(void 0!==t.deepFreeze)return void t.deepFreeze(t);let e=Object.getOwnPropertyNames(t);for(let r of e){let e=t[r];e&&"object"==typeof e&&Si(e)}return Object.freeze(t)}var Ai=class extends Error{};function Mi(t){let e={...t};return Object.setPrototypeOf(e,Object.getPrototypeOf(t)),e}function Ci(t,e,r){if(void 0===t?void 0===e?(t=0,e=10):t=e-10:void 0===e&&(e=t+10),t>e){let r=t;t=e,e=r}let n=[],i=1/(r+1);for(let a=0;a<r;a++){let r=t+(e-t)*(a+.75+.5*Math.random())*i;n.push(r)}return n}function Oi(t){return t instanceof Uint8Array||t instanceof Uint16Array||t instanceof Uint32Array||t instanceof Int8Array||t instanceof Int16Array||t instanceof Int32Array||t instanceof Float32Array||t instanceof Float64Array}function Di(t,e){for(let r of t)!0!==e(r.id,r.data)&&Di(r.children,e)}function Pi(t,e){if(!0!==e(t.id,t.data))for(let r of t.children)Pi(r,e)}var Ti,zi=class extends Array{constructor(){super(...arguments),Object.setPrototypeOf(this,zi.prototype)}deepFreeze(){let t=0;for(;t<this.length;)Si(this[t]),t++}fillCaches0(t,e){this.objCaches.set(t.id,t),this.parentCaches.set(t.id,e);for(let r of t.children)this.fillCaches0(r,t.id)}fillCaches(){if(void 0===this.objCaches){this.objCaches=new Map,this.parentCaches=new Map;for(let t of this)this.fillCaches0(t,null)}}randomId(){this.fillCaches();let t=Array.from(this.objCaches.keys());if(0!==t.length)return t[Math.max(0,Math.floor(Math.random()*t.length)-1)]}nonExistOrDescendantOf(t,e){if(!this.has(t))return!0;for(;t;){let r=this.parent(t);if(r===e)return!0;t=r}return!1}rootAcestor(t){for(;t;){let e=this.parent(t);if(!e)return t;t=e}return t}isDescendantOf(t,e){for(;t;){let r=this.parent(t);if(r===e)return!0;t=r}return!1}data(t){var e;return null===(e=this.get(t))||void 0===e?void 0:e.data}has(t){return void 0!==this.childrenOf(t)}get(t){return this.fillCaches(),this.objCaches.get(t)}childrenOf(t){var e;return null===t?this:null===(e=this.get(t))||void 0===e?void 0:e.children}traverseFrom(t,e){if(null===t)this.traverse(e);else{let r=this.get(t);r&&Pi(r,e)}}traverse(t){Di(this,t)}totalSize(){return this.fillCaches(),this.objCaches.size}parent(t){return this.fillCaches(),this.parentCaches.get(t)}childrenArray(t){return null===t?this:this.get(t).children}modifyById(t,e){if(void 0===this.get(t))throw new Error("not expected");{let r=this.parent(t),n=this.childrenArray(r),i=n.findIndex((e=>e.id===t));if(i<0)throw new Error("not expected");let a=n[i];return n=[...n],n[i]={...a,data:e},this.modifyArrayBy(r,n)}}modifyArrayBy(t,e){let r=t,n=e;for(;null!==r;){let t=n,e=r;if(r=this.parent(r),void 0===r)throw new Error;n=this.childrenArray(r);let i=n.findIndex((t=>t.id===e));if(i<0)throw new Error;n=[...n],n[i]={...n[i],children:t}}Object.setPrototypeOf(n,zi.prototype);let i=n;return i.fillCaches(),i}runOp(t){switch(t.type){case 7:return this.addOp(t);case 8:return this.deleteOp(t);case 9:return this.moveOp(t)}return null}checkDuplicatedIdRec(t){let{id:e,children:r}=t;if(void 0!==this.get(e))return!0;for(let n of r)if(this.checkDuplicatedIdRec(n))return!0;return!1}addOp(t){let{parent:e,fi:r,id:n,data:i,children:a}=t;if(null!==e&&void 0===this.get(e))return null;if(this.checkDuplicatedIdRec(t))return null;{let o=e,s=this.childrenArray(o),l={fi:r,id:n,data:i,children:a};return s=[...s,l],s.sort(((t,e)=>t.fi-e.fi)),t.localIndex=s.indexOf(l),{data:this.modifyArrayBy(o,s),actual:t,reverse:{type:8,id:n}}}}deleteOp(t){let{id:e}=t;if(null===this.get(e))return null;{let r=this.parent(e);if(void 0===r)return null;let n=this.childrenArray(r),i=n.findIndex((t=>t.id===e));t.localIndex=i,n=[...n];let a=n.splice(i,1)[0];return{data:this.modifyArrayBy(r,n),actual:t,reverse:{type:7,...a,parent:r}}}}moveOp(t){let{parent:e,fi:r,id:n}=t;if(null!==e&&void 0===this.get(e))return this.deleteOp({type:8,id:n});if(null!==e){let t=e;for(;null!==t;){if(void 0===t)throw new Error;if(t===n)throw new Ai("cyclic tree");t=this.parent(t)}}let i=this.parent(n);if(void 0===i)return null;let a=i,o=this.childrenArray(i),s=o.findIndex((t=>t.id===n));o=[...o];let l=o.splice(s,1)[0],h=this.modifyArrayBy(i,o);i=e,o=h.childrenArray(i);let c=l.fi;return l={...l,fi:r},o=[...o,l],o.sort(((t,e)=>t.fi-e.fi)),t.localIndex=o.indexOf(l),h=h.modifyArrayBy(i,o),{data:h,actual:t,reverse:{type:9,parent:a,fi:c,id:n}}}previous(t,e){if(null===e){let e=this.childrenArray(t);return 0===e.length?null:e[e.length-1].id}let r=null;for(let n of this.childrenArray(t)){if(n.id===e)return r;r=n.id}return null}traverseSortNext(t){let e=this.parent(t);if(void 0!==e){let r=this.childrenArray(e),n=r.findIndex((e=>e.id===t))+1;if(n<r.length)return r[n].id;if(e)return this.traverseSortNext(e)}}sortNext(t){let e=this.childrenArray(t);return e.length>0?e[0].id:this.traverseSortNext(t)}traverseSortPrevious(t){let e=this.childrenArray(t);return e.length>0?this.traverseSortPrevious(e[e.length-1].id):t}sortPrevious(t){let e=this.parent(t);if(void 0!==e){let r=this.childrenArray(e),n=r.findIndex((e=>e.id===t))-1;return n>=0?this.traverseSortPrevious(r[n].id):e}}getAllSorted(t){let e=[];for(let r of t){let t=this.getWithSortKey(r.id);void 0!==t&&e.push({...r,...t})}e.sort(((t,e)=>function(t,e){let r=0;for(;r<t.length&&r<e.length;){if(t[r]<e[r])return-1;if(t[r]>e[r])return 1;r+=1}return r!==e.length?-1:r!==t.length?1:0}(t.sortKey,e.sortKey)));for(let r of e)delete r.sortKey;return e}getWithSortKey(t){var e=t;let r=[],n=this.get(e),i=n;if(void 0!==n){for(;e;)r.splice(0,0,n.fi),null!==(e=this.parent(e))&&(n=this.get(e));return{...i,sortKey:r}}}insertBeforeHelper(t,e,r){return this.insertAfterHelper(t,this.previous(t,e),r)}insertAfterHelper(t,e,r){let n=this.childrenArray(t);if(null===e){if(0===n.length)return Ci(0,r,r);{let t=n[0].fi;return Ci(t-r,t,r)}}{let i=this.get(e);if(void 0===i||this.parent(e)!==t)throw new Error("illegal args");let a=n.find((t=>t.fi>i.fi));if(void 0===a){let t=n[n.length-1].fi;return Ci(t,t+r,r)}return Ci(i.fi,a.fi,r)}}};(Ti||(Ti={})).runOp=function(t,e){if(0!==e.type)return null;if(Array.isArray(t)){let r=e.props,n={},i=[...t],a=!1;if(r)for(let t of Object.keys(r)){let e=parseInt(t);if(isNaN(e))throw new Error("wrong index");n[t]=i[e],i[e]=r[t],a=!0}return a?{data:i,actual:e,reverse:{type:0,props:n}}:null}{let r=e.props,n={},i={...t},a=!1;if(r)for(let t of Object.keys(r)){n[t]=i[t];let e=r[t];void 0===e?delete i[t]:i[t]=e,a=!0}return a?{data:i,actual:e,reverse:{type:0,props:n}}:null}};var Ei=class extends Array{constructor(){super(...arguments),Object.setPrototypeOf(this,Ei.prototype)}deepFreeze(){let t=0;for(;t<this.length;)Si(this[t]),t++}fillCaches0(t){this.objCaches.set(t.id,t)}fillCaches(){if(void 0===this.objCaches){this.objCaches=new Map,Object.getOwnPropertyDescriptor(this,"objCaches").enumerable=!1;for(let t of this)this.fillCaches0(t)}}randomId(){this.fillCaches();let t=Array.from(this.objCaches.keys());if(0!==t.length)return t[Math.max(0,Math.floor(Math.random()*t.length)-1)]}data(t){var e;return null===(e=this.get(t))||void 0===e?void 0:e.data}get(t){return this.fillCaches(),this.objCaches.get(t)}modifyById(t,e){if(void 0===this.get(t))throw new Error("not expected");{let r=this,n=r.findIndex((e=>e.id===t));if(n<0)throw new Error("not expected");let i=r[n];return r=[...r],r[n]={...i,data:e},this.modifyArrayBy(r)}}modifyArrayBy(t){Object.setPrototypeOf(t,Ei.prototype);let e=t;return typeof process<"u"||e.fillCaches(),e}runOp(t){switch(t.type){case 4:return this.addOp(t);case 5:return this.deleteOp(t);case 6:return this.moveOp(t)}return null}addOp(t){let{fi:e,id:r,data:n}=t,i=this,a={fi:e,id:r,data:n};return i=[...i,a],i.sort(((t,e)=>t.fi-e.fi)),t.localIndex=i.indexOf(a),{data:this.modifyArrayBy(i),actual:t,reverse:{type:5,id:r}}}deleteOp(t){let{id:e}=t,r=this,n=r.findIndex((t=>t.id===e));if(-1===n)return null;t.localIndex=n,r=[...r];let i=r.splice(n,1)[0];return{data:this.modifyArrayBy(r),actual:t,reverse:{type:4,...i}}}moveOp(t){let{fi:e,id:r}=t,n=this;n=[...n];let i=n.findIndex((t=>t.id===r));if(-1===i)return null;let a=n[i].fi,o={...n[i],fi:e};return n[i]=o,n.sort(((t,e)=>t.fi-e.fi)),t.localIndex=n.indexOf(o),{data:this.modifyArrayBy(n),actual:t,reverse:{type:6,fi:a,id:r}}}previous(t){if(null===t)return 0===this.length?null:this[this.length-1].id;let e=null;for(let r of this){if(r.id===t)return e;e=r.id}return null}insertBeforeHelper(t,e){return this.insertAfterHelper(this.previous(t),e)}insertAfterHelper(t,e){let r=this;if(null===t){if(0===r.length)return Ci(0,e,e);{let t=r[0].fi;return Ci(t-e,t,e)}}{let n=this.get(t);if(void 0===n)throw new Error("illegal args");let i=r.find((t=>t.fi>n.fi));if(void 0===i){let t=r[r.length-1].fi;return Ci(t,t+e,e)}return Ci(n.fi,i.fi,e)}}};function Ii(t){return t&&"object"==typeof t&&t instanceof ji}var Li,Bi,ki,Vi,Ui,ji=class{unusedFunOverridesTable(t){}runOp(t){let e=[],r=this,n=0,i={};for(;n<t.path.length;){if(e.push(r),r=void 0===r?void 0:r[t.path[n]],void 0!==r&&!Ii(r))return null;n+=1}r=r?Mi(r):new ji;for(let[a,o]of Object.entries(t.props)){let t=r[a];i[a]=t,void 0===o?delete r[a]:r[a]=o}for(;n>0;){if(0===Object.keys(r).length){let i=e[n-1];i&&(r=Mi(i),delete r[t.path[n-1]])}else{let i=e[n-1];if(i){let e=Mi(i);e[t.path[n-1]]=r,r=e}else{let e=new ji;e[t.path[n-1]]=r,r=e}}n-=1}return{data:Object.setPrototypeOf(r,ji.prototype),actual:t,reverse:{...t,props:i}}}};function Ni(t,e){if(void 0===e)return;let r=!1,n=t.map((t=>{let n=t.id,i=Ri(t.data,e[n]);if(r=r||void 0!==i,void 0===i&&(i=t.data),t.children){let a=Ni(t.children,e);return void 0!==a?r=!0:a=t.children,{...t,id:n,data:i,children:a}}return{...t,id:n,data:i}}));return r?n:void 0}function Ri(t,e){if(!Ii(e))return e;if(t instanceof zi){let r=Ni(t,e);return void 0!==r&&Object.setPrototypeOf(r,Object.getPrototypeOf(t)),r}if(t instanceof Ei)return function(t,e){if(void 0===e)return;let r=!1,n=t.map((t=>{let n=t.id,i=Ri(t.data,e[n]);return r=r||void 0!==i,void 0===i&&(i=t.data),{...t,id:n,data:i}}));return r?(Object.setPrototypeOf(n,Object.getPrototypeOf(t)),n):void 0}(t,e);if(Array.isArray(t)){let r=!1,n=t.map(((t,n)=>{let i=Ri(t,e[n]);return r=r||void 0!==i,void 0===i&&(i=t),i}));return r?(Object.setPrototypeOf(n,Object.getPrototypeOf(t)),n):void 0}if(t instanceof ji)return Fi(t,e);if(t&&"object"==typeof t){let r={},n=!1;for(let[i,a]of Object.entries(t)){let t=Ri(a,e[i]);n=n||void 0!==t,void 0===t&&(t=a),r[i]=t}return n?(Object.setPrototypeOf(r,Object.getPrototypeOf(t)),r):void 0}}function Fi(t,e){if(void 0===t)return e;if(void 0===e)return t;if(!Ii(e))return e;if(!Ii(t))return Li.apply(t,e);let r=new Set;for(let i of Object.keys(t))r.add(i);for(let i of Object.keys(e))r.add(i);let n=new ji;for(let i of r){let r=Fi(void 0===t?void 0:t[i],void 0===e?void 0:e[i]);n[i]=r}return n}function Gi(t,e){var r;let n={cur:[],result:[],len:0};return[t=null!==(r=Xi(t,e,n))&&void 0!==r?r:t,n.result]}function qi(t,e){return null===t?null:(t.cur[t.len]=e,t.len+=1,t)}function Hi(t){t&&(t.len-=1)}function Wi(t,e,r){let n=!1,i=t.map((t=>{let i=t.id,a=e[i];if(void 0!==a&&"string"==typeof a&&(n=!0,i=a,null!==r))throw new Error("not supported");let o=Xi(t.data,e,qi(r,i));Hi(r),n=n||void 0!==o,void 0===o&&(o=t.data);let s=Wi(t.children,e,r);return void 0!==s?n=!0:s=t.children,{...t,id:i,data:o,children:s}}));if(n)return i}function Xi(t,e,r){if(t instanceof zi){let n=Wi(t,e,r);return void 0!==n&&Object.setPrototypeOf(n,Object.getPrototypeOf(t)),n}if(t instanceof Ei)return function(t,e,r){let n=!1,i=t.map((t=>{let i=t.id,a=e[i];if(void 0!==a&&"string"==typeof a&&(n=!0,i=a,null!==r))throw new Error("not supported");let o=Xi(t.data,e,qi(r,i));return Hi(r),n=n||void 0!==o,void 0===o&&(o=t.data),{...t,id:i,data:o}}));if(n)return Object.setPrototypeOf(i,Object.getPrototypeOf(t)),i}(t,e,r);if(Array.isArray(t)){let n=!1,i=t.map(((t,i)=>{let a=Xi(t,e,qi(r,i));return Hi(r),n=n||void 0!==a,void 0===a&&(a=t),a}));return n?(Object.setPrototypeOf(i,Object.getPrototypeOf(t)),i):void 0}if(t&&"object"==typeof t&&!Oi(t)){let n={},i=!1;for(let[a,o]of Object.entries(t))if("name"!==a){let t=e[a];if("string"==typeof t){if(null!==r)throw new Error("not supported");i=!0,a=t}let s=Xi(o,e,qi(r,a));Hi(r),i=i||void 0!==s,void 0===s&&(s=o),n[a]=s}else n[a]=o;return i?(Object.setPrototypeOf(n,Object.getPrototypeOf(t)),n):void 0}if("string"==typeof t){let n=e[t];return void 0!==n&&function(t){if(null===t)return null;t.result.push(t.cur.slice(0,t.len))}(r),n}}(Bi=Li||(Li={})).apply=function(t,e){var r;return null!==(r=Ri(t,e))&&void 0!==r?r:t},Bi.merge=function(t,e){return Fi(t,e)},Bi.filterOp=function(t,e){let r=0,n=e.path,i=t;for(;r<n.length&&void 0!==i;){if(i=oa.zoomOnce(i,n[r]),void 0===i)return e;if(!Ii(i))return;r+=1}if(void 0===i)return e;if(Ii(i)){if(0===e.type){let t={...e.props};for(let e of Object.keys(i))delete t[e];return{...e,props:t}}if(1===e.type||4===e.type||7===e.type){let t=Ni([e],i);return t?(console.log(t),t):e}return e}},(t=>{t.replaceProps=function(t,e){let r=oa.zoom(e,t.path);if("object"==typeof r){let e={};for(let n of Object.keys(t.props))e[n]=r[n];return{...t,props:e}}return{...t,props:{}}}})(ki||(ki={})),(t=>{function e(t,e){let r=e.path;for(var n=[];;){let o;if(t instanceof ji&&0===e.type&&(o=t.runOp({...e,path:r.slice(n.length)}),null===o&&(o=void 0)),void 0===o&&n.length===r.length&&(o=t instanceof zi||t instanceof Ei||t instanceof _i?t.runOp(e):Ti.runOp(t,e)),void 0!==o){if(null!==o){let t=o.data;for(let e=n.length-1;e>=0;e--){let i=r[e],a=n[e];if(a instanceof zi){if("number"==typeof i)throw new Error("illegal arg");t=a.modifyById(i,t)}else if(a instanceof Ei){if("number"==typeof i)throw new Error("illegal arg");t=a.modifyById(i,t)}else if(a instanceof _i){if("number"==typeof i)throw new Error("illegal arg");t=a.modifyById(i,t)}else if(a instanceof ji){let e={...a,[i]:t};t=Object.setPrototypeOf(e,ji.prototype)}else{if("object"!=typeof a)return null;if(Array.isArray(a)){if("string"==typeof i&&(i=parseInt(i),isNaN(i)))throw new Error("Invalid path");let e=t;t=[...a],t[i]=e}else t={...a,[i]:t}}}return{data:t,actual:{...o.actual,path:r},reverse:{...o.reverse,path:r}}}return null}let s,l=r[n.length];if(t instanceof zi){var i;if("number"==typeof l)throw new Error("");s=null===(i=t.get(l))||void 0===i?void 0:i.data}else if(t instanceof Ei){var a;if("number"==typeof l)throw new Error("");s=null===(a=t.get(l))||void 0===a?void 0:a.data}else null!==t&&(s=t[l]);if(void 0===s)return null;n.push(t),t=s}}function r(t,e){for(let r=0;r<t.length&&r<e.length;r++)if(t[r]!==e[r])return!0;return!1}function n(t,e){if(t.length!==e.length)return!1;for(let r=0;r<t.length;r++)if(t[r]!==e[r])return!1;return!0}t.drop=function(t,e){return{...t,path:t.path.slice(e)}},t.applySimple=function(t,r){var n,i;return null!==(n=null===(i=e(t,r))||void 0===i?void 0:i.data)&&void 0!==n?n:t},t.apply=e,t.pathDisjoint=r,t.pathEq=n,t.commutative=function(t,e){return r(t.path,e.path)},t.subsumed=function(t,e){return!(0!==t.type||0!==e.type||!n(t.path,e.path))&&Object.keys(t.props).every((t=>void 0!==e.props[t]))}})(Vi||(Vi={})),(t=>{function e(t,e){var r=t;let n=[],i=[];for(let o of e)try{if(3===o.type||5===o.type&&"variables"===o.path[o.path.length-1]){let t,e,a;if(3===o.type?(t=oa.zoom(r,[...o.path,o.id]),a=Vi.apply(r,{...o,type:2})):(t=oa.zoom(r,[...o.path,o.id,"value"]),a=Vi.apply(r,o)),null!==a){r=a.data;let[s,l]=Gi(r,{[o.id]:t});r=s;for(let a=0;a<l.length;a++){let s=l[a],h=s.pop();if("number"==typeof h){let n=[h];for(let t=a+1;t<l.length;t++){let e=l[t],r=e[e.length-1];if("number"!=typeof r||!oa.equal(s,e.slice(0,e.length-1)))break;n.push(r),l.splice(t,1)}let i=oa.zoom(r,s);e=i.map(((t,e)=>n.includes(e)?o.id:t)),t=i,h=s.pop()}else{if("alphaOverride"===h||"alpha"===h){t/=100;let e=t,n=oa.zoom(r,s.slice(0,s.length-2)),i=n.layers.map((t=>t.id===s[s.length-1]?{...t,data:{...t.data,[h]:e}}:t));Object.setPrototypeOf(i,Object.getPrototypeOf(n.layers)),n.layers=i}e=o.id}n.push({type:0,path:s,props:{[h]:t}}),i.push({type:0,path:s,props:{[h]:e}})}i.push(a.reverse),n.push(a.actual)}}else{let t=Vi.apply(r,o);null!==t&&(n.push(t.actual),r=t.data,i.push(t.reverse))}}catch(a){if(a instanceof Ai)return null;throw a}return{data:r,actual:n,reverse:i.reverse()}}t.empty=function(){return[]},t.removePrefix=function(t,e){let r=[];for(let n of t){let[t,...i]=n.path;t===e&&r.push({...n,path:i})}return r},t.addPrefix=function(t,e){return t.map((t=>({...t,path:[e,...t.path]})))},t.concat=function(t,e){return[...t,...e]},t.compress=function(t,e){return[...t.filter((t=>!e.some((e=>Vi.subsumed(t,e))))),...e]},t.commutative=function(t,e){return t.every((t=>e.every((e=>Vi.commutative(t,e)))))},t.applyAll=function(t,r){for(let n of r){let r=e(t,n);null!==r&&(t=r.data)}return t},t.apply=e})(Ui||(Ui={}));var Yi=Symbol(),Qi=Symbol(),Zi=Symbol(),Ki=class{reportOp(t,e){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],n=this;if(null===e)return;n._current=e.data;let i=r;for(;!(n instanceof sa);){let t=n._path,e=n._current;if(""!==t&&i.splice(0,0,t),n=n._parent,null===n)return;n.update(t,e)}n.push(i,t,e.actual,e.reverse)}deleteChildren(t){if(this._children){let e=this._children[t];if(e){let r=e[Zi];r&&r(),delete this._children[t]}}}},Ji=class extends Ki{constructor(t,e,r){super(),this._parent=t,this._path=e,this._current=r}update(t,e){if(Array.isArray(this._current)){if("string"==typeof t&&(t=parseInt(t),isNaN(t)))throw new Error("Invalid path");this._current=[...this._current],this._current[t]=e}else this._current={...this._current,[t]:e}}runOp(t){this.reportOp(t,Ti.runOp(this._current,t),t.path)}},$i=class extends Ki{constructor(t,e,r){super(),this._parent=t,this._path=e,this._current=r}update(t,e){this._current={...this._current,[t]:e},Object.setPrototypeOf(this._current,_i.prototype)}runOp(t){this.reportOp(t,this._current.runOp(t))}},ta={get(t,e){if(e===Zi)return()=>{t._parent=null};if(e===Yi)return t._current;if(e===Qi)return t;let{_current:r,_children:n}=t;if("push"===e&&Array.isArray(r))throw new Error("not supported to expand array");let i=void 0===n?void 0:n[e];if(void 0!==i)return i;let a=r[e],o=la(t,e,a);return o!==a?(void 0===n&&(n={},t._children=n),n[e]=o,o):a},has:(t,e)=>e in t._current,ownKeys:t=>Reflect.ownKeys(t._current),defineProperty(){throw Error("not supported")},getPrototypeOf:t=>Object.getPrototypeOf(t._current),setPrototypeOf(){throw Error("not supported")},getOwnPropertyDescriptor(t,e){let r=t._current,n=Reflect.getOwnPropertyDescriptor(r,e);return n&&{writable:!0,configurable:!0,enumerable:n.enumerable,value:r[e]}}},ea={...ta,set(t,e,r){var n;let i={type:0,props:{[e]:null!==(n=ua(r))&&void 0!==n?n:r}};return t.deleteChildren(e),t.runOp(i),!0},deleteProperty(t,e){let r={type:0,props:{[e]:void 0}};return t.deleteChildren(e),t.runOp(r),!0}},ra={...ta,set(t,e,r){return void 0===r?this.deleteProperty(t,e):(t.deleteChildren(e),t.runOp({type:1,id:e,data:r})),!0},deleteProperty:(t,e)=>(t.runOp({type:2,id:e}),!0)},na=class extends Ki{constructor(t,e,r){super(),this._children={},this._parent=t,this._path=e,this._current=r,this[Zi]=()=>{this._parent=null}}unproxy(){return this._current}update(t,e){this._current=this._current.modifyById(t,e)}runOp(t){this.reportOp(t,this._current.runOp(t))}randomId(){return this._current.randomId()}isDescendantOf(t,e){return this._current.isDescendantOf(t,e)}childrenOf(t){return this._current.childrenOf(t)}traverse(t){return this._current.traverse(t)}get(t){return this._current.get(t)}parent(t){return this._current.parent(t)}traverse(t){this._current.traverse(((e,r)=>{t(e,this.data(e))}))}data(t){var e;let{_current:r,_children:n}=this,i=void 0===n?void 0:n[t];if(void 0!==i)return i;let a=null===(e=r.get(t))||void 0===e?void 0:e.data,o=la(this,t,a);return o!==a?(void 0===n&&(n={},this._children=n),n[t]=o,o):a}add(t,e,r,n,i){this.runOp({type:7,parent:t,fi:e,id:r,data:n,children:i})}move(t,e,r){this.runOp({type:9,parent:t,fi:e,id:r})}insertAfter(t,e,r){let n=this._current.insertAfterHelper(t,e,r.length);for(let i=0;i<r.length;i++){let e=r[i];this.add(t,n[i],e.id,e.data,e.children)}}insertBefore(t,e,r){let n=this._current.insertBeforeHelper(t,e,r.length);for(let i=0;i<r.length;i++){let e=r[i];this.add(t,n[i],e.id,e.data,e.children)}}moveAfter(t,e,r){let n=this._current.insertAfterHelper(t,e,r.length);for(let i=0;i<r.length;i++){let e=r[i];this.move(t,n[i],e)}}moveBefore(t,e,r){let n=this._current.insertBeforeHelper(t,e,r.length);for(let i=0;i<r.length;i++){let e=r[i];this.move(t,n[i],e)}}delete(t){this.deleteChildren(t),this.runOp({type:8,id:t})}sortNext(t){return this._current.sortNext(t)}sortPrevious(t){return this._current.sortPrevious(t)}getAllSorted(t){return this._current.getAllSorted(t)}},ia=class extends Ki{constructor(t,e,r){super(),this._children={},this._parent=t,this._path=e,this._current=r,this[Zi]=()=>{this._parent=null}}unproxy(){return this._current}get length(){return this._current.length}forEach(t){let e=this.length;for(let r=0;r<e;r++){let e=this._current[r].id,n=this._current[r].fi;t(this.data(this._current[r].id),e,n)}}find(t){let e=this.length;for(let r=0;r<e;r++){let e=this._current[r].id;if(t(this.data(e),e))return this.get(e)}}update(t,e){this._current=this._current.modifyById(t,e)}randomId(){return this._current.randomId()}get(t){return{...this._current.get(t),data:this.data(t)}}data(t){var e;let{_current:r,_children:n}=this,i=void 0===n?void 0:n[t];if(void 0!==i)return i;let a=null===(e=r.get(t))||void 0===e?void 0:e.data,o=la(this,t,a);return o!==a?(void 0===n&&(n={},this._children=n),n[t]=o,o):a}runOp(t){this.reportOp(t,this._current.runOp(t))}add(t,e,r){this.runOp({type:4,fi:t,id:e,data:r})}move(t,e){this.runOp({type:6,fi:t,id:e})}insertAfter(t,e){let r=this._current.insertAfterHelper(t,e.length);for(let n=0;n<e.length;n++){let t=e[n];this.add(r[n],t.id,t.data)}}insertBefore(t,e){let r=this._current.insertBeforeHelper(t,e.length);for(let n=0;n<e.length;n++){let t=e[n];this.add(r[n],t.id,t.data)}}moveAfter(t,e){let r=this._current.insertAfterHelper(t,e.length);for(let n=0;n<e.length;n++){let t=e[n];this.move(r[n],t)}}moveBefore(t,e){let r=this._current.insertBeforeHelper(t,e.length);for(let n=0;n<e.length;n++){let t=e[n];this.move(r[n],t)}}delete(t){this.deleteChildren(t),this.runOp({type:5,id:t})}};function aa(t,e,r){if(t.length>0){let n=t[t.length-1];if(0===n.type&&0===e.type&&oa.equal(n.path,r))return void Object.assign(n.props,e.props)}t.push({...e,path:r})}var oa,sa=class extends Ki{constructor(t){super(),this.ts=[],this.actual=[],this.reverse=[],this._current=t}update(t,e){if(""!==t)throw new Error("");this._current=e}push(t,e,r,n){aa(this.ts,e,t),aa(this.actual,r,t),aa(this.reverse,n,t)}result(){return{data:this._current,ts:this.ts,actual:this.actual,reverse:this.reverse.reverse()}}};function la(t,e,r){return r instanceof zi?new na(t,e,r):r instanceof Ei?new ia(t,e,r):r instanceof _i?new Proxy(new $i(t,e,r),ra):null!==r&&"object"==typeof r?Oi(r)?r:new Proxy(new Ji(t,e,r),ea):r}function ha(t){let e=new sa(t);return[la(e,"",t),e]}function ca(t,e){let[r,n]=ha(t);return e(r),n.result()}function ua(t){return t instanceof na||t instanceof ia?t._current:null!==t&&"object"==typeof t?t[Yi]:t}function da(t,e){let r=[];if(!(e.length<=t.length))return null;for(var n=0;n<e.length;){if("*"===e[n])r.push(t[n]);else if(t[n]!==e[n])return null;n+=1}return r}(t=>{function e(t,e){return(t instanceof zi||t instanceof na)&&"string"==typeof e||(t instanceof Ei||t instanceof ia)&&"string"==typeof e?t.data(e):"number"==typeof e&&Array.isArray(t)||"string"==typeof e&&"object"==typeof t&&null!==t?t[e]:void 0}function r(t,r){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;for(;n<r.length&&void 0!==t;)t=e(t,r[n]),n+=1;return t}t.equal=function(t,e){if(e.length!==t.length)return!1;for(var r=0;r<t.length;){if(t[r]!==e[r])return!1;r+=1}return!0},t.removeOverridden=function(t,e,n){let i=r(n,t);if(void 0!==i&&"object"==typeof i&&null!==i){let t={...e};return Object.keys(i).forEach((e=>{delete t[e]})),t}return e},t.zoomOnce=e,t.zoom=r})(oa||(oa={}));var pa,fa=class{},ma=class extends fa{constructor(t){super(),this.id=t}},va=class extends fa{constructor(t){super(),this.data=t}};try{pa=new TextDecoder}catch{}var ga,ya,ba,xa,wa,_a,Sa,Aa=0,Ma=[],Ca=Ma,Oa=0,Da={},Pa=0,Ta=0,za=[],Ea={useRecords:!1,mapsAsObjects:!0},Ia=class{},La=new Ia;La.name="MessagePack 0xC1";var Ba=!1,ka=class{constructor(t){t&&(!1===t.useRecords&&void 0===t.mapsAsObjects&&(t.mapsAsObjects=!0),t.structures?t.structures.sharedLength=t.structures.length:t.getStructures&&((t.structures=[]).uninitialized=!0,t.structures.sharedLength=0)),Object.assign(this,t)}unpack(t,e){if(ga)return so((()=>(lo(),this?this.unpack(t,e):ka.prototype.unpack.call(Ea,t,e))));ya=e>-1?e:t.length,Aa=0,Oa=0,Ta=0,xa=null,Ca=Ma,wa=null,ga=t;try{Sa=t.dataView||(t.dataView=new DataView(t.buffer,t.byteOffset,t.byteLength))}catch(Bi){throw ga=null,t instanceof Uint8Array?Bi:new Error("Source must be a Uint8Array or Buffer but was a "+(t&&"object"==typeof t?t.constructor.name:typeof t))}if(this instanceof ka){if(Da=this,this.structures)return ba=this.structures,Va();(!ba||ba.length>0)&&(ba=[])}else Da=Ea,(!ba||ba.length>0)&&(ba=[]);return Va()}unpackMultiple(t,e){let r,n=0;try{Ba=!0;let i=t.length,a=this?this.unpack(t,i):uo.unpack(t,i);if(!e){for(r=[a];Aa<i;)n=Aa,r.push(Va());return r}for(e(a);Aa<i;)if(n=Aa,!1===e(Va()))return}catch(rs){throw rs.lastPosition=n,rs.values=r,rs}finally{Ba=!1,lo()}}_mergeStructures(t,e){for(let r=0,n=(t=t||[]).length;r<n;r++){let e=t[r];e&&(e.isShared=!0,r>=32&&(e.highByte=r-32>>5))}t.sharedLength=t.length;for(let r in e||[])if(r>=0){let n=t[r],i=e[r];i&&(n&&((t.restoreStructures||(t.restoreStructures=[]))[r]=n),t[r]=i)}return this.structures=t}decode(t,e){return this.unpack(t,e)}};function Va(){try{if(!Da.trusted&&!Ba){let t=ba.sharedLength||0;t<ba.length&&(ba.length=t)}let t=ja();if(Aa==ya)ba.restoreStructures&&Ua(),ba=null,ga=null,_a&&(_a=null);else{if(Aa>ya){let t=new Error("Unexpected end of MessagePack data");throw t.incomplete=!0,t}if(!Ba)throw new Error("Data read, but end of buffer not reached")}return t}catch(fc){throw ba.restoreStructures&&Ua(),lo(),(fc instanceof RangeError||fc.message.startsWith("Unexpected end of buffer"))&&(fc.incomplete=!0),fc}}function Ua(){for(let t in ba.restoreStructures)ba[t]=ba.restoreStructures[t];ba.restoreStructures=null}function ja(){let t=ga[Aa++];if(t<160){if(t<128){if(t<64)return t;{let e=ba[63&t]||Da.getStructures&&Ga()[63&t];return e?(e.read||(e.read=Ra(e,63&t)),e.read()):t}}if(t<144){if(t-=128,Da.mapsAsObjects){let e={};for(let r=0;r<t;r++)e[no()]=ja();return e}{let e=new Map;for(let r=0;r<t;r++)e.set(ja(),ja());return e}}{t-=144;let e=new Array(t);for(let r=0;r<t;r++)e[r]=ja();return e}}if(t<192){let e=t-160;if(Ta>=Aa)return xa.slice(Aa-Pa,(Aa+=e)-Pa);if(0==Ta&&ya<140){let t=e<16?$a(e):Ja(e);if(null!=t)return t}return qa(e)}{let e;switch(t){case 192:return null;case 193:return wa?(e=ja(),e>0?wa[1].slice(wa.position1,wa.position1+=e):wa[0].slice(wa.position0,wa.position0-=e)):La;case 194:return!1;case 195:return!0;case 196:return to(ga[Aa++]);case 197:return e=Sa.getUint16(Aa),Aa+=2,to(e);case 198:return e=Sa.getUint32(Aa),Aa+=4,to(e);case 199:return eo(ga[Aa++]);case 200:return e=Sa.getUint16(Aa),Aa+=2,eo(e);case 201:return e=Sa.getUint32(Aa),Aa+=4,eo(e);case 202:if(e=Sa.getFloat32(Aa),Da.useFloat32>2){let t=ho[(127&ga[Aa])<<1|ga[Aa+1]>>7];return Aa+=4,(t*e+(e>0?.5:-.5)|0)/t}return Aa+=4,e;case 203:return e=Sa.getFloat64(Aa),Aa+=8,e;case 204:return ga[Aa++];case 205:return e=Sa.getUint16(Aa),Aa+=2,e;case 206:return e=Sa.getUint32(Aa),Aa+=4,e;case 207:return Da.int64AsNumber?(e=4294967296*Sa.getUint32(Aa),e+=Sa.getUint32(Aa+4)):e=Sa.getBigUint64(Aa),Aa+=8,e;case 208:return Sa.getInt8(Aa++);case 209:return e=Sa.getInt16(Aa),Aa+=2,e;case 210:return e=Sa.getInt32(Aa),Aa+=4,e;case 211:return Da.int64AsNumber?(e=4294967296*Sa.getInt32(Aa),e+=Sa.getUint32(Aa+4)):e=Sa.getBigInt64(Aa),Aa+=8,e;case 212:if(e=ga[Aa++],114==e)return io(63&ga[Aa++]);{let t=za[e];if(t)return t.read?(Aa++,t.read(ja())):t.noBuffer?(Aa++,t()):t(ga.subarray(Aa,++Aa));throw new Error("Unknown extension "+e)}case 213:return e=ga[Aa],114==e?(Aa++,io(63&ga[Aa++],ga[Aa++])):eo(2);case 214:return eo(4);case 215:return eo(8);case 216:return eo(16);case 217:return e=ga[Aa++],Ta>=Aa?xa.slice(Aa-Pa,(Aa+=e)-Pa):Ha(e);case 218:return e=Sa.getUint16(Aa),Ta>=(Aa+=2)?xa.slice(Aa-Pa,(Aa+=e)-Pa):Wa(e);case 219:return e=Sa.getUint32(Aa),Ta>=(Aa+=4)?xa.slice(Aa-Pa,(Aa+=e)-Pa):Xa(e);case 220:return e=Sa.getUint16(Aa),Aa+=2,Qa(e);case 221:return e=Sa.getUint32(Aa),Aa+=4,Qa(e);case 222:return e=Sa.getUint16(Aa),Aa+=2,Za(e);case 223:return e=Sa.getUint32(Aa),Aa+=4,Za(e);default:if(t>=224)return t-256;if(void 0===t){let t=new Error("Unexpected end of MessagePack data");throw t.incomplete=!0,t}throw new Error("Unknown MessagePack token "+t)}}}var Na=/^[a-zA-Z_$][a-zA-Z\d_$]*$/;function Ra(t,e){function r(){if(r.count++>2){let r=t.read=new Function("r","return function(){return {"+t.map((t=>Na.test(t)?t+":r()":"["+JSON.stringify(t)+"]:r()")).join(",")+"}}")(ja);return 0===t.highByte&&(t.read=Fa(e,t.read)),r()}let n={};for(let e=0,r=t.length;e<r;e++){n[t[e]]=ja()}return n}return r.count=0,0===t.highByte?Fa(e,r):r}var Fa=(t,e)=>function(){let r=ga[Aa++];if(0===r)return e();let n=t<32?-(t+(r<<5)):t+(r<<5),i=ba[n]||Ga()[n];if(!i)throw new Error("Record id is not defined for "+n);return i.read||(i.read=Ra(i,t)),i.read()};function Ga(){let t=so((()=>(ga=null,Da.getStructures())));return ba=Da._mergeStructures(t,ba)}var qa=Ya,Ha=Ya,Wa=Ya,Xa=Ya;function Ya(t){let e;if(t<16&&(e=$a(t)))return e;if(t>64&&pa)return pa.decode(ga.subarray(Aa,Aa+=t));let r=Aa+t,n=[];for(e="";Aa<r;){let t=ga[Aa++];if(0===(128&t))n.push(t);else if(192===(224&t)){let e=63&ga[Aa++];n.push((31&t)<<6|e)}else if(224===(240&t)){let e=63&ga[Aa++],r=63&ga[Aa++];n.push((31&t)<<12|e<<6|r)}else if(240===(248&t)){let e=(7&t)<<18|(63&ga[Aa++])<<12|(63&ga[Aa++])<<6|63&ga[Aa++];e>65535&&(e-=65536,n.push(e>>>10&1023|55296),e=56320|1023&e),n.push(e)}else n.push(t);n.length>=4096&&(e+=Ka.apply(String,n),n.length=0)}return n.length>0&&(e+=Ka.apply(String,n)),e}function Qa(t){let e=new Array(t);for(let r=0;r<t;r++)e[r]=ja();return e}function Za(t){if(Da.mapsAsObjects){let e={};for(let r=0;r<t;r++)e[no()]=ja();return e}{let e=new Map;for(let r=0;r<t;r++)e.set(ja(),ja());return e}}var Ka=String.fromCharCode;function Ja(t){let e=Aa,r=new Array(t);for(let n=0;n<t;n++){let t=ga[Aa++];if((128&t)>0)return void(Aa=e);r[n]=t}return Ka.apply(String,r)}function $a(t){if(t<4){if(t<2){if(0===t)return"";{let t=ga[Aa++];return(128&t)>1?void(Aa-=1):Ka(t)}}{let e=ga[Aa++],r=ga[Aa++];if((128&e)>0||(128&r)>0)return void(Aa-=2);if(t<3)return Ka(e,r);let n=ga[Aa++];return(128&n)>0?void(Aa-=3):Ka(e,r,n)}}{let e=ga[Aa++],r=ga[Aa++],n=ga[Aa++],i=ga[Aa++];if((128&e)>0||(128&r)>0||(128&n)>0||(128&i)>0)return void(Aa-=4);if(t<6){if(4===t)return Ka(e,r,n,i);{let t=ga[Aa++];return(128&t)>0?void(Aa-=5):Ka(e,r,n,i,t)}}if(t<8){let a=ga[Aa++],o=ga[Aa++];if((128&a)>0||(128&o)>0)return void(Aa-=6);if(t<7)return Ka(e,r,n,i,a,o);let s=ga[Aa++];return(128&s)>0?void(Aa-=7):Ka(e,r,n,i,a,o,s)}{let a=ga[Aa++],o=ga[Aa++],s=ga[Aa++],l=ga[Aa++];if((128&a)>0||(128&o)>0||(128&s)>0||(128&l)>0)return void(Aa-=8);if(t<10){if(8===t)return Ka(e,r,n,i,a,o,s,l);{let t=ga[Aa++];return(128&t)>0?void(Aa-=9):Ka(e,r,n,i,a,o,s,l,t)}}if(t<12){let h=ga[Aa++],c=ga[Aa++];if((128&h)>0||(128&c)>0)return void(Aa-=10);if(t<11)return Ka(e,r,n,i,a,o,s,l,h,c);let u=ga[Aa++];return(128&u)>0?void(Aa-=11):Ka(e,r,n,i,a,o,s,l,h,c,u)}{let h=ga[Aa++],c=ga[Aa++],u=ga[Aa++],d=ga[Aa++];if((128&h)>0||(128&c)>0||(128&u)>0||(128&d)>0)return void(Aa-=12);if(t<14){if(12===t)return Ka(e,r,n,i,a,o,s,l,h,c,u,d);{let t=ga[Aa++];return(128&t)>0?void(Aa-=13):Ka(e,r,n,i,a,o,s,l,h,c,u,d,t)}}{let p=ga[Aa++],f=ga[Aa++];if((128&p)>0||(128&f)>0)return void(Aa-=14);if(t<15)return Ka(e,r,n,i,a,o,s,l,h,c,u,d,p,f);let m=ga[Aa++];return(128&m)>0?void(Aa-=15):Ka(e,r,n,i,a,o,s,l,h,c,u,d,p,f,m)}}}}}function to(t){return Da.copyBuffers?Uint8Array.prototype.slice.call(ga,Aa,Aa+=t):ga.subarray(Aa,Aa+=t)}function eo(t){let e=ga[Aa++];if(za[e])return za[e](ga.subarray(Aa,Aa+=t));throw new Error("Unknown extension type "+e)}var ro=new Array(4096);function no(){let t=ga[Aa++];if(!(t>=160&&t<192))return Aa--,ja();if(t-=160,Ta>=Aa)return xa.slice(Aa-Pa,(Aa+=t)-Pa);if(!(0==Ta&&ya<180))return qa(t);let e,r=4095&(t<<5^(t>1?Sa.getUint16(Aa):t>0?ga[Aa]:0)),n=ro[r],i=Aa,a=Aa+t-3,o=0;if(n&&n.bytes==t){for(;i<a;){if(e=Sa.getUint32(i),e!=n[o++]){i=1879048192;break}i+=4}for(a+=3;i<a;)if(e=ga[i++],e!=n[o++]){i=1879048192;break}if(i===a)return Aa=i,n.string;a-=3,i=Aa}for(n=[],ro[r]=n,n.bytes=t;i<a;)e=Sa.getUint32(i),n.push(e),i+=4;for(a+=3;i<a;)e=ga[i++],n.push(e);let s=t<16?$a(t):Ja(t);return n.string=null!=s?s:qa(t)}var io=(t,e)=>{var r=ja();let n=t;void 0!==e&&(t=t<32?-((e<<5)+t):(e<<5)+t,r.highByte=e);let i=ba[t];return i&&i.isShared&&((ba.restoreStructures||(ba.restoreStructures=[]))[t]=i),ba[t]=r,r.read=Ra(r,n),r.read()},ao="object"==typeof self?self:global;za[0]=()=>{},za[0].noBuffer=!0,za[101]=()=>{let t=ja();return(ao[t[0]]||Error)(t[1])},za[105]=t=>{let e=Sa.getUint32(Aa-4);_a||(_a=new Map);let r,n=ga[Aa];r=n>=144&&n<160||220==n||221==n?[]:{};let i={target:r};_a.set(e,i);let a=ja();return i.used?Object.assign(r,a):(i.target=a,a)},za[112]=t=>{let e=Sa.getUint32(Aa-4),r=_a.get(e);return r.used=!0,r.target},za[115]=()=>new Set(ja());var oo=["Int8","Uint8","Uint8Clamped","Int16","Uint16","Int32","Uint32","Float32","Float64","BigInt64","BigUint64"].map((t=>t+"Array"));function so(t){let e=ya,r=Aa,n=Oa,i=Pa,a=Ta,o=xa,s=Ca,l=_a,h=wa,c=new Uint8Array(ga.slice(0,ya)),u=ba,d=ba.slice(0,ba.length),p=Da,f=Ba,m=t();return ya=e,Aa=r,Oa=n,Pa=i,Ta=a,xa=o,Ca=s,_a=l,wa=h,ga=c,Ba=f,(ba=u).splice(0,ba.length,...d),Da=p,Sa=new DataView(ga.buffer,ga.byteOffset,ga.byteLength),m}function lo(){ga=null,_a=null,ba=null}za[116]=t=>{let e=t[0],r=oo[e];if(!r)throw new Error("Could not find typed array for code "+e);return new ao[r](Uint8Array.prototype.slice.call(t,1).buffer)},za[120]=()=>{let t=ja();return new RegExp(t[0],t[1])},za[98]=t=>{let e=(t[0]<<24)+(t[1]<<16)+(t[2]<<8)+t[3],r=Aa;Aa+=e-4,(wa=[ja(),ja()]).position0=0,wa.position1=0;let n=Aa;Aa=r;try{return ja()}finally{Aa=n}},za[255]=t=>4==t.length?new Date(1e3*(16777216*t[0]+(t[1]<<16)+(t[2]<<8)+t[3])):8==t.length?new Date(((t[0]<<22)+(t[1]<<14)+(t[2]<<6)+(t[3]>>2))/1e6+1e3*(4294967296*(3&t[3])+16777216*t[4]+(t[5]<<16)+(t[6]<<8)+t[7])):12==t.length?new Date(((t[0]<<24)+(t[1]<<16)+(t[2]<<8)+t[3])/1e6+1e3*((128&t[4]?-281474976710656:0)+1099511627776*t[6]+4294967296*t[7]+16777216*t[8]+(t[9]<<16)+(t[10]<<8)+t[11])):new Date("invalid");var ho=new Array(147);for(let fy=0;fy<256;fy++)ho[fy]=+("1e"+Math.floor(45.15-.30103*fy));var co,uo=new ka({useRecords:!1}),po=(uo.unpack,uo.unpackMultiple,uo.unpack,new Float32Array(1));new Uint8Array(po.buffer,0,4);try{co=new TextEncoder}catch{}var fo,mo,vo,go,yo,bo=typeof Buffer<"u",xo=bo?Buffer.allocUnsafeSlow:Uint8Array,wo=bo?Buffer:Uint8Array,_o=bo?4294967296:2144337920,So=0,Ao=null,Mo=/[\u0080-\uFFFF]/,Co=Symbol("record-id"),Oo=class extends ka{constructor(t){super(t),this.offset=0;let e,r,n,i,a,o=0,s=wo.prototype.utf8Write?function(t,e,r){return vo.utf8Write(t,e,r)}:!(!co||!co.encodeInto)&&function(t,e){return co.encodeInto(t,vo.subarray(e)).written},l=this;t||(t={});let h=t&&t.sequential,c=t.structures||t.saveStructures,u=t.maxSharedStructures;if(null==u&&(u=c?32:0),u>8160)throw new Error("Maximum maxSharedStructure is 8160");let d=t.maxOwnStructures;null==d&&(d=c?32:64),h&&!t.saveStructures&&(this.structures=[]);let p=u>32||d+u>64,f=u+64,m=u+d+64;if(m>8256)throw new Error("Maximum maxSharedStructure + maxOwnStructure is 8192");let v=[],g=0,y=0;this.pack=this.encode=function(t,s){if(vo||(vo=new xo(8192),go=new DataView(vo.buffer,0,8192),So=0),(yo=vo.length-10)-So<2048?(vo=new xo(vo.length),go=new DataView(vo.buffer,0,vo.length),yo=vo.length-10,So=0):So=So+7&2147483640,e=So,a=l.structuredClone?new Map:null,l.bundleStrings?(Ao=["",""],vo[So++]=214,vo[So++]=98,Ao.position=So-e,So+=4):Ao=null,r=l.structures,r){r.uninitialized&&(r=l._mergeStructures(l.getStructures()));let t=r.sharedLength||0;if(t>u)throw new Error("Shared structures is larger than maximum shared structures, try increasing maxSharedStructures to "+r.sharedLength);if(!r.transitions){r.transitions=Object.create(null);for(let e=0;e<t;e++){let t=r[e];if(!t)continue;let n,i=r.transitions;for(let e=0,r=t.length;e<r;e++){let r=t[e];n=i[r],n||(n=i[r]=Object.create(null)),i=n}i[Co]=e+64}o=t}h||(r.nextId=t+64)}n&&(n=!1),i=r||[];try{if(b(t),Ao){go.setUint32(Ao.position+e,So-Ao.position-e);let t=Ao;Ao=null,b(t[0]),b(t[1])}if(l.offset=So,a&&a.idsToInsert){(So+=6*a.idsToInsert.length)>yo&&w(So),l.offset=So;let t=function(t,e){let r,n=6*e.length,i=t.length-n;for(e.sort(((t,e)=>t.offset>e.offset?1:-1));r=e.pop();){let e=r.offset,a=r.id;t.copyWithin(e+n,e,i),n-=6;let o=e+n;t[o++]=214,t[o++]=105,t[o++]=a>>24,t[o++]=a>>16&255,t[o++]=a>>8&255,t[o++]=255&a,i=e}return t}(vo.subarray(e,So),a.idsToInsert);return a=null,t}return s&Uo?(vo.start=e,vo.end=So,vo):vo.subarray(e,So)}finally{if(r){if(y<10&&y++,g>1e4)r.transitions=null,y=0,g=0,v.length>0&&(v=[]);else if(v.length>0&&!h){for(let t=0,e=v.length;t<e;t++)v[t][Co]=0;v=[]}if(n&&l.saveStructures){let n=r.sharedLength||u;r.length>n&&(r=r.slice(0,n));let i=vo.subarray(e,So);return!1===l.saveStructures(r,o)?(l._mergeStructures(l.getStructures()),l.pack(t)):(o=n,i)}}s&jo&&(So=e)}};let b=t=>{So>yo&&(vo=w(So));var r,n=typeof t;if("string"===n){let e,n=t.length;if(Ao&&n>=8&&n<4096){let e=Mo.test(t);return Ao[e?0:1]+=t,vo[So++]=193,void b(e?-n:n)}e=n<32?1:n<256?2:n<65536?3:5;let i=3*n;if(So+i>yo&&(vo=w(So+i)),n<64||!s){let i,a,o,s=So+e;for(i=0;i<n;i++)a=t.charCodeAt(i),a<128?vo[s++]=a:a<2048?(vo[s++]=a>>6|192,vo[s++]=63&a|128):55296===(64512&a)&&56320===(64512&(o=t.charCodeAt(i+1)))?(a=65536+((1023&a)<<10)+(1023&o),i++,vo[s++]=a>>18|240,vo[s++]=a>>12&63|128,vo[s++]=a>>6&63|128,vo[s++]=63&a|128):(vo[s++]=a>>12|224,vo[s++]=a>>6&63|128,vo[s++]=63&a|128);r=s-So-e}else r=s(t,So+e,i);r<32?vo[So++]=160|r:r<256?(e<2&&vo.copyWithin(So+2,So+1,So+1+r),vo[So++]=217,vo[So++]=r):r<65536?(e<3&&vo.copyWithin(So+3,So+2,So+2+r),vo[So++]=218,vo[So++]=r>>8,vo[So++]=255&r):(e<5&&vo.copyWithin(So+5,So+3,So+3+r),vo[So++]=219,go.setUint32(So,r),So+=4),So+=r}else if("number"===n)if(t>>>0===t)t<64?vo[So++]=t:t<256?(vo[So++]=204,vo[So++]=t):t<65536?(vo[So++]=205,vo[So++]=t>>8,vo[So++]=255&t):(vo[So++]=206,go.setUint32(So,t),So+=4);else if((t|0)===t)t>=-32?vo[So++]=256+t:t>=-128?(vo[So++]=208,vo[So++]=t+256):t>=-32768?(vo[So++]=209,go.setInt16(So,t),So+=2):(vo[So++]=210,go.setInt32(So,t),So+=4);else{let e;if((e=this.useFloat32)>0&&t<4294967296&&t>=-2147483648){let r;if(vo[So++]=202,go.setFloat32(So,t),e<4||((r=t*ho[(127&vo[So])<<1|vo[So+1]>>7])|0)===r)return void(So+=4);So--}vo[So++]=203,go.setFloat64(So,t),So+=8}else if("object"===n)if(t){if(a){let r=a.get(t);if(r){if(!r.id){let t=a.idsToInsert||(a.idsToInsert=[]);r.id=t.push(r)}return vo[So++]=214,vo[So++]=112,go.setUint32(So,r.id),void(So+=4)}a.set(t,{offset:So-e})}let n=t.constructor;if(n===Object)x(t,!0);else if(n===Array){(r=t.length)<16?vo[So++]=144|r:r<65536?(vo[So++]=220,vo[So++]=r>>8,vo[So++]=255&r):(vo[So++]=221,go.setUint32(So,r),So+=4);for(let e=0;e<r;e++)b(t[e])}else if(n===Map){(r=t.size)<16?vo[So++]=128|r:r<65536?(vo[So++]=222,vo[So++]=r>>8,vo[So++]=255&r):(vo[So++]=223,go.setUint32(So,r),So+=4);for(let[e,r]of t)b(e),b(r)}else{for(let e=0,r=fo.length;e<r;e++){if(t instanceof mo[e]){let r=fo[e];if(r.write)return r.type&&(vo[So++]=212,vo[So++]=r.type,vo[So++]=0),void b(r.write.call(this,t));let n,i=vo,a=go,o=So;vo=null;try{n=r.pack.call(this,t,(t=>(vo=i,i=null,(So+=t)>yo&&w(So),{target:vo,targetView:go,position:So-t})),b)}finally{i&&(go=a,So=o,yo=(vo=i).length-10)}return void(n&&(n.length+So>yo&&w(n.length+So),So=To(n,vo,So,r.type)))}}x(t,!t.hasOwnProperty)}}else vo[So++]=192;else if("boolean"===n)vo[So++]=t?195:194;else if("bigint"===n){if(t<BigInt(1)<<BigInt(63)&&t>=-(BigInt(1)<<BigInt(63)))vo[So++]=211,go.setBigInt64(So,t);else if(t<BigInt(1)<<BigInt(64)&&t>0)vo[So++]=207,go.setBigUint64(So,t);else{if(!this.largeBigIntToFloat)throw new RangeError(t+" was too large to fit in MessagePack 64-bit integer format, set largeBigIntToFloat to convert to float-64");vo[So++]=203,go.setFloat64(So,Number(t))}So+=8}else if("undefined"===n)this.encodeUndefinedAsNil?vo[So++]=192:(vo[So++]=212,vo[So++]=0,vo[So++]=0);else{if("function"!==n)throw new Error("Unknown type: "+n);b(this.writeFunction&&this.writeFunction())}},x=!1===this.useRecords?this.variableMapSize?t=>{let e,r=Object.keys(t),n=r.length;n<16?vo[So++]=128|n:n<65536?(vo[So++]=222,vo[So++]=n>>8,vo[So++]=255&n):(vo[So++]=223,go.setUint32(So,n),So+=4);for(let i=0;i<n;i++)b(e=r[i]),b(t[e])}:(t,r)=>{vo[So++]=222;let n=So-e;So+=2;let i=0;for(let e in t)(r||t.hasOwnProperty(e))&&(b(e),b(t[e]),i++);vo[n+++e]=i>>8,vo[n+e]=255&i}:t=>{let e,r=Object.keys(t),a=i.transitions||(i.transitions=Object.create(null)),o=0;for(let n=0,i=r.length;n<i;n++){let t=r[n];e=a[t],e||(e=a[t]=Object.create(null),o++),a=e}let s=a[Co];if(s)s>=96&&p?(vo[So++]=96+(31&(s-=96)),vo[So++]=s>>5):vo[So++]=s;else{s=i.nextId,s||(s=64),s<f&&this.shouldShareStructure&&!this.shouldShareStructure(r)?(s=i.nextOwnId,s<m||(s=f),i.nextOwnId=s+1):(s>=m&&(s=f),i.nextId=s+1);let t=r.highByte=s>=96&&p?s-96>>5:-1;a[Co]=s,i[s-64]=r,s<f?(r.isShared=!0,i.sharedLength=s-63,n=!0,t>=0?(vo[So++]=96+(31&s),vo[So++]=t):vo[So++]=s):(t>=0?(vo[So++]=213,vo[So++]=114,vo[So++]=96+(31&s),vo[So++]=t):(vo[So++]=212,vo[So++]=114,vo[So++]=s),o&&(g+=y*o),v.length>=d&&(v.shift()[Co]=0),v.push(a),b(r))}for(let n=0,i=r.length;n<i;n++)b(t[r[n]])},w=t=>{let r;if(t>16777216){if(t-e>_o)throw new Error("Packed buffer would be larger than maximum buffer size");r=Math.min(_o,4096*Math.round(Math.max((t-e)*(t>67108864?1.25:2),4194304)/4096))}else r=1+(Math.max(t-e<<2,vo.length-1)>>12)<<12;let n=new xo(r);return go=new DataView(n.buffer,0,r),vo.copy?vo.copy(n,0,e,t):n.set(vo.slice(e,t)),So-=e,e=0,yo=n.length-10,vo=n}}useBuffer(t){vo=t,go=new DataView(vo.buffer,vo.byteOffset,vo.byteLength),So=0}};function Do(t,e,r,n){let i=t.byteLength;if(i+1<256){var{target:a,position:o}=r(4+i);a[o++]=199,a[o++]=i+1}else if(i+1<65536){var{target:a,position:o}=r(5+i);a[o++]=200,a[o++]=i+1>>8,a[o++]=i+1&255}else{var{target:a,position:o,targetView:s}=r(7+i);a[o++]=201,s.setUint32(o,i+1),o+=4}a[o++]=116,a[o++]=e,a.set(new Uint8Array(t.buffer,t.byteOffset,t.byteLength),o)}function Po(t,e){let r=t.byteLength;var n,i;if(r<256){var{target:n,position:i}=e(r+2);n[i++]=196,n[i++]=r}else if(r<65536){var{target:n,position:i}=e(r+3);n[i++]=197,n[i++]=r>>8,n[i++]=255&r}else{var{target:n,position:i,targetView:a}=e(r+5);n[i++]=198,a.setUint32(i,r),i+=4}n.set(t,i)}function To(t,e,r,n){let i=t.length;switch(i){case 1:e[r++]=212;break;case 2:e[r++]=213;break;case 4:e[r++]=214;break;case 8:e[r++]=215;break;case 16:e[r++]=216;break;default:i<256?(e[r++]=199,e[r++]=i):i<65536?(e[r++]=200,e[r++]=i>>8,e[r++]=255&i):(e[r++]=201,e[r++]=i>>24,e[r++]=i>>16&255,e[r++]=i>>8&255,e[r++]=255&i)}return e[r++]=n,e.set(t,r),r+=i}function zo(t){if(t.Class){if(!t.pack&&!t.write)throw new Error("Extension has no pack or write function");if(t.pack&&!t.type)throw new Error("Extension has no type (numeric code to identify the extension)");mo.unshift(t.Class),fo.unshift(t)}!function(t){t.unpack?za[t.type]=t.unpack:za[t.type]=t}(t)}mo=[Date,Set,Error,RegExp,ArrayBuffer,Object.getPrototypeOf(Uint8Array.prototype).constructor,Ia],fo=[{pack(t,e,r){let n=t.getTime()/1e3;if((this.useTimestamp32||0===t.getMilliseconds())&&n>=0&&n<4294967296){let{target:t,targetView:r,position:i}=e(6);t[i++]=214,t[i++]=255,r.setUint32(i,n)}else if(n>0&&n<17179869184){let{target:r,targetView:i,position:a}=e(10);r[a++]=215,r[a++]=255,i.setUint32(a,4e6*t.getMilliseconds()+(n/1e3/4294967296|0)),i.setUint32(a+4,n)}else if(isNaN(n)){if(this.onInvalidDate)return e(0),r(this.onInvalidDate());let{target:t,targetView:n,position:i}=e(3);t[i++]=212,t[i++]=255,t[i++]=255}else{let{target:r,targetView:i,position:a}=e(15);r[a++]=199,r[a++]=12,r[a++]=255,i.setUint32(a,1e6*t.getMilliseconds()),i.setBigInt64(a+4,BigInt(Math.floor(n)))}}},{pack(t,e,r){let n=Array.from(t),{target:i,position:a}=e(this.structuredClone?3:0);this.structuredClone&&(i[a++]=212,i[a++]=115,i[a++]=0),r(n)}},{pack(t,e,r){let{target:n,position:i}=e(this.structuredClone?3:0);this.structuredClone&&(n[i++]=212,n[i++]=101,n[i++]=0),r([t.name,t.message])}},{pack(t,e,r){let{target:n,position:i}=e(this.structuredClone?3:0);this.structuredClone&&(n[i++]=212,n[i++]=120,n[i++]=0),r([t.source,t.flags])}},{pack(t,e){this.structuredClone?Do(t,16,e):Po(bo?Buffer.from(t):new Uint8Array(t),e)}},{pack(t,e){let r=t.constructor;r!==wo&&this.structuredClone?Do(t,oo.indexOf(r.name),e):Po(t,e)}},{pack(t,e){let{target:r,position:n}=e(1);r[n]=193}}];var Eo,Io=new Oo({useRecords:!1}),{NEVER:Lo,ALWAYS:Bo,DECIMAL_ROUND:ko,DECIMAL_FIT:Vo}=(Io.pack,Io.pack,{NEVER:0,ALWAYS:1,DECIMAL_ROUND:3,DECIMAL_FIT:4}),Uo=512,jo=1024,No=new Oo({structuredClone:!0});function Ro(t){if(Oi(t))return t;if(Array.isArray(t))return t.map(Ro);if("object"==typeof t&&null!==t){let e={};for(let r of Object.keys(t).sort())e[r]=Ro(t[r]);return Object.setPrototypeOf(e,Object.getPrototypeOf(t)),e}return t}zo({Class:_i.prototype.constructor,type:1,write:t=>({...t}),read:t=>(Object.setPrototypeOf(t,_i.prototype),t)}),zo({Class:Ei.prototype.constructor,type:2,write:t=>[...t],read:t=>(Object.setPrototypeOf(t,Ei.prototype),t)}),zo({Class:zi.prototype.constructor,type:3,write:t=>[...t],read:t=>(Object.setPrototypeOf(t,zi.prototype),t)}),zo({Class:ma.prototype.constructor,type:4,write:t=>t.id,read:t=>new ma(t)}),zo({Class:va.prototype.constructor,type:5,write:t=>t.data,read:t=>new va(t)}),zo({Class:ji.prototype.constructor,type:6,write:t=>({...t}),read:t=>(Object.setPrototypeOf(t,ji.prototype),t)}),(t=>{function e(t){return No.pack(t)}t.serialize=e,t.deserialize=function(t){return No.unpack(t)},t.checksum=function(t){return function(t){var e=0;if(0===t.length)return e;for(let r=0;r<t.length;r++)e=(e<<5)-e+t[r],e|=0;return e}(e(Ro(t))).toString()}})(Eo||(Eo={}));var Fo,Go,qo,Ho,Wo,Xo,Yo,Qo,Zo,Ko,Jo,$o,ts,es,rs,ns,is,as,os,ss="personal camera",ls="a218fcc3-276b-49b9-b485-49037fd14f5f",hs=5526619;function cs(t){return"string"==typeof t&&36===t.length&&/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(t)}(Go=Fo||(Fo={})).isEqual=function(t,e){return t[0]===e[0]&&t[1]===e[1]},Go.lerp=function(t,e,r){return[t[0]+(e[0]-t[0])*r,t[1]+(e[1]-t[1])*r]},(Ho=qo||(qo={})).isEqual=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]},Ho.add=function(t,e){return[t[0]+e[0],t[1]+e[1],t[2]+e[2]]},Ho.sub=function(t,e){return[t[0]-e[0],t[1]-e[1],t[2]-e[2]]},Ho.div=function(t,e){return[t[0]/e[0],t[1]/e[1],t[2]/e[2]]},Ho.mul=function(t,e){return[t[0]*e[0],t[1]*e[1],t[2]*e[2]]},Ho.dist=function(t,e){return Math.hypot(t[0]-e[0],t[1]-e[1],t[2]-e[2])},Ho.lerp=function(t,e,r){return[t[0]+(e[0]-t[0])*r,t[1]+(e[1]-t[1])*r,t[2]+(e[2]-t[2])*r]},(t=>{t.isEqual=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]},t.lerp=function(t,e,r){return[t[0]+(e[0]-t[0])*r,t[1]+(e[1]-t[1])*r,t[2]+(e[2]-t[2])*r,t[3]+(e[3]-t[3])*r]}})(Wo||(Wo={})),(Yo=Xo||(Xo={})).identity=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Yo.isEqual=function(t,e){for(let r=0;r<16;r++)if(t[r]!==e[r])return!1;return!0},Yo.simplify=function(t){return null!==t&&void 0!==t?t:Yo.identity},Yo.applyMatrix4=function(t,e){let r=e.slice(0);for(var n=0,i=e.length;n<i;n+=3){let i=t[3]*e[n]+t[7]*e[n+1]+t[11]*e[n+2]+t[15];r[n]=(t[0]*e[n]+t[4]*e[n+1]+t[8]*e[n+2]+t[12])/i,r[n+1]=(t[1]*e[n]+t[5]*e[n+1]+t[9]*e[n+2]+t[13])/i,r[n+2]=(t[2]*e[n]+t[6]*e[n+1]+t[10]*e[n+2]+t[14])/i}return r},(Zo=Qo||(Qo={})).isRGB=function(t){return"object"==typeof t&&"number"==typeof t.r&&"number"==typeof t.g&&"number"==typeof t.b},Zo.white={r:1,g:1,b:1},Zo.red={r:1,g:0,b:0},Zo.black={r:0,g:0,b:0},Zo.toRgb255a1=function(t){return{r:Math.round(255*t.r),g:Math.round(255*t.g),b:Math.round(255*t.b),a:1}},Zo.clone=function(t){return{r:t.r,g:t.g,b:t.b}},Zo.fromHex=function(t){return{r:((t=Math.floor(t))>>16&255)/255,g:(t>>8&255)/255,b:(255&t)/255}},Zo.toHex=function(t){return 65536*Math.round(255*t.r)+256*Math.round(255*t.g)+Math.round(255*t.b)},Zo.equals=function(t,e){return t.r===e.r&&t.g===e.g&&t.b===e.b},Zo.lerp=function(t,e,r){return{r:t.r+(e.r-t.r)*r,g:t.g+(e.g-t.g)*r,b:t.b+(e.b-t.b)*r}},(t=>{t.white={...Qo.white,a:1},t.transparent={...Qo.white,a:0},t.from0to1=function(t){return{r:t[0],g:t[1],b:t[2],a:t[3]}},t.fromHexAndA=function(t,e){return{...Qo.fromHex(t),a:e}},t.toRgb255a1=function(t){return{r:Math.round(255*t.r),g:Math.round(255*t.g),b:Math.round(255*t.b),a:t.a}},t.equals=function(t,e){return Qo.equals(t,e)&&t.a===e.a},t.lerp=function(t,e,r){return{r:t.r+(e.r-t.r)*r,g:t.g+(e.g-t.g)*r,b:t.b+(e.b-t.b)*r,a:t.a+(e.a-t.a)*r}}})(Ko||(Ko={})),(t=>{t.identity={position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]}})(Jo||(Jo={})),(t=>{t.defaultData={mass:1,stiffness:80,damping:10,velocity:0}})($o||($o={})),(t=>{t.defaultData={control1:[.5,0],control2:[.5,1]}})(ts||(ts={})),(rs=es||(es={})).linear=[0,0,1,1],rs.ease=[.25,.1,.25,1],rs.easeIn=[.42,0,1,1],rs.easeOut=[0,0,.58,1],rs.easeInOut=[.42,0,.58,1],(t=>{t.all=["PerspectiveCamera","OrthographicCamera"],t.is=function(e){return t.all.includes(e)}})(ns||(ns={})),(t=>{t.DefaultUp=[0,1,0],t.DefaultTargetOffset=1e3,t.defaultData={far:1e5,type:"OrthographicCamera",perspective:{near:70,fov:45,zoom:1},orthographic:{near:-1e5,zoom:1},up:t.DefaultUp,isUpVectorFlipped:!1,targetOffset:t.DefaultTargetOffset},t.getZoom=function(t){return"PerspectiveCamera"===t.type?t.perspective.zoom:t.orthographic.zoom}})(is||(is={})),(t=>{t.defaultData=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.1;return{disabled:!1,type:"linear",hideBase:!1,count:3,radial:{radius:2*Math.max(t[0],t[1]),start:0,end:360,alignment:!1,axis:"y",scale:[1,1,1],rotation:[0,0,0],position:[0,0,0]},toObject:{object:"",spreadType:"random",scale:[0,0,0],rotation:[0,0,0],position:[0,0,0],axis:"x",seed:0,count:99,align:"normal"},linear:{scale:[1,1,1],rotation:[0,0,0],position:[t[0]+t[0]*e,0,0]},grid:{count:[2,2,2],size:t.map((t=>t*(1+e))),useCenter:!0},randomness:!1,randomnessObject:{strength:100,scale:[0,0,0],rotation:[0,0,0],position:[0,0,0],movement:1,seed:0,freqScale:10,noiseType:"perlin"}}},t.merge=function(t,e){let r={...t};if(ws.forEach((n=>{var i;Object.assign(r,{[n]:null!==(i=e[n])&&void 0!==i?i:t[n]})})),r.radial={...t.radial},e.radial){let n=t.radial,i=e.radial;_s.forEach((t=>{var e;Object.assign(r.radial,{[t]:null!==(e=i[t])&&void 0!==e?e:n[t]})}))}if(r.linear={...t.linear},e.linear){let n=t.linear,i=e.linear;Ss.forEach((t=>{var e;Object.assign(r.linear,{[t]:null!==(e=i[t])&&void 0!==e?e:n[t]})}))}if(r.grid={...t.grid},e.grid){let n=t.grid,i=e.grid;As.forEach((t=>{var e;Object.assign(r.grid,{[t]:null!==(e=i[t])&&void 0!==e?e:n[t]})}))}if(r.toObject={...t.toObject},e.toObject){let n=t.toObject,i=e.toObject;Ms.forEach((t=>{var e;Object.assign(r.toObject,{[t]:null!==(e=i[t])&&void 0!==e?e:n[t]})}))}if(r.randomnessObject={...t.randomnessObject},e.randomnessObject){let n=t.randomnessObject,i=e.randomnessObject;Cs.forEach((t=>{var e;Object.assign(r.randomnessObject,{[t]:null!==(e=i[t])&&void 0!==e?e:n[t]})}))}return r}})(as||(as={})),(t=>{t.defaultData={radial:{},linear:{},grid:{},toObject:{},randomnessObject:{}};let e=["radial","linear","grid","toObject","randomnessObject"];t.toOps=function(t,r){let n=[];void 0!==t.count&&n.push({type:0,path:r,props:{count:t.count}});for(let i of e){let e=t[i];e&&Object.keys(e).length>0&&n.push({type:0,path:[...r,i],props:e})}return n}})(os||(os={}));var us,ds,ps,fs,ms,vs,gs,ys,bs,xs,ws=["count"],_s=["radius","start","end","position","scale","rotation"],Ss=["position","scale","rotation"],As=["count","size"],Ms=["count","position","scale","rotation"],Cs=["strength","scale","rotation","position","movement","seed","freqScale"];(t=>{t.all=["PointLight","SpotLight","DirectionalLight","HemisphereLight"],t.is=function(e){return t.all.includes(e)}})(us||(us={})),(t=>{t.defaultData=function(t){return function(t){if("PointLight"===t)return{type:t,color:Ko.white,intensity:1,distance:2e3,decay:1,shadows:!0,shadowResolution:1024,shadowRadius:1,penumbraSize:.5,depth:1e5};if("SpotLight"===t)return{type:t,color:Ko.white,intensity:1,distance:2e3,decay:1,shadows:!0,penumbra:0,angle:30/180*Math.PI,depth:1e5,penumbraSize:.5,shadowResolution:1024,shadowRadius:1};if("DirectionalLight"===t)return{type:t,color:Ko.white,intensity:1,shadows:!0,size:2e3,depth:1e5,penumbraSize:.5,shadowResolution:1024,shadowRadius:1};throw new Error("not implemented")}(t)}})(ds||(ds={})),(t=>{t.defaultData={enabled:"visibility",fusedBody:!0,rigidBody:"positioned",density:1,pointMass:0,gravityScale:1,friction:.5,damping:0,restitution:.2,colliderType:"convex",enabledRotation:[!0,!0,!0],enabledTranslation:[!0,!0,!0]}})(ps||(ps={})),(t=>{t.defaultData={castShadow:!0,receiveShadow:!0},t.equals=function(t,e){return t.castShadow===e.castShadow&&t.receiveShadow===e.receiveShadow}})(fs||(fs={})),(t=>{t.defaultData={flatShading:!1,wireframe:!1,side:0},t.equals=function(t,e){return t.flatShading===e.flatShading&&t.side===e.side&&t.wireframe===e.wireframe}})(ms||(ms={})),(t=>{t.defaultData={...ms.defaultData,...fs.defaultData}})(vs||(vs={})),(t=>{t.getMaterialData=function(t,e){let r=[];if("material"in t){var n,i;let a="string"==typeof t.material?null!==(n=e.materials[t.material])&&void 0!==n?n:null===(i=e.lib.materials[t.material])||void 0===i?void 0:i.asset:t.material;a&&r.push(a)}else if("materials"in t)for(let s of t.materials){var a,o;let t="string"==typeof s?null!==(a=e.materials[s])&&void 0!==a?a:null===(o=e.lib.materials[s])||void 0===o?void 0:o.asset:s;t&&r.push(t)}return r}})(gs||(gs={})),(t=>{t.defaultVideo={data:"",thumb:"/_assets/_videos/catThumb.png",type:"video",name:"Cat video"},t.maxSize=3e7})(ys||(ys={})),(t=>{t.is=function(t){return"texture"===t||"video"===t||"color"===t||"depth"===t||"normal"===t||"gradient"===t||"noise"===t||"fresnel"===t||"rainbow"===t||"toon"===t||"outline"===t||"transmission"===t||"matcap"===t||"displace"===t||"pattern"===t||"light"===t}})(bs||(bs={})),(t=>{t.is=function(t){return"phong"===t||"toon"===t||"lambert"===t||"physical"===t}})(xs||(xs={}));var Os,Ds,Ps,Ts,zs=["mode","gradientType","noiseType","displacementType","projection","cnormal","crop","axis","side"],Es=["wrapping","image","video","name"];(t=>{t.patch=function(t,e){let{texture:r,...n}=e;if(Object.assign(t,n),r){let e=t.texture;e&&Object.assign(e,r)}},t.defaultData=function(t,e){return"light"===t&&e?function(t){let e={mode:0,isMask:!1,visible:!0,bumpMap:void 0,bumpMapIntensity:5,roughnessMap:void 0,alphaOverride:1};switch(t){case"phong":return{...e,category:"phong",specular:{r:.2,g:.2,b:.2},shininess:5,type:"light",visible:!0,mode:0,occlusion:!0,alpha:.6};case"toon":return{...e,category:"toon",specular:{r:.2,g:.2,b:.2},shininess:10,type:"light",alpha:1};case"lambert":return{...e,category:"lambert",emissive:{r:0,g:0,b:0},type:"light",alpha:1,visible:!0,mode:0,occlusion:!0};case"physical":return{...e,category:"physical",roughness:.2,metalness:.2,reflectivity:.2,type:"light",alpha:1,visible:!0,mode:0,occlusion:!0}}}(e):function(t){let e={alpha:1,mode:0,isMask:!1,visible:!0};switch(t){case"texture":return{...e,type:"texture",size:[128,128],blending:0,axis:"x",side:2,projection:0,texture:{image:"image_0",wrapping:1e3,repeat:[1,1],offset:[0,0]},crop:!1};case"video":return{...e,type:"video",size:[128,128],blending:0,axis:"x",side:2,projection:0,texture:{video:ys.defaultVideo,wrapping:1001,repeat:[1,1],offset:[0,0]},crop:!1};case"color":return{...e,type:"color",color:Qo.fromHex(hs)};case"depth":return{...e,type:"depth",gradientType:1,smooth:!1,isVector:!0,isWorldSpace:!1,origin:[0,0,0],direction:[1,0,0],colors:[[1,1,1,1],[0,0,0,1]],steps:[0,1],near:50,far:200};case"normal":return{...e,type:"normal",cnormal:[1,1,1]};case"gradient":return{...e,type:"gradient",gradientType:0,smooth:!1,colors:[[0,0,0,1],[1,1,1,1],[1,1,1,1],[1,1,1,1],[1,1,1,1],[1,1,1,1],[1,1,1,1],[1,1,1,1],[1,1,1,1],[1,1,1,1]],steps:[0,1,1,1,1,1,1,1,1,1],num:2,angle:0,offset:[0,0],morph:[0,0]};case"noise":return{...e,type:"noise",size:[100,100,100],noiseType:0,scale:1,move:1,colorA:{...Qo.fromHex(6710886),a:1},colorB:{...Qo.fromHex(6710886),a:1},colorC:{...Qo.fromHex(16777215),a:1},colorD:{...Qo.fromHex(16777215),a:1},distortion:[1,1],fA:[1.7,9.2],fB:[8.3,2.8],voronoiStyle:0,highCut:1,lowCut:0,smoothness:.3,seed:0,quality:1};case"fresnel":return{...e,type:"fresnel",color:Ko.fromHexAndA(16777215,1),bias:.1,scale:1,intensity:2,factor:1};case"rainbow":return{...e,type:"rainbow",filmThickness:30,movement:0,wavelengths:[0,0,0],noiseStrength:0,noiseScale:1,offset:[0,0,0]};case"toon":return{...e,type:"toon",positioning:2,colors:[[0,0,0,1],[.5,.5,.5,1],[.5,.5,.5,1],[1,1,1,1],[1,1,1,1],[1,1,1,1],[1,1,1,1],[1,1,1,1],[1,1,1,1],[1,1,1,1]],steps:[0,.475,.525,1,1,1,1,1,1,1],num:4,source:[0,1e3,0],isWorldSpace:!0,noiseStrength:0,noiseScale:1,shadowColor:Ko.fromHexAndA(0,0),offset:[0,0,0]};case"outline":return{...e,type:"outline",outlineColor:Ko.fromHexAndA(0,1),contourColor:Ko.fromHexAndA(0,1),outlineWidth:2,contourWidth:5,outlineThreshold:.4,contourThreshold:0,outlineSmoothing:0,contourFrequency:10,contourDirection:[0,1,0],positionalLines:!1,compensation:!0};case"matcap":return{...e,type:"matcap",texture:{image:"matcap_0",wrapping:1001,repeat:[1,1],offset:[0,0]}};case"transmission":return{...e,type:"transmission",thickness:10,ior:1.5,roughness:1};case"displace":return{visible:!0,type:"displace",displacementType:"noise",noiseType:0,scale:10,movement:1,offset:[0,0,0],intensity:8,voronoiStyle:0,smoothness:.3,seed:0,highCut:1,lowCut:0,quality:1};case"pattern":return{...e,type:"pattern",style:0,projection:0,axis:"y",blending:0,offset:[0,0],colorA:{...Qo.fromHex(0),a:1},colorB:{...Qo.fromHex(16777215),a:1},frequency:[10,10],size:.5,variation:0,smoothness:.5,zigzag:0,rotation:0,vertical:[0,1],horizontal:[0,1],sides:6}}}(t)}})(Os||(Os={})),(t=>{function e(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"layer1",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"layer2",n=new Ei;return n.push({fi:0,data:Os.defaultData("light",t),id:e}),n.push({fi:1,data:Os.defaultData("color"),id:r}),{layers:n}}t.isMergable=function(t){return!t.layers.some((t=>"texture"===t.data.type&&0!==t.data.projection||"depth"===t.data.type&&!t.data.isWorldSpace||"noise"===t.data.type||"displace"===t.data.type))},t.getHash=function(t){let e="";return t.layers.forEach((t=>{Object.entries(t.data).forEach((t=>{let[r,n]=t;e+="".concat(r).concat(n),Array.isArray(n)?n.forEach((t=>e+="".concat(t))):"object"==typeof n?Object.values(n).forEach((t=>{e+="".concat("number"==typeof t?t.toFixed(4):t)})):e+="".concat(n)}))})),e},t.defaultEmptyData=function(){return{layers:new Ei}},t.defaultData=function(){return e("phong",arguments.length>0&&void 0!==arguments[0]?arguments[0]:"layer1",arguments.length>1&&void 0!==arguments[1]?arguments[1]:"layer2")},t.withName=function(t,e){return{...t,name:e}},t.defaultTwoLayerData=e,t.defaultTwoLayerTextureData=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"phong",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"layer1",n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"layer2",i=Os.defaultData("texture");Object.assign(i.texture,{image:t});let a=new Ei;return a.push({fi:0,data:i,id:r}),a.push({fi:1,data:Os.defaultData("light",e),id:n}),{layers:a}},t.defaultTwoLayerVideoTextureData=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"phong",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"layer1",n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"layer2",i=Os.defaultData("video");Object.assign(i.texture,{video:t});let a=new Ei;return a.push({fi:0,data:i,id:r}),a.push({fi:1,data:Os.defaultData("light",e),id:n}),{layers:a}}})(Ds||(Ds={})),(t=>{t.defaultData=function(){return{points:new Ei,roundness:0,shapeHoles:[],isClosed:!1}}})(Ps||(Ps={})),(t=>{t.defaultData=function(){return{points:new Ei,lastInsertionPlane:null,subdivisions:12,isClosed:!1}}})(Ts||(Ts={}));var Is,Ls={type:"Ellipse",width:50,height:50,spikes:16,angle:360,innerRadius:0};(t=>{t.merge=function(t,e){let r={...t};return Sl.forEach((n=>{var i;Object.assign(r,{[n]:null!==(i=e[n])&&void 0!==i?i:t[n]})})),r}})(Is||(Is={}));var Bs,ks,Vs,Us,js,Ns,Rs,Fs,Gs,qs,Hs,Ws,Xs,Ys,Qs,Zs,Ks,Js,$s,tl,el,rl,nl,il,al,ol,sl,ll,hl,cl,ul,dl,pl,fl,ml,vl,gl,yl,bl,xl,wl,_l={shape:Ls,depth:1,offset:0,bevel:50,bevelSides:6,angle:0,twist:0,startScale:1,endScale:1,capType:"flat"},Sl=["depth","offset","angle","twist","startScale","endScale"];function Al(t){t.layers.forEach((t=>{if("depth"===t.type&&void 0!==t.colorA){let e=t.colorA,r=t.colorB,n=[[e.r,e.g,e.b,e.a],[r.r,r.g,r.b,r.a]],i=[0,1];for(let t=2;t<10;t++)n.push(n[1]),i.push(1);let a={...wi(ua(t),"type","visible","isVector","isWorldSpace","origin","alpha","mode"),near:Math.max(0,t.near),far:Math.max(0,t.far),colors:n,steps:i,num:2,direction:[1,0,0],smooth:!1,gradientType:1};Object.assign(t,a)}else if("depth"===t.type&&1===t.gradientType&&(t.near<0||t.far<0)){let e={...ua(t),near:Math.max(t.near,0),far:Math.max(t.far,0)};Object.assign(t,e)}}))}function Ml(t,e){Object.values(t.shared.materials).forEach((t=>e(t)))}function Cl(t,e){t.scene.objects.traverse(((t,r)=>{"materials"in r?r.materials.forEach(((t,n)=>{void 0===t&&(r.materials[n]=Ds.defaultData(),t=r.materials[n]),"string"!=typeof t&&e(t)})):"material"in r?"string"!=typeof r.material&&(void 0===r.material&&(r.material=Ds.defaultData()),e(r.material)):"Mesh"===r.type&&(void 0===r.material&&(r.material=Ds.defaultData()),e(r.material)),"overrides"in r&&Object.values(r.overrides).forEach((t=>{t.material&&"string"!=typeof t.material&&e(t.material)}))}))}function Ol(t){void 0===t.layers&&Object.assign(t,Ds.defaultTwoLayerData("lambert"))}function Dl(t){!t.layers||t.layers.forEach((t=>{if("depth"===t.type&&10===t.colors.length){let e=[...t.colors];e.push(t.colors[9]);let r=[...t.steps];r.push(t.steps[9]);let n={...ua(t),colors:e,steps:r};Object.assign(t,n)}}))}function Pl(t){t.scene.objects.traverse(((t,e)=>{"materials"in e?e.materials.forEach((t=>{"string"!=typeof t&&Dl(t)})):"material"in e&&"string"!=typeof e.material&&Dl(e.material)})),Object.values(t.shared.materials).forEach((t=>Dl(t)))}function Tl(t){t.layers&&t.layers.forEach((t=>{"depth"===t.type&&void 0!==t.num&&(t.colors=t.colors.slice(0,t.num),t.steps=t.steps.slice(0,t.num),delete t.num)}))}function zl(t){t.layers&&t.layers.forEach((t=>{(function(t){return"displace"!==t.type})(t)&&void 0===t.isMask&&(t.isMask=!1),("texture"===t.type||"video"===t.type)&&void 0===t.blending&&(t.blending=0),("noise"===t.type||"displace"===t.type&&"noise"===t.displacementType)&&(void 0===t.voronoiStyle&&(t.voronoiStyle=0),void 0===t.highCut&&(t.highCut=1),void 0===t.lowCut&&(t.lowCut=0),void 0===t.smoothness&&(t.smoothness=.3),void 0===t.seed&&(t.seed=0),void 0===t.quality&&(t.quality=1))}))}function El(t){var e;let r=null===(e=t.layers.find((t=>"light"===t.type)))||void 0===e?void 0:e.data;if("basic"===(null===r||void 0===r?void 0:r.category)){let t=Os.defaultData("light","phong"),e=r;Object.assign(e,t),e.visible=!1}}function Il(t){Ml(t,El),Cl(t,El)}function Ll(t){t.layers.forEach((t=>{"light"===t.type&&"toon"!==t.category&&void 0===t.occlusion&&(t.occlusion=!0)}))}function Bl(t){t.layers&&t.layers.forEach((t=>{"light"===t.type&&void 0===t.bumpMapIntensity&&(t.bumpMapIntensity=5)}))}function kl(t,e){if(e<1&&(Cl(t,Al),Ml(t,Al),t.schema=1),e<2&&(function(t){Object.assign(t.scene.publish,{orbitControls:{...al.defaultData,...ua(t.scene.publish.orbitControls)}})}(t),t.schema=2),e<3&&(function(t){function e(t){if(t.layers)for(let e of Object.values(t.layers))if(e)for(let[t,r]of Object.entries(e))if((zs.includes(t)||"boolean"==typeof r)&&delete e[t],"texture"===t)for(let[e,n]of Object.entries(r))(Es.includes(e)||"boolean"==typeof n)&&delete r[e]}t.scene.objects.traverse(((t,r)=>{r.states.forEach((t=>{let r=t;r.material?e(r.material):r.materials&&r.materials.forEach((t=>{e(t)}))}))}))}(t),t.schema=3),e<4&&(function(t){t.scene.publish.withBackground=!0}(t),t.schema=4),e<5&&(function(t){t.scene.publish.settings.web={compress:!0,preload:!0,preset:1,logo:!0,hint:!1}}(t),t.schema=5),e<6&&(function(t){t.scene.objects.traverse(((t,e)=>{let r=e.cloner;r&&(r.radial.scale=r.radial.scale.map((t=>t+1)),r.linear.scale=r.linear.scale.map((t=>t+1)))}))}(t),t.schema=6),e<7&&(function(t){t.scene.objects.traverse(((t,e)=>{let r=e.geometry;r&&("DodecahedronGeometry"===r.type||"IcosahedronGeometry"===r.type)&&(r.detail=Math.round(r.detail))}))}(t),t.schema=7),e<8&&(t.schema=8),e<9&&(Pl(t),t.schema=9),e<10&&(function(t){t.scene.objects.traverse(((t,e)=>{"Mesh"===e.type&&("BooleanGeometry"===e.geometry.type||"SubdivGeometry"===e.geometry.type)&&(e.geometry.phongAngle=35)}))}(t),t.schema=10),e<11&&(function(t){t.scene.environment.ambientLight.softShadows=!1,t.scene.environment.ambientLight.softShadowQuality="low",t.scene.objects.traverse(((t,e)=>{("DirectionalLight"===e.type||"SpotLight"===e.type)&&(e.shadowResolution=1024,e.shadowRadius=1,e.depth=1e5)})),t.shared.penumbraSize=new Array(5).fill(.5)}(t),t.schema=11),e<12&&(Pl(t),t.schema=12),e<13&&(function(t){t.shared.audios=E({},_i.prototype)}(t),t.schema=13),e<14&&(function(t){let e=t.shared.materials;Object.entries(e).forEach((t=>{let[r,n]=t;if(!n.layers){let t={name:"Untitled Material",layers:[{fi:0,data:{type:"light",category:"phong",alpha:.6,visible:!0,mode:0,specular:{r:.2,g:.2,b:.2},shininess:5},id:"layer1"},{fi:1,data:{type:"color",alpha:1,visible:!0,mode:0,color:{r:.2823529411764706,g:.2823529411764706,b:.30196078431372547}},id:"layer2"}]};Object.assign(e,{[r]:t})}}))}(t),t.schema=14),e<15&&(function(t){Object.entries(ua(t.shared.images)).filter((t=>!1===t[1].asset)).map((t=>t[0])).forEach((e=>{delete t.shared.images[e]})),Object.entries(ua(t.shared.audios)).filter((t=>!1===t[1].asset)).map((t=>t[0])).forEach((e=>{delete t.shared.audios[e]}))}(t),t.schema=15),e<16&&(function(t){t.scene.publish.settings.web.preload=!1}(t),t.schema=16),e<17&&(Cl(t,Tl),Ml(t,Tl),t.schema=17),e<18&&(Cl(t,Ol),Ml(t,Ol),t.schema=18),e<19&&(function(t){Object.assign(t.scene.publish.settings,{video:{...ol.defaultData.settings.video,...ua(t.scene.publish.settings.video)}})}(t),t.schema=19),e<20&&(function(t){t.shared.fonts=E({},_i.prototype)}(t),function(t){let e=[];t.scene.objects.traverse(((r,n)=>{let i=n;if("TextFrame"===i.type){let n=Ds.defaultTwoLayerData("phong"),a="string"==typeof i.color?t.shared.colors[i.color]:i.color;n.layers[1].data.color={r:a.r,g:a.g,b:a.b},n.layers[1].data.alpha=i.alpha;let o=function(t){return t.replace(".typeface","").replace(/optimer/gi,"open sans").replace("space_mono","space mono").replace(/alma_mono/gi,"varela round").replace(/droid_sans_mono/gi,"noto sans mono").replace(/droid_sans|gentilis|gnomon_(simple|foreground)|helvetiker/gi,"roboto").replace(/droid_serif/gi,"roboto slab").replace("_sans"," sans").replace("crimson_text","crimson text").replace("medium_medium","medium").replace("fatface_fatface","fatface").replace("100hairline","thin").replace("200thin","extralight").replace("300light","light").replace("500medium","medium").replace("600semi","semibold").replace("800heavy","extrabold").replace("900black","black").replace(/bodoni_(11|16|24|36|48|72|96)([^_])/gi,"bodoni_$1_$2").replace(/bodoni_(11|16|24|36|48|72|96)/gi,"bodoni moda").replace(/(thin|hairline)(_regular)?/gi,"100").replace(/(extra|ultra)light(_regular)?/gi,"200").replace(/light(_regular)?/gi,"300").replace(/_book|_normal|_roman/gi,"_regular").replace(/medium(_regular)?/gi,"500").replace(/(semi|demi)bold(_regular)?/gi,"600").replace(/(extra|ultra)bold(_regular)?/gi,"800").replace(/bold(_regular)?/gi,"700").replace(/(black|heavy|fatface)(_regular)?/gi,"900").replace(/([1-9]00)_italic/gi,"$1italic").replace(/regularitalic/gi,"italic").replace(/regularitalic/gi,"italic").split(" ").map((t=>t.charAt(0).toUpperCase()+t.slice(1))).join(" ")}(i.font);void 0===t.shared.fonts[o]&&(t.shared.fonts[o]={name:o});let s={name:i.name,...Ys.defaultData,...Ks.defaultData,flatShading:!1,wireframe:!1,geometry:{...Vs.defaultData("TextGeometry"),width:i.width,height:i.height,font:o,depth:0,horizontalAlign:i.horizontalAlign,verticalAlign:i.verticalAlign,fontSize:1.40625*i.fontSize,lineHeight:i.lineHeight/1.40625,letterSpacing:i.letterSpacing-1,text:i.text,textTransform:i.textTransform,extrudeBevelSize:0,extrudeBevelSegments:1},material:n,states:ua(i.states),events:ua(i.events),visible:i.visible,raycastLock:i.raycastLock,position:i.position,rotation:i.rotation,scale:i.scale,hiddenMatrix:i.hiddenMatrix},l=ua(t.scene.objects).parent(r);t.scene.objects.insertAfter(null!==l&&void 0!==l?l:null,r,[{id:r+"new",data:s,children:[]}]),e.push(r)}})),e.forEach((e=>{t.scene.objects.delete(e)}))}(t),t.schema=20),e<21&&(function(t){let e={0:"MouseDown",1:"MouseUp",2:"MouseHover",5:"KeyDown",6:"KeyUp",7:"Start",9:"LookAt",10:"Follow",11:"Scroll",12:"Audio",13:"GameControl"};t.scene.objects.traverse(((t,r)=>{r.events.forEach((t=>{if(e[Number(t.type)])if(Object.assign(t,{type:e[Number(t.type)]}),"Audio"===t.type&&"audioEvent"in t&&(Object.assign(t,{playAudio:t.audioEvent}),delete t.audioEvent),"GameControl"===t.type)Object.assign(t,{gameActions:{idle:new Ei,move:new Ei,jump:new Ei}});else{let e=new Ei;Object.assign(t,{actions:e}),("MouseDown"===t.type||"MouseUp"===t.type||"KeyDown"===t.type||"KeyUp"===t.type)&&"url"in t&&e.push({fi:0,id:n.MathUtils.generateUUID(),data:{type:"Link",url:t.url,delay:0}}),"targets"in t&&(t.targets.forEach(((t,r,i)=>{let a={easing:t.easing,duration:t.duration};6===t.easing?Object.assign(a,wi(t,"mass","stiffness","damping","velocity")):5===t.easing&&Object.assign(a,{control1:{...t.control1},control2:{...t.control2}});let o={repeat:t.repeat?-1:0,delay:t.delay,delayDirection:t.delayDirection,direction:t.cycle&&t.rewind?"pingpong-rewind":t.cycle?"pingpong":"normal"},s={state:t.state,...o,...a},l={allowSlerp:!0,type:"Transition",object:t.object,repeat:0,delay:0,delayDirection:void 0,direction:"normal",tweens:new Ei({fi:0,id:n.MathUtils.generateUUID(),data:{state:void 0,repeat:0,delay:0,delayDirection:void 0,direction:"normal",duration:0,easing:4}},{fi:1,id:n.MathUtils.generateUUID(),data:s})};e.push({fi:i,id:r,data:l})})),delete t.targets)}}))}))}(t),function(t){t.scene.objects.traverse(((t,e)=>{function r(t,r){let i=new Ei,a=[];if(e.events.forEach(((t,e,n)=>{if("Audio"===t.type&&t.trigger===r){let r;a.push(e),"play"===t.interaction?r={...wi(t,"interaction","audio","delay","volume","loop"),triggerAfter:"after"in t?t.after:void 0,toggle:"after"in t?t.toggle:void 0,type:"Audio"}:("pause"===t.interaction||"stop"===t.interaction)&&(r={...wi(t,"interaction","delay","object","playAudio"),type:"Audio"}),r&&i.push({fi:n,id:e,data:r})}})),a.forEach((t=>e.events.delete(t))),i.length){var o;let r=null===(o=e.events.find((e=>e.type===t)))||void 0===o?void 0:o.data;r?"actions"in r&&r.actions.insertBefore(null,i):e.events.insertBefore(null,[{id:n.MathUtils.generateUUID(),data:{type:t,actions:i}}])}}r("Start","start"),r("MouseDown","mouseDown"),r("MouseUp","mouseUp"),r("KeyDown","keyDown"),r("KeyUp","keyUp")}))}(t),t.schema=21),e<22&&(Il(t),t.schema=22),e<23&&(function(t){t.scene.objects.traverse(((t,e)=>{"Mesh"===e.type&&"SubdivGeometry"===e.geometry.type&&(e.geometry.scaleBaked||(e.geometry.scaleBaked=[1,1,1]))}))}(t),t.schema=23),e<24&&(function(t){t.scene.objects.traverse(((t,e)=>{("Empty"===e.type||"Mesh"===e.type)&&e.cloner&&!e.cloner.randomnessObject&&!e.cloner.toObject&&!e.cloner.randomness&&(e.cloner={...e.cloner,toObject:{object:"",spreadType:"random",scale:[0,0,0],rotation:[0,0,0],position:[0,0,0],axis:"x",seed:0,count:99,align:"normal"},randomness:!1,randomnessObject:{strength:100,scale:[0,0,0],rotation:[0,0,0],position:[0,0,0],movement:1,seed:0,freqScale:10,noiseType:"perlin"}})}))}(t),t.schema=24),(e<25||void 0===t.shared.videos)&&(function(t){t.shared.videos=E({},_i.prototype)}(t),e<25&&(t.schema=25)),e<26&&(function(t){t.scene.objects.traverse(((e,r)=>{let n=t.scene.objects.unproxy().parent(e);if(n){let e=ua(t.scene.objects.data(n));e&&"Mesh"===e.type&&"BooleanGeometry"===e.geometry.type&&"Mesh"===r.type&&(r.visible=!0!==ua(r).booleanExclude)}}))}(t),t.schema=26),e<27&&(function(t){t.scene.objects.traverse(((t,e)=>{if("Mesh"===e.type){let t=e;"NonParametricGeometry"===e.geometry.type?void 0!==t.material&&delete t.material:void 0!==t.materials&&delete t.materials}}))}(t),t.schema=27),e<28&&(Il(t),t.schema=28),e<29&&(function(t){function e(t){Object.setPrototypeOf(t,ji.prototype),t.texture&&Object.setPrototypeOf(t.texture,ji.prototype)}function r(t){Object.setPrototypeOf(t,ji.prototype);for(let r in t)e(t[r])}t.scene.objects.traverse(((t,e)=>{e.states.forEach((t=>{let e=t;if(e.material){let t=ua(e.material).layers;r(t),e.material.layers=t}if(e.materials)for(let n=0;n<e.materials.length;n++){let t=e.materials[n],i=ua(t).layers;r(i),t.layers=i}}))}))}(t),t.schema=29),e<30&&(function(t){t.scene.objects.traverse(((t,e)=>{"Mesh"===e.type&&"NonParametricGeometry"===e.geometry.type&&!("material"in e)&&!("materials"in e)&&(e.material=Ds.defaultTwoLayerData("phong"))}))}(t),t.schema=30),e<31&&(function(t){void 0===t.scene.publish.orbitControls.autoZoom&&(t.scene.publish.orbitControls.autoZoom=!1),t.scene.objects.traverse(((t,e)=>{("OrthographicCamera"===e.type||"PerspectiveCamera"===e.type)&&(void 0===e.orthographic.autoZoom&&(e.orthographic.autoZoom=!1),void 0===e.orthographic.autoZoomFrustumSize&&(e.orthographic.autoZoomFrustumSize=790))}))}(t),t.schema=31),e<33&&(function(t){t.scene.objects.traverse(((t,e)=>{void 0===e.pathSnapping&&(e.pathSnapping={pathId:null,slide:0,offset:0,orientation:"tangential"}),void 0===e.pathSnapping.offset&&(e.pathSnapping.offset=0)}))}(t),t.schema=33),e<34&&(function(t){void 0===t.scene.publish.mouseEventTarget&&(t.scene.publish.mouseEventTarget="canvas"),void 0===t.scene.publish.settings.web.hint&&(t.scene.publish.settings.web.hint=!1)}(t),t.schema=34),e<35&&(function(t){let{video:e}=t.scene.publish.settings;"gif"===e.format&&e.fps>48&&(e.fps=15)}(t),t.schema=35),e<36&&(function(t){t.scene.objects.traverse(((t,e)=>{e.events.forEach((t=>{"GameControl"===t.type&&(t.resetYPosition=Math.abs(t.resetYPosition-e.position[1]))}))}))}(t),t.schema=36),e<37&&(function(t){let e=t.scene.environment.usePhysics;t.scene.objects.traverse(((t,r)=>{e&&null===r.physics?r.collision=!1:r.collision="visibility"}))}(t),t.schema=37),e<38&&(Cl(t,zl),Ml(t,zl),t.schema=38),e<39&&(function(t){t.scene.objects.traverse(((t,e)=>{e.events.forEach((t=>{"GameControl"===t.type&&(t.navmesh=wl.defaultDataThirdPerson.navmesh)}))}))}(t),t.schema=39),e<40&&(function(t){t.scene.styles||(t.scene.styles=hl.defaultData())}(t),t.schema=40),e<41&&(function(t){void 0===t.scene.environment.ambientLight.occlusion&&(t.scene.environment.ambientLight.occlusion=!1),void 0===t.scene.environment.ambientLight.aoFullRes&&(t.scene.environment.ambientLight.aoFullRes=!1),void 0===t.scene.environment.ambientLight.radius&&(t.scene.environment.ambientLight.radius=256),void 0===t.scene.environment.ambientLight.bias&&(t.scene.environment.ambientLight.bias=.5),void 0===t.scene.environment.ambientLight.aoColor&&(t.scene.environment.ambientLight.aoColor={r:.19607843137254902,g:.19607843137254902,b:.19607843137254902}),Cl(t,Ll),Ml(t,Ll)}(t),t.schema=41),e<42&&(function(t){t.scene.objects.traverse(((t,e)=>{e.events.forEach((t=>{"GameControl"===t.type&&Object.assign(t.gameActions,{run:new Ei})}))}))}(t),t.schema=42),e<43&&(function(t){t.scene.objects.traverse(((t,e)=>{e.events.forEach((t=>{"GameControl"===t.type&&(t.keyAssignments=[...t.keyAssignments,["run","\u21e7"],["none","Ctrl"]])}))}))}(t),t.schema=43),e<99){var r;Cl(t,Bl),Ml(t,Bl),null===t.scene.publish.playCamera&&(t.scene.publish.playCamera=ss);let e=ua(t.scene.objects),n=t.scene.objects;t.scene.publish.playPage=ls,n.insertBefore(null,null,[{id:ls,data:{...rl.defaultData,backgroundColor:t.scene.backgroundColor,fog:t.scene.fog,postprocessing:t.scene.postprocessing,ao:wi(t.scene.environment.ambientLight,"occlusion","aoFullRes","radius","bias","aoColor"),publish:{playCamera:t.scene.publish.playCamera,gameControlObject:t.scene.publish.gameControlObject},shadow:wi(t.scene.environment.ambientLight,"softShadowQuality"),globalPhysics:{...Gs.defaultData,...wi(t.scene.environment,"usePhysics","gravity")},camera:null!==(r=ua(t.scene.ownerCamera))&&void 0!==r?r:rl.defaultData.camera,name:"Scene"},children:[]}]);for(let t of e)t.id!==ul.TRASH_CAN_ID&&n.move(ls,t.fi,t.id);let i=0,a=0;t.shared.penumbraSize&&t.scene.objects.traverse(((e,r)=>{var n;"DirectionalLight"===r.type?(r.penumbraSize=t.shared.penumbraSize[Math.min(i,2)],i+=1):"SpotLight"===r.type&&(r.penumbraSize=t.shared.penumbraSize[3+Math.min(a,1)],a+=1),(void 0===r.physics||null===r.physics)&&"Instance"!==r.type&&(r.physics={},Object.assign(r.physics,ps.defaultData)),void 0!==r.physics&&null!==r.physics&&(r.physics.enabled=null!==(n=r.collision)&&void 0!==n?n:"visibility",delete r.collision)})),t.schema=99}}function Vl(t){t.layers&&t.layers.forEach((t=>{"light"===t.type&&void 0===t.alphaOverride&&(t.alphaOverride=1)}))}(t=>{t.is2DParametricMesh=function(t){return"PolygonGeometry"===t||"RectangleGeometry"===t||"StarGeometry"===t||"TriangleGeometry"===t||"EllipseGeometry"===t},t.isParametricMesh=function(t){return"PolygonGeometry"===t||"PolygonGeometry"===t||"RectangleGeometry"===t||"StarGeometry"===t||"TriangleGeometry"===t||"EllipseGeometry"===t||"PathGeometry"===t||"VectorGeometry"===t||"ConeGeometry"===t||"CubeGeometry"===t||"CylinderGeometry"===t||"DodecahedronGeometry"===t||"HelixGeometry"===t||"IcosahedronGeometry"===t||"LatheGeometry"===t||"PyramidGeometry"===t||"SphereGeometry"===t||"PlaneGeometry"===t||"BackdropGeometry"===t||"TorusGeometry"===t||"TorusKnotGeometry"===t||"BooleanGeometry"===t||"TextGeometry"===t}})(Bs||(Bs={})),(t=>{t.merge=function(t,e){let r={...t};return Object.assign(r,e),"PathGeometry"===r.type&&"extrusion"in e&&e.extrusion&&(r.extrusion={...t.extrusion},Object.assign(r.extrusion,Is.merge(r.extrusion,e.extrusion))),r}})(ks||(ks={})),(t=>{t.defaultData=function(t){if("RectangleGeometry"===t)return{width:320,height:320,type:t,cornerRadius:[0,0,0,0],cornerType:0,depth:0,extrudeBevelSize:0,extrudeBevelSegments:1};if("PathGeometry"===t)return{type:t,width:1,height:1,depth:1,path:Ts.defaultData(),extrusion:_l};if("VectorGeometry"===t)return{width:1,height:1,type:t,subdivisions:12,shape:Ps.defaultData(),depth:0,extrudeBevelSize:0,extrudeBevelSegments:1};if("BooleanGeometry"===t)return{type:t,operation:2,width:0,height:0,depth:0,phongAngle:35};if("TextGeometry"===t)return{type:t,width:100,height:100,depth:0,horizontalAlign:1,verticalAlign:1,fontSize:16,lineHeight:1.2,letterSpacing:0,text:{textValue:""},textTransform:1,font:"Roboto_regular",extrudeBevelSize:0,extrudeBevelSegments:1};if("SphereGeometry"===t)return{type:"SphereGeometry",width:100,height:100,depth:100,widthSegments:64,heightSegments:64,phiStart:0,phiLength:2*Math.PI,thetaStart:0,thetaLength:180};throw new Error("not implemented")}})(Vs||(Vs={})),(t=>{t.defaultData={enabled:!1,useBackgroundColor:!1,color:Qo.white,near:.1,far:2e3}})(Us||(Us={})),(t=>{let e={opacity:1,blendFunction:13,enabled:!1};t.defaultData={enabled:!1,pixelation:{...e,blendFunction:16,granularity:15},bloom:{...e,blendFunction:16,intensity:1,blurScale:1,luminanceThreshold:.25,luminanceSmoothing:.025,kernelSize:3},chromaticAberration:{...e,offset:[2,2]},vignette:{...e,darkness:1,offset:0},hueSaturation:{...e,hue:3,saturation:0},brightnessContrast:{...e,brightness:.25,contrast:0},depthOfField:{...e,focalLength:2,focusDistance:2,bokehScale:2},noise:{...e,blendFunction:16}}})(js||(js={})),(t=>{t.defaultData={softShadowQuality:"low"}})(Ns||(Ns={})),(t=>{t.defaultData={enabled:!0,color:{r:.8274509803921568,g:.8274509803921568,b:.8274509803921568},intensity:.75}})(Rs||(Rs={})),(t=>{t.defaultData={occlusion:!1,aoFullRes:!1,radius:256,bias:.5,aoColor:{r:.19607843137254902,g:.19607843137254902,b:.19607843137254902}}})(Fs||(Fs={})),(t=>{t.defaultData={usePhysics:!1,gravity:-10}})(Gs||(Gs={})),(t=>{t.defaultData={playCamera:ss,gameControlObject:null}})(qs||(qs={})),(t=>{t.defaultData={backgroundColor:Ko.fromHexAndA(2960946,1),postprocessing:js.defaultData,fog:Us.defaultData,globalPhysics:Gs.defaultData,ambient:Rs.defaultData,ao:Fs.defaultData,shadow:Ns.defaultData,publish:qs.defaultData}})(Hs||(Hs={})),(t=>{t.isComponentRelated=function(t){return"Component"===t||"Instance"===t},t.isEmptyOrComponent=function(t){return"Empty"===t||"Instance"===t}})(Ws||(Ws={})),(t=>{t.identity={...Jo.identity,hiddenMatrix:Xo.identity},t.fromObject=function(t){return{position:t.position,rotation:t.rotation,scale:t.scale,hiddenMatrix:t.hiddenMatrix}},t.merge=function(t,e){return{position:(null===e||void 0===e?void 0:e.position)||t.position,rotation:(null===e||void 0===e?void 0:e.rotation)||t.rotation,scale:(null===e||void 0===e?void 0:e.scale)||t.scale,hiddenMatrix:(null===e||void 0===e?void 0:e.hiddenMatrix)||t.hiddenMatrix}},t.diff=function(t,e){return function(t){for(let e of Object.keys(t))void 0===t[e]&&delete t[e];return t}({position:qo.isEqual(t.position,e.position)?void 0:e.position,rotation:qo.isEqual(t.rotation,e.rotation)?void 0:e.rotation,scale:qo.isEqual(t.scale,e.scale)?null:e.scale,hiddenMatrix:Xo.isEqual(t.hiddenMatrix,e.hiddenMatrix)?void 0:e.hiddenMatrix})}})(Xs||(Xs={})),(t=>{t.defaultData={states:new Ei,events:new Ei,visible:!0,raycastLock:!1,physics:ps.defaultData,pathSnapping:{pathId:null,slide:0,offset:0,orientation:"tangential"},...Xs.identity,cloner:null}})(Ys||(Ys={})),(t=>{t.defaultData={type:"Empty",...Ys.defaultData}})(Qs||(Qs={})),(t=>{t.defaultData={type:"Component",...Ys.defaultData}})(Zs||(Zs={})),(t=>{t.defaultData={type:"Mesh",...Ys.defaultData,...vs.defaultData}})(Ks||(Ks={})),(t=>{t.defaultData={...Ys.defaultData,...Xs.identity,position:[0,0,is.DefaultTargetOffset],...is.defaultData}})(Js||(Js={})),(t=>{t.defaultData=function(t){return{...Ys.defaultData,...ds.defaultData(t)}},t.defaultDirectionalLightData={...t.defaultData("DirectionalLight"),position:[200,300,300],name:"Directional Light",intensity:.7}})($s||($s={})),(t=>{function e(t,e){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;for(;r<e.length;){let n=t?t[e[r]]:void 0;if(e.length===r+1)return n;if(!n)return;t=n.descendants,r+=1}}t.resolveWithDes=e,t.resolve=function(t,r){let n=e(t,r,arguments.length>2&&void 0!==arguments[2]?arguments[2]:0);if(n){let t=Object.keys(n);if(1===t.length&&"descendants"===t[0])return}return n}})(tl||(tl={})),(t=>{function e(t,e){return{...Ys.defaultData,...e,component:t,overrides:new ji,physics:void 0,events:void 0,type:"Instance"}}t.rootOverrideProps=["physics","events"],t.compositeNonOptionalOverrideProps=["geometry"],t.compositeEntireOverrideOverrideProps=["material"],t.ofComponent=e,t.fromComponentData=function(t){let r=Xs.fromObject(t.data);return e(t.id,r)}})(el||(el={})),(t=>{t.defaultData={type:"Page",...Ys.defaultData,physics:{...ps.defaultData,fusedBody:!1},...Hs.defaultData,camera:Js.defaultData}})(rl||(rl={})),(t=>{t.defaultCamera={position:[0,0,1e3],scale:[1,1,1],rotation:[0,0,0],hiddenMatrix:Xo.identity,name:"Play Camera",visible:!0,raycastLock:!1,physics:ps.defaultData,states:new Ei,events:new Ei,cloner:null,pathSnapping:{pathId:null,orientation:"tangential",slide:0,offset:0},...is.defaultData},t.KeysByResetCategory={States:["states"],Events:["events"],Material:["material","materials"],Geometry:["geometry"],Position:["position"],Rotation:["rotation"],Scale:["scale"],Transform:["position","scale","rotation","hiddenMatrix"],Name:["name"],Visibility:["visible","raycastLock","flatShading","wireframe","side"],Shadows:["castShadow","receiveShadow"],Cloner:["cloner"],Physics:["physics"]},t.defaultMeshObject={name:"Rectangle",...Ys.defaultData,...Ks.defaultData,geometry:Vs.defaultData("RectangleGeometry"),material:Ds.defaultTwoLayerData("phong","layer1","layer2")},t.defaultBooleanObject={name:"Boolean",...Ys.defaultData,...Ks.defaultData,geometry:Vs.defaultData("BooleanGeometry"),material:Ds.defaultTwoLayerData("phong","layer1","layer2")},t.defaultTextObject={name:"Text",...Ys.defaultData,...Ks.defaultData,geometry:Vs.defaultData("TextGeometry"),material:Ds.defaultTwoLayerData("phong","layer1","layer2")}})(nl||(nl={})),(t=>{t.newEmpty=function(t,e){let r={name:e};return"Mesh"===t.type?(r.geometry={},"material"in t&&(r.material={layers:new ji}),"materials"in t&&(r.materials=t.materials.map((t=>({layers:new ji}))))):ns.is(t.type)&&(r.perspective={},r.orthographic={}),r},t.toOps=function(t,e){let r,n=[],i={orthographic:0,perspective:0,geometry:0};function a(t,e){for(let[r,i]of Object.entries(e.layers)){let{texture:e,...a}=i;if(void 0!==e&&Object.keys(e).length>0){let i={path:[...t,"layers",r,"texture"],props:e,type:0};n.push(i)}if(Object.keys(a).length>0){let e={path:[...t,"layers",r],props:a,type:0};n.push(e)}}}for(let[o,s]of Object.entries(e))if("name"!==o)if("cloner"===o)n.push(...os.toOps(s,["cloner"]));else if("pathSnapping"===o)n.push({path:[o],props:{slide:s.slide,offset:s.offset},type:0});else if("material"===o)a(["material"],s);else if("materials"===o)for(let[t,e]of Object.entries(s))a(["materials",t],e);else if(0===i[o]){if("geometry"===o&&void 0!==s.extrusion){let t={path:[o,"extrusion"],props:s.extrusion,type:0};n.push(t),s={...s},delete s.extrusion}if(Object.keys(s).length>0){let t={path:[o],props:s,type:0};n.push(t)}}else void 0===r&&(r={path:[],props:{},type:0},n.push(r)),r.props[o]=s;return n},t.patch=function(t,e){var r,n,i,a,o,s,l,h;if(void 0===e)return t;let c={...t};if(Object.assign(c,Xs.merge(c,e)),Object.assign(c,{pathSnapping:Object.assign({},c.pathSnapping,{slide:null!==(r=null!==(n=null===(i=e.pathSnapping)||void 0===i?void 0:i.slide)&&void 0!==n?n:null===(a=c.pathSnapping)||void 0===a?void 0:a.slide)&&void 0!==r?r:0,offset:null!==(o=null!==(s=null===(l=e.pathSnapping)||void 0===l?void 0:l.offset)&&void 0!==s?s:null===(h=c.pathSnapping)||void 0===h?void 0:h.offset)&&void 0!==o?o:0})}),ns.is(t.type)){var u,d;c.orthographic={...c.orthographic},c.perspective={...c.perspective};let t=e;void 0!==(null===(u=t.orthographic)||void 0===u?void 0:u.zoom)&&(c.orthographic.zoom=t.orthographic.zoom),void 0!==(null===(d=t.perspective)||void 0===d?void 0:d.zoom)&&(c.perspective.zoom=t.perspective.zoom),void 0!==t.isUpVectorFlipped&&(c.isUpVectorFlipped=t.isUpVectorFlipped),void 0!==t.targetOffset&&(c.targetOffset=t.targetOffset)}else if("Mesh"===t.type)"geometry"in e&&Object.assign(c,{geometry:ks.merge(c.geometry,e.geometry)}),(e.material||e.materials)&&(c=function(t,e){if(void 0===e)return t;let r={...t};return"material"in r&&"material"in e&&e.material&&(r.material=ca(r.material,(t=>{if("string"!=typeof t)for(let[r,n]of Object.entries(e.material.layers)){let e=t.layers.data(r);e&&Os.patch(e,n)}})).data),r.materials&&e.materials&&(r.materials=ca(r.materials,(t=>{for(let i=0;i<r.materials.length;i++){let r=e.materials[i];if("string"!=typeof r)for(let[e,a]of Object.entries(r.layers)){var n;let r=null===(n=t[i])||void 0===n||null===(n=n.layers)||void 0===n?void 0:n.data(e);r&&Os.patch(r,a)}}})).data),r}(c,e)),c.cloner&&"cloner"in e&&Object.assign(c,{cloner:as.merge(c.cloner,e.cloner)});else if("Empty"===t.type)c.cloner&&"cloner"in e&&Object.assign(c,{cloner:as.merge(c.cloner,e.cloner)});else if(us.is(t.type)){let t=e;void 0!==t.intensity&&(c.intensity=t.intensity),void 0!==t.color&&("string"==typeof t.color?c.color=t.color:c.color=Qo.clone(t.color))}return c}})(il||(il={})),(t=>{t.defaultData={enablePan:!0,enableZoom:!0,enableRotate:!0,enableDamping:!0,rotationLimitsMode:0,rotationVerticalOffset:{min:Math.PI/4,max:Math.PI/4},rotationHorizontalOffset:{min:Math.PI/4,max:Math.PI/4},rotationSoftLimit:2,panLimitsMode:0,panVerticalOffset:{min:250,max:250},panHorizontalOffset:{min:250,max:250},panSoftLimit:2,zoomLimitsEnabled:!1,zoomLimits:{min:.1,max:2},autoRotate:!1,autoRotateSpeed:2,autoRotateClockwise:!0,hoverRotatePanMode:0,hoverRotatePanStrength:20,hoverRotateDamping:.125,isTouchZoom:!0,orbitTouches:2,panTouches:3,resetHoverEffectOnPointerLeave:!0}})(al||(al={})),(t=>{t.defaultData={orbitControls:al.defaultData,playPage:ls,withBackground:!0,preventScroll:!1,preventTouchScroll:!1,hideCursor:!1,mouseEventTarget:"canvas",joystickSizeAndXYOffset:Array(12).fill(0).map(((t,e)=>{let r=0,n=0;return e<5?n=-30:e<10&&(n=30),0===e||10===e||5===e?r=30:(4===e||11===e||9===e)&&(r=-30),[120,[r,n],"show"]})),settings:{image:{format:"jpg",ratio:1},video:{format:"mp4",imageFormat:"jpg",fps:30,mbps:80,ratio:Math.max(1,typeof window<"u"?Math.floor(window.devicePixelRatio):1),stopMode:"manual",duration:5e3},web:{logo:!0,compress:!0,preset:1,preload:!0,hint:!1}},stopRaycast:!0,hdTransmission:!1}})(ol||(ol={})),(t=>{t.defaultData={id:"basic",label:"Basic",style:"None",prompt:""}})(sl||(sl={})),(t=>{t.defaultData={weather:0,shadows:0,lightOrigin:0,temperature:0,sun:0,camera:0,environment:0,particles:0,nature:0,floor:0}})(ll||(ll={})),(t=>{t.defaultData=()=>({mode:"line-art-both",prompt:"",negativePrompt:"",style:{...sl.defaultData},isRandomSeed:!0,seed:t.generateSeed(),guessMode:!1,advanced:!1,steps:20,guidanceScale:7.5,controlNetScale:1,modifiers:ll.defaultData}),t.generateSeed=()=>Math.round(1e5*Math.random())})(hl||(hl={})),(t=>{t.physicsEnabled=function(t){return void 0!==t.find((t=>"Page"===t.data.type&&t.data.globalPhysics.usePhysics))},t.traverseModuleInstances=function(t,e,r){t.scene.objects.traverseFrom(e,((e,n)=>{if("Instance"===n.type){var i;let a=null===(i=Rl.getComponentData(t,n.component))||void 0===i?void 0:i.data;a&&r(e,n,a.events)}else r(e,n,n.events)}))}})(cl||(cl={})),(t=>{function e(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{withLight:!0,withSquare:!0},e=[],r=nl.defaultMeshObject;!0===t.withLight&&e.push({fi:-1,data:$s.defaultDirectionalLightData,id:"830a2708-8ed9-49cf-a68e-085299899103",children:[]}),!0===t.withSquare&&e.push({fi:1,id:"7ba78968-2a55-48f2-b14c-5191da3e075e",data:r,children:[]});let n=new zi;return n.push({fi:1,id:ls,data:{...rl.defaultData,name:"Scene 1"},children:e}),n}function r(e){return{...t.defaultData,objects:E(e,zi.prototype)}}t.TRASH_CAN_ID="830a2708-8ed9-49cf-a68e-085299892222",t.defaultData={objects:e(),publish:ol.defaultData,styles:hl.defaultData()},t.emptyDataWithoutPage=function(){return{objects:new zi,publish:ol.defaultData,styles:hl.defaultData()}},t.emptyDataWithPage=function(t){return{objects:e(t),publish:ol.defaultData,styles:hl.defaultData()}},t.withObjs=r,t.withObj=function(t,e){return r([{id:t,data:e,children:[],fi:0}])}})(ul||(ul={})),(t=>{t.defaultData={preset:"fullscreen",allowResponsive:!1,size:[512,512],coords:[0,0],sceneScale:1,color:{r:0,g:0,b:0,a:.5}}})(dl||(dl={})),(t=>{t.emptyImage={data:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVQYV2NgYAAAAAMAAWgmWQ0AAAAASUVORK5CYII=",name:"empty"}})(pl||(pl={})),(t=>{function e(t){return void 0!==t.textValue}function r(t){return"boolean"==typeof t}t.isTextValue=e,t.isNumber=function(t){return"number"==typeof t},t.isBoolean=r,t.typeOfVariable=function(t){return e(t)?"string":r(t)?"boolean":"number"},t.getDisplayedValue=function(e){var r;return t.isTextValue(e)?Array.isArray(e.textValue)?e.textValue.map((t=>{var r;return t.toString().padStart(null!==(r=e.padding)&&void 0!==r?r:2,"0")})).join(null!==(r=e.deliminator)&&void 0!==r?r:":")+(void 0!==e.suffix?" "+e.suffix:""):e.textValue.toString():t.isBoolean(e)?e?"True":"False":t.isNumber(e)?parseFloat(e.toFixed(3)).toString():e.toString()}})(fl||(fl={})),(t=>{t.all=["images","videos","colors","audios","fonts","materials","variables"]})(ml||(ml={})),(t=>{t.all=[...ml.all,"components"]})(vl||(vl={})),(t=>{t.defaultData=function(){return{images:new _i,videos:new _i,colors:new _i,audios:new _i,fonts:new _i,materials:new _i,components:new _i,variables:new _i}}})(gl||(gl={})),(t=>{t.defaultData=function(){return{images:new _i,videos:new _i,colors:new _i,audios:new _i,fonts:new _i,materials:new _i,components:new _i,variables:new _i}}})(yl||(yl={})),(t=>{t.defaultColors=function(){let t={"89b10010-844c-11ec-a8a3-0242ac120002":{r:.5,g:.5,b:.5,a:1,name:"Default Color"}};return E(t,_i.prototype)},t.defaultImages=function(t){let e={};return null!==t&&void 0!==t&&t.withAITexture&&(e["a1b10010-844c-a8a3-11ec-0242ac2011ec"]={...pl.emptyImage,name:"AI generated image"}),E(e,_i.prototype)},t.emptyData=function(){return{catelogs:new _i,materials:new _i,images:new _i,videos:new _i,colors:new _i,audios:new _i,fonts:new _i,variables:new Ei,lib:yl.defaultData()}},t.defaultVariables=function(t){switch(t){case"number":return{value:0,name:"Number"};case"boolean":return{value:!1,name:"Boolean"};case"string":return{value:{textValue:"String value"},name:"String"};case"time":let e=[0,0,0];return{name:"Time",value:{textValue:e,deliminator:":",padding:2,suffix:"AM"},dynamicVariableType:"time",format:"HH:mm:ss",format12h24h:"12ampm",timeZone:null,hasEnd:!1,endValue:{textValue:e,deliminator:":",padding:2,suffix:"AM"},autoStart:!0,repeat:!1};case"counter":return{name:"Counter",value:0,dynamicVariableType:"counter",updateInterval:1e3,increment:1,autoStart:!0,hasEnd:!0,endValue:60,repeat:!0,randomStart:!1,range:[0,100],decimals:0};case"random":return{name:"Random",value:0,dynamicVariableType:"random",updateInterval:1e3,increment:1,autoStart:!0,isStatic:!1,hasEnd:!0,endValue:60,repeat:!0,min:0,max:100,decimals:0};default:console.error("Unknown variable type",t)}},t.getFormattedTimerTime=function(t,e){if("HH:mm:ss"===e.format){let e=Math.floor(t/3600),r=Math.floor((t-3600*e)/60);return{textValue:[e,r,Math.round(t-3600*e-60*r)]}}if("mm:ss"===e.format){let e=Math.floor(t/60);return{textValue:[e,Math.round(t-60*e)]}}return t="number"===e.format?Math.round(t):Math.round(1e3*t)/1e3}})(bl||(bl={})),(t=>{t.list=["idle","move","jump","run"]})(xl||(xl={})),(t=>{t.defaultColliderData={type:"capsule",height:200,radius:50,position:[0,0,0],rotation:[0,0,0]},t.defaultDataThirdPerson={moveMode:"walk",forwardDirection:"+z",speedTranslate:1e3,speedRotate:100,runMultiplier:2,rotationMode:"normal",rotBy:"keys",rotByTouch:"drag",delayPos:[.3,.3],delayRot:[.3,.3],keyAssignments:[["moveNegZ","W"],["moveNegX","A"],["movePosZ","S"],["movePosX","D"],["rotPosX","\u25b2"],["rotPosY","\u25c0"],["rotNegX","\u25bc"],["rotNegY","\u25b6"],["jump","Space"],["run","\u21e7"],["none","Ctrl"]],touchControl:!0,joystickPosLoc:5,joystickRotLoc:11,jumpTouchButtonLoc:9,collider:t.defaultColliderData,colliderHelperVisible:!0,collisionEnabled:!0,jumpPower:100,resetYPosition:3e3,alignToGround:!1,autoOrientMove:!0,orientWith:"camera",orientMode:"radial",delayPosCamera:.3,delayRotCamera:.3,camera:"",cameraXAxis:"Limit",cameraYAxis:"Free",cameraRotXLimits:[0,Math.PI/2],cameraRotYLimits:[-Math.PI/2,Math.PI/2],gameActions:{idle:new Ei,move:new Ei,jump:new Ei,run:new Ei},navmesh:{enabled:!1,ch:6,cs:6,walkableClimb:5,walkableHeight:1,walkableRadius:0,zones:"all",objects:[],helperVisible:!0,destinationHelperRadius:0,destinationHelperColor:Ko.fromHexAndA(3728051,1)}}})(wl||(wl={}));var Ul=180/Math.PI;function jl(t){t.rotation=t.rotation.slice(0,3).map((t=>t*Ul))}function Nl(t){var e,r,n;jl(t),"Page"===t.type&&jl(t.camera),null===(e=t.states)||void 0===e||e.forEach((t=>{void 0===t.rotation||null===t.rotation||(t.rotation=t.rotation.slice(0,3).map((t=>t*Ul)))}));let i=t.geometry;i&&"SphereGeometry"===i.type&&(i.thetaLength=(null!==(r=i.thetaLength)&&void 0!==r?r:180)*Ul),i&&"TorusGeometry"===i.type&&(i.arc=i.arc*Ul),i&&"PathGeometry"===i.type&&(i.extrusion.angle*=Ul,i.extrusion.twist*=Ul),"Mesh"===t.type&&"TextGeometry"===t.geometry.type&&(t.geometry.text={textValue:t.geometry.text}),Array.isArray(ua(t.events))&&(null===(n=t.events)||void 0===n||n.forEach((t=>{("MouseDown"===t.type||"MouseUp"===t.type||"MousePress"===t.type||"KeyDown"===t.type||"KeyUp"===t.type||"KeyPress"===t.type||"Collision"===t.type||"Trigger"===t.type)&&(t.runMode=t.toggle?"Toggle":"Once")})))}var Rl,Fl=107;function Gl(t,e){e(t.data);for(let r of t.children)Gl(r,e)}function ql(t){var e;let r=null!==(e=t.schema)&&void 0!==e?e:104;r!==Fl&&r<105&&(Gl(t.asset,Nl),t.schema=105)}function Hl(t){var e;let r=null!==(e=t.schema)&&void 0!==e?e:0;if(r!==Fl){console.warn("updating from ",r,"to ",Fl),kl(t,r),r<100&&(void 0===t.scene.publish.joystickSizeAndXYOffset&&(t.scene.publish.joystickSizeAndXYOffset=ol.defaultData.joystickSizeAndXYOffset),t.schema=100),r<101&&(Cl(t,Vl),Ml(t,Vl),t.schema=101),r<102&&(function(t){t.scene.objects.traverse(((t,e)=>{let r=e.geometry;r&&"PathGeometry"===r.type&&(r.extrusion.capType="flat",r.extrusion.bevel=50,r.extrusion.bevelSides=6,"Custom"===r.extrusion.shape.type&&(r.extrusion.shape.shapeQuality="low"))}))}(t),t.schema=102),r<104&&(t.shared.catelogs=new _i,t.shared.lib=yl.defaultData(),t.schema=104),r<105&&(function(t){t.shared.variables=E({},_i.prototype)}(t),t.scene.objects.traverse(((t,e)=>{Nl(e)})),t.schema=105);for(let e of Object.values(t.shared.lib.components))ql(e);r<106&&(function(t){let e=ua(t.shared.variables);t.shared.variables=E(Object.entries(null!==e&&void 0!==e?e:{}).map(((t,e)=>{let[r,n]=t;return{fi:e,id:r,data:n}})),Ei.prototype)}(t),t.schema=106),r<107&&(t.shared.lib.variables=yl.defaultData().variables,t.schema=107)}}(t=>{t.defaultData={schema:Fl,scene:ul.defaultData,frames:(new _i).add("72fc2993-2da3-4b6b-96ac-2879db3a28bd",dl.defaultData),shared:{...bl.emptyData(),colors:bl.defaultColors()}},t.emptyDataForImports=function(t){let e=ul.emptyDataWithPage(t);return{schema:Fl,scene:e,frames:(new _i).add("72fc2993-2da3-4b6b-96ac-2879db3a28bd",dl.defaultData),shared:{...bl.emptyData(),colors:bl.defaultColors(),images:bl.defaultImages(t)}}},t.emptyData=function(){return{schema:Fl,scene:ul.emptyDataWithPage(),frames:(new _i).add("72fc2993-2da3-4b6b-96ac-2879db3a28bd",dl.defaultData),shared:bl.emptyData()}},t.collabHelper={...Ui,updateSchema(t){var e,r;return(null!==(e=t.schema)&&void 0!==e?e:0)<Fl?ca(t,Hl):(null!==(r=t.schema)&&void 0!==r?r:0)-Fl}},t.updateSchemaDirectly=function(e){let r=t.collabHelper.updateSchema(e);return"number"==typeof r?0===r?e:null:r.data},t.withoutLib=function(t){return{...t,shared:{...t.shared,lib:yl.defaultData()}}},t.getComponentData=function(t,e){let r=t.scene.objects.get(e);if(r&&"Component"===r.data.type)return r;{let r=t.shared.lib.components[e];if(r)return r.asset}}})(Rl||(Rl={}));var Wl=v(y()),Xl=.5*(Math.sqrt(3)-1),Yl=(3-Math.sqrt(3))/6,Ql=1/3,Zl=1/6,Kl=(Math.sqrt(5),Math.sqrt(5),t=>0|Math.floor(t)),Jl=new Float64Array([1,1,-1,1,1,-1,-1,-1,1,0,-1,0,1,0,-1,0,0,1,0,-1,0,1,0,-1]),$l=new Float64Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]);function th(){let t=eh(arguments.length>0&&void 0!==arguments[0]?arguments[0]:Math.random),e=new Float64Array(t).map((t=>Jl[t%12*2])),r=new Float64Array(t).map((t=>Jl[t%12*2+1]));return function(n,i){let a,o,s=0,l=0,h=0,c=(n+i)*Xl,u=Kl(n+c),d=Kl(i+c),p=(u+d)*Yl,f=n-(u-p),m=i-(d-p);f>m?(a=1,o=0):(a=0,o=1);let v=f-a+Yl,g=m-o+Yl,y=f-1+2*Yl,b=m-1+2*Yl,x=255&u,w=255&d,_=.5-f*f-m*m;if(_>=0){let n=x+t[w];_*=_,s=_*_*(e[n]*f+r[n]*m)}let S=.5-v*v-g*g;if(S>=0){let n=x+a+t[w+o];S*=S,l=S*S*(e[n]*v+r[n]*g)}let A=.5-y*y-b*b;if(A>=0){let n=x+1+t[w+1];A*=A,h=A*A*(e[n]*y+r[n]*b)}return 70*(s+l+h)}}function eh(t){let e=new Uint8Array(512);for(let r=0;r<256;r++)e[r]=r;for(let r=0;r<255;r++){let n=r+~~(t()*(256-r)),i=e[r];e[r]=e[n],e[n]=i}for(let r=256;r<512;r++)e[r]=e[r-256];return e}var rh,nh=new n.Triangle,ih=class{constructor(t){this.weightAttribute=null;let e=t.geometry;if(!e.isBufferGeometry||3!==e.attributes.position.itemSize)throw new Error("THREE.MeshSurfaceSampler: Requires BufferGeometry triangle mesh.");e.index&&(e=e.toNonIndexed()),this.geometry=e,this.randomFunction=Math.random,this.positionAttribute=this.geometry.getAttribute("position"),this.distribution=null}build(){let t=this.positionAttribute,e=new Float32Array(t.count/3);for(let n=0;n<t.count;n+=3){let r=1;nh.a.fromBufferAttribute(t,n),nh.b.fromBufferAttribute(t,n+1),nh.c.fromBufferAttribute(t,n+2),r*=nh.getArea(),e[n/3]=r}this.distribution=new Float32Array(t.count/3);let r=0;for(let n=0;n<e.length;n++)r+=e[n],this.distribution[n]=r;return this}setRandomGenerator(t){return this.randomFunction=t,this}sample(t,e){if(this.distribution){let r=this.distribution[this.distribution.length-1],n=this.binarySearch(this.randomFunction()*r);return this.sampleFace(n,t,e)}}binarySearch(t){if(!this.distribution)return 0;let e=this.distribution,r=0,n=e.length-1,i=-1;for(;r<=n;){let a=Math.ceil((r+n)/2);if(0===a||e[a-1]<=t&&e[a]>t){i=a;break}t<e[a]?n=a-1:r=a+1}return i}sampleFace(t,e,r){let n=this.randomFunction(),i=this.randomFunction();return n+i>1&&(n=1-n,i=1-i),nh.a.fromBufferAttribute(this.positionAttribute,3*t),nh.b.fromBufferAttribute(this.positionAttribute,3*t+1),nh.c.fromBufferAttribute(this.positionAttribute,3*t+2),e.set(0,0,0).addScaledVector(nh.a,n).addScaledVector(nh.b,i).addScaledVector(nh.c,1-(n+i)),nh.getNormal(r),this}},ah=v(b()),oh=new n.Matrix4,sh=new n.Matrix4,lh=new n.Matrix4;(t=>{t.is=function(t){return t&&t.__isSPEObject}})(rh||(rh={}));var hh,ch=t=>class extends t{constructor(){super(...arguments),this.previousModelViewMatrix=new n.Matrix4,this.copyPreviousMatrix=!0,this.hiddenMatrix=new n.Matrix4,this.matrixWorldRigid=new n.Matrix4,this.shearScale=new n.Matrix4,this.shearScaleInv=new n.Matrix4}get __isSPEObject(){return!0}isDescendantOf(t){t instanceof n.Object3D&&(t=t.uuid);let e=this;for(;e.parent;){if(e.parent.uuid===t)return!0;e=e.parent}return!1}updateMatrixWorld(t){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||t)&&(null===this.parent?this.matrixWorld.multiplyMatrices(this.hiddenMatrix,this.matrix):(this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.hiddenMatrix),this.matrixWorld.multiplyMatrices(this.matrixWorld,this.matrix)),this.matrixWorldNeedsUpdate=!1,t=!0);for(let e of this.children)e.updateMatrixWorld(t)}updateWorldMatrix(t,e){let r=this.parent;if(t&&null!==r&&r.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),null===this.parent?this.matrixWorld.multiplyMatrices(this.hiddenMatrix,this.matrix):(this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.hiddenMatrix),this.matrixWorld.multiplyMatrices(this.matrixWorld,this.matrix)),e)for(let n of this.children)n.updateWorldMatrix(!1,!0)}traverseChildren(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;for(let r of this.children)rh.is(r)&&r.traverseObject(t,e+1)}traverseObject(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!0!==t(this,e))for(let r of this.children)rh.is(r)&&r.traverseObject(t,e+1)}updateMatrixWorldSVD(){let t=this.matrixWorld.elements,e=[[t[0],t[4],t[8]],[t[1],t[5],t[9]],[t[2],t[6],t[10]]],{u:r,v:n,q:i}=(0,ah.SVD)(e),a=oh.set(r[0][0],r[0][1],r[0][2],0,r[1][0],r[1][1],r[1][2],0,r[2][0],r[2][1],r[2][2],0,0,0,0,1),o=sh.set(n[0][0],n[0][1],n[0][2],0,n[1][0],n[1][1],n[1][2],0,n[2][0],n[2][1],n[2][2],0,0,0,0,1),s=lh.copy(o).transpose();this.shearScale.makeScale(i[0],i[1],i[2]).multiply(s).premultiply(o),this.shearScaleInv.copy(this.shearScale).invert(),this.matrixWorldRigid.multiplyMatrices(a,s).copyPosition(this.matrixWorld),i.every((t=>Math.abs(i[0]-t)<.01))?this.hasNonUniformScale=!1:this.hasNonUniformScale=!0}attach(t,e){this.updateWorldMatrix(!0,!1);let r=(new n.Matrix4).copy(this.matrixWorld).invert();return null!==t.parent&&(t.parent.updateWorldMatrix(!0,!1),r.multiply(t.parent.matrixWorld)),"hiddenMatrix"in t&&t.hiddenMatrix instanceof n.Matrix4?t.hiddenMatrix.premultiply(r):t.applyMatrix4(r),t.updateWorldMatrix(!1,!1),this.add(t),void 0!==e&&(this.children.pop(),this.children.splice(e,0,t)),this}copy(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return super.copy(t,e),this.hasNonUniformScale=t.hasNonUniformScale,this}onAfterRender(t,e,r,n,i,a){this.copyPreviousMatrix&&this.previousModelViewMatrix.copy(this.modelViewMatrix)}},uh=class extends(ch(n.Object3D)){},dh=class extends uh{constructor(t){super(),this.object=t,this.matrixAutoUpdate=!1,this.hasNonUniformScale=t.hasNonUniformScale}raycast(t,e){}expand(){let t=0,e=this.object.entityChildren(t);for(;e;){var r;let n=this.children[t];(null===(r=n)||void 0===r?void 0:r.object)!==e&&(n&&this.remove(n),n=new dh(e),this.add(n),this.children.splice(t,0,this.children.pop()),n.matrixWorldNeedsUpdate=!0,n.matrixAutoUpdate=!1,n.matrix=e.matrix,n.hiddenMatrix=e.hiddenMatrix),n.expand(),t+=1,e=this.object.entityChildren(t)}for(;this.children.length>t;)this.remove(this.children[t])}get visible(){var t;return void 0!==this.playModeVisible?this.playModeVisible:this.object.visible||this.object.dataPatched.visible&&!0===(null===(t=this.object.dataPatched.cloner)||void 0===t?void 0:t.hideBase)}set visible(t){}get castShadow(){return this.object.castShadow}set castShadow(t){}get receiveShadow(){return this.object.receiveShadow}set receiveShadow(t){}get isMesh(){return"Mesh"===this.object.type}get isLight(){return this.object.isLight}get layers(){return this.object.layers}set layers(t){}get isCamera(){return!1}get geometry(){if(this.object.geometry)return this.object.geometry}get material(){if(this.object.material)return this.object.material}},ph=new n.Vector3,fh=new n.Vector3,mh=new n.Matrix4,vh=[new n.Vector3(-1,1,1),new n.Vector3(-1,-1,1),new n.Vector3(1,-1,1),new n.Vector3(1,1,1),new n.Vector3(-1,1,-1),new n.Vector3(-1,-1,-1),new n.Vector3(1,-1,-1),new n.Vector3(1,1,-1)],gh=[[0,3],[1,2],[5,6],[4,7],[0,1],[3,2],[7,6],[4,5],[0,4],[1,5],[2,6],[3,7]],yh=[[0,2],[7,5],[4,1],[3,6],[4,3],[1,6]],bh=(t,e,r)=>{t.updateEntityBoxSize(ph,fh),mh.copy(e).multiply(t.matrixWorld),0===fh.x&&0===fh.y&&0===fh.z?r.push(new n.Vector3(ph.x,ph.y,ph.z).applyMatrix4(mh)):vh.forEach((t=>{r.push(t.clone().multiply(fh).add(ph).applyMatrix4(mh))}))},xh=class extends n.Box3{constructor(){super(...arguments),this.matrix=new n.Matrix4,this.vertices=[],this.faces=[],this.edges=[],this.centerEdges=[]}copy(t){return super.copy(t),this.matrix.copy(t.matrix),this.vertices=t.vertices.map((t=>t.clone())),this.faces=t.faces.map((t=>t.clone())),this.edges=t.edges.map((t=>t.clone())),this.centerEdges=t.centerEdges.map((t=>t.clone())),this}setFromObjectSize(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];t.updateWorldMatrix(!1,e),this.makeEmpty(),this.matrix.copy(t.matrixWorld);let r=(new n.Matrix4).copy(t.matrixWorld).invert();return this.expandByObjectSize(t,r,e)}expandByObjectSize(t,e){let r=[];return!0===(arguments.length>2&&void 0!==arguments[2]&&arguments[2])?t.traverseEntity((t=>{if(t.visible||t.cloner&&t.data.visible){if(!("geometry"in t))return void r.push(new n.Vector3);bh(t,e,r)}})):bh(t,e,r),this.setFromPoints(r)}getCenter(t){return(t=super.getCenter(t)).applyMatrix4(this.matrix),t}getPositionToCenter(t){return(t=super.getCenter(t)).applyMatrix4(mh.copy(this.matrix).setPosition(0,0,0)),t}computeVertices(){this.getSize(fh).multiplyScalar(.5),this.getCenter(ph),mh.copy(this.matrix).setPosition(ph),this.vertices=vh.map((t=>t.clone().multiply(fh).applyMatrix4(mh)))}computeEdges(){this.vertices.length>0&&this.computeVertices(),this.edges=gh.map((t=>{let[e,r]=t;return new n.Line3(this.vertices[e],this.vertices[r])})),this.centerEdges=this.edges.map((t=>t.getCenter(new n.Vector3)))}computeFaces(){this.vertices.length>0&&this.computeVertices(),this.faces=yh.map((t=>{let[e,r]=t;return this.vertices[e].clone().add(this.vertices[r]).multiplyScalar(.5)}))}},wh={Cloner:()=>{},changeEntityProptotype:()=>{},createEntity:()=>{}},_h=class extends n.CurvePath{constructor(){super()}getPoints(){let t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:12,r=[],n=this.getCurveLengths(),i=n[n.length-1]/n.length;for(let a=0,o=this.curves;a<o.length;a++){let s=o[a],l=0===a?n[a]:n[a]-n[a-1],h=Math.ceil(e*l/i),c=s.getPoints(h);for(let e=0;e<c.length;e++){let n=c[e];t&&t.equals(n)||(r.push(n),t=n)}}return this.autoClose&&r.length>1&&!r[r.length-1].equals(r[0])&&r.push(r[0]),r}},Sh=.001;function Ah(t,e,r){return e.clone().sub(t).cross(e.clone().sub(r)).length()<=Sh}function Mh(t,e){let r=new n.Vector3(...t.position),i=new n.Vector3(...t.controlNext.position),a=new n.Vector3(...e.controlPrevious.position),o=new n.Vector3(...e.position);return Ah(r,i,o)&&Ah(r,a,o)}function Ch(t){let e=t.points.map((t=>new n.Vector3(...t.data.position))),r=[t.points[0]],i=new n.Vector3(...r[0].data.position);for(let n=0;n<t.points.length-1;n++)Ah(i,e[n],e[n+1])||(r.push(t.points[n]),i=e[n]);r.push(t.points[t.points.length-1]);let a=t.isClosed,o=r.length-(a?0:1),s=r.length,l=[];for(let u=0;u<s;u++){let e=r[u].data,i=new n.Vector3(...e.position),o=new n.Vector3(...e.controlPrevious.position),h=new n.Vector3(...e.controlNext.position),c={position:i,baseRoundness:e.roundness,controlPrevious:o,controlNext:h};if(0===e.roundness||!t.isClosed&&(0===u||u===s-1)){l[u]={...c,removedLength:0};continue}let d=a&&u==s-1?0:u+1,p=r[a&&0==u?s-1:u-1].data,f=r[d].data,m=new n.Vector3(...p.position),v=new n.Vector3(...f.position),g=m.clone().sub(i).normalize(),y=v.clone().sub(i).normalize();Object.assign(c,{prevDir:g,nextDir:y});let b=Mh(p,e),x=Mh(e,f);if(b&&x){let t=g.clone().add(y).normalize(),r=t.clone().cross(g).length()/g.dot(t);l[u]={...c,tan:r,removedLength:e.roundness/r}}else l[u]={...c,removedLength:0}}for(let n=0;n<o;n++){let t=a&&n===s-1?0:n+1,e=l[n],r=l[t];if(0!==e.removedLength||0!==r.removedLength){let t=e.position.distanceTo(r.position);e.removedLength=Math.min(e.removedLength,t/2),r.removedLength=Math.min(r.removedLength,t/2)}}let h=[];for(let u=0;u<o;u++){let t=u,e=a&&u===s-1?0:u+1,i=l[t],o=l[e],c=null;if(Mh(r[t].data,r[e].data)){let t=i.position.clone(),e=o.position.clone();(0!==i.removedLength||0!==o.removedLength)&&(i.nextDir&&t.add(i.nextDir.clone().setLength(i.removedLength)),o.prevDir&&e.add(o.prevDir.clone().setLength(o.removedLength))),t.distanceTo(e)>Sh&&(c=new n.CubicBezierCurve3(t,t.clone().lerp(e,.3),e.clone().lerp(t,.3),e))}else i.position.distanceTo(o.position)>Sh&&(c=new n.CubicBezierCurve3(i.position,i.controlNext,o.controlPrevious,o.position));h[2*u+1]=c}for(let u=0;u<s;u++){let t=l[u];if(0===t.removedLength){h[2*u]=null;continue}let e=t.position,r=t.prevDir.clone().multiplyScalar(t.removedLength).add(e),i=t.nextDir.clone().multiplyScalar(t.removedLength).add(e),a=t.tan*t.removedLength,o=t.prevDir.clone().add(t.nextDir).normalize(),s=r.clone().lerp(i,.5),c=r.distanceTo(i)/2,d=o.clone().multiplyScalar(Math.sqrt(Math.pow(a,2)-Math.pow(c,2))).add(s),p=o.clone().multiplyScalar(-a).add(d),f=e.distanceTo(p)/e.distanceTo(s),m=t.prevDir.clone().multiplyScalar(f*e.distanceTo(r)).add(e),v=m.clone().lerp(p,2),g=r.clone().lerp(m,4/3),y=i.clone().lerp(v,4/3);h[2*u]=new n.CubicBezierCurve3(r,g,y,i)}let c=new _h;return h.forEach((t=>{t&&c.add(t)})),c}(t=>{t.is=function(t){return t&&t.__isEntity}})(hh||(hh={}));var Oh=t=>hh.is(t),Dh={type:"completeState",isfromEntity:!0},Ph=["x","y","z"],Th=new n.Vector3,zh=(new n.Vector3).set(0,1,0),Eh=t=>class extends(ch(t)){constructor(){super(...arguments),this.raycastLock=!1,this.scaleLock=!1,this.disposed=!1,this.stateSelection=null,this.destroyedInAction=!1,this.instances=[],this.prevState=null,this.currentState=null,this.reversibleToState=null,this.currentTransitionEvent=null,this.previousAction=null,this._singleBBox=new xh,this._recursiveBBox=new xh,this.singleBBoxNeedsUpdate=!0,this.recursiveBBoxNeedsUpdate=!0,this._needApplyPathSnapping=!0,this.attachedPaths=new Set}get __isEntity(){return!0}entityChildren(t){let e=this.children[t];if(hh.is(e))return e}entityChildrenCount(){let t=this.children.length;for(;t--;)if(hh.is(this.children[t]))return t+1;return 0}get isConcreteEntity(){return"string"==typeof this.identity}get isVirtualEntity(){return"string"!=typeof this.identity}get isInstanceRoot(){return this.isConcreteEntity&&"Instance"===this.data.type}nearestInstanceSelfOrParent(){let t=this;for(;"Instance"!==t.data.type;){let e=t.parent;if(!hh.is(e))return;t=e}return t}forInstancesRec(t){this.instances.forEach((e=>{e.disposed||t(e),e.forInstancesRec(t)}))}super_Entity(t,e){"string"==typeof t&&(this.uuid=t),this.identity=t,this.data=e,this.matrixAutoUpdate=!1,this.dataPatched=this.data}changeSelectedState(t,e){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(0!==this.data.states.length||r){for(let t of this.data.states)il.toOps(this.data,t.data).forEach((t=>{let r=ki.replaceProps(t,this.data);this.dataPatched=this.data,this.updateByPatchedOp(r,this.data,e)}));if(null!==t){let r=this.data.states.data(t);r&&(this.dataPatched=il.patch(this.data,r),il.toOps(this.data,r).forEach((t=>{this.updateByPatchedOp(t,this.dataPatched,e)})))}r&&this.updateTransformState(this.dataPatched,e),this.stateSelection=t,this.updatePathSnapping(this.dataPatched.pathSnapping)}}get singleBBox(){return this.singleBBoxNeedsUpdate&&(this.singleBBoxNeedsUpdate=!1,this._singleBBox.setFromObjectSize(this,!1),this._singleBBox.computeVertices(),this._singleBBox.computeEdges(),this._singleBBox.computeFaces()),this._singleBBox}get recursiveBBox(){return this.recursiveBBoxNeedsUpdate&&(this.recursiveBBoxNeedsUpdate=!1,this._recursiveBBox.setFromObjectSize(this,!0),this._recursiveBBox.computeVertices(),this._recursiveBBox.computeEdges(),this._recursiveBBox.computeFaces()),this._recursiveBBox}updateEntityBoxSize(t,e){t.setScalar(0),e.setScalar(0)}resetBBoxNeedsUpdateSelf(){this.singleBBoxNeedsUpdate=!0,this.recursiveBBoxNeedsUpdate=!0}resetBBoxNeedsUpdate(){this.resetBBoxNeedsUpdateSelf(),this.traverseAncestors((t=>{Oh(t)&&t.resetBBoxNeedsUpdateSelf()})),this.traverseEntity((t=>{t.resetBBoxNeedsUpdateSelf()}))}find(t){let e;return this.traverseEntity((r=>{r.uuid===t&&(e=r)})),e}traverseSortNextHelper(){let t=this.parent;if(t){let e=t.children,r=e.indexOf(this)+1;if(hh.is(e[r]))return e[r];if(hh.is(t))return t.traverseSortNextHelper()}}sortNext(){let t=this.children;return this.children.length>0&&hh.is(this.children[0])?t[0]:this.traverseSortNextHelper()}goUp(t){let e=this;for(;t>0&&null!==e;)e=e.parent,t-=1;return e}hasAnccestorOrSelf(t){return this===t||this.hasAnccestor(t)}hasAnccestor(t){let e=this.parent;for(;e;){if(t===e)return!0;e=e.parent}return!1}countToAccestor(t){let e=0,r=this;for(;r!==t;){if(null===r)return-1;r=r.parent,e+=1}return e}forEachEntity(t){for(let e of this.children)Oh(e)&&t(e)}traverseEntityAncestors(t){this.traverseAncestors((e=>{hh.is(e)&&t(e)}))}traverseConcreteEntity(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!0!==t(this,e))for(let r of this.children)Oh(r)&&r.isConcreteEntity&&r.traverseEntity(t,e+1)}traverseEntity(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!0!==t(this,e))for(let r of this.children)Oh(r)&&r.traverseEntity(t,e+1)}traverseVisibleEntity(t){t(this);for(let e of this.children)Oh(e)&&e.visible&&e.traverseVisibleEntity(t)}updateMatrix(){super.updateMatrix(),this.cloner&&this.cloner.onObjUpdateMatrix(),this.dispatchEvent({type:"updateMatrix"})}updateMatrixWorld(t){super.updateMatrixWorld(t),this.dispatchEvent({type:"updateMatrixWorld"})}copy(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return super.copy(t,e),this.dataPatched=t.dataPatched,this.raycastLock=t.raycastLock,this.scaleLock=t.scaleLock,this.hiddenMatrix.copy(t.hiddenMatrix),this}hasEntityChild(){return this.children.some((t=>Oh(t)))}isAncestorOf(t){if(this.uuid===t)return!1;let e=!1;return this.traverseEntity((r=>{r.uuid===t&&(e=!0)})),e}toObjectTransformState(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];this.updateWorldMatrix(!0,!1);let e={position:this.position.toArray(),rotation:[this.rotation.x*n.MathUtils.RAD2DEG,this.rotation.y*n.MathUtils.RAD2DEG,this.rotation.z*n.MathUtils.RAD2DEG],scale:this.scale.toArray(),hiddenMatrix:this.hiddenMatrix.toArray()};return vi(e,t)}getTransformValues(t,e,r){return e[t].map(((e,n)=>{var i;return null!==(i=null===r||void 0===r?void 0:r.shared.getVariable(e,[this.uuid,t,Ph[n]]))&&void 0!==i?i:e}))}updateTransformState(t,e){var r;let i=!1;return t.position&&(this.position.fromArray(this.getTransformValues("position",t,e)),i=!0),t.rotation&&(Th.fromArray(this.getTransformValues("rotation",t,e)).multiplyScalar(n.MathUtils.DEG2RAD),this.rotation.setFromVector3(Th),i=!0),t.scale&&(this.scale.fromArray(this.getTransformValues("scale",t,e)),i=!0),void 0!==t.hiddenMatrix&&(i=!0,this.hiddenMatrix.fromArray(null!==(r=t.hiddenMatrix)&&void 0!==r?r:Xo.identity)),i&&(this.updateMatrix(),this.resetBBoxNeedsUpdate(),this.invalidateClonerTransform(this),this.traverseEntityAncestors((t=>{t.invalidateClonerTransform(this)}))),t.position&&t.rotation&&t.scale&&void 0!==t.hiddenMatrix&&this.updateWorldMatrix(!1,!0),i}onVariableUpdate(){arguments.length>0&&void 0!==arguments[0]&&arguments[0]?this.resetBBoxNeedsUpdate():(this.updateMatrix(),this.resetBBoxNeedsUpdate(),this.invalidateClonerTransform(this),this.traverseEntityAncestors((t=>{t.invalidateClonerTransform(this)})))}dispose(){this.disposed=!0,this.cloner&&(this.cloner.removeFromParent(),this.cloner=void 0)}disposeChildrenRecursively(){for(let t of this.children)hh.is(t)&&t.disposeRecursively()}disposeRecursively(){this.dispose(),this.children.forEach((t=>{hh.is(t)&&t.disposeRecursively()}))}toState(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e={name:this.name,visible:this.visible,raycastLock:this.raycastLock,...this.toObjectTransformState(t)};return vi(e,t)}updateByObjUpdateOp(t,e){void 0!==t&&this.updateByOp({type:0,props:t,path:[]},{...this.data,...t},e,!1)}updateByOp(t,e,r,n){let i=this.data;this.data=e;let a=t,o=da(t.path,["states","*"]);if(null!==o){if(0===t.type){let[e]=o;if((null===this||void 0===this?void 0:this.stateSelection)===e){let e={...t.props};if(delete e.name,Object.values(t.props).some((t=>void 0===t))){let r=this.data;if(void 0!==r){let n=oa.zoom(r,t.path.slice(2));if(n)for(let r in t.props)void 0===t.props[r]&&r in n&&(e[r]=n[r])}}a={...t,props:e,path:t.path.slice(2)}}}}else if(0===t.type){let e=this.stateSelection?this.data.states.data(this.stateSelection):void 0;if(void 0!==e){if(void 0!==t.props.name&&e.name){let{name:t,...r}=e;e=r}if(void 0!==t.props.material&&"material"in e){let{material:t,...r}=e;e=r}let r=oa.removeOverridden(t.path,t.props,e);a={...t,props:r}}}if(this.updateByPatchedOpBase(a,il.patch(this.data,this.stateSelection?this.data.states.data(this.stateSelection):void 0),r),da(t.path,["overrides"])){let n=[],i=[...t.path];for(n.push(i[1]),i.splice(0,2);i.length>0&&"descendants"===i[0];)n.push(i[1]),i.splice(0,2);if(void 0===n[n.length-1]){if(0===t.type)for(let e of Object.keys(t.props)){n[n.length-1]=e;let i=r.scene.findInstance([this.uuid,...n]);i&&(i.overrideData=t.props[e],i.updateState(Li.apply(i.component.data,i.overrideData),r))}}else{let a=r.scene.findInstance([this.uuid,...n]);if(a){let o=oa.zoom(a.component.data,i);if(0===(t={...t,path:i}).type){let e=t.props;if(o)for(let[r,n]of Object.entries(t.props))void 0===n&&(e===t.props&&(e={...t.props}),e[r]=o[r]);t={...t,props:e}}a.overrideData=tl.resolve(e.overrides,n),a.updateByOp(t,Vi.applySimple(a.data,t),r,!1)}}}else if(this.instances.length>0){let n;if(0===t.path.length&&0===t.type){let e;for(let r of el.rootOverrideProps)r in t.props&&(void 0===e&&(e={}),e[r]=t.props[r]);e&&(n={...t,props:e})}else for(let e of el.rootOverrideProps)if(da(t.path,[e])){n=t;break}void 0!==n&&this.instances.forEach((t=>{if(t.isInstanceRoot){let e=Li.filterOp(t.overrideData,n);e&&t.updateByOp(e,Vi.applySimple(t.data,e),r,!0)}})),this.instances.forEach((n=>{if(!n.isInstanceRoot){let a=Li.filterOp(n.overrideData,t);if(a){let o;o=i===n.data&&t===a?e:Vi.applySimple(n.data,a),n.updateByOp(a,o,r,!0)}}}))}}updateByPatchedOpBase(t,e,r){if(this.dataPatched=e,0===t.path.length&&0===t.type)void 0!==t.props.type&&!ns.is(t.props.type)&&wh.changeEntityProptotype(this,e,r);else if(1===t.path.length&&"geometry"===t.path[0]&&0===t.type&&"type"in t.props){wh.changeEntityProptotype(this,e,r);for(let t of this.children)hh.is(t)&&t.updateVisible(r.scene)}this.updateByPatchedOp(t,e,r)}updateByPatchedOp(t,e,r){if(0===t.path.length&&0===t.type&&this.updateState(t.props,r),null!==da(t.path,["pathSnapping"])&&this.updatePathSnapping(e.pathSnapping),null!==da(t.path,["cloner"])){let n=Vi.drop(t,1);0===n.path.length&&0===n.type&&!0===n.props.disabled?this.setFromClonerState(null,r):this.cloner?this.cloner.updateState(e.cloner,r.scene):(this.setFromClonerState(e.cloner,r),this.expandCloner(r.scene)),this.updateVisible(r.scene)}}updatePathSnapping(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.dataPatched.pathSnapping;this._updatedPathSnapping=t,this._needApplyPathSnapping=!0}get updatedPathSnapping(){return this._updatedPathSnapping}applyPathSnapping(t){var e,r,i,a,o,s,l,h,c,u,d;let p=null!==(e=null===(r=this._updatedPathSnapping)||void 0===r?void 0:r.pathId)&&void 0!==e?e:this.dataPatched.pathSnapping.pathId,f=null!==(i=null!==(a=null===(o=this._updatedPathSnapping)||void 0===o?void 0:o.slide)&&void 0!==a?a:this.dataPatched.pathSnapping.slide)&&void 0!==i?i:0,m=null!==(s=null!==(l=null===(h=this._updatedPathSnapping)||void 0===h?void 0:h.offset)&&void 0!==l?l:this.dataPatched.pathSnapping.offset)&&void 0!==s?s:0,v=null!==(c=null===(u=this._updatedPathSnapping)||void 0===u?void 0:u.orientation)&&void 0!==c?c:this.dataPatched.pathSnapping.orientation;if(null===p)return;let g=t.find(p);if(!g||!1===this._needApplyPathSnapping)return;this._needApplyPathSnapping=!1;let y=g.data;if(y.geometry.path.points.length<=1)return;let b=Ch(y.geometry.path),x=(f+m)%1;f+m===1&&0===x&&(x=1);let w=b.getPointAt(x);if(null===w)return;let _=this.parent?null===(d=this.parent)||void 0===d?void 0:d.matrixWorld:new n.Matrix4;g.updateMatrixWorld();let S=(new n.Matrix4).multiplyMatrices(_.clone().invert(),g.matrixWorld);w.applyMatrix4(S);let A={position:w.toArray(),rotation:y.rotation};if("tangential"===v){let t=(new n.Matrix4).extractRotation(g.matrixWorld),e=b.getTangentAt(x).applyMatrix4(t).add(w),r=(new n.Matrix4).lookAt(w,e,zh),i=Th.setFromEuler((new n.Euler).setFromRotationMatrix(r)).multiplyScalar(n.MathUtils.RAD2DEG);A={...A,rotation:i.toArray()}}this.updateTransformState(A),this.traverseEntity((t=>{t._cameraType&&t.dispatchEvent(Dh)}))}updateVisible(t){var e,r;if(this.visible=this.dataPatched.visible&&(!this.dataPatched.cloner||null!==(e=this.dataPatched.cloner.disabled)&&void 0!==e&&e||!0!==(null===(r=this.dataPatched.cloner)||void 0===r?void 0:r.hideBase)),!t)return;let n=!1;this.traverseEntity((t=>{if("Splat"===t.data.type)return n=!0,!0})),n&&t.reloadSplats()}updateState_Entity(t,e){void 0!==t.name&&(this.name=t.name),void 0!==t.raycastLock&&(this.raycastLock=t.raycastLock),void 0!==t.visible&&(this.updateVisible(null===e||void 0===e?void 0:e.scene),this.resetBBoxNeedsUpdate()),e&&"cloner"in t&&void 0!==t.cloner&&(this.setFromClonerState(t.cloner,e),this.updateVisible(e.scene)),this.updateTransformState(t,e)}get attachedSurfaceCloners(){return this.children.filter((t=>t instanceof wh.Cloner&&"toObject"===t.parameters.type))}setFromClonerState(t,e){this.disposed||(null===t||t.disabled?(this.cloner&&this.cloner.removeFromParent(),this.cloner=void 0):void 0===this.cloner?(this.cloner=new wh.Cloner(this,t),e.scene.addPendingExpandCloner(this)):this.cloner.updateState(t,e.scene))}expandCloner(t){!this.disposed&&this.cloner&&this.cloner.expandClones(t)}invalidateClonerTransform(t){this.cloner&&this.cloner.invalidateTransform(t)}};function Ih(t,e,r){r.x=t.x*e.x,r.y=t.y,r.z=t.x*e.y}function Lh(t){return new n.Vector2(t.y,-t.x)}var Bh=class extends n.BufferGeometry{constructor(t,e,r,i,a,o,s,l,h,c,u,d){let p=arguments.length>12&&void 0!==arguments[12]&&arguments[12];super(),this.type="RoundedCylinderBufferGeometry",t=void 0!==t?t:1,e=void 0!==e?e:1,r=r||1,i=Math.floor(i)||8,a=Math.floor(a)||1,o=void 0!==o&&o,s=void 0!==s?s:0,l=void 0!==l?l:2*Math.PI,o&&(h=0,c=0);let f=[],m=[],v=[],g=[],y=0,b=r/2,x=new n.Vector3,w=new n.Vector3;p&&0==t&&(t=h),p&&0==e&&(e=c);let _=new n.Vector2(t,b),S=new n.Vector2(e,-b),A=null,M=null,C=null,O=null,D=_.clone().sub(S),P=0,T=0,z=0;d>0&&(P=Math.min(t,e)*(1-d),T=t-P,z=e-P);let E=_.clone();E.x-=P;let I=Math.PI-D.angle(),L=D.angle(),B=Math.tan(L/2),k=Math.tan(I/2),V=B+k,U=d?V:k,j=d?V:B;if(h=Math.min(h,(t-T)/U,D.length()/V),c=Math.min(c,(e-z)/j,D.length()/V),h>0){let t=h/B;A=_.clone().sub(new n.Vector2(t,h)),d&&(C=A.clone(),C.x-=P-V*h),_.sub(D.clone().setLength(t))}if(c>0){let t=c/k;M=S.clone().sub(new n.Vector2(t,-c)),S.add(D.clone().setLength(t)),d&&(O=M.clone(),O.x-=P-V*c,E.sub(D.clone().setLength(t)))}D=_.clone().sub(S);let N=D.length()<.5,R=[];for(let H=0;H<=i;H++){let u=[],p=H/i,f=p*l+s,b=new n.Vector2(Math.sin(f),Math.cos(f));if(O&&M?(F(u,p,b,I,c,O,-1,!0),F(u,p,b,L,c,M,-1,!1)):M?(G(u,b,M.x,0,-1),F(u,p,b,L,c,M,-1,!1)):o||G(u,b,e,z,-1),Ih(Lh(D).normalize(),b,x),!N)for(let t=0;t<=a;t++){let e=t/a;Ih(D.clone().multiplyScalar(e).add(S),b,w),m.push(w.x,w.y,w.z),v.push(x.x,x.y,x.z),g.push(p,.5+w.y/r),u.push(y++)}if(C&&A?(F(u,p,b,I,h,A,1,!1),F(u,p,b,L,h,C,1,!0)):A?(F(u,p,b,I,h,A,1,!1),G(u,b,A.x,0,1)):o||G(u,b,t,T,1),d&&!N){Ih(Lh(D).multiplyScalar(-1).normalize(),b,x);for(let t=0;t<=a;t++){let e=t/a;Ih(D.clone().multiplyScalar(-e).add(E),b,w),m.push(w.x,w.y,w.z),v.push(x.x,x.y,x.z),g.push(p,.5+w.y/r),u.push(y++)}}d&&!o&&u.push(u[0]),R.push(u)}for(let n=0;n<R.length-1;n++)for(let t=0;t<R[0].length-1;t++){if(o&&d&&t==a)continue;let e=R[n][t],r=R[n+1][t],i=R[n+1][t+1],s=R[n][t+1],l=m[3*i+0],h=m[3*i+2];f.push(e,r,s),(0!=l||0!=h)&&f.push(r,i,s)}function F(t,e,i,a,o,s,l,h){for(let c=0;c<u+1;c++){let d=c/u,p=l<0?d:1-d;h&&(p-=1),p*=a;let f=new n.Vector2(Math.sin(p),Math.cos(p)*l);Ih(f.clone().multiplyScalar(o).add(s),i,w),m.push(w.x,w.y,w.z),Ih(f,i,x),v.push(x.x,x.y,x.z),g.push(e,.5+w.y/r),t.push(y++)}}function G(t,e,r,i,a){let o=new n.Vector3,s=new n.Vector2,l=[r,i];a<0&&l.reverse();for(let n of l)s.set(n,b*a),Ih(s,e,o),m.push(o.x,o.y,o.z),v.push(0,a,0),g.push(.5,.5),t.push(y++)}function q(r,i,a){let o=new n.Vector2(Math.sin(a),Math.cos(a)),s=new n.Vector2(-Math.cos(a),Math.sin(a)),l=new n.Vector3,h=r<0?(t,e,r)=>f.push(t,e,r):(t,e,r)=>f.push(t,r,e);Ih(new n.Vector2((t+e+T+z)/4,0),o,l),m.push(l.x,l.y,l.z),v.push(s.x,0,s.y),g.push(.5,.5);let c=y++;for(let t of i){let e=m.slice(3*t,3*t+3);m.push(...e),v.push(s.x,0,s.y);let r=g.slice(2*t,2*t+2);g.push(...r),y++}for(let t=c+1;t<y-1;t++)h(c,t,t+1);h(c,y-1,c+1)}l<2*Math.PI&&(q(-1,R[0],s),q(1,R[R.length-1],s+l)),this.setIndex(f),this.setAttribute("position",new n.Float32BufferAttribute(m,3)),this.setAttribute("normal",new n.Float32BufferAttribute(v,3)),this.setAttribute("uv",new n.Float32BufferAttribute(g,2))}},kh=Math.PI/2,Vh=class extends n.BufferGeometry{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:4;super(),this.type="BoxGeometry";let h=this;i=Math.floor(i),a=Math.floor(a),o=Math.floor(o),l=Math.floor(l),s=Math.min(s,t/2,e/2,r/2);let c=[],u=[],d=[],p=[],f=0,m=0;function v(t,e,r,i,a,o,l,v,g,y,b){let x=(o-2*s)/g,w=(l-2*s)/y,_=o/2-s,S=l/2-s,A=v/2,M=g+1,C=y+1,O=0,D=0,P=new n.Vector3;for(let n=0;n<C;n++){let o=n*w-S;for(let s=0;s<M;s++){let l=s*x-_;P[t]=l*i,P[e]=o*a,P[r]=A,u.push(P.x,P.y,P.z),P[t]=0,P[e]=0,P[r]=v>0?1:-1,d.push(P.x,P.y,P.z),p.push(s/g),p.push(1-n/y),O+=1}}for(let n=0;n<y;n++)for(let t=0;t<g;t++){let e=f+t+M*n,r=f+t+M*(n+1),i=f+(t+1)+M*(n+1),a=f+(t+1)+M*n;c.push(e,r,a),c.push(r,i,a),D+=6}h.addGroup(m,D,b),m+=D,f+=O}function g(t,e,r,i,a,o,v,g,y,b,x){let w=(v-2*s)/b,_=v/2-s,S=g/2-s,A=y/2,M=b+1,C=0,O=0,D=new n.Vector3,P=new n.Vector3;for(let n=0;n<l+1;n++){let h=n/l*kh,c=Math.sin(h)*s,f=(1-Math.cos(h))*s,m=Math.sin(h),v=Math.cos(h);D[e]=(S+c)*a,D[r]=(A-f)*o,P[t]=0,P[e]=m*Math.sign(D[e]),P[r]=v*Math.sign(D[r]);for(let e=0;e<M;e++){let r=e*w-_;D[t]=r*i,u.push(D.x,D.y,D.z),d.push(P.x,P.y,P.z),p.push(e/b),p.push(0),C+=1}}for(let n=0;n<l;n++)for(let t=0;t<b;t++){let e=f+t+M*n,r=f+t+M*(n+1),i=f+(t+1)+M*(n+1),a=f+(t+1)+M*n;c.push(e,r,a),c.push(r,i,a),O+=6}h.addGroup(m,O,x),m+=O,f+=C}function y(i,a,o){let h=new n.Vector3,m=new n.Vector3(t/2,e/2,r/2);m.subScalar(s);let v=[],g=i*a*o>0?(t,e,r)=>c.push(t,e,r):(t,e,r)=>c.push(t,r,e);for(let t=0;t<=l;t++){let e=[],r=kh*(1-t/l),n=Math.cos(r),c=Math.sin(r),g=0;for(let l=0;l<=t;l++){let r=Math.cos(g),l=Math.sin(g);h.x=n*r,h.y=c,h.z=n*l;let v=m.clone().addScaledVector(h,s);u.push(i*v.x,a*v.y,o*v.z),d.push(i*h.x,a*h.y,o*h.z),p.push(0,0),e.push(f++),g+=kh/t}v.push(e)}let y=v.length-1;for(let t=0;t<y;t++){let e=v[t],r=v[t+1],n=e.length-1;g(e[0],r[1],r[0]);for(let t=1;t<=n;t++)g(e[t-1],e[t],r[t]),g(e[t],r[t+1],r[t])}}v("z","y","x",-1,-1,r,e,t,o,a,0),v("z","y","x",1,-1,r,e,-t,o,a,1),v("x","z","y",1,1,t,r,e,i,o,2),v("x","z","y",1,-1,t,r,-e,i,o,3),v("x","y","z",1,-1,t,e,r,i,a,4),v("x","y","z",-1,-1,t,e,-r,i,a,5),s>0&&(g("z","y","x",-1,-1,1,r,e,t,o,0),g("z","y","x",1,-1,-1,r,e,t,o,1),g("z","y","x",-1,1,-1,r,e,t,o,1),g("z","y","x",1,1,1,r,e,t,o,0),g("x","y","z",-1,-1,-1,t,e,r,i,0),g("x","y","z",1,-1,1,t,e,r,i,1),g("x","y","z",-1,1,1,t,e,r,i,0),g("x","y","z",1,1,-1,t,e,r,i,1),g("y","x","z",-1,-1,1,e,t,r,a,0),g("y","x","z",1,-1,-1,e,t,r,a,1),g("y","x","z",1,1,1,e,t,r,a,1),g("y","x","z",-1,1,-1,e,t,r,a,0),y(1,1,1),y(-1,1,1),y(1,-1,1),y(-1,-1,1),y(1,1,-1),y(-1,1,-1),y(1,-1,-1),y(-1,-1,-1)),this.setIndex(c),this.setAttribute("position",new n.Float32BufferAttribute(u,3)),this.setAttribute("normal",new n.Float32BufferAttribute(d,3)),this.setAttribute("uv",new n.Float32BufferAttribute(p,2))}},Uh=class extends n.BufferGeometry{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:.2,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:4;super(),this.type="PolyhedronGeometryRound";let s=[],l=[],h=[];return function(){a=Math.min(.99999,a),0==a&&(o=0);let l={IcosahedronGeometry:5,DodecahedronGeometry:3,HexahedronGeometry:3,OctahedronGeometry:4,TetrahedronGeometry:3}[r],c=new n.Vector3,u=c.clone(),d=new n.Triangle,p=a*i,f=i-p,m=o+1,v=new n.Vector3,g=(t,e)=>v.subVectors(t,e).normalize(),y=(t,e)=>Array(t).fill(void 0).map(e),b=y(t.length/3,((e,r)=>(new n.Vector3).fromArray(t,3*r).setLength(i))),x=[],w=1e6;for(let t=0;t<b.length;t++){let r,n,i,a=b[t],o=[],s=1e10,l=-1;for(;-1!=(l=e.indexOf(t,l+1));){let t=l-l%3;r=e[t+(l+1)%3],n=e[t+(l+2)%3],i=a.distanceToSquared(b[r]),s=Math.min(s,i),o.push([r,n,i])}s+=1e-6;let h=[],c=0,u=o.length;for(let e=0;e<u;e++){var _;[r,n,i]=o[c];let e=1==(null===(_=x[r])||void 0===_?void 0:_.includes(t));i<=s&&h.push(r+ +e*w),c=o.findIndex((t=>t[0]==n))}x.push(h)}let S=[];{let t,e,r=0,n=0,i=3==l;for(let a=0;a<=o;a++){t=a*(a+1)/2,e=(a+1)*(a+2)/2;for(let s=0;s<o-a;s++)[r,n]=[t+s+a+2,e+s+a+3],S.push(t,e,...i?[n,t]:[r,e],n,r),[t,e]=[r,n];S.push(t,e,t+o+2)}}let A=c.clone(),M=c.clone(),C=c.clone(),O=c.clone(),D=c.clone(),P=[],T=y(b.length,(()=>y(l,(()=>c.clone()))));for(let t=0;t<b.length;t++){c.copy(b[t]).normalize(),A.copy(c).multiplyScalar(f);let e=x[t];for(let n=0;n<e.length;n++){let r=e[n],i=e[(n+1)%l];d.setFromPointsAndIndices(b,t,r%w,i%w),d.b.sub(d.a).setLength(1e10).add(d.a),d.c.sub(d.a).setLength(1e10).add(d.a),d.closestPointToPoint(A,T[t][n])}let r=[],i=[],a=[],y=new n.Vector3;0==o&&[...T[t]].reduce(((t,e)=>t.add(e)),y).multiplyScalar(1/l);for(let n=0;n<l;n++){let e=[],s=(n-1+l)%l,h=T[t][s],d=T[t][n];c.copy(h).sub(A),u.copy(d).sub(A);let b=A.angleTo(c),x=c.angleTo(u),w=Math.cos(b)*p;0==o?M.copy(y):M.copy(A).setLength(f+w),i.push(w);let _=[M,h,d];for(let t=0;t<2;t++){let n=_[t],i=_[t+1];O.subVectors(n,A),D.subVectors(i,A),C.crossVectors(O,D).normalize();for(let a=0;a<m;a++){let i=[b,x][t]*a/m;c.copy(O).applyAxisAngle(C,i).add(A),r.push(c.clone()),t&&(g(c,A),e.push([0==a?n:c.clone(),v.clone()]))}t&&(g(i,A),e.push([i,v.clone()]))}a.push(e)}P.push(a);let _=2*m,z=2;for(let t=0;t<l;t++){let e=_*t,n=_*((t+1)%l),a=[r[e]];for(let s=1;s<m;s++){O=r[e+s],D=r[n+s],a.push(O);for(let e=1,r=s-z+1;e<=r;e++)c.lerpVectors(O,D,e/(r+1)),c.sub(A).setLength(i[t]).add(A),a.push(c.clone());a.push(D)}for(let t=0;t<m;t++)a.push(r[t+m+e]);a.push(r[n+m]);let o=S.map((t=>a[t]));s.push(...o.map((t=>[t.x,t.y,t.z])).flat()),h.push(...o.map((t=>(g(t,A),[v.x,v.y,v.z]))).flat())}}let z=[];for(let t=0;t<x.length;t++)for(let e=0;e<l;e++){let r=x[t][e];if(r<w){let n=x[r].findIndex((e=>e%w==t)),i=P[t][e],a=P[r][n];for(let t=0;t<m;t++){let e=i[t],r=a[m-t],n=i[t+1];[e,r,n,n,r,a[m-(t+1)]].forEach((t=>{s.push(t[0].x,t[0].y,t[0].z),h.push(t[1].x,t[1].y,t[1].z)}))}z.push(i[0][0],a[m][0],i[m][0],a[0][0])}}for(;z.length;){let t,e,r,n;[t,e]=z.splice(0,2);let i=[t];for(;t!=e;)i.push(e),r=z.indexOf(e),n=r%2,e=z.splice(r-n,2)[1-n];v.subVectors(i[0],i[1]).cross(c.subVectors(i[0],i[2])).normalize();let a=v.dot(i[0])<0;a&&v.negate();for(let o=1;o<=i.length-2;o++)[i[o+ +a],i[o+1-+a],i[0]].forEach((t=>{s.push(t.x,t.y,t.z),h.push(v.x,v.y,v.z)}))}}(),function(){let t=new n.Vector3;for(let n=0;n<s.length;n+=3){t.x=s[n+0],t.y=s[n+1],t.z=s[n+2];let e=d(t)/2/Math.PI+.5,r=p(t)/Math.PI+.5;l.push(e,1-r)}let e=new n.Vector3,r=new n.Vector3,i=new n.Vector3,a=new n.Vector3,o=new n.Vector2,h=new n.Vector2,c=new n.Vector2,u=(t,e,r,n)=>{n<0&&1===t.x&&(l[e]=t.x-1),0===r.x&&0===r.z&&(l[e]=n/2/Math.PI+.5)};for(let n=0,f=0;n<s.length;n+=9,f+=6){e.set(s[n+0],s[n+1],s[n+2]),r.set(s[n+3],s[n+4],s[n+5]),i.set(s[n+6],s[n+7],s[n+8]),o.set(l[f+0],l[f+1]),h.set(l[f+2],l[f+3]),c.set(l[f+4],l[f+5]),a.copy(e).add(r).add(i).divideScalar(3);let t=d(a);u(o,f+0,e,t),u(h,f+2,r,t),u(c,f+4,i,t)}for(let n=0;n<l.length;n+=6){let t=l[n+0],e=l[n+2],r=l[n+4],i=Math.max(t,e,r),a=Math.min(t,e,r);i>.9&&a<.1&&(t<.2&&(l[n+0]+=1),e<.2&&(l[n+2]+=1),r<.2&&(l[n+4]+=1))}function d(t){return Math.atan2(t.z,-t.x)}function p(t){return Math.atan2(-t.y,Math.sqrt(t.x*t.x+t.z*t.z))}}(),this.setAttribute("position",new n.Float32BufferAttribute(s,3)),this.setAttribute("normal",new n.Float32BufferAttribute(h,3)),void this.setAttribute("uv",new n.Float32BufferAttribute(l,2))}static fromJSON(t){return new Uh(t.vertices,t.indices,t.radius,t.corner,t.cornerSides)}},jh=class extends Uh{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.2,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:4,n=(1+Math.sqrt(5))/2,i=1/n,a="DodecahedronGeometry";super([-1,-1,-1,-1,-1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,1,1,1,-1,1,1,1,0,-i,-n,0,-i,n,0,i,-n,0,i,n,-i,-n,0,-i,n,0,i,-n,0,i,n,0,-n,0,-i,n,0,-i,-n,0,i,n,0,i],[3,11,7,3,7,15,3,15,13,7,19,17,7,17,6,7,6,15,17,4,8,17,8,10,17,10,6,8,0,16,8,16,2,8,2,10,0,12,1,0,1,18,0,18,16,6,10,2,6,2,13,6,13,15,2,16,18,2,18,3,2,3,13,18,1,9,18,9,11,18,11,3,4,14,12,4,12,0,4,0,8,11,9,5,11,5,19,11,19,7,19,5,14,19,14,4,19,4,17,1,12,14,1,14,5,1,5,9],a,t,e,r),this.type=a}static fromJSON(t){return new jh(t.radius,t.corner,t.cornerSides)}},Nh=1e-12,Rh=class{constructor(t){this.position=new n.Vector2,this.startPosition=new n.Vector2,this.uuid=n.MathUtils.generateUUID(),this.position=t.clone()}start(){this.reset()}reset(){this.startPosition.copy(this.position)}applyOffset(t){this.position.copy(this.startPosition).add(t)}copy(t){return this.position.copy(t.position),this.startPosition.copy(t.startPosition),this}clone(){return new Rh(this.position).copy(this)}toJSON(){return[this.position.x,this.position.y]}},Fh=class extends Rh{constructor(t){super(t.position),this.parent=t}copy(t){return super.copy(t),this}clone(){return new Fh(this.parent).copy(this)}},Gh=class extends Rh{constructor(t,e){super(e),this.controls=[],this.roundness=0,this.areControlsDirectionsMirrored=!0,this.uuid=t,this.controls.push(new Fh(this),new Fh(this))}static create(t,e){let r=new Gh(t,new n.Vector2(...e.position));return r.controls[0].position.set(...e.controlPrevious.position),r.controls[1].position.set(...e.controlNext.position),r.roundness=e.roundness,r.areControlsDirectionsMirrored=e.areControlsDirectionsMirrored,r}getOppositeControl(t){let e=this.controls.indexOf(t);return 0===e?this.controls[1]:1===e?this.controls[0]:null}applyOffsetToControls(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;for(let r=0,n=this.controls.length;r<n;r++){let n=this.controls[r];this.position.distanceTo(n.position)<=e?n.position.copy(this.position):n.applyOffset(t)}}controlsMoved(){return!(this.position.equals(this.controls[0].position)&&this.position.equals(this.controls[1].position))}copy(t){return super.copy(t),this.controls[0].copy(t.controls[0]),this.controls[1].copy(t.controls[1]),this.roundness=t.roundness,this.uuid=t.uuid,this}clone(){return new Gh(this.uuid,this.position).copy(this)}toJSON(){return super.toJSON().concat(this.controls[0].toJSON(),this.controls[1].toJSON(),[this.roundness])}computeTangents(){var t,e;return[null===(t=this.curveBefore)||void 0===t?void 0:t.getTangentAt(1),null===(e=this.curveAfter)||void 0===e?void 0:e.getTangentAt(0)]}computeNormals(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new n.Vector2,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new n.Vector2,[r,i]=this.computeTangents();return r&&i&&(qh(r,t),qh(i,e)),[t,e]}computeTangent(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new n.Vector2,[e,r]=this.computeTangents();return e&&r&&t.copy(e).add(r).normalize(),t}computeNormal(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new n.Vector2,[e,r]=this.computeNormals();return t.copy(e).add(r).normalize(),t}};function qh(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new n.Vector2,r=t.length();return e.set(-t.y/r,t.x/r)}var Hh=new n.Vector2,Wh=new n.Vector2,Xh=new n.Vector2,Yh=new n.Vector2,Qh=new n.Vector2,Zh=new n.Vector2,Kh=new n.Vector3,Jh=new n.Vector3;function $h(t){let e=new n.Vector2;e.addVectors(t.v0,Hh.subVectors(t.v1,t.v0).multiplyScalar(2/3));let r=new n.Vector2;return r.addVectors(t.v2,Wh.subVectors(t.v1,t.v2).multiplyScalar(2/3)),new n.CubicBezierCurve(t.v0,e,r,t.v2)}function tc(t,e){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Number.EPSILON;return Math.abs(t-e)<r}function ec(t,e){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Number.EPSILON;return t.distanceTo(e)<r}function rc(t,e){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Number.EPSILON;return t.distanceTo(e)<r}function nc(t,e,r){let n=Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2)),i=Math.sqrt(Math.pow(e.x-r.x,2)+Math.pow(e.y-r.y,2)),a=Math.sqrt(Math.pow(r.x-t.x,2)+Math.pow(r.y-t.y,2));return Math.acos((i*i+n*n-a*a)/(2*i*n))}function ic(t,e,r){return cc(t,e)&&cc(e,r)&&ac(t.position,e.position,r.position)}function ac(t,e,r){return 0===Hh.copy(e).sub(t).cross(Wh.copy(r).sub(t))}function oc(t,e,r,n,i){let a=Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2)),o=(t.y+e.y)/2,s=(t.x+e.x)/2,l=Math.sqrt(Math.pow(r,2)-Math.pow(a/2,2))*(t.y-e.y)/a,h=Math.sqrt(Math.pow(r,2)-Math.pow(a/2,2))*(e.x-t.x)/a;return n.set(s+l,o+h),i.set(s-l,o-h),[n,i]}function sc(t,e,r){return t.distanceTo(r)<e.distanceTo(r)?e:t}function lc(t,e,r,n,i,a){let o,s=e.x-t.x,l=e.y-t.y,h=r.x-t.x,c=r.y-t.y,u=Math.sqrt((s+h)*(s+h)+(l+c)*(l+c));return nc(e,t,r)>Math.PI&&(u*=-1),o=tc(c,l)?(l+c)*(n/u-.5)*8/3/(s-h):(s+h)*(n/u-.5)*8/3/(c-l),i.set(e.x-o*l,e.y+o*s),a.set(r.x+o*c,r.y-o*h),[i,a]}function hc(t,e){return t.position.equals(t.controls[1].position)&&e.position.equals(e.controls[0].position)}function cc(t,e){return ac(t.position,t.controls[1].position,e.position)&&ac(t.position,e.controls[0].position,e.position)}function uc(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:12,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=[];for(let i=0,a=t.length;i<a;i++){let a=t[i],o=0;if(r&&void 0!==a.roundedCurveCorner){let t=.5*dc(a.roundedCurveCorner,e);i>0&&(n[i-1]+=t),o+=t}void 0!==a.curveAfter&&(o+=dc(a.curveAfter,e)),n.push(o)}return t.length>0&&r&&void 0!==t[0].roundedCurveCorner&&(n[t.length-1]+=.5*dc(t[0].roundedCurveCorner,e)),n}function dc(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:12;return t&&t instanceof n.EllipseCurve?2*e:t&&(t instanceof n.LineCurve||t instanceof n.LineCurve3)?1:t&&t instanceof n.SplineCurve?e*t.points.length:e}var pc,fc,mc,vc=new n.Vector2,gc=new n.Vector2,yc=new n.Vector2,bc=new n.Vector2,xc=new n.Vector2,wc=new n.Vector2,_c=class extends n.Shape{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:100,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100;super(),this.points=[],this.shapeHoles=[],this.plane=new n.Plane(new n.Vector3(0,0,-1)),this.subdivision=0,this.controlSnapDistance=4,this.pointIDs=0,this.isMesh2D=!1,this.isText=!1,this._roundness=0,this.isClosed=!1,this.useCubicForRoundedCorners=!0,this.uuid=n.MathUtils.generateUUID(),this.needsUpdate=!1,this.roundedCurves=[],this._width=t,this._height=e}static createFromState(t,e,r){let n=new _c;return n.isClosed=t.isClosed,n.points=t.points.map((t=>Gh.create(t.id,t.data))),"number"==typeof t.roundness&&(n.roundness=t.roundness),n.shapeHoles=t.shapeHoles.map((t=>_c.createFromState(t))),void 0!==e&&void 0!==r&&n.applySize(e,r),n.update(),n}get width(){return this._width}get height(){return this._height}get roundness(){return this._roundness}set roundness(t){if(this._roundness!==t){this._roundness=t;for(let e=0,r=this.points.length;e<r;e++)this.points[e].roundness=t;this.needsUpdate=!0}}getPointsIndexesByIds(t){return t.map((t=>this.getPointIndexById(t))).filter((t=>t>=0))}getPointIndexById(t){let e=this.points.length,r=this.points.findIndex((e=>e.uuid===t));if(r<0){let r=e;for(let e=0,n=this.shapeHoles.length;e<n;e++){let n=this.shapeHoles[e],i=n.points.length,a=n.getPointIndexById(t);if(!(a<0))return a+r;r+=i}}return r}getLineIndexById(t){return this.getPointIndexById(t)}getBezierPoint(t){if(t<=this.points.length-1)return this.points[t];if(this.shapeHoles.length>0){let e=this.points.length;for(let r=0,n=this.shapeHoles.length;r<n;r++){let n=this.shapeHoles[r],i=t-e;if(i<=n.points.length-1)return n.points[i];e+=n.points.length}}throw new Error("This shape does not have a point for this index: "+t)}getBezierPointIndex(t){let e=this.points.indexOf(t);if(e>=0)return e;if(e=this.points.length,this.shapeHoles.length>0)for(let r=0,n=this.shapeHoles.length;r<n;r++){let n=this.shapeHoles[r],i=n.points.indexOf(t);if(i>=0)return e+i;e+=n.points.length}return-1}getAllPoints(){let t=[].concat(...this.shapeHoles.map((t=>t.points)));return[...this.points,...t]}applySize(t,e){0===t&&(t=.001),0===e&&(e=.001),this._width=t,this._height=e}applyScale(t,e){let r=vc.set(t,e);for(let n=0,i=this.points.length;n<i;n++){let t=this.points[n];t.position.multiply(r),t.controls[0].position.multiply(r),t.controls[1].position.multiply(r)}for(let n=0,i=this.shapeHoles.length;n<i;n++)this.shapeHoles[n].applyScale(t,e);this._update()}createPoint(t){let e,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:n.MathUtils.generateUUID();e=t instanceof n.Vector2?t:new n.Vector2(t,r);let a=new Gh(i,e);return a.roundness=this.roundness,a}addPoint(t){this.points.push(t),this.needsUpdate=!0}addPointAt(t,e){this.points.splice(e,0,t),this.needsUpdate=!0}getPointByUuid(t){for(let e=0,r=this.points.length;e<r;e++){let r=this.points[e];if(r.uuid===t)return r}for(let e=0,r=this.shapeHoles.length;e<r;e++){let r=this.shapeHoles[e].getPointByUuid(t);if(r)return r}}getFirstPoint(){return this.points[0]}getLastPoint(){return this.points[this.points.length-1]}removePoint(t){let e=this.points.indexOf(t);e>=0&&this.points.splice(e,1),this.needsUpdate=!0}removePointById(t){let e=this.points.find((e=>e.uuid===t));e&&this.removePoint(e)}update(){for(let t=0,e=this.shapeHoles.length;t<e;t++)this.shapeHoles[t].update();this._update()}extractShapePointsToBuffer(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:12,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.subdivision=e,void 0===this.curveDivisions&&this.computeCurveDivisions(e);let i=r?this.roundedCurveDivisions:this.curveDivisions;return function(t,e){let r,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:12,a=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],o=Jh.set(0,0,0),s=0,l=[];for(let h=0;h<e.length;h++){let a=e[h],c=Hh,u=dc(a,i);l.push(u);for(let e=0;e<=u;e++)if(a instanceof n.CubicBezierCurve||a instanceof n.QuadraticBezierCurve||a instanceof n.LineCurve){if(a.getPoint(e/u,c),o.set(c.x,c.y,0),void 0!==r&&rc(r,o))continue;void 0===r&&(r=Kh),r.copy(o),t.setXYZ(s,o.x,o.y,o.z),s++}}a&&s>1&&!(t.getX(s-1)===t.getX(0)&&t.getY(s-1)===t.getY(0)&&t.getZ(s-1)===t.getZ(0))&&(t.setXYZ(s,t.getX(0),t.getY(0),t.getZ(0)),s++)}(t,r?this.roundedCurves:this.curves,e,this.autoClose),i.reduce(((t,e)=>t+e),0)+1}computeCurveDivisions(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:12;return this.curveDivisions=uc(this.points,t,!1),this.roundedCurveDivisions=uc(this.points,t,!0),this.curveDivisions}extractFilteredShapePointsToBuffer(t,e){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:12;return 2*function(t,e,r){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:12,a=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],o=Jh.set(0,0,0),s=0,l=[];for(let c=0;c<e.length;c++){if(!1===r[c])continue;let a,u=e[c],d=Hh,p=dc(u,i);l.push(p);for(let e=0;e<=p;e++)if(u instanceof n.CubicBezierCurve||u instanceof n.QuadraticBezierCurve||u instanceof n.LineCurve){var h;if(u.getPoint(e/p,d),o.set(d.x,d.y,0),null!==(h=a)&&void 0!==h&&h.equals(o))continue;void 0===a?a=Kh:(t.setXYZ(s,a.x,a.y,a.z),s++,t.setXYZ(s,o.x,o.y,o.z),s++),a.copy(o)}}return a&&s>1&&!(t.getX(s-1)===t.getX(0)&&t.getY(s-1)===t.getY(0)&&t.getZ(s-1)===t.getZ(0))&&(t.setXYZ(s,t.getX(0),t.getY(0),t.getZ(0)),s++),l}(t,this.curves,e,r,this.autoClose).reduce(((t,e)=>t+e),0)}extractShapePointsToFlatArray(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:12;return this.subdivision=e,void 0===this.curveDivisions&&this.computeCurveDivisions(e),function(t,e){let r,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:12,a=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],o=0;for(let s=0;s<e.length;s++){let a=e[s],l=dc(a,i),h=Hh;for(let e=0;e<=l;e++)if(a instanceof n.CubicBezierCurve||a instanceof n.QuadraticBezierCurve||a instanceof n.LineCurve){if(a.getPoint(e/l,h),void 0!==r&&ec(r,h,Nh))continue;void 0===r&&(r=Wh),r.copy(h),t.push(h.x,h.y),o++}}return tc(t[0],t[t.length-2],Nh)&&tc(t[1],t[t.length-1],Nh)&&(t.pop(),t.pop()),a&&o>1&&!(tc(t[o-1],t[1],Nh)&&tc(t[o-2],t[0],Nh))&&(t.push(t[0],t[1]),o++),t}(t,this.roundedCurves,e,this.autoClose)}getCurveIndexFromVertexId(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=0;void 0===this.curveDivisions&&this.computeCurveDivisions(this.subdivision);let n=e?this.roundedCurveDivisions:this.curveDivisions,i=0;e&&void 0!==this.points[0].roundedCurveCorner&&(i=.5*dc(this.points[0].roundedCurveCorner,this.subdivision));let a=t-i;a<0&&(a+=n.reduce(((t,e)=>t+e),0));for(let o=0,s=n.length;o<s;o++){let t=n[o];if(a<r+t)return[o,(a-r+1)/t];r+=t}return[0,1]}getCurveT(t,e,r){let n=this.points[t],i=this.points[t>=this.points.length-1?0:t+1],a=this.curveDivisions,o=a[t];if(hc(n,i)){let t=n.position.distanceTo(i.position);return n.position.distanceTo(vc.set(r.x,r.y))/t}let s=0;for(let l=0;l<t;l++)s+=a[l];return(e-s)/o}dispose(){}_applyCurveForPoint(t,e){hc(e,t)?this.lineTo(t.position.x,t.position.y):this.bezierCurveTo(e.controls[1].position.x,e.controls[1].position.y,t.controls[0].position.x,t.controls[0].position.y,t.position.x,t.position.y);let r=this.curves[this.curves.length-1];t.curveBefore=r,e.curveAfter=r;let n=r.clone();t.roundedCurveBefore=n,e.roundedCurveAfter=n,t.roundedCurveCorner=void 0,this.roundedCurves.push(n)}_update(){if(this.curves=[],this.roundedCurves=[],!this.points.length)return;for(let n=0,i=this.points.length;n<i;n++){let t=this.points[n];if(0===n)this.moveTo(t.position.x,t.position.y);else{let e=this.points[n-1];this._applyCurveForPoint(t,e)}}let t=this.getLastPoint();if(null!==t&&void 0!==t&&t.curveAfter&&(t.curveAfter=void 0),this.isClosed){let t=this.points[0],e=this.points[this.points.length-1];this._applyCurveForPoint(t,e)}if(this.points.length>2){let t=0;for(let i=0,a=this.points.length;i<a;i++){var e,r;let a=this.points[i],o=null!==(e=this.points[i-1])&&void 0!==e?e:this.points[this.points.length-1],s=null!==(r=this.points[i+1])&&void 0!==r?r:this.points[0],l=a.roundness,h=o&&s&&ic(o,a,s);if(!a.controlsMoved()&&l>0&&!h){let e=a.curveBefore,r=a.curveAfter;if(void 0===e||void 0===r)continue;let o,s=a.roundedCurveBefore,h=a.roundedCurveAfter,c=e.getLength(),u=r.getLength(),d=Math.min(l,.499*c),p=Math.min(l,.499*u),f=Math.min(d,p),m=1-f/c,v=f/u,g=e.getPointAt(m,vc),y=r.getPointAt(v,gc);if(this._subSplitCurve(e,s,m,g,void 0),this._subSplitCurve(r,h,v,void 0,y),this.useCubicForRoundedCorners){let t=nc(g,a.position,y)/2,e=Math.tan(t)*g.distanceTo(a.position),[r,i]=oc(g,y,e,yc,bc),s=sc(r,i,a.position),[l,h]=lc(s,g,y,e,xc,wc);o=new n.CubicBezierCurve(g.clone(),l.clone(),h.clone(),y.clone())}else o=new n.QuadraticBezierCurve(g.clone(),a.position.clone(),y.clone());a.roundedCurveCorner=o,this.roundedCurves.splice(i+t,0,o),t++}}}}_subSplitCurve(t,e,r,i,a){if(!(t instanceof n.LineCurve)){let n=t,o=e,s=n.getUtoTmapping(r,0),l=function(t,e,r,n){let i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:.5,a=Hh.subVectors(e,t).multiplyScalar(i).add(t),o=Wh.subVectors(r,e).multiplyScalar(i).add(e),s=Xh.subVectors(n,r).multiplyScalar(i).add(r),l=a,h=Yh.subVectors(o,a).multiplyScalar(i).add(a),c=Qh.subVectors(s,o).multiplyScalar(i).add(o),u=s,d=Zh.subVectors(c,h).multiplyScalar(i).add(h);return[t.x,t.y,l.x,l.y,h.x,h.y,d.x,d.y,c.x,c.y,u.x,u.y,n.x,n.y]}(n.v0,n.v1,n.v2,n.v3,s);return void 0!==i&&(o.v0.set(l[0],l[1]),o.v1.set(l[2],l[3]),o.v2.set(l[4],l[5]),o.v3.set(l[6],l[7])),void 0!==a&&(o.v0.set(l[6],l[7]),o.v1.set(l[8],l[9]),o.v2.set(l[10],l[11]),o.v3.set(l[12],l[13])),o}return void 0!==i&&e.v2.copy(i),void 0!==a&&e.v1.copy(a),e}clone(){let t=new _c(this._width,this._height);return t.points=this.points.map((t=>t.clone())),t.isClosed=this.isClosed,t.roundness=this.roundness,t.isMesh2D=this.isMesh2D,t.shapeHoles=this.shapeHoles.map((t=>t.clone())),t}toJSON(){return{points:this.points.reduce(((t,e)=>t.concat(e.toJSON())),[]),shapeHoles:this.shapeHoles.map((t=>t.toJSON())),isClosed:this.isClosed,roundness:this.roundness}}fromJSON(t){var e;this.points=[],this.pointIDs=0;let r=t.points.length/7;for(let i=0;i<r;i++){let e=7*i,r=t.points[e+0],a=t.points[e+1],o=t.points[e+2],s=t.points[e+3],l=t.points[e+4],h=t.points[e+5],c=t.points[e+6],u=new Gh(n.MathUtils.generateUUID(),new n.Vector2(r,a));u.controls[0].position.set(o,s),u.controls[1].position.set(l,h),u.roundness=c,this.points.push(u)}return this.shapeHoles=null!==(e=t.shapeHoles)&&void 0!==e&&e.length?t.shapeHoles.map((t=>{let e=new _c;return e.fromJSON(t),e})):[],this.isClosed=t.isClosed,this._roundness=t.roundness,this._update(),this}fromShape(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.isText=e;let r=(t,e)=>{e instanceof n.CubicBezierCurve&&e.v3.equals(t.position)&&t.controls[0].position.copy(e.v2)};return this.points=(t=>{let e,i,a=[];for(e=0,i=t.length;e<i;e++)t[e]instanceof n.QuadraticBezierCurve&&(t[e]=$h(t[e]));for(e=0,i=t.length;e<i;e++){let i,o=t[e],s=e>0?t[e-1]:null;o instanceof n.CubicBezierCurve?(i=this.createPoint(o.v0),i.controls[1].position.copy(o.v1)):o instanceof n.LineCurve&&(i=this.createPoint(o.v1)),void 0!==i&&(null!==s&&r(i,s),a.push(i))}let o=t[t.length-1],s=!1;return o instanceof n.CubicBezierCurve?o.v3.equals(a[0].position)&&(a[0].controls[0].position.copy(o.v2),s=!0):o instanceof n.LineCurve&&o.v2.equals(a[0].position)&&(s=!0),this.isClosed=s,a})(t.curves),t instanceof n.Shape&&(this.shapeHoles=t.holes.map((t=>{let e=new _c;return e.fromShape(t),e}))),this.update(),this}updatePoint(t,e){let r=this.getPointByUuid(t);r&&(void 0!==e.position&&r.position.fromArray(e.position),void 0!==e.roundness&&(r.roundness=e.roundness),void 0!==e.areControlsDirectionsMirrored&&(r.areControlsDirectionsMirrored=e.areControlsDirectionsMirrored),this.needsUpdate=!0)}updatePreviousControl(t,e){var r;let n=null===(r=this.getPointByUuid(t))||void 0===r?void 0:r.controls[0];n&&(e.position&&n.position.fromArray(e.position),this.needsUpdate=!0)}updateNextControl(t,e){var r;let n=null===(r=this.getPointByUuid(t))||void 0===r?void 0:r.controls[1];n&&(e.position&&n.position.fromArray(e.position),this.needsUpdate=!0)}},Sc=2*Math.PI;function Ac(t,e,r,n,i){let{x:a,y:o}=t;return{x:a*e+n,y:o*r+i}}function Mc(t,e){let r=1.5707963267948966===e?.551915024494:-1.5707963267948966===e?-.551915024494:1.3333333333333333*Math.tan(e/4),n=Math.cos(t),i=Math.sin(t),a=Math.cos(t+e),o=Math.sin(t+e);return[{x:n-i*r,y:i+n*r},{x:a+o*r,y:o-a*r},{x:a,y:o}]}function Cc(t,e,r,n){let i=t*n-e*r<0?-1:1,a=Math.min(1,Math.max(-1,t*r+e*n));return i*Math.acos(a)}function Oc(t){let{px:e,py:r,cx:n,cy:i,rx:a,ry:o,largeArcFlag:s,sweepFlag:l}=t,h=[];if(0===a||0===o)return[];let c=(e-n)/2,u=(r-i)/2;if(0===c&&0===u)return[];a=Math.abs(a),o=Math.abs(o);let d=Math.pow(c,2)/Math.pow(a,2)+Math.pow(u,2)/Math.pow(o,2);d>1&&(a*=Math.sqrt(d),o*=Math.sqrt(d));let p=function(t,e,r,n,i,a,o,s,l,h){let c=Math.pow(i,2),u=Math.pow(a,2),d=Math.pow(o,2),p=Math.pow(s,2),f=c*u-c*p-u*d;f<0&&(f=0),f/=c*p+u*d,f=Math.sqrt(f)*(l===h?-1:1);let m=f*i/a*s,v=f*-a/i*o,g=m+(t+r)/2,y=v+(e+n)/2,b=(o-m)/i,x=(s-v)/a,w=(-o-m)/i,_=(-s-v)/a,S=Cc(1,0,b,x),A=Cc(b,x,w,_);return!h&&A>0&&(A-=Sc),h&&A<0&&(A+=Sc),{centerx:g,centery:y,ang1:S,ang2:A}}(e,r,n,i,a,o,c,u,s,l),{ang1:f,ang2:m}=p,{centerx:v,centery:g}=p,y=Math.abs(m)/(Sc/4);Math.abs(1-y)<1e-7&&(y=1);let b=Math.max(Math.ceil(y),1);m/=b;for(let x=0;x<b;x++)h.push(Mc(f,m)),f+=m;return h.map((t=>{let{x:e,y:r}=Ac(t[0],a,o,v,g),{x:n,y:i}=Ac(t[1],a,o,v,g),{x:s,y:l}=Ac(t[2],a,o,v,g);return{x1:e,y1:r,x2:n,y2:i,x:s,y:l}}))}function Dc(t,e){if(!t)throw e||"Assertion Failed!"}(fc=pc||(pc={}))[fc.ODD=0]="ODD",fc[fc.NONZERO=1]="NONZERO",fc[fc.POSITIVE=2]="POSITIVE",fc[fc.NEGATIVE=3]="NEGATIVE",fc[fc.ABS_GEQ_TWO=4]="ABS_GEQ_TWO",function(t){t[t.POLYGONS=0]="POLYGONS",t[t.CONNECTED_POLYGONS=1]="CONNECTED_POLYGONS",t[t.BOUNDARY_CONTOURS=2]="BOUNDARY_CONTOURS"}(mc||(mc={}));var Pc=function(){function t(){}return t.vertEq=function(t,e){return t.s===e.s&&t.t===e.t},t.vertLeq=function(t,e){return t.s<e.s||t.s===e.s&&t.t<=e.t},t.transLeq=function(t,e){return t.t<e.t||t.t===e.t&&t.s<=e.s},t.edgeGoesLeft=function(e){return t.vertLeq(e.Dst,e.Org)},t.edgeGoesRight=function(e){return t.vertLeq(e.Org,e.Dst)},t.vertL1dist=function(t,e){return Math.abs(t.s-e.s)+Math.abs(t.t-e.t)},t.edgeEval=function(e,r,n){Dc(t.vertLeq(e,r)&&t.vertLeq(r,n));var i=r.s-e.s,a=n.s-r.s;return i+a>0?i<a?r.t-e.t+(e.t-n.t)*(i/(i+a)):r.t-n.t+(n.t-e.t)*(a/(i+a)):0},t.edgeSign=function(e,r,n){Dc(t.vertLeq(e,r)&&t.vertLeq(r,n));var i=r.s-e.s,a=n.s-r.s;return i+a>0?(r.t-n.t)*i+(r.t-e.t)*a:0},t.transEval=function(e,r,n){Dc(t.transLeq(e,r)&&t.transLeq(r,n));var i=r.t-e.t,a=n.t-r.t;return i+a>0?i<a?r.s-e.s+(e.s-n.s)*(i/(i+a)):r.s-n.s+(n.s-e.s)*(a/(i+a)):0},t.transSign=function(e,r,n){Dc(t.transLeq(e,r)&&t.transLeq(r,n));var i=r.t-e.t,a=n.t-r.t;return i+a>0?(r.s-n.s)*i+(r.s-e.s)*a:0},t.vertCCW=function(t,e,r){return t.s*(e.t-r.t)+e.s*(r.t-t.t)+r.s*(t.t-e.t)>=0},t.interpolate=function(t,e,r,n){return(t=t<0?0:t)<=(r=r<0?0:r)?0===r?(e+n)/2:e+t/(t+r)*(n-e):n+r/(t+r)*(e-n)},t.intersect=function(e,r,n,i,a){var o,s,l;t.vertLeq(e,r)||(l=e,e=r,r=l),t.vertLeq(n,i)||(l=n,n=i,i=l),t.vertLeq(e,n)||(l=e,e=n,n=l,l=r,r=i,i=l),t.vertLeq(n,r)?t.vertLeq(r,i)?((o=t.edgeEval(e,n,r))+(s=t.edgeEval(n,r,i))<0&&(o=-o,s=-s),a.s=t.interpolate(o,n.s,s,r.s)):((o=t.edgeSign(e,n,r))+(s=-t.edgeSign(e,i,r))<0&&(o=-o,s=-s),a.s=t.interpolate(o,n.s,s,i.s)):a.s=(n.s+r.s)/2,t.transLeq(e,r)||(l=e,e=r,r=l),t.transLeq(n,i)||(l=n,n=i,i=l),t.transLeq(e,n)||(l=e,e=n,n=l,l=r,r=i,i=l),t.transLeq(n,r)?t.transLeq(r,i)?((o=t.transEval(e,n,r))+(s=t.transEval(n,r,i))<0&&(o=-o,s=-s),a.t=t.interpolate(o,n.t,s,r.t)):((o=t.transSign(e,n,r))+(s=-t.transSign(e,i,r))<0&&(o=-o,s=-s),a.t=t.interpolate(o,n.t,s,i.t)):a.t=(n.t+r.t)/2},t}(),Tc=function(){this.next=null,this.prev=null,this.anEdge=null,this.trail=null,this.n=0,this.marked=!1,this.inside=!1},zc=function(){function t(t){this.side=t,this.next=null,this.Org=null,this.Sym=null,this.Onext=null,this.Lnext=null,this.Lface=null,this.activeRegion=null,this.winding=0}return Object.defineProperty(t.prototype,"Rface",{get:function(){return this.Sym.Lface},set:function(t){this.Sym.Lface=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Dst",{get:function(){return this.Sym.Org},set:function(t){this.Sym.Org=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Oprev",{get:function(){return this.Sym.Lnext},set:function(t){this.Sym.Lnext=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Lprev",{get:function(){return this.Onext.Sym},set:function(t){this.Onext.Sym=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Dprev",{get:function(){return this.Lnext.Sym},set:function(t){this.Lnext.Sym=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Rprev",{get:function(){return this.Sym.Onext},set:function(t){this.Sym.Onext=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Dnext",{get:function(){return this.Sym.Onext.Sym},set:function(t){this.Sym.Onext.Sym=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Rnext",{get:function(){return this.Sym.Lnext.Sym},set:function(t){this.Sym.Lnext.Sym=t},enumerable:!0,configurable:!0}),t}(),Ec=function(){this.next=null,this.prev=null,this.anEdge=null,this.coords=[0,0,0],this.s=0,this.t=0,this.pqHandle=0,this.n=0,this.idx=0},Ic=function(){function t(){var t=new Ec,e=new Tc,r=new zc(0),n=new zc(1);t.next=t.prev=t,t.anEdge=null,e.next=e.prev=e,r.next=r,r.Sym=n,n.next=n,n.Sym=r,this.vHead=t,this.fHead=e,this.eHead=r,this.eHeadSym=n}return t.prototype.makeEdge_=function(t){var e=new zc(0),r=new zc(1);t.Sym.side<t.side&&(t=t.Sym);var n=t.Sym.next;return r.next=n,n.Sym.next=e,e.next=t,t.Sym.next=r,e.Sym=r,e.Onext=e,e.Lnext=r,e.Org=null,e.Lface=null,e.winding=0,e.activeRegion=null,r.Sym=e,r.Onext=r,r.Lnext=e,r.Org=null,r.Lface=null,r.winding=0,r.activeRegion=null,e},t.prototype.splice_=function(t,e){var r=t.Onext,n=e.Onext;r.Sym.Lnext=e,n.Sym.Lnext=t,t.Onext=n,e.Onext=r},t.prototype.makeVertex_=function(t,e,r){var n=t;Dc(n,"Vertex can't be null!");var i=r.prev;n.prev=i,i.next=n,n.next=r,r.prev=n,n.anEdge=e;var a=e;do{a.Org=n,a=a.Onext}while(a!==e)},t.prototype.makeFace_=function(t,e,r){var n=t;Dc(n,"Face can't be null");var i=r.prev;n.prev=i,i.next=n,n.next=r,r.prev=n,n.anEdge=e,n.trail=null,n.marked=!1,n.inside=r.inside;var a=e;do{a.Lface=n,a=a.Lnext}while(a!==e)},t.prototype.killEdge_=function(t){t.Sym.side<t.side&&(t=t.Sym);var e=t.next,r=t.Sym.next;e.Sym.next=r,r.Sym.next=e},t.prototype.killVertex_=function(t,e){var r=t.anEdge,n=r;do{n.Org=e,n=n.Onext}while(n!==r);var i=t.prev,a=t.next;a.prev=i,i.next=a},t.prototype.killFace_=function(t,e){var r=t.anEdge,n=r;do{n.Lface=e,n=n.Lnext}while(n!==r);var i=t.prev,a=t.next;a.prev=i,i.next=a},t.prototype.makeEdge=function(){var t=new Ec,e=new Ec,r=new Tc,n=this.makeEdge_(this.eHead);return this.makeVertex_(t,n,this.vHead),this.makeVertex_(e,n.Sym,this.vHead),this.makeFace_(r,n,this.fHead),n},t.prototype.splice=function(t,e){var r=!1,n=!1;if(t!==e){if(e.Org!==t.Org&&(n=!0,this.killVertex_(e.Org,t.Org)),e.Lface!==t.Lface&&(r=!0,this.killFace_(e.Lface,t.Lface)),this.splice_(e,t),!n){var i=new Ec;this.makeVertex_(i,e,t.Org),t.Org.anEdge=t}if(!r){var a=new Tc;this.makeFace_(a,e,t.Lface),t.Lface.anEdge=t}}},t.prototype.delete=function(t){var e=t.Sym,r=!1;if(t.Lface!==t.Rface&&(r=!0,this.killFace_(t.Lface,t.Rface)),t.Onext===t)this.killVertex_(t.Org,null);else if(t.Rface.anEdge=t.Oprev,t.Org.anEdge=t.Onext,this.splice_(t,t.Oprev),!r){var n=new Tc;this.makeFace_(n,t,t.Lface)}e.Onext===e?(this.killVertex_(e.Org,null),this.killFace_(e.Lface,null)):(t.Lface.anEdge=e.Oprev,e.Org.anEdge=e.Onext,this.splice_(e,e.Oprev)),this.killEdge_(t)},t.prototype.addEdgeVertex=function(t){var e=this.makeEdge_(t),r=e.Sym;this.splice_(e,t.Lnext),e.Org=t.Dst;var n=new Ec;return this.makeVertex_(n,r,e.Org),e.Lface=r.Lface=t.Lface,e},t.prototype.splitEdge=function(t){var e=this.addEdgeVertex(t).Sym;return this.splice_(t.Sym,t.Sym.Oprev),this.splice_(t.Sym,e),t.Dst=e.Org,e.Dst.anEdge=e.Sym,e.Rface=t.Rface,e.winding=t.winding,e.Sym.winding=t.Sym.winding,e.idx=t.idx,e.Sym.idx=t.Sym.idx,e},t.prototype.connect=function(t,e){var r=!1,n=this.makeEdge_(t),i=n.Sym;if(e.Lface!==t.Lface&&(r=!0,this.killFace_(e.Lface,t.Lface)),this.splice_(n,t.Lnext),this.splice_(i,e),n.Org=t.Dst,i.Org=e.Org,n.Lface=i.Lface=t.Lface,t.Lface.anEdge=i,!r){var a=new Tc;this.makeFace_(a,n,t.Lface)}return n},t.prototype.zapFace=function(t){var e,r,n,i,a,o=t.anEdge;r=o.Lnext;do{r=(e=r).Lnext,e.Lface=null,null===e.Rface&&(e.Onext===e?this.killVertex_(e.Org,null):(e.Org.anEdge=e.Onext,this.splice_(e,e.Oprev)),(n=e.Sym).Onext===n?this.killVertex_(n.Org,null):(n.Org.anEdge=n.Onext,this.splice_(n,n.Oprev)),this.killEdge_(e))}while(e!=o);i=t.prev,(a=t.next).prev=i,i.next=a},t.prototype.countFaceVerts_=function(t){var e=t.anEdge,r=0;do{r++,e=e.Lnext}while(e!==t.anEdge);return r},t.prototype.mergeConvexFaces=function(t){var e,r,n,i,a;for(e=this.fHead.next;e!==this.fHead;e=e.next)if(e.inside)for(a=(r=e.anEdge).Org;n=r.Lnext,(i=r.Sym)&&i.Lface&&i.Lface.inside&&(this.countFaceVerts_(e)+this.countFaceVerts_(i.Lface)-2<=t&&Pc.vertCCW(r.Lprev.Org,r.Org,i.Lnext.Lnext.Org)&&Pc.vertCCW(i.Lprev.Org,i.Org,r.Lnext.Lnext.Org)&&(n=i.Lnext,this.delete(i),r=null,i=null)),!r||r.Lnext.Org!==a;)r=n;return!0},t.prototype.check=function(){var t,e,r,n,i,a,o=this.fHead,s=this.vHead,l=this.eHead;for(e=o,e=o;(t=e.next)!==o;e=t){Dc(t.prev===e),i=t.anEdge;do{Dc(i.Sym!==i),Dc(i.Sym.Sym===i),Dc(i.Lnext.Onext.Sym===i),Dc(i.Onext.Sym.Lnext===i),Dc(i.Lface===t),i=i.Lnext}while(i!==t.anEdge)}for(Dc(t.prev===e&&null===t.anEdge),n=s,n=s;(r=n.next)!==s;n=r){Dc(r.prev===n),i=r.anEdge;do{Dc(i.Sym!==i),Dc(i.Sym.Sym===i),Dc(i.Lnext.Onext.Sym===i),Dc(i.Onext.Sym.Lnext===i),Dc(i.Org===r),i=i.Onext}while(i!==r.anEdge)}for(Dc(r.prev===n&&null===r.anEdge),a=l,a=l;(i=a.next)!==l;a=i)Dc(i.Sym.next===a.Sym),Dc(i.Sym!==i),Dc(i.Sym.Sym===i),Dc(null!==i.Org),Dc(null!==i.Dst),Dc(i.Lnext.Onext.Sym===i),Dc(i.Onext.Sym.Lnext===i);Dc(i.Sym.next===a.Sym&&i.Sym===this.eHeadSym&&i.Sym.Sym===i&&null===i.Org&&null===i.Dst&&null===i.Lface&&null===i.Rface)},t}(),Lc=function(){this.handle=null},Bc=function(){this.key=null,this.node=0},kc=function(){function t(t,e){this.leq=e,this.max=0,this.nodes=[],this.handles=[],this.initialized=!1,this.freeList=0,this.size=0,this.max=t,this.nodes=[],this.handles=[];for(var r=0;r<t+1;r++)this.nodes[r]=new Lc,this.handles[r]=new Bc;this.initialized=!1,this.nodes[1].handle=1,this.handles[1].key=null}return t.prototype.floatDown_=function(t){var e,r,n,i=this.nodes,a=this.handles;for(e=i[t].handle;;){if((n=t<<1)<this.size&&this.leq(a[i[n+1].handle].key,a[i[n].handle].key)&&++n,Dc(n<=this.max),r=i[n].handle,n>this.size||this.leq(a[e].key,a[r].key)){i[t].handle=e,a[e].node=t;break}i[t].handle=r,a[r].node=t,t=n}},t.prototype.floatUp_=function(t){var e,r,n,i=this.nodes,a=this.handles;for(e=i[t].handle;;){if(r=i[n=t>>1].handle,0===n||this.leq(a[r].key,a[e].key)){i[t].handle=e,a[e].node=t;break}i[t].handle=r,a[r].node=t,t=n}},t.prototype.init=function(){for(var t=this.size;t>=1;--t)this.floatDown_(t);this.initialized=!0},t.prototype.min=function(){return this.handles[this.nodes[1].handle].key},t.prototype.insert=function(t){var e,r;if(2*(e=++this.size)>this.max){var n,i;for(this.max*=2,i=this.nodes.length,this.nodes.length=this.max+1,n=i;n<this.nodes.length;n++)this.nodes[n]=new Lc;for(i=this.handles.length,this.handles.length=this.max+1,n=i;n<this.handles.length;n++)this.handles[n]=new Bc}return 0===this.freeList?r=e:(r=this.freeList,this.freeList=this.handles[r].node),this.nodes[e].handle=r,this.handles[r].node=e,this.handles[r].key=t,this.initialized&&this.floatUp_(e),r},t.prototype.extractMin=function(){var t=this.nodes,e=this.handles,r=t[1].handle,n=e[r].key;return this.size>0&&(t[1].handle=t[this.size].handle,e[t[1].handle].node=1,e[r].key=null,e[r].node=this.freeList,this.freeList=r,--this.size,this.size>0&&this.floatDown_(1)),n},t.prototype.delete=function(t){var e,r=this.nodes,n=this.handles;Dc(t>=1&&t<=this.max&&null!==n[t].key),r[e=n[t].node].handle=r[this.size].handle,n[r[e].handle].node=e,--this.size,e<=this.size&&(e<=1||this.leq(n[r[e>>1].handle].key,n[r[e].handle].key)?this.floatDown_(e):this.floatUp_(e)),n[t].key=null,n[t].node=this.freeList,this.freeList=t},t}(),Vc=function(){this.eUp=null,this.nodeUp=null,this.windingNumber=0,this.inside=!1,this.sentinel=!1,this.dirty=!1,this.fixUpperEdge=!1},Uc=function(){this.key=null,this.next=null,this.prev=null},jc=function(){function t(t,e){this.frame=t,this.leq=e,this.head=new Uc,this.head.next=this.head,this.head.prev=this.head}return t.prototype.min=function(){return this.head.next},t.prototype.max=function(){return this.head.prev},t.prototype.insert=function(t){return this.insertBefore(this.head,t)},t.prototype.search=function(t){var e=this.head;do{e=e.next}while(null!==e.key&&!this.leq(this.frame,t,e.key));return e},t.prototype.insertBefore=function(t,e){do{t=t.prev}while(null!==t.key&&!this.leq(this.frame,t.key,e));var r=new Uc;return r.key=e,r.next=t.next,t.next.prev=r,r.prev=t,t.next=r,r},t.prototype.delete=function(t){t.next.prev=t.prev,t.prev.next=t.next},t}(),Nc=function(){function t(){}return t.regionBelow=function(t){return t.nodeUp.prev.key},t.regionAbove=function(t){return t.nodeUp.next.key},t.debugEvent=function(t){},t.addWinding=function(t,e){t.winding+=e.winding,t.Sym.winding+=e.Sym.winding},t.edgeLeq=function(t,e,r){var n=t.event,i=e.eUp,a=r.eUp;return i.Dst===n?a.Dst===n?Pc.vertLeq(i.Org,a.Org)?Pc.edgeSign(a.Dst,i.Org,a.Org)<=0:Pc.edgeSign(i.Dst,a.Org,i.Org)>=0:Pc.edgeSign(a.Dst,n,a.Org)<=0:a.Dst===n?Pc.edgeSign(i.Dst,n,i.Org)>=0:Pc.edgeEval(i.Dst,n,i.Org)>=Pc.edgeEval(a.Dst,n,a.Org)},t.deleteRegion=function(t,e){e.fixUpperEdge&&Dc(0===e.eUp.winding),e.eUp.activeRegion=null,t.dict.delete(e.nodeUp)},t.fixUpperEdge=function(t,e,r){Dc(e.fixUpperEdge),t.mesh.delete(e.eUp),e.fixUpperEdge=!1,e.eUp=r,r.activeRegion=e},t.topLeftRegion=function(e,r){var n,i=r.eUp.Org;do{r=t.regionAbove(r)}while(r.eUp.Org===i);if(r.fixUpperEdge){if(null===(n=e.mesh.connect(t.regionBelow(r).eUp.Sym,r.eUp.Lnext)))return null;t.fixUpperEdge(e,r,n),r=t.regionAbove(r)}return r},t.topRightRegion=function(e){var r=e.eUp.Dst;do{e=t.regionAbove(e)}while(e.eUp.Dst===r);return e},t.addRegionBelow=function(t,e,r){var n=new Vc;return n.eUp=r,n.nodeUp=t.dict.insertBefore(e.nodeUp,n),n.fixUpperEdge=!1,n.sentinel=!1,n.dirty=!1,r.activeRegion=n,n},t.isWindingInside=function(t,e){switch(t.windingRule){case pc.ODD:return 0!==(1&e);case pc.NONZERO:return 0!==e;case pc.POSITIVE:return e>0;case pc.NEGATIVE:return e<0;case pc.ABS_GEQ_TWO:return e>=2||e<=-2}throw new Error("Invalid winding rulle")},t.computeWinding=function(e,r){r.windingNumber=t.regionAbove(r).windingNumber+r.eUp.winding,r.inside=t.isWindingInside(e,r.windingNumber)},t.finishRegion=function(e,r){var n=r.eUp,i=n.Lface;i.inside=r.inside,i.anEdge=n,t.deleteRegion(e,r)},t.finishLeftRegions=function(e,r,n){for(var i,a=null,o=r,s=r.eUp;o!==n;){if(o.fixUpperEdge=!1,(i=(a=t.regionBelow(o)).eUp).Org!=s.Org){if(!a.fixUpperEdge){t.finishRegion(e,o);break}i=e.mesh.connect(s.Lprev,i.Sym),t.fixUpperEdge(e,a,i)}s.Onext!==i&&(e.mesh.splice(i.Oprev,i),e.mesh.splice(s,i)),t.finishRegion(e,o),s=a.eUp,o=a}return s},t.addRightEdges=function(e,r,n,i,a,o){var s,l,h,c,u=!0;h=n;do{Dc(Pc.vertLeq(h.Org,h.Dst)),t.addRegionBelow(e,r,h.Sym),h=h.Onext}while(h!==i);for(null===a&&(a=t.regionBelow(r).eUp.Rprev),l=r,c=a;(h=(s=t.regionBelow(l)).eUp.Sym).Org===c.Org;)h.Onext!==c&&(e.mesh.splice(h.Oprev,h),e.mesh.splice(c.Oprev,h)),s.windingNumber=l.windingNumber-h.winding,s.inside=t.isWindingInside(e,s.windingNumber),l.dirty=!0,!u&&t.checkForRightSplice(e,l)&&(t.addWinding(h,c),t.deleteRegion(e,l),e.mesh.delete(c)),u=!1,l=s,c=h;l.dirty=!0,Dc(l.windingNumber-h.winding===s.windingNumber),o&&t.walkDirtyRegions(e,l)},t.spliceMergeVertices=function(t,e,r){t.mesh.splice(e,r)},t.vertexWeights=function(t,e,r){var n=Pc.vertL1dist(e,t),i=Pc.vertL1dist(r,t),a=.5*i/(n+i),o=.5*n/(n+i);t.coords[0]+=a*e.coords[0]+o*r.coords[0],t.coords[1]+=a*e.coords[1]+o*r.coords[1],t.coords[2]+=a*e.coords[2]+o*r.coords[2]},t.getIntersectData=function(e,r,n,i,a,o){r.coords[0]=r.coords[1]=r.coords[2]=0,r.idx=-1,t.vertexWeights(r,n,i),t.vertexWeights(r,a,o)},t.checkForRightSplice=function(e,r){var n=t.regionBelow(r),i=r.eUp,a=n.eUp;if(Pc.vertLeq(i.Org,a.Org)){if(Pc.edgeSign(a.Dst,i.Org,a.Org)>0)return!1;Pc.vertEq(i.Org,a.Org)?i.Org!==a.Org&&(e.pq.delete(i.Org.pqHandle),t.spliceMergeVertices(e,a.Oprev,i)):(e.mesh.splitEdge(a.Sym),e.mesh.splice(i,a.Oprev),r.dirty=n.dirty=!0)}else{if(Pc.edgeSign(i.Dst,a.Org,i.Org)<0)return!1;t.regionAbove(r).dirty=r.dirty=!0,e.mesh.splitEdge(i.Sym),e.mesh.splice(a.Oprev,i)}return!0},t.checkForLeftSplice=function(e,r){var n,i=t.regionBelow(r),a=r.eUp,o=i.eUp;if(Dc(!Pc.vertEq(a.Dst,o.Dst)),Pc.vertLeq(a.Dst,o.Dst)){if(Pc.edgeSign(a.Dst,o.Dst,a.Org)<0)return!1;t.regionAbove(r).dirty=r.dirty=!0,n=e.mesh.splitEdge(a),e.mesh.splice(o.Sym,n),n.Lface.inside=r.inside}else{if(Pc.edgeSign(o.Dst,a.Dst,o.Org)>0)return!1;r.dirty=i.dirty=!0,n=e.mesh.splitEdge(o),e.mesh.splice(a.Lnext,o.Sym),n.Rface.inside=r.inside}return!0},t.checkForIntersect=function(e,r){var n,i,a=t.regionBelow(r),o=r.eUp,s=a.eUp,l=o.Org,h=s.Org,c=o.Dst,u=s.Dst,d=new Ec;if(Dc(!Pc.vertEq(u,c)),Dc(Pc.edgeSign(c,e.event,l)<=0),Dc(Pc.edgeSign(u,e.event,h)>=0),Dc(l!==e.event&&h!==e.event),Dc(!r.fixUpperEdge&&!a.fixUpperEdge),l===h||Math.min(l.t,c.t)>Math.max(h.t,u.t))return!1;if(Pc.vertLeq(l,h)){if(Pc.edgeSign(u,l,h)>0)return!1}else if(Pc.edgeSign(c,h,l)<0)return!1;return t.debugEvent(e),Pc.intersect(c,l,u,h,d),Dc(Math.min(l.t,c.t)<=d.t),Dc(d.t<=Math.max(h.t,u.t)),Dc(Math.min(u.s,c.s)<=d.s),Dc(d.s<=Math.max(h.s,l.s)),Pc.vertLeq(d,e.event)&&(d.s=e.event.s,d.t=e.event.t),n=Pc.vertLeq(l,h)?l:h,Pc.vertLeq(n,d)&&(d.s=n.s,d.t=n.t),Pc.vertEq(d,l)||Pc.vertEq(d,h)?(t.checkForRightSplice(e,r),!1):!Pc.vertEq(c,e.event)&&Pc.edgeSign(c,e.event,d)>=0||!Pc.vertEq(u,e.event)&&Pc.edgeSign(u,e.event,d)<=0?u===e.event?(e.mesh.splitEdge(o.Sym),e.mesh.splice(s.Sym,o),r=t.topLeftRegion(e,r),o=t.regionBelow(r).eUp,t.finishLeftRegions(e,t.regionBelow(r),a),t.addRightEdges(e,r,o.Oprev,o,o,!0),!0):c===e.event?(e.mesh.splitEdge(s.Sym),e.mesh.splice(o.Lnext,s.Oprev),a=r,r=t.topRightRegion(r),i=t.regionBelow(r).eUp.Rprev,a.eUp=s.Oprev,s=t.finishLeftRegions(e,a,null),t.addRightEdges(e,r,s.Onext,o.Rprev,i,!0),!0):(Pc.edgeSign(c,e.event,d)>=0&&(t.regionAbove(r).dirty=r.dirty=!0,e.mesh.splitEdge(o.Sym),o.Org.s=e.event.s,o.Org.t=e.event.t),Pc.edgeSign(u,e.event,d)<=0&&(r.dirty=a.dirty=!0,e.mesh.splitEdge(s.Sym),s.Org.s=e.event.s,s.Org.t=e.event.t),!1):(e.mesh.splitEdge(o.Sym),e.mesh.splitEdge(s.Sym),e.mesh.splice(s.Oprev,o),o.Org.s=d.s,o.Org.t=d.t,o.Org.pqHandle=e.pq.insert(o.Org),t.getIntersectData(e,o.Org,l,c,h,u),t.regionAbove(r).dirty=r.dirty=a.dirty=!0,!1)},t.walkDirtyRegions=function(e,r){for(var n,i,a=t.regionBelow(r);;){for(;a.dirty;)r=a,a=t.regionBelow(a);if(!r.dirty&&(a=r,null===(r=t.regionAbove(r))||!r.dirty))return;if(r.dirty=!1,n=r.eUp,i=a.eUp,n.Dst!==i.Dst&&t.checkForLeftSplice(e,r)&&(a.fixUpperEdge?(t.deleteRegion(e,a),e.mesh.delete(i),i=(a=t.regionBelow(r)).eUp):r.fixUpperEdge&&(t.deleteRegion(e,r),e.mesh.delete(n),n=(r=t.regionAbove(a)).eUp)),n.Org!==i.Org)if(n.Dst===i.Dst||r.fixUpperEdge||a.fixUpperEdge||n.Dst!==e.event&&i.Dst!==e.event)t.checkForRightSplice(e,r);else if(t.checkForIntersect(e,r))return;n.Org===i.Org&&n.Dst===i.Dst&&(t.addWinding(i,n),t.deleteRegion(e,r),e.mesh.delete(n),r=t.regionAbove(a))}},t.connectRightVertex=function(e,r,n){var i,a=n.Onext,o=t.regionBelow(r),s=r.eUp,l=o.eUp,h=!1;s.Dst!==l.Dst&&t.checkForIntersect(e,r),Pc.vertEq(s.Org,e.event)&&(e.mesh.splice(a.Oprev,s),r=t.topLeftRegion(e,r),a=t.regionBelow(r).eUp,t.finishLeftRegions(e,t.regionBelow(r),o),h=!0),Pc.vertEq(l.Org,e.event)&&(e.mesh.splice(n,l.Oprev),n=t.finishLeftRegions(e,o,null),h=!0),h?t.addRightEdges(e,r,n.Onext,a,a,!0):(i=Pc.vertLeq(l.Org,s.Org)?l.Oprev:s,i=e.mesh.connect(n.Lprev,i),t.addRightEdges(e,r,i,i.Onext,i.Onext,!1),i.Sym.activeRegion.fixUpperEdge=!0,t.walkDirtyRegions(e,r))},t.connectLeftDegenerate=function(e,r,n){var i,a,o,s,l;return i=r.eUp,Pc.vertEq(i.Org,n)?(Dc(!1),void t.spliceMergeVertices(e,i,n.anEdge)):Pc.vertEq(i.Dst,n)?(Dc(!1),r=t.topRightRegion(r),a=s=(o=(l=t.regionBelow(r)).eUp.Sym).Onext,l.fixUpperEdge&&(Dc(a!==o),t.deleteRegion(e,l),e.mesh.delete(o),o=a.Oprev),e.mesh.splice(n.anEdge,o),Pc.edgeGoesLeft(a)||(a=null),void t.addRightEdges(e,r,o.Onext,s,a,!0)):(e.mesh.splitEdge(i.Sym),r.fixUpperEdge&&(e.mesh.delete(i.Onext),r.fixUpperEdge=!1),e.mesh.splice(n.anEdge,i),void t.sweepEvent(e,n))},t.connectLeftVertex=function(e,r){var n,i,a,o,s,l,h=new Vc;if(h.eUp=r.anEdge.Sym,n=e.dict.search(h).key,i=t.regionBelow(n)){if(o=n.eUp,s=i.eUp,0===Pc.edgeSign(o.Dst,r,o.Org))return void t.connectLeftDegenerate(e,n,r);if(a=Pc.vertLeq(s.Dst,o.Dst)?n:i,n.inside||a.fixUpperEdge){if(a===n)l=e.mesh.connect(r.anEdge.Sym,o.Lnext);else l=e.mesh.connect(s.Dnext,r.anEdge).Sym;a.fixUpperEdge?t.fixUpperEdge(e,a,l):t.computeWinding(e,t.addRegionBelow(e,n,l)),t.sweepEvent(e,r)}else t.addRightEdges(e,n,r.anEdge,r.anEdge,null,!0)}},t.sweepEvent=function(e,r){e.event=r,t.debugEvent(e);for(var n=r.anEdge;null===n.activeRegion;)if((n=n.Onext)===r.anEdge)return void t.connectLeftVertex(e,r);var i=t.topLeftRegion(e,n.activeRegion);Dc(null!==i);var a=t.regionBelow(i),o=a.eUp,s=t.finishLeftRegions(e,a,null);s.Onext===o?t.connectRightVertex(e,i,s):t.addRightEdges(e,i,s.Onext,o,o,!0)},t.addSentinel=function(t,e,r,n){var i=new Vc,a=t.mesh.makeEdge();a.Org.s=r,a.Org.t=n,a.Dst.s=e,a.Dst.t=n,t.event=a.Dst,i.eUp=a,i.windingNumber=0,i.inside=!1,i.fixUpperEdge=!1,i.sentinel=!0,i.dirty=!1,i.nodeUp=t.dict.insert(i)},t.initEdgeDict=function(e){e.dict=new jc(e,t.edgeLeq);var r=e.bmax[0]-e.bmin[0],n=e.bmax[1]-e.bmin[1],i=e.bmin[0]-r,a=e.bmax[0]+r,o=e.bmin[1]-n,s=e.bmax[1]+n;t.addSentinel(e,i,a,o),t.addSentinel(e,i,a,s)},t.doneEdgeDict=function(e){for(var r,n=0;null!==(r=e.dict.min().key);)r.sentinel||(Dc(r.fixUpperEdge),Dc(1===++n)),Dc(0===r.windingNumber),t.deleteRegion(e,r)},t.removeDegenerateEdges=function(e){var r,n,i,a=e.mesh.eHead;for(r=a.next;r!==a;r=n)n=r.next,i=r.Lnext,Pc.vertEq(r.Org,r.Dst)&&r.Lnext.Lnext!==r&&(t.spliceMergeVertices(e,i,r),e.mesh.delete(r),i=(r=i).Lnext),i.Lnext===r&&(i!==r&&((i===n||i===n.Sym)&&(n=n.next),e.mesh.delete(i)),(r===n||r===n.Sym)&&(n=n.next),e.mesh.delete(r))},t.initPriorityQ=function(t){var e,r,n,i=0;for(r=(n=t.mesh.vHead).next;r!==n;r=r.next)i++;for(i+=8,e=t.pq=new kc(i,Pc.vertLeq),r=(n=t.mesh.vHead).next;r!==n;r=r.next)r.pqHandle=e.insert(r);return r===n&&(e.init(),!0)},t.donePriorityQ=function(t){t.pq=null},t.removeDegenerateFaces=function(e,r){var n,i,a;for(n=r.fHead.next;n!==r.fHead;n=i)i=n.next,Dc((a=n.anEdge).Lnext!==a),a.Lnext.Lnext===a&&(t.addWinding(a.Onext,a),e.mesh.delete(a));return!0},t.computeInterior=function(e,r){var n,i;if(void 0===r&&(r=!0),t.removeDegenerateEdges(e),!t.initPriorityQ(e))return!1;for(t.initEdgeDict(e);null!==(n=e.pq.extractMin());){for(;null!==(i=e.pq.min())&&Pc.vertEq(i,n);)i=e.pq.extractMin(),t.spliceMergeVertices(e,n.anEdge,i.anEdge);t.sweepEvent(e,n)}return e.event=e.dict.min().key.eUp.Org,t.debugEvent(e),t.doneEdgeDict(e),t.donePriorityQ(e),!!t.removeDegenerateFaces(e,e.mesh)&&(r&&e.mesh.check(),!0)},t}(),Rc=function(){function t(){this.mesh=new Ic,this.normal=[0,0,0],this.sUnit=[0,0,0],this.tUnit=[0,0,0],this.bmin=[0,0],this.bmax=[0,0],this.windingRule=pc.ODD,this.dict=null,this.pq=null,this.event=null,this.vertexIndexCounter=0,this.vertices=[],this.vertexIndices=[],this.vertexCount=0,this.elements=[],this.elementCount=0}return t.prototype.dot_=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},t.prototype.normalize_=function(t){var e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2];if(!e)throw"Zero-size vector!";e=Math.sqrt(e),t[0]/=e,t[1]/=e,t[2]/=e},t.prototype.longAxis_=function(t){var e=0;return Math.abs(t[1])>Math.abs(t[0])&&(e=1),Math.abs(t[2])>Math.abs(t[e])&&(e=2),e},t.prototype.computeNormal_=function(t){var e,r,n,i,a,o,s=[0,0,0],l=[0,0,0],h=[0,0,0],c=[0,0,0],u=[0,0,0],d=[null,null,null],p=[null,null,null],f=this.mesh.vHead;e=f.next;for(var m=0;m<3;++m)i=e.coords[m],l[m]=i,p[m]=e,s[m]=i,d[m]=e;for(e=f.next;e!==f;e=e.next)for(var v=0;v<3;++v)(i=e.coords[v])<l[v]&&(l[v]=i,p[v]=e),i>s[v]&&(s[v]=i,d[v]=e);var g=0;if(s[1]-l[1]>s[0]-l[0]&&(g=1),s[2]-l[2]>s[g]-l[g]&&(g=2),l[g]>=s[g])return t[0]=0,t[1]=0,void(t[2]=1);for(o=0,r=p[g],n=d[g],h[0]=r.coords[0]-n.coords[0],h[1]=r.coords[1]-n.coords[1],h[2]=r.coords[2]-n.coords[2],e=f.next;e!==f;e=e.next)c[0]=e.coords[0]-n.coords[0],c[1]=e.coords[1]-n.coords[1],c[2]=e.coords[2]-n.coords[2],u[0]=h[1]*c[2]-h[2]*c[1],u[1]=h[2]*c[0]-h[0]*c[2],u[2]=h[0]*c[1]-h[1]*c[0],(a=u[0]*u[0]+u[1]*u[1]+u[2]*u[2])>o&&(o=a,t[0]=u[0],t[1]=u[1],t[2]=u[2]);o<=0&&(t[0]=t[1]=t[2]=0,t[this.longAxis_(h)]=1)},t.prototype.checkOrientation_=function(){for(var t,e,r=this.mesh.fHead,n=this.mesh.vHead,i=0,a=r.next;a!==r;a=a.next)if(!((e=a.anEdge).winding<=0))do{i+=(e.Org.s-e.Dst.s)*(e.Org.t+e.Dst.t),e=e.Lnext}while(e!==a.anEdge);if(i<0){for(t=n.next;t!==n;t=t.next)t.t=-t.t;this.tUnit[0]=-this.tUnit[0],this.tUnit[1]=-this.tUnit[1],this.tUnit[2]=-this.tUnit[2]}},t.prototype.projectPolygon_=function(){var t,e,r=this.mesh.vHead,n=[0,0,0],i=!1;n[0]=this.normal[0],n[1]=this.normal[1],n[2]=this.normal[2],!n[0]&&!n[1]&&!n[2]&&(this.computeNormal_(n),i=!0),t=this.sUnit,e=this.tUnit;var a=this.longAxis_(n);t[a]=0,t[(a+1)%3]=1,t[(a+2)%3]=0,e[a]=0,e[(a+1)%3]=0,e[(a+2)%3]=n[a]>0?1:-1;for(var o=r.next;o!==r;o=o.next)o.s=this.dot_(o.coords,t),o.t=this.dot_(o.coords,e);i&&this.checkOrientation_();for(var s=!0,l=r.next;l!==r;l=l.next)s?(this.bmin[0]=this.bmax[0]=l.s,this.bmin[1]=this.bmax[1]=l.t,s=!1):(l.s<this.bmin[0]&&(this.bmin[0]=l.s),l.s>this.bmax[0]&&(this.bmax[0]=l.s),l.t<this.bmin[1]&&(this.bmin[1]=l.t),l.t>this.bmax[1]&&(this.bmax[1]=l.t))},t.prototype.addWinding_=function(t,e){t.winding+=e.winding,t.Sym.winding+=e.Sym.winding},t.prototype.tessellateMonoRegion_=function(t,e){var r,n;if((r=e.anEdge).Lnext===r||r.Lnext.Lnext===r)throw"Mono region invalid";for(;Pc.vertLeq(r.Dst,r.Org);r=r.Lprev);for(;Pc.vertLeq(r.Org,r.Dst);r=r.Lnext);n=r.Lprev;for(;r.Lnext!==n;)if(Pc.vertLeq(r.Dst,n.Org)){for(;n.Lnext!==r&&(Pc.edgeGoesLeft(n.Lnext)||Pc.edgeSign(n.Org,n.Dst,n.Lnext.Dst)<=0);)n=t.connect(n.Lnext,n).Sym;n=n.Lprev}else{for(;n.Lnext!==r&&(Pc.edgeGoesRight(r.Lprev)||Pc.edgeSign(r.Dst,r.Org,r.Lprev.Org)>=0);)r=t.connect(r,r.Lprev).Sym;r=r.Lnext}if(n.Lnext===r)throw"Mono region invalid";for(;n.Lnext.Lnext!==r;)n=t.connect(n.Lnext,n).Sym;return!0},t.prototype.tessellateInterior_=function(t){for(var e,r=t.fHead.next;r!==t.fHead;r=e)if(e=r.next,r.inside&&!this.tessellateMonoRegion_(t,r))return!1;return!0},t.prototype.discardExterior_=function(t){for(var e,r=t.fHead.next;r!==t.fHead;r=e)e=r.next,r.inside||t.zapFace(r)},t.prototype.setWindingNumber_=function(t,e,r){for(var n,i=t.eHead.next;i!==t.eHead;i=n)n=i.next,i.Rface.inside!==i.Lface.inside?i.winding=i.Lface.inside?e:-e:r?t.delete(i):i.winding=0},t.prototype.getNeighbourFace_=function(t){return t.Rface&&t.Rface.inside?t.Rface.n:-1},t.prototype.outputPolymesh_=function(t,e,r,n){var i,a,o=0,s=0;r>3&&t.mergeConvexFaces(r);for(var l=t.vHead.next;l!==t.vHead;l=l.next)l.n=-1;for(var h=t.fHead.next;h!==t.fHead;h=h.next)if(h.n=-1,h.inside){i=h.anEdge,a=0;do{-1===(l=i.Org).n&&(l.n=s,s++),a++,i=i.Lnext}while(i!==h.anEdge);if(a>r)throw"Face vertex greater that support polygon";h.n=o,++o}this.elementCount=o,e===mc.CONNECTED_POLYGONS&&(o*=2),this.elements=[],this.elements.length=o*r,this.vertexCount=s,this.vertices=[],this.vertices.length=s*n,this.vertexIndices=[],this.vertexIndices.length=s;for(l=t.vHead.next;l!==t.vHead;l=l.next)if(-1!==l.n){var c=l.n*n;this.vertices[c+0]=l.coords[0],this.vertices[c+1]=l.coords[1],n>2&&(this.vertices[c+2]=l.coords[2]),this.vertexIndices[l.n]=l.idx}var u=0;for(h=t.fHead.next;h!==t.fHead;h=h.next)if(h.inside){i=h.anEdge,a=0;do{l=i.Org;this.elements[u++]=l.n,a++,i=i.Lnext}while(i!==h.anEdge);for(var d=a;d<r;++d)this.elements[u++]=-1;if(e===mc.CONNECTED_POLYGONS){i=h.anEdge;do{this.elements[u++]=this.getNeighbourFace_(i),i=i.Lnext}while(i!==h.anEdge);for(var p=a;p<r;++p)this.elements[u++]=-1}}},t.prototype.outputContours_=function(t,e){var r,n,i=0,a=0;this.vertexCount=0,this.elementCount=0;for(var o=t.fHead.next;o!==t.fHead;o=o.next)if(o.inside){n=r=o.anEdge;do{this.vertexCount++,r=r.Lnext}while(r!==n);this.elementCount++}this.elements=[],this.elements.length=2*this.elementCount,this.vertices=[],this.vertices.length=this.vertexCount*e,this.vertexIndices=[],this.vertexIndices.length=this.vertexCount;var s=0,l=0,h=0;i=0;for(o=t.fHead.next;o!==t.fHead;o=o.next)if(o.inside){a=0,n=r=o.anEdge;do{this.vertices[s++]=r.Org.coords[0],this.vertices[s++]=r.Org.coords[1],e>2&&(this.vertices[s++]=r.Org.coords[2]),this.vertexIndices[l++]=this.vertexIdCallback?this.vertexIdCallback(r):r.Org.idx,a++,r=r.Lnext}while(r!==n);this.elements[h++]=i,this.elements[h++]=a,i+=a}},t.prototype.addContour=function(t,e){null===this.mesh&&(this.mesh=new Ic),t<2&&(t=2),t>3&&(t=3);for(var r=null,n=0;n<e.length;n+=t)null===r?(r=this.mesh.makeEdge(),this.mesh.splice(r,r.Sym)):(this.mesh.splitEdge(r),r=r.Lnext),r.Org.coords[0]=e[n+0],r.Org.coords[1]=e[n+1],r.Org.coords[2]=t>2?e[n+2]:0,r.Org.idx=this.vertexIndexCounter++,this.edgeCreateCallback&&this.edgeCreateCallback(r),r.winding=1,r.Sym.winding=-1},t.prototype.tesselate=function(t,e,r,n,i,a){if(void 0===t&&(t=pc.ODD),void 0===e&&(e=mc.POLYGONS),void 0===a&&(a=!0),this.vertices=[],this.elements=[],this.vertexIndices=[],this.vertexIndexCounter=0,i&&(this.normal[0]=i[0],this.normal[1]=i[1],this.normal[2]=i[2]),this.windingRule=t,n<2&&(n=2),n>3&&(n=3),!this.mesh)return!1;this.projectPolygon_(),Nc.computeInterior(this,a);var o=this.mesh;return e===mc.BOUNDARY_CONTOURS?this.setWindingNumber_(o,1,!0):this.tessellateInterior_(o),a&&o.check(),e===mc.BOUNDARY_CONTOURS?this.outputContours_(o,n):this.outputPolymesh_(o,e,r,n),!0},t}();function Fc(t){var e=t.windingRule,r=void 0===e?pc.ODD:e,n=t.elementType,i=void 0===n?mc.POLYGONS:n,a=t.polySize,o=void 0===a?3:a,s=t.vertexSize,l=void 0===s?2:s,h=t.normal,c=void 0===h?[0,0,1]:h,u=t.contours,d=void 0===u?[]:u,p=t.strict,f=void 0===p||p,m=t.debug,v=void 0!==m&&m;if(!d&&f)throw new Error("Contours can't be empty");if(d){var g=new Rc;t.edgeCreateCallback&&(g.edgeCreateCallback=t.edgeCreateCallback),t.vertexIdCallback&&(g.vertexIdCallback=t.vertexIdCallback);for(var y=0;y<d.length;y++)g.addContour(l||2,d[y]);return g.tesselate(r,i,o,l,c,f),{vertices:g.vertices,vertexIndices:g.vertexIndices,vertexCount:g.vertexCount,elements:g.elements,elementCount:g.elementCount,mesh:v?g.mesh:void 0}}}pc.ODD,pc.NONZERO,pc.POSITIVE,pc.NEGATIVE,pc.ABS_GEQ_TWO,mc.POLYGONS,mc.CONNECTED_POLYGONS,mc.BOUNDARY_CONTOURS;var Gc=class{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:256,e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.capacity=t,this.size=0,this.debug=e,this.debug&&console.log("allocating with cap ".concat(t));let r=t*Gc.eSize;this.buffer=new ArrayBuffer(r);let n=Float32Array.BYTES_PER_ELEMENT,i=0;this.positions=new Float32Array(this.buffer,i*n,3*t),i+=3*t,this.normals=new Float32Array(this.buffer,i*n,3*t),i+=3*t,this.uvs=new Float32Array(this.buffer,i*n,2*t)}realloc(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(t<this.size)throw Error("cannot shrink buffer");if(t<=this.capacity&&!e)return;this.debug&&console.log("resizing from ".concat(this.capacity," \u2192 ").concat(t));let r=t*Gc.eSize,n=new ArrayBuffer(r),i=Float32Array.BYTES_PER_ELEMENT,a=0,o=new Float32Array(n,a*i,3*t);a+=3*t;let s=new Float32Array(n,a*i,3*t);a+=3*t;let l=new Float32Array(n,a*i,2*t);e?(o.set(this.positions.subarray(0,3*this.size)),s.set(this.normals.subarray(0,3*this.size)),l.set(this.uvs.subarray(0,2*this.size))):(o.set(this.positions),s.set(this.normals),l.set(this.uvs)),this.buffer=n,this.positions=o,this.normals=s,this.uvs=l,this.capacity=t}get(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,e=this.size+t;if(e>this.capacity){let t=this.capacity;for(;e>t;)t*=2;this.realloc(t)}let r=this.size;return this.size=e,r}reserve(t){let e=this.size+t;e>this.capacity&&this.realloc(e)}shrink(){this.debug&&console.log("shrinking ".concat(this.capacity," \u2192 ").concat(this.size)),this.realloc(this.size,!0)}},qc=Gc;qc.eSize=8*Float32Array.BYTES_PER_ELEMENT;var Hc=v(w()),Wc={vertices:[160,160,-160,160,-160,-160,160,-160],vertexIndices:[1,0,3,2],vertexCount:4,elements:[0,4],elementCount:1,mesh:void 0},Xc={vertices:[],vertexIndices:[],vertexCount:0,elements:[],elementCount:0,mesh:void 0},Yc={vertices:[-160,160,160,-160,160,160,-160,-160],vertexIndices:[1,3,0,2],vertexCount:4,elements:[0,1,2,1,0,3],elementCount:2,mesh:void 0},Qc=(t,e)=>r=>{let[n,i]=r;return i<n&&(i+=e),(t>=n?t:t+e)<=i},Zc=class extends n.BufferGeometry{constructor(t,e){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:12,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:3,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:pc.ODD,s=arguments.length>6&&void 0!==arguments[6]&&arguments[6];super(),this.forPathBevel=s,this.type="ShapeGeometry",this.vertexCache={},this._shape=t,this._depth=e,this._curveSegments=i,this._bevelSegmentsInput=a;let l,h,c,u=this._shape.extractShapePointsToFlatArray([],i),d=this._shape.shapeHoles.map((t=>{let e=t.extractShapePointsToFlatArray([],i),r=[];for(let n=e.length-1;n>=1;n-=2){let t=e[n-1],i=e[n-0];r.push(t,i)}return r})),p=[],f=[];for(let n=0;n<u.length;n+=2)f.push([u[n],u[n+1]]);p.push(f);for(let n=0;n<d.length;n++){let t=d[n],e=[];for(let r=0;r<t.length;r+=2)e.push([t[r],t[r+1]]);p.push(e)}l=t.isText?.1*(new n.Box2).setFromPoints(t.points.map((t=>t.position))).getSize(new n.Vector2).length():0===p[0].length?r:(0,Hc.default)(p).distance,r<=0?(this._bevel=0,this._bevelSegments=0):(this._bevel=Math.min(r,l,e/2),this._bevelSegments=Math.floor(a));try{h=Fc({windingRule:o,elementType:mc.BOUNDARY_CONTOURS,vertexSize:2,strict:!0,contours:[u]})}catch{h=Wc}try{c=Fc({windingRule:pc.ODD,elementType:mc.BOUNDARY_CONTOURS,vertexSize:2,strict:!0,contours:[...d]})}catch{c=Xc}if(!h)throw new Error("error generating geometry");let m=h.elementCount;if(c){h.elementCount+=c.elementCount;for(let t=0;t<c.elements.length;t++){let e=c.elements[t],r=t%2===0?h.vertexCount:0;h.elements.push(e+r)}for(let t=0;t<c.vertexIndices.length;t++){let e=c.vertexIndices[t],r=h.vertexCount;h.vertexIndices.push(e+r)}for(let t=0;t<c.vertices.length;t++){let e=c.vertices[t];h.vertices.push(e)}}let v=1/0,g=-1/0,y=1/0,b=-1/0;for(let n=0,C=h.vertexCount;n<C;n++){let t=2*n,e=h.vertices[t+0],r=h.vertices[t+1];e<v&&(v=e),e>g&&(g=e),r<y&&(y=r),r>b&&(b=r)}this._minX=v,this._minY=y,this._width=g-v,this._height=b-y,this._buffer=new qc(this._computeBufferEstimatedSize(h));let x=[],w=[];for(let n=h.elementCount-1;n>=0;n--){let t=n>=m,e=2*n,r=h.elements[e+0],a=h.elements[e+1],o=r+a,c={start:r,count:a,normals:[],continuous:[],concave:[]},u=r,p=o-1,f=r+1,v=this._shape.roundedCurves.length;do{let e=u-r,n=h.vertices[2*p+0],i=h.vertices[2*p+1],s=h.vertices[2*u+0],l=h.vertices[2*u+1],d=h.vertices[2*f+0],m=h.vertices[2*f+1],g=s-n,y=l-i,b=Math.sqrt(g*g+y*y);g/=b,y/=b;let x=s-d,w=l-m,_=Math.sqrt(x*x+w*w);x/=_,w/=_,c.normals[2*e+0]=-w,c.normals[2*e+1]=x,c.concave[e]=g*w-y*x>0;let S=h.vertexIndices[u];if(Array.isArray(S))c.continuous[e]=!1;else{let[t,r]=this._shape.getCurveIndexFromVertexId(S-1,!0);if(r>0&&r<1)c.continuous[e]=!0;else{let n=1===r?t+1:t-1;n=(n+v)%v;let i=1===r?0:1,a=this._shape.roundedCurves[t].getTangent(r),o=this._shape.roundedCurves[n].getTangent(i);c.continuous[e]=a.dot(o)>.95}}t&&(c.normals[2*e+0]*=-1,c.normals[2*e+1]*=-1),[p,u,f]=[u,f,f+1],f>=o&&(f-=a)}while(f!==r+1);let g=[];g.push({bevelI:0,angle:0,size:0,boundary:{vertices:h.vertices.slice(2*r,2*o),vertexCount:a,vertexIndices:new Array(a).fill(!0).map(((t,e)=>[e,e])),elements:[0,a],elementCount:1,mesh:null},reverseMap:[],insetPoints:h.vertices.slice(2*r,2*o)});let y=0;for(let n=1;n<=this._bevelSegments;n++){let e=n/this._bevelSegments*Math.PI/2,r=(1-Math.cos(e))*this._bevel,o=[],s=[],l=[],u=[],d=0;for(let n=0;n<a;n++){let e=2*n,p=(n-1+a)%a*2,f=h.vertices[2*c.start+e+0],m=h.vertices[2*c.start+e+1],v=-c.normals[p+0]*r,g=-c.normals[p+1]*r,y=-c.normals[e+0]*r,b=-c.normals[e+1]*r;if(c.concave[n]||!c.concave[n]&&t){let e=Math.atan2(g,v),a=Math.atan2(b,y);a>e&&(a-=2*Math.PI);let s=a-e;if(c.continuous[n]||t){let i=e+s/2,a=Math.cos(i)*r,l=Math.sin(i)*r;o[2*d+0]=f+a*(t?-1:1),o[2*d+1]=m+l*(t?-1:1),u[d]=n,d++}else{let t=Math.max(1,Math.floor(i/4*Math.abs(s)/Math.PI));for(let i=0;i<=t;i++){let a=e+s*(i/t),l=Math.cos(a)*r,h=Math.sin(a)*r;o[2*d+0]=f+l,o[2*d+1]=m+h,u[d]=n,d++}}}else o[2*d+0]=f+v,o[2*d+1]=m+g,u[d]=n,s[n]=d,d++,o[2*d+0]=f,o[2*d+1]=m,u[d]=n,d++,o[2*d+0]=f+y,o[2*d+1]=m+b,u[d]=n,l[n]=d,d++}let p=Fc({windingRule:pc.POSITIVE,elementType:mc.BOUNDARY_CONTOURS,vertexSize:2,strict:!0,contours:[o],edgeCreateCallback:t=>{let e=t.Org.idx,r=u[e],n=u[(e+1)%u.length];t.idx=[r,n],t.Sym.idx=[n,r]},vertexIdCallback:t=>{let e=t.Lprev.idx;return[e?e[1]:0,t.idx?t.idx[0]:0]}});if(!p)throw console.log("Error"),new Error("error generating bevel geometry for ".concat(n,"'th loop"));if(!p.vertexCount){let t=(n-1)/this._bevelSegments*Math.PI/2;y=(1-Math.sin(t))*this._bevel;break}for(let t=0;t<p.vertexIndices.length;t++){let[e,r]=p.vertexIndices[t];if(e===r)continue;let n=r;r<e&&(n+=a);for(let i=e;i<n;i++){let n=i%a,o=(i+1)%a;if(!c.continuous[n]||!c.continuous[o]){p.vertexIndices[t]=[e,n],p.vertexIndices.splice(t+1,0,[o,r]),p.vertices.splice(2*(t+1),0,p.vertices[2*t],p.vertices[2*t+1]);break}}}g.push({bevelI:n,angle:e,size:r,boundary:p,reverseMap:u,insetPoints:o})}let b=(t,e,r)=>{let n=0,i=t.boundary.vertexIndices.length;for(;n<i&&r(t.boundary.vertexIndices[e]);)e=(e+1)%i,n++;return n},_=x.length;for(let n=1;n<g.length;n++){let t=g[n-1],e=g[n],r=t.boundary.vertexIndices.length,i=e.boundary.vertexIndices.length;if(!r||!i)break;let o=c.concave.length,l=0,h=Qc(l,a);for(;!t.boundary.vertexIndices.filter(h).length||!e.boundary.vertexIndices.filter(h).length;)l++,h=Qc(l,a);let u=t.boundary.vertexIndices.findIndex(h),d=e.boundary.vertexIndices.findIndex(h);do{u=(u+1)%r}while(h(t.boundary.vertexIndices[u]));do{d=(d+1)%i}while(h(e.boundary.vertexIndices[d]));l=(l+1)%a;let p,f,m=l,v=0,y=this._buildBevelVert(c,t,(u-1+r)%r,void 0,v),w=this._buildBevelVert(c,e,(d-1+i)%i,void 0,v),_=!1;do{v=(l||o)/o,h=Qc(l,a);let n=b(t,u,h),m=b(e,d,h),g=_;if(_=!1,n&&!m){for(let e=0;e<n;e++)p=this._buildBevelVert(c,t,(u+e)%r,e/(n-1),v),x.push(y.topN,p.topP,w.topN),!1===s&&x.push(p.bottomP,y.bottomN,w.bottomN),y=p;_=!0}else if(!n&&m)for(let t=0;t<m;t++)f=this._buildBevelVert(c,e,(d+t)%i,t/(m-1),v),x.push(w.topN,y.topP,f.topP),!1===s&&x.push(y.bottomP,w.bottomN,f.bottomP),w=f;else if(n&&m)if(p=this._buildBevelVert(c,t,u,0,v),f=this._buildBevelVert(c,e,d,0,v),g?(x.push(y.topN,f.topP,w.topN),x.push(y.topN,p.topP,f.topP),!1===s&&(x.push(f.bottomP,y.bottomN,w.bottomN),x.push(f.bottomP,p.bottomP,y.bottomN))):(x.push(w.topN,y.topN,p.topP),x.push(w.topN,p.topP,f.topP),!1===s&&(x.push(p.bottomP,y.bottomN,w.bottomN),x.push(p.bottomP,w.bottomN,f.bottomP))),y=p,w=f,n===m)for(let a=1;a<n;a++)p=this._buildBevelVert(c,t,(u+a)%r,a/(n-1),v),f=this._buildBevelVert(c,e,(d+a)%i,a/(m-1),v),x.push(y.topN,p.topP,w.topN),x.push(w.topN,p.topP,f.topP),!1===s&&(x.push(p.bottomP,y.bottomN,w.bottomN),x.push(p.bottomP,w.bottomN,f.bottomP)),y=p,w=f;else if(n>m){let a=n/m,o=0;for(let l=1;l<n;l++)p=this._buildBevelVert(c,t,(u+l)%r,l/(n-1),v),x.push(y.topN,p.topP,w.topN),!1===s&&x.push(p.bottomP,y.bottomN,w.bottomN),y=p,l>(o+1)*a&&(o++,f=this._buildBevelVert(c,e,(d+o)%i,o/(m-1),v),x.push(w.topN,p.topP,f.topP),!1===s&&x.push(p.bottomP,w.bottomN,f.bottomP),w=f)}else{let a=m/n,o=0;for(let l=1;l<m;l++)f=this._buildBevelVert(c,e,(d+l)%i,l/(m-1),v),x.push(w.topN,p.topP,f.topP),!1===s&&x.push(p.bottomP,w.bottomN,f.bottomP),w=f,l>(o+1)*a&&(o++,p=this._buildBevelVert(c,t,(u+o)%r,o/(n-1),v),x.push(y.topN,p.topP,w.topN),!1===s&&x.push(p.bottomP,y.bottomN,w.bottomN),y=p)}u=(u+n)%r,d=(d+m)%i,l=(l+1)%o}while(l!==m)}if(!1===s&&this._depth>2*this._bevel&&this._buildWall(g,c,x),t){let t=[];for(let e=x.length-1;e>=_+2;e-=3){let r=x[e-2],n=x[e-1],i=x[e-0];t.push(i,n,r)}x.splice(_,x.length-_,...t)}if(t){let t=[];for(let e=g[g.length-1].boundary.vertices.length-1;e>=1;e-=2){let r=g[g.length-1].boundary.vertices[e-1],n=g[g.length-1].boundary.vertices[e-0];t.push(r,n)}w.push(t)}if(!t){let t,e=g[g.length-1];try{t=Fc({windingRule:g.length>1?pc.POSITIVE:pc.ODD,elementType:mc.POLYGONS,vertexSize:2,strict:!0,contours:[e.insetPoints,...w]})}catch{t=Yc}if(!t)throw new Error("Error generating geometry for surface");0===d.length&&this._bevel<l&&Object.assign(this,{useNgonForTopBottomFaceDuringBake:!0});for(let r=0;r<3*t.elementCount;r+=3){let e=this._buildSurfaceVert(t,t.elements[r+0],y),n=this._buildSurfaceVert(t,t.elements[r+1],y),i=this._buildSurfaceVert(t,t.elements[r+2],y);x.push(e.top,n.top,i.top),!1===s&&x.push(i.bottom,n.bottom,e.bottom)}}this.vertexCache={}}this._buffer.shrink();let _=new n.BufferAttribute(Uint32Array.from(x),1),S=new n.BufferAttribute(this._buffer.positions,3),A=new n.BufferAttribute(this._buffer.normals,3),M=new n.BufferAttribute(this._buffer.uvs,2);S.needsUpdate=!0,A.needsUpdate=!0,M.needsUpdate=!0,_.needsUpdate=!0,this.setAttribute("position",S),this.setAttribute("normal",A),this.setAttribute("uv",M),this.setIndex(_)}_computeBufferEstimatedSize(t){return 2*t.vertexCount*(2+this._bevelSegments)}_buildWall(t,e,r){let n=t[0];for(let i=0,a=n.boundary.vertexCount;i<a;i++){let t=this._buildBevelVert(e,n,i),o=this._buildBevelVert(e,n,(i+1)%a);r.push(o.topP,t.topN,t.bottomN),r.push(o.topP,t.bottomN,o.bottomP)}}_buildSurfaceVert(t,e,r){let n=e.toString();if(n in this.vertexCache)return this.vertexCache[n];let i=t.vertices[2*e+0],a=t.vertices[2*e+1],o=(i-this._minX)/this._width,s=(a-this._minY)/this._height;this.forPathBevel&&(s=1);let l=this._buffer.get(this.forPathBevel?1:2),h=3*l,c=2*l,u={top:l+0,bottom:l+1};return this._buffer.positions[h+0]=i,this._buffer.positions[h+1]=a,this._buffer.positions[h+2]=this.forPathBevel?this._bevel:this._depth-r,this._buffer.normals[h+0]=0,this._buffer.normals[h+1]=0,this._buffer.normals[h+2]=1,this._buffer.uvs[c+0]=o,this._buffer.uvs[c+1]=s,!1===this.forPathBevel&&(this._buffer.positions[h+3]=i,this._buffer.positions[h+4]=a,this._buffer.positions[h+5]=r,this._buffer.normals[h+3]=0,this._buffer.normals[h+4]=0,this._buffer.normals[h+5]=-1,this._buffer.uvs[c+2]=o,this._buffer.uvs[c+3]=s),this.vertexCache[n]=u,u}_buildBevelVert(t,e,r){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,i=arguments.length>4?arguments[4]:void 0,a="".concat(e.bevelI,":").concat(r);if(a in this.vertexCache&&0!==i&&1!==i&&(!i||i===this.vertexCache[a].pathBevelUCoord))return this.vertexCache[a];let o,s,l,h,[c,u]=e.boundary.vertexIndices[r];c!==u?(s=c,o=u,h=!1,l=t.continuous[s]&&t.continuous[o]):(o=c,s=(o-1+t.count)%t.count,h=t.concave[o]&&e.bevelI>0,l=t.continuous[o]||h);let d=Math.cos(e.angle),p=Math.sin(e.angle),f=2*r,m=2*o,v=2*s,g=e.boundary.vertices[f+0],y=e.boundary.vertices[f+1],b=(1-p)*this._bevel,x=(g-this._minX)/this._width,w=(y-this._minY)/this._height;this.forPathBevel&&(void 0!==i&&(x=i),w=1);let _=t.normals[m+0],S=t.normals[m+1],A=t.normals[v+0],M=t.normals[v+1];if(h){_+=(A-_)*(1-n),S+=(M-S)*(1-n);let t=Math.sqrt(_*_+S*S);_/=t,S/=t}let C=this.forPathBevel?this._buffer.get(l?1:2):this._buffer.get(l?2:4),O=3*C,D=2*C,P={i:r,fi:o,topP:C+0,topN:C+0,bottomP:C+1,bottomN:C+1,pathBevelUCoord:i};return this._buffer.positions[O+0]=g,this._buffer.positions[O+1]=y,this._buffer.positions[O+2]=(this.forPathBevel?this._bevel:this._depth)-b,this._buffer.normals[O+0]=_*d,this._buffer.normals[O+1]=S*d,this._buffer.normals[O+2]=p,this._buffer.uvs[D+0]=x,this._buffer.uvs[D+1]=w,!1===this.forPathBevel&&(this._buffer.positions[O+3]=g,this._buffer.positions[O+4]=y,this._buffer.positions[O+5]=b,this._buffer.normals[O+3]=_*d,this._buffer.normals[O+4]=S*d,this._buffer.normals[O+5]=-p,this._buffer.uvs[D+2]=w,this._buffer.uvs[D+3]=x),l||(this.forPathBevel?(C+=1,O+=3,D+=2):(C+=2,O+=6,D+=4),P.topP=C+0,P.bottomP=C+1,this._buffer.positions[O+0]=g,this._buffer.positions[O+1]=y,this._buffer.positions[O+2]=(this.forPathBevel?this._bevel:this._depth)-b,this._buffer.normals[O+0]=A*d,this._buffer.normals[O+1]=M*d,this._buffer.normals[O+2]=p,this._buffer.uvs[D+0]=x,this._buffer.uvs[D+1]=w,!1===this.forPathBevel&&(this._buffer.positions[O+3]=g,this._buffer.positions[O+4]=y,this._buffer.positions[O+5]=b,this._buffer.normals[O+3]=A*d,this._buffer.normals[O+4]=M*d,this._buffer.normals[O+5]=-p,this._buffer.uvs[D+2]=w,this._buffer.uvs[D+3]=x)),this.vertexCache[a]=P,P}clone(){let t=new Zc(this._shape,this._depth,this._bevel,this._curveSegments,this._bevelSegmentsInput);return t.userData=Nn(this.userData),t}},Kc=class extends n.BufferGeometry{constructor(t){var e,r,i,a,o,s;let l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:12,h=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};super(),this.type="ShapeGeometry",this.windingRule=pc.ODD,this.elementType=mc.POLYGONS,this.polySize=3,this.vertexSize=2,this.strict=!0,this._shape=t,this._curveSegments=l,this._triangulationOptions=Object.assign({windingRule:pc.ODD,elementType:mc.POLYGONS,polySize:3,vertexSize:2,strict:!0},h);let c,u,d,p=this._shape.extractShapePointsToFlatArray([],this._curveSegments),f=this._shape.shapeHoles.map((t=>t.extractShapePointsToFlatArray([],this._curveSegments))),m=!0,v=!0;for(let n=0,b=p.length/2;n<b;n++){let t=2*n,e=p[t+0],r=p[t+1];if(void 0!==u&&e!==u&&(m=!1),void 0!==d&&r!==d&&(v=!1),u=e,d=r,!m&&!v)break}if(!m&&!v)try{c=Fc({contours:[p,...f],windingRule:this._triangulationOptions.windingRule,elementType:this._triangulationOptions.elementType,polySize:this._triangulationOptions.polySize,vertexSize:this._triangulationOptions.vertexSize,strict:this._triangulationOptions.strict})}catch{c=Wc}let g=null!==(e=null===(r=c)||void 0===r?void 0:r.vertexCount)&&void 0!==e?e:1,y=null!==(i=null===(a=c)||void 0===a?void 0:a.elementCount)&&void 0!==i?i:1;if(this._positionAttribute=new n.BufferAttribute(new Float32Array(3*g),3),this._normalAttribute=new n.BufferAttribute(new Float32Array(3*g),3),this._uvAttribute=new n.BufferAttribute(new Float32Array(2*g),2),this._indexAttribute=new n.BufferAttribute(new Uint32Array(3*y),1),c){let t=1/0,e=-1/0,r=1/0,n=-1/0;for(let o=0,s=g;o<s;o++){let i=2*o,a=c.vertices[i+0],s=c.vertices[i+1];a<t&&(t=a),a>e&&(e=a),s<r&&(r=s),s>n&&(n=s)}let i=e-t,a=n-r;for(let o=0,s=g;o<s;o++){let e=2*o,n=c.vertices[e+0],s=c.vertices[e+1],l=(n-t)/i,h=(s-r)/a;this._positionAttribute.setXYZ(o,n,s,0),this._normalAttribute.setXYZ(o,0,0,1),this._uvAttribute.setXY(o,l,h)}for(let o=0,s=y;o<s;o++){let t=3*o,e=c.elements[t+0],r=c.elements[t+1],n=c.elements[t+2];this._indexAttribute.setX(t+0,e),this._indexAttribute.setX(t+1,r),this._indexAttribute.setX(t+2,n)}}this.setAttribute("position",this._positionAttribute),this.setAttribute("normal",this._normalAttribute),this.setAttribute("uv",this._uvAttribute),this.setIndex(this._indexAttribute),this.setDrawRange(0,3*(null!==(o=null===(s=c)||void 0===s?void 0:s.elementCount)&&void 0!==o?o:1))}clone(){let t=new Kc(this._shape,this._curveSegments);return t.userData=Nn(this.userData),t}},Jc=class extends Zc{constructor(t,e){super(t,e,arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,arguments.length>3&&void 0!==arguments[3]?arguments[3]:12,arguments.length>4&&void 0!==arguments[4]?arguments[4]:3,arguments.length>5&&void 0!==arguments[5]?arguments[5]:pc.ODD),this.type="ShapeGeometry"}_computeBufferEstimatedSize(t){return 2*t.vertexCount*(2+this._bevelSegments)}_buildWall(t,e,r){let n=t[0];for(let i=0,a=n.boundary.vertexCount;i<a;i++){let t=this._buildBevelVert(e,n,i),o=this._buildBevelVert(e,n,(i+1)%a);r.push(o.topP,t.topN,t.bottomN),r.push(o.topP,t.bottomN,o.bottomP)}}clone(){let t=new Jc(this._shape,this._depth,this._bevel,this._curveSegments,this._bevelSegmentsInput);return t.userData=Nn(this.userData),t}},$c=class{static create(t){return this.build(this.normalizeInputs(t))}static normalizeInputs(t,e){var r,n,i,a,o,s,l,h,c;let u=Object.assign({},null!==(r=null===e||void 0===e?void 0:e.parameters)&&void 0!==r?r:{width:100,subdivisions:40,roundness:0,extrudeBevelSize:0,extrudeBevelSegments:3,windingRule:pc.ODD},t.parameters),d=Math.abs(u.width),p=Math.abs(null!==(n=u.height)&&void 0!==n?n:u.width),f=Math.abs(null!==(i=u.depth)&&void 0!==i?i:0),m=null!==(a=t.shape)&&void 0!==a?a:null===e||void 0===e?void 0:e.shape,v=null!==(o=null===(s=m)||void 0===s?void 0:s.roundness)&&void 0!==o?o:u.roundness;void 0!==m&&(m instanceof _c?(m.width!==d||m.height!==p)&&m.applySize(d,p):m=new _c(d,p).fromJSON(m),void 0!==(null===(l=t.parameters)||void 0===l?void 0:l.roundness)&&(null===(h=t.parameters)||void 0===h?void 0:h.roundness)>0&&m.update());let g=null!==(c=m)&&void 0!==c?c:new _c(d,p);return{parameters:Object.assign(u,{width:d,height:p,depth:f,roundness:v}),shape:g}}static build(t){let e,{depth:r,extrudeBevelSize:n,extrudeBevelSegments:i,subdivisions:a,roundness:o,windingRule:s}=t.parameters;return t.shape.roundness=o,e=r<=0?new Kc(t.shape,a,{windingRule:s}):new Jc(t.shape,r,n,a,i,s),Object.assign(e,{userData:{...t,type:"VectorGeometry"}})}},tu=2*Math.PI,eu=class{static create(t){return this.build(this.normalizeInputs(t))}static normalizeInputs(t,e){var r,i,a;let o=Object.assign({},null!==(r=null===e||void 0===e?void 0:e.parameters)&&void 0!==r?r:{width:100,depth:0,spikes:64,angle:360,innerRadius:0,extrudeBevelSize:0,extrudeBevelSegments:1},t.parameters);return o.angle=n.MathUtils.clamp(o.angle,0,360),{shape:t.shape&&t.shape instanceof _c?t.shape:new _c,parameters:Object.assign(o,{width:Math.abs(o.width),height:Math.abs(null!==(i=o.height)&&void 0!==i?i:o.width),depth:Math.abs(null!==(a=o.depth)&&void 0!==a?a:0)})}}static build(t){let e,{width:r,height:i,spikes:a,angle:o,innerRadius:s,depth:l,extrudeBevelSize:h,extrudeBevelSegments:c}=t.parameters,u=t.shape,d=function(t,e,r,n,i,a){if(n>=tu)return i>30||i%4===0?(function(t,e,r){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,o=.5522847498,s=e*o,l=r*o;t.addPoint(iu(i-e,a,i-e,a-l,i-e,a+l)),t.addPoint(iu(i,a+r,i-s,a+r,i+s,a+r)),t.addPoint(iu(i+e,a,i+e,a+l,i+e,a-l)),t.addPoint(iu(i,a-r,i+s,a-r,i-s,a-r)),n>0&&ou(t,e,r,n)}(t,e,r,a),Math.round(i/4)):ru(t,n,i,e,r,a);n=Math.max(n,.001);let o={x:0,y:r},s=n+.5*Math.PI,l={x:Math.cos(s)*e,y:Math.sin(s)*r},h=Oc({px:o.x,py:o.y,cx:l.x,cy:l.y,rx:e,ry:r,largeArcFlag:n>Math.PI,sweepFlag:!0});return i>30||i%h.length===0?function(t,e,r,n,i,a,o,s){let l=Math.round(i/n.length);t.addPoint(nu(e,r));for(let h=0,c=n.length;h<c;h++){let e=n[h],r=t.points[h],i=nu(e.x,e.y);r.controls[1].position.set(e.x1,e.y1),i.controls[0].position.set(e.x2,e.y2),t.addPoint(i)}return s>0?au(t,a,o,s):t.addPoint(nu(0,0)),l}(t,o.x,o.y,h,i,e,r,a):ru(t,n,i,e,r,a)}(u,.5*r,.5*i,o*Math.PI/180,a,s);return u.isClosed=!0,u.update(),0===o?(e=new n.BufferGeometry,e.setAttribute("position",new n.Float32BufferAttribute([],3))):e=$c.create({shape:u,parameters:{subdivisions:d,depth:l,extrudeBevelSize:h,extrudeBevelSegments:c}}),Object.assign(e,{userData:{...t,type:"EllipseGeometry"}})}};function ru(t,e,r,n,i,a){let o=-e/r;for(let s=0;s<=r;s++){let e=o*s,r=Math.sin(e)*n,a=Math.cos(e)*i;t.addPoint(nu(r,a))}return e<tu?a>0?au(t,n,i,a):t.addPoint(nu(0,0)):(t.removePoint(t.points[t.points.length-1]),a>0&&ou(t,n,i,a)),1}function nu(t,e){return new Gh(n.MathUtils.generateUUID(),new n.Vector2(t,e))}function iu(t,e,r,n,i,a){let o=nu(t,e);return o.controls[0].position.set(r,n),o.controls[1].position.set(i,a),o}function au(t,e,r,n){su(t,e,r,n).forEach((e=>t.addPoint(e)))}function ou(t,e,r,n){let i=su(t,e,r,n),a=new _c;i.forEach((t=>a.addPoint(t))),a.isClosed=!0,t.shapeHoles.push(a)}function su(t,e,r,i){let a=i*e/100,o=a*(Math.abs(r)/Math.abs(e)),s=new n.Vector2(a/e,o/r),l=t.points.map((t=>{let e=t.clone();return e.uuid=n.MathUtils.generateUUID(),e})).reverse();return l.forEach((t=>{t.position.multiply(s);let e=t.controls[0].position.clone().multiply(s),r=t.controls[1].position.clone().multiply(s);t.controls[0].position.copy(r),t.controls[1].position.copy(e)})),l}var lu=new n.Uint32BufferAttribute([0,0,0],1),hu=class extends n.BufferGeometry{constructor(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,o=arguments.length>7&&void 0!==arguments[7]?arguments[7]:1,s=arguments.length>9&&void 0!==arguments[9]?arguments[9]:1,l=arguments.length>10&&void 0!==arguments[10]?arguments[10]:1,h=arguments.length>11&&void 0!==arguments[11]?arguments[11]:1;if(super(),0===i)return;let c=t&&1===i;c&&(h=0),l>100&&(l=100),0===l&&(h=0);let u,d,p,f,m,v,g,y,b=()=>new n.Vector3,x=new n.Vector3,w=b(),_=b(),S=b(),A=b(),M=b(),C=b(),O=b(),D=b(),P=b(),T=b(),z=b(),E=e-2*o+.001,I=E/i,L=Math.ceil(a*i),B=L+1,k=E/L,V=-E/2,U=s+1,j=2*Math.PI/s,N=Math.PI/2/h,R=Math.min((1-l/100)*o,o-.01),F=o-R,G=0,q=2*h+2,H=U*q/2,W=H+U*B,X=Math.max(0,U*(B+q)),[Y,Q,Z]=[3,3,2].map((t=>Array(X*t).fill(0))),K=[],J=r-o;function $(e,r){let n=Math.PI/2;v=r*k,y=2*Math.PI*(v%I)/I+n,v+=V,g=Math.sin(y)*J,m=Math.cos(y)*J,t?e.set(m,g,v):e.set(m,v,g)}$(x,-1e-10),$(w,0),A.copy(x),$(x,1);let tt=x.distanceTo(w),et=c?0:F+R,rt=tt*L+2*et,nt=R,it=rt-et;for(let n=0;n<=L;n++){$(_,n),z.subVectors(_,A).normalize(),A.copy(_),P.copy(_).setComponent(+t+1,0).normalize(),T.crossVectors(z,P).normalize();let e=0===n,r=n===L,i=e?3*Math.PI/2:N,a=e?nt:it,l=e?U:W,u=e?0:X-U,d=z.clone().multiplyScalar(e?-F:F).add(_),p=z.clone().multiplyScalar(e?-1:1).normalize();for(let t=0;t<U;t++){let f=t*j;if(M.addVectors(x.copy(P).multiplyScalar(o*Math.cos(f)),w.copy(T).multiplyScalar(o*Math.sin(f))),C.copy(M).normalize(),e||r){c||(G=u+t,[0,1,2].forEach((t=>{Y[3*G+t]=d.getComponent(t),Q[3*G+t]=p.getComponent(t)})),Z[2*G]=+r,Z[2*G+1]=t/s),w.copy(C).multiplyScalar(R),S.addVectors(_,w);for(let r=0;r<h;r++){let n=r*N+i;O.addVectors(x.copy(z).multiplyScalar(F*Math.sin(n)),w.copy(C).multiplyScalar(F*Math.cos(n))),D.copy(O).normalize(),w.addVectors(S,O),O.normalize(),G=l+r*U+t,[0,1,2].forEach((t=>{Y[3*G+t]=w.getComponent(t),Q[3*G+t]=D.getComponent(t)}));let o=+e+Math.sin(n);Z[2*G]=(a+F*o)/rt,Z[2*G+1]=t/s}}w.addVectors(_,M),G=H+n*U+t,[0,1,2].forEach((t=>{Y[3*G+t]=w.getComponent(t),Q[3*G+t]=C.getComponent(t)})),Z[2*G]=(et+n*tt)/rt,Z[2*G+1]=t/s}}let at=B+2*h+2,[ot,st]=[+c,at-1];for(let n=ot;n<=st-1;n++){let t=c&&n===st-1;for(let e=0;e<U-1;e++)u=n*U+e,d=u+1,p=(t?e:u)+U,f=(t?e+1:d)+U,0===n?K.push(d,f,p):n===at-2?K.push(u,d,p):K.push(u,d,p,d,f,p)}this.setIndex(K),this.setAttribute("position",new n.Float32BufferAttribute(Y,3)),this.setAttribute("normal",new n.Float32BufferAttribute(Q,3)),this.setAttribute("uv",new n.Float32BufferAttribute(Z,2))}getClosedTorusIndicesForBooleanOrSubdiv(){let t,e,r,n,i=this.userData.parameters,a=Math.ceil(i.tubularSegments),o=i.radialSegments+1,s=Array.from(this.getIndex().array),l=6*(a-1)*i.radialSegments,h=a,c=h===a;for(let u=0;u<i.radialSegments;u++)t=h*o+u,e=t+1,r=(c?u:t)+o,n=(c?u+1:e)+o,s[l++]=t,s[l++]=e,s[l++]=r,s[l++]=e,s[l++]=n,s[l++]=r;return s.length=l,lu.array=s,lu.count=s.length,lu}},cu=class extends Uh{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.2,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:4,n=(1+Math.sqrt(5))/2,i="IcosahedronGeometry";super([-1,n,0,1,n,0,-1,-n,0,1,-n,0,0,-1,n,0,1,n,0,-1,-n,0,1,-n,n,0,-1,n,0,1,-n,0,-1,-n,0,1],[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],i,t,e,r),this.type=i}static fromJSON(t){return new cu(t.radius,t.corner,t.cornerSides)}},uu=new n.Matrix4,du=new n.Object3D,pu=new n.Vector3,fu=class extends n.EventDispatcher{constructor(){super(),this.uuid=n.MathUtils.generateUUID(),this.name="",this.type="Geometry",this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.elementsNeedUpdate=!1,this.verticesNeedUpdate=!1,this.uvsNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.lineDistancesNeedUpdate=!1,this.groupsNeedUpdate=!1}applyMatrix4(t){let e=(new n.Matrix3).getNormalMatrix(t);for(let r=0,n=this.vertices.length;r<n;r++)this.vertices[r].applyMatrix4(t);for(let r=0,n=this.faces.length;r<n;r++){let t=this.faces[r];t.normal.applyMatrix3(e).normalize();for(let r=0,n=t.vertexNormals.length;r<n;r++)t.vertexNormals[r].applyMatrix3(e).normalize()}return null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this.verticesNeedUpdate=!0,this.normalsNeedUpdate=!0,this}rotateX(t){return uu.makeRotationX(t),this.applyMatrix4(uu),this}rotateY(t){return uu.makeRotationY(t),this.applyMatrix4(uu),this}rotateZ(t){return uu.makeRotationZ(t),this.applyMatrix4(uu),this}translate(t,e,r){return uu.makeTranslation(t,e,r),this.applyMatrix4(uu),this}scale(t,e,r){return uu.makeScale(t,e,r),this.applyMatrix4(uu),this}lookAt(t){return du.lookAt(t),du.updateMatrix(),this.applyMatrix4(du.matrix),this}fromBufferGeometry(t){let e=this,r=null!==t.index?t.index:void 0,i=t.attributes;if(void 0===i.position)return console.error("THREE.Geometry.fromBufferGeometry(): Position attribute required for conversion."),this;let a=i.position,o=i.normal,s=i.color,l=i.uv,h=i.uv2;void 0!==h&&(this.faceVertexUvs[1]=[]);for(let d=0;d<a.count;d++)e.vertices.push((new n.Vector3).fromBufferAttribute(a,d)),void 0!==s&&e.colors.push((new n.Color).fromBufferAttribute(s,d));function c(t,r,i,a){let c=void 0===s?[]:[e.colors[t].clone(),e.colors[r].clone(),e.colors[i].clone()],u=void 0===o?[]:[(new n.Vector3).fromBufferAttribute(o,t),(new n.Vector3).fromBufferAttribute(o,r),(new n.Vector3).fromBufferAttribute(o,i)],d=new vu(t,r,i,u,c,a);e.faces.push(d),void 0!==l&&e.faceVertexUvs[0].push([(new n.Vector2).fromBufferAttribute(l,t),(new n.Vector2).fromBufferAttribute(l,r),(new n.Vector2).fromBufferAttribute(l,i)]),void 0!==h&&e.faceVertexUvs[1].push([(new n.Vector2).fromBufferAttribute(h,t),(new n.Vector2).fromBufferAttribute(h,r),(new n.Vector2).fromBufferAttribute(h,i)])}let u=t.groups;if(u.length>0)for(let n=0;n<u.length;n++){let t=u[n],e=t.start;for(let n=e,i=e+t.count;n<i;n+=3)void 0!==r?c(r.getX(n),r.getX(n+1),r.getX(n+2),t.materialIndex):c(n,n+1,n+2,t.materialIndex)}else if(void 0!==r)for(let n=0;n<r.count;n+=3)c(r.getX(n),r.getX(n+1),r.getX(n+2));else for(let n=0;n<a.count;n+=3)c(n,n+1,n+2);return this.computeFaceNormals(),null!==t.boundingBox&&(this.boundingBox=t.boundingBox.clone()),null!==t.boundingSphere&&(this.boundingSphere=t.boundingSphere.clone()),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(pu).negate(),this.translate(pu.x,pu.y,pu.z),this}normalize(){this.computeBoundingSphere();let t=this.boundingSphere.center,e=this.boundingSphere.radius,r=0===e?1:1/e,i=new n.Matrix4;return i.set(r,0,0,-r*t.x,0,r,0,-r*t.y,0,0,r,-r*t.z,0,0,0,1),this.applyMatrix4(i),this}computeFaceNormals(){let t=new n.Vector3,e=new n.Vector3;for(let r=0,n=this.faces.length;r<n;r++){let n=this.faces[r],i=this.vertices[n.a],a=this.vertices[n.b],o=this.vertices[n.c];t.subVectors(o,a),e.subVectors(i,a),t.cross(e),t.normalize(),n.normal.copy(t)}}computeVertexNormals(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],e=new Array(this.vertices.length);for(let r=0,i=this.vertices.length;r<i;r++)e[r]=new n.Vector3;if(t){let t=new n.Vector3,r=new n.Vector3;for(let n=0,i=this.faces.length;n<i;n++){let i=this.faces[n],a=this.vertices[i.a],o=this.vertices[i.b],s=this.vertices[i.c];t.subVectors(s,o),r.subVectors(a,o),t.cross(r),e[i.a].add(t),e[i.b].add(t),e[i.c].add(t)}}else{this.computeFaceNormals();for(let t=0,r=this.faces.length;t<r;t++){let r=this.faces[t];e[r.a].add(r.normal),e[r.b].add(r.normal),e[r.c].add(r.normal)}}for(let r=0,n=this.vertices.length;r<n;r++)e[r].normalize();for(let r=0,n=this.faces.length;r<n;r++){let t=this.faces[r],n=t.vertexNormals;3===n.length?(n[0].copy(e[t.a]),n[1].copy(e[t.b]),n[2].copy(e[t.c])):(n[0]=e[t.a].clone(),n[1]=e[t.b].clone(),n[2]=e[t.c].clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)}computeFlatVertexNormals(){this.computeFaceNormals();for(let t=0,e=this.faces.length;t<e;t++){let e=this.faces[t],r=e.vertexNormals;3===r.length?(r[0].copy(e.normal),r[1].copy(e.normal),r[2].copy(e.normal)):(r[0]=e.normal.clone(),r[1]=e.normal.clone(),r[2]=e.normal.clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)}computeMorphNormals(){for(let e=0,r=this.faces.length;e<r;e++){let t=this.faces[e];t.__originalFaceNormal?t.__originalFaceNormal.copy(t.normal):t.__originalFaceNormal=t.normal.clone(),t.__originalVertexNormals||(t.__originalVertexNormals=[]);for(let e=0,r=t.vertexNormals.length;e<r;e++)t.__originalVertexNormals[e]?t.__originalVertexNormals[e].copy(t.vertexNormals[e]):t.__originalVertexNormals[e]=t.vertexNormals[e].clone()}let t=new fu;t.faces=this.faces;for(let e=0,r=this.morphTargets.length;e<r;e++){if(!this.morphNormals[e]){this.morphNormals[e]={},this.morphNormals[e].faceNormals=[],this.morphNormals[e].vertexNormals=[];let t=this.morphNormals[e].faceNormals,r=this.morphNormals[e].vertexNormals;for(let e=0,i=this.faces.length;e<i;e++){let e=new n.Vector3,i={a:new n.Vector3,b:new n.Vector3,c:new n.Vector3};t.push(e),r.push(i)}}let r=this.morphNormals[e];t.vertices=this.morphTargets[e].vertices,t.computeFaceNormals(),t.computeVertexNormals();for(let t=0,e=this.faces.length;t<e;t++){let e=this.faces[t],n=r.faceNormals[t],i=r.vertexNormals[t];n.copy(e.normal),i.a.copy(e.vertexNormals[0]),i.b.copy(e.vertexNormals[1]),i.c.copy(e.vertexNormals[2])}}for(let e=0,r=this.faces.length;e<r;e++){let t=this.faces[e];t.normal=t.__originalFaceNormal,t.vertexNormals=t.__originalVertexNormals}}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new n.Box3),this.boundingBox.setFromPoints(this.vertices)}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new n.Sphere),this.boundingSphere.setFromPoints(this.vertices)}merge(t,e){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(!t||!t.isGeometry)return void console.error("THREE.Geometry.merge(): geometry not an instance of THREE.Geometry.",t);let i,a=this.vertices.length,o=this.vertices,s=t.vertices,l=this.faces,h=t.faces,c=this.colors,u=t.colors;void 0!==e&&(i=(new n.Matrix3).getNormalMatrix(e));for(let n=0,d=s.length;n<d;n++){let t=s[n].clone();void 0!==e&&t.applyMatrix4(e),o.push(t)}for(let n=0,d=u.length;n<d;n++)c.push(u[n].clone());for(let n=0,d=h.length;n<d;n++){let t,e,o=h[n],s=o.vertexNormals,c=o.vertexColors,u=new vu(o.a+a,o.b+a,o.c+a);u.normal.copy(o.normal),void 0!==i&&u.normal.applyMatrix3(i).normalize();for(let r=0,n=s.length;r<n;r++)t=s[r].clone(),void 0!==i&&t.applyMatrix3(i).normalize(),u.vertexNormals.push(t);u.color.copy(o.color);for(let r=0,n=c.length;r<n;r++)e=c[r],u.vertexColors.push(e.clone());u.materialIndex=o.materialIndex+r,l.push(u)}for(let n=0,d=t.faceVertexUvs.length;n<d;n++){let e=t.faceVertexUvs[n];void 0===this.faceVertexUvs[n]&&(this.faceVertexUvs[n]=[]);for(let t=0,r=e.length;t<r;t++){let r=e[t],i=[];for(let t=0,e=r.length;t<e;t++)i.push(r[t].clone());this.faceVertexUvs[n].push(i)}}}mergeMesh(t){t&&t.isMesh?(t.matrixAutoUpdate&&t.updateMatrix(),this.merge(t.geometry,t.matrix)):console.error("THREE.Geometry.mergeMesh(): mesh not an instance of THREE.Mesh.",t)}mergeVertices(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:4,e={},r=[],n=[],i=Math.pow(10,t);for(let s=0,l=this.vertices.length;s<l;s++){let t=this.vertices[s],a=Math.round(t.x*i)+"_"+Math.round(t.y*i)+"_"+Math.round(t.z*i);void 0===e[a]?(e[a]=s,r.push(this.vertices[s]),n[s]=r.length-1):n[s]=n[e[a]]}let a=[];for(let s=0,l=this.faces.length;s<l;s++){let t=this.faces[s];t.a=n[t.a],t.b=n[t.b],t.c=n[t.c];let e=[t.a,t.b,t.c];for(let r=0;r<3;r++)if(e[r]===e[(r+1)%3]){a.push(s);break}}for(let s=a.length-1;s>=0;s--){let t=a[s];this.faces.splice(t,1);for(let e=0,r=this.faceVertexUvs.length;e<r;e++)this.faceVertexUvs[e].splice(t,1)}let o=this.vertices.length-r.length;return this.vertices=r,o}setFromPoints(t){this.vertices=[];for(let e=0,r=t.length;e<r;e++){let r=t[e];this.vertices.push(new n.Vector3(r.x,r.y,r.z||0))}return this}sortFacesByMaterialIndex(){let t=this.faces,e=t.length;for(let o=0;o<e;o++)t[o]._id=o;t.sort((function(t,e){return t.materialIndex-e.materialIndex}));let r,n,i=this.faceVertexUvs[0],a=this.faceVertexUvs[1];i&&i.length===e&&(r=[]),a&&a.length===e&&(n=[]);for(let o=0;o<e;o++){let e=t[o]._id;r&&r.push(i[e]),n&&n.push(a[e])}r&&(this.faceVertexUvs[0]=r),n&&(this.faceVertexUvs[1]=n)}toJSON(){let t={metadata:{version:4.5,type:"Geometry",generator:"Geometry.toJSON"}};if(t.uuid=this.uuid,t.type=this.type,""!==this.name&&(t.name=this.name),void 0!==this.parameters){let e=this.parameters;for(let r in e)void 0!==e[r]&&(t[r]=e[r]);return t}let e=[];for(let p=0;p<this.vertices.length;p++){let t=this.vertices[p];e.push(t.x,t.y,t.z)}let r=[],n=[],i={},a=[],o={},s=[],l={};for(let p=0;p<this.faces.length;p++){let t=this.faces[p],e=!0,n=!1,i=void 0!==this.faceVertexUvs[0][p],a=t.normal.length()>0,o=t.vertexNormals.length>0,s=1!==t.color.r||1!==t.color.g||1!==t.color.b,l=t.vertexColors.length>0,f=0;if(f=h(f,0,0),f=h(f,1,e),f=h(f,2,n),f=h(f,3,i),f=h(f,4,a),f=h(f,5,o),f=h(f,6,s),f=h(f,7,l),r.push(f),r.push(t.a,t.b,t.c),r.push(t.materialIndex),i){let t=this.faceVertexUvs[0][p];r.push(d(t[0]),d(t[1]),d(t[2]))}if(a&&r.push(c(t.normal)),o){let e=t.vertexNormals;r.push(c(e[0]),c(e[1]),c(e[2]))}if(s&&r.push(u(t.color)),l){let e=t.vertexColors;r.push(u(e[0]),u(e[1]),u(e[2]))}}function h(t,e,r){return r?t|1<<e:t&~(1<<e)}function c(t){let e=t.x.toString()+t.y.toString()+t.z.toString();return void 0!==i[e]||(i[e]=n.length/3,n.push(t.x,t.y,t.z)),i[e]}function u(t){let e=t.r.toString()+t.g.toString()+t.b.toString();return void 0!==o[e]||(o[e]=a.length,a.push(t.getHex())),o[e]}function d(t){let e=t.x.toString()+t.y.toString();return void 0!==l[e]||(l[e]=s.length/2,s.push(t.x,t.y)),l[e]}return t.data={},t.data.vertices=e,t.data.normals=n,a.length>0&&(t.data.colors=a),s.length>0&&(t.data.uvs=[s]),t.data.faces=r,t}clone(){return(new fu).copy(this)}copy(t){this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.name=t.name;let e=t.vertices;for(let u=0,d=e.length;u<d;u++)this.vertices.push(e[u].clone());let r=t.colors;for(let u=0,d=r.length;u<d;u++)this.colors.push(r[u].clone());let n=t.faces;for(let u=0,d=n.length;u<d;u++)this.faces.push(n[u].clone());for(let u=0,d=t.faceVertexUvs.length;u<d;u++){let e=t.faceVertexUvs[u];void 0===this.faceVertexUvs[u]&&(this.faceVertexUvs[u]=[]);for(let t=0,r=e.length;t<r;t++){let r=e[t],n=[];for(let t=0,e=r.length;t<e;t++){let e=r[t];n.push(e.clone())}this.faceVertexUvs[u].push(n)}}let i=t.morphTargets;for(let u=0,d=i.length;u<d;u++){let t={};if(t.name=i[u].name,void 0!==i[u].vertices){t.vertices=[];for(let e=0,r=i[u].vertices.length;e<r;e++)t.vertices.push(i[u].vertices[e].clone())}if(void 0!==i[u].normals){t.normals=[];for(let e=0,r=i[u].normals.length;e<r;e++)t.normals.push(i[u].normals[e].clone())}this.morphTargets.push(t)}let a=t.morphNormals;for(let u=0,d=a.length;u<d;u++){let t={};if(void 0!==a[u].vertexNormals){t.vertexNormals=[];for(let e=0,r=a[u].vertexNormals.length;e<r;e++){let r=a[u].vertexNormals[e],n={};n.a=r.a.clone(),n.b=r.b.clone(),n.c=r.c.clone(),t.vertexNormals.push(n)}}if(void 0!==a[u].faceNormals){t.faceNormals=[];for(let e=0,r=a[u].faceNormals.length;e<r;e++)t.faceNormals.push(a[u].faceNormals[e].clone())}this.morphNormals.push(t)}let o=t.skinWeights;for(let u=0,d=o.length;u<d;u++)this.skinWeights.push(o[u].clone());let s=t.skinIndices;for(let u=0,d=s.length;u<d;u++)this.skinIndices.push(s[u].clone());let l=t.lineDistances;for(let u=0,d=l.length;u<d;u++)this.lineDistances.push(l[u]);let h=t.boundingBox;null!==h&&(this.boundingBox=h.clone());let c=t.boundingSphere;return null!==c&&(this.boundingSphere=c.clone()),this.elementsNeedUpdate=t.elementsNeedUpdate,this.verticesNeedUpdate=t.verticesNeedUpdate,this.uvsNeedUpdate=t.uvsNeedUpdate,this.normalsNeedUpdate=t.normalsNeedUpdate,this.colorsNeedUpdate=t.colorsNeedUpdate,this.lineDistancesNeedUpdate=t.lineDistancesNeedUpdate,this.groupsNeedUpdate=t.groupsNeedUpdate,this}toBufferGeometry(){let t=(new mu).fromGeometry(this),e=new n.BufferGeometry,r=new Float32Array(3*t.vertices.length);if(e.setAttribute("position",xu.call(new n.BufferAttribute(r,3),t.vertices)),t.normals.length>0){let r=new Float32Array(3*t.normals.length);e.setAttribute("normal",xu.call(new n.BufferAttribute(r,3),t.normals))}if(t.colors.length>0){let r=new Float32Array(3*t.colors.length);e.setAttribute("color",yu.call(new n.BufferAttribute(r,3),t.colors))}if(t.uvs.length>0){let r=new Float32Array(2*t.uvs.length);e.setAttribute("uv",bu.call(new n.BufferAttribute(r,2),t.uvs))}if(t.uvs2.length>0){let r=new Float32Array(2*t.uvs2.length);e.setAttribute("uv2",bu.call(new n.BufferAttribute(r,2),t.uvs2))}e.groups=t.groups;for(let i in t.morphTargets){let r=[],a=t.morphTargets[i];for(let t=0,e=a.length;t<e;t++){let e=a[t],i=new n.Float32BufferAttribute(3*e.data.length,3);i.name=e.name,r.push(xu.call(i,e.data))}e.morphAttributes[i]=r}if(t.skinIndices.length>0){let r=new n.Float32BufferAttribute(4*t.skinIndices.length,4);e.setAttribute("skinIndex",wu.call(r,t.skinIndices))}if(t.skinWeights.length>0){let r=new n.Float32BufferAttribute(4*t.skinWeights.length,4);e.setAttribute("skinWeight",wu.call(r,t.skinWeights))}return null!==t.boundingSphere&&(e.boundingSphere=t.boundingSphere.clone()),null!==t.boundingBox&&(e.boundingBox=t.boundingBox.clone()),e}computeTangents(){console.error("THREE.Geometry: .computeTangents() has been removed.")}computeLineDistances(){console.error("THREE.Geometry: .computeLineDistances() has been removed. Use THREE.Line.computeLineDistances() instead.")}applyMatrix(t){return console.warn("THREE.Geometry: .applyMatrix() has been renamed to .applyMatrix4()."),this.applyMatrix4(t)}dispose(){this.dispatchEvent({type:"dispose"})}static createBufferGeometryFromObject(t){let e=new n.BufferGeometry,r=t.geometry;if(t.isPoints||t.isLine){let t=new n.Float32BufferAttribute(3*r.vertices.length,3),i=new n.Float32BufferAttribute(3*r.colors.length,3);if(e.setAttribute("position",xu.call(t,r.vertices)),e.setAttribute("color",yu.call(i,r.colors)),r.lineDistances&&r.lineDistances.length===r.vertices.length){let t=new n.Float32BufferAttribute(r.lineDistances.length,1);e.setAttribute("lineDistance",gu.call(t,r.lineDistances))}null!==r.boundingSphere&&(e.boundingSphere=r.boundingSphere.clone()),null!==r.boundingBox&&(e.boundingBox=r.boundingBox.clone())}else t.isMesh&&(e=r.toBufferGeometry());return e}};fu.prototype.isGeometry=!0;var mu=class{constructor(){this.vertices=[],this.normals=[],this.colors=[],this.uvs=[],this.uvs2=[],this.groups=[],this.morphTargets={},this.skinWeights=[],this.skinIndices=[],this.boundingBox=null,this.boundingSphere=null,this.verticesNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.uvsNeedUpdate=!1,this.groupsNeedUpdate=!1}computeGroups(t){let e,r,n,i=[],a=t.faces;for(r=0;r<a.length;r++){let t=a[r];t.materialIndex!==n&&(n=t.materialIndex,void 0!==e&&(e.count=3*r-e.start,i.push(e)),e={start:3*r,materialIndex:n})}void 0!==e&&(e.count=3*r-e.start,i.push(e)),this.groups=i}fromGeometry(t){let e,r=t.faces,i=t.vertices,a=t.faceVertexUvs,o=a[0]&&a[0].length>0,s=a[1]&&a[1].length>0,l=t.morphTargets,h=l.length;if(h>0){e=[];for(let t=0;t<h;t++)e[t]={name:l[t].name,data:[]};this.morphTargets.position=e}let c,u=t.morphNormals,d=u.length;if(d>0){c=[];for(let t=0;t<d;t++)c[t]={name:u[t].name,data:[]};this.morphTargets.normal=c}let p=t.skinIndices,f=t.skinWeights,m=p.length===i.length,v=f.length===i.length;i.length>0&&0===r.length&&console.error("THREE.DirectGeometry: Faceless geometries are not supported.");for(let g=0;g<r.length;g++){let t=r[g];this.vertices.push(i[t.a],i[t.b],i[t.c]);let y=t.vertexNormals;if(3===y.length)this.normals.push(y[0],y[1],y[2]);else{let e=t.normal;this.normals.push(e,e,e)}let b=t.vertexColors;if(3===b.length)this.colors.push(b[0],b[1],b[2]);else{let e=t.color;this.colors.push(e,e,e)}if(!0===o){let t=a[0][g];void 0!==t?this.uvs.push(t[0],t[1],t[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv ",g),this.uvs.push(new n.Vector2,new n.Vector2,new n.Vector2))}if(!0===s){let t=a[1][g];void 0!==t?this.uvs2.push(t[0],t[1],t[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv2 ",g),this.uvs2.push(new n.Vector2,new n.Vector2,new n.Vector2))}for(let r=0;r<h;r++){let n=l[r].vertices;e[r].data.push(n[t.a],n[t.b],n[t.c])}for(let e=0;e<d;e++){let t=u[e].vertexNormals[g];c[e].data.push(t.a,t.b,t.c)}m&&this.skinIndices.push(p[t.a],p[t.b],p[t.c]),v&&this.skinWeights.push(f[t.a],f[t.b],f[t.c])}return this.computeGroups(t),this.verticesNeedUpdate=t.verticesNeedUpdate,this.normalsNeedUpdate=t.normalsNeedUpdate,this.colorsNeedUpdate=t.colorsNeedUpdate,this.uvsNeedUpdate=t.uvsNeedUpdate,this.groupsNeedUpdate=t.groupsNeedUpdate,null!==t.boundingSphere&&(this.boundingSphere=t.boundingSphere.clone()),null!==t.boundingBox&&(this.boundingBox=t.boundingBox.clone()),this}},vu=class{constructor(t,e,r,i,a){let o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;this.a=t,this.b=e,this.c=r,this.normal=i&&i.isVector3?i:new n.Vector3,this.vertexNormals=Array.isArray(i)?i:[],this.color=a&&a.isColor?a:new n.Color,this.vertexColors=Array.isArray(a)?a:[],this.materialIndex=o}clone(){return(new this.constructor).copy(this)}copy(t){this.a=t.a,this.b=t.b,this.c=t.c,this.normal.copy(t.normal),this.color.copy(t.color),this.materialIndex=t.materialIndex;for(let e=0,r=t.vertexNormals.length;e<r;e++)this.vertexNormals[e]=t.vertexNormals[e].clone();for(let e=0,r=t.vertexColors.length;e<r;e++)this.vertexColors[e]=t.vertexColors[e].clone();return this}};function gu(t){return this.array.set(t),this}function yu(t){let e=this.array,r=0;for(let i=0,a=t.length;i<a;i++){let a=t[i];void 0===a&&(console.warn("THREE.BufferAttribute.copyColorsArray(): color is undefined",i),a=new n.Color),e[r++]=a.r,e[r++]=a.g,e[r++]=a.b}return this}function bu(t){let e=this.array,r=0;for(let i=0,a=t.length;i<a;i++){let a=t[i];void 0===a&&(console.warn("THREE.BufferAttribute.copyVector2sArray(): vector is undefined",i),a=new n.Vector2),e[r++]=a.x,e[r++]=a.y}return this}function xu(t){let e=this.array,r=0;for(let i=0,a=t.length;i<a;i++){let a=t[i];void 0===a&&(console.warn("THREE.BufferAttribute.copyVector3sArray(): vector is undefined",i),a=new n.Vector3),e[r++]=a.x,e[r++]=a.y,e[r++]=a.z}return this}function wu(t){let e=this.array,r=0;for(let i=0,a=t.length;i<a;i++){let a=t[i];void 0===a&&(console.warn("THREE.BufferAttribute.copyVector4sArray(): vector is undefined",i),a=new n.Vector4),e[r++]=a.x,e[r++]=a.y,e[r++]=a.z,e[r++]=a.w}return this}var _u=["a","b","c"];function Su(t,e){switch(e){case"c":return t.c;case"b":return t.b;default:return t.a}}function Au(t,e,r){let n=Math.min(t,e)+"_"+Math.max(t,e);return r.get(n)}function Mu(t,e,r,n,i,a){let o,s=Math.min(t,e),l=Math.max(t,e),h=s+"_"+l;if(n.has(h))o=n.get(h);else{o={a:r[s],b:r[l],newEdge:null,faces:[]},n.set(h,o)}o.faces.push(i),a[t].edges.push(o),a[e].edges.push(o)}function Cu(t,e,r,n,i){t.push(new vu(e,r,n,void 0,void 0,i))}function Ou(t,e){return Math.abs(e-t)/2+Math.min(t,e)}function Du(t,e,r,n){t.push([e.clone(),r.clone(),n.clone()])}var Pu=class{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this.subdivisions=t}modify(t){(t=t instanceof n.BufferGeometry?(new fu).fromBufferGeometry(t):t.clone()).mergeVertices();let e=this.subdivisions;for(;e-- >0;)this._smooth(t);return t.computeFaceNormals(),t.computeVertexNormals(),t}_smooth(t){let e,r,i,a,o,s=new n.Vector3,l=t.vertices,h=t.faces,c=t.faceVertexUvs[0],u=void 0!==c&&c.length>0,d=[],p=new Map;!function(t,e,r,n){let i,a,o;for(i=0,a=t.length;i<a;i++)r[i]={edges:[]};for(i=0,a=e.length;i<a;i++)o=e[i],Mu(o.a,o.b,t,n,o,r),Mu(o.b,o.c,t,n,o,r),Mu(o.c,o.a,t,n,o,r)}(l,h,d,p);let f,m,v,g,y,b,x,w=[];for(let q of Array.from(p.keys())){for(m=p.get(q),v=new n.Vector3,y=3/8,b=1/8,x=m.faces.length,2!=x&&(y=.5,b=0),v.addVectors(m.a,m.b).multiplyScalar(y),s.set(0,0,0),a=0;a<x;a++){for(g=m.faces[a],o=0;o<3&&(f=l[Su(g,_u[o])],f===m.a||f===m.b);o++);f&&s.add(f)}s.multiplyScalar(b),v.add(s),m.newEdge=w.length,w.push(v)}let _,S,A,M,C,O,D,P=[];for(r=0,i=l.length;r<i;r++){for(O=l[r],C=d[r].edges,e=C.length,3==e?_=3/16:e>3&&(_=3/(8*e)),S=1-e*Number(_),A=_,e<=2&&(2==e&&(S=3/4,A=1/8)),D=O.clone().multiplyScalar(S),s.set(0,0,0),a=0;a<e;a++)M=C[a],f=M.a!==O?M.a:M.b,s.add(f);s.multiplyScalar(Number(A)),D.add(s),P.push(D)}let T,z,E,I,L,B,k,V=P.concat(w),U=P.length,j=[],N=[],R=new n.Vector2,F=new n.Vector2,G=new n.Vector2;for(r=0,i=h.length;r<i;r++)g=h[r],T=Number(Au(g.a,g.b,p).newEdge)+U,z=Number(Au(g.b,g.c,p).newEdge)+U,E=Number(Au(g.c,g.a,p).newEdge)+U,Cu(j,T,z,E,g.materialIndex),Cu(j,g.a,T,E,g.materialIndex),Cu(j,g.b,z,T,g.materialIndex),Cu(j,g.c,E,z,g.materialIndex),u&&(I=c[r],L=I[0],B=I[1],k=I[2],R.set(Ou(L.x,B.x),Ou(L.y,B.y)),F.set(Ou(B.x,k.x),Ou(B.y,k.y)),G.set(Ou(L.x,k.x),Ou(L.y,k.y)),Du(N,R,F,G),Du(N,L,R,G),Du(N,B,F,R),Du(N,k,G,F));t.vertices=V,t.faces=j,u&&(t.faceVertexUvs[0]=N)}},Tu=new n.Vector3,zu=class{static create(t){return this.build(this.normalizeInputs(t))}static normalizeInputs(t,e){var r,n,i;let a=Object.assign({},null!==(r=null===e||void 0===e?void 0:e.parameters)&&void 0!==r?r:{width:100,depth:0,spikes:5,cornerRadius:0,extrudeBevelSize:0,extrudeBevelSegments:3},t.parameters);return{shape:t.shape&&t.shape instanceof _c?t.shape:new _c,parameters:Object.assign(a,{width:Math.abs(a.width),height:Math.abs(null!==(n=a.height)&&void 0!==n?n:a.width),depth:Math.abs(null!==(i=a.depth)&&void 0!==i?i:0)})}}static build(t){let{width:e,height:r,spikes:n,cornerRadius:i,depth:a,extrudeBevelSize:o,extrudeBevelSegments:s}=t.parameters,l=t.shape,h=.5*e,c=.5*r,u=2*Math.PI/n;for(let p=0;p<n;p++){let t=u*p,e=0+Math.sin(t)*h,r=0+Math.cos(t)*c;l.addPoint(l.createPoint(e,r))}l.isClosed=!0;for(let p=0,f=l.points.length;p<f;p++)l.points[p].roundness=i;l.roundness=i,l.update();let d=$c.create({shape:l,parameters:{roundness:i,depth:a,extrudeBevelSize:o,extrudeBevelSegments:s}});return Object.assign(d,{userData:{...t,type:"PolygonGeometry"}})}};function Eu(t,e,r){r.x=t.x*e.x,r.y=t.y,r.z=t.x*e.y}function Iu(t,e,r,n,i,a){let o=e.clone().sub(t),s=r.clone().sub(t),l=o.angleTo(s);if(o.normalize(),s.normalize(),n===i){let e=o.add(s).normalize();a.copy(t).addScaledVector(e,n/Math.sin(l/2))}else{let e=o.angleTo(s);a.copy(t),a.addScaledVector(o,i/Math.sin(e)),a.addScaledVector(s,n/Math.sin(e))}}function Lu(t,e,r){let n=t.clone().sub(e),i=r.clone().sub(e);return n.projectOnVector(i),n.add(e)}var Bu=class extends n.BufferGeometry{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:4,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:4;super(),r=Math.floor(Math.max(3,r)),i=Math.floor(i),s=Math.floor(s);let l,h=[],c=[],u=[],d=[],p=0,f=e/2,m=Math.PI/r,v=t*Math.cos(Math.PI/r),g=2*Math.PI/r,y=(r-2)*Math.PI/r,b=Math.PI-y,x=new n.Vector3(0,-f,0),w=new n.Vector3(0,f,0),_=new n.Vector2(t,-f),S=new n.Vector2(v,-f),A=new n.Vector2(0,w.y).sub(S),M=new n.Vector2(0,w.y).sub(_),C=new n.Vector2(A.y,-A.x).normalize(),O=new n.Vector2(M.y,-M.x).normalize(),D=t*Math.cos(Math.PI/r)*Math.tan((Math.PI-A.angle())/2)-1e-8;o=Math.min(o,D);{let t=new n.Vector3(C.x,C.y,0),e=new n.Vector3(Math.cos(g)*t.x,t.y,Math.sin(g)*t.x);l=t.angleTo(e)}let P=o/Math.tan((Math.PI-A.angle())/2),T=o/Math.tan((Math.PI-l)/2),z=new n.Vector3;if(!a){c.push(x.x,x.y,x.z),u.push(0,-1,0),d.push(0,0);let t=p++,e=[],i=_.clone(),a=P/Math.cos(Math.PI/r);i.x-=a;for(let o=0;o<r;o++){let t=o/r*Math.PI*2+m;Eu(i,new n.Vector2(Math.sin(t),Math.cos(t)),z),c.push(z.x,z.y,z.z),u.push(0,-1,0),d.push(0,0),e.push(p++)}for(let r=0;r<e.length;r++)h.push(e[r],t,e[(r+1)%e.length])}let E=[];{let t=new n.Vector3,e=new n.Vector3,i=new n.Vector3,a=new n.Vector3,f=new n.Vector3,v=new n.Vector3;for(let g=0;g<r;g++){let y=g/r*Math.PI*2+m,b=(g+.5)/r*Math.PI*2+m,S=(g+1)/r*Math.PI*2+m,M=new n.Vector2(Math.sin(y),Math.cos(y)),D=new n.Vector2(Math.sin(b),Math.cos(b)),z=new n.Vector2(Math.sin(S),Math.cos(S));Eu(_,M,e),Eu(_,z,i),Eu(C,D,t),Iu(w,e,i,T,T,a),c.push(a.x,a.y,a.z),Iu(e,w,i,T,P,f),c.push(f.x,f.y,f.z),Iu(i,e,w,P,T,v),c.push(v.x,v.y,v.z),u.push(t.x,t.y,t.z),u.push(t.x,t.y,t.z),u.push(t.x,t.y,t.z),d.push(0,0),d.push(0,0),d.push(0,0);let B=p++,k=p++,V=p++;if(h.push(B,k,V),o>0){{let t=e.clone().add(i).multiplyScalar(.5),r=w.clone().sub(t).normalize(),n=x.clone().sub(t).normalize().add(r).normalize().multiplyScalar(-1);I(t,v.clone().sub(f),n,A.angle())}let m,g;{let t=new n.Vector3;Eu(O,z,t);let e=v.clone().add(a).multiplyScalar(.5);e=Lu(e,i,w);let r=v.clone().sub(a);[m,g]=I(e,r,t,l,a.y)}{let t=m,e=t.clone().setY(0).normalize(),r=new n.Vector3(0,-1,0),i=e.clone().cross(r);L(t,e,r,i)}E.concat(g);{let e=A.angle(),i=Math.PI-e,a=w.clone();a.y-=o/Math.sin(e-Math.PI/2);let l=new n.Vector3,f=[];for(let n=0;n<s;n++){let e=[],h=Math.PI/2-i*n/s,m=Math.cos(h),v=Math.sin(h),g=b;for(let i=0;i<=n;i++){let i=Math.cos(g),s=Math.sin(g);t.x=m*s,t.y=v,t.z=m*i,l.copy(a).addScaledVector(t,o),c.push(l.x,l.y,l.z),u.push(t.x,t.y,t.z),d.push(0,0),e.push(p++),g+=2*Math.PI/n/r}f.push(e)}g.reverse(),f.push(g);let m=f.length-1;for(let t=0;t<m;t++){let e=f[t],r=f[t+1],n=e.length-1;h.push(r[1],e[0],r[0]);for(let t=1;t<=n;t++)h.push(e[t],e[t-1],r[t]),h.push(r[t+1],e[t],r[t])}}}}}function I(t,e,r,i,a){let l=-i/2,f=(Math.PI-i)/2,m=e.clone().normalize().cross(r);t.addScaledVector(r,-o/Math.sin(f));let v=new n.Vector3,g=new n.Vector3,y=p,b=[];for(let n=0;n<=s;n++){let h=l+n/s*i;g.set(0,0,0),g.addScaledVector(m,Math.sin(h)),g.addScaledVector(r,Math.cos(h));for(let r=0;r<=1;r++){let n=r/1-.5;if(v.copy(t),v.addScaledVector(e,n),v.addScaledVector(g,o),null!=a){let t=Math.max(0,v.y-a);v.addScaledVector(e,-t/e.y)}c.push(v.x,v.y,v.z),u.push(g.x,g.y,g.z),d.push(0,0),0===r&&b.push(p),p++}}for(let n=0;n<s;n++)for(let t=0;t<1;t++){let e=y+t+2*n,r=e+2,i=r+1,a=e+1;h.push(e,r,a),h.push(r,i,a)}return[t.clone().addScaledVector(e,.5),b]}function L(t,e,r,i){let a=Math.PI/2,l=M.angle()-a,f=[],m=new n.Vector3,v=new n.Vector3;for(let n=0;n<=s;n++){let h=[],g=n/s;for(let s=0;s<=n;s++){let f=((n?s/n:0)-.5)*b,y=Math.cos(f),x=Math.sin(f),w=(a+Math.atan(Math.tan(l)*y))*g,_=Math.cos(w),S=Math.sin(w);m.set(0,0,0),m.addScaledVector(e,S*y),m.addScaledVector(r,_),m.addScaledVector(i,S*x),v.copy(t).addScaledVector(m,o),c.push(v.x,v.y,v.z),u.push(m.x,m.y,m.z),d.push(0,0),h.push(p++)}f.push(h)}let g=f.length-1;for(let n=0;n<g;n++){let t=f[n],e=f[n+1],r=t.length-1;h.push(t[0],e[1],e[0]);for(let n=1;n<=r;n++)h.push(t[n-1],t[n],e[n]),h.push(t[n],e[n+1],e[n])}}this.setIndex(h),this.setAttribute("position",new n.Float32BufferAttribute(c,3)),this.setAttribute("normal",new n.Float32BufferAttribute(u,3)),this.setAttribute("uv",new n.Float32BufferAttribute(d,2))}},ku=class{static create(t){return this.build(this.normalizeInputs(t))}static normalizeInputs(t,e){var r,n,i,a;let o=Object.assign({},null!==(r=null===e||void 0===e?void 0:e.parameters)&&void 0!==r?r:{width:100,depth:0,cornerRadius:[0,0,0,0],cornerType:1,extrudeBevelSize:0,extrudeBevelSegments:1},t.parameters),s=Object.assign(null!==(n=null===e||void 0===e?void 0:e.ui)&&void 0!==n?n:{enabledIndieCorners:!1},t.ui);return{shape:t.shape&&t.shape instanceof _c?t.shape:new _c,parameters:Object.assign(o,{width:Math.abs(o.width),height:Math.abs(null!==(i=o.height)&&void 0!==i?i:o.width),depth:Math.abs(null!==(a=o.depth)&&void 0!==a?a:0)}),ui:s}}static build(t){let e=t.shape,{width:r,height:n,cornerRadius:i,cornerType:a,depth:o,extrudeBevelSize:s,extrudeBevelSegments:l}=t.parameters,h={x:.5*r,y:.5*n},c={x:-h.x,y:-h.y},u={x:h.x,y:h.y};function d(t,e,i){return e>r&&i>n?Math.min(t*r/e,t*n/i):e>r?t*r/e:i>n?t*n/i:t}let p=[];p[0]=0===i[0]?0:d(i[0],i[0]+i[3],i[0]+i[1]),p[1]=0===i[1]?0:d(i[1],i[1]+i[2],i[1]+i[0]),p[2]=0===i[2]?0:d(i[2],i[2]+i[1],i[2]+i[3]),p[3]=0===i[3]?0:d(i[3],i[3]+i[0],i[3]+i[2]);let f=c.x,m=u.x,v=u.y,g=c.y;e.addPoint(e.createPoint(f,v)),e.addPoint(e.createPoint(m,v)),e.addPoint(e.createPoint(m,g)),e.addPoint(e.createPoint(f,g)),e.isClosed=!0;let y=!0;for(let x=0,w=e.points.length;x<w;x++)e.points[x].roundness=p[x],x>0&&p[x]!==p[x-1]&&(y=!1);y&&(e.roundness=p[0]),e.useCubicForRoundedCorners=1!==a,e.update();let b=$c.create({shape:e,parameters:{depth:o,extrudeBevelSize:s,extrudeBevelSegments:l}});return Object.assign(b,{userData:{...t,type:"RectangleGeometry"}})}},Vu=class extends n.BufferGeometry{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:90,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:10,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:24;super(),this.type="BackdropGeometry";let s=[],l=[],h=[],c=.001;0==a&&(o=1),o=Math.max(1,Math.floor(o)),a=Math.min(a,100),i=Math.min(180-c,i),i*=Math.PI/180;let u=[],d=Math.PI/2,p=function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return new n.Vector3(t,e,r)},f=p(),m=p(),[v,g,y]=[e/2,t/2,r/2],b=-g,x=+g,[w,_,S]=[p(b,-v,+y),p(b,-v,-y),p(b,+v,-y)],A=function(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return Math.sin(t-Math.PI/(+e+1))},M=function(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return Math.cos(t-Math.PI/(+e+1))};S.y=Math.sin(i)*e-v;let C=Math.cos(i)*e-y,O=w.z-c;i<=d?(S.z=Math.min(C,O),S.z==O&&(S.y-=(C-O)/Math.tan(d-i))):_.z=Math.min(_.z-C-y,w.z-c),f.subVectors(w,_),m.subVectors(S,_);let D=Math.min(f.length(),m.length())*a/100,P=D*Math.tan(i/2),T=D/Math.cos(i/2),z=f.clone().normalize().add(m.normalize()).setLength(T).add(_);f.set(0,A(i,!0),M(i,!0)),u.push([S,f.clone()]);let E=(Math.PI-i)/o;for(let n=0;n<=o;n++){let t=d+i+n*E;f.set(0,Math.sin(t)*P,Math.cos(t)*P),f.add(z),m.set(0,A(t),M(t)),u.push([f.clone(),m.clone()])}u.push([w,p(0,1,0)]);let I=Math.sin(E/2)*P*2,L=u.length-1,B=u[0][0].distanceTo(u[1][0]),k=B+I*o+u[L-1][0].distanceTo(u[L][0]);u[0].push(1);for(let n=0;n<=o;n++)u[n+1].push(1-(B+n*I)/k);u[L].push(0);let V,U,j,[N,R,F]=u[0];for(let n=1;n<u.length;n++)[V,U,j]=u[n],s.push(b,N.y,N.z,b,V.y,V.z,x,N.y,N.z,x,N.y,N.z,b,V.y,V.z,x,V.y,V.z),l.push(0,R.y,R.z,0,U.y,U.z,0,R.y,R.z,0,R.y,R.z,0,U.y,U.z,0,U.y,U.z),h.push(0,F,0,j,1,F,1,F,0,j,1,j),[N,R,F]=[V,U,j];this.setAttribute("position",new n.Float32BufferAttribute(s,3)),this.setAttribute("normal",new n.Float32BufferAttribute(l,3)),this.setAttribute("uv",new n.Float32BufferAttribute(h,2))}},Uu=class{static create(t){return this.build(this.normalizeInputs(t))}static normalizeInputs(t,e){var r,n,i;let a=Object.assign({},null!==(r=null===e||void 0===e?void 0:e.parameters)&&void 0!==r?r:{width:100,depth:0,innerRadiusPercent:38.19,spikes:5,cornerRadius:0,angle:360,extrudeBevelSize:0,extrudeBevelSegments:1},t.parameters);return{shape:t.shape&&t.shape instanceof _c?t.shape:new _c,parameters:Object.assign(a,{width:Math.abs(a.width),height:Math.abs(null!==(n=a.height)&&void 0!==n?n:a.width),depth:Math.abs(null!==(i=a.depth)&&void 0!==i?i:0)})}}static build(t){let{width:e,height:r,innerRadiusPercent:n,spikes:i,cornerRadius:a,angle:o,depth:s,extrudeBevelSize:l,extrudeBevelSegments:h}=t.parameters,c=t.shape,u=.5*e,d=.5*r,p=o*Math.PI/360/i,f=Math.PI/2*3*-1,m=u*n/100,v=d*n/100;if(3===i&&50===n){p=2*Math.PI/i;for(let t=0;t<i;t++){let e=p*t,r=0+Math.sin(e)*u,n=0+Math.cos(e)*d;c.addPoint(c.createPoint(r,n))}}else for(let y=0;y<i;y++){let t=0+Math.cos(f)*u,e=0+Math.sin(f)*d;c.addPoint(c.createPoint(t,e)),f+=p,t=0+Math.cos(f)*m,e=0+Math.sin(f)*v,c.addPoint(c.createPoint(t,e)),f+=p}c.isClosed=!0;for(let y=0,b=c.points.length;y<b;y++)c.points[y].roundness=a;c.roundness=a,c.update();let g=$c.create({shape:c,parameters:{roundness:a,depth:s,extrudeBevelSize:l,extrudeBevelSegments:h}});return Object.assign(g,{userData:{...t,type:"StarGeometry"}})}};var ju=new n.Matrix4,Nu=new n.Matrix4;var Ru=class extends n.BufferGeometry{constructor(t){super(),this.type="PathExtrusionGeometry",this.inputs=t,this.build()}_isGeometryClosed(){return this.inputs.path.isClosed&&1===this.inputs.parameters.extrusion.depth}_isOpenEnded(){let t=this.inputs.parameters.extrusion;return!(this.inputs.path.isClosed&&1===t.depth)||!function(t,e){let r=2*Math.PI;return(t%r+r)%r===(e%r+r)%r}(t.twist,0)||t.startScale!==t.endScale}build(){let t=this._extractPathPoints();if(t.length<2)return;let e=this._computeBasisMatrices(t),{depth:r,offset:i}=this.inputs.parameters.extrusion;r=Math.max(0,Math.min(r,1)),i=Math.max(0,Math.min(i,1));let a=this.inputs.path.isClosed?t.length:t.length-1,o=Math.floor(i*a),s=this.inputs.path.isClosed?Math.ceil((r+i)*a):Math.ceil(Math.min(1,r+i)*a),l=Math.min(Math.max(2,s-o+1),a+2),h=[],c=[];for(let n=0;n<l;n++){let r=this.inputs.path.isClosed?(n+o)%t.length:Math.min(n+o,t.length-1);h.push(t[r].clone()),c.push(e[r].clone())}let u=(t,e,r)=>{h[t]=h[t].clone().lerp(h[e],r),c[t]=function(t,e,r){let i=[new n.Vector3,new n.Vector3,new n.Vector3],a=[new n.Vector3,new n.Vector3,new n.Vector3];return t.extractBasis(i[0],i[1],i[2]),e.extractBasis(a[0],a[1],a[2]),i.forEach(((t,e)=>{let i=a[e],o=n.MathUtils.lerp(t.length(),i.length(),r);t.lerp(i,r).setLength(o)})),(new n.Matrix4).makeBasis(i[0],i[1],i[2])}(c[t],c[e],r)},d=0,p=i*a%1;(!this.inputs.path.isClosed||r<=1)&&(p||0===i)&&(d=p,u(0,1,d));let f=0,m=(i+r)*a%1;if((this.inputs.path.isClosed&&r<=1||!this.inputs.path.isClosed&&i+r<1)&&m&&(f=m,u(h.length-1,h.length-2,1-f)),0===r){let t=h.length-1;h[t].copy(h[0]),c[t].copy(c[0])}this._applyPathModifiers(c,d,f);let{bevel:v,bevelSides:g}=this.inputs.parameters.extrusion,y=v>0?this.inputs.parameters.extrusion.capType:"flat",b=5;"Custom"===this.inputs.parameters.extrusion.shape.type&&(b="low"===this.inputs.parameters.extrusion.shape.shapeQuality?5:12);let x,{regions:w,infos:_,vertices:S}=this._computeShapePoints(b),A=0;"round"===y&&(x=new Zc(this.inputs.shapeData,2*v,v,b,g,void 0,!0),A=x.getAttribute("position").count);let M=0,C=0;_.sort(((t,e)=>t.start-e.start)),_.forEach((t=>{t.verticesStart=M,t.verticesCount=t.continuous.reduce(((t,e,r)=>t+(0!==r&&e?1:2)),0),C+=t.verticesCount,M=C}));let O,D=C*l,P=0;if(this._isOpenEnded()&&"flat"===y){try{O=Fc({windingRule:pc.ODD,elementType:mc.POLYGONS,polySize:3,vertexSize:2,strict:!0,contours:w})}catch{O=Yc}P=O.vertexCount}let T=D+2*P+2*A,z=D+2*P,E={positions:new Float32Array(3*T),normals:new Float32Array(3*T),uvs:new Float32Array(2*T)},I=[];if(_.forEach((t=>{this._extrudeRegion(t,S,c,h,E,I,this._isGeometryClosed()&&!this._isOpenEnded())})),O&&(this._closeEnd(O,D,I,E,c[0],h[0],!1),this._closeEnd(O,D+P,I,E,c[c.length-1],h[h.length-1],!0)),x){E.positions.set(x.getAttribute("position").array,3*z),E.normals.set(x.getAttribute("normal").array,3*z),E.uvs.set(x.getAttribute("uv").array,2*z);let t=I.length;I.push(...x.getIndex().array.map((t=>t+z))),z+=A,E.positions.set(x.getAttribute("position").array,3*z),E.normals.set(x.getAttribute("normal").array,3*z),E.uvs.set(x.getAttribute("uv").array,2*z);let e=I.length;I.push(...x.getIndex().array.map((t=>t+z))),this.setAttribute("position",new n.BufferAttribute(E.positions,3)),this.setAttribute("normal",new n.BufferAttribute(E.normals,3)),this.setAttribute("uv",new n.BufferAttribute(E.uvs,2)),this.setIndex(I);let r=ju;r.copy(c[c.length-1]).setPosition(h[h.length-1]),this.applyMatrix4OnRange(r,z,T),r.copy(c[0]).setPosition(h[0]).multiply(Nu.makeScale(1,1,-1)),this.applyMatrix4OnRange(r,z-A,z),this.reverseIndicesOnRange(t,e)}else this.setAttribute("position",new n.BufferAttribute(E.positions,3)),this.setAttribute("normal",new n.BufferAttribute(E.normals,3)),this.setAttribute("uv",new n.BufferAttribute(E.uvs,2)),this.setIndex(I)}_extractPathPoints(){let t=Ch(this.inputs.path).getPoints(this.inputs.path.subdivisions);if(t.length<2)return[];let e=[t[0]];return t.forEach((t=>{e[e.length-1].distanceToSquared(t)>.001&&e.push(t)})),this.inputs.path.isClosed&&e[e.length-1].distanceTo(e[0])<.001&&e.pop(),e}_computeBasisMatrices(t){let e=[],r=t.length,i=this.inputs.path.isClosed,a=new n.Vector3,o=new n.Vector3,s=new n.Vector3,l=new n.Vector3,h=new n.Vector3(0,1,0);for(let m=0;m<r;m++){let c,u,d=t[m];c=0===m?i?t[t.length-2]:d.clone().multiplyScalar(2).sub(t[1]):t[m-1],u=m===r-1?i?t[1]:d.clone().multiplyScalar(2).sub(t[m-1]):t[m+1];let p=d.clone().sub(c).normalize(),f=u.clone().sub(d).normalize(),v=p.clone().add(f).normalize();s.copy(v),0===m&&(v.equals(h)||v.clone().negate().equals(h))&&h.set(0,0,1);let g=h.clone().cross(v).normalize(),y=v.clone().cross(g).normalize();h.copy(y),l.copy(g),0===m&&(a.copy(y),o.copy(v));let b=(new n.Matrix4).makeBasis(g,y,v);e.push(b)}let c=i?o:s,u=i?a:new n.Vector3(0,1,0),d=c.clone().cross(l).normalize(),p=Math.acos(u.dot(d));if(isNaN(p))return e;let f=u.clone().cross(d);c.dot(f)>0&&(p*=-1);for(let m=1;m<e.length;m++){let t=(new n.Matrix4).makeRotationZ(p*m/e.length);e[m].multiply(t)}return e}_applyPathModifiers(t,e,r){let i=t.length,{angle:a,twist:o,startScale:s,endScale:l}=this.inputs.parameters.extrusion,h=new n.Matrix4,c=new n.Matrix4;return t.forEach(((t,u)=>{let d=0===u?0:u===i-1?1:(u-e)/(i-(0===r?0:1)-(e+(1-r)));h.makeRotationZ(n.MathUtils.lerp(a,a+o,d)*n.MathUtils.DEG2RAD);let p=n.MathUtils.lerp(s,l,d);c.makeScale(p,p,p),t.multiply(h).multiply(c)})),t}_computeShapePoints(){let t,e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:12,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:pc.ODD,i=this.inputs.shapeData,a=i.extractShapePointsToFlatArray([],r),o=i.shapeHoles.map((t=>{let e=t.extractShapePointsToFlatArray([],r),n=[];for(let r=e.length-1;r>=1;r-=2){let t=e[r-1],i=e[r-0];n.push(t,i)}return n}));try{t=Fc({windingRule:n,elementType:mc.BOUNDARY_CONTOURS,vertexSize:2,strict:!0,contours:[a]})}catch{t=Wc}try{e=Fc({windingRule:pc.ODD,elementType:mc.BOUNDARY_CONTOURS,vertexSize:2,strict:!0,contours:[...o]})}catch{e=Xc}if(!t)throw new Error("error generating geometry");let s=t.elementCount;if(e){t.elementCount+=e.elementCount;for(let r=0;r<e.elements.length;r++){let n=e.elements[r],i=r%2===0?t.vertexCount:0;t.elements.push(n+i)}for(let r=0;r<e.vertexIndices.length;r++){let n=e.vertexIndices[r],i=t.vertexCount;t.vertexIndices.push(n+i)}for(let r=0;r<e.vertices.length;r++){let n=e.vertices[r];t.vertices.push(n)}}let l=1/0,h=-1/0,c=1/0,u=-1/0;for(let p=0,f=t.vertexCount;p<f;p++){let e=2*p,r=t.vertices[e+0],n=t.vertices[e+1];r<l&&(l=r),r>h&&(h=r),n<c&&(c=n),n>u&&(u=n)}let d=[];for(let p=t.elementCount-1;p>=0;p--){let e=p>=s,r=2*p,n=t.elements[r+0],a=t.elements[r+1],o=n+a,l={start:n,count:a,normals:[],isHole:e,continuous:[],verticesStart:0,verticesCount:0};d.push(l);let h=n,c=o-1,u=n+1,f=i.roundedCurves.length;do{let r=h-n,s=t.vertices[2*c+0],d=t.vertices[2*c+1],p=t.vertices[2*h+0],m=t.vertices[2*h+1],v=t.vertices[2*u+0],g=t.vertices[2*u+1],y=p-s,b=m-d,x=Math.sqrt(y*y+b*b);y/=x,b/=x;let w=p-v,_=m-g,S=Math.sqrt(w*w+_*_);w/=S,_/=S,l.normals[2*r+0]=-_,l.normals[2*r+1]=w;let A=t.vertexIndices[h];if(Array.isArray(A))l.continuous[r]=!1;else{let[t,e]=i.getCurveIndexFromVertexId(A-1,!0);if(e>0&&e<1)l.continuous[r]=!0;else{let n=1===e?t+1:t-1;n=(n+f)%f;let a=1===e?0:1,o=i.roundedCurves[t].getTangent(e),s=i.roundedCurves[n].getTangent(a);l.continuous[r]=o.dot(s)>.95}}e&&(l.normals[2*r+0]*=-1,l.normals[2*r+1]*=-1),[c,h,u]=[h,u,u+1],u>=o&&(u-=a)}while(u!==n+1)}return{regions:[a,...o],infos:d,vertices:t.vertices}}_insertVertex(t,e,r,n,i){let a=2*e,o=3*e;t.positions[o+0]=r.x,t.positions[o+1]=r.y,t.positions[o+2]=r.z,t.normals[o+0]=n.x,t.normals[o+1]=n.y,t.normals[o+2]=n.z,t.uvs[a+0]=i.x,t.uvs[a+1]=i.y}_extrudeRegion(t,e,r,i,a,o,s){let l=new n.Vector3,h=new n.Vector3,c=new n.Vector3,u=new n.Vector3,d=new n.Vector2;r.forEach(((n,o)=>{let s=i[o],p=t.verticesStart*r.length+t.verticesCount*o;for(let i=0;i<t.count;i++){let f=2*(t.start+i);if(l.set(e[f+0],e[f+1],0),c.copy(l).applyMatrix4(n).add(s),t.continuous[i])u.set(t.normals[2*i+0],t.normals[2*i+1],0);else{let r=0===i?2*(t.start+t.count-1):f-2;h.set(e[r+0],e[r+1],0),u.copy(l).sub(h),u.set(-u.y,u.x,0),t.isHole||u.negate()}if(u.applyMatrix4(n).normalize(),d.set(0===i?1:i/t.count,o/(r.length-1)),this._insertVertex(a,p,c,u,d),p++,!t.continuous[i]||0===i){if(0===i)u.set(t.normals[2*i+0],t.normals[2*i+1],0),d.set(0,o/(r.length-1));else{let r=i===t.count-1?2*t.start:f+2;h.set(e[r+0],e[r+1],0),u.copy(h).sub(l),u.set(-u.y,u.x,0),t.isHole||u.negate()}u.applyMatrix4(n).normalize(),this._insertVertex(a,p,c,u,d),p++}}}));let p=r.length-1;for(let n=0;n<p;n++){let e=t.verticesStart*r.length+t.verticesCount*n,i=t.verticesStart*r.length+t.verticesCount*(n+1),a=0;for(let r=0;r<t.count;r++){(!t.continuous[r]||0===r)&&a++;let n=r===t.count-1?0:a+1,s=e+a,l=e+n,h=i+n,c=i+a;t.isHole?o.push(s,h,l,s,c,h):o.push(s,l,h,s,h,c),a++}}}_closeEnd(t,e,r,i,a,o,s){let l=t.vertexCount,h=new n.Vector3(0,0,s?-1:1).applyMatrix4(a),c=new n.Vector3,u=new n.Vector2;for(let n=0;n<l;n++){let r=2*n;c.set(t.vertices[r+0],t.vertices[r+1],0).applyMatrix4(a).add(o),this._insertVertex(i,e+n,c,h,u)}let d=t.elements;for(let n=0;n<t.elementCount;n++){let t=3*n,i=d[t+0]+e,a=d[t+(s?1:2)]+e,o=d[t+(s?2:1)]+e;r.push(i,a,o)}}applyMatrix4OnRange(t,e,r){let i,a,o,s,l=t.elements,h=(new n.Matrix3).getNormalMatrix(t).elements,c=this.attributes.position,u=this.attributes.normal;if(!c||!u)return;let d=c.array,p=u.array,f=c.itemSize;for(let n=e*f,m=r*f;n<m;n+=f)i=d[n+0],a=d[n+1],o=d[n+2],s=1/(l[3]*i+l[7]*a+l[11]*o+l[15]),d[n+0]=(l[0]*i+l[4]*a+l[8]*o+l[12])*s,d[n+1]=(l[1]*i+l[5]*a+l[9]*o+l[13])*s,d[n+2]=(l[2]*i+l[6]*a+l[10]*o+l[14])*s,i=p[n+0],a=p[n+1],o=p[n+2],p[n+0]=h[0]*i+h[3]*a+h[6]*o,p[n+1]=h[1]*i+h[4]*a+h[7]*o,p[n+2]=h[2]*i+h[5]*a+h[8]*o;c.needsUpdate=!0,u.needsUpdate=!0}reverseIndicesOnRange(t,e){let r=this.index;if(r){for(let n=t;n<e;n+=3){let t=r.getX(n),e=r.getX(n+1),i=r.getX(n+2);r.setXYZ(n,i,e,t)}r.needsUpdate=!0}}};function Fu(){let t=new n.BufferGeometry;return t.setAttribute("position",new n.BufferAttribute(new Float32Array([]),3)),t.setIndex(new n.BufferAttribute(new Uint16Array([]),1)),t}var Gu=Fu().attributes,qu=class extends n.BufferGeometry{constructor(t,e){super(),this.charWidths=[],this.charCoords=[],this.wrappedText=[],this.isLowResolution=!1,this.vectorShapes=[],Object.assign(this.attributes,Gu),this.userData={parameters:t,type:"TextGeometry"};let r=e.getFont(t.font);null!==r&&void 0!==r&&r.isLoaded?(this.font=r,this.update(t)):this.updateFont(t.font,e).then((()=>{this.update(t),null===e||void 0===e||e.requestRender()}))}async updateFont(t,e){let r=e.getFont(t);r&&(this.font=r,await r.loadingPromise)}update(t){let e=this.font;if(this.userData={parameters:t,type:"TextGeometry"},null===e||void 0===e||!e.isLoaded)return void console.warn("Cannot update text because its font is not loaded");let{width:r,height:n,depth:a,extrudeBevelSize:o,extrudeBevelSegments:s,text:l,textTransform:h}=t,c=fl.getDisplayedValue(l),u=function(t,e,r){let n=[""],i="";for(let a of r)i+=a," "===a||"\n"===a?(n[n.length-1]+=i,i="","\n"===a&&n.push("")):e.getTextWidth(n[n.length-1]+i,t)>t.width&&(n[n.length-1].length&&n.push(""),e.getTextWidth(n[n.length-1]+i,t)>t.width&&(1===i.length?(n[n.length-1]+=i,i=""):(n[n.length-1]+=i.slice(0,-1),i=i[i.length-1],n.push(""))));return n[n.length-1]+=i,n}(t,e,2===h?c.toUpperCase():3===h?c.toLowerCase():c),{shapes:d,charWidths:p,charCoords:f}=e.generateShapes(u,t),m=.5*("number"==typeof r?r:1),v=.5*("number"==typeof n?n:1),g=d.map((t=>(new _c).fromShape(t,!0)));this.vectorShapes=g;let y=g.map((t=>$c.create({shape:t,parameters:{depth:a,extrudeBevelSegments:s,extrudeBevelSize:o,windingRule:a<=0?pc.NONZERO:pc.ODD,subdivisions:this.isLowResolution&&a>0?1:12}}))),b=y.length?i(y):Fu();b.translate(-m,v,0),this.dispose(),this.wrappedText=u,this.charCoords=f,this.charWidths=p,this.deleteAttribute("extrudeNormal"),Object.entries(b.attributes).forEach((t=>{let[e,r]=t;this.setAttribute(e,r)})),this.setIndex(b.index),this.computeBoundingSphere()}clone(){let t=E(new n.BufferGeometry,qu.prototype);return t.copy(this),console.log("CloneGeometry",this,t),t}copy(t){return Object.entries(t.attributes).forEach((t=>{let[e,r]=t;this.setAttribute(e,r)})),this.setIndex(t.index),this.userData={parameters:{...t.userData.parameters},type:"TextGeometry"},this}async setText(t){this.font&&await this.font.loadingPromise,await this.update({...this.userData.parameters,text:t})}get text(){var t;return null!==(t=this.userData.parameters.text)&&void 0!==t?t:""}};var Hu,Wu,Xu=new Promise((t=>{Hu=t})),Yu=!1;function Qu(){if(!Yu)return Wu||(Wu=async function(){let t=r.e(788).then(r.bind(r,8788)),[e,n]=await Promise.all([t,fetch("".concat("https://unpkg.com/@splinetool/modelling-wasm@0.9.526/build","/process.wasm")).then((t=>t.arrayBuffer()))]),i=e.default,a=await i({wasmBinary:n});Hu(a),Yu=!0}(),Wu)}var Zu=["font"];function Ku(t,e,r,i){var a;let o,s,l;"PathGeometry"===t.type?(s=JSON.parse(JSON.stringify(t)),l=[[],["extrusion"]]):(s={...t},l=[[]]);for(let n of l){let t=s;for(let e of n)t=t[e];for(o in t){let r=t[o];cs(r)&&!Zu.includes(o)&&(t[o]=e.getVariable(r,[i.uuid,"geometry",...n,o]),cs(t[o])&&(t[o]=1))}}let h,c={parameters:s,type:s.type};if("PathGeometry"===s.type)c.path=s.path;else if("VectorGeometry"===s.type){let t=_c.createFromState(s.shape,s.width,s.height);c.shape=t}else if("NonParametricGeometry"===s.type)s.data.groups&&null!==(a=s.data.groups)&&void 0!==a&&a.forEach((t=>{var e;return t.materialIndex=Math.max(null!==(e=t.materialIndex)&&void 0!==e?e:0,0)})),c.geometry=(new n.BufferGeometryLoader).parse(s);else{if("SubdivGeometry"===s.type){let e=new od(s,r);return e.data=t,e}if("TextGeometry"===s.type)return new qu(s,e)}try{h=Od(c)}catch(u){console.error(u)}if(!h){let t=_c.createFromState(Ps.defaultData(),100,100);c.shape=t,h=Od(c)}return h}var Ju=new n.Matrix4;function $u(t,e,r,n){let i,a,o,s=t.position.array,l=t.normal.array,h=Ju.makeScale(e,r,n).invert().elements;for(var c=0,u=s.length;c<u;c+=3)s[c]*=e,s[c+1]*=r,s[c+2]*=n,i=l[c],a=l[c+1],o=l[c+2],l[c]=h[0]*i+h[4]*a+h[8]*o,l[c+1]=h[1]*i+h[5]*a+h[9]*o,l[c+2]=h[2]*i+h[6]*a+h[10]*o;t.position.needsUpdate=!0,t.normal.needsUpdate=!0}var td,ed=new n.Box3,rd=new n.Vector3;Xu.then((t=>{td=t}));var nd=new Float32Array([10,10,0,-10,10,0,-10,-10,0,10,-10,0]),id=new Uint32Array([0,1,2,3]),ad=new Uint8Array([4]),od=class extends n.BufferGeometry{constructor(t,e){super(),this.data=t,this.flatShading=e,this.subdivPointer=0,this.rebuild(),this.freeSubdivPointer()}mutateDirectlyScaleBaked(t,e){this.freeSubdivPointer();let r=this.data.scaleBaked,n=qo.div(e,r);this.subdividedGeometry&&$u(this.subdividedGeometry.attributes,...n),this.originalGeometry&&$u(this.originalGeometry.attributes,...n),this.data=t;let i=this.userData.parameters;this.userData.parameters={width:i.width*n[0],height:i.height*n[1],depth:i.depth*n[2]},this.originalGeometry.boundingSphere.center.multiply(rd.fromArray(n));let a=rd.set(i.width,i.height,i.depth).length();this.originalGeometry.boundingSphere.radius=a/2}ensureSubdivPointer(){return 0===this.subdivPointer&&this.rebuild(),this.subdivPointer}rebuild(){var t,e;let r,i,a;try{({originalGeometry:r,subdividedGeometry:i,subdivPointer:a}=od.build(this.data,void 0,!this.flatShading,void 0))}catch{r=new n.BoxGeometry(100,100,100),a=0}this.subdivPointer=a,this.originalGeometry=r,this.subdividedGeometry=null!==(t=i)&&void 0!==t?t:void 0;let o=null!==(e=this.subdividedGeometry)&&void 0!==e?e:this.originalGeometry;Object.assign(this,o),this.calcBoundingBox()}freeSubdivPointer(){this.subdivPointer&&(od.freeSubdivPointer(this.subdivPointer),this.subdivPointer=0)}dispose(){super.dispose(),this.freeSubdivPointer()}calcBoundingBox(){let t=this.originalGeometry;null===t.boundingSphere&&(t.boundingSphere=new n.Sphere,this.subdividedGeometry&&(this.subdividedGeometry.boundingSphere=t.boundingSphere));let e=t.attributes.position,r=t.boundingSphere.center;ed.setFromBufferAttribute(e),ed.getCenter(r),t.boundingSphere.radius=r.distanceTo(ed.max),isNaN(t.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this),ed.getSize(rd);let i={width:rd.x,height:rd.y,depth:rd.z};return this.userData.parameters=i,i}static build(t,e,r,n){var i;let a,o,s,l=null!==(i=null===t||void 0===t?void 0:t.phongAngle)&&void 0!==i?i:35;!1===r&&(l=-1),e&&(td.free_bvh(e),td.free_subdivision_surface(e));try{a=od.allocate(t,n)}catch(Zo){console.error(Zo,t),a=od.allocate({positionWASM:nd,indexWASM:id,verticesPerFaceWASM:ad},n)}if(td.set_destination_refinement_level(a,0),o=od.buildLevel(a,!0,l),t.subdivisions>0)try{td.set_destination_refinement_level(a,t.subdivisions),s=od.buildLevel(a,!1,l)}catch{try{td.set_destination_refinement_level(a,t.subdivisions-1),s=od.buildLevel(a,!1,l)}catch{s=null}}else s=null;return{subdivPointer:a,originalGeometry:o,subdividedGeometry:s}}static primitiveToQuads(t,e,r){t.widthSegments>16&&(t.widthSegments=16),t.heightSegments>16&&(t.heightSegments=16),t.depthSegments>16&&(t.depthSegments=16),t.radialSegments>16&&(t.radialSegments=16),"DodecahedronGeometry"===t.type&&(t.detail=0);let n,i,a,o,s,l,h=void 0!==t.shape||void 0!==t.path?e.geometry:Ku(t,r,!1);if(n="TorusGeometry"===t.type&&t.arc===2*Math.PI?h.getClosedTorusIndicesForBooleanOrSubdiv():h.getIndex(),({positions:i,triIndices:s}=ld(h.getAttribute("position"),n)),"CylinderGeometry"===t.type&&0===t.cornerRadius&&0===t.hollow&&!1===t.openEnded){let e=t.radialSegments*t.heightSegments*3*2;l=[e,e+3*t.radialSegments]}return({indices:a,verticesPerFace:o}=pd(i,s,h,l)),{positions:i,indices:a,verticesPerFace:o}}static allocate(t,e){var r;let i,a,o,s=[],l=[];t.positionWASM&&t.positionWASM.length>0?(i=t.positionWASM,a=t.indexWASM,o=t.verticesPerFaceWASM):(i=nd,a=id,o=ad);let h,c=i.length,u=a.length,d=o.length,p=i.length+s.length+l.length,f=a.length+o.length,m=p*Float32Array.BYTES_PER_ELEMENT+f*Uint32Array.BYTES_PER_ELEMENT,v=p*Float32Array.BYTES_PER_ELEMENT,g=(Uint32Array.BYTES_PER_ELEMENT,td._malloc(m)),y=new Float32Array(td.HEAPF32.buffer,g,p),b=new Uint32Array(td.HEAPU32.buffer,g+v,f);y.set(i,0),y.set(s,i.length),y.set(l,i.length+s.length),b.set(a,0),b.set(o,a.length),null!==t&&void 0!==t&&null!==(r=t.scaleBaked)&&void 0!==r&&r.some((t=>1!==t))&&(h=(new n.Matrix4).makeScale(...t.scaleBaked)),e&&(h?h.premultiply(e):h=e);let x=h?td.alloc_subdivision_surface2(g,c,g+v,u,g+v+a.length*Uint32Array.BYTES_PER_ELEMENT,d,h.elements):td.alloc_subdivision_surface(g,c,g+v,u,g+v+a.length*Uint32Array.BYTES_PER_ELEMENT,d);return td._free(g),x}static buildLevel(t,e,r,i,a){let o=a?td.get_mesh_data2(t,e?td.Level.CONTROL:td.Level.REFINED,r,a.elements):td.get_mesh_data(t,e?td.Level.CONTROL:td.Level.REFINED,r),s=td.HEAPU32.subarray(o>>2,8+(o>>2)),l=s.subarray(4,8),h=0,c=td.HEAPU32[s[h]>>2],u=td.HEAPF32.subarray(c>>2,(c>>2)+l[h]);h++;let d=td.HEAPU32[s[h]>>2],p=td.HEAPF32.subarray(d>>2,(d>>2)+l[h]);h++;let f=td.HEAPU32[s[h]>>2],m=td.HEAPU32.subarray(f>>2,(f>>2)+l[h]);h++;let v=td.HEAPU32[s[h]>>2],g=td.HEAPU32.subarray(v>>2,(v>>2)+l[h]);if(h++,void 0===i){let t=new n.BufferGeometry;if(t.setIndex(new n.Uint32BufferAttribute(g,1)),t.setAttribute("position",new n.Float32BufferAttribute(u,3)),t.setAttribute("normal",new n.Float32BufferAttribute(p,3)),e){t.setAttribute("faceMap",new n.Uint32BufferAttribute(m,1));let e=new Float32Array(p.length/3*4).fill(0);t.setAttribute("color",new n.BufferAttribute(e,4))}return td.free_mesh_data(o),t.userData.type="SubdivGeometry",t}i.getAttribute("position").copyArray(u),i.getAttribute("normal").copyArray(p),i.attributes.position.needsUpdate=!0,i.attributes.normal.needsUpdate=!0,td.free_mesh_data(o)}static freeSubdivPointer(t){td.free_bvh(t),td.free_subdivision_surface(t)}static buildControlCageWireframe(t,e,r){let i=td.get_wireframe_data_for_base_level(t),a=td.HEAPU32.subarray(i>>2,4+(i>>2)),o=a.subarray(2,4),s=0,l=td.HEAPU32[a[s]>>2],h=td.HEAPF32.subarray(l>>2,(l>>2)+o[s]);s++;let c=td.HEAPU32[a[s]>>2],u=td.HEAPU32.subarray(c>>2,(c>>2)+o[s]);if(void 0===e){let t=new n.BufferGeometry;t.setAttribute("position",new n.Float32BufferAttribute(h,3));let e=new Float32Array(h.length);for(let n=0,i=h.length;n<i;)e[n++]=r.r,e[n++]=r.g,e[n++]=r.b;return t.setAttribute("color",new n.BufferAttribute(e,3)),t.setIndex(new n.Uint32BufferAttribute(u,1)),td.free_wireframe_data_for_base_level(i),t}e.getAttribute("position").copyArray(h),e.attributes.position.needsUpdate=!0,td.free_wireframe_data_for_base_level(i)}static updateCollabMesh(t,e,r){let n=0===e;n||td.set_destination_refinement_level(t,e);let i=r?td.get_topological_data2(t,n?td.Level.CONTROL:td.Level.REFINED,r.elements):td.get_topological_data(t,n?td.Level.CONTROL:td.Level.REFINED),a=td.HEAPU32.subarray(i>>2,6+(i>>2)),o=a.subarray(3,6),s=0,l=td.HEAPU32[a[s]>>2],h=new Float32Array(td.HEAPF32.subarray(l>>2,(l>>2)+o[s]));s++;let c=td.HEAPU32[a[s]>>2],u=new Uint32Array(td.HEAPU32.subarray(c>>2,(c>>2)+o[s]));s++;let d=td.HEAPU32[a[s]>>2],p=new Uint8Array(td.HEAPU32.subarray(d>>2,(d>>2)+o[s]));return td.free_topological_data(i),{positions:h,indices:u,verticesPerFace:p}}},sd=["getX","getY","getZ"];function ld(t,e){let r={},n=e?e.count:t.count,i=0,a=[],o=[];for(let l=0;l<n;l++){let n=e?e.getX(l):l,s="";for(let e=0;e<3;e++)s+="".concat(~~(1e4*t[sd[e]](n)),",");if(s in r)a.push(r[s]);else{for(let e=0;e<3;e++)o.push(t[sd[e]](n));r[s]=i,a.push(i),i++}}let s=[];for(let l=0;l<a.length;l+=3)a[l]===a[l+1]||a[l]===a[l+2]||a[l+1]===a[l+2]||s.push(a[l],a[l+1],a[l+2]);return{positions:o,triIndices:s}}var hd=new n.Vector3,cd=new n.Vector3,ud=new n.Vector3,dd=new n.Vector3;function pd(t,e,r,n){let i=[],a=[];if(void 0!==r.userData.shape&&0===r.userData.parameters.depth&&0===r.userData.shape.shapeHoles.length){let e=r.userData.shape.extractShapePointsToFlatArray([]),n=r.userData.parameters.spikes;if("EllipseGeometry"===r.userData.type&&n<=24&&n%4===0&&r.userData.parameters.angle>=360){let t=e.length/2/n;e=e.filter(((e,r)=>Math.floor(r/2)%t===0))}let o=0;for(let t=0;t<e.length;t+=2)o+=(e[t]-e[(0===t?e.length:t)-2])*(e[t+1]+e[(0===t?e.length:t)-1]);t.length=0;let s=0;if(o<0)for(let r=0;r<e.length;r+=2)t.push(e[r],e[r+1],0),i.push(s++);else for(let r=e.length-2;r>=0;r-=2)t.push(e[r],e[r+1],0),i.push(s++);return a.push(s),{indices:i,verticesPerFace:a}}let o=new Float32Array([r.userData.parameters.depth])[0],s=0;for(;s<e.length;){if(r.useNgonForTopBottomFaceDuringBake){let r=0;if((t[3*e[s]+2]===o||0===t[3*e[s]+2])&&r++,(t[3*e[s+1]+2]===o||0===t[3*e[s+1]+2])&&r++,(t[3*e[s+2]+2]===o||0===t[3*e[s+2]+2])&&r++,3===r)break}if(e[s+1]===e[s+3]&&e[s+2]===e[s+5]||e[s+0]===e[s+3]&&e[s+2]===e[s+4]){hd.set(t[3*e[s]],t[3*e[s]+1],t[3*e[s]+2]),cd.set(t[3*e[s+1]],t[3*e[s+1]+1],t[3*e[s+1]+2]),ud.set(t[3*e[s+4]],t[3*e[s+4]+1],t[3*e[s+4]+2]),dd.set(t[3*e[s+5]],t[3*e[s+5]+1],t[3*e[s+5]+2]),cd.sub(hd).normalize(),ud.sub(hd).normalize(),dd.sub(hd).normalize();let r=cd.cross(ud).dot(dd);Math.abs(r)>.005||n&&n.some(((t,e)=>e%2!==1&&(s>=n[e]&&s<n[e+1])))?(i.push(e[s],e[s+1],e[s+2]),a.push(3),s+=3):(i.push(e[s],e[s+1],e[s+4],e[s+5]),a.push(4),s+=6)}else i.push(e[s],e[s+1],e[s+2]),a.push(3),s+=3}if(r.useNgonForTopBottomFaceDuringBake){let e=[],n=[],s=0;for(let r=0,i=0;r<t.length;r+=3,i++)0===t[r+2]&&(e.push(i),s++),t[r+2]===o&&n.push(i);if(0===r.userData.parameters.extrudeBevelSize){let t=n[0];n[0]=n[1],n[1]=t}e.reverse(),i.push(...e,...n),a.push(s,s)}return{indices:i,verticesPerFace:a}}var fd={};((t,e)=>{for(var r in e)c(t,r,{get:e[r],enumerable:!0})})(fd,{calcBoolean:()=>wd,calcBooleanTopological:()=>xd,freeMeshSet:()=>Md,getMeshSet:()=>_d,hasOpenEdges:()=>Sd,transformMeshSet:()=>Ad});var md,vd,gd=new Promise((t=>{t}));function yd(t){let e=t.length,r=e*Uint32Array.BYTES_PER_ELEMENT,n=e*Float32Array.BYTES_PER_ELEMENT,i=Number.isInteger(t[0])?r:n,a=md._malloc(i);return(Number.isInteger(t[0])?new Uint32Array(md.HEAPU32.buffer,a,e):new Float32Array(md.HEAPF32.buffer,a,e)).set(t,0),a}function bd(t){switch(t){case 0:return md.OP.UNION;case 1:return md.OP.INTERSECTION;case 2:return md.OP.A_MINUS_B;case 3:return md.OP.B_MINUS_A;case 4:return md.OP.SYMMETRIC_DIFFERENCE;case 5:return md.OP.ALL;default:throw new Error("Unknown boolean operation "+t)}}function xd(t,e){void 0===vd&&(vd=md.init_csg());let r=yd(t),n=md.csg_calc_topological(vd,r,t.length,bd(e));md._free(r);let i=md.HEAPU32.subarray(n>>2,6+(n>>2)),a=i.subarray(3,6),o=0,s=md.HEAPU32[i[o]>>2],l=new Float32Array(md.HEAPF32.subarray(s>>2,(s>>2)+a[o]));o++;let h=md.HEAPU32[i[o]>>2],c=new Uint32Array(md.HEAPU32.subarray(h>>2,(h>>2)+a[o]));o++;let u=md.HEAPU32[i[o]>>2],d=new Uint8Array(md.HEAPU32.subarray(u>>2,(u>>2)+a[o]));return md.free_mesh_data(n),{positions:l,indices:c,verticesPerFace:d}}function wd(t,e,r,i){void 0===vd&&(vd=md.init_csg());let a=yd(t),o=md.csg_calc(vd,a,t.length,i,bd(e));md._free(a);let s=md.HEAPU32.subarray(o>>2,5+(o>>2)),l=s.subarray(2,5),h=0,c=md.HEAPU32[s[h]>>2],u=md.HEAPF32.subarray(c>>2,(c>>2)+l[h]);h++;let d=md.HEAPU32[s[h]>>2],p=md.HEAPF32.subarray(d>>2,(d>>2)+l[h]);h++;let f=l[h];r.setAttribute("position",new n.Float32BufferAttribute(u,3)),r.setAttribute("normal",new n.Float32BufferAttribute(p,3));let m=md.HEAPF32.subarray(5+(o>>2),5+(o>>2)+6);return null===r.boundingSphere&&(r.boundingSphere=new n.Sphere),r.boundingSphere.radius=-1,r.userData.parameters={width:2*m[3],height:2*m[4],depth:2*m[5]},md.free_mesh_data(o),f}function _d(t,e,r){if(void 0===md)return-1;let n,i,a;if(e&&void 0!==t.userData.positions){let e=t.userData;a=e.verticesPerFace.length,n=e.positions,i=Array(e.verticesPerFace.reduce(((t,e)=>t+e),0)+a);for(let t=0,r=0,n=0;t<e.verticesPerFace.length;t++){i[n++]=e.verticesPerFace[t];for(let a=0;a<e.verticesPerFace[t];a++)i[n++]=e.indices[r++]}}else({positions:n,faceIndices:i,nFaces:a}=function(t,e,r){let n,i;i="TorusGeometry"===t.userData.parameters.type&&t.userData.parameters.arc===2*Math.PI?t.getClosedTorusIndicesForBooleanOrSubdiv():t.getIndex();let a,{positions:o,triIndices:s}=ld(t.getAttribute("position"),i);if(e&&r){let{indices:e,verticesPerFace:r}=pd(o,s,t);a=r.length,n=[];for(let t=0,i=0;t<a;t++){n.push(r[t]);for(let a=0;a<r[t];a++)n.push(e[i++])}}else{let t=s.length;n=Array(t+t/3),a=0;for(let e=0,r=0;r<n.length;)n[r++]=3,a++,n[r++]=s[e++],n[r++]=s[e++],n[r++]=s[e++]}return{positions:o,faceIndices:n,nFaces:a}}(t,e,r));let o=n.length,s=i.length,l=n.length,h=i.length,c=l*Float32Array.BYTES_PER_ELEMENT+h*Uint32Array.BYTES_PER_ELEMENT,u=l*Float32Array.BYTES_PER_ELEMENT,d=(Uint32Array.BYTES_PER_ELEMENT,md._malloc(c)),p=new Float32Array(md.HEAPF32.buffer,d,l),f=new Uint32Array(md.HEAPU32.buffer,d+u,h);p.set(n,0),f.set(i,0);let m=md.get_csg_mesh(d,o,d+u,s,a);return md._free(d),m}function Sd(t){return md.has_open_edges(t)}function Ad(t,e){md.transform_csg_mesh(t,e.elements)}function Md(t){md.free_csg_mesh(t)}gd.then((t=>md=t));var Cd={ConeGeometry:class{static create(t){return this.build(this.normalizeInputs(t))}static normalizeInputs(t,e){var r,i,a;let o=Object.assign({},null!==(r=null===e||void 0===e?void 0:e.parameters)&&void 0!==r?r:{width:100,radialSegments:32,heightSegments:8,openEnded:!1,thetaStart:0,thetaLength:360,cornerRadiusTop:8,cornerRadiusBottom:8,cornerSegments:8},t.parameters);return o.thetaLength=n.MathUtils.clamp(o.thetaLength,0,360),{parameters:Object.assign(o,{width:Math.abs(o.width),height:Math.abs(null!==(i=o.height)&&void 0!==i?i:o.width),depth:Math.abs(null!==(a=o.depth)&&void 0!==a?a:o.width)})}}static build(t){let e,{width:r,depth:i,height:a,radialSegments:o,heightSegments:s,openEnded:l,thetaStart:h,thetaLength:c,cornerRadiusTop:u,cornerRadiusBottom:d,cornerSegments:p}=t.parameters;return 0===c?(e=new n.BufferGeometry,e.setAttribute("position",new n.Float32BufferAttribute([],3))):e=u>0||d>0||c<360?new Bh(0,r/2,a,o,s,l,h,c*Math.PI/180,u,d,p,0,!0):new n.ConeGeometry(r/2,a,o,s,l),e.scale(1,1,i/r),Object.assign(e,{userData:{...t,type:"ConeGeometry"}})}},CubeGeometry:class{static create(t){return this.build(this.normalizeInputs(t))}static normalizeInputs(t,e){var r,n,i;let a=Object.assign({},null!==(r=null===e||void 0===e?void 0:e.parameters)&&void 0!==r?r:{width:100,widthSegments:1,heightSegments:1,depthSegments:1,cornerRadius:8,cornerSegments:8},t.parameters);return{parameters:Object.assign(a,{width:Math.abs(a.width),height:Math.abs(null!==(n=a.height)&&void 0!==n?n:a.width),depth:Math.abs(null!==(i=a.depth)&&void 0!==i?i:a.width)})}}static build(t){let e,{width:r,height:i,depth:a,widthSegments:o,heightSegments:s,depthSegments:l,cornerRadius:h,cornerSegments:c}=t.parameters;return e=0==h?new n.BoxGeometry(r,i,a,o,s,l):new Vh(r,i,a,o,s,l,h,c),Object.assign(e,{userData:{...t,type:"CubeGeometry"}})}},CylinderGeometry:class{static create(t){return this.build(this.normalizeInputs(t))}static normalizeInputs(t,e){var r,i,a,o,s;let l=Object.assign({},null!==(r=null===e||void 0===e?void 0:e.parameters)&&void 0!==r?r:{width:100,radialSegments:64,heightSegments:1,openEnded:!1,thetaStart:0,thetaLength:360,cornerRadius:8,cornerSegments:8,hollow:0},t.parameters);l.thetaLength=n.MathUtils.clamp(l.thetaLength,0,360);let h=l.width/2,c=null!==(i=l.radiusTop)&&void 0!==i?i:h,u=null!==(a=l.radiusBottom)&&void 0!==a?a:h;return c===u?(c=h,u=h):c>u?(c=h,u=u*h/c):(c=c*h/u,u=h),{parameters:Object.assign(l,{width:Math.abs(l.width),height:Math.abs(null!==(o=l.height)&&void 0!==o?o:l.width),depth:Math.abs(null!==(s=l.depth)&&void 0!==s?s:l.width),radiusTop:c,radiusBottom:u})}}static build(t){let e,{width:r,depth:i,height:a,radialSegments:o,heightSegments:s,openEnded:l,thetaStart:h,thetaLength:c,radiusTop:u,radiusBottom:d,cornerRadius:p,cornerSegments:f,hollow:m}=t.parameters;return 0===c?(e=new n.BufferGeometry,e.setAttribute("position",new n.Float32BufferAttribute([],3))):e=p||m?new Bh(u,d,a,o,s,l,h,c*Math.PI/180,p,p,f,m):new n.CylinderGeometry(u,d,a,o,s,l,h,c*Math.PI/180),e.scale(1,1,i/r),Object.assign(e,{userData:{...t,type:"CylinderGeometry"}})}},DodecahedronGeometry:class{static create(t){return this.build(this.normalizeInputs(t))}static normalizeInputs(t,e){var r,n,i;let a=Object.assign({},null!==(r=null===e||void 0===e?void 0:e.parameters)&&void 0!==r?r:{width:100,detail:0,corner:0,cornerSides:4},t.parameters);return{parameters:Object.assign(a,{width:Math.abs(a.width),height:Math.abs(null!==(n=a.height)&&void 0!==n?n:a.width),depth:Math.abs(null!==(i=a.depth)&&void 0!==i?i:a.width)})}}static build(t){let{width:e,height:r,depth:i,detail:a,corner:o,cornerSides:s}=t.parameters,l=0===a&&0!==o?new jh(.5*e,o,s):new n.DodecahedronGeometry(.5*e,a);return l.scale(1,r/e,i/e),Object.assign(l,{userData:{...t,type:"DodecahedronGeometry"}})}},EllipseGeometry:eu,HelixGeometry:class{static create(t){return this.build(this.normalizeInputs(t))}static normalizeInputs(t,e){var r,n,i;let a=Object.assign({},null!==(r=null===e||void 0===e?void 0:e.parameters)&&void 0!==r?r:{width:100,revolutions:2,segments:40,pathRadius:10,pathType:0,pathSegments:30,cornerRadius:30,cornerSegments:4},t.parameters),o=Math.abs(a.width),s=Math.abs(null!==(n=a.height)&&void 0!==n?n:o),l=Math.abs(null!==(i=a.depth)&&void 0!==i?i:o),h=Math.abs(Math.min(o,l))/2;return{parameters:Object.assign(a,{width:o,height:s,depth:l,radius:h,segments:Math.round(a.segments),pathSegments:Math.round(a.pathSegments),cornerSegments:Math.round(a.cornerSegments)})}}static build(t){let{width:e,height:r,depth:n,radius:i,revolutions:a,segments:o,pathRadius:s,pathType:l,pathSegments:h,cornerRadius:c,cornerSegments:u}=t.parameters,d=new hu(!1,e,r,n,i,a,o,s,l,h,c,u);return Object.assign(d,{userData:{...t,type:"HelixGeometry"}})}},IcosahedronGeometry:class{static create(t){return this.build(this.normalizeInputs(t))}static normalizeInputs(t,e){var r,n,i;let a=Object.assign({},null!==(r=null===e||void 0===e?void 0:e.parameters)&&void 0!==r?r:{width:100,detail:0,corner:0,cornerSides:4},t.parameters);return{parameters:Object.assign(a,{width:Math.abs(a.width),height:Math.abs(null!==(n=a.height)&&void 0!==n?n:a.width),depth:Math.abs(null!==(i=a.depth)&&void 0!==i?i:a.width)})}}static build(t){let{width:e,height:r,depth:i,detail:a,corner:o,cornerSides:s}=t.parameters,l=0===a&&0!==o?new cu(.5*e,o,s):new n.IcosahedronGeometry(.5*e,a);return l.scale(1,r/e,i/e),Object.assign(l,{userData:{...t,type:"IcosahedronGeometry"}})}},LatheGeometry:class{static create(t){return this.build(this.normalizeInputs(t))}static normalizeInputs(t,e){var r,n,i,a,o;(null!==(r=null===(n=t.parameters)||void 0===n?void 0:n.points)&&void 0!==r?r:[]).forEach((t=>{Array.isArray(t)&&(t.x=t[0],t.y=t[1])}));let s=Object.assign({},null!==(i=null===e||void 0===e?void 0:e.parameters)&&void 0!==i?i:{width:100,segments:64,verticalSegments:64,points:[{x:0,y:-50,id:0},{x:50,y:-50,id:1},{x:50,y:50,id:2},{x:0,y:50,id:3}]},t.parameters);return{parameters:Object.assign(s,{width:Math.abs(s.width),height:Math.abs(null!==(a=s.height)&&void 0!==a?a:s.width),depth:Math.abs(null!==(o=s.depth)&&void 0!==o?o:s.width)})}}static build(t){let{points:e,segments:r,verticalSegments:i}=t.parameters,a=new n.Shape;a.moveTo(e[0].x,e[0].y),a.bezierCurveTo(e[1].x,e[1].y,e[2].x,e[2].y,e[3].x,e[3].y);let o=new n.LatheGeometry(a.extractPoints(i).shape,r);return o.rotateZ(Math.PI),Object.assign(o,{userData:{...t,type:"LatheGeometry"}})}},NonParametricGeometry:class{static create(t){return this.build(this.normalizeInputs(t))}static normalizeInputs(t,e){var r,i;let a,o=null!==(r=null!==(i=t.geometry)&&void 0!==i?i:null===e||void 0===e?void 0:e.geometry)&&void 0!==r?r:(new n.BufferGeometry).copy(new n.BoxGeometry(100,100,100));void 0===e?(o.computeBoundingBox(),o.boundingBox.getSize(Tu),a={width:Tu.x,height:Tu.y,depth:Tu.z,subdivisions:0}):a=e.parameters;let s={...a,...t.parameters};return{parameters:{width:Math.abs(s.width),height:Math.abs(s.height),depth:Math.abs(s.depth),subdivisions:Math.abs(s.subdivisions)},geometry:o}}static build(t){var e;let{width:r,height:i,depth:a,subdivisions:o}=t.parameters,s=null!==(e=t.geometry)&&void 0!==e?e:(new n.BufferGeometry).copy(new n.BoxGeometry(100,100,100)),l=s.userData.parameters;void 0===l?(s.computeBoundingBox(),s.boundingBox.getSize(Tu)):Tu.set(l.width,l.height,l.depth),(r!==Tu.x||i!==Tu.y||a!==Tu.z)&&s.scale(0===Tu.x?1:r/Tu.x,0===Tu.y?1:i/Tu.y,0===Tu.z?1:a/Tu.z);let h=s.originalGeometry;try{o>0?(void 0===h||(null===l||void 0===l?void 0:l.subdivisions)!==o)&&(void 0===h&&(h=s),s=new Pu(o).modify(h).toBufferGeometry()):(void 0!==h&&(s=h),h=void 0,void 0===s.getAttribute("normal")&&s.computeVertexNormals())}catch{void 0!==h&&(s=h),h=void 0,void 0===s.getAttribute("normal")&&s.computeVertexNormals()}return void 0!==h&&Object.assign(s,{originalGeometry:h}),delete t.geometry,Object.assign(s,{userData:{...t,type:"NonParametricGeometry"}})}static loadFromUrl(t,e,r){new n.BufferGeometryLoader(r).load(t,(t=>{let r=this.normalizeInputs({geometry:t});t.boundingBox.getSize(Tu);let n=100/Tu.x;Object.assign(r.parameters,{width:100,height:Tu.y*n,depth:Tu.z*n}),e(this.build(r))}))}},PolygonGeometry:zu,PyramidGeometry:class{static create(t){return this.build(this.normalizeInputs(t))}static normalizeInputs(t,e){var r,n,i;let a=Object.assign({},null!==(r=null===e||void 0===e?void 0:e.parameters)&&void 0!==r?r:{width:100,radialSegments:4,heightSegments:1,cornerRadius:0,cornerSegments:8,openEnded:!1},t.parameters);return{parameters:Object.assign(a,{width:Math.abs(a.width),height:Math.abs(null!==(n=a.height)&&void 0!==n?n:a.width),depth:Math.abs(null!==(i=a.depth)&&void 0!==i?i:a.width)})}}static build(t){let{width:e,height:r,depth:n,radialSegments:i,heightSegments:a,openEnded:o,cornerRadius:s,cornerSegments:l}=t.parameters,h=new Bu(.5*e,r,i,a,o,s,l);return h.scale(1,1,n/e),Object.assign(h,{userData:{...t,type:"PyramidGeometry"}})}},RectangleGeometry:ku,SphereGeometry:class{static create(t){return this.build(this.normalizeInputs(t))}static normalizeInputs(t,e){var r,i,a;let o=Object.assign({},null!==(r=null===e||void 0===e?void 0:e.parameters)&&void 0!==r?r:{width:100,widthSegments:64,heightSegments:64,phiStart:0,phiLength:2*Math.PI,thetaStart:0,thetaLength:180},t.parameters);return o.thetaLength=n.MathUtils.clamp(o.thetaLength,0,180),{parameters:Object.assign(o,{width:Math.abs(o.width),height:Math.abs(null!==(i=o.height)&&void 0!==i?i:o.width),depth:Math.abs(null!==(a=o.depth)&&void 0!==a?a:o.width)})}}static build(t){let e,{width:r=100,height:i=r,depth:a=r,widthSegments:o=64,heightSegments:s=64,phiStart:l,phiLength:h,thetaStart:c,thetaLength:u}=t.parameters;return 0===u?(e=new n.BufferGeometry,e.setAttribute("position",new n.Float32BufferAttribute([],3))):e=new n.SphereGeometry(.5*r,o,s,l,h,c,u*n.MathUtils.DEG2RAD),e.scale(1,i/r,a/r),Object.assign(e,{userData:{...t,type:"SphereGeometry"}})}},PlaneGeometry:class{static create(t){return this.build(this.normalizeInputs(t))}static normalizeInputs(t,e){var r,n;let i=Object.assign({},null!==(r=null===e||void 0===e?void 0:e.parameters)&&void 0!==r?r:{width:100,depth:0,widthSegments:8,heightSegments:8},t.parameters);return{parameters:Object.assign(i,{width:Math.abs(i.width),height:Math.abs(null!==(n=i.height)&&void 0!==n?n:i.width),depth:0})}}static build(t){let{width:e=100,height:r=e,widthSegments:i=8,heightSegments:a=8}=t.parameters,o=new n.PlaneGeometry(e,r,i,a);return o.scale(1,1,1),Object.assign(o,{userData:{...t,type:"PlaneGeometry"}})}},BackdropGeometry:class{static create(t){return this.build(this.normalizeInputs(t))}static normalizeInputs(t,e){var r,n,i;let a=Object.assign({},null!==(r=null===e||void 0===e?void 0:e.parameters)&&void 0!==r?r:{width:100,angle:90,cornerRadius:24,cornerSegments:8},t.parameters);return{parameters:Object.assign(a,{width:Math.abs(a.width),height:Math.abs(null!==(n=a.height)&&void 0!==n?n:a.width),depth:Math.abs(null!==(i=a.depth)&&void 0!==i?i:a.width)})}}static build(t){let{width:e,height:r,depth:n,angle:i,cornerRadius:a,cornerSegments:o}=t.parameters,s=new Vu(e,r,n,i,a,o);return Object.assign(s,{userData:{...t,type:"BackdropGeometry"}})}},StarGeometry:Uu,TextFrameGeometry:class{static create(t){return this.build(this.normalizeInputs(t))}static normalizeInputs(t,e){var r,n,i;let a=Object.assign({},null!==(r=null===e||void 0===e?void 0:e.parameters)&&void 0!==r?r:{width:100,depth:0},t.parameters);return{parameters:Object.assign(a,{width:Math.abs(a.width),height:Math.abs(null!==(n=a.height)&&void 0!==n?n:a.width),depth:Math.abs(null!==(i=a.depth)&&void 0!==i?i:0)})}}static build(t){let{width:e,height:r}=t.parameters,i=new n.PlaneGeometry(e,r);return Object.assign(i,{userData:{...t,type:"TextFrameGeometry"}})}},TorusGeometry:class{static create(t){return this.build(this.normalizeInputs(t))}static normalizeInputs(t,e){var r,n,i;let a=Object.assign({},null!==(r=null===e||void 0===e?void 0:e.parameters)&&void 0!==r?r:{width:100,radialSegments:32,tubularSegments:64,arc:360,cornerRadius:30,cornerSegments:8},t.parameters),o=Math.abs(a.width),s=Math.abs(null!==(n=a.height)&&void 0!==n?n:a.width),l=Math.round(Math.abs(null!==(i=a.depth)&&void 0!==i?i:.25*a.width));return{parameters:Object.assign(a,{width:o,height:s,depth:l})}}static build(t){let{width:e,height:r,depth:i,radialSegments:a,tubularSegments:o,arc:s,cornerRadius:l,cornerSegments:h}=t.parameters,c=function(t,e,r,i,a,o,s,l,h,c,u){[e,r]=[r,e],s=e/2;let d=n.MathUtils.clamp(a/360,0,1);if(0===d){let t=new n.BufferGeometry;return t.setAttribute("position",new n.Float32BufferAttribute([],3)),t}return 1===d&&(c=0),new hu(!0,t,e,r,i,d,o,s,l,h,c,u)}(e,r,i,.5*e,s,o,0,0,a,l,h);return c.scale(1,r/e,1),Object.assign(c,{userData:{...t,type:"TorusGeometry"}})}},TorusKnotGeometry:class{static create(t){return this.build(this.normalizeInputs(t))}static normalizeInputs(t,e){var r,n,i,a;let o=Object.assign({},null!==(r=null===e||void 0===e?void 0:e.parameters)&&void 0!==r?r:{width:100,tubularSegments:64,radialSegments:32,p:2,q:3},t.parameters);return{parameters:Object.assign(o,{width:Math.abs(o.width),height:Math.abs(null!==(n=o.height)&&void 0!==n?n:o.width),depth:Math.abs(null!==(i=o.depth)&&void 0!==i?i:o.width),tube:null!==(a=o.tube)&&void 0!==a?a:.125*o.width})}}static build(t){let{width:e,tube:r,tubularSegments:i,radialSegments:a,p:o,q:s}=t.parameters,l=.5*e;l!==r&&(l-=r);let h=new n.TorusKnotGeometry(l,r,i,a,o,s);return Object.assign(h,{userData:{...t,type:"TorusKnotGeometry"}})}},TriangleGeometry:class{static create(t){return this.build(this.normalizeInputs(t))}static normalizeInputs(t,e){var r,n,i;let a=Object.assign({},null!==(r=null===e||void 0===e?void 0:e.parameters)&&void 0!==r?r:{width:100,depth:0,spikes:5,cornerRadius:0,extrudeBevelSize:0,extrudeBevelSegments:1,isRect:!1},t.parameters);return{shape:t.shape&&t.shape instanceof _c?t.shape:new _c,parameters:Object.assign(a,{width:Math.abs(a.width),height:Math.abs(null!==(n=a.height)&&void 0!==n?n:a.width*(a.isRect?1:Math.sqrt(3)/2)),depth:Math.abs(null!==(i=a.depth)&&void 0!==i?i:0)})}}static build(t){let{width:e=100,height:r,cornerRadius:n,depth:i,extrudeBevelSize:a,extrudeBevelSegments:o,isRect:s}=t.parameters,l=t.shape,h=.5*e,c=.5*r;s?(l.addPoint(l.createPoint(-h,c)),l.addPoint(l.createPoint(h,-c)),l.addPoint(l.createPoint(-h,-c))):(l.addPoint(l.createPoint(0,c)),l.addPoint(l.createPoint(h,-c)),l.addPoint(l.createPoint(-h,-c))),l.isClosed=!0;for(let d=0,p=l.points.length;d<p;d++)l.points[d].roundness=n;l.roundness=n,l.update();let u=$c.create({shape:l,parameters:{roundness:n,depth:i,extrudeBevelSize:a,extrudeBevelSegments:o}});return Object.assign(u,{userData:{...t,type:"TriangleGeometry"}})}},PathGeometry:class{static create(t){return this.build(this.normalizeInputs(t))}static normalizeInputs(t,e){var r,n,i,a,o;let s=Object.assign({},null!==(r=null===e||void 0===e?void 0:e.parameters)&&void 0!==r?r:{width:100,height:100,depth:1,subdivisions:12,roundness:0,extrudeBevelSize:0,extrudeBevelSegments:3},t.parameters),l=Math.abs(s.width),h=Math.abs(null!==(n=s.height)&&void 0!==n?n:s.width),c=Math.abs(null!==(i=s.depth)&&void 0!==i?i:0),u=null!==(a=null===e||void 0===e?void 0:e.shapeData)&&void 0!==a?a:eu.create({parameters:Ls}).userData.shape;return{path:null!==(o=t.path)&&void 0!==o?o:Ts.defaultData(),parameters:Object.assign(s,{width:l,height:h,depth:c,extrusion:{..._l,...s.extrusion}}),shapeData:u}}static build(t){if(t.path.points.length>=2){let e=new Ru(t);return Object.assign(e,{userData:{...t,type:"PathGeometry"}})}return Object.assign(new n.BufferGeometry,{userData:{...t,type:"PathGeometry"}})}},VectorGeometry:$c},Od=t=>Cd[t.type].create(t);function Dd(t){return null!==t&&"booleanOp"in t}var Pd=class extends(Eh(n.Mesh)){constructor(){super(...arguments),this.booleanMeshSetAddress=-1,this.booleanWasTransformed=!1,this.booleanMatrixInvOld=new n.Matrix4}updateVisible(t){super.updateVisible(t),this.visible=!Dd(this.parent)&&this.visible,Dd(this.parent)&&this.parent.invalidateDownstreamBooleanData()}freeBooleanPointer(){-1!==this.booleanMeshSetAddress&&(fd.freeMeshSet(this.booleanMeshSetAddress),this.booleanMeshSetAddress=-1)}invalidateDownstreamBooleanData(){return arguments.length>0&&void 0!==arguments[0]&&arguments[0]?this.booleanWasTransformed=!0:this.freeBooleanPointer(),Dd(this.parent)?this.parent.invalidateDownstreamBooleanData():this}invalidateUpstreamBooleanData(){this.freeBooleanPointer();for(let t of this.children)t instanceof Pd&&(t.freeBooleanPointer(),Dd(t)&&t.invalidateUpstreamBooleanData())}updateTransformState(t,e){let r=super.updateTransformState(t,e);return r&&Dd(this.parent)&&this.invalidateDownstreamBooleanData(!0),r}onVariableUpdate(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];super.onVariableUpdate(t),Dd(this.parent)&&this.invalidateDownstreamBooleanData(!0)}},Td=new n.Box3;function zd(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t.count,n=arguments.length>3?arguments[3]:void 0,i=arguments.length>4?arguments[4]:void 0,a=1/0,o=1/0,s=1/0,l=-1/0,h=-1/0,c=-1/0;for(let u=e;u<r;u++){let e=t.getX(u),r=t.getY(u),n=t.getZ(u);e<a&&(a=e),r<o&&(o=r),n<s&&(s=n),e>l&&(l=e),r>h&&(h=r),n>c&&(c=n)}Td.min.set(a,o,s),Td.max.set(l,h,c),Td.getCenter(n),Td.getSize(i).multiplyScalar(.5)}var Ed=new n.BufferGeometry,Id=new n.MeshBasicMaterial,Ld=class extends Pd{constructor(t,e){super(Ed,Id),this.super_Entity(t,e)}updateState(t,e){this.updateState_Entity(t,e)}updateEntityBoxSize(t,e){let r=this.geometry.getAttribute("position");void 0!==r?zd(r,this.geometry.drawRange.start,this.geometry.drawRange.count<1/0?this.geometry.drawRange.count:r.count,t,e):super.updateEntityBoxSize(t,e)}},Bd=class{constructor(t){var e;t=null!==(e=t)&&void 0!==e?e:{},this.name=t.name,this.type=t.type,this.node=t.node,this.size=t.size,this.needsUpdate=t.needsUpdate}get value(){return this.node.value}set value(t){this.node.value=t}},kd=class{constructor(t){this.hashProperties=void 0,this.isNode=!0,this.shortcuts={},this.uuid=n.MathUtils.generateUUID(),this.type=t,this.name=""}analyze(t,e){var r;e=null!==(r=e)&&void 0!==r?r:{},t.analyzing=!0,this.build(t.addFlow(e.slot,e.cache,e.context),"v4"),t.clearVertexNodeCode(),t.clearFragmentNodeCode(),t.removeFlow(),t.analyzing=!1}analyzeAndFlow(t,e,r){var n;return r=null!==(n=r)&&void 0!==n?n:{},this.analyze(t,r),this.flow(t,e,r)}flow(t,e,r){var n;r=null!==(n=r)&&void 0!==n?n:{},t.addFlow(r.slot,r.cache,r.context);let i={result:this.build(t,e),code:t.clearNodeCode(),extra:t.context.extra};return t.removeFlow(),i}build(t,e,r){var n;e=null!==(n=e)&&void 0!==n?n:this.getType(t,e);let i=t.getNodeData(null!==r&&void 0!==r?r:this);return t.analyzing&&this.appendDepsNode(t,i,e),-1===t.nodes.indexOf(this)&&t.nodes.push(this),void 0!==this.updateFrame&&-1===t.updaters.indexOf(this)&&t.updaters.push(this),this.generate(t,e,r)}updateFrame(t){}generateReadonly(t,e,r,n,i,a){return""}generate(t,e,r,n,i){return""}parse(t,e,r,n){}appendDepsNode(t,e,r){e.deps=(e.deps||0)+1;let n=t.getTypeLength(r);(n>(e.outputMax||0)||this.getType(t,r))&&(e.outputMax=n,e.output=r)}setName(t){this.name=t}getName(){return this.name}getType(t,e){return"sampler2D"===e||"samplerCube"===e?e:this.type}getHash(){let t,e,r="{";for(t in this)e=this[t],e instanceof kd&&(r+='"'+t+'":'+e.getHash()+",");if(this.hashProperties)for(let n=0;n<this.hashProperties.length;n++)t=this.hashProperties[n],e=this[t],r+='"'+t+'":"'+String(e)+'",';return r+='"id":"'+this.uuid+'"}',r}},Vd=new class{constructor(){this.nodes={},this.keywords={}}add(t){this.nodes[t.name]=t}addKeyword(t,e,r){r=void 0===r||r,this.keywords[t]={callback:e,cache:r}}remove(t){delete this.nodes[t.name]}removeKeyword(t){delete this.keywords[t]}get(t){return this.nodes[t]}getKeyword(t,e){return this.keywords[t].callback(e)}getKeywordData(t){return this.keywords[t]}contains(t){return void 0!==this.nodes[t]}containsKeyword(t){return void 0!==this.keywords[t]}},Ud=class extends kd{constructor(t,e){var r;super(t),this.scope="",e=null!==(r=e)&&void 0!==r?r:{},this.shared=void 0===e.shared||e.shared,this.unique=void 0!==e.unique&&e.unique}build(t,e,r,i){var a;if(e=null!==(a=e)&&void 0!==a?a:this.getType(t),this.getShared(t,e)){var o;let a=this.getUnique(t,e);a&&void 0===this.uuid&&(this.uuid=n.MathUtils.generateUUID()),r=t.getUUID(null!==(o=r)&&void 0!==o?o:this.getUUID(),!a);let s=t.getNodeData(r),l=s.output||this.getType(t);if(t.analyzing)return(s.deps||0)>0||this.getLabel()?(this.appendDepsNode(t,s,e),this.generate(t,e,r)):super.build(t,e,r);if(a)return s.name=s.name||super.build(t,e,r),s.name;if(!this.getLabel()&&(!this.getShared(t,l)||t.context.ignoreCache||1===s.deps))return super.build(t,e,r);r=this.getUUID(!1);let h=this.getTemp(t,r);if(h)return t.format(h,l,e);{h=super.generate(t,e,r,s.output,i);let n=this.generate(t,l,r);return t.addNodeCode(h+" = "+n+";"),t.format(h,l,e)}}return super.build(t,e,r)}getShared(t,e){return"sampler2D"!==e&&"samplerCube"!==e&&this.shared}getUnique(t,e){return this.unique}setLabel(t){return this.label=t,this}getLabel(){return this.label}getUUID(t){let e=this.uuid;return"string"==typeof this.scope&&(e=this.scope+"-"+e),e}getTemp(t,e){e=e||this.uuid;let r=t.getVars()[e];return r?r.name:void 0}generate(t,e,r,n,i){var a;return this.getShared(t,e)||console.error("TempNode is not shared"),r=null!==(a=r)&&void 0!==a?a:this.uuid,t.getTempVar(r,null!==n&&void 0!==n?n:this.getType(t),i,this.getLabel()).name}},jd=class extends Ud{constructor(t,e){var r;(e=null!==(r=e)&&void 0!==r?r:{}).shared=void 0!==e.shared&&e.shared,super(t,e),this.readonly=!1}setReadonly(t){return this.readonly=t,this.hashProperties=this.readonly?["value"]:void 0,this}getReadonly(){return this.readonly}generate(t,e,r,n,i,a){var o,s;r=t.getUUID(null!==(o=r)&&void 0!==o?o:this.getUUID()),n=null!==(s=n)&&void 0!==s?s:this.getType(t);let l=t.getNodeData(r);return this.getReadonly()&&void 0!==this.generateReadonly?this.generateReadonly(t,e,r,n,i,a):t.isShader("vertex")?(l.vertex||(l.vertex=t.createVertexUniform(n,this,i,a,this.getLabel())),t.format(l.vertex.name,n,e)):(l.fragment||(l.fragment=t.createFragmentUniform(n,this,i,a,this.getLabel())),t.format(l.fragment.name,n,e))}},Nd=class extends jd{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1?arguments[1]:void 0;super("v2"),this.nodeType="Vector2",this.value=t instanceof n.Vector2?t:new n.Vector2(t,e)}get x(){return this.value.x}set x(t){this.value.x=t}get y(){return this.value.y}set y(t){this.value.y=t}generateReadonly(t,e,r,n,i,a){return t.format("vec2("+this.value.x+", "+this.value.y+")",n,e)}},Rd=class extends jd{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1?arguments[1]:void 0,r=arguments.length>2?arguments[2]:void 0;super("v3"),this.nodeType="Vector3",this.value=t instanceof n.Vector3?t:new n.Vector3(t,e,r)}get x(){return this.value.x}set x(t){this.value.x=t}get y(){return this.value.y}set y(t){this.value.y=t}get z(){return this.value.z}set z(t){this.value.z=t}generateReadonly(t,e,r,n,i,a){return t.format("vec3("+this.value.x+", "+this.value.y+", "+this.value.z+")",n,e)}},Fd=class extends n.Color{constructor(t,e,r,n){super(t,e,r),this.isColorA=!0,this.a=n}setRGBA(t,e,r,n){super.setRGB(t,e,r),this.a=n}copy(t){return super.copy(t),this.a="a"in t?t.a:1,this}clone(){return new this.constructor(this.r,this.g,this.b,this.a)}setStyle(t){let e,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"srgb";if("transparent"===t)return this.setRGBA(0,0,0,0),this;if(e=/^((?:rgb|hsl)a?)\(([^)]*)\)/.exec(t)){let n,i=e[1],a=e[2];switch(i){case"rgb":case"rgba":if(n=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return this.a="rgba"===i?parseFloat(n[4]):1,super.setStyle(t,r);break;case"hsl":case"hsla":if(n=/^\s*(\d*\.?\d+)\s*,\s*(\d*\.?\d+)%\s*,\s*(\d*\.?\d+)%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return this.a="hsla"===i?parseFloat(n[4]):1,super.setStyle(t,r)}}return super.setStyle(t,r)}get x(){return this.r}get y(){return this.g}get z(){return this.b}get w(){return this.a}set x(t){this.r=t}set y(t){this.g=t}set z(t){this.b=t}set w(t){this.a=t}},Gd=class extends jd{constructor(t){super("v4"),this.nodeType="Vector4",this.value=t instanceof Fd?t:new Fd(t.r,t.g,t.b,t.a)}generateReadonly(t,e,r,n,i,a){return t.format("vec4("+this.value.r+", "+this.value.g+", "+this.value.b+", "+this.value.a+")",n,e)}},qd=/^\s*([a-z_0-9]+)\s([a-z_0-9]+)\s*\((.*?)\)/i,Hd=/[a-z_0-9]+/gi,Wd=class extends Ud{constructor(t,e,r,n,i){super(i),this.src="",this.nodeType="Function",this.useKeywords=!0,this.includes=[],this.extensions={},this.keywords={},this.isMethod=void 0===i,this.isInterface=!1,this.parse(t,e,r,n)}getShared(t,e){return!this.isMethod}getType(t){return t.getTypeByFormat(this.type)}getInputByName(t){if(this.inputs){let e=this.inputs.length;for(;e--;)if(this.inputs[e].name===t)return this.inputs[e]}}getIncludeByName(t){if(this.includes){let e=this.includes.length;for(;e--;)if(this.includes[e].name===t)return this.includes[e]}}generate(t,e,r,n,i){let a,o=0,s=this.src;if(this.includes)for(let h=0;h<this.includes.length;h++)t.include(this.includes[h],this);for(let h in this.extensions)t.extensions[h]=!0;let l=[];for(;a=Hd.exec(this.src);)l.push(a);for(let h=0;h<l.length;h++){let e=l[h],r=e[0],n=!this.isMethod||!this.getInputByName(r),i=r;if(this.keywords[r]||this.useKeywords&&n&&Vd.containsKeyword(r)){let e=this.keywords[r];if(!e){let n=Vd.getKeywordData(r);n.cache&&(e=t.keywords[r]),e=e||Vd.getKeyword(r,t),n.cache&&(t.keywords[r]=e)}i=e.build(t)}r!==i&&"."!==s[e.index+o-1]&&(s=s.substring(0,e.index+o)+i+s.substring(e.index+r.length+o),o+=i.length-r.length),void 0===this.getIncludeByName(i)&&Vd.contains(i)&&t.include(Vd.get(i))}return"source"===e?s:this.isMethod?(this.isInterface||t.include(this,void 0,s),this.name):t.format("( "+s+" )",this.getType(t),e)}parse(t,e,r,n){if(this.src=t||"",this.includes=null!==e&&void 0!==e?e:[],this.extensions=null!==r&&void 0!==r?r:{},this.keywords=null!==n&&void 0!==n?n:{},this.isMethod){let t=qd.exec(this.src);if(this.inputs=[],t&&4==t.length){this.type=t[1],this.name=t[2];let e=t[3].match(Hd);if(e){let t=0;for(;t<e.length;){let r,n=e[t++];"in"===n||"out"===n||"inout"===n?r=e[t++]:(r=n,n="");let i=e[t++];this.inputs.push({name:i,type:r,qualifier:n})}}this.isInterface=-1===this.src.indexOf("{")}else this.type="",this.name=""}}},Xd=/^([a-z_0-9]+)\s([a-z_0-9]+)\s?\=?\s?(.*?)(\;|$)/i,Yd=class extends Ud{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",e=arguments.length>1?arguments[1]:void 0;super(),this.src="",this.useDefine=!1,this.nodeType="Const",this.parse(t||Yd.PI,void 0,void 0,void 0,e)}getType(t){return t.getTypeByFormat(this.type)}parse(t,e,r,n,i){this.src=t||"";let a,o,s="",l=Xd.exec(t);this.useDefine=null!==i&&void 0!==i?i:"#"===this.src.charAt(0),l&&l.length>1?(o=l[1],a=l[2],s=l[3]):(a=this.src,o="f"),this.name=a,this.type=o,this.value=s}build(t,e){if("source"===e){if(this.value)return this.useDefine?"#define "+this.name+" "+this.value:"const "+this.type+" "+this.name+" = "+this.value+";";if(this.useDefine)return this.src}return t.include(this),t.format(this.name,this.getType(t),e)}generate(t,e,r,n,i){return t.format(this.name,this.getType(t),e)}},Qd=Yd;Qd.PI="PI",Qd.PI2="PI2",Qd.RECIPROCAL_PI="RECIPROCAL_PI",Qd.RECIPROCAL_PI2="RECIPROCAL_PI2",Qd.LOG2="LOG2",Qd.EPSILON="EPSILON";var Zd=new RegExp("^structs*([a-z_0-9]+)s*{s*((.|\n)*?)}","gim"),Kd=new RegExp("s*(w*?)s*(w*?)(=|;)","gim"),Jd=class extends Ud{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";super(),this.inputs=[],this.src="",this.nodeType="Struct",this.parse(t)}getType(t){return t.getTypeByFormat(this.name)}getInputByName(t){let e=this.inputs.length;for(;e--;)if(this.inputs[e].name===t)return this.inputs[e]}generate(t,e,r,n,i){return"source"===e?this.src+";":t.format("( "+this.src+" )",this.getType(t),e)}parse(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";this.src=t,this.inputs=[];let e=Zd.exec(t);if(e){let t,r=e[2];for(;t=Kd.exec(r);)this.inputs.push({type:t[1],name:t[2]});this.name=e[1]}else this.name="";this.type=this.name}},$d=class extends Ud{constructor(t){super("v2",{shared:!1}),this.nodeType="UV",this.index=null!==t&&void 0!==t?t:0}generate(t,e){t.requires.uv[this.index]=!0;let r=this.index>0?this.index+1:"",n=t.isShader("vertex")?"uv"+r:"vUv"+r;return t.format(n,this.getType(t),e)}};Vd.addKeyword("uv",(function(){return new $d})),Vd.addKeyword("uv2",(function(){return new $d(1)}));var tp=class extends Ud{constructor(t,e){super("v4"),this.nodeType="ColorSpace",this.input=t,this.method=null!==e&&void 0!==e?e:tp.LINEAR_TO_LINEAR,this.hashProperties=["method"]}static getEncodingComponents(t){switch(t){case n.LinearEncoding:return["Linear"];case n.sRGBEncoding:return["sRGB"];default:return[]}}generate(t,e){var r;let n=this.input.build(t,"v4"),i=this.getType(t),a=tp.Nodes[this.method],o=t.include(a);if(o===tp.LINEAR_TO_LINEAR)return t.format(n,i,e);if(2===(null===(r=a.inputs)||void 0===r?void 0:r.length)){let r=this.factor.build(t,"f");return t.format(o+"( "+n+", "+r+" )",i,e)}return t.format(o+"( "+n+" )",i,e)}fromEncoding(t){let e=tp.getEncodingComponents(t);this.method="LinearTo"+e[0],this.factor=e[1]}fromDecoding(t){let e=tp.getEncodingComponents(t);this.method=e[0]+"ToLinear",this.factor=e[1]}},ep=tp;ep.Nodes={LinearToLinear:new Wd(["vec4 LinearToLinear( in vec4 value ) {","\treturn value;","}"].join("\n")),sRGBToLinear:new Wd(["vec4 sRGBToLinear( in vec4 value ) {","\treturn vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );","}"].join("\n")),LinearTosRGB:new Wd(["vec4 LinearTosRGB( in vec4 value ) {","\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.w );","}"].join("\n"))},ep.LINEAR_TO_LINEAR="LinearToLinear",ep.SRGB_TO_LINEAR="sRGBToLinear",ep.LINEAR_TO_SRGB="LinearTosRGB";var rp=class extends Wd{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",arguments.length>4?arguments[4]:void 0,arguments.length>3?arguments[3]:void 0,arguments.length>2?arguments[2]:void 0,arguments.length>1?arguments[1]:void 0),this.nodeType="Expression"}},np=class extends jd{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new n.Texture,e=arguments.length>1?arguments[1]:void 0,r=arguments.length>2?arguments[2]:void 0,i=arguments.length>3?arguments[3]:void 0;super("v4",{shared:!0}),this.nodeType="Texture",this.value=t,this.uv=null!==e&&void 0!==e?e:new $d,this.bias=r,this.project=void 0!==i&&i}getTexture(t,e){return super.generate(t,e,this.value.uuid,"t")}generate(t,e){var r;if("sampler2D"===e)return this.getTexture(t,e);let n,i,a=this.getTexture(t,e),o=this.uv.build(t,this.project?"v4":"v2"),s=this.bias?this.bias.build(t,"f"):void 0;void 0===s&&t.context.bias&&(s=t.context.bias.setTexture(this).build(t,"f")),n=this.project?"texture2DProj":s?"tex2DBias":"tex2D",i=s?n+"( "+a+", "+o+", "+s+" )":n+"( "+a+", "+o+" )";let l={include:t.isShader("vertex"),ignoreCache:!0},h=this.getType(t);return t.addContext(l),this.colorSpace=null!==(r=this.colorSpace)&&void 0!==r?r:new ep(new rp("",h)),this.colorSpace.fromDecoding(t.getTextureEncodingFromMap(this.value)),this.colorSpace.input.parse(i),i=this.colorSpace.build(t,h),t.removeContext(),t.format(i,h,e)}},ip=class extends jd{constructor(t){super("f"),this.nodeType="Float",this.value=null!==t&&void 0!==t?t:0}generateReadonly(t,e,r,n,i,a){return t.format(this.value+(this.value%1?"":".0"),n,e)}},ap=class extends Ud{constructor(t,e){super(),this.inputs=[],this.nodeType="FunctionCall",this.value=t,this.inputs=null!==e&&void 0!==e?e:[]}getFunction(){return this.value}getType(t){return this.value.getType(t)}generate(t,e,r,n,i){n=this.getType(t);let a=this.value,o=a.build(t,e)+"( ",s=[];if(a.inputs){for(let e=0;e<a.inputs.length;e++){let r=a.inputs[e],n=this.inputs[e]||this.inputs[r.name];s.push(n.build(t,t.getTypeByFormat(r.type)))}o+=s.join(", ")+" )"}return t.format(o,n,e)}},op=class extends Ud{constructor(t,e){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:op.ADD;super(),this.nodeType="Operator",this.type=t.type,this.a=t,this.b=e,this.op=r}getType(t){let e=this.a.getType(t),r=this.b.getType(t);return t.isTypeMatrix(e)?"v4":t.getTypeLength(r)>t.getTypeLength(e)?r:e}generate(t,e){let r=this.getType(t);this.type=r;let n=this.a.build(t,r),i=this.b.build(t,r);return t.format("( "+n+" "+this.op+" "+i+" )",r,e)}},sp=op;sp.ADD="+",sp.SUB="-",sp.MUL="*",sp.DIV="/";var lp=class extends Ud{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:lp.ABS,r=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0;super(),this.nodeType="Math",this.a=t,"string"!=typeof e?this.b=e:n=e,"string"!=typeof r?this.c=r:n=r,this.method=n,this.hashProperties=["method"]}getNumInputs(t){switch(this.method){case lp.MIX:case lp.CLAMP:case lp.REFRACT:case lp.SMOOTHSTEP:case lp.FACEFORWARD:return 3;case lp.MIN:case lp.MAX:case lp.MOD:case lp.STEP:case lp.REFLECT:case lp.DISTANCE:case lp.DOT:case lp.CROSS:case lp.POW:return 2;default:return 1}}getInputType(t){let e=t.getTypeLength(this.a.getType(t)),r=this.b?t.getTypeLength(this.b.getType(t)):0,n=this.c?t.getTypeLength(this.c.getType(t)):0;return e>r&&e>n?this.a.getType(t):r>n?this.b.getType(t):this.c.getType(t)}getType(t){switch(this.method){case lp.LENGTH:case lp.DISTANCE:case lp.DOT:return"f";case lp.CROSS:return"v3"}return this.getInputType(t)}generate(t,e){let r,n,i,a=this.a?t.getTypeLength(this.a.getType(t)):0,o=this.b?t.getTypeLength(this.b.getType(t)):0,s=this.c?t.getTypeLength(this.c.getType(t)):0,l=this.getInputType(t),h=this.getType(t);switch(this.type=h,this.method){case lp.NEGATE:return t.format("( -"+this.a.build(t,l)+" )",l,e);case lp.INVERT:return t.format("( 1.0 - "+this.a.build(t,l)+" )",l,e);case lp.CROSS:r=this.a.build(t,"v3"),n=this.b.build(t,"v3");break;case lp.STEP:r=this.a.build(t,1===a?"f":l),n=this.b.build(t,l);break;case lp.MIN:case lp.MAX:case lp.MOD:r=this.a.build(t,l),n=this.b.build(t,1===o?"f":l);break;case lp.REFRACT:r=this.a.build(t,l),n=this.b.build(t,l),i=this.c.build(t,"f");break;case lp.MIX:r=this.a.build(t,l),n=this.b.build(t,l),i=this.c.build(t,1===s?"f":l);break;default:r=this.a.build(t,l),this.b&&(n=this.b.build(t,l)),this.c&&(i=this.c.build(t,l))}let c=[];c.push(r),n&&c.push(n),i&&c.push(i);let u=this.getNumInputs(t);if(c.length!==u)throw Error('Arguments not match used in "'.concat(this.method,'". Require ').concat(u,", currently ").concat(c.length,"."));return t.format(this.method+"( "+c.join(", ")+" )",h,e)}},hp=lp;hp.RAD="radians",hp.DEG="degrees",hp.EXP="exp",hp.EXP2="exp2",hp.LOG="log",hp.LOG2="log2",hp.SQRT="sqrt",hp.INV_SQRT="inversesqrt",hp.FLOOR="floor",hp.CEIL="ceil",hp.NORMALIZE="normalize",hp.FRACT="fract",hp.SATURATE="saturate",hp.SIN="sin",hp.COS="cos",hp.TAN="tan",hp.ASIN="asin",hp.ACOS="acos",hp.ARCTAN="atan",hp.ABS="abs",hp.SIGN="sign",hp.LENGTH="length",hp.NEGATE="negate",hp.INVERT="invert",hp.MIN="min",hp.MAX="max",hp.MOD="mod",hp.STEP="step",hp.REFLECT="reflect",hp.DISTANCE="distance",hp.DOT="dot",hp.CROSS="cross",hp.POW="pow",hp.MIX="mix",hp.CLAMP="clamp",hp.REFRACT="refract",hp.SMOOTHSTEP="smoothstep",hp.FACEFORWARD="faceforward";var cp=class extends Ud{constructor(t,e,r){super("v4"),this.nodeType="TextureCubeUV",this.value=t,this.uv=e,this.bias=r}bilinearCubeUV(t,e,r,n){var i,a,o,s;let l=new ap(cp.Nodes.bilinearCubeUV,[e,r,n]);this.colorSpaceTL=null!==(i=this.colorSpaceTL)&&void 0!==i?i:new ep(new rp("","v4")),this.colorSpaceTL.fromDecoding(t.getTextureEncodingFromMap(this.value.value)),this.colorSpaceTL.input.parse(l.build(t)+".tl"),this.colorSpaceTR=null!==(a=this.colorSpaceTR)&&void 0!==a?a:new ep(new rp("","v4")),this.colorSpaceTR.fromDecoding(t.getTextureEncodingFromMap(this.value.value)),this.colorSpaceTR.input.parse(l.build(t)+".tr"),this.colorSpaceBL=null!==(o=this.colorSpaceBL)&&void 0!==o?o:new ep(new rp("","v4")),this.colorSpaceBL.fromDecoding(t.getTextureEncodingFromMap(this.value.value)),this.colorSpaceBL.input.parse(l.build(t)+".bl"),this.colorSpaceBR=null!==(s=this.colorSpaceBR)&&void 0!==s?s:new ep(new rp("","v4")),this.colorSpaceBR.fromDecoding(t.getTextureEncodingFromMap(this.value.value)),this.colorSpaceBR.input.parse(l.build(t)+".br");let h={include:t.isShader("vertex"),ignoreCache:!0};t.addContext(h),this.colorSpaceTLExp=new rp(this.colorSpaceTL.build(t,"v4"),"v4"),this.colorSpaceTRExp=new rp(this.colorSpaceTR.build(t,"v4"),"v4"),this.colorSpaceBLExp=new rp(this.colorSpaceBL.build(t,"v4"),"v4"),this.colorSpaceBRExp=new rp(this.colorSpaceBR.build(t,"v4"),"v4"),t.removeContext();let c=new rp("mix( mix( cubeUV_TL, cubeUV_TR, cubeUV.f.x ), mix( cubeUV_BL, cubeUV_BR, cubeUV.f.x ), cubeUV.f.y )","v4");return c.keywords.cubeUV_TL=this.colorSpaceTLExp,c.keywords.cubeUV_TR=this.colorSpaceTRExp,c.keywords.cubeUV_BL=this.colorSpaceBLExp,c.keywords.cubeUV_BR=this.colorSpaceBRExp,c.keywords.cubeUV=l,c}generate(t,e){if(t.isShader("fragment")){let r=this.uv,n=this.bias||t.context.roughness,i=new ap(cp.Nodes.roughnessToMip,[n]),a=new hp(i,cp.Nodes.m0,cp.Nodes.cubeUV_maxMipLevel,hp.CLAMP),o=new hp(a,hp.FLOOR),s=new hp(a,hp.FRACT),l=this.bilinearCubeUV(t,this.value,r,o),h=this.bilinearCubeUV(t,this.value,r,new sp(o,new ip(1).setReadonly(!0),sp.ADD)),c=new hp(l,h,s,hp.MIX);return t.format(c.build(t),"v4",e)}return console.warn("TextureCubeUVNode is not compatible with "+t.shader+" shader."),t.format("vec4( 0.0 )",this.getType(t),e)}},up=cp;up.Nodes=function(){let t=new Jd("struct TextureCubeUVData {\n\t\t\tvec4 tl;\n\t\t\tvec4 tr;\n\t\t\tvec4 br;\n\t\t\tvec4 bl;\n\t\t\tvec2 f;\n\t\t}"),e=new Qd("float cubeUV_maxMipLevel 8.0",!0),r=new Qd("float cubeUV_minMipLevel 4.0",!0),n=new Qd("float cubeUV_maxTileSize 256.0",!0),i=new Qd("float cubeUV_minTileSize 16.0",!0),a=new Wd("float getFace(vec3 direction) {\n\t\t\t\tvec3 absDirection = abs(direction);\n\t\t\t\tfloat face = -1.0;\n\t\t\t\tif (absDirection.x > absDirection.z) {\n\t\t\t\t\tif (absDirection.x > absDirection.y)\n\t\t\t\t\t\tface = direction.x > 0.0 ? 0.0 : 3.0;\n\t\t\t\t\telse\n\t\t\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t\t\t} else {\n\t\t\t\t\tif (absDirection.z > absDirection.y)\n\t\t\t\t\t\tface = direction.z > 0.0 ? 2.0 : 5.0;\n\t\t\t\t\telse\n\t\t\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t\t\t}\n\t\t\t\treturn face;\n\t\t}");a.useKeywords=!1;let o=new Wd("vec2 getUV(vec3 direction, float face) {\n\t\t\t\tvec2 uv;\n\t\t\t\tif (face == 0.0) {\n\t\t\t\t\tuv = vec2(direction.z, direction.y) / abs(direction.x); // pos x\n\t\t\t\t} else if (face == 1.0) {\n\t\t\t\t\tuv = vec2(-direction.x, -direction.z) / abs(direction.y); // pos y\n\t\t\t\t} else if (face == 2.0) {\n\t\t\t\t\tuv = vec2(-direction.x, direction.y) / abs(direction.z); // pos z\n\t\t\t\t} else if (face == 3.0) {\n\t\t\t\t\tuv = vec2(-direction.z, direction.y) / abs(direction.x); // neg x\n\t\t\t\t} else if (face == 4.0) {\n\t\t\t\t\tuv = vec2(-direction.x, direction.z) / abs(direction.y); // neg y\n\t\t\t\t} else {\n\t\t\t\t\tuv = vec2(direction.x, direction.y) / abs(direction.z); // neg z\n\t\t\t\t}\n\t\t\t\treturn 0.5 * (uv + 1.0);\n\t\t}");o.useKeywords=!1;let s=new Wd("TextureCubeUVData bilinearCubeUV(sampler2D envMap, vec3 direction, float mipInt) {\n\t\t\tfloat face = getFace(direction);\n\t\t\tfloat filterInt = max(cubeUV_minMipLevel - mipInt, 0.0);\n\t\t\tmipInt = max(mipInt, cubeUV_minMipLevel);\n\t\t\tfloat faceSize = exp2(mipInt);\n\t\t\tfloat texelSize = 1.0 / (3.0 * cubeUV_maxTileSize);\n\t\t\tvec2 uv = getUV(direction, face) * (faceSize - 1.0);\n\t\t\tvec2 f = fract(uv);\n\t\t\tuv += 0.5 - f;\n\t\t\tif (face > 2.0) {\n\t\t\t\tuv.y += faceSize;\n\t\t\t\tface -= 3.0;\n\t\t\t}\n\t\t\tuv.x += face * faceSize;\n\t\t\tif(mipInt < cubeUV_maxMipLevel){\n\t\t\t\tuv.y += 2.0 * cubeUV_maxTileSize;\n\t\t\t}\n\t\t\tuv.y += filterInt * 2.0 * cubeUV_minTileSize;\n\t\t\tuv.x += 3.0 * max(0.0, cubeUV_maxTileSize - 2.0 * faceSize);\n\t\t\tuv *= texelSize;\n\t\t\tvec4 tl = texture2D(envMap, uv);\n\t\t\tuv.x += texelSize;\n\t\t\tvec4 tr = texture2D(envMap, uv);\n\t\t\tuv.y += texelSize;\n\t\t\tvec4 br = texture2D(envMap, uv);\n\t\t\tuv.x -= texelSize;\n\t\t\tvec4 bl = texture2D(envMap, uv);\n\t\t\treturn TextureCubeUVData( tl, tr, br, bl, f );\n\t\t}",[t,a,o,e,r,n,i]);s.useKeywords=!1;let l=new Qd("float r0 1.0",!0),h=new Qd("float v0 0.339",!0),c=new Qd("float m0 -2.0",!0),u=new Qd("float r1 0.8",!0),d=new Qd("float v1 0.276",!0),p=new Qd("float m1 -1.0",!0),f=new Qd("float r4 0.4",!0),m=new Qd("float v4 0.046",!0),v=new Qd("float m4 2.0",!0),g=new Qd("float r5 0.305",!0),y=new Qd("float v5 0.016",!0),b=new Qd("float m5 3.0",!0),x=new Qd("float r6 0.21",!0),w=new Qd("float v6 0.0038",!0),_=new Qd("float m6 4.0",!0);return{bilinearCubeUV:s,roughnessToMip:new Wd("float roughnessToMip(float roughness) {\n\t\t\tfloat mip = 0.0;\n\t\t\tif (roughness >= r1) {\n\t\t\t\tmip = (r0 - roughness) * (m1 - m0) / (r0 - r1) + m0;\n\t\t\t} else if (roughness >= r4) {\n\t\t\t\tmip = (r1 - roughness) * (m4 - m1) / (r1 - r4) + m1;\n\t\t\t} else if (roughness >= r5) {\n\t\t\t\tmip = (r4 - roughness) * (m5 - m4) / (r4 - r5) + m4;\n\t\t\t} else if (roughness >= r6) {\n\t\t\t\tmip = (r5 - roughness) * (m6 - m5) / (r5 - r6) + m5;\n\t\t\t} else {\n\t\t\t\tmip = -2.0 * log2(1.16 * roughness);// 1.16 = 1.79^0.25\n\t\t\t}\n\t\t\treturn mip;\n\t\t}",[l,h,c,u,d,p,f,m,v,g,y,b,x,w,_]),m0:c,cubeUV_maxMipLevel:e}}();var dp=class extends Ud{constructor(t){super("v3"),this.nodeType="Normal",this.scope=null!==t&&void 0!==t?t:dp.VIEW}getShared(){return this.scope===dp.WORLD}build(t,e,r,n){let i=t.context[this.scope+"Normal"];return i?i.build(t,e,r,n):super.build(t,e,r)}generate(t,e,r,n,i){let a;switch(this.scope){case dp.VIEW:a=t.isShader("vertex")?"transformedNormal":"geometryNormal";break;case dp.LOCAL:t.isShader("vertex")?a="objectNormal":(t.requires.normal=!0,a="vObjectNormal");break;case dp.WORLD:t.isShader("vertex")?a="inverseTransformDirection( transformedNormal, viewMatrix ).xyz":(t.requires.worldNormal=!0,a="vWNormal")}return t.format(a,this.getType(t),e)}},pp=dp;pp.LOCAL="local",pp.WORLD="world",pp.VIEW="view",pp.NORMAL="normal",Vd.addKeyword("viewNormal",(function(){return new pp(pp.VIEW)})),Vd.addKeyword("localNormal",(function(){return new pp(pp.NORMAL)})),Vd.addKeyword("worldNormal",(function(){return new pp(pp.WORLD)}));var fp=class extends Ud{constructor(t){super("v3"),this.nodeType="Position",this.scope=null!==t&&void 0!==t?t:fp.LOCAL}getType(){return this.scope===fp.PROJECTION?"v4":this.type}getShader(){switch(this.scope){case fp.LOCAL:case fp.WORLD:return!1}return!0}generate(t,e,r,n,i){let a;switch(this.scope){case fp.LOCAL:t.isShader("vertex")?a="transformed":(t.requires.position=!0,a="vPosition");break;case fp.WORLD:if(t.isShader("vertex"))return"( modelMatrix * vec4( transformed, 1.0 ) ).xyz";t.requires.worldPosition=!0,a="vWPosition";break;case fp.VIEW:a=t.isShader("vertex")?"-mvPosition.xyz":"vViewPosition";break;case fp.PROJECTION:a=t.isShader("vertex")?"( projectionMatrix * modelViewMatrix * vec4( position, 1.0 ) )":"vec4( 0.0 )"}return t.format(a,this.getType(),e)}},mp=fp;mp.LOCAL="local",mp.WORLD="world",mp.VIEW="view",mp.PROJECTION="projection",Vd.addKeyword("position",(function(){return new mp})),Vd.addKeyword("worldPosition",(function(){return new mp(mp.WORLD)})),Vd.addKeyword("viewPosition",(function(){return new mp(mp.VIEW)}));var vp=class extends Ud{constructor(t){super("v3"),this.nodeType="Reflect",this.scope=null!==t&&void 0!==t?t:vp.CUBE}getUnique(t){return!t.context.viewNormal}getType(){return this.scope===vp.SPHERE?"v2":this.type}generate(t,e){let r=this.getUnique(t);if(t.isShader("fragment")){let n;switch(this.scope){case vp.VECTOR:{let e=new pp(pp.VIEW),i=t.context.roughness,a=e.build(t,"v3"),o=new mp(mp.VIEW).build(t,"v3"),s=i?i.build(t,"f"):void 0,l="reflect( -normalize( ".concat(o," ), ").concat(a," )");s&&(l="normalize( mix( ".concat(l,", ").concat(a,", ").concat(s," * ").concat(s," ) )"));let h="inverseTransformDirection( ".concat(l,", viewMatrix )");r?(t.addNodeCode("vec3 reflectVec = ".concat(h,";")),n="reflectVec"):n=h;break}case vp.CUBE:{let e=new vp(vp.VECTOR).build(t,"v3"),i="vec3( -"+e+".x, "+e+".yz )";r?(t.addNodeCode("vec3 reflectCubeVec = ".concat(i,";")),n="reflectCubeVec"):n=i;break}case vp.SPHERE:{let e="normalize( ( viewMatrix * vec4( "+new vp(vp.VECTOR).build(t,"v3")+", 0.0 ) ).xyz + vec3( 0.0, 0.0, 1.0 ) ).xy * 0.5 + 0.5";r?(t.addNodeCode("vec2 reflectSphereVec = ".concat(e,";")),n="reflectSphereVec"):n=e;break}}return t.format(n,this.getType(),e)}return console.warn("ReflectNode is not compatible with "+t.shader+" shader."),t.format("vec3( 0.0 )",this.type,e)}},gp=vp;gp.CUBE="cube",gp.SPHERE="sphere",gp.VECTOR="vector";var yp=class extends Ud{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new np,e=arguments.length>1?arguments[1]:void 0,r=arguments.length>2?arguments[2]:void 0;super("v4"),this.nodeType="TextureCube",this.value=t,this.radianceNode=new up(this.value,null!==e&&void 0!==e?e:new gp(gp.VECTOR),r),this.irradianceNode=new up(this.value,new pp(pp.WORLD),new ip(1).setReadonly(!0))}generate(t,e){return t.isShader("fragment")?(t.require("irradiance"),t.context.bias&&t.context.bias.setTexture(this.value),("irradiance"===t.slot?this.irradianceNode:this.radianceNode).build(t,e)):(console.warn("TextureCubeNode is not compatible with "+t.shader+" shader."),t.format("vec4( 0.0 )",this.getType(t),e))}},bp=class extends jd{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new n.CubeTexture,e=arguments.length>1?arguments[1]:void 0,r=arguments.length>2?arguments[2]:void 0;super("v4",{shared:!0}),this.nodeType="CubeTexture",this.value=t,this.uv=null!==e&&void 0!==e?e:new gp,this.bias=r}getTexture(t,e){return super.generate(t,e,this.value.uuid,"tc")}generate(t,e){var r,n;if("samplerCube"===e)return this.getTexture(t,e);let i,a=this.getTexture(t,e),o=null===(r=this.uv)||void 0===r?void 0:r.build(t,"v3"),s=this.bias?this.bias.build(t,"f"):void 0;void 0===s&&t.context.bias&&(s=t.context.bias.setTexture(this).build(t,"f")),i=s?"texCubeBias( "+a+", "+o+", "+s+" )":"texCube( "+a+", "+o+" )";let l={include:t.isShader("vertex"),ignoreCache:!0},h=this.getType(t);return t.addContext(l),this.colorSpace=null!==(n=this.colorSpace)&&void 0!==n?n:new ep(new rp("",h)),this.colorSpace.fromDecoding(t.getTextureEncodingFromMap(this.value)),this.colorSpace.input.parse(i),i=this.colorSpace.build(t,h),t.removeContext(),t.format(i,h,e)}},xp=["x","y","z","w"],wp=["float","vec2","vec3","vec4"],_p={float:"f",vec2:"v2",vec3:"v3",vec4:"v4",mat4:"v4",int:"i",bool:"b","float[]":"f[]","vec4[]":"v4[]"},Sp={t:"sampler2D",tc:"samplerCube",b:"bool",i:"int",f:"float",c:"vec3",v2:"vec2",v3:"vec3",v4:"vec4",m3:"mat3",m4:"mat4","f[]":"float[]","v4[]":"vec4[]"},Ap=class{constructor(){this.includes={consts:{},functions:{},structs:{}},this.cache="",this.slot="",this.shader="",this.context={},this.needsJitter=!0,this.getIncludesCode=function(){function t(t,e){return t.deps.length-e.deps.length}return function(e,r){let n=this.getIncludes(e,r);if(!n)return"";let i="";n=n.sort(t);for(let t=0;t<n.length;t++)n[t].src&&(i+=n[t].src+"\n");return i}}(),this.slots=[],this.caches=[],this.contexts=[],this.keywords={},this.nodeData={},this.fragmentVariables={},this.fragmentParsVariables={},this.vertexParsVariables={},this.requires={uv:[],color:[],transparent:!1,irradiance:!1,position:!1,worldPosition:!1,normal:!1,worldNormal:!1,vWorldViewDir:!1,modelMatrix:!1,viewMatrix:!1,projectionMatrix:!1},this.includes={consts:[],functions:[],structs:[]},this.attributes={},this.prefixCode=["#ifdef TEXTURE_LOD_EXT","\t#define texCube(a, b) textureCube(a, b)","\t#define texCubeBias(a, b, c) textureCubeLodEXT(a, b, c)","\t#define tex2D(a, b) texture2D(a, b)","\t#define tex2DBias(a, b, c) texture2DLodEXT(a, b, c)","#else","\t#define texCube(a, b) textureCube(a, b)","\t#define texCubeBias(a, b, c) textureCube(a, b, c)","\t#define tex2D(a, b) texture2D(a, b)","\t#define tex2DBias(a, b, c) texture2D(a, b, c)","#endif","\n\t\t\t// NOTE: Include Spline's blending modes. This could be part of BlendNode\n\t\t\t#define SPE_BLENDING_NORMAL 0\n\t\t\t#define SPE_BLENDING_MULTIPLY 1\n\t\t\t#define SPE_BLENDING_SCREEN 2\n\t\t\t#define SPE_BLENDING_OVERLAY 3\n\n\t\t\tvec3 spe_normalBlend( vec3 a, vec3 b, float alpha ) {\n\t\t\t\treturn mix( a, b, alpha );\n\t\t\t}\n\n\t\t\tvec3 spe_multiplyBlend( vec3 a, vec3 b, float alpha ) {\n\t\t\t\treturn mix( a, a * b, alpha );\n\t\t\t}\n\n\t\t\tvec3 spe_screenBlend( vec3 a, vec3 b, float alpha ) {\n\t\t\t\tvec3 tmp = 1.0 - ( 1.0 - a ) * ( 1.0 - b );\n\t\t\t\treturn mix( a, tmp, alpha );\n\t\t\t}\n\n\t\t\tvec3 spe_overlayBlend( vec3 a, vec3 b, float alpha ) {\n\t\t\t\tvec3 tmp = mix( 1. - 2. * (1. - a) * (1. - b), 2. * a * b, step( a, vec3(.5) ) );\n\t\t\t\treturn clamp( mix( a, tmp, alpha ), 0.0, 1.0 );\n\t\t\t}\n\n\t\t\tvec3 spe_blend( vec3 a, vec3 b, float alpha, int mode ) {\n\t\t\t\tif ( mode == SPE_BLENDING_NORMAL ) return spe_normalBlend( a, b, alpha );\n\t\t\t\telse if ( mode == SPE_BLENDING_MULTIPLY ) return spe_multiplyBlend( a, b, alpha );\n\t\t\t\telse if ( mode == SPE_BLENDING_SCREEN ) return spe_screenBlend( a, b, alpha );\n\t\t\t\telse if ( mode == SPE_BLENDING_OVERLAY ) return spe_overlayBlend( a, b, alpha );\n\t\t\t\treturn vec3( 1.0 );\n\t\t\t}\n\t\t\t","#include <packing>","#include <common>"].join("\n"),this.parsCode={vertex:["float neighbor_offset = 0.0001;",""].join("\n"),fragment:["float accumAlpha = 0.0;","void accumulateAlpha(float alpha) {\n\t\t\t\t\taccumAlpha += (1.0 - accumAlpha) * alpha;\n\t\t\t\t}",""].join("\n")},this.code={vertex:"",fragment:""},this.nodeCode={vertex:"",fragment:""},this.resultCode={vertex:"",fragment:""},this.finalCode={vertex:"",fragment:""},this.inputs={uniforms:{list:[],vertex:[],fragment:[]},arrayUniforms:{list:[],vertex:[],fragment:[]},vars:{varying:[],vertex:[],fragment:[]}},this.defines={},this.uniforms={},this.extensions={derivatives:!1,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1},this.updaters=[],this.nodes=[],this.analyzing=!1}build(t,e){this.addVertexParsCode("\nuniform int frameIndex;\nuniform vec2 resolution;\nuniform mat4 previousModelViewMatrix;\nuniform mat4 previousProjectionMatrix;\n\nvarying vec4 vCurrentPosition;\nvarying vec4 vPreviousPosition;\n"),this.addFragmentParsCode("\nlayout(location = 1) out vec4 gVelocity;\n\nuniform int frameIndex;\nuniform vec2 resolution;\n\nvarying vec4 vCurrentPosition;\nvarying vec4 vPreviousPosition;\n\nconst vec2 haltonSequence[16] = vec2[16](\nvec2( 0.000000,-0.333334),\nvec2(-0.500000, 0.333334),\nvec2( 0.500000,-0.777778),\nvec2(-0.750000,-0.111112),\nvec2( 0.250000, 0.555556),\nvec2(-0.250000,-0.555556),\nvec2( 0.750000, 0.111112),\nvec2(-0.875000, 0.777778),\nvec2(0.125000, -0.925926),\nvec2(-0.375000, -0.259260),\nvec2(0.625000, 0.407408),\nvec2(-0.625000, -0.703704),\nvec2(0.375000, -0.037038),\nvec2(-0.125000, 0.629630),\nvec2(0.875000, -0.481482),\nvec2(-0.937500, 0.185186));\n\nvec2 vogelDiskSample(int sampleIndex, int sampleCount, float angle) {\n  const float goldenAngle = 2.399963f; // radians\n  float r = sqrt(float(sampleIndex) + 0.5f) / sqrt(float(sampleCount));\n  float theta = float(sampleIndex) * goldenAngle + angle;\n  float sine = sin(theta);\n  float cosine = cos(theta);\n  return vec2(cosine, sine) * r;\n}\n\n// Derived from the interleaved gradient function from Jimenez 2014 http:goo.gl/eomGso\nfloat getNoiseInterleavedGradient(vec2 screenPos) {\n    vec3 magic = vec3(0.06711056f, 0.00583715f, 52.9829189f);\n    return fract(magic.z * fract(dot(screenPos, magic.xy)));\n}\n\n"),this.buildShader("vertex",t),this.buildShader("fragment",e);for(let r=0;r<this.requires.uv.length;r++)if(this.requires.uv[r]){let t=r>0?r+1:"";this.addVaryCode("varying vec2 vUv"+t+";"),r>0&&this.addVertexParsCode("attribute vec2 uv"+t+";"),this.addVertexFinalCode("vUv"+t+" = uv"+t+";")}return this.requires.color[0]&&(this.addVaryCode("varying vec4 vColor;"),this.addVertexParsCode("attribute vec4 color;"),this.addVertexFinalCode("vColor = color;")),this.requires.color[1]&&(this.addVaryCode("varying vec4 vColor2;"),this.addVertexParsCode("attribute vec4 color2;"),this.addVertexFinalCode("vColor2 = color2;")),this.requires.position&&(this.addVaryCode("varying vec3 vPosition;"),this.addVertexFinalCode("vPosition = transformed;")),this.requires.worldPosition,this.requires.normal&&(this.addVaryCode("varying vec3 vObjectNormal;"),this.addVertexFinalCode("vObjectNormal = normal;")),this.requires.modelMatrix&&this.addFragmentParsCode("uniform mat4 modelMatrix;"),this.requires.viewMatrix&&this.addFragmentParsCode("uniform mat4 viewMatrix;"),this.requires.projectionMatrix&&this.addFragmentParsCode("uniform mat4 projectionMatrix;"),this.requires.worldNormal&&(this.addVaryCode("varying vec3 vWNormal;"),this.addVertexFinalCode("vWNormal = inverseTransformDirection( transformedNormal, viewMatrix ).xyz;")),this.requires.vWorldViewDir&&(this.addVaryCode("varying vec3 vWorldViewDir;"),this.addVertexFinalCode("vWorldViewDir = isPerspectiveMatrix( projectionMatrix ) ?  ( (modelMatrix * vec4(position, 1.0)).xyz - cameraPosition ) : vec3( -viewMatrix[0][2], -viewMatrix[1][2], -viewMatrix[2][2] );")),this.needsJitter&&(this.addVertexFinalCode("\n// TODO: This could be generated CPU side and passed to the shader every frame\nconst vec2 haltonSequence[16] = vec2[16](\nvec2( 0.000000,-0.333334),\nvec2(-0.500000, 0.333334),\nvec2( 0.500000,-0.777778),\nvec2(-0.750000,-0.111112),\nvec2( 0.250000, 0.555556),\nvec2(-0.250000,-0.555556),\nvec2( 0.750000, 0.111112),\nvec2(-0.875000, 0.777778),\nvec2(0.125000, -0.925926),\nvec2(-0.375000, -0.259260),\nvec2(0.625000, 0.407408),\nvec2(-0.625000, -0.703704),\nvec2(0.375000, -0.037038),\nvec2(-0.125000, 0.629630),\nvec2(0.875000, -0.481482),\nvec2(-0.937500, 0.185186));\n\n// TODO: Pass correct view size\nvec2 offset = haltonSequence[frameIndex];\noffset.x /= resolution.x;\noffset.y /= resolution.y;\n\nvec4 currentPosition = gl_Position;\nvec4 currentPositionJittered = currentPosition + (vec4(offset.x, offset.y, 0.0, 0.0) * currentPosition.w);\n\n// We want to calculate the velocity with unjittered positions\n// so that things that are not moving get a velocity = 0\nvCurrentPosition = currentPosition;\nvPreviousPosition = previousProjectionMatrix * previousModelViewMatrix * vec4(transformed, 1.0);\n#ifdef OUTLINE_COMPENSATION\nvPreviousPosition.xy += OUTLINE_COMPENSATION;\n#endif\ngl_Position = currentPositionJittered;\n\n"),this.addFragmentFinalCode("\nvec2 oldPos = vPreviousPosition.xy;\n    oldPos /= vPreviousPosition.w;\n    oldPos.xy = (oldPos.xy+1.)/2.0;\n\nvec2 newPos = vCurrentPosition.xy;\n    newPos /= vCurrentPosition.w;\n    newPos.xy = (newPos.xy+1.)/2.0;\n\nvec2 velocity = (newPos - oldPos);\n\n// Discard fully transparent pixels \nif (gl_FragColor.a <= 0.0) discard;\n\ngVelocity = vec4(velocity, 0.0, 1.0);\n")),this}buildShader(t,e){this.resultCode[t]=e.build(this.setShader(t),"v4")}setMaterial(t,e){return this.defines={},this}addFlow(t,e,r){return this.addSlot(t).addCache(e).addContext(r)}removeFlow(){return this.removeSlot().removeCache().removeContext()}addCache(t){return this.cache=null!==t&&void 0!==t?t:"",this.caches.push(this.cache),this}removeCache(){return this.caches.pop(),this.cache=this.caches[this.caches.length-1]||"",this}addContext(t){return this.context=Object.assign({},this.context,t),this.context.extra=this.context.extra||{},this.contexts.push(this.context),this}removeContext(){return this.contexts.pop(),this.context=this.contexts[this.contexts.length-1]||{},this}addSlot(t){return this.slot=t||"",this.slots.push(this.slot),this}removeSlot(){return this.slots.pop(),this.slot=this.slots[this.slots.length-1]||"",this}addFragmentVariable(t,e){void 0===this.fragmentVariables[t]&&(this.addFragmentCode("".concat(e," ").concat(t,";")),this.fragmentVariables[t]="")}addFragmentParsVariable(t,e){void 0===this.fragmentParsVariables[t]&&(this.addFragmentParsCode("".concat(e," ").concat(t,";")),this.fragmentParsVariables[t]="")}addVertexParsVariable(t,e){void 0===this.vertexParsVariables[t]&&(this.addVertexParsCode("".concat(e," ").concat(t,";")),this.vertexParsVariables[t]="")}addVertexCode(t){this.addCode(t,"vertex")}addFragmentCode(t){this.addCode(t,"fragment")}addCode(t,e){this.code[null!==e&&void 0!==e?e:this.shader]+=t+"\n"}addVertexNodeCode(t){this.addNodeCode(t,"vertex")}addFragmentNodeCode(t){this.addNodeCode(t,"fragment")}addNodeCode(t,e){this.nodeCode[null!==e&&void 0!==e?e:this.shader]+=t+"\n"}clearNodeCode(t){var e;t=null!==(e=t)&&void 0!==e?e:this.shader;let r=this.nodeCode[t];return this.nodeCode[t]="",r}clearVertexNodeCode(){return this.clearNodeCode("vertex")}clearFragmentNodeCode(){return this.clearNodeCode("fragment")}addVertexFinalCode(t){this.addFinalCode(t,"vertex")}addFragmentFinalCode(t){this.addFinalCode(t,"fragment")}addFinalCode(t,e){this.finalCode[null!==e&&void 0!==e?e:this.shader]+=t+"\n"}addVertexParsCode(t){this.addParsCode(t,"vertex")}addFragmentParsCode(t){this.addParsCode(t,"fragment")}addParsCode(t,e){this.parsCode[null!==e&&void 0!==e?e:this.shader]+=t+"\n"}addVaryCode(t){this.addVertexParsCode(t),this.addFragmentParsCode(t)}isCache(t){return-1!==this.caches.indexOf(t)}isSlot(t){return-1!==this.slots.indexOf(t)}define(t,e){this.defines[t]=void 0===e?1:e}require(t){this.requires[t]=!0}isDefined(t){return void 0!==this.defines[t]}getVar(t,e,r){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"varying",i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"V",a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"",o=this.getVars(n),s=o[t];if(!s){let n=o.length;s={name:r||"node"+i+n+(a?"_"+a:""),type:e},o.push(s),o[t]=s}return s}getTempVar(t,e,r,n){return this.getVar(t,e,r,this.shader,"T",n)}getAttribute(t,e){if(!this.attributes[t]){let r=this.getVar(t,e);this.addVertexParsCode("attribute "+e+" "+t+";"),this.addVertexFinalCode(r.name+" = "+t+";"),this.attributes[t]={varying:r,name:t,type:e}}return this.attributes[t]}getCode(t){return[this.prefixCode,this.parsCode[t],this.getVarListCode(this.getVars("varying"),"varying"),this.getVarListCode(this.inputs.uniforms[t],"uniform"),this.getVarListCode(this.inputs.arrayUniforms[t],"uniform"),this.getIncludesCode("consts",t),this.getIncludesCode("structs",t),this.getIncludesCode("functions",t),"void main() {",this.getVarListCode(this.getVars(t)),this.code[t],this.resultCode[t],this.finalCode[t],"}"].join("\n")}getVarListCode(t,e){var r;e=null!==(r=e)&&void 0!==r?r:"";let n="";for(let i=0,a=t.length;i<a;++i){let r=t[i],a=r.type,o=r.name,s=r.size,l=this.getFormatByType(a);if(void 0===l)throw new Error("Node pars "+l+" not found.");l.includes("[]")?n+=e+" "+l.substring(0,l.length-2)+" "+o+"[".concat(s,"];\n"):n+=e+" "+l+" "+o+";\n"}return n}getVars(t){return this.inputs.vars[null!==t&&void 0!==t?t:this.shader]}getNodeData(t){let e=t instanceof kd?t.uuid:t;return this.nodeData[e]=this.nodeData[e]||{}}createUniform(t,e,r,n,i,a){if(e.includes("[]")){let o=this.inputs.arrayUniforms,s=o.list.length,l=new Bd({type:e,size:r.size,name:n||"nodeUA"+s+(a?"_"+a:""),node:r,needsUpdate:i});return o.list.push(l),o[t].push(l),o[t][l.name]=l,this.uniforms[l.name]=l,l}{let o=this.inputs.uniforms,s=o.list.length,l=new Bd({type:e,name:n||"nodeU"+s+(a?"_"+a:""),node:r,needsUpdate:i});return o.list.push(l),o[t].push(l),o[t][l.name]=l,this.uniforms[l.name]=l,l}}createVertexUniform(t,e,r,n,i){return this.createUniform("vertex",t,e,r,n,i)}createFragmentUniform(t,e,r,n,i){return this.createUniform("fragment",t,e,r,n,i)}include(t,e,r){let n;if(t="string"==typeof t?Vd.get(t):t,!1===this.context.include)return t.name;t instanceof Wd?n=this.includes.functions:t instanceof Qd?n=this.includes.consts:t instanceof Jd&&(n=this.includes.structs);let i=n[this.shader]=n[this.shader]||[];if(t){var a;let n=i[t.name];if(n||(n=i[t.name]={node:t,deps:[]},i.push(n),n.src=t.build(this,"source")),t instanceof Wd&&e&&i[e.name]&&-1===i[e.name].deps.indexOf(t)&&(i[e.name].deps.push(t),null!==(a=t.includes)&&void 0!==a&&a.length)){let r=0;do{this.include(t.includes[r++],e)}while(r<t.includes.length)}return r&&(n.src=r),t.name}throw new Error("Include not found.")}colorToVectorProperties(t){return t.replace("r","x").replace("g","y").replace("b","z").replace("a","w")}colorToVector(t){return t.replace(/c/g,"v3")}getIncludes(t,e){return this.includes[t][e||this.shader]}getConstructorFromLength(t){return wp[t-1]}isTypeMatrix(t){return/^m/.test(t)}getTypeLength(t){return"f"===t?1:parseInt(this.colorToVector(t).substr(1))}getTypeFromLength(t){return 1===t?"f":"v"+t}findNode(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];for(let n=0;n<arguments.length;n++){let t=e[n];if(null!==t&&void 0!==t&&t.isNode)return t}}resolve(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];for(let i=0;i<arguments.length;i++){let t=e[i];if(void 0!==t){if(t.isNode)return t;if(t.isTexture)switch(t.mapping){case n.CubeReflectionMapping:case n.CubeRefractionMapping:return new bp(t);case n.CubeUVReflectionMapping:return new yp(new np(t));default:return new np(t)}else{if(t.isVector2)return new Nd(t);if(t.isVector3)return new Rd(t);if(t.isVector4)return new Gd(t)}}}}format(t,e,r){switch(this.colorToVector(r+" <- "+e)){case"f <- v2":case"f <- v3":case"f <- v4":return t+".x";case"f <- i":case"f <- b":return"float( "+t+" )";case"v2 <- f":return"vec2( "+t+" )";case"v2 <- v3":case"v2 <- v4":return t+".xy";case"v2 <- i":case"v2 <- b":case"v3 <- i":case"v3 <- b":return"vec2( float( "+t+" ) )";case"v3 <- f":return"vec3( "+t+" )";case"v3 <- v2":return"vec3( "+t+", 0.0 )";case"v3 <- v4":return t+".xyz";case"v4 <- f":return"vec4( "+t+" )";case"v4 <- v2":return"vec4( "+t+", 0.0, 1.0 )";case"v4 <- v3":return"vec4( "+t+", 1.0 )";case"v4 <- i":case"v4 <- b":return"vec4( float( "+t+" ) )";case"i <- f":case"i <- b":return"int( "+t+" )";case"i <- v2":case"i <- v3":case"i <- v4":return"int( "+t+".x )";case"b <- f":return"( "+t+" != 0.0 )";case"b <- v2":return"( "+t+" != vec2( 0.0 ) )";case"b <- v3":return"( "+t+" != vec3( 0.0 ) )";case"b <- v4":return"( "+t+" != vec4( 0.0 ) )";case"b <- i":return"( "+t+" != 0 )"}return t}getTypeByFormat(t){return _p[t]||t}getFormatByType(t){return Sp[t]||t}getUUID(t,e){return(e=void 0===e||e)&&this.cache&&(t=this.cache+"-"+t),t}getElementByIndex(t){return xp[t]}getIndexByElement(t){return xp.indexOf(t)}isShader(t){return this.shader===t}setShader(t){return this.shader=t,this}mergeDefines(t){for(let e in t)this.defines[e]=t[e];return this.defines}mergeUniform(t){for(let e in t)this.uniforms[e]=t[e];return this.uniforms}getTextureEncodingFromMap(t){let e;return t?t.isTexture&&(e=t.encoding):e=n.LinearEncoding,e===n.LinearEncoding&&this.context.gamma&&(e=n.sRGBEncoding),e}},Mp=class extends jd{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1?arguments[1]:void 0,r=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0;super("c"),this.nodeType="Color",this.value=t instanceof Fd?t:new Fd(t||0,e,r,n)}setRGBA(t){this.value.setRGBA(t.r,t.g,t.b,t.a)}generate(t,e,r,n,i,a){var o,s;r=t.getUUID(null!==(o=r)&&void 0!==o?o:this.getUUID()),n=null!==(s=n)&&void 0!==s?s:this.getType(t);let l=t.getNodeData(r),h=this.getReadonly()&&void 0!==this.generateReadonly;if(this.alpha){let e=this.alpha.build(t,"f");t.addFragmentNodeCode("accumAlpha += ( 1.0 - accumAlpha ) * ".concat(e,";"))}return h?this.generateReadonly(t,e,r,n,i,a):t.isShader("vertex")?(l.vertex||(l.vertex=t.createVertexUniform(n,this,i,a,this.getLabel())),t.format(l.vertex.name,n,e)):(l.fragment||(l.fragment=t.createFragmentUniform(n,this,i,a,this.getLabel())),t.format(l.fragment.name,n,e))}generateReadonly(t,e,r,n,i,a){return t.format("vec3("+this.value.r+", "+this.value.g+", "+this.value.b+")",n,e)}},Cp=class extends jd{constructor(t){super("i"),this.nodeType="Int",this.value=Math.floor(null!==t&&void 0!==t?t:0)}generateReadonly(t,e,r,n,i,a){return t.format(this.value.toString(),n,e)}},Op=class extends jd{constructor(t){super("b"),this.nodeType="Bool",this.value=null!==t&&void 0!==t&&t}generateReadonly(t,e,r,n){return t.format(this.value?"true":"false",n,e)}},Dp=class extends jd{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,e=arguments.length>1?arguments[1]:void 0;super("f[]"),this.nodeType="FloatArray",this.size=t,this.value=Array.isArray(e)?e:"number"==typeof e?new Array(t).fill(e):new Array(t).fill(0)}},Pp=class extends jd{},Tp=class extends Pp{constructor(t){super("v3"),this.image=t,this._value=new n.Vector3}get value(){var t,e;return this._value.x=this.image.isVideo?null!==(t=this.image.img.videoWidth)&&void 0!==t?t:0:this.image.img.width,this._value.y=this.image.isVideo?null!==(e=this.image.img.videoHeight)&&void 0!==e?e:0:this.image.img.height,this._value}},zp=class extends Pp{constructor(t,e){super("t"),this.image=t,this.wrap=e}get value(){return this.image.getTexture(this.wrap)}},Ep=class extends jd{constructor(t){super("m3"),this.nodeType="Matrix3",this.value=null!==t&&void 0!==t?t:new n.Matrix3}generateReadonly(t,e,r,n,i,a){return t.format("mat3("+this.value.elements.join(", ")+")",n,e)}get elements(){return this.value.elements}set elements(t){this.value.fromArray(t)}},Ip=class extends jd{constructor(t){super("m4"),this.nodeType="Matrix4",this.value=null!==t&&void 0!==t?t:new n.Matrix4}generateReadonly(t,e,r,n,i,a){return t.format("mat4("+this.value.elements.join(", ")+")",n,e)}get elements(){return this.value.elements}set elements(t){this.value.fromArray(t)}};function Lp(t,e,r){t.setUvTransform(r[0],r[1],e[0],e[1],0,0,0)}var Bp=class extends Ep{constructor(t,e){super(new n.Matrix3),this.repeat=t,this.offset=e,Lp(this.value,t,e)}updateMatrix(){Lp(this.value,this.repeat,this.offset)}},kp=class extends jd{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,e=arguments.length>1?arguments[1]:void 0;super("v4[]"),this.nodeType="Vector4Array",this.size=t,this.value=Array.isArray(e)?e:e instanceof n.Vector4?new Array(t).fill(e):new Array(t).fill(new n.Vector4(0))}},Vp=class extends Ud{constructor(t,e,r,n){super("v3"),this.nodeType="Blend",this.a=t,this.b=e,this.alpha=r,this.mode=n}generate(t,e){if(t.isShader("fragment")){let r=[];return r.push(this.a.build(t,"c")),r.push(this.b.build(t,"c")),r.push(this.alpha.build(t,"f")),r.push(this.mode.build(t,"i")),t.format("spe_blend("+r.join(",")+")",this.getType(t),e)}return console.warn("BlendNode is not compatible with "+t.shader+" shader."),t.format("vec3( 0.0 )",this.getType(t),e)}},Up=class extends Ud{constructor(t,e){super("v3"),this.nodeType="CustomColor",this.color=t,this.alpha=e,this.calpha="g".concat(this.uuid.toString().replace(/-/g,""),"_calpha")}generate(t,e){if(t.isShader("fragment")){let r=t.include(Up.Nodes.customColor);t.addFragmentVariable(this.calpha,"float");let n=[];return n.push(this.color.build(t,"v3")),n.push(this.mask?"luminance(".concat(this.mask.build(t,"v3"),")"):"1.0"),n.push(this.alpha.build(t,"f")),n.push(this.calpha),t.format(r+"("+n.join(",")+")",this.getType(t),e)}return console.warn("CustomColorNode is not compatible with "+t.shader+" shader."),t.format("vec3( 0.0 )",this.getType(t),e)}},jp=Up;jp.Nodes={customColor:new Wd("vec3 customColor(vec3 color, float mask, float alpha, out float calpha) {\n\t\t\t\tfloat lalpha = alpha * mask;\n\t\t\t\tcalpha =  lalpha / clamp(lalpha + accumAlpha, 0.00001, 1.0);\n\t\t\t\taccumAlpha += (1.0 - accumAlpha) * lalpha;\n\n\t\t\t\treturn color;\n\t\t\t}")};var Np=class extends Ud{constructor(t,e){super("v3"),this.nodeType="CustomNormal",this.cnormal=t,this.alpha=e,this.calpha="g".concat(this.uuid.toString().replace(/-/g,""),"_calpha")}generate(t,e){if(t.isShader("fragment")){let r=t.include(Np.Nodes.customNormal);t.addFragmentVariable(this.calpha,"float");let n=[];return n.push(this.cnormal.build(t,"v3")),n.push("normal"),n.push(this.mask?"luminance(".concat(this.mask.flow(t,"v3").result,")"):"1.0"),n.push(this.alpha.build(t,"f")),n.push(this.calpha),t.format(r+"("+n.join(",")+")",this.getType(t),e)}return console.warn("CustomNormalNode is not compatible with "+t.shader+" shader."),t.format("vec3( 0.0 )",this.getType(t),e)}},Rp=Np;Rp.Nodes={customNormal:new Wd("vec3 customNormal(vec3 cnormal, vec3 norm, float mask, float alpha, out float calpha) {\n\t\t\t\tvec3 normal = packNormalToRGB( norm ).rgb;\n\t\t\t\tnormal *= step( vec3(0.5), cnormal );\n\n\t\t\t\tfloat lalpha = alpha * mask;\n\t\t\t\tcalpha =  lalpha / clamp( lalpha + accumAlpha, 0.00001, 1.0 );\n\t\t\t\taccumAlpha += ( 1.0 - accumAlpha ) * lalpha;\n\n\t\t\t\treturn normal;\n\t\t\t}")};var Fp=class extends Ud{constructor(t,e,r,n,i,a,o,s,l,h,c,u){super("v3"),this.nodeType="CustomTexture",this.texture=t,this.textureSize=e,this.crop=r,this.projection=n,this.axis=i,this.side=a,this.size=o,this.blending=s,this.mat=l,this.isMask=u,this.alpha=h,this.mode=c,this.calpha="g".concat(this.uuid.toString().replace(/-/g,""),"_calpha")}generate(t,e){t.require("position"),t.require("normal"),t.require("uv"),t.requires.uv=[!0],t.extensions.shaderTextureLOD=!0,t.extensions.derivatives=!0;let r,n="g".concat(this.uuid.toString().replace(/-/g,""));switch(this.projection.value){case 3:r=t.include(Fp.Nodes.cylindrical);break;case 2:r=t.include(Fp.Nodes.spherical);break;case 1:let e=["vec3(1.0, 0.0, 0.0)","vec3(0.0, 1.0, 0.0)","vec3(0.0, 0.0, 1.0)"][this.axis.value],i=["zy","xz","xy"][this.axis.value],a=new Wd("\n\t\tvec3 ".concat(n,"_planarTexture(vec3 normal, sampler2D tex, vec2 textureSize, float crop, mat3 mat, vec2 size, float blending, bool isMask, float mask, float alpha, int mode, out float calpha, out vec2 writeUv) {\n\t\t\t\tvec2 projected = (1. + (position.").concat(i,")) / 2.;\n\t\t\t\tvec2 uvs = ( mat * vec3( (projected * 2. - 1.) / (size * .5), 1. ) / 2. + 0.5 ).xy;\n\t\t\t\twriteUv = uvs;\n\n\t\t\t\tvec4 tmp = texture2D( tex, uvs );\n\n\t\t\t\tvec3 col = tmp.rgb;\n\t\t\t\tfloat lalpha = alpha * tmp.a;\n\t\t\t\t").concat(2===this.side.value?"":"lalpha *= step(0.0, ".concat(1===this.side.value?"-1.0 * ":"","dot(vObjectNormal, ").concat(e,"));"),"\n\n\t\t\t\tif ( crop > 0.5 ) {\n\t\t\t\t\tif ( uvs.x < 0.0 || uvs.x > 1.0 || uvs.y < 0.0 || uvs.y > 1.0 )  {\n\t\t\t\t\t\tlalpha = 0.0;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tlalpha *= mask;\n\n\t\t\t\tcalpha =  lalpha / clamp( lalpha + accumAlpha, 0.00001, 1.0 );\n\t\t\t\taccumAlpha += (1.0 - accumAlpha) * lalpha * (1.0 - float(isMask));\n\n\t\t\t\treturn col;\n\t\t\t}"));r=t.include(a);break;case 4:r=t.include(Fp.Nodes.triplanar);break;default:r=t.include(Fp.Nodes.uv)}t.addFragmentVariable(this.calpha,"float");let i=[];if(i.push("normal"),i.push(this.texture.generate(t,"t")),i.push(this.textureSize.build(t,"v2")),i.push(this.crop.build(t,"f")),i.push(this.mat.build(t,"mat3")),i.push(this.size.build(t,"v2")),i.push(this.blending.build(t,"f")),i.push(this.isMask.build(t,"b")),i.push(this.mask?"luminance(".concat(this.mask.flow(t,"v3").result,")"):"1.0"),i.push(this.alpha.build(t,"f")),i.push(this.mode.build(t,"i")),i.push(this.calpha),4===this.projection.value){let e="".concat(n,"_writeUvs"),r=e+"0",a=e+"1",o=e+"2",s="".concat(n,"_triplanarWeights");t.addFragmentVariable(r,"vec2"),t.addFragmentVariable(a,"vec2"),t.addFragmentVariable(o,"vec2"),t.addFragmentVariable(s,"vec3"),i.push(r),i.push(a),i.push(o),i.push(s)}else{let e="".concat(n,"_writeUvs");t.addFragmentVariable(e,"vec2"),i.push(e)}return t.format(r+"("+i.join(",")+")",this.getType(t),e)}},Gp=Fp;Gp.Nodes={cylindrical:new Wd("\nvec3 cylindricalTexture(vec3 normal, sampler2D tex, vec2 textureSize, float crop, mat3 mat, vec2 size, float blending, bool isMask, float mask, float alpha, int mode, out float calpha, out vec2 writeUv) {\n                vec3 posN = normalize(position);\n                float u = 0.5 + atan(posN.z, posN.x) / (2.*3.1415);\n                float scaledHeight = position.y / (size.y * 0.5);\n                float v =  (scaledHeight / 2.) + .5;\n\n                vec2 calculatedUv = vec2(u,v);\n\t\t\t\tvec2 uvs = ( mat * vec3( calculatedUv * 2. - 1., 1. ) / 2. + 0.5 ).xy;\n\t\t\t\twriteUv = uvs;\n\n                vec2 df = fwidth(uvs);\n               \tif(df.x > 0.5) df.x = 0.;\n\n\t\t\t\t#ifdef GL_EXT_shader_texture_lod\n                vec4 tmp = texture2DLodEXT(tex, uvs, log2(max(df.x, df.y)*min(textureSize.x, textureSize.y)));\n\t\t\t\t#else\n                vec4 tmp = textureLod(tex, uvs, log2(max(df.x, df.y)*min(textureSize.x, textureSize.y)));\n\t\t\t\t#endif\n\n\t\t\t\tvec3 col = tmp.rgb;\n\t\t\t\tfloat lalpha = alpha * tmp.a;\n\t\t\t\tif ( crop > 0.5 ) {\n\t\t\t\t\tif ( uvs.x < 0.0 || uvs.x > 1.0 || uvs.y < 0.0 || uvs.y > 1.0 )  {\n\t\t\t\t\t\tlalpha = 0.0;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tlalpha *= mask;\n\t\t\t\t\n\t\t\t\tcalpha =  lalpha / clamp( lalpha + accumAlpha, 0.00001, 1.0 );\n\t\t\t\taccumAlpha += (1.0 - accumAlpha) * lalpha * (1.0 - float(isMask));\n\n\t\t\t\treturn col;\n\t\t\t}\n"),spherical:new Wd("\nvec3 sphericalTexture(vec3 normal, sampler2D tex, vec2 textureSize, float crop, mat3 mat, vec2 size, float blending, bool isMask, float mask, float alpha, int mode, out float calpha, out vec2 writeUv) {\n                vec3 posN = normalize(vPosition);\n                float u = 0.5 + atan(posN.z, posN.x) / (2.*3.1415);\n                float v = 0.5 + asin(posN.y) / 3.1415;\n\n                vec2 calculatedUv = vec2(u,v);\n\t\t\t\tvec2 uvs = ( mat * vec3( calculatedUv * 2. - 1., 1. ) / 2. + 0.5 ).xy;\n\t\t\t\twriteUv = uvs;\n\n                vec2 df = fwidth(uvs);\n               \tif(df.x > 0.5) df.x = 0.;\n\t\t\t\t#ifdef GL_EXT_shader_texture_lod\n                vec4 tmp = texture2DLodEXT(tex, uvs, log2(max(df.x, df.y)*min(textureSize.x, textureSize.y)));\n\t\t\t\t#else\n                vec4 tmp = textureLod(tex, uvs, log2(max(df.x, df.y)*min(textureSize.x, textureSize.y)));\n\t\t\t\t#endif\n\n\t\t\t\tvec3 col = tmp.rgb;\n\t\t\t\tfloat lalpha = alpha * tmp.a;\n\t\t\t\tif ( crop > 0.5 ) {\n\t\t\t\t\tif ( uvs.x < 0.0 || uvs.x > 1.0 || uvs.y < 0.0 || uvs.y > 1.0 )  {\n\t\t\t\t\t\tlalpha = 0.0;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tlalpha *= mask;\n\n\t\t\t\tcalpha =  lalpha / clamp( lalpha + accumAlpha, 0.00001, 1.0 );\n\t\t\t\taccumAlpha += (1.0 - accumAlpha) * lalpha * (1.0 - float(isMask));\n\n\t\t\t\treturn col;\n\t\t\t}\n"),uv:new Wd("vec3 uvTexture(vec3 normal, sampler2D tex, vec2 textureSize, float crop, mat3 mat, vec2 size, float blending, bool isMask, float mask, float alpha, int mode, out float calpha, out vec2 writeUv) {\n\t\t\t\tvec2 uvs = ( mat * vec3( vUv * 2. - 1., 1. ) / 2. + 0.5 ).xy;\n\t\t\t\twriteUv = uvs;\n\n\t\t\t\tvec4 tmp = texture2D( tex, uvs );\n\n\t\t\t\tvec3 col = tmp.rgb;\n\n\t\t\t\tfloat lalpha = alpha * tmp.a;\n\t\t\t\tif ( crop > 0.5 ) {\n\t\t\t\t\tif ( uvs.x < 0.0 || uvs.x > 1.0 || uvs.y < 0.0 || uvs.y > 1.0 )  {\n\t\t\t\t\t\tlalpha = 0.0;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tlalpha *= mask;\n\n\t\t\t\tcalpha =  lalpha / clamp( lalpha + accumAlpha, 0.00001, 1.0 );\n\t\t\t\taccumAlpha += (1.0 - accumAlpha) * lalpha * (1.0 - float(isMask));\n\n\t\t\t\treturn col;\n\t\t\t}"),triplanar:new Wd("vec3 triplanarTexture(vec3 normal, sampler2D tex, vec2 textureSize, float crop, mat3 mat, vec2 size, float blending, bool isMask, float mask, float alpha, int mode, out float calpha, out vec2 writeUvs0, out vec2 writeUvs1, out vec2 writeUvs2, out vec3 writeWeights) {\n\t\t\t\tvec3 p = position;\n\t\t\t\tvec2 uv0 = (1.0 + p.xy) / 2.0;     \n\t\t\t\tvec2 uv1 = (1.0 + p.zy) / 2.0;\t\t\n\t\t\t\tvec2 uv2 = (1.0 + p.xz) / 2.0;\t\t\n\t\n\t\t\t\tuv0 = (mat * vec3((uv0 * 2.0 - 1.0) / (size * 0.5), 1.0) / 2.0 + 0.5).xy;\n\t\t\t\tuv1 = (mat * vec3((uv1 * 2.0 - 1.0) / (size * 0.5), 1.0) / 2.0 + 0.5).xy;\n\t\t\t\tuv2 = (mat * vec3((uv2 * 2.0 - 1.0) / (size * 0.5), 1.0) / 2.0 + 0.5).xy;\n\n\t\t\t\t// Range from 3 to 128 seems to be good\n\t\t\t\tfloat exponent = (1.0 - blending) * 125.0 + 3.0;\n\n\t\t\t\tvec3 n = vObjectNormal;\n\t\t\t\tvec3 weights = abs(normalize(n));\n\t\t\t\tweights = pow(weights, vec3(exponent));\n\t\t\t\tweights /= dot(weights, vec3(1.0));\n\n\t\t\t\t// Write out all sets of UVs that we generated\n\t\t\t\twriteUvs0 = uv0;\n\t\t\t\twriteUvs1 = uv1;\n\t\t\t\twriteUvs2 = uv2;\n\t\t\t\twriteWeights = weights;\n\n\t\t\t\t// Derivatives for LOD\n\t\t\t\tvec2 df0 = fwidth(uv0);\n\t\t\t\tvec2 df1 = fwidth(uv1);\n\t\t\t\tvec2 df2 = fwidth(uv2);\n\t\t\t\tif (df0.x > 0.5) df0.x = 0.0;\n\t\t\t\tif (df1.x > 0.5) df1.x = 0.0;\n\t\t\t\tif (df2.x > 0.5) df2.x = 0.0;\n\n\t\t\t\t#ifdef GL_EXT_shader_texture_lod\n                \tvec4 tmp = \n\t\t\t\t\t\ttexture2DLodEXT(tex, uv0, log2(max(df0.x, df0.y)*min(textureSize.x, textureSize.y))) * weights.z + \n\t\t\t\t\t\ttexture2DLodEXT(tex, uv1, log2(max(df1.x, df1.y)*min(textureSize.x, textureSize.y))) * weights.x + \n\t\t\t\t\t\ttexture2DLodEXT(tex, uv2, log2(max(df2.x, df2.y)*min(textureSize.x, textureSize.y))) * weights.y;\n\t\t\t\t#else\n                \tvec4 tmp = \n\t\t\t\t\t\ttextureLod(tex, uv0, log2(max(df0.x, df0.y)*min(textureSize.x, textureSize.y))) * weights.z + \n\t\t\t\t\t\ttextureLod(tex, uv1, log2(max(df1.x, df1.y)*min(textureSize.x, textureSize.y))) * weights.x + \n\t\t\t\t\t\ttextureLod(tex, uv2, log2(max(df2.x, df2.y)*min(textureSize.x, textureSize.y))) * weights.y;\n\t\t\t\t#endif\n\n\t\t\t\tvec3 col = tmp.rgb;\n\t\t\t\tfloat lalpha = alpha * tmp.a;\n\n\t\t\t\t// Apply cropping across all 3 planes\n\t\t\t\tif ( crop > 0.5 ) {\n\t\t\t\t\tif ( uv0.x < 0.0 || uv0.x > 1.0 || uv0.y < 0.0 || uv0.y > 1.0 )  {\n\t\t\t\t\t\tlalpha = 0.0;\n\t\t\t\t\t}\n\t\t\t\t\tif ( uv1.x < 0.0 || uv1.x > 1.0 || uv1.y < 0.0 || uv1.y > 1.0 )  {\n\t\t\t\t\t\tlalpha = 0.0;\n\t\t\t\t\t}\n\t\t\t\t\tif ( uv2.x < 0.0 || uv2.x > 1.0 || uv2.y < 0.0 || uv2.y > 1.0 )  {\n\t\t\t\t\t\tlalpha = 0.0;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tlalpha *= mask;\n\t\t\t\tcalpha =  lalpha / clamp(lalpha + accumAlpha, 0.00001, 1.0);\n\t\t\t\taccumAlpha += (1.0 - accumAlpha) * lalpha * (1.0 - float(isMask));\n\n\t\t\t\treturn col;//n * 0.5 + 0.5;\n\t\t\t}\t\t\t\n\t\t\t")};var qp=class extends Ud{constructor(t,e,r,n,i,a,o,s,l,h,c,u){super("v3"),this.nodeType="Depth",this.gradientType=t,this.smooth=e,this.near=r,this.far=n,this.isVector=i,this.isWorldSpace=a,this.origin=o,this.direction=s,this.colors=l,this.steps=h,this.isMask=u,this.alpha=c,this.calpha="g".concat(this.uuid.toString().replace(/-/g,""),"_calpha")}generate(t,e){let r="g".concat(this.uuid.toString().replace(/-/g,"")),n=new Wd("vec3 ".concat(r,"_sdepth(float near, float far, vec3 origin, vec3 direction, vec4 colors[").concat(r,"_MAX_COLORS], float steps[").concat(r,"_MAX_COLORS], bool isMask, float mask, float alpha, out float calpha) {\n               vec4 color = colors[0];\n               #ifdef ").concat(r,"_IS_VECTOR\n                   #ifdef ").concat(r,"_LINEAR\n                       #ifdef ").concat(r,"_WORLDSPACE\n                       float depth = vectorLinearWorldSpaceDepth(direction, origin, near, far);\n                       #else\n                       float depth = vectorLinearObjectSpaceDepth(direction, origin, near, far);\n                       #endif\n                   #else\n                       #ifdef ").concat(r,"_WORLDSPACE\n                           float depth = vectorSphericalWorldSpaceDepth(origin, near, far);\n                       #else\n                           float depth = vectorSphericalObjectSpaceDepth(origin, near, far);\n                       #endif\n                   #endif\n               #else\n                   float dist = length(vWPosition - cameraPosition);\n\t\t\t       float depth = ( dist - near ) / ( far - near );\n               #endif\n\n\n              float p;\n              #ifdef ").concat(r,"_SMOOTH\n\t\t\t\tfor ( int i = 1; i < ").concat(r,"_MAX_COLORS; i++ ) {\n\t\t\t\t\t\tp = clamp( ( depth - steps[i-1] ) / ( steps[i] - steps[i-1] ), 0.0, 1.0 );\n\t\t\t\t\t\tcolor = mix(color, colors[i], smoothstep(0.0, 1.0, p));\n\t\t\t\t\t}\n              #else\n                for ( int i = 1; i < ").concat(r,"_MAX_COLORS; i++ ) {\n                   p = clamp(( depth - steps[i - 1] ) / ( steps[i] - steps[i - 1] ), 0.0, 1.0);\n                   color = mix(color, colors[i], p);\n                 }\n              #endif\n\n               float lalpha = alpha * color.a * mask;\n               calpha = mix(lalpha / clamp(lalpha + accumAlpha, 0.00001, 1.0), lalpha, float(isMask));\n\t\t\t   accumAlpha += (1.0 - accumAlpha) * lalpha * (1.0 - float(isMask));\n\t\t\t   \n               return color.rgb;\n\t\t\t}"),[qp.Nodes.vectorLinearWorldSpaceDepth,qp.Nodes.vectorLinearObjectSpaceDepth,qp.Nodes.vectorSphericalObjectSpaceDepth,qp.Nodes.vectorSphericalWorldSpaceDepth]);if(t.isShader("fragment")){t.define("".concat(r,"_MAX_COLORS"),this.colors.value.length),this.smooth.value&&t.define("".concat(r,"_SMOOTH")),this.isVector.value>.5&&t.define("".concat(r,"_IS_VECTOR")),0===this.gradientType.value&&t.define("".concat(r,"_LINEAR")),this.isWorldSpace.value>.5&&t.define("".concat(r,"_WORLDSPACE")),t.require("worldPosition"),t.addFragmentVariable(this.calpha,"float");let i=t.include(n),a=[];return a.push(this.near.build(t,"f")),a.push(this.far.build(t,"f")),a.push(this.origin.build(t,"v3")),a.push(this.direction.build(t,"v3")),a.push(this.colors.build(t,"v4[]")),a.push(this.steps.build(t,"f[]")),a.push(this.isMask.build(t,"b")),a.push(this.mask?"luminance(".concat(this.mask.flow(t,"v3").result,")"):"1.0"),a.push(this.alpha.build(t,"f")),a.push(this.calpha),t.format(i+"("+a.join(",")+")",this.getType(t),e)}return console.warn("DepthNode is not compatible with "+t.shader+" shader."),t.format("vec3( 0.0 )",this.getType(t),e)}},Hp=qp;Hp.Nodes={vectorLinearWorldSpaceDepth:new Wd("float vectorLinearWorldSpaceDepth(vec3 direction, vec3 origin, float near, float far) {\n               vec3 n = normalize(direction);\n               float dist = (n.x*(vWPosition.x - origin.x) + n.y*(vWPosition.y - origin.y) + n.z*(vWPosition.z - origin.z));\n               return ( dist - near ) / ( far - near );\n            }"),vectorLinearObjectSpaceDepth:new Wd("float vectorLinearObjectSpaceDepth(vec3 direction, vec3 origin, float near, float far) {\n               vec3 n = normalize(direction);\n               float dist = (n.x*(position.x - origin.x) + n.y*(position.y - origin.y) + n.z*(position.z - origin.z));\n               return ( dist - near ) / ( far - near );\n            }"),vectorSphericalWorldSpaceDepth:new Wd("float vectorSphericalWorldSpaceDepth(vec3 origin, float near, float far) {\n               float dist = length(vWPosition - origin);\n               return ( dist - near ) / ( far - near );\n            }"),vectorSphericalObjectSpaceDepth:new Wd("float vectorSphericalObjectSpaceDepth(vec3 origin, float near, float far) {\n               float dist = length(position - origin);\n               return ( dist - near ) / ( far - near );\n            }")};var Wp=class extends Ud{constructor(t,e,r,n,i,a,o,s){super("v3"),this.nodeType="Fresnel",this.color=t,this.bias=e,this.scale=r,this.intensity=n,this.factor=i,this.isMask=s,this.alpha=a,this.mode=o,this.calpha="g".concat(this.uuid.toString().replace(/-/g,""),"_calpha")}generate(t,e){if(t.require("vWorldViewDir"),t.require("worldNormal"),t.isShader("fragment")){t.addFragmentVariable(this.calpha,"float");let r=new Wd("vec3 fresnel(vec3 color, float bias, float scale, float intensity, float factor, bool isMask, float mask, float alpha, int mode, out float calpha) {\n\t\t\t\t\tfloat fresnel = bias + scale * pow( abs( factor + dot( normalize( vWorldViewDir ), normalize( vWNormal ) ) ), intensity );\n\n\t\t\t\t\tfloat lalpha = clamp(fresnel, 0.0, 1.0) * alpha * mask;\n\t\t\t\t\tcalpha = mix(lalpha / clamp(lalpha + accumAlpha, 0.00001, 1.0), lalpha, float(isMask));\n\t\t\t\t\taccumAlpha += (1.0 - accumAlpha) * lalpha * (1.0 - float(isMask));\n\n\t\t\t\t\treturn color;\n\t\t\t\t}"),n=t.include(r),i=[];return i.push(this.color.build(t,"c")),i.push(this.bias.build(t,"f")),i.push(this.scale.build(t,"f")),i.push(this.intensity.build(t,"f")),i.push(this.factor.build(t,"f")),i.push(this.isMask.build(t,"b")),i.push(this.mask?"luminance(".concat(this.mask.flow(t,"v3").result,")"):"1.0"),i.push(this.alpha.build(t,"f")),i.push(this.mode.build(t,"i")),i.push(this.calpha),t.format(n+"("+i.join(",")+")",this.getType(t),e)}return console.warn("FresnelNode is not compatible with "+t.shader+" shader."),t.format("vec3( 0.0 )",this.getType(t),e)}},Xp=class extends Ud{constructor(t,e,r,n,i,a,o,s,l){super("v3"),this.nodeType="Gradient",this.gradientType=t,this.smooth=e,this.colors=r,this.steps=n,this.offset=i,this.morph=a,this.angle=o,this.isMask=l,this.alpha=s,this.calpha="g".concat(this.uuid.toString().replace(/-/g,""),"_calpha")}generate(t,e){if(t.isShader("fragment")){t.define("GRAD_MAX",10),t.require("uv"),t.requires.uv=[!0],t.addFragmentVariable(this.calpha,"float");let r=t.include(Xp.Nodes.gradient),n=[];return n.push(this.gradientType.build(t,"i")),n.push(this.smooth.build(t,"b")),n.push(this.colors.build(t,"v4[]")),n.push(this.steps.build(t,"f[]")),n.push(this.offset.build(t,"v2")),n.push(this.morph.build(t,"v2")),n.push(this.angle.build(t,"f")),n.push(this.isMask.build(t,"b")),n.push(this.mask?"luminance(".concat(this.mask.flow(t,"v3").result,")"):"1.0"),n.push(this.alpha.build(t,"f")),n.push(this.calpha),t.format(r+"("+n.join(",")+")",this.getType(t),e)}return console.warn("GradientNode is not compatible with "+t.shader+" shader."),t.format("vec3( 0.0 )",this.getType(t),e)}},Yp=Xp;Yp.Nodes={gradient:new Wd("vec3 gradient(int gradientType, bool smoothed, vec4 colors[GRAD_MAX], float steps[GRAD_MAX], vec2 offset, vec2 morph, float angle, bool isMask, float mask, float alpha, out float calpha) {\n\t\t\t\tvec4 color = colors[0];\n\t\t\t\tvec2 m = morph / vUv.xy;\n\t\t\t\tvec2 rot = vec2( 0.5 + m.x, m.y );\n\t\t\t\tvec2 dt = vec2(\n\t\t\t\t\tcos( angle ) * rot.x - sin( angle ) * rot.y,\n\t\t\t\t\tsin( angle ) * rot.x + cos( angle ) * rot.y\n\t\t\t\t);\n\t\t\t\tvec2 pt = ( vUv - 0.5 + offset ) / 2.0 + dt / 2.0;\n\t\t\t\tfloat t = dot( pt, dt ) / dot( dt, dt );\n\t\t\t\tif ( gradientType == 1 ) {\n\t\t\t\t\tt = distance (\n\t\t\t\t\t\t( vUv + morph ) * 3.0,\n\t\t\t\t\t\t( vUv + offset ) + 1.0\n\t\t\t\t\t) + angle;\n\t\t\t\t} else if ( gradientType == 2 ) {\n\t\t\t\t\tfloat polar = atan(\n\t\t\t\t\t\tvUv.x + morph.x - 0.5 + offset.x,\n\t\t\t\t\t\tvUv.y + morph.y - 0.5 + offset.y\n\t\t\t\t\t) * -1.0;\n\t\t\t\t\tt = fract( ( angle / PI / -2.0 ) + 0.5 * ( polar / PI ) );\n\t\t\t\t}\n\n\t\t\t\tfloat p;\n\t\t\t\tif (smoothed) {\n\t\t\t\t\tfor ( int i = 1; i < GRAD_MAX; i++ ) {\n\t\t\t\t\t\tp = clamp( ( t - steps[i-1] ) / ( steps[i] - steps[i-1] ), 0.0, 1.0 );\n\t\t\t\t\t\tcolor = mix(color, colors[i], smoothstep(0.0, 1.0, p));\n\t\t\t\t\t}\n\n\t\t\t\t} else {\n\t\t\t\t\tfor ( int i = 1; i < GRAD_MAX; i++ ) {\n\t\t\t\t\t\tp = clamp( ( t - steps[i-1] ) / ( steps[i] - steps[i-1] ), 0.0, 1.0 );\n\t\t\t\t\t\tcolor = mix(color, colors[i], p);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tfloat lalpha = alpha * color.a * mask;\n\t\t\t\tcalpha = mix(lalpha / clamp(lalpha + accumAlpha, 0.00001, 1.0), lalpha, float(isMask));\n\t\t\t\taccumAlpha += (1.0 - accumAlpha) * lalpha * (1.0 - float(isMask));\n\t\t\t\t\n\t\t\t\treturn color.xyz;\n\t\t\t}")};var Qp=class extends Ud{constructor(t,e,r,n){super("v3"),this.nodeType="Matcap",this.texture=t,this.isMask=n,this.alpha=e,this.mode=r,this.calpha="g".concat(this.uuid.toString().replace(/-/g,""),"_calpha")}generate(t,e){if(t.isShader("fragment")){t.addFragmentVariable(this.calpha,"float");let r=t.include(Qp.Nodes.matcap);t.require("normal"),t.requires.normal=!0;let n=[];return n.push(this.texture.generate(t,"t")),n.push("normal"),n.push(this.isMask.build(t,"b")),n.push(this.mask?"luminance(".concat(this.mask.flow(t,"v3").result,")"):"1.0"),n.push(this.alpha.build(t,"f")),n.push(this.mode.build(t,"i")),n.push(this.calpha),t.format(r+"("+n.join(",")+")",this.getType(t),e)}return console.warn("MatcapNode is not compatible with "+t.shader+" shader."),t.format("vec3( 0.0 )",this.getType(t),e)}},Zp=Qp;Zp.Nodes={matcap:new Wd("vec3 matcap(sampler2D matcapTex, vec3 normal, bool isMask, float mask, float alpha, int mode, out float calpha) {\n\t\t\t\t\tvec3 viewDir = normalize( vViewPosition );\n\t\t\t\t\tvec3 x = normalize( vec3( viewDir.z, 0.0, - viewDir.x ) );\n\t\t\t\t\tvec3 y = cross( viewDir, x );\n\t\t\t\t\tvec2 uv = vec2( dot( x, normal ), dot( y, normal ) ) * 0.495 + 0.5; // 0.495 to remove artifacts caused by undersized matcap disks\n\t\t\t\t\tvec4 matcapColor = texture2D( matcapTex, uv );\n\n\t\t\t\t\tfloat lalpha = alpha * mask;\n\t\t\t\t\tcalpha = mix(lalpha / clamp(lalpha + accumAlpha, 0.00001, 1.0), lalpha, float(isMask));\n\t\t\t\t\taccumAlpha += (1.0 - accumAlpha) * lalpha * (1.0 - float(isMask));\n\t\t\t\t\t\n\t\t\t\t\treturn matcapColor.rgb;\n            \t}")};var Kp,Jp=((Kp=Jp||{}).SIMPLEX="simplex3d",Kp.SIMPLEX_FRACTAL="simplex3dFractal",Kp.ASHIMA="simplexAshima",Kp.FBM="fbm",Kp.PERLIN="perlin",Kp.VORONOI="voronoi",Kp),$p=function(){let t=new Wd("vec3 random3(vec3 c) {\n\t\t\tfloat j = 4096.0*sin(dot(c,vec3(17.0, 59.4, 15.0)));\n\t\t\tvec3 r;\n\t\t\tr.z = fract(512.0*j);\n\t\t\tj *= .125;\n\t\t\tr.x = fract(512.0*j);\n\t\t\tj *= .125;\n\t\t\tr.y = fract(512.0*j);\n\t\t\treturn r-0.5;\n\t\t}"),e=new Wd("float simplex3d(vec3 p) {\n\t\t\t vec3 s = floor(p + dot(p, vec3(F3)));\n\t\t\t vec3 x = p - s + dot(s, vec3(G3));\n\t\t\t \n\t\t\t vec3 e = step(vec3(0.0), x - x.yzx);\n\t\t\t vec3 i1 = e*(1.0 - e.zxy);\n\t\t\t vec3 i2 = 1.0 - e.zxy*(1.0 - e);\n\t\t\t\t\n\t\t\t vec3 x1 = x - i1 + G3;\n\t\t\t vec3 x2 = x - i2 + 2.0*G3;\n\t\t\t vec3 x3 = x - 1.0 + 3.0*G3;\n\t\t\t \n\t\t\t vec4 w, d;\n\t\t\t \n\t\t\t w.x = dot(x, x);\n\t\t\t w.y = dot(x1, x1);\n\t\t\t w.z = dot(x2, x2);\n\t\t\t w.w = dot(x3, x3);\n\t\t\t \n\t\t\t w = max(0.6 - w, 0.0);\n\t\t\t \n\t\t\t d.x = dot(random3(s), x);\n\t\t\t d.y = dot(random3(s + i1), x1);\n\t\t\t d.z = dot(random3(s + i2), x2);\n\t\t\t d.w = dot(random3(s + 1.0), x3);\n\t\t\t \n\t\t\t w *= w;\n\t\t\t w *= w;\n\t\t\t d *= w;\n\t\t\t \n\t\t\t return dot(d, vec4(52.0));\n\t\t}",[t]);e.keywords.F3=new Qd("float F3 0.3333333"),e.keywords.G3=new Qd("float G3 0.1666667");let r=new Wd("float simplex3dFractal(vec3 m) {\n\t\t\tmat3 rot1 = mat3(-0.37, 0.36, 0.85,-0.14,-0.93, 0.34,0.92, 0.01,0.4);\n\t\t\tmat3 rot2 = mat3(-0.55,-0.39, 0.74, 0.33,-0.91,-0.24,0.77, 0.12,0.63);\n\t\t\tmat3 rot3 = mat3(-0.71, 0.52,-0.47,-0.08,-0.72,-0.68,-0.7,-0.45,0.56);\n\t\t\treturn 0.5333333 * simplex3d(m * rot1)\n\t\t\t\t + 0.2666667 * simplex3d(2.0 * m * rot2)\n\t\t\t\t + 0.1333333 * simplex3d(4.0 * m * rot3)\n\t\t\t\t + 0.0666667 * simplex3d(8.0 * m);\n\t\t}",[e]),n=new Wd("vec4 permute(vec4 x){return mod(((x*34.0)+1.0)*x, 289.0);}"),i=new Wd("vec4 taylorInvSqrt(vec4 r){return 1.79284291400159 - 0.85373472095314 * r;}"),a=new Wd("float simplexAshima(vec3 v) {\n\t\t  const vec2  C = vec2(1.0/6.0, 1.0/3.0) ;\n\t\t  const vec4  D = vec4(0.0, 0.5, 1.0, 2.0);\n\t\t  vec3 i  = floor(v + dot(v, C.yyy) );\n\t\t  vec3 x0 =   v - i + dot(i, C.xxx) ;\n\t\t  vec3 g = step(x0.yzx, x0.xyz);\n\t\t  vec3 l = 1.0 - g;\n\t\t  vec3 i1 = min( g.xyz, l.zxy );\n\t\t  vec3 i2 = max( g.xyz, l.zxy );\n\t\t  vec3 x1 = x0 - i1 + 1.0 * C.xxx;\n\t\t  vec3 x2 = x0 - i2 + 2.0 * C.xxx;\n\t\t  vec3 x3 = x0 - 1. + 3.0 * C.xxx;\n\t\t  i = mod(i, 289.0 ); \n\t\t  vec4 p = permute( permute( permute( \n\t\t\t\t\t i.z + vec4(0.0, i1.z, i2.z, 1.0 ))\n\t\t\t\t   + i.y + vec4(0.0, i1.y, i2.y, 1.0 )) \n\t\t\t\t   + i.x + vec4(0.0, i1.x, i2.x, 1.0 ));\n\t\t  float n_ = 1.0/7.0; // N=7\n\t\t  vec3  ns = n_ * D.wyz - D.xzx;\n\t\t  vec4 j = p - 49.0 * floor(p * ns.z *ns.z);  //  mod(p,N*N)\n\t\t  vec4 x_ = floor(j * ns.z);\n\t\t  vec4 y_ = floor(j - 7.0 * x_ );    // mod(j,N)\n\t\t  vec4 x = x_ *ns.x + ns.yyyy;\n\t\t  vec4 y = y_ *ns.x + ns.yyyy;\n\t\t  vec4 h = 1.0 - abs(x) - abs(y);\n\t\t  vec4 b0 = vec4( x.xy, y.xy );\n\t\t  vec4 b1 = vec4( x.zw, y.zw );\n\t\t  vec4 s0 = floor(b0)*2.0 + 1.0;\n\t\t  vec4 s1 = floor(b1)*2.0 + 1.0;\n\t\t  vec4 sh = -step(h, vec4(0.0));\n\t\t  vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy ;\n\t\t  vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww ;\n\t\t  vec3 p0 = vec3(a0.xy,h.x);\n\t\t  vec3 p1 = vec3(a0.zw,h.y);\n\t\t  vec3 p2 = vec3(a1.xy,h.z);\n\t\t  vec3 p3 = vec3(a1.zw,h.w);\n\t\t  vec4 norm = taylorInvSqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2, p2), dot(p3,p3)));\n\t\t  p0 *= norm.x;\n\t\t  p1 *= norm.y;\n\t\t  p2 *= norm.z;\n\t\t  p3 *= norm.w;\n\t\t  vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0);\n\t\t  m = m * m;\n\t\t  return 42.0 * dot( m*m, vec4( dot(p0,x0), dot(p1,x1), \n\t\t\t\t\t\t\t\t\t\tdot(p2,x2), dot(p3,x3) ) );\n\t\t}",[n,i]),o=new Wd("vec4 mod289(vec4 x){return x - floor(x * (1.0 / 289.0)) * 289.0;}"),s=new Wd("vec4 perm(vec4 x){return mod289(((x * 34.0) + 1.0) * x);}",[o]),l=new Wd("float noise(vec3 p){\n\t\t\tvec3 a = floor(p);\n\t\t\tvec3 d = p - a;\n\t\t\td = d * d * (3.0 - 2.0 * d);\n\t\t\tvec4 b = a.xxyy + vec4(0.0, 1.0, 0.0, 1.0);\n\t\t\tvec4 k1 = perm(b.xyxy);\n\t\t\tvec4 k2 = perm(k1.xyxy + b.zzww);\n\t\t\tvec4 c = k2 + a.zzzz;\n\t\t\tvec4 k3 = perm(c);\n\t\t\tvec4 k4 = perm(c + 1.0);\n\t\t\tvec4 o1 = fract(k3 * (1.0 / 41.0));\n\t\t\tvec4 o2 = fract(k4 * (1.0 / 41.0));\n\t\t\tvec4 o3 = o2 * d.z + o1 * (1.0 - d.z);\n\t\t\tvec2 o4 = o3.yw * d.x + o3.xz * (1.0 - d.x);\n\t\t\treturn o4.y * d.y + o4.x * (1.0 - d.y);\n\t\t}",[s]),h=new Wd("float fbm(vec3 x) {\n\t\t\tfloat v = 0.0;\n\t\t\tfloat a = 0.5;\n\t\t\tvec3 shift = vec3(100);\n\t\t\tfor (int i = 0; i < NUM_OCTAVES; ++i) {\n\t\t\t\tv += a * noise(x);\n\t\t\t\tx = x * 2.0 + shift;\n\t\t\t\ta *= 0.5;\n\t\t\t}\n\t\t\treturn v;\n\t\t}",[l]);h.keywords.NUM_OCTAVES=new Qd("int NUM_OCTAVES ".concat(5));let c=new Wd("vec3 fade(vec3 t) {return t*t*t*(t*(t*6.0-15.0)+10.0);}"),u=new Wd("float perlin(vec3 P){\n\t\t  vec3 Pi0 = floor(P);\n\t\t  vec3 Pi1 = Pi0 + vec3(1.0);\n\t\t  Pi0 = mod(Pi0, 289.0);\n\t\t  Pi1 = mod(Pi1, 289.0);\n\t\t  vec3 Pf0 = fract(P);\n\t\t  vec3 Pf1 = Pf0 - vec3(1.0);\n\t\t  vec4 ix = vec4(Pi0.x, Pi1.x, Pi0.x, Pi1.x);\n\t\t  vec4 iy = vec4(Pi0.yy, Pi1.yy);\n\t\t  vec4 iz0 = Pi0.zzzz;\n\t\t  vec4 iz1 = Pi1.zzzz;\n\t\t  vec4 ixy = permute(permute(ix) + iy);\n\t\t  vec4 ixy0 = permute(ixy + iz0);\n\t\t  vec4 ixy1 = permute(ixy + iz1);\n\t\t  vec4 gx0 = ixy0 / 7.0;\n\t\t  vec4 gy0 = fract(floor(gx0) / 7.0) - 0.5;\n\t\t  gx0 = fract(gx0);\n\t\t  vec4 gz0 = vec4(0.5) - abs(gx0) - abs(gy0);\n\t\t  vec4 sz0 = step(gz0, vec4(0.0));\n\t\t  gx0 -= sz0 * (step(0.0, gx0) - 0.5);\n\t\t  gy0 -= sz0 * (step(0.0, gy0) - 0.5);\n\t\t  vec4 gx1 = ixy1 / 7.0;\n\t\t  vec4 gy1 = fract(floor(gx1) / 7.0) - 0.5;\n\t\t  gx1 = fract(gx1);\n\t\t  vec4 gz1 = vec4(0.5) - abs(gx1) - abs(gy1);\n\t\t  vec4 sz1 = step(gz1, vec4(0.0));\n\t\t  gx1 -= sz1 * (step(0.0, gx1) - 0.5);\n\t\t  gy1 -= sz1 * (step(0.0, gy1) - 0.5);\n\t\t  vec3 g000 = vec3(gx0.x,gy0.x,gz0.x);\n\t\t  vec3 g100 = vec3(gx0.y,gy0.y,gz0.y);\n\t\t  vec3 g010 = vec3(gx0.z,gy0.z,gz0.z);\n\t\t  vec3 g110 = vec3(gx0.w,gy0.w,gz0.w);\n\t\t  vec3 g001 = vec3(gx1.x,gy1.x,gz1.x);\n\t\t  vec3 g101 = vec3(gx1.y,gy1.y,gz1.y);\n\t\t  vec3 g011 = vec3(gx1.z,gy1.z,gz1.z);\n\t\t  vec3 g111 = vec3(gx1.w,gy1.w,gz1.w);\n\t\t  vec4 norm0 = taylorInvSqrt(vec4(dot(g000, g000), dot(g010, g010), dot(g100, g100), dot(g110, g110)));\n\t\t  g000 *= norm0.x;\n\t\t  g010 *= norm0.y;\n\t\t  g100 *= norm0.z;\n\t\t  g110 *= norm0.w;\n\t\t  vec4 norm1 = taylorInvSqrt(vec4(dot(g001, g001), dot(g011, g011), dot(g101, g101), dot(g111, g111)));\n\t\t  g001 *= norm1.x;\n\t\t  g011 *= norm1.y;\n\t\t  g101 *= norm1.z;\n\t\t  g111 *= norm1.w;\n\t\t  float n000 = dot(g000, Pf0);\n\t\t  float n100 = dot(g100, vec3(Pf1.x, Pf0.yz));\n\t\t  float n010 = dot(g010, vec3(Pf0.x, Pf1.y, Pf0.z));\n\t\t  float n110 = dot(g110, vec3(Pf1.xy, Pf0.z));\n\t\t  float n001 = dot(g001, vec3(Pf0.xy, Pf1.z));\n\t\t  float n101 = dot(g101, vec3(Pf1.x, Pf0.y, Pf1.z));\n\t\t  float n011 = dot(g011, vec3(Pf0.x, Pf1.yz));\n\t\t  float n111 = dot(g111, Pf1);\n\t\t  vec3 fade_xyz = fade(Pf0);\n\t\t  vec4 n_z = mix(vec4(n000, n100, n010, n110), vec4(n001, n101, n011, n111), fade_xyz.z);\n\t\t  vec2 n_yz = mix(n_z.xy, n_z.zw, fade_xyz.y);\n\t\t  float n_xyz = mix(n_yz.x, n_yz.y, fade_xyz.x); \n\t\t  return 2.2 * n_xyz;\n\t\t}",[n,i,c]),d=new Wd("float hashwithoutsine13(vec3 p3)\n\t\t{\n\t\t\tp3  = fract(p3 * .1031);\n\t\t\tp3 += dot(p3, p3.yzx + 33.33);\n\t\t\treturn fract((p3.x + p3.y) * p3.z);\n\t\t}"),p=new Wd("vec3 hashwithoutsine33(vec3 p3)\n\t\t{\n\t\t\tp3 = fract(p3 * vec3(.1031, .1030, .0973));\n\t\t\tp3 += dot(p3, p3.yxz+33.33);\n\t\t\treturn fract((p3.xxy + p3.yxx)*p3.zyx);\n\t\t}"),f=new Wd("float metric(in vec3 p)\n\t\t{\n\t\t\t// L2 \n\t\t\treturn length(p);\n\n\t\t\t// Chebyshev \n\t\t\t// vec3 a = abs(p);\n\t\t\t// return max(a.x, max(a.y, a.z));\n\t\t}"),m=new Wd("float smin( float a, float b, float k )\n\t\t{\n\t\t\tfloat h = smoothstep(0.0, 1.0, 0.5 + 0.5 * (b - a) / k);\n\t\t\tfloat correction = k * h * (1.0 - h);\n\t\t\treturn mix(b, a, h) - correction;\n\t\t}"),v=new Wd("float smax( float a, float b, float k )\n\t\t{\n\t\t\tfloat h = smoothstep(1.0, 0.0, 0.5 + 0.5 * (a - b) / k);\n\t\t\tfloat correction = k * h * (1.0 - h);\n\t\t\treturn mix(a, b, h) + correction;\n\t\t}"),g=new Wd("float remap(float value, float input_min, float input_max, float output_min, float output_max) {\n\t\t\t// Compute width of each interval\n\t\t\tfloat input_width = input_max - input_min;\n\t\t\tfloat output_width = output_max - output_min;\n\t\t\n\t\t\t// Convert input range into a 0-1 range \n\t\t\tfloat scaled = (value - input_min) / input_width;\n\t\t\n\t\t\t// Convert the 0-1 range into a value in output range\n\t\t\treturn output_min + (scaled * output_width);\n\t\t}");return{simplex:e,simplexFractal:r,simplexAshima:a,fbm:h,perlin:u,voronoi:new Wd('float voronoi(in vec3 x, in int style, in float smoothness, in float seed, in int quality) \n\t\t{\n\t\t\t// Integer and fractional parts of this point\'s coordinates\n\t\t\tivec3 p = ivec3(floor(x));\n\t\t\tvec3 f = fract(x);\n\n\t\t\t// Different variables that we will use to construct noise:\n\t\t\t//\n\t\t\t// f1: distance to the closest feature point\n\t\t\t// f2: distance to the second closest feature point\n\t\t\t// e: distance to the closest edge (cell boundary)\n\t\t\t//\n\t\t\t// We also compute "smooth" versions of all of the above quantites, essentially\n\t\t\t// replacing "hard" minimums with "smooth" minimums (described by IQ)\n\t\t\tfloat f1_smooth = 8.0;\n\t\t\tfloat f1 = 8.0;\n\t\t\tfloat f2_smooth = 8.0;\n\t\t\tfloat f2 = 8.0;\n\t\t\tfloat e_smooth = 8.0;\n\t\t\tfloat e = 8.0;\n\n\t\t\t// Variables stored from closest cell\n\t\t\tivec3 mb;\n\t\t\tvec3 mr; \n\n\t\t\tint steps = quality;\n\t\t\t\n\t\t\tfor (int x = -steps; x <= steps; x++) \n\t\t\tfor (int y = -steps; y <= steps; y++)\n\t\t\tfor (int z = -steps; z <= steps; z++)\n\t\t\t{\n\t\t\t\tivec3 b = ivec3(x, y, z);\n\t\t\t\tvec3 r = vec3(b) + hashwithoutsine33(vec3(p + b) + seed) - f;\n\t\t\t\tfloat d = length(r);\n\t\t\t\t\n\t\t\t\tf1_smooth = smin(d, f1_smooth, smoothness);\n\n\t\t\t\t// Store un-smoothed distances too \n\t\t\t\tif (d < f1) \n\t\t\t\t{\n\t\t\t\t\tf2 = f1;\n\t\t\t\t\tf1 = d;\n\n\t\t\t\t\tmb = ivec3(x, y, z);\n\t\t\t\t\tmr = r;\n\t\t\t\t} \n\t\t\t\telse if (d < f2) \n\t\t\t\t{\n\t\t\t\t\tf2 = d;\n\t\t\t\t}\n\t\t\t}\t\n\t\t\t\n\t\t\tfloat id = hashwithoutsine13(vec3(p + mb) + seed);\n\n\t\t\t// Second pass for edge distance  \n\t\t\tfor (int x = -steps; x <= steps; x++) \n\t\t\tfor (int y = -steps; y <= steps; y++)\n\t\t\tfor (int z = -steps; z <= steps; z++)\n\t\t\t{\n\t\t\t\t// Start search at the cell that contains the closest point to "x" (found in 1st pass)\n\t\t\t\tivec3 b = mb + ivec3(x, y, z);\n\t\t\t\tvec3 r = vec3(b) + hashwithoutsine33(vec3(p + b) + seed) - f;\n\t\t\t\tfloat d1 = dot(0.5 * (mr + r), (r - mr)); \t\t\t\t// IQ normalizes "r - mr" but that breaks things for the smooth version?\n\t\t\t\tfloat d2 = dot(0.5 * (mr + r), normalize(r - mr));\n\n\t\t\t\te_smooth = smin(d1, e_smooth, smoothness);\n\n\t\t\t\te = min(e, d2);\n\n\t\t\t\t// Also compute a smooth version of F2 in this pass\n\t\t\t\t{\n\t\t\t\t\tivec3 b = ivec3(x, y, z);\n\t\t\t\t\tif (b != mb) \n\t\t\t\t\t{\n\t\t\t\t\t\tvec3 r = vec3(b) + hashwithoutsine33(vec3(p + b) + seed) - f;\n\t\t\t\t\t\tfloat d = length(r);\n\n\t\t\t\t\t\tf2_smooth = smin(d, f2_smooth, smoothness);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Different visualization modes \n\t\t\tif (style == 0) \n\t\t\t{\n\t\t\t\treturn f1_smooth;\n\t\t\t}\n\t\t\tif (style == 1) \n\t\t\t{\n\t\t\t\treturn f2_smooth;\n\t\t\t}\n\t\t\tif (style == 2) \n\t\t\t{\n\t\t\t\treturn f2_smooth - f1_smooth;\n\t\t\t\t\n\t\t\t\t// "Pebbles" also cool\n\t\t\t\t//return step(0.2, f2_smooth - f1_smooth);\n\t\t\t}\n\t\t\tif (style == 3) \n\t\t\t{\n\t\t\t\t// This one is really good for rock / stone effects\n\t\t\t\tfloat a = f1; \n\t\t\t\tfloat b = f2;\n\t\t\t\tfloat k = 3.0;\n\t\t\t\tfloat h = max(k - abs(a - b), 0.0) / k;\n\t\t\t\tfloat final = min(a, b) - h * h * k * (1.0 / 4.0);\n\t\t\t\treturn final;\n\t\t\t}\n\t\t\tif (style == 4) \n\t\t\t{\n\t\t\t\t// Some random adjustments to make this style stand out more \n\t\t\t\treturn exp(5.0 * e_smooth);\n\t\t\t}\n\t\t\tif (style == 5) \n\t\t\t{\n\t\t\t\treturn pow(f1_smooth, 3.0);\n\t\t\t}\n\t\t\tif (style == 6) \n\t\t\t{\t\t\t\t\n\t\t\t\tconst float eps = 0.0125;\n\n\t\t\t\t// Thicker lines as the user increases the smoothness slider\n\t\t\t\tfloat thickness = smoothness * 0.25 + eps;\n\n\t\t\t\t// Blurrier lines as the user increases the smoothness slider\n\t\t\t\tfloat blur = pow(smoothness, 3.0) * 0.25 + eps;\n\n\t\t\t\treturn smoothstep(\n\t\t\t\t\tthickness - thickness * blur, \n\t\t\t\t\tthickness + thickness * blur, \n\t\t\t\t\te\n\t\t\t\t);\n\t\t\t}\n\t\t\tif (style == 7) \n\t\t\t{\n\t\t\t\treturn hashwithoutsine13(vec3(p + mb) + seed);\n\t\t\t}\n\t\t}\n\t',[d,p,f,m,v,g])}}(),tf=class extends Ud{constructor(t,e,r,n,i,a,o,s,l,h,c,u,d,p,f,m,v,g,y){super("v3"),this.nodeType="Noise",this.scale=t,this.size=e,this.move=r,this.fA=n,this.fB=i,this.distortion=a,this.colorA=o,this.colorB=s,this.colorC=l,this.colorD=h,this.noiseType=u,this.voronoiStyle=p,this.highCut=f,this.lowCut=m,this.smoothness=v,this.seed=g,this.quality=y,this.isMask=d,this.alpha=c,this.calpha="g".concat(this.uuid.toString().replace(/-/g,""),"_calpha")}generate(t,e,r,n,i){t.require("uv"),t.requires.uv=[!0],t.addFragmentVariable(this.calpha,"float");let a=Object.values(Jp)[this.noiseType.value],o="voronoi"==a?"\n\t\tfloat v = ".concat(a,'(st + move, voronoiStyle, smoothness, seed, quality);\n\n\t\t// Apply clipping to colors\n\t\tv = remap(v, lowCut, highCut, 0.0, 1.0);\n\t\tv = smax(v, 0.0, smoothness * 0.25);\n\t\tv = smin(v, 1.0, smoothness * 0.25);\n\n\t\t// Note that the voronoi mode only uses colors "A" and "C" from the UI \n\t\tvec4 color = mix(colorA, colorC, v); \n\t\t'):"\n\t\tvec3 q = vec3(".concat(a,"(st),\n\t\t\t\t\t   ").concat(a,"(st + vec3(1.0)),\n\t\t\t\t\t   ").concat(a,"(st + vec3(1.0)));\n\t\tvec3 r = vec3(").concat(a,"(st + vec3(distortion, 1.0) * q + vec3(fA, 1.0) + move),\n\t\t\t\t\t  ").concat(a,"(st + vec3(distortion, 1.0) * q + vec3(fB, 1.0) + move), \n\t\t\t\t\t  ").concat(a,"(st * q));\n\t\tfloat f = ").concat(a,"(st + r);\n\t\tvec4 color;\n\t\tcolor = mix(colorA, colorB, clamp((f * f) * 4.0, 0.0, 1.0));\n\t\tcolor = mix(color, colorC, clamp(length(q), 0.0, 1.0));\n\t\tcolor = mix(color, colorD, clamp(length(r.x), 0.0, 1.0));\n\t\t"),s=new Wd("vec3 ".concat(a,"customNoise(float scale, vec3 size, float move, vec2 fA, vec2 fB, vec2 distortion, vec4 colorA, vec4 colorB, vec4 colorC, vec4 colorD, int voronoiStyle, float highCut, float lowCut, float smoothness, float seed, int quality, bool isMask, float mask, float alpha, out float calpha) \n\t\t\t{\n                // Prevent scale of zero \n\t\t\t\tscale = max(abs(scale), 0.001);\n\n\t\t\t\tvec3 st = position / size;\n\t\t\t\tst /= scale;\n\n\t\t\t\t").concat(o,"\n\n\t\t\t\tfloat lalpha = alpha * color.a * mask;\n\t\t\t\tcalpha = mix(lalpha / clamp(lalpha + accumAlpha, 0.00001, 1.0), lalpha, float(isMask));\n\t\t\t\taccumAlpha += (1.0 - accumAlpha) * lalpha * (1.0 - float(isMask));\n\n\t\t\t\treturn clamp(color, 0.0, 1.0).rgb;\n\t\t\t}"),[$p.simplex,$p.simplexFractal,$p.simplexAshima,$p.fbm,$p.perlin,$p.voronoi]),l=t.include(s),h=[];return h.push(this.scale.build(t,"f")),h.push(this.size.build(t,"v3")),h.push(this.move.build(t,"f")),h.push(this.fA.build(t,"v2")),h.push(this.fB.build(t,"v2")),h.push(this.distortion.build(t,"v2")),h.push(this.colorA.build(t,"v4")),h.push(this.colorB.build(t,"v4")),h.push(this.colorC.build(t,"v4")),h.push(this.colorD.build(t,"v4")),h.push(this.voronoiStyle.build(t,"i")),h.push(this.highCut.build(t,"f")),h.push(this.lowCut.build(t,"f")),h.push(this.smoothness.build(t,"f")),h.push(this.seed.build(t,"f")),h.push(this.quality.build(t,"i")),h.push(this.isMask.build(t,"b")),h.push(this.mask?"luminance(".concat(this.mask.flow(t,"v3").result,")"):"1.0"),h.push(this.alpha.build(t,"f")),h.push(this.calpha),t.format(l+"("+h.join(",")+")",this.getType(t),e)}};tf.numOctaves=5;var ef=class extends Ud{constructor(t,e,r,n,i,a,o,s,l,h,c,u,d,p,f,m){super("v3"),this.nodeType="Outline",this.firstTime=!0,this.outlineColor=t,this.contourColor=e,this.outlineWidth=r,this.contourWidth=n,this.contourThreshold=i,this.outlineThreshold=a,this.contourFrequency=o,this.outlineSmoothing=s,this.contourDirection=l,this.positionalLines=h,this.compensation=c,this.resolution=u,this.normalMap=d,this.depthMap=p,this.pixelRatio=f,this.alpha=m,this.calpha="g".concat(this.uuid.toString().replace(/-/g,""),"_calpha")}generate(t,e){let r="g".concat(this.uuid.toString().replace(/-/g,""));if(t.require("vWorldViewDir"),t.require("worldNormal"),t.extensions.derivatives=!0,this.compensation.value&&t.define("OUTLINE_COMPENSATION","".concat(r,"_offset")),this.firstTime){let e=this.outlineWidth.build(t,"f"),n=this.resolution.build(t,"v2"),i=this.compensation.build(t,"b"),a=this.pixelRatio.build(t,"f");t.addVertexParsVariable("randomColor","attribute vec3"),t.addVertexParsVariable("extrudeNormal","attribute vec3"),t.addVertexParsVariable(e,"uniform float"),t.addVertexParsVariable(n,"uniform vec2"),t.addVertexParsVariable(i,"uniform bool"),t.addVertexParsVariable(a,"uniform float"),t.addVertexParsVariable("vID","flat out float"),t.addFragmentParsVariable("vID","flat in float"),t.addVertexFinalCode("\n                vID = randomColor.r;\n                vec2 ".concat(r,"_offset = vec2(0.0);\n                if (").concat(i,") {\n                    vec4 ").concat(r,"_clipPosition = projectionMatrix * (modelViewMatrix * vec4(position, 1.0));\n                    // NOTE: For certain shapes, like spheres, we get incorrect extrusion when the\n                    // normals face the camera directly. So we hackily fix this by offsetting the normal\n                    // by a tiny amount.\n                    vec3 ").concat(r,"_clipNormal = mat3(projectionMatrix) * (mat3(modelViewMatrix) * extrudeNormal) + 0.0000001;\n                    ").concat(r,"_offset = normalize(").concat(r,"_clipNormal.xy) / ").concat(n," * (").concat(e," / 2.0) * ").concat(r,"_clipPosition.w * 2.0 * ").concat(a,";\n                    ").concat(r,"_clipPosition.xy += ").concat(r,"_offset;\n                    // TODO(MAX): To handle multiple outline layers, we only want to extrude\n                    // if this offset is the biggest of all the potential offsets\n                    gl_Position = ").concat(r,"_clipPosition;\n                }\n            "))}if(t.isShader("fragment")){t.require("uv"),t.requires.uv=[!0],t.addFragmentVariable(this.calpha,"float");let r=t.include(ef.Nodes.outline),n=[];return n.push(this.outlineColor.build(t,"c")),n.push(this.contourColor.build(t,"c")),n.push(this.outlineWidth.build(t,"f")),n.push(this.contourWidth.build(t,"f")),n.push(this.contourThreshold.build(t,"f")),n.push(this.outlineThreshold.build(t,"f")),n.push(this.contourFrequency.build(t,"f")),n.push(this.outlineSmoothing.build(t,"f")),n.push(this.contourDirection.build(t,"v3")),n.push(this.positionalLines.build(t,"b")),n.push(this.resolution.build(t,"v2")),n.push(this.normalMap.getTexture(t,"t")),n.push(this.depthMap.getTexture(t,"t")),n.push(this.pixelRatio.build(t,"f")),n.push(this.compensation.build(t,"b")),n.push(this.mask?"luminance(".concat(this.mask.flow(t,"v3").result,")"):"1.0"),n.push(this.alpha.build(t,"f")),n.push(this.calpha),this.firstTime=!this.firstTime,t.format(r+"("+n.join(",")+")",this.getType(t),e)}return console.warn("OutlineNode is not compatible with "+t.shader+" shader."),""}},rf=ef;rf.Nodes=function(){let t=new Wd("\nfloat sobelSample(sampler2D t, sampler2D d, vec2 uv, vec2 resolution, float outlineWidth, float pixelRatio)\n{\n    vec2 halton = haltonSequence[frameIndex];\n    float temporalOffset = getNoiseInterleavedGradient(gl_FragCoord.xy + halton);\n    float temporalAngle  = temporalOffset * PI2;\n\n    vec2 texelSize = (vec2(1.0) / resolution);\n    vec2 offsetSize = texelSize * outlineWidth * pixelRatio;\n\n    vec2 uvSamples[9];\n    vec4 normalSamples[9];\n\n\tuvSamples[0] = uv + vec2( -offsetSize.x, -offsetSize.y) + (vogelDiskSample(0, 9, temporalAngle) * texelSize);\n\tuvSamples[1] = uv + vec2(0.0, -offsetSize.y) + (vogelDiskSample(1, 9, temporalAngle) * texelSize);\n\tuvSamples[2] = uv + vec2(  offsetSize.x, -offsetSize.y) + (vogelDiskSample(2, 9, temporalAngle) * texelSize);\n\tuvSamples[3] = uv + vec2( -offsetSize.x, 0.0) + (vogelDiskSample(3, 9, temporalAngle) * texelSize);\n\tuvSamples[4] = uv;\n\tuvSamples[5] = uv + vec2(  offsetSize.x, 0.0) + (vogelDiskSample(5, 9, temporalAngle) * texelSize);\n\tuvSamples[6] = uv + vec2( -offsetSize.x, offsetSize.y) + (vogelDiskSample(6, 9, temporalAngle) * texelSize);\n\tuvSamples[7] = uv + vec2(0.0, offsetSize.y) + (vogelDiskSample(7, 9, temporalAngle) * texelSize);\n\tuvSamples[8] = uv + vec2(  offsetSize.x, offsetSize.y) + (vogelDiskSample(8, 9, temporalAngle) * texelSize);\n\n\n    normalSamples[0] = texture2D(t, uvSamples[0]);\n    normalSamples[1] = texture2D(t, uvSamples[1]);\n    normalSamples[2] = texture2D(t, uvSamples[2]);\n    normalSamples[3] = texture2D(t, uvSamples[3]);\n    normalSamples[4] = texture2D(t, uvSamples[4]);\n    normalSamples[5] = texture2D(t, uvSamples[5]);\n    normalSamples[6] = texture2D(t, uvSamples[6]);\n    normalSamples[7] = texture2D(t, uvSamples[7]);\n    normalSamples[8] = texture2D(t, uvSamples[8]);\n\n    float depthBias = 0.0001;\n    // TODO(MAX): Can we somehow reduce the number of conditionals here with MATH?!\n    if (normalSamples[0].a != vID && normalSamples[0].a != 0.0) {\n        float depthAtSample = texture2D(d, uvSamples[0]).r + depthBias;\n        if (gl_FragCoord.z > depthAtSample) {\n           return 0.0;\n        }\n    }\n\n    if (normalSamples[1].a != vID && normalSamples[1].a != 0.0) {\n        float depthAtSample = texture2D(d, uvSamples[1]).r + depthBias;\n        if (gl_FragCoord.z > depthAtSample) {\n           return 0.0;\n        }\n    }\n\n    if (normalSamples[2].a != vID && normalSamples[2].a != 0.0) {\n        float depthAtSample = texture2D(d, uvSamples[2]).r + depthBias;\n        if (gl_FragCoord.z > depthAtSample) {\n           return 0.0;\n        }\n    }\n\n    if (normalSamples[3].a != vID && normalSamples[3].a != 0.0) {\n        float depthAtSample = texture2D(d, uvSamples[3]).r + depthBias;\n        if (gl_FragCoord.z > depthAtSample) {\n           return 0.0;\n        }\n    }\n\n\n    if (normalSamples[4].a != vID && normalSamples[4].a != 0.0) {\n        float depthAtSample = texture2D(d, uvSamples[4]).r + depthBias;\n        if (gl_FragCoord.z > depthAtSample) {\n           return 0.0;\n        }\n    }\n\n    if (normalSamples[5].a != vID && normalSamples[5].a != 0.0) {\n        float depthAtSample = texture2D(d, uvSamples[5]).r + depthBias;\n        if (gl_FragCoord.z > depthAtSample) {\n           return 0.0;\n        }\n    }\n\n    if (normalSamples[6].a != vID && normalSamples[6].a != 0.0) {\n        float depthAtSample = texture2D(d, uvSamples[6]).r + depthBias;\n        if (gl_FragCoord.z > depthAtSample) {\n           return 0.0;\n        }\n    }\n\n    if (normalSamples[7].a != vID && normalSamples[7].a != 0.0) {\n        float depthAtSample = texture2D(d, uvSamples[7]).r + depthBias;\n        if (gl_FragCoord.z > depthAtSample) {\n           return 0.0;\n        }\n    }\n\n    if (normalSamples[8].a != vID && normalSamples[8].a != 0.0) {\n        float depthAtSample = texture2D(d, uvSamples[8]).r + depthBias;\n        if (gl_FragCoord.z > depthAtSample) {\n           return 0.0;\n        }\n    }\n\n    vec3 sobel_edge_h = normalSamples[2].rgb + (2.0*normalSamples[5].rgb) + normalSamples[8].rgb - (normalSamples[0].rgb + (2.0*normalSamples[3].rgb) + normalSamples[6].rgb);\n  \tvec3 sobel_edge_v = normalSamples[0].rgb + (2.0*normalSamples[1].rgb) + normalSamples[2].rgb - (normalSamples[6].rgb + (2.0*normalSamples[7].rgb) + normalSamples[8].rgb);\n\n    float edgeNormal = sqrt(dot(sobel_edge_h, sobel_edge_h) + dot(sobel_edge_v, sobel_edge_v));\n    return edgeNormal;\n}\n");return{outline:new Wd("vec3 outline(vec3 outlineColor, vec3 contourColor, float outlineWidth, float contourWidth, float outlineThreshold, float contourThreshold, float outlineSmoothing, float contourFrequency, vec3 contourDirection, bool positionalLines, vec2 resolution, sampler2D normalMap, sampler2D depthMap, float pixelRatio, bool compensation, float mask, float alpha, out float calpha) {\n                vec3 result = outlineColor;\n                float resultAlpha = 0.0;\n\n                vec3 N = normalize(vWNormal);\n                vec2 nuv = (gl_FragCoord.xy / resolution);\n                float sobelSample = compensation ? sobelSample(normalMap, depthMap, nuv, resolution, outlineWidth / 2., pixelRatio) : sobelSample(normalMap, depthMap, nuv, resolution, outlineWidth, pixelRatio);\n                resultAlpha = smoothstep(outlineThreshold - outlineSmoothing, outlineThreshold + outlineSmoothing, sobelSample);\n\n                //resultAlpha = 1.0;\n                //result = vec3(sobelSample);\n\n                float t = 1.0 - contourThreshold;\n                if(positionalLines) {\n                    vec3 NDir = position * contourDirection;\n                    float NT = NDir.x + NDir.y + NDir.z;\n                    float f  = fract(NT * contourFrequency * 0.01);\n                    float df = fwidth(NT * contourFrequency);\n\n                    float g = smoothstep(df * (contourWidth * 0.01), df * (contourWidth * 0.01 * 2.0), f);\n                    if (g < 1.0 && resultAlpha == 0.0) {\n                        result = contourColor;\n                        resultAlpha = 1.0;\n                    }\n                 }\n                 else {\n                    vec3 NDir = N * contourDirection;\n                    float NT = NDir.x + NDir.y + NDir.z;\n                    float df = fwidth(NT * contourThreshold);\n                    float f = sin(NT * 1.0 * contourFrequency);\n                    float g = smoothstep(0.0, df * contourWidth, 1.0 - f);\n\n                    if (df > (t * 0.5) && g < 1.0 && resultAlpha == 0.0) {\n                        result = contourColor;\n                        resultAlpha = 1.0 - g;\n                    }\n                 }\n\n                 float lalpha = alpha * resultAlpha * mask;\n                 calpha =  lalpha / clamp( lalpha + accumAlpha, 0.00001, 1.0 );\n                 accumAlpha += ( 1.0 - accumAlpha ) * lalpha;\n\t\t\t\t \n                 return result;\n             }",[t])}}();var nf=class extends Ud{constructor(t,e,r,n,i,a,o,s,l,h,c,u,d,p,f,m,v,g){super("v3"),this.nodeType="Pattern",this.style=t,this.projection=e,this.axis=r,this.blending=n,this.offset=i,this.colorA=a,this.colorB=o,this.frequency=s,this.size=l,this.variation=h,this.smoothness=c,this.zigzag=u,this.rotation=d,this.vertical=p,this.horizontal=f,this.sides=m,this.isMask=g,this.alpha=v,this.calpha="g".concat(this.uuid.toString().replace(/-/g,""),"_calpha")}generate(t,e){if(t.isShader("fragment")){let r;switch(t.require("position"),t.require("uv"),t.requires.uv=[!0],t.require("normal"),t.requires.normal=!0,t.addFragmentVariable(this.calpha,"float"),this.style.value){case 0:default:r="circle";break;case 1:r="ring";break;case 2:r="polygon";break;case 3:r="xcross";break;case 4:r="diamond";break;case 5:r="checkerboard";break;case 6:r="line";break;case 7:r="wave"}let n="g".concat(this.uuid.toString().replace(/-/g,"")),i=new Wd("float hashwithoutsine12(vec2 p)\n\t\t\t\t{\n\t\t\t\t\tvec3 p3 = fract(vec3(p.xyx) * .1031);\n\t\t\t\t\tp3 += dot(p3, p3.yzx + 33.33);\n\t\t\t\t\treturn fract((p3.x + p3.y) * p3.z);\n\t\t\t\t}"),a=new Wd("vec2 rotate_uv(in vec2 uv, float a, bool repeat) \n\t\t\t\t{\n\t\t\t\t\tconst float mid = 0.5;\n\t\t\t\t\tfloat radians = a * (PI / 180.0);\n\t\t\t\t\tvec2 rotated = vec2(\n\t\t\t\t\t\tcos(radians) * (uv.x - mid) + sin(radians) * (uv.y - mid) + mid,\n\t\t\t\t\t\tcos(radians) * (uv.y - mid) - sin(radians) * (uv.x - mid) + mid\n\t\t\t\t\t);\n\t\t\t\t\treturn repeat ? fract(rotated): rotated;\n\t\t\t\t}"),o="";if(4===this.projection.value){let t=2===this.style.value?"".concat(r,"(uv0, frequency, size, variation, smoothness_remapped, zigzag, rotation, sides)"):"".concat(r,"(uv0, frequency, size, variation, smoothness_remapped, zigzag, rotation)"),e=2===this.style.value?"".concat(r,"(uv1, frequency, size, variation, smoothness_remapped, zigzag, rotation, sides)"):"".concat(r,"(uv1, frequency, size, variation, smoothness_remapped, zigzag, rotation)"),n=2===this.style.value?"".concat(r,"(uv2, frequency, size, variation, smoothness_remapped, zigzag, rotation, sides)"):"".concat(r,"(uv2, frequency, size, variation, smoothness_remapped, zigzag, rotation)");o="\n\t\t\t\tvec3 p = position;\n\t\t\t\tfloat factor = 0.0125;\n\t\t\t\tvec2 uv0 = fract(p.xy * factor);\n\t\t\t\tvec2 uv1 = fract(p.zy * factor);\n\t\t\t\tvec2 uv2 = fract(p.xz * factor);\n\t\t\t\t\n\t\t\t\tuv0 = rotate_uv(uv0 + offset, rotation, true);\n\t\t\t\tuv1 = rotate_uv(uv1 + offset, rotation, true);\n\t\t\t\tuv2 = rotate_uv(uv2 + offset, rotation, true);\n\t\n\t\t\t\tfloat d0 = ".concat(t,";\n\t\t\t\tfloat d1 = ").concat(e,";\n\t\t\t\tfloat d2 = ").concat(n,";\n\t\t\t\t\n\t\t\t\t// Range from 3 to 128 seems to be good\n\t\t\t\tfloat exponent = (1.0 - blending) * 125.0 + 3.0;\n\n\t\t\t\tvec3 n = vObjectNormal;\n\t\t\t\tvec3 weights = abs(normalize(n));\n\t\t\t\tweights = pow(weights, vec3(exponent));\n\t\t\t\tweights /= dot(weights, vec3(1.0));\n\t\t\t\td0 *= weights.z;\n\t\t\t\td1 *= weights.x;\n\t\t\t\td2 *= weights.y;\n\t\t\t\tfloat draw = d0 + d1 + d2;\n\t\n\t\t\t\tvec2 custom_uv = uv0 * weights.z + uv1 * weights.x + uv2 * weights.y;\n\t\t\t\t")}else{let t=2===this.style.value?"".concat(r,"(custom_uv, frequency, size, variation, smoothness_remapped, zigzag, rotation, sides)"):"".concat(r,"(custom_uv, frequency, size, variation, smoothness_remapped, zigzag, rotation)"),e="";0===this.axis.value?e="float radius = length(p);\n\t\t\t\t\tfloat theta = atan(p.y, p.z);\n\t\t\t\t\tfloat phi = acos(p.x / radius);":1===this.axis.value?e="float radius = length(p);\n\t\t\t\t\tfloat theta = atan(p.x, p.z);\n\t\t\t\t\tfloat phi = acos(p.y / radius);":(this.axis.value,e="float radius = length(p);\n\t\t\t\t\tfloat theta = atan(p.y, p.x);\n\t\t\t\t\tfloat phi = acos(p.z / radius);");let n="";switch(this.projection.value){case 0:n="custom_uv = vUv.st;";break;case 1:case 3:default:break;case 2:n="\n\t\t\t\t\t\t\tvec3 p = position;\n\t\t\t\t\t\t\t".concat(e,"\n\t\t\t\t\t\t\tcustom_uv = vec2(theta, phi);\n\t\t\t\t\t\t\tcustom_uv /= PI;\n\t\t\t\t\t\t\t")}o="\n\t\t\t\tvec2 custom_uv;\n\t\t\t\t".concat(n,"\n\t\n\t\t\t\tcustom_uv += offset;\n\t\t\t\tcustom_uv = fract(custom_uv);\n\t\t\t\tcustom_uv = rotate_uv(custom_uv, rotation, true);\n\t\n\t\t\t\tfloat draw = ").concat(t,";\n\t\t\t\t")}let s=new Wd("vec3 ".concat(n,"_pattern(vec3 normal, float blending, int style, vec2 offset, vec4 colorA, vec4 colorB, vec2 frequency, float size, float variation, float smoothness, float zigzag, float rotation, vec2 vertical, vec2 horizontal, int sides, bool isMask, float mask, float alpha, out float calpha) {\n\t\t\t\t\tconst float TWO_PI = PI * 2.0;\n\t\t\t\t\tfloat smoothness_remapped = pow(smoothness, 5.0);\t\n\n\t\t\t\t\t").concat(o,"\n\n\t\t\t\t\t// Construct final output color\n\t\t\t\t\tvec4 color = mix(colorA, colorB, draw);\n\t\t\t\t\tcolor.a = clamp(color.a, 0.0, 1.0);\n\n\t\t\t\t\t// Apply cuts\n\t\t\t\t\tcolor.a *= \n\t\t\t\t\t\tstep(vertical.x, custom_uv.y) * \n\t\t\t\t\t\tstep(custom_uv.y, vertical.y);\n\t\t\t\t\tcolor.a *= \n\t\t\t\t\t\tstep(horizontal.x, abs(custom_uv.x)) * \n\t\t\t\t\t\tstep(abs(custom_uv.x), horizontal.y);\n\n\t\t\t\t\t// Accumulate alpha \n\t\t\t\t\tfloat lalpha = alpha * clamp(color.a, 0.0, 1.0) * mask;\n\t\t\t\t\tcalpha = mix(lalpha / clamp(lalpha + accumAlpha, 0.00001, 1.0), lalpha, float(isMask));\n\t\t\t\t\taccumAlpha += (1.0 - accumAlpha) * lalpha * (1.0 - float(isMask));\n\n\t\t\t\t\treturn clamp(color, 0.0, 1.0).rgb;\n\t\t\t\t}"),[a,i,nf.DrawFunctions.circle,nf.DrawFunctions.ring,nf.DrawFunctions.polygon,nf.DrawFunctions.cross,nf.DrawFunctions.diamond,nf.DrawFunctions.checkerboard,nf.DrawFunctions.line,nf.DrawFunctions.wave]),l=t.include(s),h=[];return h.push("normal"),h.push(this.blending.build(t,"f")),h.push(this.style.build(t,"i")),h.push(this.offset.build(t,"v2")),h.push(this.colorA.build(t,"v4")),h.push(this.colorB.build(t,"v4")),h.push(this.frequency.build(t,"v2")),h.push(this.size.build(t,"f")),h.push(this.variation.build(t,"f")),h.push(this.smoothness.build(t,"f")),h.push(this.zigzag.build(t,"f")),h.push(this.rotation.build(t,"f")),h.push(this.vertical.build(t,"v2")),h.push(this.horizontal.build(t,"v2")),h.push(this.sides.build(t,"i")),h.push(this.isMask.build(t,"b")),h.push(this.mask?"luminance(".concat(this.mask.flow(t,"v3").result,")"):"1.0"),h.push(this.alpha.build(t,"f")),h.push(this.calpha),t.format(l+"("+h.join(",")+")",this.getType(t),e)}return console.warn("PatterNode is not compatible with "+t.shader+" shader."),t.format("vec3(0.0)",this.getType(t),e)}},af=nf;af.DrawFunctions=function(){let t=new Wd("float hashwithoutsine12(vec2 p) {\n\t\t\t\tvec3 p3 = fract(vec3(p.xyx) * 0.1031);\n\t\t\t\tp3 += dot(p3, p3.yzx + 33.33);\n\t\t\t\treturn fract((p3.x + p3.y) * p3.z);\n\t\t\t}"),e=new Wd("vec2 tile_and_center(in vec2 uv, in vec2 frequency, in float variation, in float zigzag, in float rotation) {\n                // Create tiles in UV-space\n                uv *= frequency;\n\n                // Integer coords\n                vec2 i = floor(uv);\n\n                // Offset every other row based on zigzag param, then compute fractional coords\n                float row_offset = mod(i.y, 2.0);\n                uv.x += row_offset * zigzag;\n                vec2 f = fract(uv);\n\n\t\t\t\t// Rotate the tile itself:\n\t\t\t\t// const float mid = 0.5;\n\t\t\t\t// f = vec2(\n\t\t\t\t// \tcos(rotation) * (f.x - mid) + sin(rotation) * (f.y - mid) + mid,\n\t\t\t\t// \tcos(rotation) * (f.y - mid) - sin(rotation) * (f.x - mid) + mid\n\t\t\t\t// );\n\t\t\t\t// f = fract(f);\n\n                f = f * 2.0 - 1.0;\n\n\t\t\t\t// Recompute integer coords after shifting - then, random value per tile \n\t\t\t\ti = floor(uv);\n\t\t\t\tfloat rand = (hashwithoutsine12(i) * 5.0 + 1.0);\n\t\t\t\tfloat jitter = mix(1.0, rand, variation);\n\t\t\t\tf *= jitter;\n\n                return f;\n            }",[t]);return{tileAndCenter:e,circle:new Wd("float circle(in vec2 uv, in vec2 frequency, in float size, in float variation, in float smoothness, in float zigzag, in float rotation) {\n                vec2 f = tile_and_center(uv, frequency, variation, zigzag, rotation);\n                return smoothstep(\n                    -smoothness, \n                     smoothness, \n                     length(f) - size\n                );\n            }",[e]),ring:new Wd("float ring(in vec2 uv, in vec2 frequency, in float size, in float variation, in float smoothness, in float zigzag, in float rotation) {\n                vec2 f = tile_and_center(uv, frequency, variation, zigzag, rotation);\n\n\t\t\t\tfloat d = length(f);\n                const float inner_width = 0.5;\n\n                float outer = smoothstep(-smoothness, smoothness, d - size);\n                float inner = smoothstep(-smoothness, smoothness, d - size * inner_width);\n\t\t\t\treturn outer + (1.0 - inner);   \n            }",[e]),polygon:new Wd("float sdf_ngon(in vec2 p, in float r, in int n) {\n                float an = (PI * 2.0) / float(n);\n                float he = r * tan(0.5 * an);\n                \n                // Rotate to first sector\n                p = -p.yx; \n                float bn = an * floor((atan(p.y, p.x) + 0.5 * an) / an);\n                vec2  cs = vec2(cos(bn), sin(bn));\n                p = mat2(cs.x, -cs.y, cs.y, cs.x)*p;\n            \n                // Side of polygon\n                return length(p - vec2(r, clamp(p.y, -he, he))) * sign(p.x - r);\n            }\n            \n            float polygon(in vec2 uv, in vec2 frequency, in float size, in float variation, in float smoothness, in float zigzag, in float rotation, in int sides) {\n                vec2 f = tile_and_center(uv, frequency, variation, zigzag, rotation);\n                return smoothstep(-smoothness, smoothness, sdf_ngon(f, size, sides));\n            }",[e]),cross:new Wd("float sdf_cross(in vec2 p, in vec2 b, float r ) {\n                p = abs(p); \n\t\t\t\tp = (p.y > p.x) ? p.yx : p.xy;\n                vec2  q = p - b;\n                float k = max(q.y, q.x);\n                vec2  w = (k > 0.0) ? q : vec2(b.y - p.x, -k);\n                return sign(k) * length(max(w, 0.0)) + r;\n            }\n            \n            // Avoid namespace conflicts \n            float xcross(in vec2 uv, in vec2 frequency, in float size, in float variation, in float smoothness, in float zigzag, in float rotation) {\n                vec2 f = tile_and_center(uv, frequency, variation, zigzag, rotation);\n                return smoothstep(-smoothness, smoothness, sdf_cross(f, vec2(size, size * 0.25), smoothness));\n            }",[e]),diamond:new Wd("float ndot(vec2 a, vec2 b) { \n                return a.x*b.x - a.y*b.y; \n            }\n            \n            float sdf_diamond(in vec2 p, in vec2 b) {\n                p = abs(p);\n                float h = clamp(ndot(b - 2.0 * p, b) / dot(b, b), -1.0, 1.0);\n                float d = length(p - 0.5 * b * vec2(1.0 - h, 1.0 + h));\n                return d * sign(p.x * b.y + p.y * b.x - b.x * b.y);\n            }\n\n            float diamond(in vec2 uv, in vec2 frequency, in float size, in float variation, in float smoothness, in float zigzag, in float rotation) {\n                vec2 f = tile_and_center(uv, frequency, variation, zigzag, rotation);\n\t            return smoothstep(-smoothness, smoothness, sdf_diamond(f, vec2(size)));\n            }",[e]),checkerboard:new Wd("float checkerboard(in vec2 uv, in vec2 frequency, in float size, in float variation, in float smoothness, in float zigzag, in float rotation) {\n                uv *= frequency;\n                vec2 i = floor(uv);\n\n                float offset = mod(i.y, 2.0);\n\n                uv.x += offset + zigzag * offset;\n                float x = floor(uv.x);\n                \n                return mod(x, 2.0);\n            }"),line:new Wd("float line(in vec2 uv, in vec2 frequency, in float size, in float variation, in float smoothness, in float zigzag, in float rotation) {\n                vec2 f = tile_and_center(uv, frequency, 0.0, zigzag, rotation);\n\t\t\t\t\n\t\t\t\t// Different approach for variation param here\n\t\t\t\tfloat row = floor(uv * frequency).y;\n\t\t\t\tfloat rand = hashwithoutsine12(vec2(row));\n\t\t\t\tfloat s = mix(size, size * rand, variation);\n\n\t\t\t\treturn smoothstep(\n\t\t\t\t\ts - smoothness, \n\t\t\t\t\ts + smoothness, \n\t\t\t\t\tabs(f.y)\n\t\t\t\t);\n            }",[e]),wave:new Wd("// Uses bisection \n            float udf_cos(in vec2 p, in float a, in float b, in float c, in float d) {\n                // Convert all data to a primitive cosine wave\n                p = c * (p - vec2(d, a));\n                \n                const float TWO_PI = PI * 2.0;\n\n                // Reduce to principal half cycle\n                p.x = mod(p.x, TWO_PI); \n                if (p.x > PI) {\n                    p.x = TWO_PI - p.x;\n                }\n            \n                // Find zero of derivative (minimize distance)\n                float xa = 0.0;\n                float xb = TWO_PI;\n\n                // 24 bit precision\n                for (int i = 0; i < 24; i++) {\n                    float x = 0.5 * (xa + xb);\n                    float y = x - p.x + b * c * sin(x) * (p.y - b * c * cos(x));\n                    if (y < 0.0) xa = x; \n                    else xb = x;\n                }\n                float x = 0.5 * (xa + xb);\n                \n                // Compute distance    \n                vec2 q = vec2(x, b * c * cos(x));\n                return length(p - q) / c;\n            }\n\n            float wave(in vec2 uv, in vec2 frequency, in float size, in float variation, in float smoothness, in float zigzag, in float rotation) {\n                float repeat = frequency.x;\n                uv *= repeat;\n                vec2 i = floor(uv);\n                float row_offset = mod(i.y, 2.0);\n                uv.x += row_offset * zigzag;\n                vec2 f = vec2(uv.x, fract(uv.y));\n\n                // Generalized cosine: y(x) = a + b * cos(cx + d)\n                const float amplitude = 0.125;\n                float wave_frequency = frequency.y * 0.1;\n                float distance_estimate = udf_cos(f, 0.50, amplitude, wave_frequency * (2.0 * PI), 0.0);\n\n\t\t\t\t// Different approach for variation param here\n\t\t\t\tfloat rand = hashwithoutsine12(vec2(i.y));\n\t\t\t\tfloat s = mix(size, size * rand, variation);\n\n                return smoothstep(-smoothness, smoothness, distance_estimate - s * 0.5);\n            }")}}();var of=class extends Ud{constructor(t,e,r,n,i,a,o,s){super("v3"),this.nodeType="Rainbow",this.filmThickness=t,this.movement=e,this.wavelengths=r,this.noiseStrength=n,this.noiseScale=i,this.offset=a,this.isMask=s,this.alpha=o,this.calpha="g".concat(this.uuid.toString().replace(/-/g,""),"_calpha")}generate(t,e){if(t.require("vWorldViewDir"),t.require("worldNormal"),t.isShader("fragment")){t.require("uv"),t.requires.uv=[!0],t.addFragmentVariable(this.calpha,"float");let r=t.include(of.Nodes.rainbow),n=[];return n.push(this.filmThickness.build(t,"f")),n.push(this.movement.build(t,"f")),n.push(this.wavelengths.build(t,"v3")),n.push(this.noiseStrength.build(t,"f")),n.push(this.noiseScale.build(t,"f")),n.push(this.offset.build(t,"v3")),n.push(this.isMask.build(t,"b")),n.push(this.mask?"luminance(".concat(this.mask.flow(t,"v3").result,")"):"1.0"),n.push(this.alpha.build(t,"f")),n.push(this.calpha),t.format(r+"("+n.join(",")+")",this.getType(t),e)}return console.warn("RainbowNode is not compatible with "+t.shader+" shader."),t.format("vec3( 0.0 )",this.getType(t),e)}},sf=of;sf.Nodes=function(){let t=new Wd("vec3 attenuation(vec3 wavelengths, float filmThickness, float movement, float noiseStrength, float noiseScale, vec3 offset) {\n                 vec3 st = position / noiseScale;\n\t\t\t\t vec3 q = vec3(simplex3d(st),\n\t\t\t\t\t\t\t  simplex3d(st + vec3(1.0)),\n\t\t\t\t\t\t\t  simplex3d(st + vec3(1.0)));\n\n\t\t\t\t vec3 r = vec3(simplex3d(st + vec3(1.4, 1.3, 1.0) * q + vec3(1.7, 9.2, 1.0)),\n\t\t\t\t\t\t\t  simplex3d(st + vec3(2.0, 1.2, 1.0) * q + vec3(8.3, 2.8, 1.0)),\n\t\t\t\t\t\t\t  simplex3d(st * q));\n\n                 float noise = simplex3d(st + r);\n\n                 return .5 + .5 * cos((((filmThickness + (noise * noiseStrength)) / (vec3(wavelengths.r * 1.0, wavelengths.g * 0.8, wavelengths.b * 0.6) + 1.0)) * dot(normalize(vWorldViewDir + (offset * -0.001)), normalize(vWNormal))) + movement);\n             }",[$p.simplex]);return{rainbow:new Wd("vec3 rainbow(float filmThickness, float movement, vec3 wavelengths, float noiseStrength, float noiseScale, vec3 offset, bool isMask, float mask, float alpha, out float calpha) {\n\t\t\t\tvec3 res = clamp(attenuation(wavelengths, filmThickness, movement, noiseStrength, noiseScale, offset), 0.0, 2.0);\n\n\t\t\t\tfloat rainbowContribution = clamp(res.r + res.g + res.b, 0.0, 1.0);\n\n\t\t\t\tfloat lalpha = alpha * rainbowContribution * mask;\n\t\t\t\tcalpha = mix(lalpha / clamp(lalpha + accumAlpha, 0.00001, 1.0), lalpha, float(isMask));\n\t\t\t\taccumAlpha += (1.0 - accumAlpha) * lalpha * (1.0 - float(isMask));\n\n\t\t\t\treturn res;\n             }",[t])}}();var lf=class extends Ud{constructor(t,e,r,n,i,a,o,s,l,h){super("v3"),this.nodeType="Toon",this.positioning=t,this.colors=e,this.steps=r,this.source=n,this.isWorldSpace=i,this.noiseStrength=a,this.noiseScale=o,this.shadowColor=s,this.offset=l,this.alpha=h,this.calpha="g".concat(this.uuid.toString().replace(/-/g,""),"_calpha")}generate(t,e){if(t.require("worldNormal"),t.require("worldPosition"),t.isShader("fragment")){t.define("COLORS_MAX",10),t.addFragmentVariable(this.calpha,"float");let r=t.include(lf.Nodes.toon),n=[];return n.push(this.positioning.build(t,"i")),n.push(this.colors.build(t,"v4[]")),n.push(this.steps.build(t,"f[]")),n.push(this.source.build(t,"v3")),n.push(this.isWorldSpace.build(t,"b")),n.push(this.noiseStrength.build(t,"f")),n.push(this.noiseScale.build(t,"f")),n.push(this.shadowColor.build(t,"v4")),n.push(this.offset.build(t,"v3")),n.push(this.mask?"luminance(".concat(this.mask.flow(t,"v3").result,")"):"1.0"),n.push(this.alpha.build(t,"f")),n.push(this.calpha),t.format(r+"("+n.join(",")+")",this.getType(t),e)}return console.warn("ToonNode is not compatible with "+t.shader+" shader."),t.format("vec3( 0.0 )",this.getType(t),e)}},hf=lf;hf.Nodes=function(){let t=new Wd("float rand(float n) {\n\t\t\t\treturn fract(sin(n) * 43758.5453123);\n\t\t\t}"),e=new Wd("float hash1(float p) { \n\t\t\t\tp = fract(p * 0.011); \n\t\t\t\tp *= p + 7.5; \n\t\t\t\tp *= p + p; \n\t\t\t\treturn fract(p); \n\t\t\t}"),r=new Wd("float valueNoise(vec3 x) {\n\t\t\t\tconst vec3 step = vec3(110, 241, 171);\n\t\t\t\n\t\t\t\tvec3 i = floor(x);\n\t\t\t\tvec3 f = fract(x);\n\t\t\t \n\t\t\t\t// For performance, compute the base input to a 1D hash from the integer part of the argument and the \n\t\t\t\t// incremental change to the 1D based on the 3D -> 1D wrapping\n\t\t\t\tfloat n = dot(i, step);\n\t\t\t\n\t\t\t\tvec3 u = f * f * (3.0 - 2.0 * f);\n\t\t\t\treturn mix(mix(mix( hash1(n + dot(step, vec3(0, 0, 0))), hash1(n + dot(step, vec3(1, 0, 0))), u.x),\n\t\t\t\t\t\t\t   mix( hash1(n + dot(step, vec3(0, 1, 0))), hash1(n + dot(step, vec3(1, 1, 0))), u.x), u.y),\n\t\t\t\t\t\t   mix(mix( hash1(n + dot(step, vec3(0, 0, 1))), hash1(n + dot(step, vec3(1, 0, 1))), u.x),\n\t\t\t\t\t\t\t   mix( hash1(n + dot(step, vec3(0, 1, 1))), hash1(n + dot(step, vec3(1, 1, 1))), u.x), u.y), u.z);\n\t\t\t}",[e]),n=new Wd("vec3 hash3(vec3 x) {\n\t\t\t\tx = vec3(dot(x,vec3(127.1, 311.7, 74.7)),\n\t\t\t\t\t\t dot(x,vec3(269.5, 183.3, 246.1)),\n\t\t\t\t\t\t dot(x,vec3(113.5, 271.9, 124.6)));\n\t\t\t\n\t\t\t\treturn fract(sin(x)*43758.5453123);\n\t\t\t}"),i=new Wd('vec3 voronoiNoise(in vec3 x)\n\t\t\t{\n\t\t\t\tvec3 p = floor(x);\n\t\t\t\tvec3 f = fract(x);\n\n\t\t\t\tfloat id = 0.0;\n\t\t\t\tvec2 res = vec2(100.0);\n\n\t\t\t\tfor(int k=-1; k<=1; k++)\n\t\t\t\tfor(int j=-1; j<=1; j++)\n\t\t\t\tfor(int i=-1; i<=1; i++)\n\t\t\t\t{\n\t\t\t\t\tvec3 b = vec3(float(i), float(j), float(k));\n\n\t\t\t\t\t// Comment out the "+ hash(p + b);" part below to get "square" cells\n\t\t\t\t\tvec3 r = vec3(b) - f + hash3(p + b);\n\t\t\t\t\tfloat d = dot(r, r);\n\n\t\t\t\t\tif (d < res.x)\n\t\t\t\t\t{\n\t\t\t\t\t\tid = dot(p + b, vec3(1.0, 57.0, 113.0));\n\t\t\t\t\t\tres = vec2(d, res.x);\t\t\t\n\t\t\t\t\t}\n\t\t\t\t\telse if (d < res.y)\n\t\t\t\t\t{\n\t\t\t\t\t\tres.y = d;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn vec3(sqrt(res), abs(id));\n\t\t\t}\n\t\t\t',[n]);return{toon:new Wd('vec3 toon(int positioning, vec4 colors[COLORS_MAX], float steps[COLORS_MAX], vec3 source, bool isWorldSpace, float noiseStrength, float noiseScale, vec4 shadowColor, vec3 offset, float mask, float alpha, out float calpha) {\n\t\t\t\tfloat t = 0.0;\n\t\t\t\tfloat shadow = 1.0;\n\n\t\t\t\tif (positioning == 0) {\n\n\t\t\t\t\t// Can\'t do this mode if lighting is "none"\n\t\t\t\t\t#if (defined(PHONG) || defined(LAMBERT) || defined(STANDARD))\n\n\t\t\t\t\t\t// Algorithm from Chapter 10 of Graphics Shaders\n\t\t\t\t\t\tconst vec3 weights = vec3(0.2125, 0.7154, 0.0721);\n\t\t\t\t\t\tvec3 lpos;\n\t\t\t\t\t\tvec3 l;\n\t\t\t\t\t\tfloat dproduct;\n\n\t\t\t\t\t\t#if (NUM_POINT_LIGHTS > 0)\n\n\t\t\t\t\t\t\t#if defined(USE_SHADOWMAP) && (NUM_POINT_LIGHT_SHADOWS > 0)\n\t\t\t\t\t\t\t\tPointLightShadow pointLightShadow;\n\t\t\t\t\t\t\t#endif \n\n\t\t\t\t\t\t\t#pragma unroll_loop_start\n\t\t\t\t\t\t\tfor (int i = 0; i < NUM_POINT_LIGHTS; i++) {\n\t\t\t\t\t\t\t\t// Light positions are in view-space for some reason?\n\t\t\t\t\t\t\t\tlpos = (inverse(viewMatrix) * vec4(pointLights[UNROLLED_LOOP_INDEX].position, 1.0)).xyz;\n\t\t\t\t\t\t\t\tl = normalize(lpos - worldPosition);\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\tdproduct = dot(l, normalize(worldNormal)) * 0.5 + 0.5;\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t// TODO: we want to use "intensity" but it isn\'t available in the shader code\n\t\t\t\t\t\t\t\t//dproduct += dot(pointLights[UNROLLED_LOOP_INDEX].color, weights);\n\n\t\t\t\t\t\t\t\tt = max(t, dproduct);\n\n\t\t\t\t\t\t\t\t// Accumulate shadow contribution\n\t\t\t\t\t\t\t\t#if defined(USE_SHADOWMAP) && (UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS)\n\t\t\t\t\t\t\t\t\tpointLightShadow = pointLightShadows[UNROLLED_LOOP_INDEX];\n\t\t\t\t\t\t\t\t\tshadow *= getPointShadow( \n\t\t\t\t\t\t\t\t\t\t\tpointShadowMap[UNROLLED_LOOP_INDEX], \n\t\t\t\t\t\t\t\t\t\t\tpointLightShadow.shadowMapSize, \n\t\t\t\t\t\t\t\t\t\t\tpointLightShadow.shadowBias, \n\t\t\t\t\t\t\t\t\t\t\tpointLightShadow.shadowRadius,\n\t\t\t\t\t\t\t\t\t\t\tvPointShadowCoord[UNROLLED_LOOP_INDEX], \n\t\t\t\t\t\t\t\t\t\t\tpointLightShadow.shadowCameraNear, \n\t\t\t\t\t\t\t\t\t\t\tpointLightShadow.shadowCameraFar);\n\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t#pragma unroll_loop_end\n\n\t\t\t\t\t\t#endif\n\n\t\t\t\t\t\t#if NUM_DIR_LIGHTS > 0 \n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t#if defined(USE_SHADOWMAP) && (NUM_DIR_LIGHT_SHADOWS > 0)\n\t\t\t\t\t\t\t\tDirectionalLightShadow directionalLightShadow;\n\t\t\t\t\t\t\t#endif \n\n\t\t\t\t\t\t\t#pragma unroll_loop_start\n\t\t\t\t\t\t\tfor (int i = 0; i < NUM_DIR_LIGHTS; i++) {\n\t\t\t\t\t\t\t\t// Use the direction vector for directional lights instead\n\t\t\t\t\t\t\t\tl = (inverse(viewMatrix) * vec4(directionalLights[UNROLLED_LOOP_INDEX].direction, 0.0)).xyz;\n\t\t\n\t\t\t\t\t\t\t\tdproduct = dot(l, normalize(worldNormal)) * 0.5 + 0.5;\n\t\t\t\t\t\t\t\tt = max(t, dproduct);\n\n\t\t\t\t\t\t\t\t// Accumulate shadow contribution\n\t\t\t\t\t\t\t\t#if defined(USE_SHADOWMAP) && (UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS)\n\t\t\t\t\t\t\t\t\tdirectionalLightShadow = directionalLightShadows[UNROLLED_LOOP_INDEX];\n\t\t\t\t\t\t\t\t\tshadow *= getShadow( \n\t\t\t\t\t\t\t\t\t\tUNROLLED_LOOP_INDEX,\n\t\t\t\t\t\t\t\t\t\tdirectionalShadowMap[UNROLLED_LOOP_INDEX], \n\t\t\t\t\t\t\t\t\t\tdirectionalLightShadow.shadowMapSize, \n\t\t\t\t\t\t\t\t\t\tdirectionalLightShadow.shadowBias, \n\t\t\t\t\t\t\t\t\t\tdirectionalLightShadow.shadowRadius, \n\t\t\t\t\t\t\t\t\t\tvDirectionalShadowCoord[UNROLLED_LOOP_INDEX]);\n\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t#pragma unroll_loop_end\n\n\t\t\t\t\t\t#endif\n\n\t\t\t\t\t\t#if NUM_SPOT_LIGHTS > 0 \n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t#if defined(USE_SHADOWMAP) && (NUM_SPOT_LIGHT_SHADOWS > 0)\n\t\t\t\t\t\t\t\tSpotLightShadow spotLightShadow;\n\t\t\t\t\t\t\t#endif \n\n\t\t\t\t\t\t\t#pragma unroll_loop_start\n\t\t\t\t\t\t\tfor (int i = 0; i < NUM_SPOT_LIGHTS; i++) {\n\t\t\t\t\t\t\t\tlpos = (inverse(viewMatrix) * vec4(spotLights[UNROLLED_LOOP_INDEX].position, 1.0)).xyz;\n\t\t\t\t\t\t\t\tl = normalize(lpos - worldPosition);\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\tdproduct = dot(l, normalize(worldNormal)) * 0.5 + 0.5;\n\t\t\t\t\t\t\t\tt = max(t, dproduct);\n\n\t\t\t\t\t\t\t\t// Accumulate shadow contribution\n\t\t\t\t\t\t\t\t#if defined(USE_SHADOWMAP) && (UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS)\n\t\t\t\t\t\t\t\t\tspotLightShadow = spotLightShadows[UNROLLED_LOOP_INDEX];\n\t\t\t\t\t\t\t\t\tshadow *= getShadow(\n\t\t\t\t\t\t\t\t\t\tUNROLLED_LOOP_INDEX,\n\t\t\t\t\t\t\t\t\t\tspotShadowMap[UNROLLED_LOOP_INDEX], \n\t\t\t\t\t\t\t\t\t\tspotLightShadow.shadowMapSize, \n\t\t\t\t\t\t\t\t\t\tspotLightShadow.shadowBias, \n\t\t\t\t\t\t\t\t\t\tspotLightShadow.shadowRadius, \n\t\t\t\t\t\t\t\t\t\tvSpotLightCoord[UNROLLED_LOOP_INDEX]);\n\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t#pragma unroll_loop_end\n\n\t\t\t\t\t\t#endif\n\n\t\t\t\t\t\tt = clamp(t, 0.0, 1.0);\n\t\t\t\t\n\t\t\t\t\t#endif\n\n\t\t\t\t} else if (positioning == 1) {\n\t\t\t\t\t\n\t\t\t\t\tvec3 origin = mix(position, worldPosition, float(isWorldSpace));\n\t\t\t\t\tvec3 direction = normalize(source - origin);\n\t\t\t\t\tt = dot(direction, normalize(worldNormal)) * 0.5 + 0.5;\t\n\n\t\t\t\t} else {\n\n\t\t\t\t\tvec3 origin = worldPosition;\n\t\t\t\t\tvec3 source = cameraPosition - offset;\n\t\t\t\t\tvec3 direction = normalize(source - origin);\n\t\t\t\t\tt = dot(direction, normalize(worldNormal)) * 0.5 + 0.5;\t\n\t\t\t\t\t\n\t\t\t\t}\n\n\t\t\t\tif (noiseStrength > 0.0) {\n\t\t\t\t\t// Distort with noise\n\t\t\t\t\tvec3 st = position / noiseScale;\n\t\t\t\t\t\n\t\t\t\t\t// Voronoi "smooth" noise\n\t\t\t\t\tfloat noise = 1.0 - voronoiNoise(st).x;\n\n\t\t\t\t\t// Voronoi cellular noise\n\t\t\t\t\t//float noise = 1.0 - rand(voronoiNoise(st).z);\n\n\t\t\t\t\t// Position warp noise\n\t\t\t\t\t// vec3 offset = vec3(\n\t\t\t\t\t// \tsimplex3d(st),\n\t\t\t\t\t// \tsimplex3d(st + vec3(111.1, 143.89, 217.19)),\n\t\t\t\t\t// \tsimplex3d(st + vec3(171.1, 247.89, 117.23))\n\t\t\t\t\t// );\n\t\t\t\t\t// st += offset;\n\t\t\t\t\t// float noise = valueNoise(st);\n\n\t\t\t\t\tt += noise * noiseStrength;\n\t\t\t\t}\n\n\t\t\t\tt = clamp(t, 0.0, 1.0);\n\n\t\t\t\t// Compute ramp color\n\t\t\t\tfloat p;\n\t\t\t\tvec4 color = colors[0];\n\t\t\t\tfor (int i = 1; i < COLORS_MAX; i++) {\n\t\t\t\t\tp = clamp((t - steps[i-1]) / (steps[i] - steps[i-1]), 0.0, 1.0);\n\t\t\t\t\tcolor = mix(color, colors[i], smoothstep(0.0, 1.0, p));\n\t\t\t\t}\n\n\t\t\t\t// Incorporate custom shadow color\n\t\t\t\tif (positioning == 0) {\n\n\t\t\t\t\tvec3 blendedShadow = mix(color.rgb, shadowColor.rgb, shadowColor.a);\n\t\t\t\t\tcolor.rgb = mix(blendedShadow, color.rgb, shadow);\n\t\t\t\t\n\t\t\t\t}\n\n\t\t\t\t// Accumulate alpha as usual\n\t\t\t\tfloat lalpha = alpha * color.a * mask;\n\t\t\t\tcalpha =  lalpha / clamp(lalpha + accumAlpha, 0.00001, 1.0);\n\t\t\t\taccumAlpha += (1.0 - accumAlpha) * lalpha;\n\n\t\t\t\treturn color.xyz;\n\n            }',[$p.simplex,t,r,i])}}();var cf={textureBicubic:new Wd("float w0( float a ) {\n            return ( 1.0 / 6.0 ) * ( a * ( a * ( - a + 3.0 ) - 3.0 ) + 1.0 );\n        }\n    \n        float w1( float a ) {\n            return ( 1.0 / 6.0 ) * ( a *  a * ( 3.0 * a - 6.0 ) + 4.0 );\n        }\n    \n        float w2( float a ){\n            return ( 1.0 / 6.0 ) * ( a * ( a * ( - 3.0 * a + 3.0 ) + 3.0 ) + 1.0 );\n        }\n    \n        float w3( float a ) {\n            return ( 1.0 / 6.0 ) * ( a * a * a );\n        }\n    \n        // g0 and g1 are the two amplitude functions\n        float g0( float a ) {\n            return w0( a ) + w1( a );\n        }\n    \n        float g1( float a ) {\n            return w2( a ) + w3( a );\n        }\n    \n        // h0 and h1 are the two offset functions\n        float h0( float a ) {\n            return - 1.0 + w1( a ) / ( w0( a ) + w1( a ) );\n        }\n    \n        float h1( float a ) {\n            return 1.0 + w3( a ) / ( w2( a ) + w3( a ) );\n        }\n    \n        vec4 bicubic( sampler2D tex, vec2 uv, vec4 texelSize, float lod ) {\n            uv = uv * texelSize.zw + 0.5;\n    \n            vec2 iuv = floor( uv );\n            vec2 fuv = fract( uv );\n    \n            float g0x = g0( fuv.x );\n            float g1x = g1( fuv.x );\n            float h0x = h0( fuv.x );\n            float h1x = h1( fuv.x );\n            float h0y = h0( fuv.y );\n            float h1y = h1( fuv.y );\n    \n            vec2 p0 = ( vec2( iuv.x + h0x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;\n            vec2 p1 = ( vec2( iuv.x + h1x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;\n            vec2 p2 = ( vec2( iuv.x + h0x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;\n            vec2 p3 = ( vec2( iuv.x + h1x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;\n    \n            return g0( fuv.y ) * ( g0x * textureLod( tex, p0, lod ) + g1x * textureLod( tex, p1, lod ) ) + \n                   g1( fuv.y ) * ( g0x * textureLod( tex, p2, lod ) + g1x * textureLod( tex, p3, lod ) );\n        }\n\n        vec4 textureBicubic( sampler2D sampler, vec2 uv, float lod ) {\n            vec2 fLodSize = vec2( textureSize( sampler, int( lod ) ) );\n            vec2 cLodSize = vec2( textureSize( sampler, int( lod + 1.0 ) ) );\n            vec2 fLodSizeInv = 1.0 / fLodSize;\n            vec2 cLodSizeInv = 1.0 / cLodSize;\n            vec4 fSample = bicubic( sampler, uv, vec4( fLodSizeInv, fLodSize ), floor( lod ) );\n            vec4 cSample = bicubic( sampler, uv, vec4( cLodSizeInv, cLodSize ), ceil( lod ) );\n            return mix( fSample, cSample, fract( lod ) );\n        }")};var uf=class extends Ud{constructor(t,e,r,n,i,a,o,s){super("v3"),this.nodeType="Transmission",this.thickness=t,this.ior=e,this.roughness=r,this.transmissionSamplerSize=n,this.transmissionSamplerMap=i,this.transmissionDepthMap=a,this.aspectRatio=o,this.alpha=s,this.calpha="g".concat(this.uuid.toString().replace(/-/g,""),"_calpha")}generate(t,e){if(t.extensions.shaderTextureLOD=!0,t.extensions.derivatives=!0,t.isShader("fragment")){t.define("NUM_SAMPLES",6),t.define("BLUR_SLOD",Math.pow(2,vf.transmissionLod.value)),t.require("worldPosition"),t.requires.worldNormal=!0,t.requires.modelMatrix=!0,t.requires.projectionMatrix=!0,t.addFragmentVariable(this.calpha,"float");let r=t.include(uf.Nodes.transmission),n=[];return n.push(this.thickness.build(t,"f")),n.push(this.ior.build(t,"f")),n.push(this.roughness.build(t,"f")),n.push(this.transmissionSamplerSize.build(t,"v2")),n.push(this.transmissionSamplerMap.getTexture(t,"t")),n.push(this.transmissionDepthMap.getTexture(t,"t")),n.push(this.aspectRatio.build(t,"v2")),n.push("normal"),n.push(this.mask?"luminance(".concat(this.mask.flow(t,"v3").result,")"):"1.0"),n.push(this.alpha.build(t,"f")),n.push(this.calpha),t.format(r+"("+n.join(",")+")",this.getType(t),e)}return console.warn("TransmissionNode is not compatible with "+t.shader+" shader."),t.format("vec3( 0.0 )",this.getType(t),e)}},df=uf;df.Nodes=function(){let t=new Wd("vec3 blur(sampler2D sp, vec2 U, vec2 scale, float lod, sampler2D dm, vec2 unrefractedU, vec2 aspectRatio) {\n                // Slightly modified version of this:\n                // https://www.shadertoy.com/view/ltScRG\n\n\t\t\t\t// Special case for blur == 0.0\n\t\t\t\tif (lod == 0.0) {\n\t\t\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\t\treturn texture2DLodEXT( sp, U, 0.0).rgb;\n\t\t\t\t\t#else\n\t\t\t\t\treturn textureLod( sp, U, 0.0).rgb;\n\t\t\t\t\t#endif\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tvec2 texelSize = vec2(1.0) / resolution;\n                vec2 halton = haltonSequence[frameIndex];\n                float temporalOffset = getNoiseInterleavedGradient(gl_FragCoord.xy + halton);\n                float temporalAngle  = temporalOffset * PI2;\n\t\t\t\tvec3 res = vec3(0.0);\n                vec2 uv = vec2(0.0);\n                vec2 offset = vec2(0.0);\n                vec2 vogelSample = vec2(0.0);\n                for (int i = 0; i < NUM_SAMPLES; i++) {\n                    vogelSample =  vogelDiskSample(i, NUM_SAMPLES, temporalAngle) * texelSize;\n                    offset = vogelSample * scale * (lod * 10.0); // TODO: used to be hardcoded to 20\n                    uv = U + offset;\n                    float opaqueDepth = unpackRGBAToDepth(textureLod(dm, uv, lod));\n                    if (opaqueDepth != 0.0 && opaqueDepth < gl_FragCoord.z) {\n                        uv = unrefractedU;\n                        lod = lod > 4.0 ? lod : lod / 2.0;\n                    }\n                    res += textureLod(sp, uv, lod).rgb;\n                }\n                return res / float(NUM_SAMPLES);\n            }"),e=new Wd("vec3 getVolumeTransmissionRay( vec3 n, vec3 v, float thickness, float ior, mat4 modelMatrix ) {\n\t\t        // Direction of refracted light.\n\t\t        vec3 refractionVector = refract( -v,  n, 1.0 / ior );\n\t\t        \n\t\t\t\t// Compute rotation-independant scaling of the model matrix.\n\t\t        vec3 modelScale;\n\t\t        modelScale.x = length( vec3( modelMatrix[ 0 ].xyz ) );\n\t\t        modelScale.y = length( vec3( modelMatrix[ 1 ].xyz ) );\n\t\t        modelScale.z = length( vec3( modelMatrix[ 2 ].xyz ) );\n\n\t\t        // The thickness is specified in local space\n\t\t        return normalize( refractionVector ) * thickness * modelScale;\n\t        }"),r=new Wd("float applyIorToRoughness( float roughness, float ior ) {\n\t\t\t\t// Scale roughness with IOR so that an IOR of 1.0 results in no microfacet refraction and\n\t\t\t\t// an IOR of 1.5 results in the default amount of microfacet refraction.\n\t\t\t\treturn roughness * clamp( ior * 2.0 - 2.0, 0.0, 1.0 );\n\t\t\t}"),n=new Wd('vec3 getTransmissionSample( vec2 fragCoord, float roughness, float ior, vec2 transmissionSamplerSize, sampler2D transmissionSamplerMap, sampler2D transmissionDepthMap, vec2 unrefractedCoords, vec2 aspectRatio) {\n\t\t\t\t// Threejs exports do not pass a depth map to this shader, so we have to fallback to the "Threejs method of blurring" - see\n\t\t\t\t// also the code in convertTransmission.ts, which runs during export\n\t\t\t\t#ifdef IS_THREEJS_EXPORT\n\t\t\t\t\tfloat lod = log2(transmissionSamplerSize.x) * applyIorToRoughness(roughness / 5.0, ior);\n\t\t\t\t\treturn textureBicubic(transmissionSamplerMap, fragCoord.xy, lod).rgb;\n\t\t\t\t#else\n\t\t\t\t\tfloat framebufferLod = log2( transmissionSamplerSize.x ) * applyIorToRoughness( roughness, ior );\n\t\t\t\t\tfloat lod = applyIorToRoughness(roughness, ior);\n\t\t\t\t\treturn blur(transmissionSamplerMap, fragCoord, vec2(lod), min(framebufferLod / 5.5, 8.5), transmissionDepthMap, unrefractedCoords, aspectRatio);\n\t\t\t\t#endif\n\t\t\t}',[cf.textureBicubic,r,t]),i=new Wd("vec3 getIBLVolumeRefraction( vec3 n, vec3 v, float roughness, vec3 position, mat4 modelMatrix, mat4 viewMatrix, mat4 projMatrix, float ior, float thickness, vec2 transmissionSamplerSize, sampler2D transmissionSamplerMap, sampler2D transmissionDepthMap, vec2 aspectRatio ) {\n\t\t\t\tvec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, ior, modelMatrix );\n\t\t\t\tvec3 refractedRayExit = position + transmissionRay;\n\n\t\t\t\t// Project refracted vector on the framebuffer, while mapping to normalized device coordinates.\n\t\t\t\tvec4 ndcPos = projMatrix * viewMatrix *  vec4( refractedRayExit, 1.0 );\n\t\t\t\tvec2 refractionCoords = ndcPos.xy / ndcPos.w;\n\t\t\t\trefractionCoords += 1.0;\n\t\t\t\trefractionCoords /= 2.0;\n\n\t\t\t\tvec4 ndcPosUnrefracted = projMatrix * viewMatrix * vec4(position, 1.0 );\n\t\t\t\tvec2 unrefractedCoords = ndcPosUnrefracted.xy / ndcPosUnrefracted.w;\n\t\t\t\tunrefractedCoords += 1.0;\n\t\t\t\tunrefractedCoords /= 2.0;\n\n\t\t\t\t// Sample framebuffer to get pixel the refracted ray hits.\n\t\t\t\treturn getTransmissionSample( refractionCoords, roughness, ior, transmissionSamplerSize, transmissionSamplerMap, transmissionDepthMap, unrefractedCoords, aspectRatio );\n    \t\t}",[n,e]);return{transmission:new Wd("vec3 transmission(float thickness, float ior, float roughness, vec2 transmissionSamplerSize, sampler2D transmissionSamplerMap, sampler2D transmissionDepthMap, vec2 aspectRatio, vec3 normal, float mask, float alpha, out float calpha) {\n                vec3 v = vec3(0.);\n                if (isOrthographic) {\n                    v = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n                } else {\n                    v = normalize(vWPosition - cameraPosition);\n                }\n                vec3 transmission = getIBLVolumeRefraction(vWNormal, -v, roughness,  vWPosition, modelMatrix, viewMatrix, projectionMatrix, ior, thickness, transmissionSamplerSize, transmissionSamplerMap, transmissionDepthMap, aspectRatio );\n                \n\t\t\t\tfloat lalpha = alpha * mask;\n\t\t\t\tcalpha =  lalpha / clamp( lalpha + accumAlpha, 0.00001, 1.0 );\n\t\t\t\taccumAlpha += ( 1.0 - accumAlpha ) * alpha;\n\n\t\t\t\treturn transmission;\n            }",[i])}}();var pf=(t=>(t.NOISE="noise",t.MAP="map",t))(pf||{}),ff=class extends Ud{constructor(t,e,r,n,i,a,o,s,l,h,c){super("v3"),this.displacementTypeIndex=new Cp(0),this.nodeType="VertexDisplacement",this.intensity=t,this.movementOrTexture=e,"map"===Object.values(pf)[this.displacementTypeIndex.value]&&(this.mat=new Ep(this.movementOrTexture.value.matrix)),this.cropOrOffset=r,this.scale=h,this.noiseFunctionIndex=c,this.voronoiStyle=n,this.smoothness=i,this.seed=a,this.highCut=o,this.lowCut=s,this.quality=l}generate(t,e){if(t.isShader("vertex")){t.define("USE_LAYER_DISPLACE");let r,n=[];switch(n.push("displaced_position"),n.push("displaced_normal"),Object.values(pf)[this.displacementTypeIndex.value]){case"map":r=t.include(ff.Nodes.map),n.push(this.movementOrTexture.getTexture(t,"t")),n.push("uv"),n.push(this.cropOrOffset.build(t,"f")),this.mat&&n.push(this.mat.build(t,"mat3"));break;case"noise":{let e=Object.values(Jp)[this.noiseFunctionIndex.value],i=new Wd("vec3 orthogonal(vec3 v) {\n\t\t\t\t\t\t\treturn normalize(abs(v.x) > abs(v.z) ? vec3(-v.y, v.x, 0.0) : vec3(0.0, -v.z, v.y));\n\t\t\t\t\t\t}"),a="voronoi"==e?"\n\t\t\t\t\tfloat v = ".concat(e,"((p + offset) * scale * 0.001 + neighbour_offset + (movement * 0.1), voronoiStyle, smoothness, seed, quality);\n\t\t\t\t\tv = remap(v, lowCut, highCut, 0.0, 1.0);\n\t\t\t\t\tv = smax(v, 0.0, smoothness * 0.25);\n\t\t\t\t\tv = smin(v, 1.0, smoothness * 0.25);\n\n\t\t\t\t\treturn p + n * v * intensity;\n\t\t\t\t\t"):"\n\t\t\t\t\treturn p + n * ".concat(e,"((p + offset) * scale * 0.001 + neighbour_offset + (movement * 0.1)) * intensity;\n\t\t\t\t\t"),o=new Wd("vec3 distorted(vec3 p, vec3 n, float scale, float intensity, vec3 offset, float neighbour_offset, float movement, int voronoiStyle, float smoothness, float seed, float highCut, float lowCut, int quality) {\n\t\t\t\t\t\t\t".concat(a,"\n\t\t\t\t\t\t}"),[$p.simplex,$p.simplexFractal,$p.simplexAshima,$p.fbm,$p.perlin,$p.voronoi]),s=new Wd("vec3 vertexDisplacementNoise(vec3 position, vec3 normal, float scale, vec3 offset, float movement, int voronoiStyle, float smoothness, float seed, float highCut, float lowCut, int quality, float intensity, out vec3 displaced_normal) {\n\t\t\t\t\t\t\tvec3 displaced_position = distorted(position, normal, scale, intensity, offset, neighbor_offset, movement, voronoiStyle, smoothness, seed, highCut, lowCut, quality);\n\t\t\t\t\t\t\tvec3 tangent1 = orthogonal(normal);\n\t\t\t\t\t\t\tvec3 tangent2 = normalize(cross(normal, tangent1));\n\n                            // TODO(Max): The distance to the neighbors was originally scaled by 0.1.\n                            // This caused some small oval/circular visual artifacts in the lighting.\n                            // For now, simply using neighbors further away betters the problem,\n                            // but we should figure out the underlying cause when we have some time.\n                            // Maybe its related to how we calculate the tangent and bitangent?\n\t\t\t\t\t\t\tvec3 nearby1 = position + tangent1;\n\t\t\t\t\t\t\tvec3 nearby2 = position + tangent2;\n\t\t\t\t\t\t\tvec3 distorted1 = distorted(nearby1, normal, scale, intensity, offset, neighbor_offset, movement, voronoiStyle, smoothness, seed, highCut, lowCut, quality);\n\t\t\t\t\t\t\tvec3 distorted2 = distorted(nearby2, normal, scale, intensity, offset, neighbor_offset, movement, voronoiStyle, smoothness, seed, highCut, lowCut, quality);\n\t\t\t\t\t\t\tdisplaced_normal = normalize(cross(distorted1 - displaced_position, distorted2 - displaced_position));\n\t\t\t\t\t\t\treturn displaced_position;\n\t\t\t\t\t\t}",[o,i]);r=t.include(s),n.push(this.scale.build(t,"f")),n.push(this.cropOrOffset.build(t,"v3")),n.push(this.movementOrTexture.build(t,"f")),n.push(this.voronoiStyle.build(t,"i")),n.push(this.smoothness.build(t,"f")),n.push(this.seed.build(t,"f")),n.push(this.highCut.build(t,"f")),n.push(this.lowCut.build(t,"f")),n.push(this.quality.build(t,"i"));break}}return n.push(this.intensity.build(t,"f")),n.push("displaced_normal"),t.format(r+"("+n.join(",")+")",this.getType(t),e)}return console.warn("VertexDisplacementNode is not compatible with "+t.shader+" shader."),t.format("vec3( 0.0 )",this.getType(t),e)}},mf=ff;mf.Nodes=function(){let t=new Wd("vec3 orthogonal(vec3 v) {\n\t\t\t\treturn normalize(abs(v.x) > abs(v.z) ? vec3(-v.y, v.x, 0.0) : vec3(0.0, -v.z, v.y));\n\t\t\t}"),e=new Wd("float displacementMapTexture(sampler2D tex, float crop, vec2 uv, mat3 mat, vec2 offset) {\n\t\t\t\tvec2 uvs = (mat * vec3(uv * 2.0 - 1.0, 1.0) / 2.0 + 0.5).xy + offset;\n\t\t\t\tvec4 tmp = texture2D(tex, uvs);\n\t\t\t\tvec3 col = tmp.rgb;\n\t\t\t\tif (crop > 0.5) {\n\t\t\t\t\tif ( uvs.x < 0.0 || uvs.x > 1.0 || uvs.y < 0.0 || uvs.y > 1.0 )  {\n\t\t\t\t\t\treturn 0.0;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn col.r;\n\t\t\t}");return{map:new Wd("vec3 vertexDisplacementMap(vec3 position, vec3 normal, sampler2D tex, vec2 uv, float crop, mat3 mat, float intensity, out vec3 displaced_normal) {\n\t\t\t\tvec3 displaced_position = position + normal * displacementMapTexture(tex, crop, uv, mat, vec2(0.0)) * intensity;\n\t\t\t\tvec3 tangent1 = normalize(orthogonal(normal));\n\t\t\t\tvec3 tangent2 = normalize(cross(normal, tangent1));\n\t\t\t\tvec3 nearby1 = position + tangent1 * 0.1;\n\t\t\t\tvec3 nearby2 = position + tangent2 * 0.1;\n\t\t\t\tvec3 distorted1 = nearby1 + normal * displacementMapTexture(tex, crop, uv, mat, vec2(neighbor_offset)) * intensity;\n\t\t\t\tvec3 distorted2 = nearby2 + normal * displacementMapTexture(tex, crop, uv, mat, vec2(neighbor_offset)) * intensity;\n\t\t\t\tdisplaced_normal = normalize(cross(distorted1 - displaced_position, distorted2 - displaced_position));\n\t\t\t\treturn displaced_position;\n\t\t\t}",[t,e])}}();var vf={normalRenderTarget:new np,normalRenderTargetDepth:new np,transmissionRenderTarget:new np,aspectRatio:new Nd,transmissionSize:new Nd(2048,2048),transmissionRenderTargetDepth:new np,aoRenderTarget:new np,aoEnabled:new Op,pixelRatioNode:new ip(1),resolution:new Nd,penumbraSize:new Dp(5,.5),frameIndex:new Cp(0),transmissionLod:new Cp(2)};for(let fy of Object.values(vf))fy.isRenderGlobal=!0;var gf,yf=class extends kd{constructor(){super("basic"),this.nodeType="Basic",this.color=new Mp(hs),this.shadingAlpha=new ip(1),this.shadingBlend=new Cp(0),this.previousModelViewMatrix=new Ip,this.previouseProjectionMatrix=new Ip}get category(){return"phong"}generate(t){let e;if(t.isShader("vertex")){let r=this.position?this.position.analyzeAndFlow(t,"v3",{cache:"position"}):void 0;t.mergeUniform({frameIndex:vf.frameIndex}),t.mergeUniform({resolution:vf.resolution}),t.mergeUniform({previousModelViewMatrix:this.previousModelViewMatrix}),t.mergeUniform({previousProjectionMatrix:this.previouseProjectionMatrix}),t.mergeUniform(n.UniformsUtils.merge([n.UniformsLib.fog])),t.addParsCode(["varying vec3 vViewPosition;","varying vec3 vWPosition;","#include <fog_pars_vertex>","#include <normal_pars_vertex>"].join("\n"));let i=["#include <beginnormal_vertex>","\n\t\t\t\t#if !defined( USE_LAYER_DISPLACE )\n\t\t\t\t\t#include <defaultnormal_vertex>\n\t\t\t\t#endif\n\n\t\t\t\tvec3 displaced_position = position;\n\t\t\t\tvec3 displaced_normal = normal;\n\n\t\t\t\t#if defined( USE_LAYER_DISPLACE )\n\t\t\t\t\tvec3 transformed;\n\t\t\t\t\tvec3 transformedNormal;\n\t\t\t\t#endif\n\t\t\t\t","#include <normal_vertex>","\n\t\t\t\t#if !defined( USE_LAYER_DISPLACE )\n\t\t\t\t\t#include <begin_vertex>\n\t\t\t\t#endif /* !USE_LAYER_DISPLACE */\n\t\t\t\t"];r&&i.push(r.code,r.result?"displaced_position = "+r.result+";":""),i.push("transformed = displaced_position;","transformedNormal = normalMatrix * displaced_normal;","#ifndef FLAT_SHADED","\tvNormal = transformedNormal;","#endif"),i.push("#include <project_vertex>","#include <fog_vertex>","#include <clipping_planes_vertex>","\tvViewPosition = - mvPosition.xyz;","#include <worldpos_vertex>"),i.push("vWPosition = ( modelMatrix * vec4( transformed, 1.0 ) ).xyz;"),e=i.join("\n")}else{void 0===this.color&&(this.color=new Mp(hs)),this.color.analyze(t,{slot:"color"}),this.alpha&&this.alpha.analyze(t),this.afterColor&&this.afterColor.analyze(t,{slot:"afterColor"});let r=this.color.flow(t,"c",{slot:"color"}),n=this.alpha?this.alpha.flow(t,"f"):void 0,i=this.alphaOverride?this.alphaOverride.flow(t,"f"):void 0,a=this.afterColor?this.afterColor.flow(t,"c",{slot:"afterColor"}):void 0;t.requires.transparent=void 0!==n,t.addParsCode(["varying vec3 vWPosition;","#include <fog_pars_fragment>","#include <dithering_pars_fragment>","varying vec3 vViewPosition;","#include <normal_pars_fragment>"].join("\n"));let o=["#include <normal_fragment_begin>",r.code];n&&o.push(n.code,"#ifdef ALPHATEST"," if ( "+n.result+" <= ALPHATEST ) discard;","#endif"),a?o.push(a.code,"vec3 outgoingLight = ".concat(r.result,";"),"vec3 finalColor = spe_blend(outgoingLight, ".concat(a.result,", 1.0, SPE_BLENDING_NORMAL);")):o.push("vec3 finalColor = ".concat(r.result,";"));let s="1.0";this.mask&&(this.mask.analyze(t),s="luminance(".concat(this.mask.flow(t,"v3").result,")")),n?o.push("gl_FragColor = vec4( finalColor, accumAlpha * ".concat(n.result," * ").concat(s," );")):o.push("gl_FragColor = vec4("+r.result+", 1.0 );"),i&&o.push("gl_FragColor.a *= ".concat(i.result,";")),o.push("#include <fog_fragment>","#include <dithering_fragment>"),e=o.join("\n")}return e}},bf=class extends kd{constructor(){super("lambert"),this.nodeType="Lambert",this.color=new Mp(hs),this.emissive=new Mp(0),this.emissiveIntensity=new ip(1),this.previousModelViewMatrix=new Ip,this.previouseProjectionMatrix=new Ip,this.shadingAlpha=new ip(1),this.shadingBlend=new Cp(0),this.occlusion=new Op(!0)}get category(){return"lambert"}build(t){let e;if(t.define("LAMBERT"),t.requires.lights=!0,t.extensions.derivatives=!0,t.isShader("vertex")){let r=this.position?this.position.analyzeAndFlow(t,"v3",{cache:"position"}):void 0;t.mergeUniform({frameIndex:vf.frameIndex}),t.mergeUniform({resolution:vf.resolution}),t.mergeUniform({previousModelViewMatrix:this.previousModelViewMatrix}),t.mergeUniform({previousProjectionMatrix:this.previouseProjectionMatrix}),t.mergeUniform(n.UniformsUtils.merge([n.UniformsLib.fog,n.UniformsLib.lights])),t.addParsCode(["varying vec3 vViewPosition;","varying vec3 vWPosition;","varying vec3 vLightFront;","varying vec3 vIndirectFront;","#ifndef DOUBLE_SIDED","   #define DOUBLE_SIDED","#endif","#ifdef DOUBLE_SIDED","\tvarying vec3 vLightBack;","\tvarying vec3 vIndirectBack;","#endif","#include <bsdfs>","#include <lights_pars_begin>","#include <color_pars_vertex>","#include <fog_pars_vertex>","#include <normal_pars_vertex>","#include <shadowmap_pars_vertex>","#include <clipping_planes_pars_vertex>"].join("\n"));let i=["#include <beginnormal_vertex>","\n\t\t\t\t#ifndef USE_LAYER_DISPLACE\n\t\t\t\t\t#include <defaultnormal_vertex>\n\t\t\t\t#endif\n\n\t\t\t\tvec3 displaced_position = position;\n\t\t\t\tvec3 displaced_normal = normal;\n\n\t\t\t\t#ifdef USE_LAYER_DISPLACE\n\t\t\t\t\tvec3 transformed;\n\t\t\t\t\tvec3 transformedNormal;\n\t\t\t\t#endif\n\t\t\t\t","#include <normal_vertex>","\n\t\t\t\t#ifndef USE_LAYER_DISPLACE\n\t\t\t\t\t#include <begin_vertex>\n\t\t\t\t#endif\n\t\t\t\t"];r&&i.push(r.code,r.result?"displaced_position = "+r.result+";":""),i.push("transformed = displaced_position;","transformedNormal = normalMatrix * displaced_normal;","#ifndef FLAT_SHADED","    vNormal = transformedNormal;","#endif"),i.push("\t#include <project_vertex>","\t#include <clipping_planes_vertex>","\tvViewPosition = - mvPosition.xyz;","\t#include <worldpos_vertex>","\n\t\t\t\t\tvec3 diffuse = vec3( 1.0 );\n\t\t\t\t\tGeometricContext geometry;\n\t\t\t\t\tgeometry.position = mvPosition.xyz;\n\t\t\t\t\tgeometry.normal = normalize( transformedNormal );\n\t\t\t\t\tgeometry.viewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( -mvPosition.xyz );\n\t\t\t\t"),i.push("\n\t\t\t\t\tGeometricContext backGeometry;\n\t\t\t\t\tbackGeometry.position = geometry.position;\n\t\t\t\t\tbackGeometry.normal = -geometry.normal;\n\t\t\t\t\tbackGeometry.viewDir = geometry.viewDir;\n\t\t\t\t\tvLightFront = vec3( 0.0 );\n\t\t\t\t\tvIndirectFront = vec3( 0.0 );\n\t\t\t\t\t#ifdef DOUBLE_SIDED\n\t\t\t\t\t\tvLightBack = vec3( 0.0 );\n\t\t\t\t\t\tvIndirectBack = vec3( 0.0 );\n\t\t\t\t\t#endif\n\t\t\t\t\tIncidentLight directLight;\n\t\t\t\t\tfloat dotNL;\n\t\t\t\t\tvec3 directLightColor_Diffuse;\n\t\t\t\t\tvIndirectFront += getAmbientLightIrradiance( ambientLightColor );\n\t\t\t\t\tvIndirectFront += getLightProbeIrradiance( lightProbe, geometry.normal );\n\t\t\t\t\t#ifdef DOUBLE_SIDED\n\t\t\t\t\t\tvIndirectBack += getAmbientLightIrradiance( ambientLightColor );\n\t\t\t\t\t\tvIndirectBack += getLightProbeIrradiance( lightProbe, backGeometry.normal );\n\t\t\t\t\t#endif\n\t\t\t\t\t#if NUM_POINT_LIGHTS > 0\n\t\t\t\t\t\t#pragma unroll_loop_start\n\t\t\t\t\t\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\t\t\t\t\t\tgetPointLightInfo( pointLights[ i ], geometry, directLight );\n\t\t\t\t\t\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\t\t\t\t\t\tdirectLightColor_Diffuse = directLight.color;\n\t\t\t\t\t\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t\t\t\t\t\t#ifdef DOUBLE_SIDED\n\t\t\t\t\t\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t}\n\t\t\t\t\t\t#pragma unroll_loop_end\n\t\t\t\t\t#endif\n\t\t\t\t\t#if NUM_SPOT_LIGHTS > 0\n\t\t\t\t\t\t#pragma unroll_loop_start\n\t\t\t\t\t\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\t\t\t\t\t\tgetSpotLightInfo( spotLights[ i ], geometry, directLight );\n\t\t\t\t\t\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\t\t\t\t\t\tdirectLightColor_Diffuse = directLight.color;\n\t\t\t\t\t\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t\t\t\t\t\t#ifdef DOUBLE_SIDED\n\t\t\t\t\t\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t}\n\t\t\t\t\t\t#pragma unroll_loop_end\n\t\t\t\t\t#endif\n\t\t\t\t\t#if NUM_DIR_LIGHTS > 0\n\t\t\t\t\t\t#pragma unroll_loop_start\n\t\t\t\t\t\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\t\t\t\t\t\tgetDirectionalLightInfo( directionalLights[ i ], geometry, directLight );\n\t\t\t\t\t\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\t\t\t\t\t\tdirectLightColor_Diffuse = directLight.color;\n\t\t\t\t\t\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t\t\t\t\t\t#ifdef DOUBLE_SIDED\n\t\t\t\t\t\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t}\n\t\t\t\t\t\t#pragma unroll_loop_end\n\t\t\t\t\t#endif\n\t\t\t\t\t#if NUM_HEMI_LIGHTS > 0\n\t\t\t\t\t\t#pragma unroll_loop_start\n\t\t\t\t\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\t\t\t\t\t\tvIndirectFront += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry.normal );\n\t\t\t\t\t\t\t#ifdef DOUBLE_SIDED\n\t\t\t\t\t\t\t\tvIndirectBack += getHemisphereLightIrradiance( hemisphereLights[ i ], backGeometry.normal );\n\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t}\n\t\t\t\t\t\t#pragma unroll_loop_end\n\t\t\t\t\t#endif\n\t\t\t\t","\t#include <shadowmap_vertex>","\t#include <fog_vertex>"),i.push("vWPosition = ( modelMatrix * vec4( transformed, 1.0 ) ).xyz;"),e=i.join("\n")}else{t.mergeUniform({penumbraSize:vf.penumbraSize}),t.mergeUniform({frameIndex:vf.frameIndex}),t.mergeUniform({aoMap:vf.aoRenderTarget}),t.mergeUniform({aoEnabled:vf.aoEnabled}),void 0===this.color&&(this.color=new Mp(hs)),this.color.analyze(t,{slot:"color"}),this.shadingAlpha.analyze(t),this.shadingBlend.analyze(t),this.afterColor&&this.afterColor.analyze(t,{slot:"afterColor"}),this.alpha&&this.alpha.analyze(t);let r=this.color.flow(t,"c",{slot:"color"}),n=this.emissive.flow(t,"c",{slot:"emissive"}),i=this.emissiveIntensity.flow(t,"f",{slot:"emissive"}),a=this.occlusion.flow(t,"b",{slot:"occlusion"}),o=this.shadingAlpha.flow(t,"f"),s=this.shadingBlend.flow(t,"i"),l=this.afterColor?this.afterColor.flow(t,"c",{slot:"afterColor"}):void 0,h=this.alpha?this.alpha.flow(t,"f"):void 0,c=this.alphaOverride?this.alphaOverride.flow(t,"f"):void 0;t.requires.transparent=void 0!==h,t.addParsCode(["uniform float penumbraSize[".concat(5,"];"),"uniform sampler2D aoMap;","uniform bool aoEnabled;","varying vec3 vViewPosition;","varying vec3 vWPosition;","varying vec3 vLightFront;","varying vec3 vIndirectFront;","#ifndef DOUBLE_SIDED","   #define DOUBLE_SIDED","#endif","#include <normal_pars_fragment>","#ifdef DOUBLE_SIDED","\tvarying vec3 vLightBack;","\tvarying vec3 vIndirectBack;","#endif","#include <bsdfs>","#include <lights_pars_begin>","#include <fog_pars_fragment>","#include <shadowmap_pars_fragment>","#include <shadowmask_pars_fragment>","#include <clipping_planes_pars_fragment>","#include <dithering_pars_fragment>"].join("\n"));let u=["#include <normal_fragment_begin>","\n\t\t\t\t// NOTE: gl_FrontFacing alternative using face normal estimation.\n\t\t\t\tvec3 viewdx = dFdx(vViewPosition);\n\t\t\t\tvec3 viewdy = dFdy(vViewPosition);\n\t\t\t\tvec3 faceNormal = normalize(cross(viewdx, viewdy));\n\t\t\t\tbool isFrontFacing = (dot(normal, faceNormal) >= 0.0);\n\t\t\t\t","#include <clipping_planes_fragment>"];u.push(r.code,"vec3 diffuseColor = "+r.result+";","ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );"),h&&u.push(h.code,"#ifdef ALPHATEST","if ( "+h.result+" <= ALPHATEST ) discard;","#endif"),u.push("#ifdef DOUBLE_SIDED","\treflectedLight.indirectDiffuse += ( isFrontFacing ) ? vIndirectFront : vIndirectBack;","#else","\treflectedLight.indirectDiffuse += vIndirectFront;","#endif","#include <lightmap_fragment>","reflectedLight.indirectDiffuse *= BRDF_Lambert( diffuseColor.rgb );","#ifdef DOUBLE_SIDED","\treflectedLight.directDiffuse = ( isFrontFacing ) ? vLightFront : vLightBack;","#else","\treflectedLight.directDiffuse = vLightFront;","#endif","reflectedLight.directDiffuse *= BRDF_Lambert( diffuseColor.rgb ) * getShadowMask();"),n&&u.push(n.code,"reflectedLight.directDiffuse += "+n.result+" * "+i.result+";"),u.push("vec3 ao = aoEnabled && "+a.result+" ? tex2D(aoMap, gl_FragCoord.xy / resolution).rgb : vec3(1.0);","vec3 outgoingLight = (reflectedLight.directDiffuse + reflectedLight.indirectDiffuse) ;");let d="1.0";this.mask&&(this.mask.analyze(t),d="luminance(".concat(this.mask.flow(t,"v3").result,")")),u.push("\n\t\t\t\tif (outgoingLight != diffuseColor) {\n\t\t\t\t\tfloat lightAccu = clamp( length( reflectedLight.directSpecular + reflectedLight.indirectSpecular ), 0.0, 1.0 );\n\t\t\t\t\taccumAlpha += ( 1.0 - accumAlpha ) * ".concat(o.result," * ").concat(d," * lightAccu;\n\t\t\t\t\toutgoingLight = spe_blend( diffuseColor, outgoingLight, ").concat(o.result," * ").concat(d,", ").concat(s.result," );\n\n\t\t\t\t\toutgoingLight *= ao;\n\t\t\t\t}\n\t\t\t\t")),l&&u.push(l.code,"outgoingLight = spe_blend(outgoingLight, ".concat(l.result,", 1.0, SPE_BLENDING_NORMAL);")),h?u.push("gl_FragColor = vec4( outgoingLight, accumAlpha * ".concat(h.result," );")):u.push("gl_FragColor = vec4( outgoingLight, 1.0 );"),c&&u.push("gl_FragColor.a *= ".concat(c.result,";")),u.push("#include <encodings_fragment>","#include <fog_fragment>","#include <dithering_fragment>"),e=u.join("\n")}return e}},xf={dHdxy:new Wd("vec2 dHdxy(sampler2D bumpMap, vec2 bumpMapUv, float bumpScale) {\n\n            // Gradient of UVs w.r.t. X coordinate (in screen-space)\n            vec2 dSTdx = dFdx(bumpMapUv);\n\n            // Gradient of UVs w.r.t. Y coordinate (in screen-space)\n            vec2 dSTdy = dFdy(bumpMapUv);\n            \n            // Forward differencing\n            float Hll = bumpScale * luminance(texture(bumpMap, bumpMapUv).rgb);\n            float dBx = bumpScale * luminance(texture(bumpMap, bumpMapUv + dSTdx).rgb) - Hll;\n            float dBy = bumpScale * luminance(texture(bumpMap, bumpMapUv + dSTdy).rgb) - Hll;\n            \n            return vec2( dBx, dBy );\n        }"),perturbNormalArb:new Wd("vec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy, float faceDirection ) {\n            vec3 vSigmaX = dFdx( surf_pos.xyz );\n            vec3 vSigmaY = dFdy( surf_pos.xyz );\n            vec3 vN = surf_norm; // normalized\n            \n            vN = normalize(vN);\n\n            vec3 R1 = cross( vSigmaY, vN );\n            vec3 R2 = cross( vN, vSigmaX );\n\n            R1 = normalize(R1);\n            R2 = normalize(R2);\n    \n            float fDet = dot( vSigmaX, R1 ) * faceDirection;\n    \n            vec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n            return normalize( abs( fDet ) * vN - vGrad );\n        }")},wf=class extends kd{constructor(){super("phong"),this.nodeType="Phong",this.color=new Mp(hs),this.specular=new Mp(1118481),this.shininess=new ip(30),this.previousModelViewMatrix=new Ip,this.previouseProjectionMatrix=new Ip,this.shadingAlpha=new ip(1),this.shadingBlend=new Cp(0),this.occlusion=new Op(!0)}get category(){return"phong"}build(t){let e;if(t.define("PHONG"),t.requires.lights=!0,t.extensions.derivatives=!0,t.isShader("vertex")){let r=this.position?this.position.analyzeAndFlow(t,"v3",{cache:"position"}):void 0;t.mergeUniform({frameIndex:vf.frameIndex}),t.mergeUniform({resolution:vf.resolution}),t.mergeUniform({previousModelViewMatrix:this.previousModelViewMatrix}),t.mergeUniform({previousProjectionMatrix:this.previouseProjectionMatrix}),t.mergeUniform(n.UniformsUtils.merge([n.UniformsLib.fog,n.UniformsLib.lights])),t.addParsCode(["varying vec3 vViewPosition;","varying vec3 vWPosition;","#include <fog_pars_vertex>","#include <skinning_pars_vertex>","#include <normal_pars_vertex>","#include <shadowmap_pars_vertex>","#include <clipping_planes_pars_vertex>"].join("\n"));let i=["#include <beginnormal_vertex>","\n\t\t\t\t#include <skinbase_vertex>\n\t\t\t\t#include <skinnormal_vertex>\n\t\t\t\t#ifndef USE_LAYER_DISPLACE\n\t\t\t\t\t#include <defaultnormal_vertex>\n\t\t\t\t#endif\n\n\n\t\t\t\tvec3 displaced_position = position;\n\t\t\t\tvec3 displaced_normal = objectNormal;\n\n\t\t\t\t#ifdef USE_LAYER_DISPLACE\n\t\t\t\t\tvec3 transformed;\n\t\t\t\t\tvec3 transformedNormal;\n\t\t\t\t#endif\n\t\t\t\t","#include <normal_vertex>","\n\t\t\t\t#ifndef USE_LAYER_DISPLACE\n\t\t\t\t\t#include <begin_vertex>\n\t\t\t\t#endif\n\t\t\t\t"];r&&i.push(r.code,r.result?"displaced_position = "+r.result+";":""),i.push("transformed = displaced_position;","#include <skinning_vertex>","transformedNormal = normalMatrix * displaced_normal;","#ifndef FLAT_SHADED","    vNormal = transformedNormal;","#endif"),i.push("\t#include <project_vertex>","\t#include <clipping_planes_vertex>","\tvViewPosition = - mvPosition.xyz;","\t#include <worldpos_vertex>","\t#include <shadowmap_vertex>","\t#include <fog_vertex>"),i.push("vWPosition = ( modelMatrix * vec4( transformed, 1.0 ) ).xyz;"),e=i.join("\n")}else{t.mergeUniform({penumbraSize:vf.penumbraSize}),t.mergeUniform({frameIndex:vf.frameIndex}),t.mergeUniform({aoMap:vf.aoRenderTarget}),t.mergeUniform({aoEnabled:vf.aoEnabled}),void 0===this.color&&(this.color=new Mp(hs)),this.color.analyze(t,{slot:"color"}),this.specular.analyze(t),this.shininess.analyze(t);let r=this.occlusion.flow(t,"b",{slot:"occlusion"});this.shadingAlpha.analyze(t),this.shadingBlend.analyze(t),this.afterColor&&this.afterColor.analyze(t,{slot:"afterColor"}),this.alpha&&this.alpha.analyze(t);let n=this.color.flow(t,"c",{slot:"color"}),i=this.specular.flow(t,"c"),a=this.shininess.flow(t,"f"),o=this.shadingAlpha.flow(t,"f"),s=this.shadingBlend.flow(t,"i"),l=this.afterColor?this.afterColor.flow(t,"c",{slot:"afterColor"}):void 0,h=this.alpha?this.alpha.flow(t,"f"):void 0,c=this.alphaOverride?this.alphaOverride.flow(t,"f"):void 0;t.requires.transparent=void 0!==h,t.addParsCode(["varying vec3 vWPosition;","uniform vec3 emissive;","uniform float penumbraSize[".concat(5,"];"),"uniform sampler2D aoMap;","uniform bool aoEnabled;","#include <normal_pars_fragment>","#include <fog_pars_fragment>","#include <bsdfs>","#include <lights_pars_begin>","#include <lights_phong_pars_fragment>","#include <shadowmap_pars_fragment>","#include <dithering_pars_fragment>"].join("\n"));let u=["#include <normal_fragment_begin>","\n\t\t\t\t// NOTE: gl_FrontFacing alternative using face normal estimation.\n\t\t\t\tvec3 viewdx = dFdx(vViewPosition);\n\t\t\t\tvec3 viewdy = dFdy(vViewPosition);\n\t\t\t\tvec3 faceNormal = normalize(cross(viewdx,viewdy));\n\t\t\t\tif (dot(normal, faceNormal) < 0.0) {\n\t\t\t\t\tnormal *= -1.0;\n\t\t\t\t}\n\t\t\t\t","\tBlinnPhongMaterial material;"];if(this.bumpMap){t.include(xf.dHdxy),t.include(xf.perturbNormalArb);let e=this.bumpMap.texture.flow(t,"t"),r=this.bumpMap.flow(t,"v3"),n=this.bumpMapIntensity?this.bumpMapIntensity.flow(t,"f").result:"1.0",i="";i=4===this.bumpMap.projection.value?"\n\t\t\t\t\tvec3 bumpNormal = vec3(0.0);\n\t\t\t\t\t{\n\t\t\t\t\t\tvec2 uv0 = g".concat(this.bumpMap.uuid.toString().replace(/-/g,""),"_writeUvs0;\n\t\t\t\t\t\tvec2 uv1 = g").concat(this.bumpMap.uuid.toString().replace(/-/g,""),"_writeUvs1;\n\t\t\t\t\t\tvec2 uv2 = g").concat(this.bumpMap.uuid.toString().replace(/-/g,""),"_writeUvs2;\n\t\t\t\t\t\tvec3 weights = g").concat(this.bumpMap.uuid.toString().replace(/-/g,""),"_triplanarWeights;\n\n\t\t\t\t\t\tvec2 grad0 = dHdxy(").concat(e.result,", uv0, ").concat(n,");\n\t\t\t\t\t\tvec3 n0 = perturbNormalArb(-vViewPosition, normal, grad0, faceDirection);\n\n\t\t\t\t\t\tvec2 grad1 = dHdxy(").concat(e.result,", uv1, ").concat(n,");\n\t\t\t\t\t\tvec3 n1 = perturbNormalArb(-vViewPosition, normal, grad1, faceDirection);\n\n\t\t\t\t\t\tvec2 grad2 = dHdxy(").concat(e.result,", uv2, ").concat(n,");\n\t\t\t\t\t\tvec3 n2 = perturbNormalArb(-vViewPosition, normal, grad2, faceDirection);\n\t\t\t\t\t\t\n\t\t\t\t\t\tbumpNormal = n0 * weights.z + n1 * weights.x + n2 * weights.y;\n\t\t\t\t\t\tbumpNormal = normalize(bumpNormal);\n\t\t\t\t\t}\n\n\t\t\t\t\tnormal = bumpNormal;\n\t\t\t\t\t"):"\n\t\t\t\t\tvec2 bumpMapCachedUv = g".concat(this.bumpMap.uuid.toString().replace(/-/g,""),"_writeUvs;\n\t\t\t\t\tvec2 grad = dHdxy(").concat(e.result,", bumpMapCachedUv, ").concat(n,");\n\t\t\t\t\tnormal = perturbNormalArb( - vViewPosition, normal, grad, faceDirection );\n\t\t\t\t\t"),u.push("// Call the Texture Layer's function once here so that it writes out its procedural UV coordinates\n\t\t\t\t\t".concat(r.result,";\n\t\t\t\t\t").concat(i,"\n\t\t\t\t\t"))}u.push(n.code,"\tvec3 diffuseColor = "+n.result+";","\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );","\tvec3 totalEmissiveRadiance = emissive;",i.code,"\tvec3 specular = "+i.result+";",a.code,"\tfloat shininess = max( 0.0001, "+a.result+" );","\tfloat specularStrength = 1.0;"),h&&u.push(h.code,"#ifdef ALPHATEST","if ( "+h.result+" <= ALPHATEST ) discard;","#endif"),u.push("material.diffuseColor = diffuseColor;"),u.push("material.specularColor = specular;","material.specularShininess = shininess;","material.specularStrength = specularStrength;","#include <lights_fragment_begin>","#include <lights_fragment_end>"),u.push("vec3 ao = aoEnabled && "+r.result+" ? tex2D(aoMap, gl_FragCoord.xy / resolution).rgb : vec3(1.0);","vec3 outgoingLight = ((reflectedLight.directDiffuse + reflectedLight.indirectDiffuse)) + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;");let d="1.0";this.mask&&(this.mask.analyze(t),d="luminance(".concat(this.mask.flow(t,"v3").result,")")),u.push("\n\t\t\t\tif (outgoingLight != diffuseColor) {\n\t\t\t\t\tfloat lightAccu = clamp( length( reflectedLight.directSpecular + reflectedLight.indirectSpecular ), 0.0, 1.0 );\n\t\t\t\t\taccumAlpha += ( 1.0 - accumAlpha ) * ".concat(o.result," * ").concat(d," * lightAccu;\n\t\t\t\t\toutgoingLight = spe_blend( diffuseColor, outgoingLight, ").concat(o.result," * ").concat(d,", ").concat(s.result," );\n\t\t\t\t\t\n\t\t\t\t\toutgoingLight *= ao;\n\t\t\t\t}\n\t\t\t\t")),l&&u.push(l.code,"outgoingLight = spe_blend(outgoingLight, ".concat(l.result,", 1.0, SPE_BLENDING_NORMAL);")),h?u.push("gl_FragColor = vec4( outgoingLight, accumAlpha * ".concat(h.result,");")):u.push("gl_FragColor = vec4( outgoingLight, 1.0 );"),c&&u.push("gl_FragColor.a *= ".concat(c.result,";")),u.push("#include <encodings_fragment>","#include <fog_fragment>","#include <dithering_fragment>"),e=u.join("\n")}return e}},_f=class extends kd{constructor(){super("standard"),this.nodeType="Standard",this.color=new Mp(hs),this.roughness=new ip(.3),this.metalness=new ip(0),this.reflectivity=new ip(.5),this.previousModelViewMatrix=new Ip,this.previouseProjectionMatrix=new Ip,this.shadingAlpha=new ip(1),this.shadingBlend=new Cp(0),this.occlusion=new Op(!0)}get category(){return"physical"}build(t){let e;if(t.define("STANDARD"),t.requires.lights=!0,t.extensions.derivatives=!0,t.extensions.shaderTextureLOD=!0,t.isShader("vertex")){let r=this.position?this.position.analyzeAndFlow(t,"v3",{cache:"position"}):void 0;t.mergeUniform({frameIndex:vf.frameIndex}),t.mergeUniform({resolution:vf.resolution}),t.mergeUniform({previousModelViewMatrix:this.previousModelViewMatrix}),t.mergeUniform({previousProjectionMatrix:this.previouseProjectionMatrix}),t.mergeUniform(n.UniformsUtils.merge([n.UniformsLib.fog,n.UniformsLib.lights])),n.UniformsLib.LTC_1&&(t.uniforms.ltc_1={value:void 0},t.uniforms.ltc_2={value:void 0}),t.addParsCode(["varying vec3 vViewPosition;","varying vec3 vWPosition;","#include <fog_pars_vertex>","#include <normal_pars_vertex>","#include <shadowmap_pars_vertex>","#include <clipping_planes_pars_vertex>"].join("\n"));let i=["#include <beginnormal_vertex>","\n\t\t\t\t#if !defined( USE_LAYER_DISPLACE )\n\t\t\t\t\t#include <defaultnormal_vertex>\n\t\t\t\t#endif\n\n\t\t\t\tvec3 displaced_position = position;\n\t\t\t\tvec3 displaced_normal = normal;\n\n\t\t\t\t#if defined( USE_LAYER_DISPLACE )\n\t\t\t\t\tvec3 transformed;\n\t\t\t\t\tvec3 transformedNormal;\n\t\t\t\t#endif\n\t\t\t\t","#include <normal_vertex>","\n\t\t\t\t#if !defined( USE_LAYER_DISPLACE )\n\t\t\t\t\t#include <begin_vertex>\n\t\t\t\t#endif /* !USE_LAYER_DISPLACE */\n\t\t\t\t"];r&&i.push(r.code,r.result?"displaced_position = "+r.result+";":""),i.push("transformed = displaced_position;","transformedNormal = normalMatrix * displaced_normal;","#ifndef FLAT_SHADED","    vNormal = transformedNormal;","#endif"),i.push("#include <project_vertex>","#include <fog_vertex>","#include <clipping_planes_vertex>","\tvViewPosition = - mvPosition.xyz;","#include <worldpos_vertex>","#include <shadowmap_vertex>"),i.push("vWPosition = ( modelMatrix * vec4( transformed, 1.0 ) ).xyz;"),e=i.join("\n")}else{t.mergeUniform({penumbraSize:vf.penumbraSize}),t.mergeUniform({frameIndex:vf.frameIndex}),t.mergeUniform({aoMap:vf.aoRenderTarget}),t.mergeUniform({aoEnabled:vf.aoEnabled});let r={gamma:!0};void 0===this.color&&(this.color=new Mp(hs)),this.color.analyze(t,{slot:"color",context:r}),this.roughness.analyze(t),this.metalness.analyze(t);let n=this.occlusion.flow(t,"b",{slot:"occlusion"});this.shadingAlpha.analyze(t),this.shadingBlend.analyze(t),this.afterColor&&this.afterColor.analyze(t,{slot:"afterColor"}),this.alpha&&this.alpha.analyze(t),this.reflectivity&&this.reflectivity.analyze(t);let i=this.color.flow(t,"c",{slot:"color",context:r}),a=this.roughness.flow(t,"f"),o=this.metalness.flow(t,"f"),s=this.shadingAlpha.flow(t,"f"),l=this.shadingBlend.flow(t,"i"),h=this.afterColor?this.afterColor.flow(t,"c",{slot:"afterColor"}):void 0,c=this.alpha?this.alpha.flow(t,"f"):void 0,u=this.alphaOverride?this.alphaOverride.flow(t,"f"):void 0,d=this.reflectivity?this.reflectivity.flow(t,"f"):void 0;t.requires.transparent=void 0!==c,t.addParsCode(["varying vec3 vViewPosition;","varying vec3 vWPosition;","uniform float penumbraSize[".concat(5,"];"),"uniform sampler2D aoMap;","uniform bool aoEnabled;","#include <normal_pars_fragment>","#include <dithering_pars_fragment>","#include <fog_pars_fragment>","#include <bsdfs>","#include <lights_pars_begin>","#include <lights_physical_pars_fragment>","#include <shadowmap_pars_fragment>"].join("\n"));let p=["#include <clipping_planes_fragment>","\t#include <normal_fragment_begin>","\n\t\t\t\t// NOTE: gl_FrontFacing alternative using face normal estimation.\n\t\t\t\tvec3 viewdx = dFdx(vViewPosition);\n\t\t\t\tvec3 viewdy = dFdy(vViewPosition);\n\t\t\t\tvec3 faceNormal = normalize(cross(viewdx,viewdy));\n\t\t\t\tif (dot(normal, faceNormal) < 0.0) {\n\t\t\t\t\tnormal *= -1.0;\n\t\t\t\t}\n\t\t\t\t","\tPhysicalMaterial material;","\tmaterial.diffuseColor = vec3( 1.0 );"];if(this.bumpMap){t.include(xf.dHdxy),t.include(xf.perturbNormalArb);let e=this.bumpMap.texture.flow(t,"t"),r=this.bumpMap.flow(t,"v3"),n=this.bumpMapIntensity?this.bumpMapIntensity.flow(t,"f").result:"1.0",i="";i=4===this.bumpMap.projection.value?"\n\t\t\t\t\tvec3 bumpNormal = vec3(0.0);\n\t\t\t\t\t{\n\t\t\t\t\t\tvec2 uv0 = g".concat(this.bumpMap.uuid.toString().replace(/-/g,""),"_writeUvs0;\n\t\t\t\t\t\tvec2 uv1 = g").concat(this.bumpMap.uuid.toString().replace(/-/g,""),"_writeUvs1;\n\t\t\t\t\t\tvec2 uv2 = g").concat(this.bumpMap.uuid.toString().replace(/-/g,""),"_writeUvs2;\n\t\t\t\t\t\tvec3 weights = g").concat(this.bumpMap.uuid.toString().replace(/-/g,""),"_triplanarWeights;\n\n\t\t\t\t\t\tvec2 grad0 = dHdxy(").concat(e.result,", uv0, ").concat(n,");\n\t\t\t\t\t\tvec3 n0 = perturbNormalArb(-vViewPosition, normal, grad0, faceDirection);\n\n\t\t\t\t\t\tvec2 grad1 = dHdxy(").concat(e.result,", uv1, ").concat(n,");\n\t\t\t\t\t\tvec3 n1 = perturbNormalArb(-vViewPosition, normal, grad1, faceDirection);\n\n\t\t\t\t\t\tvec2 grad2 = dHdxy(").concat(e.result,", uv2, ").concat(n,");\n\t\t\t\t\t\tvec3 n2 = perturbNormalArb(-vViewPosition, normal, grad2, faceDirection);\n\t\t\t\t\t\t\n\t\t\t\t\t\tbumpNormal = n0 * weights.z + n1 * weights.x + n2 * weights.y;\n\t\t\t\t\t\tbumpNormal = normalize(bumpNormal);\n\t\t\t\t\t}\n\n\t\t\t\t\tnormal = bumpNormal;\n\t\t\t\t\t"):"\n\t\t\t\t\tvec2 bumpMapCachedUv = g".concat(this.bumpMap.uuid.toString().replace(/-/g,""),"_writeUvs;\n\t\t\t\t\tvec2 grad = dHdxy(").concat(e.result,", bumpMapCachedUv, ").concat(n,");\n\t\t\t\t\tnormal = perturbNormalArb( - vViewPosition, normal, grad, faceDirection );\n\t\t\t\t\t"),p.push("// Call the Texture Layer's function once here so that it writes out its procedural UV coordinates\n\t\t\t\t\t".concat(r.result,";\n\t\t\t\t\t").concat(i,"\n\t\t\t\t\t"))}if(p.push(i.code,"\tvec3 diffuseColor = "+i.result+";","\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );",o.code,"\tfloat metalnessFactor = "+o.result+";"),this.roughnessMap){let e=this.roughnessMap.texture.flow(t,"t"),r=this.roughnessMap.flow(t,"v3"),n="";n=4===this.roughnessMap.projection.value?"\n\t\t\t\t\tfloat roughnessChange = 1.0;\n\t\t\t\t\t{\n\t\t\t\t\t\tvec2 uv0 = g".concat(this.roughnessMap.uuid.toString().replace(/-/g,""),"_writeUvs0;\n\t\t\t\t\t\tvec2 uv1 = g").concat(this.roughnessMap.uuid.toString().replace(/-/g,""),"_writeUvs1;\n\t\t\t\t\t\tvec2 uv2 = g").concat(this.roughnessMap.uuid.toString().replace(/-/g,""),"_writeUvs2;\n\t\t\t\t\t\tvec3 weights = g").concat(this.roughnessMap.uuid.toString().replace(/-/g,""),"_triplanarWeights;\n\n\t\t\t\t\t\tfloat r0 = luminance(texture(").concat(e.result,", uv0).rgb) * roughnessScale;\n\t\t\t\t\t\tfloat r1 = luminance(texture(").concat(e.result,", uv1).rgb) * roughnessScale;\n\t\t\t\t\t\tfloat r2 = luminance(texture(").concat(e.result,", uv2).rgb) * roughnessScale;\n\n\t\t\t\t\t\troughnessChange = (r0 * weights.z + r1 * weights.x + r2 * weights.y);\n\t\t\t\t\t}\n\t\t\t\t\tfloat roughnessFactor = roughnessChange * ").concat(a.result,";\n\t\t\t\t\t"):"\n\t\t\t\t\tvec2 roughnessMapCachedUv = g".concat(this.roughnessMap.uuid.toString().replace(/-/g,""),"_writeUvs;\n\n\t\t\t\t\tvec4 vals = texture(").concat(e.result,",  roughnessMapCachedUv);\n\t\t\t\t\tfloat roughnessFactor = luminance(vals.rgb) * ").concat(a.result,";\n\t\t\t\t\t"),p.push("// Call the Texture Layer's function once here so that it writes out its procedural UV coordinates\n\t\t\t\t\t".concat(r.result,";\n\n\t\t\t\t\tconst float roughnessScale = 1.0;\n\n\t\t\t\t\t").concat(n,"\n\t\t\t\t"))}else p.push(a.code,"\tfloat roughnessFactor = "+a.result+";");c&&p.push(c.code,"#ifdef ALPHATEST","\tif ( "+c.result+" <= ALPHATEST ) discard;","#endif"),p.push("vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );"),p.push("material.diffuseColor = diffuseColor * ( 1.0 - metalnessFactor );","material.roughness = max( roughnessFactor, 0.0525 );","material.roughness += geometryRoughness;","material.roughness = min( material.roughness, 1.0 );","material.roughness = clamp( roughnessFactor, 0.04, 1.0 );"),d?p.push(d.code,"material.specularColor = mix( vec3( 0.16 * pow2( "+d.result+" ) ), diffuseColor, metalnessFactor );"):p.push("material.specularColor = mix( vec3( 0.04 ), diffuseColor, metalnessFactor );"),p.push("#include <lights_fragment_begin>"),p.push("#include <lights_fragment_end>"),p.push("vec3 ao = aoEnabled && "+n.result+" ? tex2D(aoMap, gl_FragCoord.xy / resolution).rgb : vec3(1.0);","vec3 outgoingLight = ((reflectedLight.directDiffuse + reflectedLight.indirectDiffuse)) + reflectedLight.directSpecular + reflectedLight.indirectSpecular;");let f="1.0";this.mask&&(this.mask.analyze(t),f="luminance(".concat(this.mask.flow(t,"v3").result,")")),p.push("\n\t\t\t\tif (outgoingLight != diffuseColor) {\n\t\t\t\t\tfloat lightAccu = clamp( length( reflectedLight.directSpecular + reflectedLight.indirectSpecular ), 0.0, 1.0 );\n\t\t\t\t\taccumAlpha += ( 1.0 - accumAlpha ) * ".concat(s.result," * ").concat(f," * lightAccu;\n\t\t\t\t\toutgoingLight = spe_blend( diffuseColor, outgoingLight, ").concat(s.result," * ").concat(f,", ").concat(l.result," );\n\t\t\t\t\t\n\t\t\t\t\toutgoingLight *= ao;\n\t\t\t\t}\n\t\t\t\t")),h&&p.push(h.code,"outgoingLight = spe_blend(outgoingLight, ".concat(h.result,", 1.0, SPE_BLENDING_NORMAL);")),c?p.push("gl_FragColor = vec4( outgoingLight, accumAlpha * ".concat(c.result," );")):p.push("gl_FragColor = vec4( outgoingLight, 1.0 );"),u&&p.push("gl_FragColor.a *= ".concat(u.result,";")),p.push("#include <encodings_fragment>","#include <fog_fragment>","#include <dithering_fragment>"),e=p.join("\n")}return e}},Sf=class extends kd{constructor(){super("toon"),this.nodeType="Toon",this.color=new Mp(hs),this.specular=new Mp(1118481),this.shininess=new ip(30),this.previousModelViewMatrix=new Ip,this.previouseProjectionMatrix=new Ip,this.shadingAlpha=new ip(1),this.shadingBlend=new Cp(0)}get category(){return"toon"}build(t){let e;if(t.define("TOON"),t.requires.lights=!0,t.extensions.derivatives=!0,t.isShader("vertex")){let r=this.position?this.position.analyzeAndFlow(t,"v3",{cache:"position"}):void 0;t.mergeUniform({frameIndex:vf.frameIndex}),t.mergeUniform({resolution:vf.resolution}),t.mergeUniform({previousModelViewMatrix:this.previousModelViewMatrix}),t.mergeUniform({previousProjectionMatrix:this.previouseProjectionMatrix}),t.mergeUniform(n.UniformsUtils.merge([n.UniformsLib.fog,n.UniformsLib.lights])),t.addParsCode(["varying vec3 vViewPosition;","varying vec3 vWPosition;","#include <fog_pars_vertex>","#include <normal_pars_vertex>","#include <shadowmap_pars_vertex>","#include <clipping_planes_pars_vertex>"].join("\n"));let i=["#include <beginnormal_vertex>","\n\t\t\t\t#ifndef USE_LAYER_DISPLACE\n\t\t\t\t\t#include <defaultnormal_vertex>\n\t\t\t\t#endif\n\n\t\t\t\tvec3 displaced_position = position;\n\t\t\t\tvec3 displaced_normal = normal;\n\n\t\t\t\t#ifdef USE_LAYER_DISPLACE\n\t\t\t\t\tvec3 transformed;\n\t\t\t\t\tvec3 transformedNormal;\n\t\t\t\t#endif\n\t\t\t\t","#include <normal_vertex>","\n\t\t\t\t#ifndef USE_LAYER_DISPLACE\n\t\t\t\t\t#include <begin_vertex>\n\t\t\t\t#endif\n\t\t\t\t"];r&&i.push(r.code,r.result?"displaced_position = "+r.result+";":""),i.push("transformed = displaced_position;","transformedNormal = normalMatrix * displaced_normal;","#ifndef FLAT_SHADED","    vNormal = transformedNormal;","#endif"),i.push("\t#include <project_vertex>","\t#include <fog_vertex>","\t#include <clipping_planes_vertex>","\tvViewPosition = - mvPosition.xyz;","\t#include <worldpos_vertex>","\t#include <shadowmap_vertex>","\t#include <fog_vertex>"),i.push("vWPosition = ( modelMatrix * vec4( transformed, 1.0 ) ).xyz;"),e=i.join("\n")}else{t.mergeUniform({penumbraSize:vf.penumbraSize}),t.mergeUniform({frameIndex:vf.frameIndex}),t.mergeUniform({aoMap:vf.aoRenderTarget}),t.mergeUniform({aoEnabled:vf.aoEnabled}),void 0===this.color&&(this.color=new Mp(hs)),this.color.analyze(t,{slot:"color"}),this.specular.analyze(t),this.shininess.analyze(t),this.shadingAlpha.analyze(t),this.shadingBlend.analyze(t),this.afterColor&&this.afterColor.analyze(t,{slot:"afterColor"}),this.alpha&&this.alpha.analyze(t);let r=this.color.flow(t,"c",{slot:"color"}),n=this.specular.flow(t,"c"),i=this.shininess.flow(t,"f"),a=this.shadingAlpha.flow(t,"f"),o=this.shadingBlend.flow(t,"i"),s=this.afterColor?this.afterColor.flow(t,"c",{slot:"afterColor"}):void 0,l=this.alpha?this.alpha.flow(t,"f"):void 0,h=this.alphaOverride?this.alphaOverride.flow(t,"f"):void 0;t.requires.transparent=void 0!==l,t.addParsCode(["uniform float penumbraSize[".concat(5,"];"),"uniform sampler2D aoMap;","uniform bool aoEnabled;","varying vec3 vWPosition;","#include <normal_pars_fragment>","#include <gradientmap_pars_fragment>","#include <fog_pars_fragment>","#include <bsdfs>","#include <lights_pars_begin>","#include <dithering_pars_fragment>","\n\t\t\t\t\tvarying vec3 vViewPosition;\n\t\t\t\t\tstruct ToonMaterial {\n\t\t\t\t\t\tvec3\tdiffuseColor;\n\t\t\t\t\t\tvec3\tspecularColor;\n\t\t\t\t\t\tfloat\tspecularShininess;\n\t\t\t\t\t\tfloat\tspecularStrength;\n\t\t\t\t\t};\n\t\t\t\t\tvoid RE_Direct_Toon( const in IncidentLight directLight, const in GeometricContext geometry, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\t\t\t\t\t\tvec3 irradiance = getGradientIrradiance( geometry.normal, directLight.direction ) * directLight.color;\n\t\t\t\n\t\t\t\t\t\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n\t\t\t\t\t\treflectedLight.directSpecular += irradiance * BRDF_BlinnPhong( directLight.direction, geometry.viewDir, geometry.normal, material.specularColor, material.specularShininess ) * material.specularStrength;\n\t\t\t\t\t}\n\t\t\t\t\tvoid RE_IndirectDiffuse_Toon( const in vec3 irradiance, const in GeometricContext geometry, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\t\t\t\t\t\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n\t\t\t\t\t}\n\t\t\t\t\t#define RE_Direct\t\t\t\tRE_Direct_Toon\n\t\t\t\t\t#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Toon\n\t\t\t\t\t#define Material_LightProbeLOD( material )\t(0)\n\t\t\t\t\t","#include <shadowmap_pars_fragment>","#include <bumpmap_pars_fragment>","#include <normalmap_pars_fragment>"].join("\n"));let c=["#include <normal_fragment_begin>","\n\t\t\t\t// NOTE: gl_FrontFacing alternative using face normal estimation.\n\t\t\t\tvec3 viewdx = dFdx(vViewPosition);\n\t\t\t\tvec3 viewdy = dFdy(vViewPosition);\n\t\t\t\tvec3 faceNormal = normalize(cross(viewdx,viewdy));\n\t\t\t\tif (dot(normal, faceNormal) < 0.0) {\n\t\t\t\t\tnormal *= -1.0;\n\t\t\t\t}\n\t\t\t\t","\tToonMaterial material;"];if(this.bumpMap){t.include(xf.dHdxy),t.include(xf.perturbNormalArb);let e=this.bumpMap.texture.flow(t,"t"),r=this.bumpMap.flow(t,"v3"),n=this.bumpMapIntensity?this.bumpMapIntensity.flow(t,"f").result:"1.0",i="";i=4===this.bumpMap.projection.value?"\n\t\t\t\t\tvec3 bumpNormal = vec3(0.0);\n\t\t\t\t\t{\n\t\t\t\t\t\tvec2 uv0 = g".concat(this.bumpMap.uuid.toString().replace(/-/g,""),"_writeUvs0;\n\t\t\t\t\t\tvec2 uv1 = g").concat(this.bumpMap.uuid.toString().replace(/-/g,""),"_writeUvs1;\n\t\t\t\t\t\tvec2 uv2 = g").concat(this.bumpMap.uuid.toString().replace(/-/g,""),"_writeUvs2;\n\t\t\t\t\t\tvec3 weights = g").concat(this.bumpMap.uuid.toString().replace(/-/g,""),"_triplanarWeights;\n\n\t\t\t\t\t\tvec2 grad0 = dHdxy(").concat(e.result,", uv0, ").concat(n,");\n\t\t\t\t\t\tvec3 n0 = perturbNormalArb(-vViewPosition, normal, grad0, faceDirection);\n\n\t\t\t\t\t\tvec2 grad1 = dHdxy(").concat(e.result,", uv1, ").concat(n,");\n\t\t\t\t\t\tvec3 n1 = perturbNormalArb(-vViewPosition, normal, grad1, faceDirection);\n\n\t\t\t\t\t\tvec2 grad2 = dHdxy(").concat(e.result,", uv2, ").concat(n,");\n\t\t\t\t\t\tvec3 n2 = perturbNormalArb(-vViewPosition, normal, grad2, faceDirection);\n\t\t\t\t\t\t\n\t\t\t\t\t\tbumpNormal = n0 * weights.z + n1 * weights.x + n2 * weights.y;\n\t\t\t\t\t\tbumpNormal = normalize(bumpNormal);\n\t\t\t\t\t}\n\n\t\t\t\t\tnormal = bumpNormal;\n\t\t\t\t\t"):"\n\t\t\t\t\tvec2 bumpMapCachedUv = g".concat(this.bumpMap.uuid.toString().replace(/-/g,""),"_writeUvs;\n\t\t\t\t\tvec2 grad = dHdxy(").concat(e.result,", bumpMapCachedUv, ").concat(n,");\n\t\t\t\t\tnormal = perturbNormalArb( - vViewPosition, normal, grad, faceDirection );\n\t\t\t\t\t"),c.push("// Call the Texture Layer's function once here so that it writes out its procedural UV coordinates\n\t\t\t\t\t".concat(r.result,";\n\t\t\t\t\t").concat(i,"\n\t\t\t\t\t"))}c.push(r.code,"\tvec3 diffuseColor = "+r.result+";","\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );",n.code,"\tvec3 specular = "+n.result+";",i.code,"\tfloat shininess = max( 0.0001, "+i.result+" );","\tfloat specularStrength = 1.0;"),l&&c.push(l.code,"#ifdef ALPHATEST","if ( "+l.result+" <= ALPHATEST ) discard;","#endif"),c.push("material.diffuseColor = diffuseColor;"),c.push("material.specularColor = specular;","material.specularShininess = shininess;","material.specularStrength = specularStrength;","#include <lights_fragment_begin>","#include <lights_fragment_end>"),c.push("vec3 ao = aoEnabled ? tex2D(aoMap, gl_FragCoord.xy / resolution).rgb : vec3(1.0);","vec3 outgoingLight = ((reflectedLight.directDiffuse + reflectedLight.indirectDiffuse) * ao) + reflectedLight.directSpecular;");let u="1.0";this.mask&&(this.mask.analyze(t),u="luminance(".concat(this.mask.flow(t,"v3").result,")")),c.push("\n\t\t\t\tif (outgoingLight != diffuseColor) {\n\t\t\t\t\tfloat lightAccu = clamp( length( reflectedLight.directSpecular + reflectedLight.indirectSpecular ), 0.0, 1.0 );\n\t\t\t\t\taccumAlpha += ( 1.0 - accumAlpha ) * ".concat(a.result," * ").concat(u," * lightAccu;\n\t\t\t\t\toutgoingLight = spe_blend( diffuseColor, outgoingLight, ").concat(a.result," * ").concat(u,", ").concat(o.result," );\n\t\t\t\t}\n\t\t\t\t")),s&&c.push(s.code,"outgoingLight = spe_blend(outgoingLight, ".concat(s.result,", 1.0, SPE_BLENDING_NORMAL);")),l?c.push("gl_FragColor = vec4( outgoingLight, accumAlpha * ".concat(l.result," );")):c.push("gl_FragColor = vec4( outgoingLight, 1.0 );"),h&&c.push("gl_FragColor.a *= ".concat(h.result,";")),c.push("#include <encodings_fragment>","#include <fog_fragment>","#include <dithering_fragment>"),e=c.join("\n")}return e}},Af=class{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e4;this.timeout=t,this.cache=new Map,this.head={data:null,time:0,src:null,next:null,prev:null},this.tail={data:null,time:1/0,src:null,next:null,prev:null},this.hasClean=!1,this.head.next=this.tail,this.tail.prev=this.head}log(){}remove(t){let e=this.cache.get(t);e&&(this.dispose(t,e.data),this.cache.delete(t),e.prev.next=e.next,e.next.prev=e.prev)}scheduleCleanup(){this.hasClean||(this.log("scheduled cleanup"),this.hasClean=!0,setTimeout((()=>{this.hasClean=!1,this.log("cleaning");let t=Date.now(),e=this.head.next;for(;e.time<t-this.timeout;)this.dispose(e.src,e.data),this.cache.delete(e.src),e=e.next,e.prev=this.head,this.head.next=e;this.head.next!==this.tail?this.scheduleCleanup():this.log("no more cleanup")}),this.timeout+1e3))}has(t){var e;return null===(e=this.cache.get(t))||void 0===e?void 0:e.data}load(t){let e=Date.now(),r=this.cache.get(t);return void 0===r?(r={data:this.create(t),src:t,time:e,next:null,prev:null},this.cache.set(t,r)):(r.time=e,r.prev.next=r.next,r.next.prev=r.prev),r.prev=this.tail.prev,r.next=this.tail,this.tail.prev.next=r,this.tail.prev=r,this.scheduleCleanup(),r.data}},Mf=class extends Af{create(t){return URL.createObjectURL(new Blob([t]))}dispose(t,e){URL.revokeObjectURL(e)}};var Cf=class{constructor(t,e){this.data=t,this.cache=e,this.refCount=0}deref(){this.refCount,this.refCount-=1,0===this.refCount&&(this.cache.remove(this),this.dispose())}dispose(){this.refCount,0}},Of=class{constructor(){this.cache=new Map}remove(t){this.cache.delete(t.data),0}load(t){let e=this.cache.get(t);return void 0===e&&(e=this.create(t),this.cache.set(t,e)),e.refCount+=1,e}},Df=class extends Cf{constructor(t,e){super(t,e.imageHolderCache),this.data=t,this.shared=e,this.loaded=!1,this.isVideo=!1,this.isVideo="video"===t.type,this.updateSrc(t.data)}async updateSrc(t){if(typeof document>"u")return;this.disposeTextures(),this.loaded=!1;let e=()=>{this.loaded=!0;let t=[1e3,1001,1002];for(let e of t){let t=this[e];t&&(t.image=this.img,t.needsUpdate=!0)}this.shared.requestRender()};if(this.isVideo){if(this.img=document.createElement("video"),this.img.preload="auto",this.img.playsInline=!0,this.img.currentTime=.01,"string"!=typeof t){var r=new FileReader;let e;r.readAsDataURL(new Blob([t],{type:"video/mp4"})),await new Promise((t=>{r.onloadend=r=>{var n;e=null===(n=r.target)||void 0===n?void 0:n.result,t(null)}})),this.img.src=e}else this.img.src=t;this.img.onloadeddata=()=>{e()}}else this.img=new Image,this.img.src=function(t){return"string"==typeof t?t:(gf||(gf=new Mf),gf.load(t))}(t),this.img.onload=e}getTexture(t){let e=this[t];if(e)return e;{let e;return e=this.isVideo?new n.VideoTexture(this.img,void 0,t,t):new n.Texture(this.img,void 0,t,t),this.loaded&&(e.needsUpdate=!0),this[t]=e,e}}disposeTextures(){var t,e,r;null!==(t=this[1e3])&&void 0!==t&&t.dispose(),this[1e3]=void 0,null!==(e=this[1001])&&void 0!==e&&e.dispose(),this[1001]=void 0,null!==(r=this[1002])&&void 0!==r&&r.dispose(),this[1002]=void 0}dispose(){super.dispose(),this.disposeTextures()}},Pf=class extends Df{};function Tf(t,e){return e.color(t)}function zf(t,e){switch(t.type){case"fresnel":return function(t,e){let{bias:r,scale:n,intensity:i,factor:a,color:o}=t;return{...If(t,e),color:Tf(o,e),bias:r,scale:n,intensity:i,factor:a}}(t,e);case"gradient":return function(t,e){let{gradientType:r,smooth:i,colors:a,steps:o,angle:s,offset:l,morph:h}=t;return{...If(t,e),gradientType:r,smooth:i,colors:a.map((t=>new n.Vector4(t[0],t[1],t[2],t[3]))),num:a.length,steps:o,offset:new n.Vector2(...l),morph:new n.Vector2(...h),angle:s}}(t,e);case"depth":return function(t,e){let{gradientType:r,near:i,far:a,isVector:o,isWorldSpace:s,origin:l,direction:h,colors:c,steps:u,smooth:d}=t;return{...If(t,e),gradientType:r,near:i,far:a,isVector:o,isWorldSpace:s,origin:new n.Vector3(...l),direction:h?new n.Vector3(...h):new n.Vector3(1,0,0),colors:c.map((t=>void 0!==t?new n.Vector4(t[0],t[1],t[2],t[3]):new n.Vector4(0,0,0,0))),steps:u.slice(0,c.length),smooth:d}}(t,e);case"normal":return function(t,e){let{cnormal:r}=t;return{...If(t,e),cnormal:new n.Vector3(r[0],r[1],r[2])}}(t,e);case"noise":return function(t,e){return{...If(t,e),scale:t.scale,move:t.move,fA:new n.Vector2(...t.fA),fB:new n.Vector2(...t.fB),size:new n.Vector3(...t.size),distortion:new n.Vector2(...t.distortion),colorA:Tf(t.colorA,e),colorB:Tf(t.colorB,e),colorC:Tf(t.colorC,e),colorD:Tf(t.colorD,e),noiseType:t.noiseType,voronoiStyle:t.voronoiStyle,highCut:t.highCut,lowCut:t.lowCut,smoothness:t.smoothness,seed:t.seed,quality:t.quality}}(t,e);case"rainbow":return function(t,e){return{...If(t,e),filmThickness:t.filmThickness,movement:t.movement,wavelengths:new n.Vector3(...t.wavelengths),noiseStrength:t.noiseStrength,noiseScale:t.noiseScale,offset:new n.Vector3(...t.offset)}}(t,e);case"toon":return function(t,e){return{...If(t,e),positioning:t.positioning,colors:t.colors.map((t=>new n.Vector4(t[0],t[1],t[2],t[3]))),num:t.colors.length,steps:t.steps,source:new n.Vector3(...t.source),isWorldSpace:t.isWorldSpace,noiseStrength:t.noiseStrength,noiseScale:t.noiseScale,shadowColor:Tf(t.shadowColor,e),offset:new n.Vector3(...t.offset)}}(t,e);case"outline":return function(t,e){return{...If(t,e),outlineColor:Tf(t.outlineColor,e),contourColor:Tf(t.contourColor,e),outlineWidth:t.outlineWidth,contourWidth:t.contourWidth,outlineThreshold:t.outlineThreshold,contourThreshold:t.contourThreshold,outlineSmoothing:t.outlineSmoothing,contourFrequency:t.contourFrequency,contourDirection:new n.Vector3(...t.contourDirection),positionalLines:t.positionalLines,compensation:t.compensation}}(t,e);case"transmission":return function(t,e){return{...If(t,e),thickness:t.thickness,ior:t.ior,roughness:t.roughness}}(t,e);case"color":return function(t,e){return{...If(t,e),color:Tf(t.color,e)}}(t,e);case"pattern":return function(t,e){return{...If(t,e),style:t.style,projection:t.projection,axis:t.axis,blending:t.blending,offset:new n.Vector2(...t.offset),colorA:Tf(t.colorA,e),colorB:Tf(t.colorB,e),frequency:new n.Vector2(...t.frequency),size:t.size,variation:t.variation,smoothness:t.smoothness,zigzag:t.zigzag,rotation:t.rotation,vertical:new n.Vector2(...t.vertical),horizontal:new n.Vector2(...t.horizontal),sides:t.sides}}(t,e)}}function Ef(t){return{type:t.type}}function If(t,e){var r;let{alpha:n,mode:i,isMask:a}=t,o="string"==typeof n?(null!==(r=Number(e.getVariable(n)))&&void 0!==r?r:100)/100:n;return{...Ef(t),alpha:o,mode:i,isMask:a}}var Lf=class extends Fd{},Bf={noise:["noiseType"],texture:["projection","axis","side"],video:["projection","axis","side"],displace:["noiseType"],light:["roughnessMap","bumpMap"],depth:["smooth","isWorldSpace","gradientType","isVector"],pattern:["style","projection","axis"]},kf={depth:["colors"]};function Vf(t,e,r){if("isMask"===e)return!0;let n=Bf[t.type],i=kf[t.type];if(void 0!==i){let n=t.color;if(i.includes(e)){var a;let t=null===(a=n[e])||void 0===a||null===(a=a.value)||void 0===a?void 0:a.length;if(void 0!==t&&t!==r.length)return!0}}return void 0!==n&&n.includes(e)}function Uf(t,e,r){let n=r.uniforms["f".concat(r.id,"_texture")];if(!n)return!1;let i=t;if("image"in i){let t=i.image,r=e.image(t),a=n;a.image instanceof Pf||a.image.deref(),a.image=r}if("video"in i){let t=i.video,r=e.video(t),a=n;a.image instanceof Pf||a.image.deref(),a.image=r}if("wrapping"in i){n.wrap=i.wrapping}if("repeat"in i||"offset"in i){let t="mat",e=r.uniforms["f".concat(r.id,"_").concat(t)];"repeat"in i&&(e.repeat=i.repeat),"offset"in i&&(e.offset=i.offset),e.updateMatrix()}return!1}var jf=(t,e,r)=>{var n,i;return null!==(n=Math.max(0,Math.min(1,Number(null!==(i=e.getVariable("number"==typeof t?100*t:t,r))&&void 0!==i?i:100)/100)))&&void 0!==n?n:1},Nf=class{constructor(t,e,r,n,i){this.id=t,this.uuid=e,this.data=r,this.uniforms={};for(let a in n)this.uniforms["f".concat(this.id,"_").concat(a)]=n[a];for(let a in r)Hf(a,this,r,i)}get type(){return this.data.type}static create(t,e,r,i){if("light"===r.type)return Gf.createLigherLayer(t,e,r,i);if("texture"===r.type||"video"===r.type){var a,o,s,l,h,c;let u="texture"===r.type?i.image(r.texture.image):i.video(r.texture.video),d=new zp(u,r.texture.wrapping),p=new Tp(u),f=new Bp(r.texture.repeat,r.texture.offset),m=new ip(r.crop?1:0),v=new Cp(null!==(a=r.projection)&&void 0!==a?a:0),g=new Cp(null!==(o=["x","y","z"].indexOf(r.axis))&&void 0!==o?o:0),y=new Cp(null!==(s=r.side)&&void 0!==s?s:0),b=new Nd(r.size?new n.Vector2(r.size[0],r.size[1]):new n.Vector2(100,100)),x=new ip(null!==(l=r.blending)&&void 0!==l?l:0),w=new ip(jf(r.alpha,i)),_=new Cp(null!==(h=r.mode)&&void 0!==h?h:0),S=new Op(null!==(c=r.isMask)&&void 0!==c&&c),A=new Gp(d,p,m,v,g,y,b,x,f,w,_,S),M=new rp(A.calpha,"f");return new Rf(t,e,r,{texture:d,textureSize:p,crop:m,projection:v,axis:g,side:y,size:b,blending:x,mat:f,alpha:w,mode:_,isMask:S},A,_,M,S,i)}if("matcap"===r.type){var u,d;let n=i.image(r.texture.image),a=new zp(n,r.texture.wrapping),o=new ip(jf(r.alpha,i)),s=new Cp(null!==(u=r.mode)&&void 0!==u?u:0),l=new Op(null!==(d=r.isMask)&&void 0!==d&&d),h=new Zp(a,o,s,l),c=new rp(h.calpha,"f");return new Rf(t,e,r,{texture:a,alpha:o,mode:s,isMask:l},h,s,c,l,i)}if("displace"===r.type){if("noise"===r.displacementType){var p,f,m,v,g,y,b,x,w,_;let a=new Rd(new n.Vector3(...r.offset)),o=new ip(null!==(p=r.scale)&&void 0!==p?p:10),s=new ip(null!==(f=r.intensity)&&void 0!==f?f:8),l=new ip(null!==(m=r.movement)&&void 0!==m?m:1),h=new Cp(null!==(v=r.noiseType)&&void 0!==v?v:0),c=new Cp(null!==(g=r.voronoiStyle)&&void 0!==g?g:0),u=new ip(null!==(y=r.smoothness)&&void 0!==y?y:.5),d=new ip(null!==(b=r.seed)&&void 0!==b?b:0),S=new ip(null!==(x=r.highCut)&&void 0!==x?x:1),A=new ip(null!==(w=r.lowCut)&&void 0!==w?w:0),M=new Cp(null!==(_=r.quality)&&void 0!==_?_:1),C=new mf(s,l,a,c,u,d,S,A,M,o,h);return new Ff(t,e,r,{offset:a,scale:o,intensity:s,movement:l,noiseType:h,voronoiStyle:c,smoothness:u,seed:d,highCut:S,lowCut:A,quality:M},C,i)}throw new Error}return function(t,e,r,i){let a=zf(r,i);return function(t,e,r,i,a){switch(t.type){case"color":{var o;let n=new Mp(null!==(o=i.color)&&void 0!==o?o:hs),s=qf(i),l=new jp(n,s.alpha),h=new rp(l.calpha,"f");return new Rf(e,r,t,{color:n,...s},l,s.mode,h,s.isMask,a)}case"fresnel":{var s,l,h,c,u;let n=new Mp(null!==(s=i.color)&&void 0!==s?s:16777215),o=new ip(null!==(l=i.bias)&&void 0!==l?l:.1),d=new ip(null!==(h=i.scale)&&void 0!==h?h:1),p=new ip(null!==(c=i.intensity)&&void 0!==c?c:2),f=new ip(null!==(u=i.factor)&&void 0!==u?u:1),m=qf(i),v=new Wp(n,o,d,p,f,m.alpha,m.mode,m.isMask),g=new rp(v.calpha,"f");return new Rf(e,r,t,{color:n,bias:o,scale:d,intensity:p,factor:f,...m},v,m.mode,g,m.isMask,a)}case"rainbow":{var d,p,f,m,v,g;let o=new ip(null!==(d=i.filmThickness)&&void 0!==d?d:30),s=new ip(null!==(p=i.movement)&&void 0!==p?p:0),l=new Rd(null!==(f=i.wavelengths)&&void 0!==f?f:new n.Vector3(0,0,0)),h=new ip(null!==(m=i.noiseStrength)&&void 0!==m?m:0),c=new ip(null!==(v=i.noiseScale)&&void 0!==v?v:1),u=new Rd(null!==(g=i.offset)&&void 0!==g?g:new n.Vector3(0,0,0)),y=qf(i),b=new sf(o,s,l,h,c,u,y.alpha,y.isMask),x=new rp(b.calpha,"f");return new Rf(e,r,t,{filmThickness:o,movement:s,wavelengths:l,noiseStrength:h,noiseScale:c,offset:u,...y},b,y.mode,x,y.isMask,a)}case"transmission":{var y,b,x;let n=new ip(null!==(y=i.thickness)&&void 0!==y?y:10),o=new ip(null!==(b=i.ior)&&void 0!==b?b:1.5),s=new ip(null!==(x=i.roughness)&&void 0!==x?x:.5),l=vf.transmissionSize,h=vf.transmissionRenderTarget,c=vf.transmissionRenderTargetDepth,u=window.innerWidth,d=window.innerHeight,p=u>=d?new Nd(d/u,1):new Nd(1,u/d),f=qf(i),m=new df(n,o,s,l,h,c,p,f.alpha),v=new rp(m.calpha,"f");return new Rf(e,r,t,{thickness:n,ior:o,roughness:s,aspectRatio:p,...f},m,f.mode,v,f.isMask,a)}case"toon":{var w,_,S,A,M,C;let o,s,l=new Cp(null!==(w=i.positioning)&&void 0!==w?w:0);i.colors?o=new kp(i.colors.length,i.colors):(o=new kp(10,new n.Vector4(0,0,0,1)),o.value[1]=new n.Vector4(1,1,1,1)),i.steps?s=new Dp(i.steps.length,i.steps):(s=new Dp(10,1),s.value[0]=0);let h=new Rd(null!==(_=i.source)&&void 0!==_?_:new n.Vector3(0,0,0)),c=new Op(null===(S=i.isWorldSpace)||void 0===S||S),u=new ip(null!==(A=i.noiseStrength)&&void 0!==A?A:0),d=new ip(null!==(M=i.noiseScale)&&void 0!==M?M:1),p=new Gd(i.shadowColor),f=new Rd(null!==(C=i.offset)&&void 0!==C?C:new n.Vector3(0,0,0)),m=qf(i),v=new hf(l,o,s,h,c,u,d,p,f,m.alpha),g=new rp(v.calpha,"f");return new Rf(e,r,t,{positioning:l,colors:o,steps:s,source:h,isWorldSpace:c,noiseStrength:u,noiseScale:d,shadowColor:p,offset:f,...m},v,m.mode,g,m.isMask,a)}case"outline":{var O,D,P,T,z,E,I,L,B,k,V;let o=new Mp(null!==(O=i.outlineColor)&&void 0!==O?O:16777215),s=new Mp(null!==(D=i.contourColor)&&void 0!==D?D:16777215),l=new ip(null!==(P=i.outlineWidth)&&void 0!==P?P:.1),h=new ip(null!==(T=i.contourWidth)&&void 0!==T?T:.1),c=new ip(null!==(z=i.outlineThreshold)&&void 0!==z?z:.1),u=new ip(null!==(E=i.contourThreshold)&&void 0!==E?E:.1),d=new ip(null!==(I=i.outlineSmoothing)&&void 0!==I?I:.1),p=new ip(null!==(L=i.contourFrequency)&&void 0!==L?L:.1),f=new Rd(null!==(B=i.contourDirection)&&void 0!==B?B:new n.Vector3(0,1,0)),m=new Op(null!==(k=i.positionalLines)&&void 0!==k&&k),v=new Op(null===(V=i.compensation)||void 0===V||V),g=vf.normalRenderTarget,y=vf.normalRenderTargetDepth,b=vf.pixelRatioNode,x=vf.resolution,w=qf(i),_=new rf(o,s,l,h,c,u,d,p,f,m,v,x,g,y,b,w.alpha),S=new rp(_.calpha,"f");return new Rf(e,r,t,{outlineColor:o,contourColor:s,outlineWidth:l,contourWidth:h,outlineThreshold:c,contourThreshold:u,outlineSmoothing:d,contourFrequency:p,contourDirection:f,positionalLines:m,compensation:v,...w},_,w.mode,S,w.isMask,a)}case"depth":{var U,j,N,R,F,G,q,H;let o,s,l=new Cp(null!==(U=i.gradientType)&&void 0!==U?U:0),h=new Op(null!==(j=i.smooth)&&void 0!==j&&j),c=new ip(null!==(N=i.near)&&void 0!==N?N:50),u=new ip(null!==(R=i.far)&&void 0!==R?R:200),d=new ip(null!==(F=i.isVector)&&void 0!==F?F:1),p=new ip(null!==(G=i.isWorldSpace)&&void 0!==G?G:0),f=new Rd(null!==(q=i.origin)&&void 0!==q?q:new n.Vector3),m=new Rd(null!==(H=i.direction)&&void 0!==H?H:new n.Vector3);i.colors?o=new kp(i.colors.length,i.colors):(o=new kp(2,new n.Vector4(0,0,0,1)),o.value[1]=new n.Vector4(1,1,1,1)),i.steps?s=new Dp(i.steps.length,i.steps):(s=new Dp(2,1),s.value[0]=0);let v=qf(i),g=new Hp(l,h,c,u,d,p,f,m,o,s,v.alpha,v.isMask),y=new rp(g.calpha,"f");return new Rf(e,r,t,{gradientType:l,smooth:h,near:c,far:u,isVector:d,isWorldSpace:p,origin:f,direction:m,colors:o,steps:s,...v},g,v.mode,y,v.isMask,a)}case"noise":{var W,X,Y,Q,Z,K,J,$,tt,et,rt,nt,it;let o=new ip(null!==(W=i.scale)&&void 0!==W?W:1),s=new Rd(null!==(X=i.size)&&void 0!==X?X:new n.Vector3(100,100,100)),l=new ip(null!==(Y=i.move)&&void 0!==Y?Y:1),h=new Nd(null!==(Q=i.fA)&&void 0!==Q?Q:new n.Vector2(1.7,9.2)),c=new Nd(null!==(Z=i.fB)&&void 0!==Z?Z:new n.Vector2(8.3,2.8)),u=new Nd(null!==(K=i.distortion)&&void 0!==K?K:new n.Vector2(1,1)),d=new Gd(i.colorA),p=new Gd(i.colorB),f=new Gd(i.colorC),m=new Gd(i.colorD),v=new Cp(null!==(J=i.noiseType)&&void 0!==J?J:0),g=new Cp(null!==($=i.voronoiStyle)&&void 0!==$?$:0),y=new ip(null!==(tt=i.highCut)&&void 0!==tt?tt:1),b=new ip(null!==(et=i.lowCut)&&void 0!==et?et:0),x=new ip(null!==(rt=i.smoothness)&&void 0!==rt?rt:.5),w=new ip(null!==(nt=i.seed)&&void 0!==nt?nt:.5),_=new Cp(null!==(it=i.quality)&&void 0!==it?it:1),S=qf(i),A=new tf(o,s,l,h,c,u,d,p,f,m,S.alpha,v,S.isMask,g,y,b,x,w,_),M=new rp(A.calpha,"f");return new Rf(e,r,t,{scale:o,size:s,move:l,fA:h,fB:c,distortion:u,colorA:d,colorB:p,colorC:f,colorD:m,noiseType:v,...S,voronoiStyle:g,highCut:y,lowCut:b,smoothness:x,seed:w,quality:_},A,S.mode,M,S.isMask,a)}case"normal":{var at;let o=new Rd(null!==(at=i.cnormal)&&void 0!==at?at:new n.Vector3(1,1,1)),s=qf(i),l=new Rp(o,s.alpha),h=new rp(l.calpha,"f");return new Rf(e,r,t,{cnormal:o,...s},l,s.mode,h,s.isMask,a)}case"gradient":{var ot,st,lt,ht,ct;let o,s,l=new Cp(null!==(ot=i.gradientType)&&void 0!==ot?ot:0),h=new Op(null!==(st=i.smooth)&&void 0!==st&&st);i.colors?o=new kp(i.colors.length,i.colors):(o=new kp(10,new n.Vector4(0,0,0,1)),o.value[1]=new n.Vector4(1,1,1,1)),i.steps?s=new Dp(i.steps.length,i.steps):(s=new Dp(10,1),s.value[0]=0);let c=new Nd(null!==(lt=i.offset)&&void 0!==lt?lt:new n.Vector2(0,0)),u=new Nd(null!==(ht=i.morph)&&void 0!==ht?ht:new n.Vector2(0,0)),d=new ip(null!==(ct=i.angle)&&void 0!==ct?ct:0),p=qf(i),f=new Yp(l,h,o,s,c,u,d,p.alpha,p.isMask),m=new rp(f.calpha,"f");return new Rf(e,r,t,{gradientType:l,smooth:h,colors:o,steps:s,offset:c,morph:u,angle:d,...p},f,p.mode,m,p.isMask,a)}case"pattern":{var ut,dt,pt,ft,mt,vt,gt,yt,bt,xt,wt,_t,St,At;let o=new Cp(null!==(ut=i.style)&&void 0!==ut?ut:0),s=new Cp(null!==(dt=i.projection)&&void 0!==dt?dt:0),l=new Cp(null!==(pt=["x","y","z"].indexOf(i.axis))&&void 0!==pt?pt:0),h=new ip(null!==(ft=i.blending)&&void 0!==ft?ft:0),c=new Nd(null!==(mt=i.offset)&&void 0!==mt?mt:new n.Vector2(0,0)),u=new Gd(i.colorA),d=new Gd(i.colorB),p=new Nd(null!==(vt=i.frequency)&&void 0!==vt?vt:new n.Vector2(10,10)),f=new ip(null!==(gt=i.size)&&void 0!==gt?gt:.5),m=new ip(null!==(yt=i.variation)&&void 0!==yt?yt:0),v=new ip(null!==(bt=i.smoothness)&&void 0!==bt?bt:.5),g=new ip(null!==(xt=i.zigzag)&&void 0!==xt?xt:0),y=new ip(null!==(wt=i.rotation)&&void 0!==wt?wt:0),b=new Nd(null!==(_t=i.vertical)&&void 0!==_t?_t:new n.Vector2(0,1)),x=new Nd(null!==(St=i.horizontal)&&void 0!==St?St:new n.Vector2(0,1)),w=new Cp(null!==(At=i.sides)&&void 0!==At?At:6),_=qf(i),S=new af(o,s,l,h,c,u,d,p,f,m,v,g,y,b,x,w,_.alpha,_.isMask),A=new rp(S.calpha,"f");return new Rf(e,r,t,{style:o,projection:s,axis:l,blending:h,offset:c,colorA:u,colorB:d,frequency:p,size:f,variation:m,smoothness:v,zigzag:g,rotation:y,vertical:b,horizontal:x,sides:w,..._},S,_.mode,A,_.isMask,a)}default:{let n=new Mp(1,0,0,1),o=qf(i),s=new jp(n,o.alpha),l=new rp(s.calpha,"f");return new Rf(e,r,t,{color:n,...o},s,o.mode,l,o.isMask,a)}}}(r,t,e,a,i)}(t,e,r,i)}updateByOp(t,e,r){let i=t;if(void 0===i.path[0]){if(0===i.type)return"type"in i.props||"category"in i.props||"visible"in i.props?(r.scene.markNeedsUpdateRendererDirty(),!0):function(t,e,r,i){let a=!1;for(let[o,s]of Object.entries(t)){if("bumpMap"===o||"roughnessMap"===o){a=!0;continue}if(!o||void 0===s)continue;if(Hf(o,r,i,e)){"visible"===o&&"light"===r.type&&(a=!0);continue}r.visible=i.visible;let t=r.uniforms["f".concat(r.id,"_").concat(o)];if(t&&!(t instanceof Pp))switch(a=a||Vf(r,o,s),t.constructor){case Mp:if("string"==typeof s){let r=e.getColor(s);r&&(t.value=r);break}{let e=s;t.value instanceof Lf?t.value=new Fd(e.r,e.g,e.b,e.a):t.setRGBA(e);break}case Gd:if("string"==typeof s){let r=e.getColor(s);r&&(t.value=r);break}{let e=s;t.value instanceof Lf?t.value=new Fd(e.r,e.g,e.b,e.a):t.value.setRGBA(e.r,e.g,e.b,e.a);break}case Nd:{let e=s;t.value.setX(e[0]),t.value.setY(e[1]);break}case Rd:{let e=s;t.value.setX(e[0]),t.value.setY(e[1]),t.value.setZ(e[2]);break}case np:Uf(s,e,r);break;case kp:t.value=s.map((t=>new n.Vector4(...t)));break;default:t.value=s}}return a}(i.props,r.shared,this,e)}else if("texture"===i.path[0])return!("texture"in e)&&!("video"in e)||Uf(i.props,r.shared,this);return!1}dispose(){if(function(t){let e=t instanceof Nf?t.type:t;return"texture"===e||"video"===e||"displace_map"===e||"matcap"===e}(this)){let t=this.uniforms["f".concat(this.id,"_texture")];if(!t)return!1;let e=t;e.image instanceof Pf||e.image.deref()}}hasValueByKey(t){return void 0!==this.uniforms[t]}hasValue(t){return this.hasValueByKey("f".concat(this.id,"_").concat(t))}setValue(t,e){let r="f".concat(this.id,"_").concat(t);this.hasValueByKey(r)&&void 0!==e&&(this.uniforms[r].value=e)}getNode(t){let e="f".concat(this.id,"_").concat(t);if(this.hasValueByKey(e))return this.uniforms[e]}getValue(t){let e="f".concat(this.id,"_").concat(t);if(this.hasValueByKey(e))return this.uniforms[e].value}getName(t){let e=/f\d+_(.*)/.exec(t);if(e&&e.length>1)return e[1];console.log("Layer.getName: error ".concat(t))}getNames(){let t=[];for(let e in this.uniforms){let r=this.getName(e);r&&t.push(r)}return t}},Rf=class extends Nf{constructor(t,e,r,n,i,a,o,s,l){super(t,e,r,n,l),this.params=n,this.color=i,this.mode=a,this.alpha=o,this.isMask=s}},Ff=class extends Nf{constructor(t,e,r,n,i,a){super(t,e,r,n,a),this.position=i}},Gf=class extends Nf{constructor(t,e,r,n,i,a){super(t,e,r,i,a),this.node=n}static createLigherLayer(t,e,r,n){let i,a,o=new ip(jf(r.alpha,n)),s=new Cp(r.mode),l=new ip(r.bumpMapIntensity),h=new ip(jf(r.alphaOverride,n));if(r.visible)if("lambert"===r.category){var c,u;i=new bf;let t=new Mp(null!==(c=n.color(r.emissive))&&void 0!==c?c:0),e=new Op(null===(u=r.occlusion)||void 0===u||u);a={emissive:t,occlusion:e},i.emissive=t,i.occlusion=e}else if("toon"===r.category){var d,p;i=new Sf;let t=new ip(null!==(d=r.shininess)&&void 0!==d?d:30),e=new Mp(null!==(p=n.color(r.specular))&&void 0!==p?p:1118481);a={shininess:t,specular:e},i.shininess=t,i.specular=e}else if("physical"===r.category){var f,m,v,g;i=new _f;let t=new ip(null!==(f=r.roughness)&&void 0!==f?f:.3),e=new ip(null!==(m=r.metalness)&&void 0!==m?m:0),n=new ip(null!==(v=r.reflectivity)&&void 0!==v?v:.5),o=new Op(null===(g=r.occlusion)||void 0===g||g);a={roughness:t,metalness:e,reflectivity:n,occlusion:o},i.roughness=t,i.metalness=e,i.reflectivity=n,i.occlusion=o}else{var y,b,x;i=new wf;let t=new ip(null!==(y=r.shininess)&&void 0!==y?y:30),e=new Mp(void 0!==r.specular&&null!==(b=n.color(r.specular))&&void 0!==b?b:1118481),o=new Op(null===(x=r.occlusion)||void 0===x||x);a={shininess:t,specular:e,occlusion:o},i.shininess=t,i.specular=e,i.occlusion=o}else i=new yf,a={};return i.alpha=new ip(1),i.shadingAlpha=o,i.shadingBlend=s,i.bumpMapIntensity=l,i.alphaOverride=h,a.alpha=i.shadingAlpha,a.mode=i.shadingBlend,a.bumpMapIntensity=i.bumpMapIntensity,a.alphaOverride=i.alphaOverride,new Gf(t,e,r,i,a,n)}get category(){return this.node.category}};function qf(t){var e,r,n;return{alpha:new ip(null!==(e=t.alpha)&&void 0!==e?e:1),mode:new Cp(null!==(r=t.mode)&&void 0!==r?r:0),isMask:new Op(null!==(n=t.isMask)&&void 0!==n&&n)}}function Hf(t,e,r,n){if("displace"===r.type&&("intensity"===t||"visible"===t)){let t=e.uniforms["f".concat(e.id,"_intensity")];return t?(t.value=r.intensity*(r.visible?1:0),t):void 0}if("displace"!==r.type&&("alpha"===t||"visible"===t)){let i=e.uniforms["f".concat(e.id,"_alpha")];if(!i)return;if(i.value=jf(r.alpha,n)*(r.visible?1:0),"outline"===r.type&&"visible"===t){let t=e.uniforms["f".concat(e.id,"_compensation")];t&&(t.value=r.compensation&&r.visible)}return i}}function Wf(t,e){let r=0,n=t.layers.find((t=>"light"===t.data.type));if(n){let t=n.data,r=Number(e.getVariable(t.alphaOverride));if(("string"==typeof t.alphaOverride?r/100:t.alphaOverride)<1)return!0}for(let a of t.layers){if("displace"!==a.data.type&&a.data.isMask)return!0;if("displace"!==a.data.type&&"alpha"in a.data&&"light"!==a.data.type&&"fresnel"!==a.data.type&&"texture"!==a.data.type&&"matcap"!==a.data.type&&"rainbow"!==a.data.type&&"outline"!==a.data.type&&"pattern"!==a.data.type){var i;let t=a.data.visible?a.data.alpha:0;if("string"==typeof t&&(t=Math.max(0,Math.min(1,Number(null!==(i=e.getVariable(t))&&void 0!==i?i:100)/100))),1===t&&"depth"===a.data.type||"gradient"===a.data.type){for(let e of a.data.colors)if(e[3]<1){t=e[3];break}}else if(1===t&&"noise"===a.data.type){let r=e.color(a.data.colorA).a,n=e.color(a.data.colorB).a,i=e.color(a.data.colorC).a,o=e.color(a.data.colorD).a,s=Math.min(r,Math.min(n,Math.min(i,o)));s<1&&(t=s)}r+=(1-r)*t}}return r<1}var Xf=class extends n.ShaderMaterial{constructor(){super(void 0),this.flatShading=!1,this.needsJitter=!0,this.cacheKey="",this.fog=!0,this.dithering=!0,this.vertexColors=!0,this.transparent=!0}customProgramCacheKey(){return this.cacheKey}},Yf=class extends Xf{constructor(t,e,r,n){super(),this.flatShading=t,this.side=e,this.wireframe=r,this.root=n}updateAfterBuild(){let t=this.root;this.lights=t.lights,this.vertexShader=t.vertexShader,this.fragmentShader=t.fragmentShader,this.defines=t.defines,this.uniforms=t.uniforms,this.extensions=t.extensions,this.transparent=t.transparent,this.cacheKey=t.customProgramCacheKey()+"flat"+this.flatShading+this.side}onBeforeCompile(t,e){this.root.onBeforeCompile(t)}get data(){return this.root.data}get category(){return this.root.category}get hasAO(){return this.root.hasAO}getFlavor(t,e,r){return this.root.getFlavor(t,e,r)}get layers(){return this.root.layers}get fragment(){return this.root.fragment}getLayersOfType(t){return this.root.getLayersOfType(t)}getLayerByUuid(t){return this.root.getLayerByUuid(t)}updateByOp(t,e,r){this.root.updateByOp(t,e,r)}nodeMaterialDispose(){this.root.nodeMaterialDispose()}},Qf=class extends Xf{constructor(t,e){let r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];super(),this.data=t,this.allowVariableSaves=r,this.layerIdGen=0,this.flavors=[],this.masks={},this.type="NodeMaterial",this.updaters=[],this.reset0(t,e)}get nodeMaterial(){return this}getFlavor(t,e,r){let n=r?6:(t?3:0)+e;if(0===n)return this;void 0===this.flavors&&(this.flavors=[]),n-=1;let i=this.flavors[n];return void 0===i&&(i=new Yf(t,e,r,this),this.flavors[n]=i,i.flatShading=t,i.side=e,i.updateAfterBuild()),i}get fragment(){return this.lightLayer.node}get category(){return this.lightLayer.category}get hasAO(){var t,e;return null!==(t=null===(e=this.lightLayer.getNode("occlusion"))||void 0===e?void 0:e.value)&&void 0!==t&&t}reset(t,e){this.data!==t&&this.reset0(t,e)}reset0(t,e){var r,n;this.data=t;let i=null!==(r=t.layers)&&void 0!==r?r:Ds.defaultTwoLayerData("phong").layers;try{this.layers=i.map((t=>Nf.create(this.layerIdGen++,t.id,t.data,e.shared)))}catch{this.layers=[]}this.layers.reverse(),this.name=null!==(n=t.name)&&void 0!==n?n:"Untitled Material",this.onUpdate(e.shared),this.transparent=Wf(t,e.shared),this.saveVariableLocations(e)}onVariableUpdate(t,e,r){if("alphaOverride"===t[0])this.transparent=Wf(this.data,r.shared),this.lightLayer.setValue("alphaOverride",Math.max(0,Math.min(Number(e)/100,1)));else if("layer"===t[0]){let n=t[1],i=t[2];if(n&&i){let t=this.layers.find((t=>t.uuid===n));(null===t||void 0===t?void 0:t.hasValue(i))&&("alpha"===i?(this.transparent=Wf(this.data,r.shared),t.setValue(i,Math.max(0,Math.min(Number(e)/100,1)))):t.setValue(i,e))}}}saveVariableLocations(t){if(!this.allowVariableSaves)return;let e=this.data.layers.find((t=>"light"===t.data.type));e&&t.shared.getVariable(e.data.alphaOverride,["material",this.uuid,"alphaOverride"]),this.data.layers.forEach((e=>{"alpha"in e.data&&"string"==typeof e.data.alpha&&t.shared.getVariable(e.data.alpha,["material",this.uuid,"layer",e.id,"alpha"])}))}getLayersOfType(t){return this.layers.filter((e=>e.type===t))}getLayerByUuid(t){return this.layers.find((e=>e.uuid===t))}onUpdate(t){this.cacheKey=this.computeCacheKey(),this.lightLayer=this.layers.find((t=>t instanceof Gf)),void 0===this.lightLayer&&(this.lightLayer=new Gf(0,"",{...Os.defaultData("light","phong"),visible:!1},new yf,{},t)),this.dispose();for(let e of this.flavors)e&&e.dispose();this.applyTextureMaps(),this.applyMasks(),this.blendColors(),this.blendAfterColors(),this.blendPositions()}applyTextureMaps(){let t=this.layers.find((t=>t instanceof Gf));if(!t)return;let e=t.data,r=e.bumpMap,n=e.roughnessMap;t.node.bumpMap=void 0,t.node.roughnessMap=void 0;for(let i=0;i<this.layers.length;++i){let e=this.layers[i];e instanceof Rf&&e.color instanceof Gp&&(e.uuid===r&&(t.node.bumpMap=e.color),e.uuid===n&&(t.node.roughnessMap=e.color))}}updateByOp(t,e,r){if(void 0!==e?this.data=e:e=this.data,this.transparent=Wf(e,r.shared),"layers"===t.path[0]){this.data=e;let n=r.shared,i=t.path[1];if(void 0===i){if(this.layers.reverse(),4===t.type){let e=Nf.create(this.layerIdGen++,t.id,t.data,r.shared);this.layers.splice(t.localIndex,0,e),r.scene.markNeedsUpdateRendererDirty()}else if(5===t.type)this.layers.splice(t.localIndex,1)[0].dispose(),r.scene.markNeedsUpdateRendererDirty();else if(6===t.type){let e=this.layers.findIndex((e=>e.uuid===t.id)),n=this.layers[e];this.layers.splice(e,1),this.layers.splice(t.localIndex,0,n),r.scene.markNeedsUpdateRendererDirty()}this.layers.reverse(),this.onUpdate(r.shared)}else{0===t.type&&void 0!==t.props.occlusion&&r.scene.markNeedsUpdateRendererDirty();let a=this.layers.find((t=>t.uuid===i));if(a){let o,s=e.layers.data(i);if(0===t.type&&("alpha"in t.props||"alphaOverride"in t.props)&&(o="alpha"in t.props?{...t.props,alpha:jf(t.props.alpha,n,["material",this.uuid,"layer",i,"alpha"])}:{...t.props,alphaOverride:jf(t.props.alphaOverride,n,["material",this.uuid,"alphaOverride"])}),a.updateByOp({...t,...o?{props:o}:{},path:t.path.slice(2)},s,r)){let t=Nf.create(this.layerIdGen++,i,s,n);this.layers.splice(this.layers.findIndex((t=>t.uuid===i)),1,t),this.onUpdate(r.shared)}}}}else this.reset(e,r)}applyMasks(){for(let t=0;t<this.layers.length;++t){let e=this.layers[t];e instanceof Rf?e.color.mask=void 0:e instanceof Gf&&(e.node.mask=void 0)}for(let t=0;t<this.layers.length;++t){let e=this.layers[t];if(e instanceof Rf&&e.isMask.value&&e.data.visible&&t>0){let r=t-1,n=this.layers[r];n instanceof Gf?n.node.mask=new sp(e.color,e.alpha,sp.MUL):n instanceof Rf&&(n.isMask.value||(n.color.mask=new sp(e.color,e.alpha,sp.MUL)))}}}blendColors(){let t=this.layers.findIndex((t=>t instanceof Rf)),e=this.layers.findIndex((t=>t instanceof Gf));if(-1!==t&&t<e){let r=this.layers[t].color;for(let n=t+1;n<e;++n){let t=this.layers[n];if(t instanceof Rf){if(t.isMask.value)continue;r=new Vp(r,t.color,t.alpha,t.mode)}}this.fragment.color=r}else this.fragment.color=void 0}blendAfterColors(){let t=new rp("outgoingLight","f"),e=this.layers.findIndex((t=>t instanceof Gf));if(this.layers.length>e+1){for(let r=e+1;r<this.layers.length;++r){let e=this.layers[r];if(e instanceof Rf){if(e.isMask.value)continue;t=new Vp(t,e.color,e.alpha,e.mode)}}this.fragment.afterColor=t}else this.fragment.afterColor=void 0}blendPositions(){let t=this.layers.filter((t=>t instanceof Ff));if(t.length>0){let e=t[0].position;for(let r=1;r<t.length;++r)t[r]&&(e=new sp(e,t[r].position,sp.ADD),e=new sp(e,new ip(.5).setReadonly(!0),sp.MUL));this.fragment.position=e}else this.fragment.position=void 0}getDefines(){return this.defines}getUniforms(){return this.uniforms}getVertexShader(){return this.vertexShader}getFragmentShader(){return this.fragmentShader}onBeforeCompile(t){this.build(),t.defines=this.defines,t.uniforms=this.uniforms,t.vertexShader=this.vertexShader,t.fragmentShader=this.fragmentShader,t.extensionDerivatives=!0===this.extensions.derivatives,t.extensionFragDepth=!0===this.extensions.fragDepth,t.extensionDrawBuffers=!0===this.extensions.drawBuffers,t.extensionShaderTextureLOD=!0===this.extensions.shaderTextureLOD}clampUniformsForPreview(t,e){let r=(t,e,r)=>Math.min(Math.max(t,e),r);for(let n of this.layers)if("displace"===n.type){let i=r(n.uniforms["f".concat(n.id,"_intensity")].value,t,e);n.uniforms["f".concat(n.id,"_intensity")].value=i}}computeCacheKey(){let t="[";for(let{data:n}of this.data.layers)if("light"===n.type)t+='"'.concat(n.visible?n.category.toUpperCase():"Basic",'"');else{var e,r;let i=[...(null!==(e=Bf[n.type])&&void 0!==e?e:[]).map((t=>n[t])),...(null!==(r=kf[n.type])&&void 0!==r?r:[]).map((t=>{var e,r;return null!==(e=null===(r=n[t])||void 0===r?void 0:r.length)&&void 0!==e?e:0}))],a="isMask"in n&&n.isMask,o='"'.concat(n.type,"-").concat(n.visible,"-").concat(a,'"');i.length?t+="[".concat(o,', "').concat(i.join('","'),'"],'):t+=o}return t=t.slice(0,-1)+"]",t}updateFrame(t){for(let e=0;e<this.updaters.length;++e)t.updateNode(this.updaters[e])}build(){let t=new Ap;t.needsJitter=this.needsJitter,this.lights=this.lightLayer.data.visible,t.build(this.fragment,this.fragment),this.vertexShader=t.getCode("vertex"),this.fragmentShader=t.getCode("fragment"),this.defines=t.defines,this.uniforms=t.uniforms,this.extensions=t.extensions,this.updaters=t.updaters;for(let e of this.flavors)e&&e.updateAfterBuild();return this}nodeMaterialDispose(){this.layers.forEach((t=>t.dispose())),super.dispose();for(let t of this.flavors)t&&t.dispose()}assetsLoaded(){for(let t of this.layers)if(t instanceof Rf){let e=t.params.texture;if(e instanceof zp&&!e.image.loaded)return!1}return!0}getHash(){let t="{";return t+='"fragment":'+this.fragment.getHash(),t+="}",t}};Object.defineProperties(Xf.prototype,{properties:{get:function(){return this.fragment.properties}}});var Zf=class extends Qf{constructor(t,e,r){super(t,e,!1),this.uuid=r,this.allowVariableSaves=!0,this.saveVariableLocations(e)}},Kf=v(_()),Jf=new Map;function $f(t){if("string"==typeof t)return t;let e=Jf.get(t);return e||(e={url:URL.createObjectURL(new Blob([t]))},Jf.set(t,e)),e.url}var tm,em,rm=class{constructor(t){let e,{src:r,volume:n,delay:i,loop:a}=t;this._volume=1,this.delay=0,this._loop=1,this.loopsRemaining=0,this._status="stopped",this.onEnd=()=>{this.loopsRemaining===1/0?this.replay():this.loopsRemaining>1?(this.replay(),this.loopsRemaining--):(this._status="stopped",this.loopsRemaining=this._loop)},e="string"==typeof r?{src:r}:{src:$f(r),format:"wav"},this.sound=new Kf.Howl(e),this.sound.on("end",this.onEnd),this.src=r,void 0!==n&&(this.volume=n),void 0!==i&&(this.delay=i),void 0!==a&&(this.loop=a)}get status(){return this._status}get volume(){return this._volume}set volume(t){this._volume=t,this.sound.volume(t)}get loop(){return this._loop}set loop(t){this._loop=t,this.loopsRemaining=t}replay(){this.clearDelay(),this.delayTimerId=window.setTimeout((()=>{this.sound.play(),this.clearDelay()}),this.delay)}fade(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3;t?(this.sound.volume(this._volume),this.clearFade(),this.fadeTimerId=window.setTimeout((()=>{this.sound.fade(this._volume,0,e),this.clearFade()}),t)):this.sound.fade(this._volume,0,e)}on(t,e,r){this.sound.on(t,e,r)}off(t,e,r){this.sound.off(t,e,r)}play(){"playing"===this._status||this.sound.playing()||("paused"===this._status?(0===this.sound.seek()?this.replay():this.sound.play(),this._status="playing"):"stopped"===this._status&&(this.replay(),this._status="playing"))}pause(){"playing"===this._status&&(this.sound.pause(),this.clearFade(),this.clearDelay(),this._status="paused")}stop(){this.sound.stop(),this.loopsRemaining=this._loop,this.clearFade(),this.clearDelay(),this._status="stopped"}clearFade(){this.fadeTimerId&&(clearTimeout(this.fadeTimerId),delete this.fadeTimerId)}clearDelay(){this.delayTimerId&&(clearTimeout(this.delayTimerId),delete this.delayTimerId)}dispose(){this.off(),this.stop(),this.clearFade(),this.clearDelay()}},nm=class{constructor(){this.type="ShapePath",this.color=new n.Color,this.subPaths=[],this.currentPath=null}moveTo(t,e){return this.currentPath=new n.Path,this.subPaths.push(this.currentPath),this.currentPath.moveTo(t,e),this}lineTo(t,e){var r;return null!==(r=this.currentPath)&&void 0!==r&&r.lineTo(t,e),this}quadraticCurveTo(t,e,r,n){var i;return null!==(i=this.currentPath)&&void 0!==i&&i.quadraticCurveTo(t,e,r,n),this}bezierCurveTo(t,e,r,n,i,a){var o;return null!==(o=this.currentPath)&&void 0!==o&&o.bezierCurveTo(t,e,r,n,i,a),this}splineThru(t){var e;return null!==(e=this.currentPath)&&void 0!==e&&e.splineThru(t),this}toShapes(){let t=0,e=1,r=2,i=3,a=4,o=5,s=6,l={loc:t,t:0};function h(e,n,i,a){let o=e.x,s=n.x,h=i.x,u=a.x,d=e.y,p=n.y,f=i.y,m=a.y,v=(u-h)*(d-f)-(m-f)*(o-h),g=(m-f)*(s-o)-(u-h)*(p-d),y=v/g,b=((s-o)*(d-f)-(p-d)*(o-h))/g;if(0===g&&0!==v||y<=0||y>=1||b<0||b>1)return null;if(0===v&&0===g){for(let h=0;h<2;h++){if(c(0===h?i:a,e,n),l.loc===t){let t=0===h?i:a;return{x:t.x,y:t.y,t:l.t}}if(l.loc===r){return{x:+(o+l.t*(s-o)).toPrecision(10),y:+(d+l.t*(p-d)).toPrecision(10),t:l.t}}}return null}for(let r=0;r<2;r++)if(c(0===r?i:a,e,n),l.loc===t){let t=0===r?i:a;return{x:t.x,y:t.y,t:l.t}}return{x:+(o+y*(s-o)).toPrecision(10),y:+(d+y*(p-d)).toPrecision(10),t:y}}function c(n,h,c){let u,d=c.x-h.x,p=c.y-h.y,f=n.x-h.x,m=n.y-h.y,v=d*m-f*p;return n.x===h.x&&n.y===h.y?(l.loc=t,void(l.t=0)):n.x===c.x&&n.y===c.y?(l.loc=e,void(l.t=1)):void(v<-Number.EPSILON?l.loc=i:v>Number.EPSILON?l.loc=a:d*f<0||p*m<0?l.loc=o:Math.sqrt(d*d+p*p)<Math.sqrt(f*f+m*m)?l.loc=s:(u=0!==d?f/d:m/p,l.loc=r,l.t=u))}function u(t,e,r){let i=new n.Vector2;e.getCenter(i);let a=[];return r.forEach((e=>{e.boundingBox.containsPoint(i)&&function(t,e){let r=[],i=[];for(let a=1;a<t.length;a++){let o=t[a-1],s=t[a];for(let t=1;t<e.length;t++){let a=h(o,s,e[t-1],e[t]);null!==a&&void 0===r.find((t=>t.t<=a.t+Number.EPSILON&&t.t>=a.t-Number.EPSILON))&&(r.push(a),i.push(new n.Vector2(a.x,a.y)))}}return i}(t,e.points).forEach((t=>{a.push({identifier:e.identifier,isCW:e.isCW,point:t})}))})),a.sort(((t,e)=>t.point.x-e.point.x)),a}let d=0,p=999999999,f=-999999999,m=[];this.subPaths.forEach((t=>{let e=t.getPoints(),r=-999999999,i=999999999,a=-999999999,o=999999999;for(let n=0;n<e.length;n++){let t=e[n];t.y>r&&(r=t.y),t.y<i&&(i=t.y),t.x>a&&(a=t.x),t.x<o&&(o=t.x)}f<=a&&(f=a+1),p>=o&&(p=o-1),e.length&&m.push({curves:t.curves,points:e,isCW:n.ShapeUtils.isClockWise(e),identifier:d++,boundingBox:new n.Box2(new n.Vector2(o,i),new n.Vector2(a,r))})}));let v=m.map((t=>{var e;return function(t,e,r,i,a){(null==a||""===a)&&(a="nonzero");let o=new n.Vector2;t.boundingBox.getCenter(o);let s=u([new n.Vector2(r,o.y),new n.Vector2(i,o.y)],t.boundingBox,e);s.sort(((t,e)=>t.point.x-e.point.x));let l=[],h=[];s.forEach((e=>{e.identifier===t.identifier?l.push(e):h.push(e)}));let c=l[0].point.x,d=[],p=0;for(;p<h.length&&h[p].point.x<c;)d.length>0&&d[d.length-1]===h[p].identifier?d.pop():d.push(h[p].identifier),p++;if(d.push(t.identifier),"evenodd"===a){let e=d.length%2===0,r=d[d.length-2];return{identifier:t.identifier,isHole:e,for:r}}if("nonzero"===a){let r=!0,n=null,i=null;for(let t=0;t<d.length;t++){let a=d[t];e[a]&&(r?(i=e[a].isCW,r=!1,n=a):i!==e[a].isCW&&(i=e[a].isCW,r=!0))}return{identifier:t.identifier,isHole:r,for:n}}console.warn('fill-rule: "'+a+'" is currently not implemented.')}(t,m,p,f,null===(e=this.userData)||void 0===e?void 0:e.style.fillRule)})),g=[];return m.forEach((t=>{let e=v[t.identifier];if(e&&!e.isHole){let e=new n.Shape;e.curves=t.curves,v.filter((e=>(null===e||void 0===e?void 0:e.isHole)&&e.for===t.identifier)).forEach((t=>{if(t){let r=m[t.identifier],i=new n.Path;i.curves=r.curves,e.holes.push(i)}})),g.push(e)}})),g}},im=new Promise((t=>{tm=t})),am=!1;function om(){if(!am)return em||(em=async function(){let t=await r.e(749).then(r.bind(r,3749));tm(t),am=!0}(),em)}var sm=new class{async load(t,e){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:()=>{},{load:n}=await im;n(t,((t,n)=>{t||!n?r(null!==t&&void 0!==t?t:"Something went wrong"):e(n)}))}async parse(t){let{parse:e,Bidi:r}=await im;try{let n=e(t),i=new r,a=t=>n.charToGlyphIndex(t.char);return i.registerModifier("glyphIndex",null,a),i.applyFeatures(n,n.defaultRenderOptions.features),{font:n,bidi:i}}catch(Yo){console.error(Yo)}}};async function lm(t){let e,r,n=!1;if(t.url?(e=await async function(t){return await(await fetch(t)).arrayBuffer()}(t.url),r=t.url,n=t.url.startsWith("/")):t.data&&(e=t.data.buffer.slice(t.data.byteOffset,t.data.byteOffset+t.data.byteLength)),e){let t=await sm.parse(e);if(t)return{font:t.font,url:r,intercepted:n,arr:e,bidi:t.bidi}}}function hm(t,e){return e.state.glyphIndex===t||e.state.fina===t||e.state.medi===t||e.state.init===t}var cm=class{constructor(t){var e;this._arrayBuffer=new ArrayBuffer(1),this._isLoaded=!1,this._intercepted=!1,this._isUserFont=null!==(e=t.isUserFont)&&void 0!==e&&e,this._loadingPromise=lm(t).then((t=>{t&&(this._arrayBuffer=t.arr,this._url=t.url,this.font=t.font,this._intercepted=t.intercepted,this._isLoaded=!0,this._bidi=t.bidi)}))}update(t){var e;this._isLoaded=!1,this._isUserFont=null!==(e=t.isUserFont)&&void 0!==e&&e,this._loadingPromise=lm(t).then((t=>{t&&(this._arrayBuffer=t.arr,this._url=t.url,this.font=t.font,this._intercepted=t.intercepted,this._isLoaded=!0,this._bidi=t.bidi)}))}get url(){return this._url}get intercepted(){return this._intercepted}get isLoaded(){return this._isLoaded}get loadingPromise(){return this._loadingPromise}reverseLigaturesTable(t,e,r){if(!this._bidi)return[];let n=this._bidi;n.getTextGlyphs(e);let i=n.tokenizer.tokens,a=[],o=0,s=r.length===i.length;for(let l=0;l<r.length;l++){let n=r[l].index,h=String.fromCharCode(r[l].unicode),c=i[o];if(hm(n,c)||s)a.push({char:h,index:n,replacements:[c.state.glyphIndex],replacementChars:[c.char]}),o++;else{let r=c.char,i="",s=[c.state.glyphIndex],l=[],u=!1;for(;!u;)o++,i=e.charAt(o),r+=i,s.push(t.charToGlyphIndex(i)),l=t.stringToGlyphs(r),1===l.length&&l[0].index===n&&(u=!0),o>e.length&&(u=!0);a.push({char:h,index:n,replacements:s,replacementChars:Array.from(r)}),o++}}return a}generateShapes(t,e){if(!this._isLoaded)return;let r,n=this.font,i=e.fontSize/this.unitsPerEm,a=e.fontSize*e.lineHeight,o=t.map((t=>this.getTextWidth(t,e))),s=e.width,l=this.getCharWidth("\n",e),h=1===e.horizontalAlign?l:0,c=this.computeSpaceWidthForLine(t,0,e),u=this.getLineInitialOffsetX(o[0],s,e.horizontalAlign,t[0],l),d=this.getLineInitialOffsetY(a,t.length,e.height,i,e.verticalAlign),p=[],f=t.map((t=>[])),m=t.map((t=>[]));for(let y=0;y<t.length;y++){let v=t[y],b={features:{liga:!0}},x=[];try{x=n.stringToGlyphs(v,b)}catch(g){console.warn(g)}u=this.getLineInitialOffsetX(o[y],s,e.horizontalAlign,v,l);let w=[];try{w=this.reverseLigaturesTable(n,v,x)}catch(g){console.warn(g)}c=this.computeSpaceWidthForLine(t,y,e);for(let t=0;t<x.length;t++){let a=x[t],o=0===a.index?"\n":a.unicode?String.fromCharCode(a.unicode):void 0,s=w[t],l=0,v=0;0===t&&2===e.horizontalAlign&&void 0!==a.leftSideBearing&&(v=-a.leftSideBearing*i),r&&(l=n.getKerningValue(a,r)*i),u+=v+l;let g=0;if("\n"===o)g=h;else if(" "===o)g=c;else{let t=this.createPath(a,i,u,d,e);t&&(g=t.offsetX-(l+v),p.push(t.path))}if(1===s.replacements.length)m[y].push([u,d]),f[y].push(g);else{let t=s.replacements.map((t=>{var e;return(null!==(e=n.glyphs.get(t).advanceWidth)&&void 0!==e?e:0)*i})),e=t.reduce(((t,e)=>t+e),0),r=t.map((t=>t/e)),a=u;for(let n=0;n<r.length;n++){let t=g*r[n];m[y].push([a,d]),f[y].push(t),a+=t}}u+=g,r=a}d-=a}let v=[];for(let y=0,b=p.length;y<b;y++)v.push(...p[y].toShapes());return{shapes:v,charWidths:f,lineWidths:o,charCoords:m}}get isUserFont(){return this._isUserFont}get arrayBuffer(){return this._arrayBuffer}get ascender(){var t,e;return null!==(t=null===(e=this.font)||void 0===e?void 0:e.ascender)&&void 0!==t?t:0}get descender(){var t,e;return null!==(t=null===(e=this.font)||void 0===e?void 0:e.descender)&&void 0!==t?t:0}get familyName(){var t,e;return null!==(t=null===(e=this.font)||void 0===e?void 0:e.names.fontFamily)&&void 0!==t?t:""}get subfamilyName(){var t,e;return null!==(t=null===(e=this.font)||void 0===e?void 0:e.names.fontSubfamily)&&void 0!==t?t:""}get unitsPerEm(){var t,e;return null!==(t=null===(e=this.font)||void 0===e?void 0:e.unitsPerEm)&&void 0!==t?t:1}getLineInitialOffsetX(t,e,r,n,i){return(3===r||2===r)&&n.indexOf("\n")>=0&&(t-=i),3===r?.5*e-.5*t:2===r?e-t:0}getLineInitialOffsetY(t,e,r,n,i){let a=e*t,o=t-Math.abs(this.ascender-this.descender)*n,s=-this.ascender*n-o/2;return 3===i?-(r-a-s):2===i?-(.5*r-.5*a-s):s}createPath(t,e,r,i,a){var o;let s=t.getPath(r,-i,a.fontSize,{kerning:!1,letterSpacing:a.letterSpacing});if(!s)return void console.error('THREE.Font: character "'+t+'" does not exists in font family '+this.familyName+".");let l=new nm,h=(null!==(o=t.advanceWidth)&&void 0!==o?o:1)*e;if(t)for(let n of s.commands){var c;let t=null===(c=l.currentPath)||void 0===c?void 0:c.currentPoint;if(!t||"Z"===n.type||t.x!==n.x||-t.y!==n.y)switch(n.type){case"M":l.moveTo(n.x,-n.y);break;case"L":l.lineTo(n.x,-n.y);break;case"Q":l.quadraticCurveTo(n.x1,-n.y1,n.x,-n.y);break;case"C":l.bezierCurveTo(n.x1,-n.y1,n.x2,-n.y2,n.x,-n.y)}}return l.subPaths.forEach((t=>{let e=function(t){if(t.length){let e=t[0];if(e instanceof n.LineCurve)return e.v1;if(e instanceof n.CubicBezierCurve||e instanceof n.QuadraticBezierCurve)return e.v0}}(t.curves);void 0!==e&&t.currentPoint.distanceTo(e)>0&&t.lineTo(e.x,e.y)})),{offsetX:h+a.fontSize*a.letterSpacing,path:l}}getCharWidth(t,e){var r,n;return null!==(r=null===(n=this.font)||void 0===n?void 0:n.getAdvanceWidth(t,e.fontSize,{kerning:!0,letterSpacing:e.letterSpacing}))&&void 0!==r?r:0}getTextWidth(t,e){var r,n;return null!==(r=null===(n=this.font)||void 0===n?void 0:n.getAdvanceWidth(t,e.fontSize,{kerning:!0,letterSpacing:e.letterSpacing}))&&void 0!==r?r:0}computeSpaceWidthForLine(t,e,r){let n=this.getCharWidth(" ",r),i=t[e];if(i){let a=this.countSpaces(i.trimEnd());if(4===r.horizontalAlign&&e<t.length-1&&a){return(r.width-(this.getTextWidth(i,r)-a*n))/a}}return n}countSpaces(t){return(t.match(/ /g)||[]).length}};var um=class{constructor(){this.objects=new Map,this.unreachable=new Set}getCached(t){return this.objects.get(t)}get size(){return this.objects.size}get(t,e,r){let n=this.objects.get(t);return void 0===n?(n=this.createObject(t,e,r),this.objects.set(t,n)):n.isShared=!0,n}forceDelete(t){let e=this.objects.get(t);e&&(this.disposeObject(e),this.objects.delete(t))}mutateIfUnique(t,e){let r=this.objects.get(t);if(r&&!0!==r.isShared)return this.objects.delete(t),this.objects.set(e,r),r}startGc(){this.unreachable=new Set(this.objects.keys())}markAsReachable(t,e){e===this.objects.get(t)&&this.unreachable.delete(t)}endGc(){this.unreachable.forEach((t=>{this.disposeObject(this.objects.get(t)),this.objects.delete(t)})),this.unreachable.clear()}dispose(){this.objects.forEach((t=>{this.disposeObject(t)})),this.objects.clear()}},dm=class extends um{constructor(t){super(),this.flatShading=t}disposeObject(t){t.dispose()}createObject(t,e,r){let n=Ku(t,e,this.flatShading,r);return n.computeBoundingSphere(),n}},pm={markNeedsUpdateRendererDirty:()=>{}},fm=class extends Of{constructor(t){super(),this.shared=t}create(t){return new Df(t,this.shared)}},mm=class{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.data=t,this.geometryCache=new dm(!0),this.geometryCache2=new dm(!1),this.imageHolderCache=new fm(this),this.thisContext={scene:pm,shared:this},this.deletedMaterial=new Zf(Ds.defaultTwoLayerData("phong"),this.thisContext,""),this.deletedImage=new Pf(pl.emptyImage,this),this.deletedVideo=new Pf(ys.defaultVideo,this),this.materials={},this.images={},this.videos={},this.colors={},this.audios={},this.fonts={},this.variables={},this.mouseProperty=null,this.raycastProperty=null,this.requestRender=()=>{this._requestRender&&this._requestRender()},e.images)for(let[r,n]of Object.entries(e.images))this.addImage(r,n);if(e.videos)for(let[r,n]of Object.entries(e.videos))this.addVideo(r,n);if(e.audios)for(let[r,n]of Object.entries(e.audios))this.addAudio(r,n);this.reset(t)}setRequestRender(t){this._requestRender=t}setEntityOpContext(t){this.entityOpContext=t}reset(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.resetLib(t.lib);for(let{id:r,data:n}of t.variables)this.addVariableHolder(r,n),e&&this.updateVariableHolder(r,n);for(let[r,n]of Object.entries(t.images))this.addImage(r,n);for(let[r,n]of Object.entries(t.videos))this.addVideo(r,n);for(let[r,n]of Object.entries(t.colors))this.addColor(r,n);for(let[r,n]of Object.entries(t.materials))this.addMaterial(r,n);for(let[r,n]of Object.entries(t.audios))this.addAudio(r,n);for(let[r,n]of Object.entries(t.fonts))this.addFont(r,n)}addMaterial(t,e){if(this.materials[t]){let r=this.materials[t];r.reset(e,this.thisContext),r.dispose()}else{let r=new Zf(e,this.thisContext,t);this.materials[t]=r}}deleteMaterial(t){this.materials[t]&&(this.materials[t].nodeMaterialDispose(),delete this.materials[t])}getMaterial(t){return this.materials[t]}getMaterialOrDeletedPlaceholder(t){var e;return null!==(e=this.materials[t])&&void 0!==e?e:this.deletedMaterial}material(t){return"string"==typeof t?this.getMaterialOrDeletedPlaceholder(t):null==t?(console.error("material is undefined or null"),this.deletedMaterial):new Qf(t,this.thisContext)}getMaterials(){return this.materials}addImage(t,e){return this.images[t]?(this.onColorOrImageUpdate&&this.onColorOrImageUpdate(),this.images[t].updateSrc(e.data),!0):(this.images[t]=new Pf(e,this),!1)}deleteImage(t){let e=this.images[t];e&&(e.dispose(),delete this.images[t])}getDefaultImage(){return this.images.image_0}getImage(t){var e;return null!==(e=this.images[t])&&void 0!==e?e:this.deletedImage}image(t){return"string"==typeof t?this.getImage(t):this.imageHolderCache.load(t)}addVideo(t,e){return this.videos[t]?(this.videos[t].updateSrc(e.data),!0):(this.videos[t]=new Pf(e,this),!1)}deleteVideo(t){let e=this.videos[t];e&&(e.dispose(),delete this.videos[t])}getVideo(t){var e;return null!==(e=this.videos[t])&&void 0!==e?e:this.deletedVideo}video(t){return"string"==typeof t?this.getVideo(t):this.imageHolderCache.load(t)}addColor(t,e){return this.colors[t]?(this.onColorOrImageUpdate&&this.onColorOrImageUpdate(),"a"in e?this.colors[t].setRGBA(e.r,e.g,e.b,e.a):this.colors[t].setRGBA(e.r,e.g,e.b,1),!0):(this.colors[t]=new Lf(e.r,e.g,e.b,"a"in e?e.a:1),!1)}updateColor(t,e){if(this.colors[t]){var r,n,i,a;this.onColorOrImageUpdate&&this.onColorOrImageUpdate();let o=this.colors[t];return this.colors[t].r=null!==(r=e.r)&&void 0!==r?r:o.r,this.colors[t].g=null!==(n=e.g)&&void 0!==n?n:o.g,this.colors[t].b=null!==(i=e.b)&&void 0!==i?i:o.b,this.colors[t].a=null!==(a=e.a)&&void 0!==a?a:o.a,!0}return!1}deleteColor(t){this.colors[t]&&delete this.colors[t]}getColor(t){return this.colors[t]}color(t){let e;if("string"!=typeof t)return new Fd(t.r,t.g,t.b,"a"in t?t.a:1);{let r=this.getColor(t);r?e=r:(console.warn("Tried to create color layer params with a color key that does not exist in the assets manager"),e=new Fd(0,0,0,0))}return e}addAudio(t,e){this.audios[t]=e}getAudio(t){let e=this.audios[t];if(e instanceof rm)return e;{let r=new rm({src:e.data});return this.audios[t]=r,r}}deleteAudio(t){let e=this.audios[t];e&&(e instanceof rm&&e.dispose(),delete this.audios[t])}addFont(t,e){this.fonts[t]=new cm(e),this.fonts[t].loadingPromise.then((()=>this.requestRender()))}getFont(t){return this.fonts[t]}deleteFont(t){this.fonts[t]&&delete this.fonts[t]}dispose(){Object.keys(this.materials).forEach((t=>this.deleteMaterial(t))),this._requestRender=void 0,Object.values(this.audios).forEach((t=>{t instanceof rm&&t.dispose()})),this.audios={},this.geometryCache.dispose(),this.geometryCache2.dispose()}addVariableHolder(t,e){return void 0===this.variables[t]?(this.variables[t]={value:e.value,locations:[]},"dynamicVariableType"in e&&(this.variables[t].dynamicVariablePlayState="Playing",this.variables[t].dynamicVariableToggleIsForward=void 0),!0):(this.variables[t].value=e.value,!1)}resetDynamicVariablePlayState(){for(let t in this.variables)void 0!==this.variables[t].dynamicVariablePlayState&&(this.variables[t].dynamicVariablePlayState="Playing",this.variables[t].dynamicVariableToggleIsForward=void 0)}updateVariableHolder(t,e){this.updateVariable(t,e.value)}updateVariable(t,e){if(void 0===this.variables[t])return!1;this.variables[t].value=e;let r=e;for(;"string"==typeof r;)r=this.variables[r].value;let i=this.entityOpContext.scene;for(let a=this.variables[t].locations.length-1;a>=0;a--){let e=this.variables[t].locations[a];if("material"===e[0]){let t=e[1],n=r,a={scene:i,shared:this},o=e.slice(2);i.traverseMaterial((e=>{var r;let i=null!==(r=e.root)&&void 0!==r?r:e;i.uuid===t&&i.onVariableUpdate(o,n,a)}));let s=this.materials[t];s&&s.onVariableUpdate(o,n,a)}else{let o=i.find(e[0]);if(void 0===o){this.variables[t].locations.splice(a,1);continue}if("geometry"!==e[1]){for(let t=1;t<e.length-1;t++)o=o[e[t]];"rotation"===e[1]?o[e[e.length-1]]=r*n.MathUtils.DEG2RAD:o[e[e.length-1]]=r}if(o=i.find(e[0]),hh.is(o))if("position"===e[1]||"rotation"===e[1]||"scale"===e[1])o.onVariableUpdate();else if("geometry"===e[1]){let t=o;o.component&&(t=o.component);let e=t.dataPatched;t.chooseGeoemtryCache(this).forceDelete(e.geometry),t.createGeometryDelayed(this.entityOpContext),t.onVariableUpdate(!0),t.instances.forEach((t=>{let e=t.dataPatched;t.chooseGeoemtryCache(this).forceDelete(e.geometry),t.createGeometryDelayed(this.entityOpContext),t.onVariableUpdate(!0)}))}}}return!0}deleteVariable(t){this.variables[t]&&delete this.variables[t]}getVariable(t,e){if(Array.isArray(t)){var r,i,a,o;if("mouse"===t[0])return null!==(r=null===(i=this.mouseProperty)||void 0===i?void 0:i[t[1]])&&void 0!==r?r:0;if("raycast"===t[0])return null!==(a=null===(o=this.raycastProperty)||void 0===o?void 0:o[t[1]])&&void 0!==a?a:0;let e=this.entityOpContext.scene.find(t[0]);if("width"===t[1]||"height"===t[1]||"depth"===t[1])return e.geometry.userData.parameters[t[1]];for(let r=1;r<t.length;r++)e=e[t[r]];return"rotation"===t[1]&&(e*=n.MathUtils.RAD2DEG),e}for(let n in this.variables){var s;if(void 0===e)break;let t=this.variables[n],r=null===(s=t.locations)||void 0===s?void 0:s.findIndex((t=>oa.equal(t,e)));void 0!==r&&-1!==r&&t.locations.splice(r,1)}if("string"==typeof t){let r=t,n=t;do{if(n=r,void 0===this.variables[r])break;r=this.variables[r].value}while("string"==typeof r);return e&&void 0!==this.variables[n]&&this.variables[n].locations.push(e),r}return t}getVariables(){return this.variables}getDynamicVariablePlayState(t){var e;return null===(e=this.variables[t])||void 0===e?void 0:e.dynamicVariablePlayState}setDynamicVariablePlayState(t,e){void 0!==this.variables[t]&&(this.variables[t].dynamicVariablePlayState=e)}getDynamicVariableToggleIsForward(t){var e;return null===(e=this.variables[t])||void 0===e?void 0:e.dynamicVariableToggleIsForward}setDynamicVariableToggleIsForward(t,e){void 0!==this.variables[t]&&(this.variables[t].dynamicVariableToggleIsForward=e)}resetLib(t){for(let[e,r]of Object.entries(t.images))this.addImage(e,r.asset);for(let[e,r]of Object.entries(t.audios))this.addAudio(e,r.asset);for(let[e,r]of Object.entries(t.colors))this.addColor(e,r.asset);for(let[e,r]of Object.entries(t.fonts))this.addFont(e,r.asset);for(let[e,r]of Object.entries(t.materials))this.addMaterial(e,r.asset);for(let[e,r]of Object.entries(t.videos))this.addVideo(e,r.asset);for(let[e,r]of Object.entries(t.variables))this.addVariableHolder(e,r.asset)}updateLibByOp(t,e){"images"===t.path[0]?1===t.path.length&&1===t.type?this.addImage(t.id,t.data.asset):1===t.path.length&&2===t.type&&this.deleteImage(t.id):"videos"===t.path[0]?1===t.path.length&&1===t.type?this.addVideo(t.id,t.data.asset):1===t.path.length&&2===t.type&&this.deleteVideo(t.id):"audios"===t.path[0]?1===t.path.length&&1===t.type?this.addAudio(t.id,t.data.asset):1===t.path.length&&2===t.type&&this.deleteAudio(t.id):"colors"===t.path[0]?1===t.path.length&&1===t.type?this.addColor(t.id,t.data.asset):1===t.path.length&&2===t.type&&this.deleteColor(t.id):"materials"===t.path[0]?1===t.path.length&&1===t.type?this.addMaterial(t.id,t.data.asset):1===t.path.length&&2===t.type&&this.deleteMaterial(t.id):"fonts"===t.path[0]?1===t.path.length&&1===t.type?this.addFont(t.id,t.data.asset):1===t.path.length&&2===t.type&&this.deleteFont(t.id):"variables"===t.path[0]?1===t.path.length&&1===t.type?this.addVariableHolder(t.id,t.data.asset):1===t.path.length&&2===t.type&&this.deleteVariable(t.id):"components"===t.path[0]&&e.updateByLibOp(t,this)}updateByOp(t,e,r){this.data=e,"images"===t.path[0]?2===t.path.length&&0===t.type?t.props.data&&this.getImage(t.path[1]).updateSrc(t.props.data):1===t.path.length&&1===t.type?this.addImage(t.id,t.data):1===t.path.length&&2===t.type&&this.deleteImage(t.id):"videos"===t.path[0]?2===t.path.length&&0===t.type?t.props.data&&this.getVideo(t.path[1]).updateSrc(t.props.data):1===t.path.length&&1===t.type?this.addVideo(t.id,t.data):1===t.path.length&&2===t.type&&this.deleteVideo(t.id):"audios"===t.path[0]?2===t.path.length&&0===t.type?t.props.data&&this.addAudio(t.path[1],e.audios[t.path[1]]):1===t.path.length&&1===t.type?this.addAudio(t.id,t.data):1===t.path.length&&2===t.type&&this.deleteAudio(t.id):"colors"===t.path[0]?2===t.path.length&&0===t.type?this.updateColor(t.path[1],t.props):1===t.path.length&&1===t.type?this.addColor(t.id,t.data):1===t.path.length&&2===t.type&&this.deleteColor(t.id):"materials"===t.path[0]?1===t.path.length&&1===t.type?this.addMaterial(t.id,t.data):1===t.path.length&&2===t.type?this.deleteMaterial(t.id):t.path.length>1&&this.getMaterial(t.path[1]).updateByOp(Vi.drop(t,2),e.materials[t.path[1]],{shared:this,scene:r}):"fonts"===t.path[0]?2===t.path.length&&0===t.type?this.updateFont(t.path[1],t,r):1===t.path.length&&1===t.type?this.addFont(t.id,t.data):1===t.path.length&&2===t.type&&this.deleteFont(t.id):"variables"===t.path[0]?2===t.path.length&&0===t.type&&"value"in t.props?this.updateVariable(t.path[1],t.props.value):1===t.path.length&&4===t.type?this.addVariableHolder(t.id,t.data):1===t.path.length&&5===t.type&&this.deleteVariable(t.id):"lib"===t.path[0]&&this.updateLibByOp(Vi.drop(t,1),r)}updateFont(t,e,r){if(e.props.url){let n=this.getFont(t),i={...this.data.fonts[t],url:e.props.url};n.update(i),n.loadingPromise.then((()=>this.requestRender())),r.updateFont(t,this)}}},vm=new mm(bl.emptyData()),gm=class extends Ld{updateByPatchedOp(t,e,r){if(super.updateByPatchedOp(t,e,r),null!==function(t,e){let r=[];if(e.length!==t.length)return null;for(var n=0;n<t.length;){if("*"===e[n])r.push(t[n]);else if(t[n]!==e[n])return null;n+=1}return r}(t.path,["materials"])&&0===t.type&&Array.isArray(this.material))for(let[n,i]of Object.entries(t.props)){let t=r.shared.material(i);this.material[Number(n)]=t}else if(da(t.path,["material"])&&this.material instanceof Xf)"material"in e&&"string"!=typeof e.material&&this.material.updateByOp(Vi.drop(t,1),e.material,r);else if(da(t.path,["materials","*"])&&Array.isArray(this.material)){let n=t.path[1];if("materials"in e&&n<this.material.length){let i=e.materials[n];"string"!=typeof i&&this.material[n].updateByOp(Vi.drop(t,2),i,r)}}}get needsAO(){return void 0!==this.material&&(Array.isArray(this.material)?this.material[0]:this.material).hasAO}updateState(t,e){var r,n;super.updateState(t,e),void 0!==t.castShadow&&(this.castShadow=t.castShadow),void 0!==t.receiveShadow&&(this.receiveShadow=t.receiveShadow);let i=this.dataPatched;if("NonParametricGeometry"!==(null===(r=t.geometry)||void 0===r?void 0:r.type)&&"material"in t&&void 0!==t.material&&(this.disposeMaterial(),this.material=e.shared.material(t.material).getFlavor(i.flatShading,i.side,i.wireframe),e.scene.markNeedsUpdateRendererDirty()),"NonParametricGeometry"===(null===(n=t.geometry)||void 0===n?void 0:n.type)&&("materials"in t&&void 0!==t.materials?(this.disposeMaterial(),this.material=t.materials.map((t=>e.shared.material(t).getFlavor(i.flatShading,i.side,i.wireframe))),e.scene.markNeedsUpdateRendererDirty()):"material"in t&&void 0!==t.material&&(this.disposeMaterial(),this.material=[e.shared.material(t.material).getFlavor(i.flatShading,i.side,i.wireframe)],e.scene.markNeedsUpdateRendererDirty())),void 0!==t.flatShading||void 0!==t.wireframe||void 0!==t.side)if(Array.isArray(this.material))for(let a=0;a<this.material.length;a++)this.material[a]=this.material[a].getFlavor(i.flatShading,i.side,i.wireframe);else this.material=this.material.getFlavor(i.flatShading,i.side,i.wireframe)}disposeMaterial(){this.material&&I(this.material).forEach((t=>{t instanceof Xf&&(t instanceof Zf||t.nodeMaterialDispose())}))}dispose(){this.disposeMaterial(),super.dispose()}},ym=new n.Vector3,bm=new n.Vector4,xm=new n.Vector4,wm=new n.Vector3,_m=new n.Matrix4,Sm=class extends gm{constructor(t,e,r){super(t,e),this.data=e,this.isSkinnedMesh=!1,this.localGeometry=void 0,e.bindMode&&e.bindMatrix&&(this.bindMode=e.bindMode,this.bindMatrix=(new n.Matrix4).fromArray(e.bindMatrix),this.bindMatrixInverse=new n.Matrix4)}chooseGeoemtryCache(t){return t.geometryCache}markGeometryAsReachable(t){this.geometryCreateDeleyed instanceof n.BufferGeometry&&this.chooseGeoemtryCache(t).markAsReachable(this.dataPatched.geometry,this.geometryCreateDeleyed)}get geometry(){if(void 0!==this.localGeometry)return this.localGeometry;if(this.geometryCreateDeleyed instanceof mm){let t=this.geometryCreateDeleyed,e=this.chooseGeoemtryCache(t);this.geometryCreateDeleyed=e.get(this.dataPatched.geometry,t,this)}return this.geometryCreateDeleyed}set geometry(t){this.localGeometry=t}get is2DAndNoDepth(){let t=this.dataPatched.geometry;return Bs.is2DParametricMesh(t.type)&&0===t.depth}get is2DType(){return Bs.is2DParametricMesh(this.geometry.userData.type)}get isNonParametric(){return"NonParametricGeometry"===this.geometry.userData.type}updateByPatchedOp(t,e,r){super.updateByPatchedOp(t,e,r),da(t.path,["geometry"])&&this.updateByPatchedOpGeometry(Vi.drop(t,1),e.geometry,r)}removeInteractionGeometry(){var t;null!==(t=this.localGeometry)&&void 0!==t&&t.dispose(),this.localGeometry=void 0}updateGeometryInteractions(t,e){this.invalidateDownstreamBooleanData();let r=this.data.geometry.type;if("NonParametricGeometry"===r||"SubdivGeometry"===r){let r,n,i,a=t;if(void 0===this.localGeometry){let t={...this.data.geometry,...a};this.localGeometry=Ku(t,e,this.data.flatShading,this)}a.scaleBaked?[r,n,i]=a.scaleBaked:({width:r,height:n,depth:i}=a);let o=this.localGeometry.userData;void 0!==o.sxPrev&&$u(this.localGeometry.attributes,r/o.sxPrev,n/o.syPrev,i/o.szPrev),o.sxPrev=r,o.syPrev=n,o.szPrev=i}else{var n;let r={...this.data.geometry,...t};null!==(n=this.localGeometry)&&void 0!==n&&n.dispose(),this.localGeometry=Ku(r,e,this.data.flatShading,this)}}refreshAttachedCloners(t){for(let e of this.attachedSurfaceCloners)t.scene.addPendingUpdateCloner(e.object)}refreshAttachedPaths(t){for(let e of this.attachedPaths)t.scene.addPendingCommand((()=>e.updateShape()))}createGeometryDelayed(t){this.geometryCreateDeleyed=t.shared,this.refreshAttachedCloners(t),this.refreshAttachedPaths(t)}updateByPatchedOpGeometry(t,e,r){var n;let i=!1;0===t.type&&0===t.path.length&&Object.keys(t.props).includes("scaleBaked")&&this.geometryCreateDeleyed instanceof od&&this.chooseGeoemtryCache(r.shared).mutateIfUnique(this.geometryCreateDeleyed.data,e)===this.geometryCreateDeleyed&&(i=!0,this.geometryCreateDeleyed.mutateDirectlyScaleBaked(e,t.props.scaleBaked),this.refreshAttachedCloners(r),this.refreshAttachedPaths(r)),i||(null!==(n=r.scene)&&void 0!==n&&n.markGeometryCacheDirty(),this.createGeometryDelayed(r)),this.resetBBoxNeedsUpdate(),this.invalidateDownstreamBooleanData()}updateGeometryOnStateUpdate(t,e){this.createGeometryDelayed(e)}updateState(t,e){void 0!==t.geometry&&this.updateGeometryOnStateUpdate(t.geometry,e),super.updateState(t,e)}updateGeometryGroupsIfNeeded(){var t,e;Array.isArray(this.material)&&0===this.geometry.groups.length&&this.geometry.addGroup(0,Math.max(null!==(t=null===(e=this.geometry.getIndex())||void 0===e?void 0:e.count)&&void 0!==t?t:0,this.geometry.getAttribute("position").count),0)}updateEntityBoxSize(t,e){var r,n;let i=this.geometry.userData.parameters;this.is2DType?t.set(0,0,.5*i.depth):this.isNonParametric?(t.setScalar(0),this.geometry.boundingSphere&&t.copy(this.geometry.boundingSphere.center),e.set(i.width,i.height,null!==(r=i.depth)&&void 0!==r?r:0).multiplyScalar(.5)):t.setScalar(0),e.set(i.width,i.height,null!==(n=i.depth)&&void 0!==n?n:0).multiplyScalar(.5)}updateMatrixWorld(t){super.updateMatrixWorld(t),"attached"===this.bindMode?this.bindMatrixInverse.copy(this.matrixWorld).invert():"detached"===this.bindMode&&this.bindMatrixInverse.copy(this.bindMatrix).invert()}bind(t,e){this.skeleton=t,this.isSkinnedMesh=!0,void 0===e&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),e=this.matrixWorld),this.bindMatrix.copy(e),this.bindMatrixInverse.copy(e).invert()}pose(){this.skeleton.pose()}normalizeSkinWeights(t){let e=new n.Vector4,r=this.geometry.attributes.skinWeight;for(let n=0,i=r.count;n<i;n++){e.fromBufferAttribute(r,n);let t=1/e.manhattanLength();t!==1/0?e.multiplyScalar(t):e.set(1,0,0,0),r.setXYZW(n,e.x,e.y,e.z,e.w)}}boneTransform(t,e){let r=this.skeleton;if(void 0===r)return;let n=this.geometry;bm.fromBufferAttribute(n.attributes.skinIndex,t),xm.fromBufferAttribute(n.attributes.skinWeight,t),ym.copy(e).applyMatrix4(this.bindMatrix),e.set(0,0,0);for(let i=0;i<4;i++){let t=xm.getComponent(i);if(0!==t){let n=bm.getComponent(i);_m.multiplyMatrices(r.bones[n].matrixWorld,r.boneInverses[n]),e.addScaledVector(wm.copy(ym).applyMatrix4(_m),t)}}return e.applyMatrix4(this.bindMatrixInverse)}};function Am(t){if(Array.isArray(t.material)){for(let e of t.material)if(0===e.getLayersOfType("outline").length)return}else if(!(t.material instanceof Xf)||0===t.material.getLayersOfType("outline").length)return;t instanceof Sm&&t.is2DAndNoDepth?function(t){if(t.geometry.attributes.extrudeNormals||!t.geometry.attributes.position)return;let e=t.geometry.attributes.position.array,r=new Float32Array(e.length),i=new n.Vector3;for(let n=0;n<e.length;n+=3)i.set(e[n],e[n+1],e[n+2]).normalize(),r[n]=i.x,r[n+1]=i.y,r[n+2]=i.z;t.geometry.setAttribute("extrudeNormal",new n.Float32BufferAttribute(r,3))}(t):function(t){if(t.geometry.attributes.extrudeNormal||!t.geometry.attributes.position||!t.geometry.attributes.normal)return;let e=new Map,r=t.geometry.attributes,i=r.position.array,a=r.normal.array,o=new Float32Array(i.length);for(let h=0;h<i.length;h+=3){var s;let t="".concat(i[h],"_").concat(i[h+1],"_").concat(i[h+2]),r=new n.Vector3(a[h],a[h+1],a[h+2]);e.has(t)?null===(s=e.get(t))||void 0===s||s.normals.push(r):e.set(t,{normals:[r],result:new n.Vector3})}e.forEach(((t,e)=>{for(let r of t.normals)t.result.add(r);t.result.divideScalar(t.normals.length)}));for(let n=0;n<i.length;n+=3){var l;let t="".concat(i[n],"_").concat(i[n+1],"_").concat(i[n+2]),r=null===(l=e.get(t))||void 0===l?void 0:l.result;r&&(o[n]=r.x,o[n+1]=r.y,o[n+2]=r.z)}t.geometry.setAttribute("extrudeNormal",new n.Float32BufferAttribute(o,3))}(t)}function Mm(t){if(!t.geometry.attributes.position)return;let e=t.geometry.attributes.position.array,r=new Float32Array(e.length),i=parseInt(t.uuid.replace(/\D/g,"")),a=[n.MathUtils.seededRandom(i),n.MathUtils.seededRandom(i+1e4),n.MathUtils.seededRandom(i+2e4)];for(let n=0;n<e.length;n++)r[n]=a[n%3];t.geometry.setAttribute("randomColor",new n.BufferAttribute(r,3))}Xu.then((t=>{t}));var Cm=new n.Box3,Om=new n.Vector3;function Dm(t){let e=!1;return t.scene.objects.traverse(((t,r)=>{"Mesh"===r.type&&"SubdivGeometry"===r.geometry.type&&(e=!0)})),e}var Pm=class extends Sm{constructor(t,e,r){super(t,e,r),this.data=e,this.hiddenMatrixOld=new n.Matrix4,this.smoothShading=!0,this.skipReactionUpdate=!1}chooseGeoemtryCache(t){return this.dataPatched.flatShading?t.geometryCache:t.geometryCache2}get subdivPointerNew(){return void 0!==this.localGeometry?this.subdivPointer:this.geometry.ensureSubdivPointer()}get originalGeometryNew(){return void 0!==this.localGeometry?this.originalGeometry:this.geometry.originalGeometry}get phongAngle(){var t;return null!==(t=this.data.geometry.phongAngle)&&void 0!==t?t:45}updateEntityBoxSize(t,e){var r;let n=this.geometry.userData.parameters;t.copy(this.originalGeometryNew.boundingSphere.center),e.set(n.width,n.height,null!==(r=n.depth)&&void 0!==r?r:0).multiplyScalar(.5)}createGeometryByControls(t){var e,r,n,i;if(!0===this.skipReactionUpdate)return;let a=null===(e=this.localGeometry)||void 0===e?void 0:e.uuid,{originalGeometry:o,subdividedGeometry:s,subdivPointer:l}=od.build(t,this.subdivPointer,this.smoothShading,this.hasNonUniformScale?this.shearScale:void 0);this.subdivPointer=l,void 0!==o&&(null!==(r=this.originalGeometry)&&void 0!==r&&r.dispose(),this.originalGeometry=o),void 0!==s&&(null!==(n=this.subdividedGeometry)&&void 0!==n&&n.dispose(),this.subdividedGeometry=null!==s&&void 0!==s?s:void 0),this.localGeometry=null!==(i=this.subdividedGeometry)&&void 0!==i?i:this.originalGeometry,Am(this),Mm(this),this.calcBoundingBox(),a&&(this.localGeometry.uuid=a)}updateState(t,e){if(super.updateState(t,e),void 0!==t.flatShading){let r=this.material;this.material=r.getFlavor(!1,r.side,r.wireframe),this.smoothShading=!t.flatShading,this.createGeometryDelayed(e)}}updateMesh(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];od.buildLevel(this.subdivPointer,!0,this.smoothShading?this.phongAngle:-1,this.originalGeometry,t&&this.hasNonUniformScale?this.shearScaleInv:void 0),this.subdividedGeometry&&od.buildLevel(this.subdivPointer,!1,this.smoothShading?this.phongAngle:-1,this.subdividedGeometry,t&&this.hasNonUniformScale?this.shearScaleInv:void 0)}updateTopology(){var t;this.originalGeometry.dispose(),this.originalGeometry=od.buildLevel(this.subdivPointer,!0,this.smoothShading?this.phongAngle:-1),this.subdividedGeometry&&(this.subdividedGeometry.dispose(),this.subdividedGeometry=od.buildLevel(this.subdivPointer,!1,this.smoothShading?this.phongAngle:-1)),this.localGeometry=null!==(t=this.subdividedGeometry)&&void 0!==t?t:this.originalGeometry}raycast(t,e){let r=this.localGeometry;this.localGeometry=this.originalGeometryNew,Ld.prototype.raycast.call(this,t,e),this.localGeometry=r}activateSVDCompensation(){!this.hasNonUniformScale||(this.matrix.copy(this.matrixWorldRigid),this.hiddenMatrixOld.copy(this.hiddenMatrix),this.hiddenMatrix.copy(this.parent.matrixWorld).invert())}deactivateSVDCompensation(){!this.hasNonUniformScale||(this.updateMatrix(),this.hasNonUniformScale=void 0,this.hiddenMatrix.copy(this.hiddenMatrixOld))}calcBoundingBox(){let t=this.originalGeometry;null===t.boundingSphere&&(t.boundingSphere=new n.Sphere,this.subdividedGeometry&&(this.subdividedGeometry.boundingSphere=t.boundingSphere));let e=t.attributes.position,r=t.boundingSphere.center;Cm.setFromBufferAttribute(e),Cm.getCenter(r),t.boundingSphere.radius=r.distanceTo(Cm.max),isNaN(t.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this),Cm.getSize(Om),this.hasNonUniformScale&&Om.divide(this.scale);let i={width:Om.x,height:Om.y,depth:Om.z};return this.geometry.userData.parameters=i,i}updateBoundingSphere(t){let e=this.originalGeometry;Cm.min.set(t[0],t[2],t[4]),Cm.max.set(t[1],t[3],t[5]),this.hasNonUniformScale&&(Cm.min.applyMatrix4(this.shearScaleInv),Cm.max.applyMatrix4(this.shearScaleInv)),null===e.boundingSphere&&(e.boundingSphere=new n.Sphere);let r=e.boundingSphere.center;Cm.getCenter(r),e.boundingSphere.radius=r.distanceTo(Cm.max)}freeSubdivPointer(){var t,e;this.subdivPointer&&(od.freeSubdivPointer(this.subdivPointer),this.subdivPointer=0),this.localGeometry=void 0,null!==(t=this.originalGeometry)&&void 0!==t&&t.dispose(),null===(e=this.subdividedGeometry)||void 0===e||e.dispose()}dispose(){super.dispose(),this.freeSubdivPointer()}updateByPatchedOpGeometry(t,e,r){super.updateByPatchedOpGeometry(t,e,r),this.localGeometry&&this.createGeometryByControls(e)}},Tm={x:[1,0,0],"-x":[-1,0,0],y:[0,1,0],"-y":[0,-1,0],z:[0,0,1],"-z":[0,0,-1]},zm={polygon_center:0,edge:1,vertex:2},Em=(t,e)=>(r,n)=>e&&0!==r&&0!==t?t*n/100:0,Im=(t,e)=>{let r=Math.abs(e),n=-1*r;return(t- -1)*(r-n)/2+n};var Lm=new n.Vector3,Bm=new n.Vector3,km=new n.Vector3,Vm=new n.Vector3;function Um(t,e){let r=km.fromArray(t),n=Vm.fromArray(e);Bm.copy(n).sub(r);let i=Bm.length();return Bm.normalize().multiplyScalar(.5*i),Lm.copy(r).add(Bm).toArray()}var jm=new n.Triangle,Nm=new n.Vector3,Rm=new n.Vector3,Fm=new n.Vector3;var Gm=t=>.5*(1-Math.cos(t*Math.PI)),qm=class{constructor(){this.perlin=new Array(4096)}noise(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(null==this.perlin){this.perlin=new Array(4096);for(let t=0;t<4096;t++)this.perlin[t]=Math.random()}t<0&&(t=-t),e<0&&(e=-e),r<0&&(r=-r);let n,i,a,o,s,l=Math.floor(t),h=Math.floor(e),c=Math.floor(r),u=t-l,d=e-h,p=r-c,f=0,m=.5;for(let v=0;v<4;v++){let t=l+(h<<4)+(c<<8);n=Gm(u),i=Gm(d),a=this.perlin[4095&t],a+=n*(this.perlin[t+1&4095]-a),o=this.perlin[t+16&4095],o+=n*(this.perlin[t+16+1&4095]-o),a+=i*(o-a),t+=256,o=this.perlin[4095&t],o+=n*(this.perlin[t+1&4095]-o),s=this.perlin[t+16&4095],s+=n*(this.perlin[t+16+1&4095]-s),o+=i*(s-o),a+=Gm(p)*(o-a),f+=a*m,m*=.5,l<<=1,u*=2,h<<=1,d*=2,c<<=1,p*=2,u>=1&&(l++,u--),d>=1&&(h++,d--),p>=1&&(c++,p--)}return f}noiseSeed(t){let e=(()=>{let t,e;return{setSeed(r){e=t=(null!==r&&void 0!==r?r:4294967296*Math.random())>>>0},getSeed:()=>t,rand:()=>(e=(1664525*e+1013904223)%4294967296,e/4294967296)}})();e.setSeed(t),this.perlin=new Array(4096);for(let r=0;r<4096;r++)this.perlin[r]=e.rand()}},Hm=new n.Vector3,Wm=new n.Matrix4,Xm=new n.Ray;function Ym(t){let e=!1;return t.scene.objects.traverse(((t,r)=>{"Mesh"===r.type&&"TextGeometry"===r.geometry.type&&(e=!0)})),e}var Qm,Zm,Km,Jm,$m=class extends Sm{constructor(t,e,r){super(t,e,r),this.data=e}get textGeometry(){return this.geometry}get charWidths(){return this.textGeometry.charWidths}get charCoords(){return this.textGeometry.charCoords}get wrappedText(){return this.textGeometry.wrappedText}get font(){return this.textGeometry.font}get initialOffsetY(){var t,e;let r=this.dataPatched;return null!==(t=null===(e=this.font)||void 0===e?void 0:e.getLineInitialOffsetY(this.lineHeight,this.wrappedText.length,r.geometry.height,this.fontScale,r.geometry.verticalAlign))&&void 0!==t?t:0}get fontScale(){let t=this.dataPatched;return this.font?t.geometry.fontSize/this.font.unitsPerEm:1}get AD(){return Math.abs(this.ascender-this.descender)}get ascender(){var t,e;return(null!==(t=null===(e=this.font)||void 0===e?void 0:e.ascender)&&void 0!==t?t:1)*this.fontScale}get descender(){var t,e;return(null!==(t=null===(e=this.font)||void 0===e?void 0:e.descender)&&void 0!==t?t:1)*this.fontScale}get lineHeight(){let t=this.dataPatched;return t.geometry.fontSize*t.geometry.lineHeight}raycast(t,e){let{matrixWorld:r}=this;if(!isNaN(t.ray.origin.x)&&0!==this.scale.x&&0!==this.scale.y&&0!==this.scale.z&&(Wm.copy(r).invert(),Xm.copy(t.ray).applyMatrix4(Wm),Xm.intersectBox(this.singleBBox,Hm))){let n=Hm.applyMatrix4(r),i=t.ray.origin.distanceTo(n);e.push({distance:i,point:n.clone(),object:this})}}},tv=1e-4,ev=new n.Vector3,rv=new n.Vector3;Xu.then((t=>{Zm=[(Qm=t).get_face_center,Qm.get_edge_midpoint,Qm.get_vertex_position],Km=[Qm.get_face_normal,Qm.get_edge_normal,Qm.get_vertex_normal],Jm=[Qm.face_count,Qm.edge_count,Qm.vertex_count]}));var nv=new n.Matrix4,iv=new n.Matrix4,av=new n.Vector3,ov=new n.Vector3,sv=new n.Vector3,lv=new n.Vector3,hv=new n.Vector3,cv=new n.Vector3,uv=new qm,dv=class extends(ch(n.Object3D)){constructor(t,e){super(),this.parameters=e,this.objectForSample=void 0,this._pendingMediaLoad=!1,this.object=t}resetOnMove(){this.removeFromParent(),this.parent=null}expandClones(t){if(null===this.parent)this.updateState(this.parameters,t);else for(let e of this.children)e instanceof dh&&e.expand()}invalidateTransform(t){this.matrixWorldNeedsUpdate=!0,this.traverse((e=>{e instanceof dh&&e.object===t&&(e.matrixWorldNeedsUpdate=!0)}))}onObjUpdateMatrix(){"toObject"!==this.parameters.type&&(this.matrixWorldNeedsUpdate=!0)}update(){switch(this._updateCount(),this.parameters.type){case"radial":this._updateRadial(this.parameters);break;case"linear":this._updateLinear(this.parameters);break;case"grid":this._updateGrid(this.parameters);break;case"toObject":this._updateToObject(this.parameters)}for(let t of this.children)t.updateMatrix(),t.hasNonUniformScale&&(t.updateMatrixWorld(),t.updateMatrixWorldSVD())}_updateCount(t){let e;if(e=void 0!==t?t:"grid"===this.parameters.type?Math.round(this.parameters.grid.count[0])*Math.round(this.parameters.grid.count[1])*Math.round(this.parameters.grid.count[2]):this.parameters.count,"toObject"===this.parameters.type&&!this.parameters.toObject.object&&(e=0),"toObject"===this.parameters.type&&this.objectForSample){for(let e=0,r=this.children.length;e<r;++e)this.remove(this.children[0]);let t=this.children;if(t.length===e)return;if(t.length<e)for(let r=0,n=e-t.length;r<n;++r){let t=new dh(this.object);t.expand(),this.add(t)}else for(let r=0,n=t.length-e;r<n;++r)this.remove(t[r])}else{if(this.children.length===e)return;if(this.children.length<e)for(let t=0,r=e-this.children.length;t<r;++t){let t=new dh(this.object);t.expand(),this.add(t)}else for(let t=0,r=this.children.length-e;t<r;++t)this.remove(this.children[0])}}_updateRadial(t){var e;let r,i=t.radial,a=i.start*n.MathUtils.DEG2RAD,o=a-i.end*n.MathUtils.DEG2RAD,s=new n.Euler(i.rotation[0],i.rotation[1],i.rotation[2]);switch(i.axis){case"z":r=new n.Vector3(0,0,1);break;case"y":r=new n.Vector3(0,1,0);break;default:r=new n.Vector3(1,0,0)}let l=null!==(e=t.randomnessObject)&&void 0!==e?e:as.defaultData([1,1,1]).randomnessObject,h="perlin"===l.noiseType;uv.noiseSeed(l.seed);let c=th((0,Wl.default)(l.seed)),u=Em(l.strength,this.parameters.randomness);for(let[n,d]of this.children.entries()){let e=n*(l.freqScale/10)+l.movement,p=h?uv.noise(e):c(e,e),f=n+1;d.scale.x=i.scale[0]+u(f,Im(p,l.scale[0]))||tv,d.scale.y=i.scale[1]+u(f,Im(p,l.scale[1]))||tv,d.scale.z=i.scale[2]+u(f,Im(p,l.scale[2]))||tv,d.position.setScalar(0);let m=o/t.count*n-a;switch(i.axis){case"x":d.rotation.set(0,m,0);break;case"y":d.rotation.set(0,0,m);break;case"z":d.rotation.set(m,0,0)}d.translateOnAxis(r,i.radius),d.position.x+=i.position[0]+u(f,Im(p,l.position[0])),d.position.y+=i.position[1]+u(f,Im(p,l.position[1])),d.position.z+=i.position[2]+u(f,Im(p,l.position[2]));let v=u(f,Im(p,l.rotation[0])),g=u(f,Im(p,l.rotation[1])),y=u(f,Im(p,l.rotation[2]));!0===i.alignment?(d.rotation.x+=s.x+v,d.rotation.y+=s.y+g,d.rotation.z+=s.z+y):d.rotation.set(s.x+v,s.y+g,s.z+y)}}_updateLinear(t){var e;if("linear"!==t.type)throw new Error;let r=t.linear,i=new n.Euler(r.rotation[0],r.rotation[1],r.rotation[2]),a=null!==(e=t.randomnessObject)&&void 0!==e?e:as.defaultData([1,1,1]).randomnessObject,o="perlin"===a.noiseType;uv.noiseSeed(a.seed);let s=th((0,Wl.default)(a.seed)),l=Em(a.strength,this.parameters.randomness);for(let[n,h]of this.children.entries()){let t=n*(a.freqScale/10)+a.movement,e=o?uv.noise(t):s(t,t),c=n+1,u=l(c,Im(e,a.rotation[0])),d=l(c,Im(e,a.rotation[1])),p=l(c,Im(e,a.rotation[2]));h.scale.x=1+(r.scale[0]-1)*n+l(c,Im(e,a.scale[0]))||tv,h.scale.y=1+(r.scale[1]-1)*n+l(c,Im(e,a.scale[1]))||tv,h.scale.z=1+(r.scale[2]-1)*n+l(c,Im(e,a.scale[2]))||tv,h.rotation.x=i.x*n+u,h.rotation.y=i.y*n+d,h.rotation.z=i.z*n+p,h.position.x=r.position[0]*n+l(c,Im(e,a.position[0])),h.position.y=r.position[1]*n+l(c,Im(e,a.position[1])),h.position.z=r.position[2]*n+l(c,Im(e,a.position[2]))}}_updateGrid(t){var e;let r=0,i=t.grid,a=null!==(e=t.randomnessObject)&&void 0!==e?e:as.defaultData([1,1,1]).randomnessObject,o=Em(a.strength,this.parameters.randomness),s="perlin"===a.noiseType;uv.noiseSeed(a.seed);let l=function(){let t=eh(arguments.length>0&&void 0!==arguments[0]?arguments[0]:Math.random),e=new Float64Array(t).map((t=>$l[t%12*3])),r=new Float64Array(t).map((t=>$l[t%12*3+1])),n=new Float64Array(t).map((t=>$l[t%12*3+2]));return function(i,a,o){let s,l,h,c,u,d,p,f,m,v,g=(i+a+o)*Ql,y=Kl(i+g),b=Kl(a+g),x=Kl(o+g),w=(y+b+x)*Zl,_=i-(y-w),S=a-(b-w),A=o-(x-w);_>=S?S>=A?(u=1,d=0,p=0,f=1,m=1,v=0):_>=A?(u=1,d=0,p=0,f=1,m=0,v=1):(u=0,d=0,p=1,f=1,m=0,v=1):S<A?(u=0,d=0,p=1,f=0,m=1,v=1):_<A?(u=0,d=1,p=0,f=0,m=1,v=1):(u=0,d=1,p=0,f=1,m=1,v=0);let M=_-u+Zl,C=S-d+Zl,O=A-p+Zl,D=_-f+2*Zl,P=S-m+2*Zl,T=A-v+2*Zl,z=_-1+.5,E=S-1+.5,I=A-1+.5,L=255&y,B=255&b,k=255&x,V=.6-_*_-S*S-A*A;if(V<0)s=0;else{let i=L+t[B+t[k]];V*=V,s=V*V*(e[i]*_+r[i]*S+n[i]*A)}let U=.6-M*M-C*C-O*O;if(U<0)l=0;else{let i=L+u+t[B+d+t[k+p]];U*=U,l=U*U*(e[i]*M+r[i]*C+n[i]*O)}let j=.6-D*D-P*P-T*T;if(j<0)h=0;else{let i=L+f+t[B+m+t[k+v]];j*=j,h=j*j*(e[i]*D+r[i]*P+n[i]*T)}let N=.6-z*z-E*E-I*I;if(N<0)c=0;else{let i=L+1+t[B+1+t[k+1]];N*=N,c=N*N*(e[i]*z+r[i]*E+n[i]*I)}return 32*(s+l+h+c)}}((0,Wl.default)(a.seed));if(!0===i.useCenter){let t={x:i.count[0]%2===0?2:1,y:i.count[1]%2===0?2:1,z:i.count[2]%2===0?2:1},e=new n.Vector3(i.size[0]*(i.count[0]-t.x)*.5,i.size[1]*(i.count[1]-t.y)*.5,i.size[2]*(i.count[2]-t.z)*.5);for(let n=0;n<i.count[0];n++)for(let t=0;t<i.count[1];t++)for(let h=0;h<i.count[2];h++){let c=[(n+1)*(a.freqScale/10)+a.movement,(t+1)*(a.freqScale/10)+a.movement,(h+1)*(a.freqScale/10)+a.movement],u=s?uv.noise(...c):l(...c),d=this.children[r++];d.scale.x=1+o(r,Im(u,a.scale[0]))||tv,d.scale.y=1+o(r,Im(u,a.scale[1]))||tv,d.scale.z=1+o(r,Im(u,a.scale[2]))||tv;let p=o(r,Im(u,a.rotation[0])),f=o(r,Im(u,a.rotation[1])),m=o(r,Im(u,a.rotation[2]));d.rotation.set(p,f,m),d.position.x=i.size[0]*n-e.x+o(r,Im(u,a.position[0])),d.position.y=i.size[1]*t-e.y+o(r,Im(u,a.position[1])),d.position.z=i.size[2]*h-e.z+o(r,Im(u,a.position[2]))}}else for(let n=0;n<i.count[0];n++)for(let t=0;t<i.count[1];t++)for(let e=0;e<i.count[2];e++){let h=[(n+1)*(a.freqScale/10)+a.movement,(t+1)*(a.freqScale/10)+a.movement,(e+1)*(a.freqScale/10)+a.movement],c=s?uv.noise(...h):l(...h),u=this.children[r++];u.scale.x=1+o(r,Im(c,a.scale[0]))||tv,u.scale.y=1+o(r,Im(c,a.scale[1]))||tv,u.scale.z=1+o(r,Im(c,a.scale[2]))||tv;let d=o(r,Im(c,a.rotation[0])),p=o(r,Im(c,a.rotation[1])),f=o(r,Im(c,a.rotation[2]));u.rotation.set(d,p,f),u.position.x=i.size[0]*n+o(r,Im(c,a.position[0])),u.position.y=-i.size[1]*t+o(r,Im(c,a.position[1])),u.position.z=-i.size[2]*e+o(r,Im(c,a.position[2]))}}_updateToObject(t){var e,r;if("toObject"!==t.type)throw new Error;let{toObject:i}=t,a=new n.Euler(i.rotation[0],i.rotation[1],i.rotation[2]),o=null!==(e=t.randomnessObject)&&void 0!==e?e:as.defaultData([1,1,1]).randomnessObject,s="perlin"===o.noiseType;uv.noiseSeed(o.seed);let l=th((0,Wl.default)(o.seed)),h=Em(o.strength,this.parameters.randomness);if(!i.object){for(let[,t]of this.children.entries())t.position.set(0,0,0),t.scale.setScalar(1),t.rotation.set(0,0,0);return void(this.objectForSample=void 0)}if(!this.objectForSample)return;if(this.objectForSample instanceof $m){if(null===(r=this.objectForSample.font)||void 0===r||!r.isLoaded||void 0===this.objectForSample.geometry.attributes.position)return void(this._pendingMediaLoad=!0);this._pendingMediaLoad=!1}if(void 0===this.objectForSample.geometry&&this.objectForSample.isAncestorOf(this.object.uuid))return void console.warn('Oh no! The object "'.concat(this.object.name,'" (').concat(this.object.uuid,") seem to be a child/descendant of the object it's being cloned to. Please re-parent it so that they are siblings instead."));let c=this.getSubdivData(),u=[],d=t=>{let e=t.length;return[t.map((t=>t[0])).reduce(((t,e)=>t+e),0)/e,t.map((t=>t[1])).reduce(((t,e)=>t+e),0)/e,t.map((t=>t[2])).reduce(((t,e)=>t+e),0)/e]},p=t=>Math.round(1e6*t)/1e6;c.forEach((t=>{let e=c.filter((e=>p(t.pos[0])===p(e.pos[0])&&p(t.pos[1])===p(e.pos[1])&&p(t.pos[2])===p(e.pos[2])));e.length>1?u.push({pos:t.pos,norm:d(e.map((t=>t.norm)))}):u.push(t)}));let f=function(t){let e=[],r={};for(var n=0,i=t.length;n<i;n++){var a=JSON.stringify(t[n].pos.map((t=>Math.round(1e4*t)/1e4)));r[a]||(e.push(t[n]),r[a]=!0)}return e}(u);if(f.length>0){let t=Math.round(f.length*i.count/100);this._updateCount(t)}else{let t=this.objectForSample.geometry.getAttribute("position");if(!t||isNaN(t.count)||0===t.count)return void console.warn('Oh no! The object "'.concat(this.object.name,'" (').concat(this.object.uuid,') cannot be cloned on the surface of "').concat(this.objectForSample.name,'" (').concat(this.objectForSample.uuid,") because the latter does not have a valid geometry."))}this.objectForSample.updateMatrixWorld();let m=new ih(this.objectForSample).build(),v=Tm[i.axis],g=this.children;m.setRandomGenerator((0,Wl.default)(this.object.uuid+i.seed));for(let[y,b]of g.entries()){let t=y*(o.freqScale/10)+o.movement,e=s?uv.noise(t):l(t,t),r=y+1,c=h(r,Im(e,o.rotation[0])),u=h(r,Im(e,o.rotation[1])),d=h(r,Im(e,o.rotation[2]));"random"===i.spreadType?m.sample(sv,lv):(f.length&&(sv.fromArray(f[y].pos),lv.fromArray(f[y].norm)),this.objectForSample instanceof Pm&&sv.applyMatrix4(nv.copy(this.objectForSample.matrixWorld).invert())),sv.applyMatrix4(this.object.hiddenMatrix.clone().invert()),b.position.copy(sv),av.fromArray(v);let p="normal"===i.align?lv:this.object.getWorldDirection(cv),g=ov.fromArray(i.position);ov.x+=ov.x+h(r,Im(e,o.position[0])),ov.y+=ov.y+h(r,Im(e,o.position[1])),ov.z+=ov.z+h(r,Im(e,o.position[2]));let x=Math.acos(p.dot(av)),w=hv.crossVectors(av,p).normalize(),_=iv.makeRotationAxis(w,x),S=p.clone().cross(this.object.up).normalize(),A=S.clone().cross(p).normalize(),M=(new n.Matrix4).makeBasis(S,p,A),C=new n.Vector3(av.y,av.z,av.x).normalize(),O=C.clone().cross(av).normalize(),D=(new n.Matrix4).makeBasis(C,av,O).invert(),P=(new n.Matrix4).multiplyMatrices(M,D);b.rotation.setFromRotationMatrix(P),g.applyMatrix4(_),b.position.add(g),b.rotation.x=b.rotation.x+a.x+c,b.rotation.y=b.rotation.y+a.y+u,b.rotation.z=b.rotation.z+a.z+d,b.scale.setScalar(1),b.scale.x=b.scale.x+i.scale[0]+h(r,Im(e,o.scale[0]))||tv,b.scale.y=b.scale.y+i.scale[1]+h(r,Im(e,o.scale[1]))||tv,b.scale.z=b.scale.z+i.scale[2]+h(r,Im(e,o.scale[2]))||tv,b.scale.multiply(this.object.scale),b.hiddenMatrix=this.object.hiddenMatrix}}getSubdivData(){if(!this.objectForSample)return[];let t=this.parameters.toObject.spreadType;if("random"===t)return[];if(this.objectForSample instanceof Pm){let e=this.objectForSample,r=zm[t],n=Jm[r],i=Zm[r],a=Km[r],o=[],s=n(e.subdivPointerNew);for(let t=0;t<=s-1;t++){let r=i(e.subdivPointerNew,t),n=a(e.subdivPointerNew,t);ev.fromArray(r).applyMatrix4(e.matrixWorld),rv.fromArray(n),o.push({pos:ev.toArray(),norm:rv.toArray()})}return o}return(this.objectForSample.geometry.index?function(t){let e=[];for(let r=0;r<=t.index.count;r++)if(Nm.fromArray(t.index.array,3*r),jm.setFromAttributeAndIndices(t.attributes.position,Nm.x,Nm.y,Nm.z),jm.getNormal(Rm),jm.getMidpoint(Fm),!(isNaN(Fm.x)||isNaN(Fm.y)||isNaN(Fm.z))){let{a:t,b:r,c:n}=jm,i=t.toArray(),a=r.toArray(),o=n.toArray(),s=t.distanceTo(r),l=r.distanceTo(n),h=n.distanceTo(t),c=Um(i,a),u=Um(a,o),d=Um(o,i),p=[s,l,h],f=Math.max(...p),m=p.filter((t=>Math.round(t)===Math.round(f))).length>1,v=[],g=jm.getMidpoint(Fm).toArray();f===s&&!m&&(v=[u,d,d],g=c),f===l&&!m&&(v=[c,d,d],g=u),f===h&&!m&&(v=[c,u,u],g=d),m&&(v=[c,u,d]),e.push({vertices:[i,a,o],faceCenters:v,midpoint:g,norm:jm.getNormal(Rm).toArray()})}return e}(this.objectForSample.geometry):function(t){let e=[],{position:r}=t.attributes;for(let n=0;n<r.count;n++){jm.setFromAttributeAndIndices(r,3*n,3*n+1,3*n+2),jm.getNormal(Rm),jm.getMidpoint(Fm);let t=jm.a.toArray(),i=jm.b.toArray(),a=jm.c.toArray();e.push({vertices:[t,i,a],faceCenters:[Um(t,i),Um(i,a),Um(a,t)],midpoint:Fm.toArray(),norm:Rm.toArray()})}return e}(this.objectForSample.geometry)).map(((e,r)=>"polygon_center"===t?{pos:e.midpoint,norm:e.norm}:"vertex"===t?[{pos:e.vertices[0],norm:e.norm},{pos:e.vertices[1],norm:e.norm},{pos:e.vertices[2],norm:e.norm}]:"edge"===t?[{pos:e.faceCenters[0],norm:e.norm},{pos:e.faceCenters[1],norm:e.norm},{pos:e.faceCenters[2],norm:e.norm}]:[])).flat()}updateState(t,e){var r;if(this.parameters=Nn(t),"toObject"!==this.parameters.type)(null===this.parent||this.parent!==this.object)&&(this.removeFromParent(),null!==(r=this.object.parent)&&void 0!==r&&r.add(this),this.matrix=this.object.matrix,this.hiddenMatrix=this.object.hiddenMatrix,this.matrixWorldNeedsUpdate=!0,this.matrixAutoUpdate=!1);else if(null===this.parent||this.parent.uuid!==this.parameters.toObject.object){this.removeFromParent();let t=e.find(this.parameters.toObject.object);this.objectForSample=t instanceof Ld?t:void 0,this.matrix=new n.Matrix4,this.hiddenMatrix=new n.Matrix4,this.matrixWorldNeedsUpdate=!0,this.matrixAutoUpdate=!1,t&&t.add(this)}this.update()}get pendingMediaLoad(){return this._pendingMediaLoad}},pv=t=>{var e;return(e=class extends t{}).geometryHelper=new n.BoxGeometry(30,30,30),e},fv=new n.Ray,mv=new n.Sphere,vv=new n.Matrix4,gv=function(t,e,r,i){let a=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=e,s=t.matrixWorld;if(null===o.boundingSphere&&o.computeBoundingSphere(),mv.copy(o.boundingSphere),mv.applyMatrix4(s),!1===r.ray.intersectsSphere(mv)||(vv.copy(s).invert(),fv.copy(r.ray).applyMatrix4(vv),null!==o.boundingBox&&!1===fv.intersectsBox(o.boundingBox)))return;let l,h,c,u,d,p,f=o.index,m=o.attributes.position,v=o.drawRange;if(!1===a){for(d=Math.max(0,v.start),p=Math.min(f.count,v.start+v.count);d<p;d+=3)if(h=f.getX(d),c=f.getX(d+1),u=f.getX(d+2),l=g(t,r,fv,m,h,c,u),l)return l.faceIndex=Math.floor(d/3),void i.push(l)}else{let e=o.attributes.position,a=new n.Vector3,s=new n.Vector3,l=new n.Vector3,h=new n.Vector3,c=2,u=1/((t.scale.x+t.scale.y+t.scale.z)/3),d=u*u;for(let n=Math.max(0,v.start),o=Math.min(e.count,v.start+v.count)-1;n<o;n+=c){if(a.fromBufferAttribute(e,n),s.fromBufferAttribute(e,n+1),fv.distanceSqToSegment(a,s,h,l)>d)continue;h.applyMatrix4(t.matrixWorld);let o=r.ray.origin.distanceTo(h);o<r.near||o>r.far||i.push({distance:o,point:l.clone().applyMatrix4(t.matrixWorld),object:t})}}function g(t,e,r,i,a,o,s){let l=new n.Vector3,h=new n.Vector3,c=new n.Vector3,u=new n.Vector3,d=new n.Vector3;if(l.fromBufferAttribute(i,a),h.fromBufferAttribute(i,o),c.fromBufferAttribute(i,s),null===r.intersectTriangle(l,h,c,!1,u))return null;d.copy(u),d.applyMatrix4(t.matrixWorld);let p=e.ray.origin.distanceTo(d);return p<e.near||p>e.far?null:{faceIndex:1,distance:p,point:d.clone(),object:t}}},yv=new n.Vector3,bv=new n.Camera,xv=class extends n.LineSegments{constructor(t){let e=new n.BufferGeometry,r=new n.LineBasicMaterial({color:16777215,vertexColors:!0,toneMapped:!1}),i=[],a=[],o={},s=new n.Color(15711266),l=new n.Color(15711266),h=new n.Color(2857471);function c(t,e,r){u(t,r),u(e,r)}function u(t,e){i.push(0,0,0),a.push(e.r,e.g,e.b),void 0===o[t]&&(o[t]=[]),o[t].push(i.length/3-1)}c("n1","n2",s),c("n2","n4",s),c("n4","n3",s),c("n3","n1",s),c("f1","f2",s),c("f2","f4",s),c("f4","f3",s),c("f3","f1",s),c("n1","f1",s),c("n2","f2",s),c("n3","f3",s),c("n4","f4",s),c("p","n1",l),c("p","n2",l),c("p","n3",l),c("p","n4",l),c("u1","u2",h),c("u2","u3",h),c("u3","u1",h),e.setAttribute("position",new n.Float32BufferAttribute(i,3)),e.setAttribute("color",new n.Float32BufferAttribute(a,3)),super(e,r),this.type="CameraHelper",this.camera=t,this.camera.updateProjectionMatrix&&this.camera.updateProjectionMatrix(),this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1,this.pointMap=o,this.update()}update(){let t=this.geometry,e=this.pointMap;bv.projectionMatrixInverse.elements=[.5112609807824982,-0,-0,-0,-0,.41421356237309503,-0,-0,-0,-0,-0,-.099999,-0,-0,-1.0000000000000002,.100001];let r=.8;wv("n1",e,t,bv,-1,-1,r),wv("n2",e,t,bv,1,-1,r),wv("n3",e,t,bv,-1,1,r),wv("n4",e,t,bv,1,1,r);let n=r;wv("f1",e,t,bv,-1,-1,n),wv("f2",e,t,bv,1,-1,n),wv("f3",e,t,bv,-1,1,n),wv("f4",e,t,bv,1,1,n);let i=n;wv("u1",e,t,bv,.35,1.1,i),wv("u2",e,t,bv,-.35,1.1,i),wv("u3",e,t,bv,0,1.55,i),t.getAttribute("position").needsUpdate=!0}dispose(){this.geometry.dispose(),this.material.dispose()}};function wv(t,e,r,n,i,a,o){yv.set(i,a,o).unproject(n);let s=e[t];if(void 0!==s){let t=r.getAttribute("position");for(let e=0,r=s.length;e<r;e++)t.setXYZ(s[e],yv.x,yv.y,yv.z)}}var _v,Sv=class extends(pv(xv)){constructor(t){super(t),this.object=t,this.object=t,this.name="CombinedCameraHelper: ".concat(t.uuid)}updateMatrixWorld(t){super.updateMatrixWorld(t),this.updateTarget()}updateTarget(){let t=this.object.getTarget();this.updateWorldMatrix(!0,!1),this.worldToLocal(t)}raycast(t,e){gv(this.object,this.geometry,t,e,!0)}};(t=>{t.is=t=>"objectHelper"in t})(_v||(_v={}));var Av,Mv=(t,e)=>class extends(Eh(t)){constructor(){super(...arguments),this.objectHelper=new e(this),this.gizmos={}}get geometryHelper(){return e.geometryHelper}raycast(t,e){this.objectHelper.raycast(t,e)}showGizmos(){for(let t in this.gizmos){let e=this.gizmos[t];e instanceof n.Box3Helper&&(e.visible=!0)}}updateEntityBoxSize(t,e){this.objectHelper.visible&&this.geometryHelper instanceof n.BoxGeometry?(t.setScalar(0),e.set(this.geometryHelper.parameters.width,this.geometryHelper.parameters.height,this.geometryHelper.parameters.height).multiplyScalar(.5)):super.updateEntityBoxSize(t,e)}hideGizmos(){for(let t in this.gizmos){let e=this.gizmos[t];e instanceof n.Box3Helper&&(e.visible=!1)}}},Cv=new n.Vector3,Ov=new n.Vector3,Dv=new n.Quaternion,Pv=new n.Vector3,Tv=new n.Vector3,zv=new n.Vector3,Ev=class extends(Mv(n.Camera,Sv)){constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{...Js.defaultData,name:""};super(),this._cameraType="OrthographicCamera",this.targetOffset=is.DefaultTargetOffset,this.isUpVectorFlipped=!1,this.angleOffsetFromUp=0,this.wasMovedByUser=!1,this.wasMovedBySwitchCameraAction=!1,this.super_Entity(t,e),this.previousProjectionMatrix=new n.Matrix4,this.matrixAutoUpdate=!0,this.width=window.innerWidth,this.height=window.innerHeight;let r=this.width,i=this.height;this.orthoCamera=new n.OrthographicCamera(-.5*r,.5*r,.5*i,-.5*i,-5e4,1e4),this.perspCamera=new n.PerspectiveCamera(45,r/i,50,1e4),this.left=this.orthoCamera.left,this.right=this.orthoCamera.right,this.top=this.orthoCamera.top,this.bottom=this.orthoCamera.bottom,this.far=this.orthoCamera.far,this.view=this.orthoCamera.view,this.aspect=this.perspCamera.aspect,this.focus=this.perspCamera.focus,this.filmGauge=this.perspCamera.filmGauge,this.filmOffset=this.perspCamera.filmOffset,this.objectHelper.update()}get isPerspectiveCamera(){return"PerspectiveCamera"===this.cameraType}get isOrthographicCamera(){return!this.isPerspectiveCamera}get cameraType(){return this._cameraType}set fov(t){this.perspCamera.fov=t}get fov(){return this.perspCamera.fov}setNear(t,e){"PerspectiveCamera"===t?this.perspCamera.near=e:this.orthoCamera.near=e}setZoom(t,e){e>=0&&("PerspectiveCamera"===t?this.perspCamera.zoom=e:this.orthoCamera.zoom=e)}set cameraType(t){"PerspectiveCamera"===t?this.toPerspective():"OrthographicCamera"===t&&this.toOrthographic()}get near(){return"PerspectiveCamera"===this._cameraType?this.perspCamera.near:this.orthoCamera.near}set near(t){"PerspectiveCamera"===this._cameraType?this.perspCamera.near=t:this.orthoCamera.near=t}get zoom(){return"PerspectiveCamera"===this._cameraType?this.perspCamera.zoom:this.orthoCamera.zoom}set zoom(t){t>=0&&("PerspectiveCamera"===this._cameraType?this.perspCamera.zoom=t:this.orthoCamera.zoom=t)}lookAt(t,e,r){"number"==typeof t&&(t=new n.Vector3(t,e,r)),super.lookAt(t),this.getWorldPosition(Cv),this.targetOffset=Cv.distanceTo(t)}getTarget(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new n.Vector3;return this.getWorldDirection(Ov),this.getWorldPosition(Cv),Ov.multiplyScalar(this.targetOffset),t.copy(Cv).add(Ov),t}getDistanceToTarget(){let t=this.getTarget();return this.getWorldPosition(Cv),Cv.distanceTo(t)}updateUp(){this.getWorldQuaternion(Dv),Pv.set(0,0,1).applyQuaternion(Dv),Tv.copy(n.Object3D.DEFAULT_UP),this.isUpVectorFlipped&&Tv.negate(),Tv.applyQuaternion(Dv),zv.copy(n.Object3D.DEFAULT_UP).projectOnPlane(Pv),this.angleOffsetFromUp=zv.angleTo(Tv),this.angleOffsetFromUp*=zv.cross(Tv).dot(Pv)>=0?1:-1}updateTransformState(t,e){let r=super.updateTransformState(t,e);return void 0!==t.isUpVectorFlipped&&(this.isUpVectorFlipped=t.isUpVectorFlipped),this.updateUp(),r}getViewFrontToObject(t){let e=t.getWorldPosition(new n.Vector3),r=t.getWorldDirection(new n.Vector3).multiplyScalar(this.targetOffset);return{position:e.clone().add(r),target:e}}getViewToTarget(t){let e=this.getWorldDirection(new n.Vector3).multiplyScalar(this.targetOffset);return{position:t.clone().sub(e),target:t}}getViewToObject(t){let e=new n.Vector3;t.getWorldPosition(e);return this.getViewToTarget(e)}setViewplaneSize(t,e){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this.aspect=t/e,r){let r=t>e?this.aspect:1,n=t>e?1:this.aspect;this.left=-395*r,this.right=395*r,this.top=1/n*395,this.bottom=1/n*-395}else this.left=.5*-t,this.right=.5*t,this.top=.5*e,this.bottom=.5*-e;this.updateProjectionMatrix()}copyViewPlaneSize(t){this.aspect=t.aspect,this.left=t.left,this.right=t.right,this.top=t.top,this.bottom=t.bottom,this.updateProjectionMatrix()}toOrthographic(){this.orthoCamera.left=this.left,this.orthoCamera.right=this.right,this.orthoCamera.top=this.top,this.orthoCamera.bottom=this.bottom,this.orthoCamera.view=this.view,this.orthoCamera.far=this.far,this.orthoCamera.updateProjectionMatrix(),this.projectionMatrix=this.orthoCamera.projectionMatrix,this.projectionMatrixInverse=this.orthoCamera.projectionMatrixInverse,this._cameraType="OrthographicCamera",this.objectHelper&&this.objectHelper.update()}toPerspective(){this.perspCamera.aspect=this.aspect,this.perspCamera.fov=this.fov,this.perspCamera.view=this.view,this.perspCamera.far=this.far,this.perspCamera.updateProjectionMatrix(),this.projectionMatrix=this.perspCamera.projectionMatrix,this.projectionMatrixInverse=this.perspCamera.projectionMatrixInverse,this._cameraType="PerspectiveCamera",this.objectHelper&&this.objectHelper.update()}setFocalLength(t){this.perspCamera.setFocalLength(t),this.toPerspective()}getFocalLength(){return this.perspCamera.getFocalLength()}getEffectiveFOV(){return this.perspCamera.getEffectiveFOV()}getFilmWidth(){return this.perspCamera.getFilmWidth()}getFilmHeight(){return this.perspCamera.getFilmHeight()}setViewOffset(t,e,r,n,i,a){"PerspectiveCamera"===this._cameraType?this.perspCamera.setViewOffset(t,e,r,n,i,a):this.orthoCamera.setViewOffset(t,e,r,n,i,a)}clearViewOffset(){"PerspectiveCamera"===this._cameraType?(this.perspCamera.clearViewOffset(),this.toPerspective()):(this.orthoCamera.clearViewOffset(),this.toOrthographic())}copyHistory(){this.previousProjectionMatrix&&this.previousProjectionMatrix.copy(this.projectionMatrix)}updateProjectionMatrix(){"PerspectiveCamera"===this._cameraType?this.toPerspective():"OrthographicCamera"===this._cameraType&&this.toOrthographic()}updateMatrixWorld(t){super.updateMatrixWorld(t),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(t,e){super.updateWorldMatrix(t,e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}copy(t,e){return super.copy(t,e),this.parent=t.parent,this.orthoCamera.copy(t.orthoCamera),this.perspCamera.copy(t.perspCamera),this.left=t.left,this.right=t.right,this.top=t.top,this.bottom=t.bottom,this.far=t.far,this.view=null===t.view?null:Object.assign({},t.view),this._cameraType=t._cameraType,this.aspect=t.aspect,this.fov=t.fov,this.focus=t.focus,this.filmGauge=t.filmGauge,this.filmOffset=t.filmOffset,this.targetOffset=t.targetOffset,this.updateProjectionMatrix(),this}toCameraState(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e={type:this.cameraType,far:this.far,orthographic:{near:this.orthoCamera.near,zoom:this.orthoCamera.zoom},perspective:{near:this.perspCamera.near,fov:this.perspCamera.fov,zoom:this.perspCamera.zoom},up:this.up.toArray(),targetOffset:this.targetOffset,isUpVectorFlipped:this.isUpVectorFlipped};return vi(e,t)}updateCameraSubtype(t,e){let r="perspective"===t?"PerspectiveCamera":"OrthographicCamera";void 0!==e.zoom&&this.setZoom(r,e.zoom),void 0!==e.near&&this.setNear(r,e.near),void 0!==e.fov&&"PerspectiveCamera"===r&&(this.fov=e.fov)}updateState(t,e){this.updateCameraState(t,e)}updateCameraState(t,e){this.updateState_Entity(t,e),void 0!==t.far&&(this.far=t.far),void 0!==t.orthographic&&this.updateCameraSubtype("orthographic",t.orthographic),void 0!==t.perspective&&this.updateCameraSubtype("perspective",t.perspective),void 0!==t.type&&(this.cameraType=t.type),void 0!==t.up&&this.up.fromArray(t.up),void 0!==t.targetOffset&&(this.targetOffset=t.targetOffset),void 0!==t.isUpVectorFlipped&&(this.isUpVectorFlipped=t.isUpVectorFlipped),this.updateProjectionMatrix()}updateByPatchedOp(t,e,r){super.updateByPatchedOp(t,e,r),1===t.path.length&&0===t.type&&this.updateCameraSubtype(t.path[0],t.props)}toState(t){return{...super.toState(t),...this.toCameraState(t),type:this.cameraType}}},Iv=new n.Matrix4,Lv=new n.Matrix4,Bv=new n.Matrix4,kv=new n.Vector3,Vv=new n.Vector3,Uv=class extends gm{constructor(t,e,r){super(t,e),this.data=e,this.meshSetAddresses=[],this.needsTransformForDownstream=!1,this.geometry=new n.BufferGeometry,this.onAfterRender=(t,e,r,n,i,a)=>{super.onAfterRender(t,e,r,n,i,a),this.recomputeBoolean()},this.geometry.userData.parameters={width:0,height:0,depth:0}}get booleanOp(){return this.data.geometry.operation}get phongAngle(){var t;return null!==(t=this.data.geometry.phongAngle)&&void 0!==t?t:45}get isLOD(){return this.recomputeBoolean(),!1}updateByPatchedOp(t,e,r){super.updateByPatchedOp(t,e,r),1===t.path.length&&"geometry"===t.path[0]&&0===t.type&&void 0!==t.props.operation&&(this.freeBooleanPointer(),this.resetBBoxNeedsUpdate())}freeBooleanPointer(){super.freeBooleanPointer(),this.geometry.dispose()}recomputeBoolean(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(-1!==this.booleanMeshSetAddress&&!t)return;for(let n=0;n<this.children.length;n++){let r=this.children[n];r instanceof Uv&&!0===r.dataPatched.visible&&r.recomputeBoolean(!0===t,e)}this.meshSetAddresses=[];for(let n=0;n<this.children.length;n++){var r;let a=this.children[n];if(a instanceof Ld&&!0===a.dataPatched.visible&&(null===(r=a.geometry.attributes.position)||void 0===r?void 0:r.count)>0&&a.geometry.drawRange.count>0&&0!==a.booleanMeshSetAddress){Iv.multiplyMatrices(a.hiddenMatrix,a.matrix);try{if(-1===a.booleanMeshSetAddress){var i;if((null!==(i=a.geometry.index)&&void 0!==i?i:a.geometry.getAttribute("position")).count/3<15e5&&(a.booleanMeshSetAddress=fd.getMeshSet(a.geometry,!0===t,e)),-1===a.booleanMeshSetAddress)return;fd.transformMeshSet(a.booleanMeshSetAddress,Iv),a.booleanMatrixInvOld.copy(Iv).invert(),a.booleanWasTransformed=!1}else a instanceof Uv&&!0===a.needsTransformForDownstream?(fd.transformMeshSet(a.booleanMeshSetAddress,Iv),a.needsTransformForDownstream=!1):!0===a.booleanWasTransformed&&(fd.transformMeshSet(a.booleanMeshSetAddress,Lv.multiplyMatrices(Iv,a.booleanMatrixInvOld)),a.booleanMatrixInvOld.copy(Iv).invert(),a.booleanWasTransformed=!1)}catch(Ho){console.error(Ho),a.booleanMeshSetAddress=0,a.geometry.userData.booleanOperationDidFail=!0;continue}!1===fd.hasOpenEdges(a.booleanMeshSetAddress)||n===this.children.length-1&&2===this.booleanOp?(this.meshSetAddresses.push(a.booleanMeshSetAddress),a.geometry.userData.booleanOperationDidFail=!1):a.geometry.userData.booleanOperationDidFail="openEdges"}}if(0===this.meshSetAddresses.length)return this.geometry.setAttribute("position",new n.Float32BufferAttribute([],0)),void this.geometry.setDrawRange(0,0);if(!0===t)return fd.calcBooleanTopological(this.meshSetAddresses,this.booleanOp);let a=this.geometry;a.dispose(),this.geometry=new n.BufferGeometry,this.geometry.userData=a.userData,this.geometry.boundingSphere=a.boundingSphere;try{this.booleanMeshSetAddress=fd.calcBoolean(this.meshSetAddresses,this.booleanOp,this.geometry,this.phongAngle)}catch(rs){this.booleanMeshSetAddress=0,this.geometry.userData.booleanOperationDidFail=!0,console.error(rs)}this.booleanMatrixInvOld.copy(this.matrix).invert(),this.needsTransformForDownstream=!0,Am(this),Mm(this)}dispose(){super.dispose(),this.geometry.dispose()}get recursiveBBox(){var t;let e=super.recursiveBBox;return-1===(null===(t=this.geometry.boundingSphere)||void 0===t?void 0:t.radius)&&(e.getCenter(this.geometry.boundingSphere.center),Bv.copy(this.matrixWorld).invert(),this.geometry.boundingSphere.center.applyMatrix4(Bv),kv.copy(e.max).applyMatrix4(Bv),Vv.copy(e.min).applyMatrix4(Bv),this.geometry.boundingSphere.radius=kv.distanceTo(Vv)/2),e}};(t=>{t.is=function(t){return hh.is(t)&&t instanceof n.Light}})(Av||(Av={}));var jv=(t,e)=>class extends(Mv(t,e)){updateState_Light(t,e){this.updateState_Entity(t,e),void 0!==t.color&&(this.color=e.shared.color(t.color)),void 0!==t.intensity&&(this.intensity=t.intensity),void 0!==t.depth&&(this.shadow.camera.far=t.depth,this.shadow.needsUpdate=!0),void 0!==t.shadows&&(this.castShadow=t.shadows)}},Nv=t=>t instanceof Ld,Rv=t=>null!==t&&t instanceof Uv,Fv=t=>_v.is(t),Gv=class extends(pv(n.AxesHelper)){constructor(t){super(arguments.length>1&&void 0!==arguments[1]?arguments[1]:15),this.object=t,this.object.updateMatrixWorld(),this.name="EmptyObjectHelper: ".concat(t.uuid),this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1,this.object.isBone&&(this.visible=!1)}raycast(t,e){gv(this.object,Gv.geometryHelper,t,e)}update(){}},qv=class extends(Mv(n.Group,Gv)){constructor(t,e){super(),this.super_Entity(t,e),this.objectHelper.update()}updateState(t,e){this.updateState_Entity(t,e),"buffer"in t&&1===Object.keys(t).length&&e.scene.reloadSplats()}},Hv=n.ShaderChunk.lights_fragment_begin,Wv=n.ShaderChunk.shadowmask_pars_fragment,Xv=null,Yv=class extends(pv(n.DirectionalLightHelper)){constructor(t){super(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:15,arguments.length>2&&void 0!==arguments[2]?arguments[2]:10066329),this.object=t,this.added=!1,this.name="DirectionalLightHelper: ".concat(t.uuid)}raycast(t,e){gv(this.object,Yv.geometryHelper,t,e)}},Qv=class extends(pv(n.PointLightHelper)){constructor(t){super(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:15,arguments.length>2&&void 0!==arguments[2]?arguments[2]:6710886),this.object=t,this.name="PointLightHelper: ".concat(t.uuid)}raycast(t,e){gv(this.object,Qv.geometryHelper,t,e)}},Zv=class extends(pv(n.SpotLightHelper)){constructor(t){super(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:6710886),this.object=t,this.name="SpotLightHelper: ".concat(t.uuid)}raycast(t,e){gv(this.object,Zv.geometryHelper,t,e)}update(){if(void 0!==this.object){let t=Zv._vector,e=this.object.distance?this.object.distance:1e3,r=e*Math.tan(this.object.angle);this.cone.scale.set(r,r,e),t.setFromMatrixPosition(this.object.target.matrixWorld),this.cone.lookAt(t);let n=void 0!==this.color?this.color:this.light.color;if(this.cone.material instanceof Array)for(let i=0,a=this.cone.material.length;i<a;i++)this.cone.material[i].color.set(n);else this.cone.material.color.set(n)}}},Kv=Zv;Kv._vector=new n.Vector3;var Jv=class extends(jv(n.DirectionalLight,Yv)){constructor(t,e,r){super(),this.super_Entity(t,e),this.castShadow=!0,this.shadow.mapSize.width=2048,this.shadow.mapSize.height=2048,this.shadow.normalBias=1,this.layers.enable(3);let i=this.shadow.camera;i.top=1250,i.bottom=-1250,i.right=1250,i.left=-1250,i.near=-1e4,i.far=2500;let a=new n.CameraHelper(this.shadow.camera);a.visible=!1,this.gizmos.shadowmap=a}update(){this.shadow.camera.updateProjectionMatrix();for(let t in this.gizmos){let e=this.gizmos[t];e instanceof n.CameraHelper&&e.update()}}updateMatrixWorld(t){super.updateMatrixWorld(t),this.objectHelper&&this.objectHelper.update()}updateState(t,e){this.updateState_Light(t,e);let r=void 0!==t.depth&&t.depth!==this.shadow.camera.far||void 0!==t.size&&t.size/2!==this.shadow.camera.right;void 0!==t.size&&function(t,e){t.shadow.camera.right=e/2,t.shadow.camera.left=-e/2,t.shadow.camera.top=e/2,t.shadow.camera.bottom=-e/2,t.shadow.needsUpdate=!0}(this,t.size),void 0!==t.shadowRadius&&(this.shadow.radius=t.shadowRadius),void 0!==t.shadowResolution&&(this.shadow.mapSize.set(t.shadowResolution,t.shadowResolution),this.shadow.map&&(this.shadow.map.dispose(),this.shadow.map=null)),void 0!==t.penumbraSize&&e.scene.markPenumbraSizeDirty(),r&&this.update()}},$v=new n.Vector3,tg=new n.Vector3,eg=new n.Quaternion,rg=class extends(jv(n.SpotLight,Kv)){constructor(t,e,r){super(),this.super_Entity(t,e),this.castShadow=!0,this.shadow.mapSize.width=1024,this.shadow.mapSize.height=1024,this.shadow.normalBias=1,this.layers.enable(3);let i=this.shadow.camera;i.fov=2*n.MathUtils.RAD2DEG*this.angle,i.aspect=1,i.near=100,i.far=2500;let a=new n.CameraHelper(this.shadow.camera);a.visible=!1,this.gizmos.shadowmap=a,this.update()}update(){this.shadow.camera.updateProjectionMatrix();for(let t in this.gizmos){let e=this.gizmos[t];e instanceof n.CameraHelper&&e.update()}}updateMatrixWorld(t){super.updateMatrixWorld(t),tg.setFromMatrixPosition(this.matrixWorld),eg.setFromRotationMatrix(this.matrixWorld),$v.copy(this.up).applyQuaternion(eg).negate().multiplyScalar(this.distance),this.target.position.copy(tg).add($v),this.target.updateMatrixWorld(),this.objectHelper&&this.objectHelper.update()}updateState(t,e){this.updateState_Light(t,e),void 0!==t.distance&&(this.distance=t.distance),void 0!==t.decay&&(this.decay=t.decay),void 0!==t.angle&&(this.angle=t.angle),void 0!==t.penumbra&&(this.penumbra=t.penumbra),void 0!==t.shadowRadius&&(this.shadow.radius=t.shadowRadius),void 0!==t.penumbraSize&&e.scene.markPenumbraSizeDirty(),void 0!==t.shadowResolution&&(this.shadow.mapSize.set(t.shadowResolution,t.shadowResolution),this.shadow.map&&(this.shadow.map.dispose(),this.shadow.map=null))}},ng=class extends(Eh(n.Scene)){constructor(t,e){super(),this.data=e,this.bgColor=new Fd(1,1,1,1),this.fog=null,this.backupFog=new n.Fog(16777215,.1,2e3),this.fogUseBGColor=!1,this.isActive=!1,this.aoColor=new n.Color,this.penumbraSizeArrayCache=null,this.super_Entity(t,e),this.personalCamera=new Ev(ss,{...Js.defaultData,...e.camera,name:"Personal Camera"}),this.personalCamera.objectHelper.visible=!1,this.add(this.personalCamera),this.activeCamera=this.personalCamera,this.ambientLight=new n.HemisphereLight(13882323,8553090,.75),this.ambientLight.name="Default Ambient Light",this.ambientLight.layers.enable(3),this.ambientLight.removeFromParent(),this.add(this.ambientLight)}get scene(){return this.parent}get postprocessing(){return this.data.postprocessing}updateVisible(){}setBackgroundColor(t){this.bgColor=t,!0===this.fogUseBGColor&&(this.backupFog.color=t)}updateAmbientLight(t,e){void 0!==t.color&&(this.ambientLight.color=Tf(t.color,e)),void 0!==t.intensity&&(this.ambientLight.intensity=t.intensity),void 0!==t.enabled&&(t.enabled?this.add(this.ambientLight):this.remove(this.ambientLight))}onDeactive(){this.isActive=!1}onActive(t){this.isActive=!0,t.fog=this.fog,this.traverseEntity((t=>{t instanceof Uv&&t.recomputeBoolean()})),this.updateShadow(this.data.shadow)}forceMaterialsUpdate(){this.traverseEntity((t=>{if(t instanceof gm)if(Array.isArray(t.material))for(let e of t.material)e.needsUpdate=!0;else t.material.needsUpdate=!0,t.material.dispose()}))}updateShadow(t){void 0!==t.softShadowQuality&&this.isActive&&function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"medium";if(Xv===t)return!1;Xv=t;let e=(t=>{switch(t){case"low":return 8;case"medium":default:return 16;case"high":return 32}})(t);n.ShaderChunk.shadowmap_pars_fragment=(t=>"\n\n// PCSS implementation based on:\n// https://www.gamedev.net/articles/programming/graphics/contact-hardening-soft-shadows-made-fast-r4906/\n// NOTE: This number affects how big the shadow blur can\n// possibly get. Bigger number == bigger blur, but less precise results\n\nconst float  gPenumbraFilterSize = 80.0;\nconst int   gPenumbraSamples = ".concat(t,";\nconst int gShadowSamples = ").concat(t,";\nconst float gShadowSamplesRpc = 1.0f / float(gShadowSamples);\n\n#ifdef USE_SHADOWMAP\n    #if NUM_DIR_LIGHT_SHADOWS > 0\n\n        uniform sampler2D directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];\n        varying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\n        struct DirectionalLightShadow {\n            float shadowBias;\n            float shadowNormalBias;\n            float shadowRadius;\n            vec2 shadowMapSize;\n        };\n\n        uniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\n    #endif\n\n    #if NUM_SPOT_LIGHT_SHADOWS > 0\n\n        uniform sampler2D spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];\n        varying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_SHADOWS ];\n\n        struct SpotLightShadow {\n            float shadowBias;\n            float shadowNormalBias;\n            float shadowRadius;\n            vec2 shadowMapSize;\n        };\n\n        uniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\n    #endif\n\n    #if NUM_POINT_LIGHT_SHADOWS > 0\n\n        uniform sampler2D pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];\n        varying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\n        struct PointLightShadow {\n            float shadowBias;\n            float shadowNormalBias;\n            float shadowRadius;\n            vec2 shadowMapSize;\n            float shadowCameraNear;\n            float shadowCameraFar;\n        };\n\n        uniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\n    #endif\n\n    /*\n    #if NUM_RECT_AREA_LIGHTS > 0\n\n        // TODO (abelnation): create uniforms for area light shadows\n\n    #endif\n    */\n\nfloat computePenumbra(int index, sampler2D shadowMap, float temporalAngle, float texelSize, vec2 uv, float compare, float texelScalar, float shadowRadius)\n{\n    float penumbra = 1.0;\n    float blockerDepthAvg = 0.0;\n    float blockerCount = 0.0;\n\n    #pragma unroll_loop_start\n    for(int i = 0; i < gPenumbraSamples; i ++)\n    {\n        vec2 offset = (vogelDiskSample(i, gShadowSamples, temporalAngle) * texelSize) * texelScalar;\n        float depth = unpackRGBAToDepth( texture2D( shadowMap, uv + offset ) );\n\n        if(depth < compare + 0.0001)\n        {\n            blockerDepthAvg += depth;\n            blockerCount++;\n        }\n    }\n    #pragma unroll_loop_end\n\n    if (blockerCount > 0.0)\n    {\n        blockerDepthAvg /= blockerCount;\n\n        // Compute penumbra\n        penumbra = (compare - blockerDepthAvg) / (blockerDepthAvg);\n        penumbra *= penumbra;\n        penumbra *= 200.0 * penumbraSize[min(index, ",5," - 1)]; // Magic number that affects how quickly the penumbra grows\n\n        return clamp(penumbra, 0.00, 1.0);\n    }\n    return 0.0;\n}\n\nfloat vogelShadow(int index, sampler2D shadowMap, vec2 uv, float texelSize, float compare, float shadowRadius)\n{\n    float shadow         = 0.0f;\n\n    // NOTE: When using TAA, we should use screen space interleaved gradient noise\n    vec2 halton = haltonSequence[frameIndex];\n    float temporalOffset = getNoiseInterleavedGradient(gl_FragCoord.xy + halton);\n    float temporalAngle  = temporalOffset * PI2;\n\n    float texelScalar = (gPenumbraFilterSize) / (texelSize * 1024.);\n    float penumbra = computePenumbra(index, shadowMap, temporalAngle, texelSize, uv, compare, texelScalar, shadowRadius);\n    if (penumbra == -1.0) {\n        return 1.0;\n    }\n\n    #pragma unroll_loop_start\n    for (int i = 0; i < gShadowSamples; i++)\n    {\n        vec2 vogelSample =  vogelDiskSample(i, gShadowSamples, temporalAngle) * texelSize;\n        // Overall blurring offset\n        vec2 offset = vogelSample * (shadowRadius * 2.);\n\n        // Penumbra offset\n        offset += vogelSample * (penumbra * texelScalar);\n\n        shadow += step( compare, unpackRGBAToDepth( texture2D( shadowMap, uv + offset ) ) );\n    }\n    #pragma unroll_loop_end\n\n    return shadow * gShadowSamplesRpc;\n}\n\n\n    float texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\n\n        return step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\n\n    }\n\n    vec2 texture2DDistribution( sampler2D shadow, vec2 uv ) {\n\n        return unpackRGBATo2Half( texture2D( shadow, uv ) );\n\n    }\n\n    float VSMShadow (sampler2D shadow, vec2 uv, float compare ){\n\n        float occlusion = 1.0;\n\n        vec2 distribution = texture2DDistribution( shadow, uv );\n\n        float hard_shadow = step( compare , distribution.x ); // Hard Shadow\n\n        if (hard_shadow != 1.0 ) {\n\n            float distance = compare - distribution.x ;\n            float variance = max( 0.00000, distribution.y * distribution.y );\n            float softness_probability = variance / (variance + distance * distance ); // Chebeyshevs inequality\n            softness_probability = clamp( ( softness_probability - 0.3 ) / ( 0.95 - 0.3 ), 0.0, 1.0 ); // 0.3 reduces light bleed\n            occlusion = clamp( max( hard_shadow, softness_probability ), 0.0, 1.0 );\n\n        }\n        return occlusion;\n\n    }\n\n    float getShadow( int i, sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\n        float shadow = 1.0;\n\n        shadowCoord.xyz /= shadowCoord.w;\n        shadowCoord.z += shadowBias;\n\n        // if ( something && something ) breaks ATI OpenGL shader compiler\n        // if ( all( something, something ) ) using this instead\n\n        bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\n        bool inFrustum = all( inFrustumVec );\n\n        bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );\n\n        bool frustumTest = all( frustumTestVec );\n\n        if ( frustumTest ) {\n\n        #if defined( SHADOWMAP_TYPE_PCF )\n\n            vec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n            return vogelShadow(i, shadowMap, shadowCoord.xy, texelSize.x, shadowCoord.z, shadowRadius );\n\n        #elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n\n            vec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n            float dx = texelSize.x;\n            float dy = texelSize.y;\n\n            vec2 uv = shadowCoord.xy;\n            vec2 f = fract( uv * shadowMapSize + 0.5 );\n            uv -= f * texelSize;\n\n            shadow = (\n                texture2DCompare( shadowMap, uv, shadowCoord.z ) +\n                texture2DCompare( shadowMap, uv + vec2( dx, 0.0 ), shadowCoord.z ) +\n                texture2DCompare( shadowMap, uv + vec2( 0.0, dy ), shadowCoord.z ) +\n                texture2DCompare( shadowMap, uv + texelSize, shadowCoord.z ) +\n                mix( texture2DCompare( shadowMap, uv + vec2( -dx, 0.0 ), shadowCoord.z ),\n                     texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 0.0 ), shadowCoord.z ),\n                     f.x ) +\n                mix( texture2DCompare( shadowMap, uv + vec2( -dx, dy ), shadowCoord.z ),\n                     texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, dy ), shadowCoord.z ),\n                     f.x ) +\n                mix( texture2DCompare( shadowMap, uv + vec2( 0.0, -dy ), shadowCoord.z ),\n                     texture2DCompare( shadowMap, uv + vec2( 0.0, 2.0 * dy ), shadowCoord.z ),\n                     f.y ) +\n                mix( texture2DCompare( shadowMap, uv + vec2( dx, -dy ), shadowCoord.z ),\n                     texture2DCompare( shadowMap, uv + vec2( dx, 2.0 * dy ), shadowCoord.z ),\n                     f.y ) +\n                mix( mix( texture2DCompare( shadowMap, uv + vec2( -dx, -dy ), shadowCoord.z ),\n                          texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, -dy ), shadowCoord.z ),\n                          f.x ),\n                     mix( texture2DCompare( shadowMap, uv + vec2( -dx, 2.0 * dy ), shadowCoord.z ),\n                          texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 2.0 * dy ), shadowCoord.z ),\n                          f.x ),\n                     f.y )\n            ) * ( 1.0 / 9.0 );\n\n        #elif defined( SHADOWMAP_TYPE_VSM )\n\n            shadow = VSMShadow( shadowMap, shadowCoord.xy, shadowCoord.z );\n\n        #else // no percentage-closer filtering:\n\n            shadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n\n        #endif\n\n        }\n\n        return shadow;\n\n    }\n\n    // cubeToUV() maps a 3D direction vector suitable for cube texture mapping to a 2D\n    // vector suitable for 2D texture mapping. This code uses the following layout for the\n    // 2D texture:\n    //\n    // xzXZ\n    //  y Y\n    //\n    // Y - Positive y direction\n    // y - Negative y direction\n    // X - Positive x direction\n    // x - Negative x direction\n    // Z - Positive z direction\n    // z - Negative z direction\n    //\n    // Source and test bed:\n    // https://gist.github.com/tschw/da10c43c467ce8afd0c4\n\n    vec2 cubeToUV( vec3 v, float texelSizeY ) {\n\n        // Number of texels to avoid at the edge of each square\n\n        vec3 absV = abs( v );\n\n        // Intersect unit cube\n\n        float scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );\n        absV *= scaleToCube;\n\n        // Apply scale to avoid seams\n\n        // two texels less per square (one texel will do for NEAREST)\n        v *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );\n\n        // Unwrap\n\n        // space: -1 ... 1 range for each square\n        //\n        // #X##         dim    := ( 4 , 2 )\n        //  # #         center := ( 1 , 1 )\n\n        vec2 planar = v.xy;\n\n        float almostATexel = 1.5 * texelSizeY;\n        float almostOne = 1.0 - almostATexel;\n\n        if ( absV.z >= almostOne ) {\n\n            if ( v.z > 0.0 )\n                planar.x = 4.0 - v.x;\n\n        } else if ( absV.x >= almostOne ) {\n\n            float signX = sign( v.x );\n            planar.x = v.z * signX + 2.0 * signX;\n\n        } else if ( absV.y >= almostOne ) {\n\n            float signY = sign( v.y );\n            planar.x = v.x + 2.0 * signY + 2.0;\n            planar.y = v.z * signY - 2.0;\n\n        }\n\n        // Transform to UV space\n\n        // scale := 0.5 / dim\n        // translate := ( center + 0.5 ) / dim\n        return vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );\n\n    }\n\n    float getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {\n\n        float shadow = 1.0;\n        vec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );\n\n        // for point lights, the uniform @vShadowCoord is re-purposed to hold\n        // the vector from the light to the world-space position of the fragment.\n        vec3 lightToPosition = shadowCoord.xyz;\n\n        // dp = normalized distance from light to fragment position\n        float compare = ( length( lightToPosition ) - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear ); // need to clamp?\n        compare += shadowBias;\n\n        // bd3D = base direction 3D\n        vec3 bd3D = normalize( lightToPosition );\n\n        vec2 halton = haltonSequence[frameIndex];\n        float temporalOffset = getNoiseInterleavedGradient(gl_FragCoord.xy + halton);\n        float temporalAngle  = temporalOffset * PI2;\n\n        #if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_VSM )\n            for (int i = 0; i < gShadowSamples; i++) {\n                vec2 vogelSample = vogelDiskSample(i, gShadowSamples, temporalAngle) * texelSize;\n\n                // Overall blurring offset\n                vec3 offset = vec3(vogelSample.x, vogelSample.y, -vogelSample.x) * (shadowRadius + 5.);\n\n                // NOTE: Removed for now\n                // Penumbra offset\n                //offset += vec3(vogelSample.x, vogelSample.y, vogelSample.y)  * (penumbra * gPenumbraFilterSize);\n\n                shadow += texture2DCompare( shadowMap, cubeToUV( bd3D + offset, texelSize.y ), compare );\n\n            }\n            return shadow * gShadowSamplesRpc;\n\n        #elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n            for (int i = 0; i < 16; i++) {\n                vec2 vogelSample = vogelDiskSample(i, gShadowSamples, temporalAngle) * texelSize;\n\n                // Overall blurring offset\n                vec3 offset = vec3(vogelSample.x, vogelSample.y, -vogelSample.x) * (shadowRadius + 5.);\n\n                shadow += texture2DCompare( shadowMap, cubeToUV( bd3D + offset, texelSize.y ), compare );\n\n            }\n            return shadow * (1.0 / 16.0);\n        #else // no percentage-closer filtering\n\n            return texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), compare );\n\n        #endif\n\n    }\n\n#endif\n"))(e);let r=Hv.slice();r=r.replace("getShadow( spotShadowMap[ i ]","getShadow( UNROLLED_LOOP_INDEX + ".concat(3,", spotShadowMap[ i ]")),r=r.replace("getShadow( directionalShadowMap[ i ]","getShadow( UNROLLED_LOOP_INDEX, directionalShadowMap[ i ]"),n.ShaderChunk.lights_fragment_begin=r;let i=Wv.slice();return i=i.replaceAll("getShadow(","getShadow( UNROLLED_LOOP_INDEX, "),n.ShaderChunk.shadowmask_pars_fragment=i,!0}(t.softShadowQuality)&&this.forceMaterialsUpdate()}updateFog(t,e){if(t.enabled?this.fog=this.backupFog:this.fog=null,this.isActive){this.scene.fog=this.fog}this.fogUseBGColor=t.useBackgroundColor,t.useBackgroundColor?this.backupFog.color.set(this.bgColor):this.backupFog.color=Tf(t.color,e),this.backupFog.near=t.near,this.backupFog.far=t.far}updateAo(t,e){void 0!==t.aoColor&&(this.aoColor=Tf(t.aoColor,e))}updateByOp(t,e,r,n){super.updateByOp(t,e,r,n);let i=e;da(t.path,["fog"])?this.updateFog(i.fog,r.shared):da(t.path,["ao"])?this.updateAo(i.ao,r.shared):da(t.path,["ambient"])?this.updateAmbientLight(i.ambient,r.shared):da(t.path,["shadow"])&&this.updateShadow(i.shadow)}updateState(t,e){this.updateState_Entity(t,e),void 0!==t.backgroundColor&&this.setBackgroundColor(Tf(t.backgroundColor,e.shared)),void 0!==t.fog&&this.updateFog(t.fog,e.shared),void 0!==t.ambient&&this.updateAmbientLight(t.ambient,e.shared),void 0!==t.ao&&this.updateAo(t.ao,e.shared),void 0!==t.shadow&&this.updateShadow(t.shadow)}raycast(t,e){super.raycast(t,e)}switchActiveCamera(t){t&&t.isDescendantOf(this)&&(this.activeCamera!==this.personalCamera&&(this.activeCamera.objectHelper.visible=!0),this.activeCamera=t,t.objectHelper.visible=!1)}get playCamera(){var t,e;return null!==(t=null===(e=this.scene)||void 0===e?void 0:e.find(this.data.publish.playCamera))&&void 0!==t?t:this.personalCamera}switchToPlayCamera(){this.switchActiveCamera(this.playCamera)}get penumbraSizeArray(){return null===this.penumbraSizeArrayCache&&this.updatePenumbraSizeArray(),this.penumbraSizeArrayCache}updatePenumbraSizeArray(){this.penumbraSizeArrayCache=new Array(5).fill(.5);let t=0,e=0;this.traverseEntity((r=>{if(!r.visible)return!0;r instanceof Jv&&r.visible&&t<3&&(this.penumbraSizeArrayCache[t]=r.data.penumbraSize,t+=1),r instanceof rg&&r.visible&&t<2&&(this.penumbraSizeArrayCache[3+e]=r.data.penumbraSize,e+=1)}))}raycastWithClones(t){let e=[],r=n=>{for(let i of n.children){let n=i.cloner;hh.is(i)&&(i.visible||(null===n||void 0===n?void 0:n.object.data.visible))&&((Nv(i)||Fv(i)&&this.scene.enableHelpers&&i.objectHelper.visible)&&(t.intersectObject(i,!1,e),yg(i,t,e,!0)),r(i))}};return r(this),e}},ig=class extends(jv(n.PointLight,Qv)){constructor(t,e,r){super(),this.super_Entity(t,e),this.castShadow=!0,this.shadow.mapSize.width=1024,this.shadow.mapSize.height=1024,this.shadow.normalBias=1,this.layers.enable(3);let i=this.shadow.camera;i.fov=90,i.aspect=1,i.near=100,i.far=2500;let a=new n.Vector3(-i.far+this.position.x,-i.far+this.position.y,-i.far+this.position.z),o=new n.Vector3(i.far+this.position.x,i.far+this.position.y,i.far+this.position.z),s=new n.Box3(a,o),l=new n.Box3Helper(s,new n.Color(16755200));l.visible=!1,this.gizmos.shadowmap=l,this.update()}update(){if(this.shadow&&(this.shadow.camera.updateProjectionMatrix(),this.gizmos))for(let t in this.gizmos){let e=this.gizmos[t];if(e instanceof n.Box3Helper){let t=this.shadow.camera,r=new n.Vector3(-t.far+this.position.x,-t.far+this.position.y,-t.far+this.position.z),i=new n.Vector3(t.far+this.position.x,t.far+this.position.y,t.far+this.position.z);e.box.set(r,i),e.updateMatrixWorld(!0)}}}updateMatrixWorld(t){super.updateMatrixWorld(t),this.objectHelper&&this.objectHelper.update()}updateState(t,e){this.updateState_Light(t,e),void 0!==t.distance&&(this.distance=t.distance),void 0!==t.decay&&(this.decay=t.decay),void 0!==t.shadowRadius&&(this.shadow.radius=t.shadowRadius),void 0!==t.shadowResolution&&(this.shadow.mapSize.set(t.shadowResolution,t.shadowResolution),this.shadow.map&&(this.shadow.map.dispose(),this.shadow.map=null))}},ag=class extends Sm{get forceComputeSize(){return!0}get shape(){return this.geometry.userData.shape}updateEntityBoxSize(t,e){let r=this.geometry.getAttribute("position");void 0!==r?zd(r,this.geometry.drawRange.start,this.geometry.drawRange.count<1/0?this.geometry.drawRange.count:r.count,t,e):super.updateEntityBoxSize(t,e)}},og=class extends Sm{constructor(t,e,r){super(t,e,r),this._shapeId=null,this._context=r}updateState(t,e){super.updateState(t,e),this.updateShape()}updateShape(){let t,e={...this.data.geometry.extrusion.shape};for(let i in e)"string"==typeof e[i]&&(e[i]=this._context.shared.getVariable(e[i],[this.uuid,"geometry","extrusion","shape",i]));if("Custom"===e.type){let n=e.shapeId;if(n!==this._shapeId&&this.detachShape(),n){var r;this._shapeId=n;let e=this._context.scene.find(n);null!==e&&void 0!==e&&e.data&&(e.attachedPaths.add(this),t=null===(r=e.geometry.userData)||void 0===r?void 0:r.shape),t||this._context.scene.addPendingCommand((()=>this.updateShape()))}}else{let r;switch(e.type){case"Rectangle":r=ku;break;case"Ellipse":r=eu;break;case"Polygon":r=zu;break;case"Star":r=Uu;break;default:throw new Error("Unknown shape type: ".concat(e.type))}t=r.create({parameters:e}).userData.shape}let n=this.geometry;t&&n.inputs&&(n.inputs.shapeData=t,n.build(),this.attachedSurfaceCloners.forEach((t=>t.update())))}detachShape(){var t;null!==this._shapeId&&(null===(t=this._context.scene.find(this._shapeId))||void 0===t||t.attachedPaths.delete(this))}createGeometryDelayed(t){this.geometryCreateDeleyed=t.shared,this.updateShape(),this.refreshAttachedPaths(t)}updateTransformState(t,e){return super.updateTransformState(t,e)}updateGeometryInteractions(t,e){super.updateGeometryInteractions(t,e),this.updateShape()}updateEntityBoxSize(t,e){let r=this.geometry.getAttribute("position");void 0!==r?zd(r,this.geometry.drawRange.start,this.geometry.drawRange.count<1/0?this.geometry.drawRange.count:r.count,t,e):super.updateEntityBoxSize(t,e)}},sg=class extends(Mv(n.Group,Gv)){constructor(t,e,r){super(),"Instance"===e.type&&"string"==typeof t&&(e=this.transformAssignData(e,r)),this.super_Entity(t,e),this.objectHelper.update()}get isComponentRoot(){return"Component"===this.data.type&&"string"==typeof this.identity}get isInstanceRoot(){return"Instance"===this.data.type&&"string"==typeof this.identity}transformAssignData(t,e){let r=Rl.getComponentData({scene:e.scene.data,shared:e.shared.data},t.component);if(r){let e,n;for(let i of el.rootOverrideProps)void 0===t[i]?(void 0===e&&(e={...t}),e[i]=r.data[i]):(void 0===n&&(n={}),n[i]=t[i],void 0===e&&(e={...t}),e[i]=Li.apply(r.data[i],t[i]));return this.overrideData=n,e}return{...Ys.defaultData,...t,...wi(Ys.defaultData,el.rootOverrideProps)}}updateByOp(t,e,r,n){var i;let a;if(this.isInstanceRoot&&!n)if(e=this.transformAssignData(e,r),0===t.type&&0===t.path.length&&this.component)for(let o of el.rootOverrideProps)o in t.props&&void 0===t.props[o]&&(void 0===a&&(a={...t,props:{...t.props}}),a.props[o]=this.component.data[o]);else if(0===t.type&&t.path.length>0&&el.rootOverrideProps.includes(t.path[0])){let r=t.path[0];void 0===a&&(a={...t,path:[],props:{[r]:e[r]}})}super.updateByOp(null!==(i=a)&&void 0!==i?i:t,e,r,n)}updateState(t,e){this.updateState_Entity(t,e)}expandInstanceChildren(t){let e=this.data;if(void 0===this.component){var r;let i=null!==(r=t.scene.find(e.component))&&void 0!==r?r:null,a=!1;if(i!==this.oldComponent){if(this.oldComponent){let e=0;for(let r of this.children){if(!hh.is(r))break;t.scene.disposeAndUnregisterEntityRecursivelyIfNotReregistered(r),lg(r),e+=1}this.children.splice(0,e)}a=!0}if(i){let r={};cg(t,[this.uuid],e.overrides,this,i,i,0,a,r);for(let e of this.children)if(hh.is(e)){let i=e.data;"Empty"===i.type&&i.animations&&e.traverseEntity((e=>{if(e instanceof Sm&&e.isSkinnedMesh){let i=e.dataPatched;if(i.bones&&i.boneInverses){let a=i.bones.map((e=>t.scene.find(r[e]))),o=i.boneInverses.map((t=>(new n.Matrix4).fromArray(t))),s=new n.Skeleton(a,o);e.bind(s,e.bindMatrix)}}else e.matrixAutoUpdate=!0}))}}this.oldComponent=this.component}}};function lg(t){if(t.component){let e=t.component.instances.indexOf(t);e>=0&&t.component.instances.splice(e,1);for(let r of t.children)hh.is(r)&&lg(r)}}function hg(t,e,r,n){return t.component===e&&di(t.identity,n)?t.overrideData===r?2:1:0}function cg(t,e,r,n,i,a,o,s,l){if(o>50)return!1;if(n.component!==i){if(n.component){let t=n.component.instances.indexOf(n);t>=0&&n.component.instances.splice(t,1)}i.instances.push(n),n.component=i}i instanceof sg&&i.isInstanceRoot&&i.expandInstanceChildren(t);let h=0;for(let u of i.children)if(hh.is(u)){let i=[...e,..."string"==typeof u.identity?[u.identity]:u.identity],d=tl.resolve(r,i,1);null==d||d instanceof ji||(Object.setPrototypeOf(d,ji.prototype),console.error("wrong prototype"));let p,f=null;if(!s){var c;let e=n.children[h];if(f=hh.is(e)?e:null,null!==f){let t=hg(f,u,d,i);p=t>=1?f.stateSelection:void 0,2!==t&&(f=null)}if(null===f&&(f=null!==(c=t.scene.findInstance(i))&&void 0!==c?c:null,null!==f)){let e=hg(f,u,d,i);if(p=e>=1?f.stateSelection:void 0,2!==e)f=null;else{let e=f.parent.children.indexOf(f);f.parent.children.splice(e,1),n.children.splice(h,0,f),f.parent===n?e<=h&&console.error("not possible"):(f.parent=n,f.matrixWorldNeedsUpdate=!0,f.resetBBoxNeedsUpdate(),f.updateVisible(),t.pendingDeletes.delete(f))}}}if(null===f){let e=d?Li.apply(u.data,d):u.data;ns.is(e.type)&&(e={...e,type:"Empty"}),f=wh.createEntity(i,e,t),f.overrideData=d,n.add(f),n.children.splice(n.children.length-1,1),n.children.splice(h,0,f),f.updateState(f.data,t),p&&f.changeSelectedState(p,t),t.scene.registerInstanceAndSetUuid(f)}if(f.isBone){l[f.identity[f.identity.length-1]]=f.uuid}h+=1,cg(t,e,r,f,u,a,o+1,s,l)}if(!s){let e=h;for(;;){let e=n.children[h];if(!hh.is(e))break;t.pendingDeletes.add(e),h+=1}n.children.splice(e,h-e)}return!0}var ug=class extends(Mv(n.Bone,Gv)){constructor(t,e){super(),this.super_Entity(t,e),this.objectHelper.update(),this.matrixAutoUpdate=!0}updateState(t,e){this.updateState_Entity(t,e)}};function dg(t,e,r){return"Mesh"===e.type?function(t,e,r){let n;return"TextGeometry"===e.geometry.type?new $m(t,e,r):(n="SubdivGeometry"===e.geometry.type?new Pm(t,e,r):"PathGeometry"===e.geometry.type?new og(t,e,r):"VectorGeometry"===e.geometry.type?new ag(t,e,r):"BooleanGeometry"===e.geometry.type?new Uv(t,e,r):new Sm(t,e,r),n)}(t,e,r):"Empty"===e.type||"Splat"===e.type?new qv(t,e):"Bone"===e.type?new ug(t,e):"Page"===e.type?new ng(t,e):"PointLight"===e.type?new ig(t,e,r):"SpotLight"===e.type?new rg(t,e,r):"DirectionalLight"===e.type?new Jv(t,e,r):"Component"===e.type||"Instance"===e.type?new sg(t,e,r):ns.is(e.type)?new Ev(t,e):(console.error(e),new qv(t,e))}function pg(t,e){let r=!1,n=e.getLayersOfType("transmission"),i=e.getLayersOfType("outline");return i.length>0&&(t.layers.set(8),n.length>0&&t.layers.enable(3),r=!0,Mm(t),Am(t)),0===n.length&&0===i.length&&t.layers.set(0),t instanceof gm&&t.needsAO&&t.layers.enable(5),r}function fg(t,e){if(!e.layers)return!1;let r=!1,n=e.getLayersOfType("transmission").filter((t=>t.data.visible)),i=e.getLayersOfType("outline").filter((t=>t.data.visible));return n.length>0&&(t.layers.set(3),i.length>0&&t.layers.enable(8),r=!0),0===n.length&&0===i.length&&t.layers.set(0),t.needsAO&&t.layers.enable(5),r}wh.createEntity=dg,wh.changeEntityProptotype=function(t,e,r){let n=dg(t.identity,e,r),i=t.children,a=t.attachedPaths,o=t.parent,s=t.component,l=t.instances,h=t.overrideData,c=t.uuid,u=t.stateSelection;t.dispose();for(let d of Object.keys(t))delete t[d];Object.setPrototypeOf(t,Object.getPrototypeOf(n));for(let d of Object.keys(n))t[d]=n[d];t.children=[...t.children,...i],t.attachedPaths=a,t.parent=o,t.component=s,t.instances=l,t.uuid=c,t.overrideData=h,t.updateState(t.data,r),u&&t.changeSelectedState(u,r),t.resetBBoxNeedsUpdate()},wh.Cloner=dv;var mg=new n.Raycaster,vg=new n.Matrix4,gg=new n.Ray;function yg(t,e,r){let n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],i=t.cloner;if(i)for(let a of i.children){let i=vg.copy(a.matrixWorld).invert(),o=gg.copy(e.ray).applyMatrix4(i),s=t.matrixWorld;o.applyMatrix4(s);let l=mg;l.set(o.origin,o.direction),l.near=e.near,l.far=e.far;let h=l.intersectObject(t,!1);h.length>0&&r.push({...h[0],object:n?a:t})}}var bg=class{constructor(){this._constraints=new Map}setConstraint(t,e){null===e?this._constraints.delete(t):this._constraints.set(t,e)}removeDependencies(t){this._constraints.delete(t)}applyConstraints(t){let e=new Set;this._constraints.forEach(((r,n)=>{let i=[n,r],a=r;for(;this._constraints.has(a);)a=this._constraints.get(a),e.has(a)||i.push(a);for(let o=i.length-2;o>=0;o--)if(!e.has(i[o])){let r=t.find(i[o]);r?r.applyPathSnapping(t):console.warn("missing entity ".concat(i[o])),e.add(i[o])}}))}findDependency(t,e){let r=t;for(;this._constraints.has(r);)if(r=this._constraints.get(r),r===e)return!0;return!1}},xg=v(M()),wg=v(T()),_g=v(M()),Sg=v(T()),Ag=class{constructor(t,e,r){this._dataNormalized=t,this._minD=e,this._maxD=r}static createFromUnnormalized(t){let e=Sg.sup(t),r=Sg.inf(t),n=(0,_g.default)(new Float32Array(t.size),t.shape),i=e-r;return i<1e-4?Sg.assigns(n,0):(Sg.subs(n,t,r),Sg.divs(n,n,i)),new Ag(n,r,e)}get data(){return this._dataNormalized}get minD(){return this._minD}get maxD(){return this._maxD}denormalize(){let t=(0,_g.default)(new Float32Array(this._dataNormalized.size),this._dataNormalized.shape);return Sg.muls(t,this._dataNormalized,this._maxD-this._minD),Sg.adds(t,t,this._minD),t}},Mg=class{constructor(t,e){this._quantized=t,this._method=e}get quantized(){return this._quantized}static maxIntBits(t){return 2**t-1}static fromNormalized(t,e){let r,n=t.data;if("norm8x"===e){let t=Mg.maxIntBits(8),e=(0,_g.default)(new Float32Array(n.size),n.shape);Sg.muls(e,n,t),Sg.roundeq(e),r=(0,_g.default)(new Uint8Array(e.data),n.shape)}else if("norm565"===e){let t=(0,_g.default)(new Float32Array(n.size),n.shape);Sg.assign(t,n),Sg.mulseq(t.pick(null,0),Mg.maxIntBits(5)),Sg.mulseq(t.pick(null,1),Mg.maxIntBits(6)),Sg.mulseq(t.pick(null,2),Mg.maxIntBits(5)),Sg.roundeq(t);let e=(0,_g.default)(new Uint16Array(t.data),n.shape),i=(0,_g.default)(new Uint16Array(n.shape[0]),[n.shape[0]]),a=(0,_g.default)(new Uint16Array(n.shape[0]),[n.shape[0]]);Sg.lshifts(i,e.pick(null,0),11),Sg.lshifts(a,e.pick(null,1),5),Sg.boreq(i,a),Sg.boreq(i,e.pick(null,2)),r=i}else{let t=(0,_g.default)(new Float32Array(n.size),n.shape);Sg.assign(t,n),Sg.mulseq(t.pick(null,0),Mg.maxIntBits(11)),Sg.mulseq(t.pick(null,1),Mg.maxIntBits(10)),Sg.mulseq(t.pick(null,2),Mg.maxIntBits(11)),Sg.roundeq(t);let e=(0,_g.default)(new Uint32Array(t.data),n.shape),i=(0,_g.default)(new Uint32Array(n.shape[0]),[n.shape[0]]),a=(0,_g.default)(new Uint32Array(n.shape[0]),[n.shape[0]]);Sg.lshifts(i,e.pick(null,0),21),Sg.lshifts(a,e.pick(null,1),11),Sg.boreq(i,a),Sg.boreq(i,e.pick(null,2)),r=i}return new Mg(r,e)}dequantize(t,e){let r,n=this._method,i=this._quantized;if("norm8x"===n){let t=Mg.maxIntBits(8);r=(0,_g.default)(new Float32Array(i.size),i.shape),Sg.muls(r,i,1/t)}else if("norm565"===n){let t=(0,_g.default)(new Uint8Array(i.shape[0]),[i.shape[0]]),e=(0,_g.default)(new Uint8Array(i.shape[0]),[i.shape[0]]),n=(0,_g.default)(new Uint8Array(i.shape[0]),[i.shape[0]]);Sg.rrshifts(t,i,11),Sg.rrshifts(e,i,5),Sg.bandseq(e,Mg.maxIntBits(6)),Sg.bands(n,i,Mg.maxIntBits(5)),r=(0,_g.default)(new Float32Array(3*i.shape[0]),[i.shape[0],3]),Sg.muls(r.pick(null,0),t,1/Mg.maxIntBits(5)),Sg.muls(r.pick(null,1),e,1/Mg.maxIntBits(6)),Sg.muls(r.pick(null,2),n,1/Mg.maxIntBits(5))}else{let t=(0,_g.default)(new Uint16Array(i.shape[0]),[i.shape[0]]),e=(0,_g.default)(new Uint16Array(i.shape[0]),[i.shape[0]]),n=(0,_g.default)(new Uint16Array(i.shape[0]),[i.shape[0]]);Sg.rrshifts(t,i,21),Sg.rrshifts(e,i,11),Sg.bandseq(e,Mg.maxIntBits(10)),Sg.bands(n,i,Mg.maxIntBits(11)),r=(0,_g.default)(new Float32Array(3*i.shape[0]),[i.shape[0],3]),Sg.muls(r.pick(null,0),t,1/Mg.maxIntBits(11)),Sg.muls(r.pick(null,1),e,1/Mg.maxIntBits(10)),Sg.muls(r.pick(null,2),n,1/Mg.maxIntBits(11))}return new Ag(r,t,e)}},Cg=class{constructor(t,e,r,n,i){let a=arguments.length>5&&void 0!==arguments[5]&&arguments[5];this._quantized=t,this._minMaxMatrix=e,this._chunkSize=r,this._quantizationMethod=n,this._variableChunkSize=i,this._isDynamicChunks=a}get length(){return this._quantized.shape[0]}get nchunks(){return this._minMaxMatrix.shape[0]}get quantized(){return this._quantized}get method(){return this._quantizationMethod}get minmaxMatrix(){return this._minMaxMatrix}_createPrunedMinMax(t){let e=t.length,r=this.minmaxMatrix.shape[0]-e,n=(0,xg.default)(new Float32Array(2*r),[r,2]),i=0,a=r,o=0,s=this.minmaxMatrix.shape[0];for(let l=0;l<t.length;l++)s=t[l],a=s-o+i,a>i&&wg.assign(n.hi(a,2).lo(i,0),this.minmaxMatrix.hi(s,2).lo(o,0)),i=a,o=s+1;return i<r&&wg.assign(n.lo(i,0),this.minmaxMatrix.lo(o,0)),n}_createPrunedQuantized(t){let e,r,n=t.length,i=this.quantized.shape[0]-n,a=this._quantizationMethod;if("norm8x"===a){r=this._quantized.shape[1];let t=r?i*r:i;e=(0,xg.default)(new Uint8Array(t),r?[i,r]:[i,1])}else e="norm565"===a?(0,xg.default)(new Uint16Array(i),[i]):(0,xg.default)(new Uint32Array(i),[i]);let o=0,s=i,l=0,h=e.shape[0];for(let c=0;c<t.length;c++)h=t[c],s=h-l+o,s>o&&(r?wg.assign(e.hi(s,r).lo(o,0),this._quantized.hi(h,r).lo(l,0)):wg.assign(e.hi(s).lo(o),this._quantized.hi(h).lo(l))),o=s,l=h+1;return o<i&&(r?wg.assign(e.lo(o,0),this._quantized.lo(l,0)):wg.assign(e.lo(o),this._quantized.lo(l))),e}pruneFeature(t,e,r){let n=this._createPrunedQuantized(t),i=this._createPrunedMinMax(e);return new Cg(n,i,this._chunkSize,this._quantizationMethod,r,!0)}static getRequiredNChunks(t,e){return Math.floor(t/e)}static fromArray(t,e,r){let n,i=t.shape[0],a=Math.floor(i/r),o=(0,xg.default)(new Float32Array(2*a),[a,2],[2,1]);n="norm8x"===e?(0,xg.default)(new Uint8Array(t.size),t.shape):"norm565"===e?(0,xg.default)(new Uint16Array(t.shape[0]),[t.shape[0]]):(0,xg.default)(new Uint32Array(t.shape[0]),[t.shape[0]]);for(let s=0;s<a;s++){let l,h=s*r,c=s+1<a?(s+1)*r:i;l=t.shape.length>1?Ag.createFromUnnormalized(t.hi(c,t.shape[1]).lo(h,0)):Ag.createFromUnnormalized(t.hi(c).lo(h)),o.set(s,0,l.minD),o.set(s,1,l.maxD),n.shape.length>1?wg.assign(n.hi(c,n.shape[1]).lo(h,0),Mg.fromNormalized(l,e).quantized):wg.assign(n.hi(c).lo(h),Mg.fromNormalized(l,e).quantized)}return new Cg(n,o,r,e)}denormDequant(){let t,e,r=this._minMaxMatrix.shape[0],n=this._quantized,i=n.shape[0],a=this._quantizationMethod,o=this._chunkSize;if(this._isDynamicChunks){if(!this._variableChunkSize)throw new Error("variable chunk must exists if chunkSize isDynamic");t=this._variableChunkSize}e="norm8x"===a?(0,xg.default)(new Float32Array(n.size),n.shape):(0,xg.default)(new Float32Array(3*i),[i,3]);let s=0,l=o;for(let h=0;h<r;h++){let[o,c]=[this._minMaxMatrix.get(h,0),this._minMaxMatrix.get(h,1)];this._isDynamicChunks&&(l=t[h]);let u,d=h+1<r?s+l:i;u=n.shape.length>1?new Mg(n.hi(d,n.shape[1]).lo(s,0),a):new Mg(n.hi(d).lo(s),a),wg.assign(e.hi(d,e.shape[1]).lo(s,0),u.dequantize(o,c).denormalize()),s=d}return e}static async fetchArrayBuffer(t){return await(await fetch(t,{mode:"cors"})).arrayBuffer()}},Og=v(M()),Dg=v(T()),Pg=v(M()),Tg=v(T()),zg=[1,10,100,1e3,1e4,1e5,1e6,1e7,1e8,1e9];function Eg(t){return t<1e5?t<100?t<10?0:1:t<1e4?t<1e3?2:3:4:t<1e7?t<1e6?5:6:t<1e9?t<1e8?7:8:9}function Ig(t,e){if(t===e)return 0;if(~~t===t&&~~e===e){if(0===t||0===e)return t<e?-1:1;if(t<0||e<0){if(e>=0)return-1;if(t>=0)return 1;t=-t,e=-e}let r=Eg(t),n=Eg(e),i=0;return r<n?(t*=zg[n-r-1],e/=10,i=-1):r>n&&(e*=zg[r-n-1],t/=10,i=1),t===e?i:t<e?-1:1}let r=String(t),n=String(e);return r===n?0:r<n?-1:1}function Lg(t,e,r,n){let i=e+1;if(i===r)return 1;if(n(t[i++],t[e])<0){for(;i<r&&n(t[i],t[i-1])<0;)i++;!function(t,e,r){for(r--;e<r;){let n=t[e];t[e++]=t[r],t[r--]=n}}(t,e,i)}else for(;i<r&&n(t[i],t[i-1])>=0;)i++;return i-e}function Bg(t,e,r,n,i){for(n===e&&n++;n<r;n++){let r=t[n],a=e,o=n;for(;a<o;){let e=a+o>>>1;i(r,t[e])<0?o=e:a=e+1}let s=n-a;switch(s){case 3:t[a+3]=t[a+2];case 2:t[a+2]=t[a+1];case 1:t[a+1]=t[a];break;default:for(;s>0;)t[a+s]=t[a+s-1],s--}t[a]=r}}function kg(t,e,r,n,i,a){let o=0,s=0,l=1;if(a(t,e[r+i])>0){for(s=n-i;l<s&&a(t,e[r+i+l])>0;)o=l,l=1+(l<<1),l<=0&&(l=s);l>s&&(l=s),o+=i,l+=i}else{for(s=i+1;l<s&&a(t,e[r+i-l])<=0;)o=l,l=1+(l<<1),l<=0&&(l=s);l>s&&(l=s);let n=o;o=i-l,l=i-n}for(o++;o<l;){let n=o+(l-o>>>1);a(t,e[r+n])>0?o=n+1:l=n}return l}function Vg(t,e,r,n,i,a){let o=0,s=0,l=1;if(a(t,e[r+i])<0){for(s=i+1;l<s&&a(t,e[r+i-l])<0;)o=l,l=1+(l<<1),l<=0&&(l=s);l>s&&(l=s);let n=o;o=i-l,l=i-n}else{for(s=n-i;l<s&&a(t,e[r+i+l])>=0;)o=l,l=1+(l<<1),l<=0&&(l=s);l>s&&(l=s),o+=i,l+=i}for(o++;o<l;){let n=o+(l-o>>>1);a(t,e[r+n])<0?l=n:o=n+1}return l}var Ug=class{constructor(t,e){g(this,"array",null),g(this,"compare",null),g(this,"minGallop",7),g(this,"length",0),g(this,"tmpStorageLength",256),g(this,"stackLength",0),g(this,"runStart",null),g(this,"runLength",null),g(this,"stackSize",0),this.array=t,this.compare=e,this.length=t.length,this.length<512&&(this.tmpStorageLength=this.length>>>1),this.tmp=new Array(this.tmpStorageLength),this.stackLength=this.length<120?5:this.length<1542?10:this.length<119151?19:40,this.runStart=new Array(this.stackLength),this.runLength=new Array(this.stackLength)}pushRun(t,e){this.runStart[this.stackSize]=t,this.runLength[this.stackSize]=e,this.stackSize+=1}mergeRuns(){for(;this.stackSize>1;){let t=this.stackSize-2;if(t>=1&&this.runLength[t-1]<=this.runLength[t]+this.runLength[t+1]||t>=2&&this.runLength[t-2]<=this.runLength[t]+this.runLength[t-1])this.runLength[t-1]<this.runLength[t+1]&&t--;else if(this.runLength[t]>this.runLength[t+1])break;this.mergeAt(t)}}forceMergeRuns(){for(;this.stackSize>1;){let t=this.stackSize-2;t>0&&this.runLength[t-1]<this.runLength[t+1]&&t--,this.mergeAt(t)}}mergeAt(t){let e=this.compare,r=this.array,n=this.runStart[t],i=this.runLength[t],a=this.runStart[t+1],o=this.runLength[t+1];this.runLength[t]=i+o,t===this.stackSize-3&&(this.runStart[t+1]=this.runStart[t+2],this.runLength[t+1]=this.runLength[t+2]),this.stackSize--;let s=Vg(r[a],r,n,i,0,e);n+=s,i-=s,0!==i&&(o=kg(r[n+i-1],r,a,o,o-1,e),0!==o&&(i<=o?this.mergeLow(n,i,a,o):this.mergeHigh(n,i,a,o)))}mergeLow(t,e,r,n){let i=this.compare,a=this.array,o=this.tmp,s=0;for(s=0;s<e;s++)o[s]=a[t+s];let l=0,h=r,c=t;if(a[c++]=a[h++],0===--n){for(s=0;s<e;s++)a[c+s]=o[l+s];return}if(1===e){for(s=0;s<n;s++)a[c+s]=a[h+s];return void(a[c+n]=o[l])}let u=this.minGallop;for(;;){let t=0,r=0,d=!1;do{if(i(a[h],o[l])<0){if(a[c++]=a[h++],r++,t=0,0===--n){d=!0;break}}else if(a[c++]=o[l++],t++,r=0,1===--e){d=!0;break}}while((t|r)<u);if(d)break;do{if(t=Vg(a[h],o,l,e,0,i),0!==t){for(s=0;s<t;s++)a[c+s]=o[l+s];if(c+=t,l+=t,(e-=t)<=1){d=!0;break}}if(a[c++]=a[h++],0===--n){d=!0;break}if(r=kg(o[l],a,h,n,0,i),0!==r){for(s=0;s<r;s++)a[c+s]=a[h+s];if(c+=r,h+=r,0===(n-=r)){d=!0;break}}if(a[c++]=o[l++],1===--e){d=!0;break}u--}while(t>=7||r>=7);if(d)break;u<0&&(u=0),u+=2}if(this.minGallop=u,u<1&&(this.minGallop=1),1===e){for(s=0;s<n;s++)a[c+s]=a[h+s];a[c+n]=o[l]}else{if(0===e)throw new Error("mergeLow preconditions were not respected");for(s=0;s<e;s++)a[c+s]=o[l+s]}}mergeHigh(t,e,r,n){let i=this.compare,a=this.array,o=this.tmp,s=0;for(s=0;s<n;s++)o[s]=a[r+s];let l=t+e-1,h=n-1,c=r+n-1,u=0,d=0;if(a[c--]=a[l--],0===--e){for(u=c-(n-1),s=0;s<n;s++)a[u+s]=o[s];return}if(1===n){for(c-=e,l-=e,d=c+1,u=l+1,s=e-1;s>=0;s--)a[d+s]=a[u+s];return void(a[c]=o[h])}let p=this.minGallop;for(;;){let r=0,f=0,m=!1;do{if(i(o[h],a[l])<0){if(a[c--]=a[l--],r++,f=0,0===--e){m=!0;break}}else if(a[c--]=o[h--],f++,r=0,1===--n){m=!0;break}}while((r|f)<p);if(m)break;do{if(r=e-Vg(o[h],a,t,e,e-1,i),0!==r){for(c-=r,l-=r,e-=r,d=c+1,u=l+1,s=r-1;s>=0;s--)a[d+s]=a[u+s];if(0===e){m=!0;break}}if(a[c--]=o[h--],1===--n){m=!0;break}if(f=n-kg(a[l],o,0,n,n-1,i),0!==f){for(c-=f,h-=f,n-=f,d=c+1,u=h+1,s=0;s<f;s++)a[d+s]=o[u+s];if(n<=1){m=!0;break}}if(a[c--]=a[l--],0===--e){m=!0;break}p--}while(r>=7||f>=7);if(m)break;p<0&&(p=0),p+=2}if(this.minGallop=p,p<1&&(this.minGallop=1),1===n){for(c-=e,l-=e,d=c+1,u=l+1,s=e-1;s>=0;s--)a[d+s]=a[u+s];a[c]=o[h]}else{if(0===n)throw new Error("mergeHigh preconditions were not respected");for(u=c-(n-1),s=0;s<n;s++)a[u+s]=o[s]}}};function jg(t){let e=(0,Pg.default)(new Int32Array(t.shape[0]),[t.shape[0]]),r=(0,Pg.default)(new Int32Array(t.shape[0]),[t.shape[0]]);return Tg.bands(e,t,1023),Tg.lshifts(r,e,16),Tg.bxoreq(e,r),Tg.bandseq(e,4278190335),Tg.lshifts(r,e,8),Tg.bxoreq(e,r),Tg.bandseq(e,50393103),Tg.lshifts(r,e,4),Tg.bxoreq(e,r),Tg.bandseq(e,51130563),Tg.lshifts(r,e,2),Tg.bxoreq(e,r),Tg.bandseq(e,153391689),e}function Ng(t,e){if(t.shape[0]!==e.shape[0])throw new Error("wrong length");let r=(0,Pg.default)(new Float32Array(t.size),t.shape,t.stride,t.offset);for(let n=0;n<e.shape[0];n++){let i=e.get(n);if(t.shape.length>1)for(let e=0;e<t.shape[1];e++)r.set(n,e,t.get(i,e));else r.set(n,t.get(i))}return r}function Rg(t){let e=Tg.sup(t),r=Tg.inf(t),n=1e3/Math.min(1e3,e-r),i=(0,Pg.default)(new Float32Array(t.data),t.shape);Tg.mulseq(i,n);let a=function(t){let e=jg(t.pick(null,0)),r=jg(t.pick(null,1));Tg.lshiftseq(r,1);let n=jg(t.pick(null,2));return Tg.lshiftseq(n,2),Tg.boreq(e,r),Tg.boreq(e,n),e}((0,Pg.default)(new Int32Array(i.data),t.shape)),o=Array.from(a.data).map(((t,e)=>[t,e]));!function(t,e,r,n){if(!Array.isArray(t))throw new TypeError("Can only sort arrays");e?"function"!=typeof e&&(n=r,r=e,e=Ig):e=Ig,r||(r=0),n||(n=t.length);let i=n-r;if(i<2)return;let a=0;if(i<32)return a=Lg(t,r,n,e),void Bg(t,r,n,r+a,e);let o=new Ug(t,e),s=function(t){let e=0;for(;t>=32;)e|=1&t,t>>=1;return t+e}(i);do{if(a=Lg(t,r,n,e),a<s){let n=i;n>s&&(n=s),Bg(t,r,r+n,r+a,e),a=n}o.pushRun(r,a),o.mergeRuns(),i-=a,r+=a}while(0!==i);o.forceMergeRuns()}(o,((t,e)=>t[0]-e[0]));let s=o.map((t=>{let[e,r]=t;return r}));return(0,Pg.default)(Uint32Array.from(s))}var Fg=class{constructor(t,e,r,n,i,a,o,s,l,h){this.propertyDescs=t,this.format=e,this.nsplats=r,this.xyz=n,this.colors=i,this.harmonics=a,this.opacity=o,this.scaling=s,this.rotation=l,this.maxSHDegree=h}getPlyBinary(){let t=Fg._generateHeaderString(this.propertyDescs,this.format,this.nsplats),e=(new TextEncoder).encode(t),r=Object.keys(this.propertyDescs).length,n=(0,Og.default)(new Float32Array(this.nsplats*r),[this.nsplats,r]);if(Dg.assign(n.pick(null,this.propertyDescs.x.index),this.xyz.pick(null,0)),Dg.assign(n.pick(null,this.propertyDescs.y.index),this.xyz.pick(null,1)),Dg.assign(n.pick(null,this.propertyDescs.z.index),this.xyz.pick(null,2)),Dg.assign(n.pick(null,this.propertyDescs.f_dc_0.index),this.colors.pick(null,0)),Dg.assign(n.pick(null,this.propertyDescs.f_dc_1.index),this.colors.pick(null,1)),Dg.assign(n.pick(null,this.propertyDescs.f_dc_2.index),this.colors.pick(null,2)),Dg.assign(n.pick(null,this.propertyDescs.opacity.index),this.opacity.pick(null,0)),Dg.assign(n.pick(null,this.propertyDescs.scale_0.index),this.scaling.pick(null,0)),Dg.assign(n.pick(null,this.propertyDescs.scale_1.index),this.scaling.pick(null,1)),Dg.assign(n.pick(null,this.propertyDescs.scale_2.index),this.scaling.pick(null,2)),Dg.assign(n.pick(null,this.propertyDescs.rot_0.index),this.rotation.pick(null,0)),Dg.assign(n.pick(null,this.propertyDescs.rot_1.index),this.rotation.pick(null,1)),Dg.assign(n.pick(null,this.propertyDescs.rot_2.index),this.rotation.pick(null,2)),Dg.assign(n.pick(null,this.propertyDescs.rot_3.index),this.rotation.pick(null,3)),this.harmonics&&this.harmonics.length>0)for(let o=0;o<this.harmonics.length;o++){let t=3*o;Dg.assign(n.pick(null,this.propertyDescs["f_rest_".concat(t)].index),this.harmonics[o].pick(null,0)),Dg.assign(n.pick(null,this.propertyDescs["f_rest_".concat(t+1)].index),this.harmonics[o].pick(null,1)),Dg.assign(n.pick(null,this.propertyDescs["f_rest_".concat(t+2)].index),this.harmonics[o].pick(null,2))}let i=new Uint8Array(n.data.buffer),a=new Uint8Array(i.length+e.length);return a.set(e),a.set(i,e.length),a.buffer}save(t,e){let r=this.getPlyBinary(),n=new Blob([r],{type:"application/octet-stream"}),i=new File([n],t),a=new FormData;a.append("file",i),a.append("filename",t),a.append("basedir",e),fetch("".concat("http://127.0.0.1:8000","/push_file"),{method:"POST",body:a})}static async loadFile(t){return await(await fetch(t)).arrayBuffer()}mortonPositionSplatsSort(){let t=Rg(this.xyz),e=Ng(this.xyz,t),r=Ng(this.colors,t),n=Ng(this.opacity,t),i=Ng(this.scaling,t),a=Ng(this.rotation,t),o=[];for(let s=0;s<this.harmonics.length;s++)o.push(Ng(this.harmonics[s],t));return new Fg(this.propertyDescs,this.format,this.nsplats,e,r,o,n,i,a,this.maxSHDegree)}static _generateHeaderString(t,e,r){let n="ply\nformat ".concat(e.format," ").concat(e.version,"\nelement vertex ").concat(r),i=Object.keys(t).length,a=Array(i);for(let o in t){let e=t[o];a[e.index]={name:o,dtype:e.dtype}}for(let o=0;o<a.length;o++)n="".concat(n,"\nproperty ").concat(a[o].dtype," ").concat(a[o].name);return"".concat(n,"\nend_header\n")}static fromArrayBuffer(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3,{splatCount:r,vertexData:n,propertiesDesc:i,format:a}=Fg.decodeHeader(t),o=n.buffer.slice(n.byteOffset),s=Object.keys(i).length,l=(0,Og.default)(new Float32Array(o),[r,s]),h=0,c={},u={double:8,int:4,uint:4,float:4,short:2,ushort:2,uchar:1};for(let b in i)if(i.hasOwnProperty(b)){let t=i[b].dtype;c[b]=h,h+=u[t]}let d=(0,Og.default)(new Float32Array(3*r),[r,3]);Dg.assign(d.pick(null,0),l.pick(null,c.x/4)),Dg.assign(d.pick(null,1),l.pick(null,c.y/4)),Dg.assign(d.pick(null,2),l.pick(null,c.z/4));let p=(0,Og.default)(new Float32Array(3*r),[r,3]);Dg.assign(p.pick(null,0),l.pick(null,c.scale_0/4)),Dg.assign(p.pick(null,1),l.pick(null,c.scale_1/4)),Dg.assign(p.pick(null,2),l.pick(null,c.scale_2/4));let f=(0,Og.default)(new Float32Array(3*r),[r,3]);Dg.assign(f.pick(null,0),l.pick(null,c.f_dc_0/4)),Dg.assign(f.pick(null,1),l.pick(null,c.f_dc_1/4)),Dg.assign(f.pick(null,2),l.pick(null,c.f_dc_2/4));let m=(0,Og.default)(new Float32Array(4*r),[r,4]);Dg.assign(m.pick(null,0),l.pick(null,c.rot_1/4)),Dg.assign(m.pick(null,1),l.pick(null,c.rot_2/4)),Dg.assign(m.pick(null,2),l.pick(null,c.rot_3/4)),Dg.assign(m.pick(null,3),l.pick(null,c.rot_0/4));for(let b=0;b<r;b++){let t=m.pick(b,null),e=Math.sqrt(t.get(0)**2+t.get(1)**2+t.get(2)**2+t.get(3)**2);Dg.divseq(t,e)}let v=(0,Og.default)(new Float32Array(1*r),[r,1]);Dg.assign(v.pick(null,0),l.pick(null,c.opacity/4));let g=(Math.min(Math.max(e,0),3)+1)**2-1,y=[];for(let b=0;b<g;b++){let t=(0,Og.default)(new Float32Array(3*r),[r,3]),e=3*b;Dg.assign(t.pick(null,0),l.pick(null,c["f_rest_".concat(e)]/4)),Dg.assign(t.pick(null,1),l.pick(null,c["f_rest_".concat(e+1)]/4)),Dg.assign(t.pick(null,2),l.pick(null,c["f_rest_".concat(e+2)]/4)),y.push(t)}return new Fg(i,a,r,d,f,y,v,p,m,e)}static async fromPLYFile(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3,r=await Fg.loadFile(t);return Fg.fromArrayBuffer(r,e)}static decodeHeader(t){let e=new TextDecoder,r=0,n="",i=100;for(;;){if(r+i>=t.byteLength)throw new Error("End of file reached while searching for end of header");let a=new Uint8Array(t,r,i);n+=e.decode(a),r+=i;let o=r-200,s=new Uint8Array(t,Math.max(0,o),o>0?200:i);if(e.decode(s).includes("end_header"))break}let a,o=n.split("\n"),s=0,l={},h={},c=0;for(let d=0;d<o.length;d++){let t=o[d].trim();if(t.startsWith("element vertex")){let e=t.match(/\d+/);e&&(s=parseInt(e[0]))}else if(t.startsWith("property")){let e=t.match(/(\w+)\s+(\w+)\s+(\w+)/);if(e){let t=e[2],r=e[3];l[r]=c,h[r]={dtype:t,index:c},c++}}else if(t.startsWith("format")){let e=t.match(/(\w+)\s+(\w+)\s+(\d+\.?\d*)/);e&&(a={format:e[2],version:e[3]})}else if("end_header"===t)break}let u=n.indexOf("end_header")+10+1;return{splatCount:s,vertexData:new DataView(t,u),headerOffset:r,propertiesDesc:h,format:a}}},Gg=class{constructor(t,e,r,n,i,a,o,s){this.config=t,this.xyz=e,this.scaling=r,this.color=n,this.opacity=i,this.harmonics=o,this.quaternion=a,this.variableChunkSize=s}get isDynamicChunks(){return this.variableChunkSize&&this.variableChunkSize.length>0}get nchunks(){return this.xyz.nchunks}get nsplats(){return this.xyz.length}get chunkSize(){return this.config.chunkSize}static compressFromGaussianData(t,e){let r=Cg.fromArray(t.xyz,e.xyz,e.chunkSize),n=Cg.fromArray(t.scaling,e.scaling,e.chunkSize),i=Cg.fromArray(t.colors,e.color,e.chunkSize),a=Cg.fromArray(t.opacity,e.opacity,e.chunkSize),o=Cg.fromArray(t.rotation,e.quaternion,e.chunkSize),s=t.harmonics,l=[];if(e.harmonics)for(let h=0;h<s.length;h++){let t=Cg.fromArray(s[h],e.harmonics,e.chunkSize);l.push(t)}return new Gg(e,r,n,i,a,o,l)}_countIndexesInChunks(t){let e=[],r=this.nchunks,n=this.chunkSize,i=this.nsplats;if(r===Cg.getRequiredNChunks(i,n))for(let a=0;a<t.length;a++){let r=t[a],n=Math.floor(r/this.chunkSize);n in e?e[n].push(r):e[n]=[r]}else{let i=this.variableChunkSize,a={},o=0;for(let t=0;t<r;t++)a[t]=o,o+=i[t];for(let s=0;s<t.length;s++){let o=t[s],l=Math.min(Math.floor(o/n),r-1);for(;o>=a[l]+i[l];)l++;l in e?e[l].push(o):e[l]=[o]}}return e}pruneSplats(t){let e,r=this._countIndexesInChunks(t),n=[];return r.length>0&&(e=this.variableChunkSize?[...this.variableChunkSize]:Array(this.nchunks).fill(this.chunkSize),r.forEach(((t,r)=>{e[r]-=t.length,e[r]<=0&&n.push(r)})),e=e.filter((t=>t>0))),new Gg(this.config,this.xyz.pruneFeature(t,n,e),this.scaling.pruneFeature(t,n,e),this.color.pruneFeature(t,n,e),this.opacity.pruneFeature(t,n,e),this.quaternion.pruneFeature(t,n,e),this.harmonics?this.harmonics.map((e=>e.pruneFeature(t,n,this.variableChunkSize))):void 0,e)}static async loadConfig(t){return await(await fetch(t,{method:"GET",mode:"cors",headers:{Accept:"application/json"}})).json()}toGaussians(){var t;let e={},r=0;if(e.x={dtype:"float",index:r},r++,e.y={dtype:"float",index:r},r++,e.z={dtype:"float",index:r},r++,e.f_dc_0={dtype:"float",index:r},r++,e.f_dc_1={dtype:"float",index:r},r++,e.f_dc_2={dtype:"float",index:r},r++,this.harmonics&&this.harmonics.length>0)for(let i=0;i<this.harmonics.length;i++)e["f_rest_".concat(i)]={dtype:"float",index:r},r++,e["f_rest_".concat(i+1)]={dtype:"float",index:r},r++,e["f_rest_".concat(i+2)]={dtype:"float",index:r},r++;e.opacity={dtype:"float",index:r},r++,e.scale_0={dtype:"float",index:r},r++,e.scale_1={dtype:"float",index:r},r++,e.scale_2={dtype:"float",index:r},r++,e.rot_0={dtype:"float",index:r},r++,e.rot_1={dtype:"float",index:r},r++,e.rot_2={dtype:"float",index:r},r++,e.rot_3={dtype:"float",index:r},r++;let n=null===(t=this.harmonics)||void 0===t?void 0:t.map((t=>t.denormDequant()));return new Fg(e,{format:"binary_little_endian",version:"1.0"},this.xyz.length,this.xyz.denormDequant(),this.color.denormDequant(),n||[],this.opacity.denormDequant(),this.scaling.denormDequant(),this.quaternion.denormDequant(),3)}},qg=v(M()),Hg=v(T()),Wg={xyz:3,color:3,opacity:1,scaling:3,quaternion:4,harmonics:3},Xg=class{constructor(t){this._buffer=t}get buffer(){return this._buffer}get decoded(){return this._decoded||(this._decoded=this.decodeBuffer()),this._decoded}get colorsA(){let t=this.decoded.color.denormDequant(),e=this.decoded.opacity.denormDequant(),r=(0,qg.default)(new Float32Array(4*t.shape[0]),[t.shape[0],4]);return Hg.mulseq(t,.28209479177387814),Hg.addseq(t,.5),Hg.mulseq(t,255),Hg.maxseq(t,0),Hg.minseq(t,255),Hg.negeq(e),Hg.expeq(e),Hg.addseq(e,1),Hg.recipeq(e),Hg.mulseq(e,255),Hg.assign(r.hi(t.shape[0],3).lo(0,0),t),Hg.assign(r.hi(t.shape[0],4).lo(0,3),e),(0,qg.default)(new Uint8Array(r.data),[t.shape[0],4]).data}get nsplats(){return this.decoded.nsplats}getSplatCount(){return this.decoded.nsplats}get precomputedCovarianceBufferData(){return this._precomputedCovarianceBufferData}decodeBuffer(){let{splatCount:t,chunkCount:e,chunkSize:r,typeChunks:n,vertexData:i,propertiesDesc:a}=this.decodeHeader(),o={xyz:a.xyz.compressionMethod,color:a.color.compressionMethod,opacity:a.opacity.compressionMethod,scaling:a.scaling.compressionMethod,quaternion:a.quaternion.compressionMethod,chunkSize:r};a.harmonics_0&&(o.harmonics=a.harmonics_0.compressionMethod);let s=i.byteOffset,l=Array(Object.keys(a).length);for(let v in a)l[a[v].index]={name:v,method:a[v].compressionMethod};let h,c=2*e*4,u=s,d="dynamic"===n?2*e:0,p=!1;if(d>0){let t=new Uint16Array(i.buffer.slice(u,u+d));u+=d,h=Array.from(t),p=!0}let f={};for(let v of l){let n,a=0,o=!0;if("norm8x"===v.method)a=1*t*Wg[v.name];else if("norm11"===v.method)a=4*t;else{if("norm565"!==v.method)throw o=!1,new Error("Not Implemented format: ".concat(v.method));a=2*t}if(!o)throw new Error("loading chunk byt hasnot minmax!");{let t=i.buffer.slice(u,u+c);n=(0,qg.default)(new Float32Array(t),[e,2]),u+=c}let s,l=i.buffer.slice(u,u+a);if(u+=a,"norm8x"===v.method)s=(0,qg.default)(new Uint8Array(l),[t,Wg[v.name]]);else if("norm11"===v.method)s=(0,qg.default)(new Uint32Array(l));else{if("norm565"!==v.method)throw new Error("Not Implemented format: ".concat(v.method));s=(0,qg.default)(new Uint16Array(l))}f[v.name]=new Cg(s,n,r,v.method,h,p)}let m=[];for(let v=0;v<15;v++){let t=f["harmonics_".concat(v)];t&&(m.push(t),delete f["harmonics_".concat(v)])}return m.length>0&&(f.harmonics=m),new Gg(o,f.xyz,f.scaling,f.color,f.opacity,f.quaternion,f.harmonics,h)}buildPreComputedBuffers(){let t=this.decoded,e=t.nsplats,r=new ArrayBuffer(24*e),i=new Float32Array(r),a=t.scaling.denormDequant(),o=t.quaternion.denormDequant(),s=new n.Quaternion,l=new n.Matrix3,h=new n.Matrix3,c=new n.Matrix3,u=new n.Matrix4;for(let n=0;n<e;n++){u.makeScale(Math.exp(a.get(n,0)),Math.exp(a.get(n,1)),Math.exp(a.get(n,2))),h.setFromMatrix4(u),s.set(o.get(n,0),o.get(n,1),o.get(n,2),o.get(n,3)),u.makeRotationFromQuaternion(s),l.setFromMatrix4(u),c.copy(l).multiply(h);let t=c.elements;i[6*n]=t[0]*t[0]+t[3]*t[3]+t[6]*t[6],i[6*n+1]=t[0]*t[1]+t[3]*t[4]+t[6]*t[7],i[6*n+2]=t[0]*t[2]+t[3]*t[5]+t[6]*t[8],i[6*n+3]=t[1]*t[1]+t[4]*t[4]+t[7]*t[7],i[6*n+4]=t[1]*t[2]+t[4]*t[5]+t[7]*t[8],i[6*n+5]=t[2]*t[2]+t[5]*t[5]+t[8]*t[8]}this._precomputedCovarianceBufferData=r}decodeHeader(){let t=this._buffer,e=new TextDecoder,r=0,n="",i=100;for(;;){if(r+i>=t.byteLength)throw new Error("End of file reached while searching for end of header");let a=new Uint8Array(t,r,i);n+=e.decode(a),r+=i;let o=r-200,s=new Uint8Array(t,Math.max(0,o),o>=0?200:i);if(e.decode(s).includes("end_header"))break}let a=n.split("\n"),o=0,s=0,l=0,h=0,c="",u={};for(let p=0;p<a.length;p++){let t=a[p].trim();if(t.startsWith("element vertex")){let e=t.match(/\d+/);e&&(o=parseInt(e[0]))}else if(t.startsWith("property")){let e=t.match(/(\w+)\s+(\w+)\s+(\w+)/);if(e){let t=e[2],r=e[3];u[t]={compressionMethod:r,index:h},h++}}else if(t.startsWith("element chunks")){let e=t.match(/\d+/);e&&(s=parseInt(e[0]))}else if(t.startsWith("element chunkSize")){let e=t.match(/\d+/);e&&(l=parseInt(e[0]))}else if(t.startsWith("element typeChunks")){let e=t.match(/(\w+)\s+(\w+)\s+(\w+)/);e&&(c=e[3])}else if("end_header"===t)break}let d=n.indexOf("end_header")+10+1;return{splatCount:o,chunkCount:s,chunkSize:l,typeChunks:c,vertexData:new DataView(t,d),propertiesDesc:u}}pruneSplats(t){let e=this.decodeBuffer().pruneSplats(t);return Xg.fromCompressedGaussianSplats(e)}static fromCompressedGaussianSplats(t){let e=t.xyz.length,r=t.xyz.nchunks,n="gspline\nelement vertex ".concat(e,"\nelement chunks ").concat(r,"\nelement chunkSize ").concat(t.chunkSize,"\nelement typeChunks ").concat(t.isDynamicChunks?"dynamic":"static","\nproperty xyz ").concat(t.xyz.method,"\nproperty color ").concat(t.color.method,"\nproperty opacity ").concat(t.opacity.method,"\nproperty scaling ").concat(t.scaling.method,"\nproperty quaternion ").concat(t.quaternion.method);if(t.harmonics&&t.harmonics.length>0)for(let S=0;S<t.harmonics.length;S++)n="".concat(n,"\nproperty harmonics_").concat(S," ").concat(t.harmonics[S].method);n="".concat(n,"\nend_header\n");let i=(new TextEncoder).encode(n),a=2*r*4,o=t.xyz.quantized.data.buffer.byteLength,s=t.xyz instanceof Cg?a:0,l=t.color.quantized.data.buffer.byteLength,h=t.color instanceof Cg?a:0,c=t.opacity.quantized.data.buffer.byteLength,u=t.opacity instanceof Cg?a:0,d=t.scaling.quantized.data.buffer.byteLength,p=t.scaling instanceof Cg?a:0,f=t.quaternion.quantized.data.buffer.byteLength,m=t.quaternion instanceof Cg?a:0,v=t.variableChunkSize?Uint16Array.from(t.variableChunkSize):void 0,g=v?v.byteLength:0,y=i.byteLength+g+o+s+l+h+c+u+d+p+f+m,b=0,x=0;if(t.harmonics&&t.harmonics.length>0)for(let S=0;S<t.harmonics.length;S++)b+=t.harmonics[S].quantized.data.buffer.byteLength,x+=t.harmonics[S]instanceof Cg?a:0;b=0,x=0,y+=b+x;let w=new Uint8Array(y),_=0;if(w.set(i,_),_+=i.byteLength,g>0&&(w.set(new Uint8Array(v.buffer),_),_+=g),t.xyz instanceof Cg&&(w.set(new Uint8Array(t.xyz.minmaxMatrix.data.buffer),_),_+=a),w.set(new Uint8Array(t.xyz.quantized.data.buffer),_),_+=o,t.color instanceof Cg&&(w.set(new Uint8Array(t.color.minmaxMatrix.data.buffer),_),_+=a),w.set(new Uint8Array(t.color.quantized.data.buffer),_),_+=l,t.opacity instanceof Cg&&(w.set(new Uint8Array(t.opacity.minmaxMatrix.data.buffer),_),_+=a),w.set(new Uint8Array(t.opacity.quantized.data.buffer),_),_+=c,t.scaling instanceof Cg&&(w.set(new Uint8Array(t.scaling.minmaxMatrix.data.buffer),_),_+=a),w.set(new Uint8Array(t.scaling.quantized.data.buffer),_),_+=d,t.quaternion instanceof Cg&&(w.set(new Uint8Array(t.quaternion.minmaxMatrix.data.buffer),_),_+=a),w.set(new Uint8Array(t.quaternion.quantized.data.buffer),_),_+=f,b>0&&t.harmonics&&t.harmonics.length>0)for(let S=0;S<t.harmonics.length;S++){let e=t.harmonics[S];e instanceof Cg&&(w.set(new Uint8Array(e.minmaxMatrix.data.buffer),_),_+=a),w.set(new Uint8Array(e.quantized.data.buffer),_),_+=e.quantized.data.byteLength}return new Xg(w.buffer)}},Yg=class{};function Qg(t){let e,r,n,i,a,o,s,l,h,c,u,d,p,f,m,v;function g(t,e,o){let s=new Float32Array(c,a,3*r);n=0;let l=new Uint32Array(c,i,r);for(let r=0;r<o.length-1;r++){let i=e[r],a=t[r].elements,h=i.filter((t=>t.enabled&&"Include"===t.mode)).map((t=>"Box"===t.type?b(t):w(t))),c=i.filter((t=>t.enabled&&"Exclude"===t.mode)).map((t=>"Box"===t.type?b(t):w(t)));for(let t=o[r];t<o[r+1];t++){let e=p[3*t],r=p[3*t+1],i=p[3*t+2];if((0===h.length||y(e,r,i,h))&&(0===c.length||!y(e,r,i,c))){let o=1/(a[3]*e+a[7]*r+a[11]*i+a[15]);s[3*n]=(a[0]*e+a[4]*r+a[8]*i+a[12])*o,s[3*n+1]=(a[1]*e+a[5]*r+a[9]*i+a[13])*o,s[3*n+2]=(a[2]*e+a[6]*r+a[10]*i+a[14])*o,l[n]=t,n++}}}}function y(t,e,r,n,i){return n["Intersect"===i?"every":"some"]((n=>{let i=function(t,e,r,n,i){let a=t-i[0],o=e-i[1],s=r-i[2],l=1/(n[3]*a+n[7]*o+n[11]*s+n[15]);return{x:(n[0]*a+n[4]*o+n[8]*s+n[12])*l+i[0],y:(n[1]*a+n[5]*o+n[9]*s+n[13])*l+i[1],z:(n[2]*a+n[6]*o+n[10]*s+n[14])*l+i[2]}}(t,e,r,n.invRotationMatrix,n.cropCenter);return Array.isArray(n)?function(t,e,r,n){return t>=n[0]&&t<=n[3]&&e>=n[1]&&e<=n[4]&&r>=n[2]&&r<=n[5]}(i.x,i.y,i.z,n):function(t,e,r,n){let i=(t-n.cropCenter[0])*n.invRadiusX,a=(e-n.cropCenter[1])*n.invRadiusY,o=(r-n.cropCenter[2])*n.invRadiusZ;return i*i+a*a+o*o<=1}(i.x,i.y,i.z,n)}))}function b(t){let e=t.cropSize[0]/2,r=t.cropSize[1]/2,n=t.cropSize[2]/2,i=[t.cropCenter[0]-e,t.cropCenter[1]-r,t.cropCenter[2]-n,t.cropCenter[0]+e,t.cropCenter[1]+r,t.cropCenter[2]+n],a=x(t.cropRotation);return Object.assign(i,{invRotationMatrix:a,cropCenter:t.cropCenter})}function x(t){let e=[],r=t[0]*Math.PI/180,n=t[1]*Math.PI/180,i=t[2]*Math.PI/180,a=Math.cos(r),o=Math.sin(r),s=Math.cos(n),l=Math.sin(n),h=Math.cos(i),c=Math.sin(i),u=a*h,d=a*c,p=o*h,f=o*c;return e[0]=s*h,e[1]=-s*c,e[2]=l,e[4]=d+p*l,e[5]=u-f*l,e[6]=-o*s,e[8]=f-u*l,e[9]=p+d*l,e[10]=a*s,e[12]=0,e[13]=0,e[14]=0,e[3]=0,e[7]=0,e[11]=0,e[15]=1,e}function w(t){let e=2/t.cropSize[0],r=2/t.cropSize[1],n=2/t.cropSize[2],i=x(t.cropRotation);return{invRadiusX:e,invRadiusY:r,invRadiusZ:n,cropCenter:t.cropCenter,invRotationMatrix:i}}t.onmessage=x=>{if(x.data.getCroppedIndexes){let e=new Uint32Array(function(t,e){let r=[],n=e.filter((t=>t.enabled&&"Include"===t.mode)).map((t=>"Box"===t.type?b(t):w(t))),i=e.filter((t=>t.enabled&&"Exclude"===t.mode)).map((t=>"Box"===t.type?b(t):w(t))),a=t.length;for(let o=0;o<a;o+=3){let e=t[o],a=t[o+1],s=t[o+2];(0===n.length||y(e,a,s,n))&&(0===i.length||!y(e,a,s,i))||r.push(o/3)}return console.log(r),r}(new Float32Array(x.data.positions),x.data.crops)).buffer;t.postMessage({outOfBoundsIndexes:e},[e])}else if(x.data.positions)u=x.data.positions,p=new Float32Array(u),m=x.data.meshMatrixWorlds,v=x.data.cropsArray,f=x.data.meshIndexIntervals,g(m,v,f),t.postMessage({sortSetupComplete:!0});else if(x.data.sort||x.data.newMatrixWorlds||x.data.newCropsArray)(x.data.newMatrixWorlds||x.data.newCropsArray)&&(v=x.data.newCropsArray||v,m=x.data.newMatrixWorlds||m,g(m,v,f)),function(u){let p,f=new Float64Array(c,o,16);for(let t=0;t<16;t++)f[t]=u[t];if(n>1){e.exports.sortIndexes(i,a,h,o,s,l,d.DepthMapRange,n);let t=new Uint32Array(n);p=t.buffer,t.set(new Uint32Array(c,l,n))}else if(1===n){let t=new Uint32Array(n);t[0]=new Uint32Array(c,i,r)[0],p=t.buffer}else p=new ArrayBuffer(0);t.postMessage({sortDone:!0,indexesBuffer:p},[p])}(x.data.sort.view,x.data.sort.cameraPosition);else if(x.data.init){d=x.data.init.Constants,r=x.data.init.splatCount;let n=d.BytesPerInt,u=3*d.BytesPerFloat,p=new Uint8Array(x.data.init.sorterWasmBytes),f=r*(n+u)+(r*d.BytesPerInt*2+d.DepthMapRange*d.BytesPerInt*2)+32*d.MemoryPageSize,m=Math.floor(f/d.MemoryPageSize)+1,v={module:{},env:{memory:new WebAssembly.Memory({initial:2*m,maximum:3*m,shared:!0})}};WebAssembly.compile(p).then((t=>WebAssembly.instantiate(t,v))).then((p=>{e=p,i=0,a=r*n,o=a+r*u,h=o+16*d.BytesPerFloat*2,s=h+r*d.BytesPerInt,l=s+d.DepthMapRange*d.BytesPerInt,c=v.env.memory.buffer,t.postMessage({sortSetupPhase1Complete:!0})}))}}}g(Yg,"DepthMapRange",65536),g(Yg,"MemoryPageSize",65536),g(Yg,"BytesPerFloat",4),g(Yg,"BytesPerInt",4);var Zg=function(){let t=new Float32Array(1),e=new Int32Array(t.buffer);return function(r){return t[0]=r,e[0]}}(),Kg=function(t,e,r,n){return t+(e<<8)+(r<<16)+(n<<24)},Jg=new n.Vector2,$g=class extends n.Mesh{constructor(t,e,r,n){let i=arguments.length>4&&void 0!==arguments[4]&&arguments[4],a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,o=arguments.length>6?arguments[6]:void 0,s=arguments.length>7?arguments[7]:void 0;super(r,n),this.splatCount=e,this.meshIndexIntervals=o,this.meshMatrixWorlds=s,this.splatBuffers=t,this.geometry=r,this.material=n,this.splatDataTextures=null,this.halfPrecisionCovariancesOnGPU=i,this.devicePixelRatio=a,this.resetLocalSplatDataAndTexturesFromSplatBuffer()}static buildMesh(t,e){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,i=arguments.length>4?arguments[4]:void 0,a=arguments.length>5?arguments[5]:void 0,o=$g.buildGeomtery(e),s=$g.buildMaterial(i);return new $g(t,e,o,s,r,n,i,a)}static buildMaterial(t){let e={covariancesTexture:{type:"t",value:null},centersColorsTexture:{type:"t",value:null},meshIndexIntervals:{value:t},meshMatrixWorldsTexture:{type:"t",value:null},focal:{type:"v2",value:new n.Vector2},viewport:{type:"v2",value:new n.Vector2},basisViewport:{type:"v2",value:new n.Vector2},debugColor:{type:"v3",value:new n.Color},covariancesTextureSize:{type:"v2",value:new n.Vector2(1024,1024)},centersColorsTextureSize:{type:"v2",value:new n.Vector2(1024,1024)},orthoZoom:{type:"f",value:-1}};return new n.ShaderMaterial({uniforms:e,vertexShader:"\n            precision highp float;\n            #include <common>\n\n            attribute uint splatIndex;\n\n            uniform highp sampler2D covariancesTexture;\n            uniform highp usampler2D centersColorsTexture;\n            uniform vec2 focal;\n            uniform vec2 viewport;\n            uniform vec2 basisViewport;\n            uniform vec2 covariancesTextureSize;\n            uniform vec2 centersColorsTextureSize;\n\t\t\t\t\t\tuniform highp sampler2D meshMatrixWorldsTexture;\n\t\t\t\t\t\tuniform uint meshIndexIntervals[257];\n\t\t\t\t\t\tuniform float orthoZoom;\n\n            varying vec4 vColor;\n            varying vec2 vUv;\n\n            varying vec2 vPosition;\n\n            const vec4 encodeNorm4 = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0);\n            const uvec4 mask4 = uvec4(uint(0x000000FF), uint(0x0000FF00), uint(0x00FF0000), uint(0xFF000000));\n            const uvec4 shift4 = uvec4(0, 8, 16, 24);\n            vec4 uintToRGBAVec (uint u) {\n               uvec4 urgba = mask4 & u;\n               urgba = urgba >> shift4;\n               vec4 rgba = vec4(urgba) * encodeNorm4;\n               return rgba;\n            }\n\n            vec2 getDataUV(in int stride, in int offset, in vec2 dimensions) {\n                vec2 samplerUV = vec2(0.0, 0.0);\n                float d = float(splatIndex * uint(stride) + uint(offset)) / dimensions.x;\n                samplerUV.y = float(floor(d)) / dimensions.y;\n                samplerUV.x = fract(d);\n                return samplerUV;\n            }\n\n            void main () {\n                uvec4 sampledCenterColor = texture(centersColorsTexture, getDataUV(1, 0, centersColorsTextureSize));\n                vec3 splatCenter = uintBitsToFloat(uvec3(sampledCenterColor.gba));\n                vColor = uintToRGBAVec(sampledCenterColor.r);\n\n                vPosition = position.xy * 2.0;\n\n\t\t\t\t\t\t\t\tuint meshIndex;\n\t\t\t\t\t\t\t\tfor (int i = 1; i < 257; i++) {\n\t\t\t\t\t\t\t\t\tif (splatIndex < meshIndexIntervals[i]) {\n\t\t\t\t\t\t\t\t\t\tmeshIndex = uint(i - 1);\n\t\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tfloat strideMulmeshIndex = float(4u*meshIndex);\n\t\t\t\t\t\t\t\tfloat meshMatrixWorldsTextureLength = float(256*4);\n\n\t\t\t\t\t\t\t\tmat4 modelMat = mat4(\n\t\t\t\t\t\t\t\t\ttexture(meshMatrixWorldsTexture, vec2((strideMulmeshIndex+0.0)/meshMatrixWorldsTextureLength, 0)),\n\t\t\t\t\t\t\t\t\ttexture(meshMatrixWorldsTexture, vec2((strideMulmeshIndex+1.0)/meshMatrixWorldsTextureLength, 0)),\n\t\t\t\t\t\t\t\t\ttexture(meshMatrixWorldsTexture, vec2((strideMulmeshIndex+2.0)/meshMatrixWorldsTextureLength, 0)),\n\t\t\t\t\t\t\t\t\ttexture(meshMatrixWorldsTexture, vec2((strideMulmeshIndex+3.0)/meshMatrixWorldsTextureLength, 0))\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\tmat4 modelViewMat = viewMatrix * modelMat;\n\t\t\t\t\t\t\t\tvec4 viewCenter = modelViewMat * vec4(splatCenter, 1.0); \n                vec4 clipCenter = projectionMatrix * viewCenter;\n\n                vec2 sampledCovarianceA = texture(covariancesTexture, getDataUV(3, 0, covariancesTextureSize)).rg;\n                vec2 sampledCovarianceB = texture(covariancesTexture, getDataUV(3, 1, covariancesTextureSize)).rg;\n                vec2 sampledCovarianceC = texture(covariancesTexture, getDataUV(3, 2, covariancesTextureSize)).rg;\n\n                vec3 cov3D_M11_M12_M13 = vec3(sampledCovarianceA.rg, sampledCovarianceB.r);\n                vec3 cov3D_M22_M23_M33 = vec3(sampledCovarianceB.g, sampledCovarianceC.rg);\n\n                // Compute the 2D covariance matrix from the upper-right portion of the 3D covariance matrix\n                mat3 Vrk = mat3(\n                    cov3D_M11_M12_M13.x, cov3D_M11_M12_M13.y, cov3D_M11_M12_M13.z,\n                    cov3D_M11_M12_M13.y, cov3D_M22_M23_M33.x, cov3D_M22_M23_M33.y,\n                    cov3D_M11_M12_M13.z, cov3D_M22_M23_M33.y, cov3D_M22_M23_M33.z\n                );\n                float s = 1.0 / (viewCenter.z * viewCenter.z);\n\n                mat3 W = transpose(mat3(modelViewMat));\n                mat3 T = orthoZoom > 0.0 ? W : W * mat3(\n\t\t\t\t\t\t\t\t\tfocal.x / viewCenter.z, 0., -(focal.x * viewCenter.x) * s,\n\t\t\t\t\t\t\t\t\t0., focal.y / viewCenter.z, -(focal.y * viewCenter.y) * s,\n\t\t\t\t\t\t\t\t\t0., 0., 0.\n\t\t\t\t\t\t\t\t);\n                mat3 cov2Dm = transpose(T) * Vrk * T;\n                cov2Dm[0][0] += 0.3;\n                cov2Dm[1][1] += 0.3;\n\n                // We are interested in the upper-left 2x2 portion of the projected 3D covariance matrix because\n                // we only care about the X and Y values. We want the X-diagonal, cov2Dm[0][0],\n                // the Y-diagonal, cov2Dm[1][1], and the correlation between the two cov2Dm[0][1]. We don't\n                // need cov2Dm[1][0] because it is a symetric matrix.\n                vec3 cov2Dv = vec3(cov2Dm[0][0], cov2Dm[0][1], cov2Dm[1][1]);\n\n                vec3 ndcCenter = clipCenter.xyz / clipCenter.w;\n\n                // We now need to solve for the eigen-values and eigen vectors of the 2D covariance matrix\n                // so that we can determine the 2D basis for the splat. This is done using the method described\n                // here: https://people.math.harvard.edu/~knill/teaching/math21b2004/exhibits/2dmatrices/index.html\n                //\n                // This is a different approach than in the original work at INRIA. In that work they compute the\n                // max extents of the 2D covariance matrix in screen space to form an axis aligned bounding rectangle\n                // which forms the geometry that is actually rasterized. They then use the inverse 2D covariance\n                // matrix (called 'conic') to determine fragment opacity.\n                float a = cov2Dv.x;\n                float d = cov2Dv.z;\n                float b = cov2Dv.y;\n                float D = a * d - b * b;\n                float trace = a + d;\n                float traceOver2 = 0.5 * trace;\n                float term2 = sqrt(trace * trace / 4.0 - D);\n                float eigenValue1 = traceOver2 + term2;\n\t\t\t\t\t\t\t\tfloat eigenValue2 = max(traceOver2 - term2, 0.00); // prevent negative eigen value\n\n                const float maxSplatSize = 1024.0;\n                vec2 eigenVector1 = normalize(vec2(b, eigenValue1 - a));\n                // since the eigen vectors are orthogonal, we derive the second one from the first\n                vec2 eigenVector2 = vec2(eigenVector1.y, -eigenVector1.x);\n                vec2 basisVector1 = eigenVector1 * min(sqrt(2.0 * eigenValue1), maxSplatSize);\n                vec2 basisVector2 = eigenVector2 * min(sqrt(2.0 * eigenValue2), maxSplatSize);\n\n                vec2 ndcOffset = vec2(vPosition.x * basisVector1 + vPosition.y * basisVector2) * basisViewport;\n\n\t\t\t\t\t\t\t\tif (orthoZoom > 0.0) {\n\t\t\t\t\t\t\t\t\tndcOffset *= orthoZoom;\n\t\t\t\t\t\t\t\t}\n\n                gl_Position = vec4(ndcCenter.xy + ndcOffset, ndcCenter.z, 1.0);\n            }",fragmentShader:"\n            precision highp float;\n            #include <common>\n\n            uniform vec3 debugColor;\n\n            varying vec4 vColor;\n            varying vec2 vUv;\n\n            varying vec2 vPosition;\n\t\t\t\t\t\tlayout(location = 1) out vec4 gVelocity; \n\n            void main () {\n                // compute the negative squared distance from the center of the splat to the\n                // current fragment in the splat's local space.\n                float A = -dot(vPosition, vPosition);\n                if (A < -4.0) discard;\n                vec3 color = vColor.rgb;\n                A = exp(A) * vColor.a;\n                gl_FragColor = vec4(color.rgb, A);\n\t\t\t\t\t\t\t\tgVelocity = vec4(0.0); // so it is ignored by TAA\n            }",transparent:!0,alphaTest:1,blending:n.NormalBlending,depthTest:!0,depthWrite:!1,side:n.DoubleSide})}static buildGeomtery(t){let e=new n.BufferGeometry;e.setIndex([0,1,2,0,2,3]);let r=new Float32Array(12),i=new n.BufferAttribute(r,3);e.setAttribute("position",i),i.setXYZ(0,-1,-1,0),i.setXYZ(1,-1,1,0),i.setXYZ(2,1,1,0),i.setXYZ(3,1,-1,0),i.needsUpdate=!0;let a=(new n.InstancedBufferGeometry).copy(e),o=new Uint32Array(t),s=new n.InstancedBufferAttribute(o,1,!1);return s.setUsage(n.DynamicDrawUsage),a.setAttribute("splatIndex",s),a.instanceCount=t,a}resetLocalSplatDataAndTexturesFromSplatBuffer(){this.updateLocalSplatDataFromSplatBuffer(),this.allocateAndStoreLocalSplatDataInTextures()}updateLocalSplatDataFromSplatBuffer(){this.splatBuffers.forEach((t=>t.buildPreComputedBuffers())),this.covariances=new Float32Array(6*this.splatCount),this.colors=new Uint8Array(4*this.splatCount),this.centers=new Float32Array(3*this.splatCount);let t=0,e=0,r=0;for(let n of this.splatBuffers){let i=n.nsplats;this.colors.subarray(t,t+4*i).set(n.colorsA),t+=4*i,this.centers.subarray(e,e+3*i).set(n.decoded.xyz.denormDequant().data),e+=3*i,this.covariances.subarray(r,r+6*i).set(new Float32Array(n.precomputedCovarianceBufferData)),r+=6*i}}allocateAndStoreLocalSplatDataInTextures(){let t=this.splatCount,e=new n.Vector2(4096,1024);for(;e.x*e.y*2<6*t;)e.y*=2;let r,i,a=new n.Vector2(4096,1024);for(;a.x*a.y*4<4*t;)a.y*=2;if(this.halfPrecisionCovariancesOnGPU){i=new Uint16Array(e.x*e.y*2);for(let t=0;t<this.covariances.length;t++)i[t]=n.DataUtils.toHalfFloat(this.covariances[t]);r=new n.DataTexture(i,e.x,e.y,n.RGFormat,n.HalfFloatType)}else i=new Float32Array(e.x*e.y*2),i.set(this.covariances),r=new n.DataTexture(i,e.x,e.y,n.RGFormat,n.FloatType);r.needsUpdate=!0,this.material.uniforms.covariancesTexture.value=r,this.material.uniforms.covariancesTextureSize.value.copy(e);let o=new Uint32Array(a.x*a.y*4);for(let n=0;n<t;n++){let t=4*n,e=3*n,r=4*n;o[r]=Kg(this.colors[t],this.colors[t+1],this.colors[t+2],this.colors[t+3]),o[r+1]=Zg(this.centers[e]),o[r+2]=Zg(this.centers[e+1]),o[r+3]=Zg(this.centers[e+2])}let s=new n.DataTexture(o,a.x,a.y,n.RGBAIntegerFormat,n.UnsignedIntType);s.internalFormat="RGBA32UI",s.needsUpdate=!0,this.material.uniforms.centersColorsTexture.value=s,this.material.uniforms.centersColorsTextureSize.value.copy(a);let l=new Float32Array(4096);for(let n=0;n<this.meshMatrixWorlds.length;n++)l.set(this.meshMatrixWorlds[n].elements,16*n);let h=new n.DataTexture(l,1024,1,n.RGBAFormat,n.FloatType);h.needsUpdate=!0,this.material.uniforms.meshMatrixWorldsTexture.value=h,this.material.uniformsNeedUpdate=!0,this.splatDataTextures={covariances:{data:i,texture:r,size:e},centerColors:{data:o,texture:s,size:a},meshMatrixWorlds:{data:l,texture:h}}}updateIndexes(t){let e=this.geometry;e.attributes.splatIndex.set(t),e.attributes.splatIndex.needsUpdate=!0,e.instanceCount=t.length}updateUniforms(t,e,r,n){this.splatCount>0&&(Jg.set(t.x*this.devicePixelRatio,t.y*this.devicePixelRatio),this.material.uniforms.viewport.value.copy(Jg),this.material.uniforms.basisViewport.value.set(2/Jg.x,2/Jg.y),this.material.uniforms.focal.value.set(e,r),this.material.uniforms.orthoZoom.value=n,this.material.uniformsNeedUpdate=!0)}getSplatDataTextures(){return this.splatDataTextures}getSplatCount(){return this.splatCount}getCenters(){return this.centers}getColors(){return this.colors}getCovariances(){return this.covariances}dispose(){this.geometry.dispose(),this.material.dispose(),this.splatDataTextures&&(this.splatDataTextures.covariances.texture.dispose(),this.splatDataTextures.centerColors.texture.dispose(),this.splatDataTextures.meshMatrixWorlds.texture.dispose())}},ty=class{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};g(this,"updateSplatMeshUniforms",function(){let t=new n.Vector2;return function(){null!==this.splatMesh&&this.splatMesh.getSplatCount()>0&&(this.renderer.getSize(t),this.cameraFocalLengthX=this.camera.projectionMatrix.elements[0]*this.devicePixelRatio*t.x*.45,this.cameraFocalLengthY=this.camera.projectionMatrix.elements[5]*this.devicePixelRatio*t.y*.45,this.splatMesh.updateUniforms(t,this.cameraFocalLengthX,this.cameraFocalLengthY,this.camera.isPerspectiveCamera?-1:this.camera.zoom*this.devicePixelRatio))}}()),g(this,"updateView",function(){let t=new n.Matrix4,e=[],r=new n.Vector3(0,0,-1),i=new n.Vector3(0,0,-1),a=new n.Vector3,o=new n.Vector3;return function(){let n=arguments.length>0&&void 0!==arguments[0]&&arguments[0],s=this.updateMatrixWorldsInWorkerIfNeeded(),l=this.cropsChanged();if(!n){i.set(0,0,-1).applyQuaternion(this.camera.quaternion);let t=!1,e=!1;if(i.dot(r)<=.95&&(t=!0),o.copy(this.camera.position).sub(a).length()>=1&&(e=!0),!t&&!e&&!s&&!l)return}a.copy(this.camera.position),r.copy(i),t.copy(this.camera.matrixWorld).invert(),t.premultiply(this.camera.perspCamera.projectionMatrix),e[0]=this.camera.position.x,e[1]=this.camera.position.y,e[2]=this.camera.position.z;let h={sort:{view:t.elements,cameraPosition:e,splatRenderCount:this.splatRenderCount,splatSortCount:this.splatRenderCount},...s?{newMatrixWorlds:this.meshMatrixWorlds}:{},...l?{newCropsArray:this.cropsArray}:{}};this.sortRunning?this.queuedMessage=h:(this.queuedMessage=null,this.sortRunning=!0,this.sortWorker.postMessage(h))}}()),this.scene=t.scene,this.currentPage=null,this.renderer=t.renderer,this.devicePixelRatio=window.devicePixelRatio,this.sortWorker=null,this.splatRenderCount=0,this.splatSortCount=0,this.splatMesh=null,this.sortRunning=!1,this.splatRenderingInitialized=!1,this.meshMatrixWorlds=null,this.meshMatrixWorldsOld=null,this.cropsArray=null,this.splatEntries=null,this.queuedMessage=null}get camera(){return this.scene.activeCamera}reloadSplats(){this.splatRenderingInitialized=!1;let t=this.loadSplat();this.renderer.pipeline.opaquePass.splatViewer=t?this:null}loadSplat(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.activePage=this.scene.activePage,t.position&&(t.position=(new n.Vector3).fromArray(t.position)),t.orientation&&(t.orientation=(new n.Quaternion).fromArray(t.orientation)),t.halfPrecisionCovariances=!!t.halfPrecisionCovariances;let e=[];if(this.splatEntries=e,this.activePage.traverseEntity((t=>{if("Splat"===t.data.type){let r=t.visible;t.traverseAncestors((t=>{r&&(r=t.visible)})),r&&e.push(t)}})),this.splatMesh&&this.splatMesh.dispose(),0===e.length)return this.splatMesh=null,!1;this.meshMatrixWorlds=e.map((t=>t.matrixWorld)),this.meshMatrixWorldsOld=e.map((t=>t.matrixWorld.clone())),this.cropsArray=e.map((t=>t.data.crops.map((t=>t.data))));let r=e.map((t=>new Xg(new Uint8Array(t.data.buffer).buffer))),i=0,a=[0];for(let n of r)i+=n.getSplatCount(),a.push(i);return this.setupSplatMesh(r,i,t.position,t.orientation,t.halfPrecisionCovariances,this.devicePixelRatio,a,this.meshMatrixWorlds),this.setupSortWorker(i),!0}updateMatrixWorldsInWorkerIfNeeded(){let t=this.splatDataTextures.meshMatrixWorlds.data;for(let e=0;e<this.meshMatrixWorlds.length;e++)t.set(this.meshMatrixWorlds[e].elements,16*e);return this.splatDataTextures.meshMatrixWorlds.texture.needsUpdate=!0,!this.meshMatrixWorlds.every(((t,e)=>t.equals(this.meshMatrixWorldsOld[e])))&&(this.meshMatrixWorldsOld=this.meshMatrixWorlds.map((t=>t.clone())),!0)}cropsChanged(){let t=!1;return this.splatEntries.forEach(((e,r)=>{var n;e.data.crops.forEach(((e,n)=>{void 0===this.cropsArray[r][n]?(t=!0,this.cropsArray[r][n]=e.data):Object.entries(e.data).forEach((e=>{var i;let[a,o]=e;(Array.isArray(o)&&o.some(((t,e)=>t!==this.cropsArray[r][n][a][e]))||o!==(null===(i=this.cropsArray[r][n])||void 0===i?void 0:i[a]))&&(t=!0,this.cropsArray[r][n][a]=o)}))})),e.data.crops.length!==(null===(n=this.cropsArray[r])||void 0===n?void 0:n.length)&&(this.cropsArray[r].length=e.data.crops.length,t=!0)})),t}setupSplatMesh(t,e){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new n.Vector3,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new n.Quaternion,a=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,s=arguments.length>6?arguments[6]:void 0,l=arguments.length>7?arguments[7]:void 0;this.splatMesh=$g.buildMesh(t,e,a,o,s,l),this.splatMesh.position.copy(r),this.splatMesh.quaternion.copy(i),this.splatMesh.frustumCulled=!1,this.splatMesh.renderOrder=10,this.updateSplatMeshUniforms(),this.splatRenderCount=e}setupSortWorker(t){this.sortWorker=function(t){let e=new Worker(URL.createObjectURL(new Blob(["(",Qg.toString(),")(self)"],{type:"application/javascript"}))),r=atob("AGFzbQEAAAAADwhkeWxpbmsuMAEEAAAAAAETA2AAAGAIf39/f39/f38AYAABfwISAQNlbnYGbWVtb3J5AgMAgIAEAwQDAAECBzkDEV9fd2FzbV9jYWxsX2N0b3JzAAALc29ydEluZGV4ZXMAARNlbXNjcmlwdGVuX3Rsc19pbml0AAIK3gMDAwABC9IDAwF/BnwBfgJAIAdFDQAgAysDUCEMIAMrAzAhDSADKwMQIQ5BACEDRP///////+9/IQtEAAAAAAAAEAAhCgNAIAIgA0ECdGoCfyAOIAEgA0EMbGoiCCoCALuiIA0gCCoCBLuioCAMIAgqAgi7oqBEAAAAAAAAsECiIgmZRAAAAAAAAOBBYwRAIAmqDAELQYCAgIB4CzYCACAJIAsgCSALYxshCyAJIAogCSAKZBshCiADQQFqIgMgB0cNAAsgB0UNACAGuCAKIAuhoyEJQQAhAwNAAn8gCSACIANBAnRqIgEoAgC3IAuhoiIKmUQAAAAAAADgQWMEQCAKqgwBC0GAgICAeAshCCABIAg2AgAgBCAIQQJ0aiIBIAEoAgBBAWo2AgAgA0EBaiIDIAdHDQALCyAGQQJPBEAgBCgCACEIQQEhAwNAIAQgA0ECdGoiASABKAIAIAhqIgg2AgAgA0EBaiIDIAZHDQALCyAHQQFrIgGtIQ8DQCAEIAIgD6dBAnQiA2ooAgBBAnRqIgcgBygCAEEBayIHNgIAIAUgASAHa0ECdGogACADaigCADYCACAPUCEDIA9CAX0hDyADRQ0ACyAGBEAgBEEAIAZBAnT8CwALCwQAQQAL"),n=new Uint8Array(r.length);for(let i=0;i<r.length;i++)n[i]=r.charCodeAt(i);return e.postMessage({init:{sorterWasmBytes:n.buffer,splatCount:t,Constants:{BytesPerFloat:Yg.BytesPerFloat,BytesPerInt:Yg.BytesPerInt,DepthMapRange:Yg.DepthMapRange,MemoryPageSize:Yg.MemoryPageSize}}}),e}(t),this.sortWorker.onmessage=t=>{var e;t.data.sortDone?(this.sortRunning=!1,null!==(e=this.splatMesh)&&void 0!==e&&e.updateIndexes(new Uint32Array(t.data.indexesBuffer)),this.lastSortTime=t.data.sortTime,this.queuedMessage&&(this.sortWorker.postMessage(this.queuedMessage),this.queuedMessage=null)):t.data.sortCanceled?this.sortRunning=!1:t.data.sortSetupPhase1Complete?this.sortWorker.postMessage({positions:this.splatMesh.getCenters().buffer,meshMatrixWorlds:this.splatMesh.meshMatrixWorlds,meshIndexIntervals:this.splatMesh.meshIndexIntervals,cropsArray:this.cropsArray}):t.data.sortSetupComplete&&(this.splatDataTextures=this.splatMesh.getSplatDataTextures(),this.updateView(!0,!0),this.splatRenderingInitialized=!0)}}update(){!1!==this.splatRenderingInitialized&&(this.updateSplatMeshUniforms(),this.updateView())}getSplatMesh(){return this.splatMesh}};(new n.MeshBasicMaterial).wireframe=!0;var ey,ry=new n.Vector3,ny=class extends n.Scene{constructor(t,e){super(),this.data=t,this.enableHelpers=!1,this.wireframeState=!1,this.needsTransmissionDirty=!0,this.needsNormalDirty=!0,this._needsTransmission=!1,this._needsNormal=!1,this.geometryCacheChanged=!1,this.splatViewer=null,this.entityByUuid={},this.entityIdentityToEntity={},this.toExpandCloner=new Set,this.toUpdateCloner=new Set,this.pendingCommands=[],this.pathConstraints=new bg,this.errorPage=new ng("fdasfa",{...rl.defaultData,name:""}),this.invisibleObjects=new qv("jflkdsafjasdifjaslk",{...Qs.defaultData,visible:!1,name:"buildin invisible"}),this.needsRecomputeInstances=!1,this.init(t,e),this.matrixAutoUpdate=!1}markGeometryCacheDirty(){this.geometryCacheChanged=!0}markNeedsUpdateRendererDirty(){this.needsTransmissionDirty=!0,this.needsNormalDirty=!0}needsTransmission(){return this.needsTransmissionDirty&&(this._needsTransmission=function(t){let e=!1;return t.traverseEntity((t=>{if(t instanceof gm)if(Array.isArray(t.material))for(let r=0;r<t.material.length;r++)fg(t,t.material[r])&&(e=!0);else fg(t,t.material)&&(e=!0)})),e}(this),this.needsTransmissionDirty=!1),this._needsTransmission}needsNormal(){return this.needsNormalDirty&&(this._needsNormal=function(t){let e=!1;return t.traverseEntity((t=>{if(t instanceof gm)if(Array.isArray(t.material))for(let r=0;r<t.material.length;r++)pg(t,t.material[r])&&(e=!0);else pg(t,t.material)&&(e=!0)})),e}(this),this.needsNormalDirty=!1),this._needsNormal}registerInstanceAndSetUuid(t){let e=t.identity.join("-"),r=this.entityIdentityToEntity[e];r&&(t.uuid=r.uuid),this.entityIdentityToEntity[e]=t,this.entityByUuid[t.uuid]=t}markPenumbraSizeDirty(){for(let t of this.children)t instanceof ng&&(t.penumbraSizeArrayCache=null)}findInstance(t){return this.entityIdentityToEntity[t.join("-")]}get bgColor(){return this.activePage.bgColor}get postprocessing(){return this.activePage.data.postprocessing}getWithSortKey(t){let e=this.find(t);if(void 0===e)return;let r=[],n=e;for(;n!==this;){let t=n;n=n.parent;let e=n.children.indexOf(t);r.splice(0,0,e)}return{entity:e,sortKey:r}}getAllSorted(t){let e=[];for(let r of t){let t=this.getWithSortKey(r.id);void 0!==t&&e.push(t)}return e.sort(((t,e)=>function(t,e){let r=0;for(;r<t.length&&r<e.length;){if(t[r]<e[r])return-1;if(t[r]>e[r])return 1;r+=1}return r!==e.length?-1:r!==t.length?1:0}(t.sortKey,e.sortKey))),e.map((t=>t.entity))}nonExistOrDescendantOf(t,e){let r=this.find(t);if(void 0===r)return!0;for(;r;){if(r.uuid===e)return!0;r=r.parent}return!1}find(t){if(this.activePage&&this.activePage.personalCamera.parent){if("f23858d0-4a3b-4bd8-8173-66ed0af7f6fb-personalCamera"===t)return this.activePage.personalCamera;if(t===ss)return this.activePage.personalCamera}if(""===t||void 0===t)return;let e=this.entityByUuid[t];return void 0===e?this.getObjectByProperty("uuid",t):e}debugEnsureEntity(t){let e=this.find(t);e?Array.isArray(e.identity)&&void 0===this.findInstance(e.identity)&&console.error("not found instance"):console.error("not found")}addPendingExpandCloner(t){this.toExpandCloner.add(t)}addPendingUpdateCloner(t){this.toUpdateCloner.add(t)}markToExpandCloner(t){this.toExpandCloner.add(t),t.traverseEntityAncestors((t=>{this.toExpandCloner.add(t)}))}doPendingExpandCloner(){this.toExpandCloner.forEach((t=>{t.expandCloner(this)})),this.toExpandCloner.clear()}doPendingUpdateCloner(){this.toUpdateCloner.forEach((t=>{var e;null===(e=t.cloner)||void 0===e||e.update()})),this.toUpdateCloner.clear()}doPendingUpdates(){this.doPendingExpandCloner(),this.doPendingUpdateCloner(),this.applyPendingCommands()}addPendingCommand(t){this.pendingCommands.push(t)}applyPendingCommands(){this.pendingCommands.forEach((t=>t())),this.pendingCommands.length=0}updateByLibOp(t,e){1===t.path.length&&"components"===t.path[0]&&1===t.type&&this.createChildrenObjects([{...t.data.asset,id:t.id}],this.invisibleObjects,e)}updateTreeByOp(t,e){if(0===t.path.length&&7===t.type){let r=null===t.parent?this:this.find(t.parent);if(void 0===r)throw new Error("unexpected");let n=this.createObject(t.id,t.data,t.children,r,t.localIndex,e);n.updateVisible(),n.resetBBoxNeedsUpdate(),Nv(n)&&Rv(n.parent)&&(n.invalidateUpstreamBooleanData(),n.parent.invalidateDownstreamBooleanData().recomputeBoolean()),this.markNeedsRecomputeInstancesForAncessors(r),this.markNeedsRecomputeInstancesForChildren(n),this.markToExpandCloner(n),this.markPenumbraSizeDirty(),n.updatePathSnapping()}else if(0===t.path.length&&8===t.type){let e=this.find(t.id);if(void 0===e)throw new Error("unexpected");this.markToExpandCloner(e),e.resetBBoxNeedsUpdate(),this.unregisterObject(e);let r=e.parent;this.markNeedsRecomputeInstancesForAncessors(r),this.markNeedsRecomputeInstancesForChildren(e),this.markPenumbraSizeDirty(),e.parent.remove(e),Rv(e.parent)&&(e.parent.invalidateUpstreamBooleanData(),e.parent.invalidateDownstreamBooleanData().recomputeBoolean()),Nv(e)&&(e.freeBooleanPointer(),r instanceof Uv&&r.invalidateDownstreamBooleanData().recomputeBoolean()),e instanceof og&&e.detachShape(),this.disposeAndUnregisterEntityRecursivelyIfNotReregistered(e),this.pathConstraints.removeDependencies(e.uuid),e.updatePathSnapping()}else if(0===t.path.length&&9===t.type){var r;let e=this.find(t.id);if(void 0===e)throw new Error("unexpected");this.markNeedsRecomputeInstancesForChildren(e);let n=e.parent;this.markNeedsRecomputeInstancesForAncessors(n),null!==(r=e.cloner)&&void 0!==r&&r.resetOnMove(),this.markToExpandCloner(e);let i=null===t.parent?this:this.find(t.parent);if(void 0===i)throw new Error("unexpected");i.add(e),this.markNeedsRecomputeInstancesForAncessors(i),this.markToExpandCloner(e),e.invalidateClonerTransform(e),e.updateVisible(),e.resetBBoxNeedsUpdate(),this.markPenumbraSizeDirty();let a=t.localIndex;i.children.splice(a,0,i.children.pop()),Nv(e)&&(e.invalidateUpstreamBooleanData(),Rv(e.parent)?e.parent.invalidateDownstreamBooleanData().recomputeBoolean():n instanceof Uv&&n.invalidateDownstreamBooleanData().recomputeBoolean()),e.updatePathSnapping()}this.markNeedsUpdateRendererDirty(),this.markGeometryCacheDirty()}get playPage(){var t;return null!==(t=this.find(this.data.publish.playPage))&&void 0!==t?t:this.errorPage}updatePage(t){var e;this.activePage&&this.activePage.onDeactive(),this.activePage=this.errorPage;for(let r of this.children)r instanceof ng&&(r.visible=r.uuid===t,r.visible&&(this.activePage=r,this.activePage.onActive(this)));this.activePage!==(null===(e=this.splatViewer)||void 0===e?void 0:e.activePage)&&this.reloadSplats()}updateEntityByOp(t,e,r,n){if(0===e.type){if(("overrides"in e.props||"component"in e.props)&&this.markNeedsRecomputeInstances(),"visible"in e.props&&this.markPenumbraSizeDirty(),e.path.includes("overrides")&&"states"in e.props){let{rest:t}=e.props;e={...e,props:t},this.markNeedsRecomputeInstances()}"pathSnapping"===e.path[0]&&void 0!==e.props.pathId&&this.pathConstraints.setConstraint(t,e.props.pathId)}let i=this.find(t);if(i)try{(function(t,e,r,n){t.updateByOp(e,r,n,!1)})(i,e,r,{scene:this,shared:n}),i instanceof Sm&&i.updateGeometryGroupsIfNeeded()}catch(Ho){console.error(Ho)}}get activeCamera(){return this.activePage.activeCamera}switchActiveCamera(t){this.activePage.switchActiveCamera(t)}isInvisibleObjects(t){return t===this.invisibleObjects||t.hasAnccestor(this.invisibleObjects)}init(t,e){let r=Object.entries(e.data.lib.components).map(((t,e)=>({data:t[1].asset.data,children:t[1].asset.children,id:t[0],fi:e})));this.invisibleObjects.updateState(this.invisibleObjects.data,{scene:this,shared:e}),this.add(this.invisibleObjects),this.createChildrenObjects(r,this.invisibleObjects,e),this.createChildrenObjects(t.objects,this,e),this.updatePage(t.publish.playPage),this.activePage.switchToPlayCamera(),this.expandInstances(e,!0),this.traverseEntity((t=>{t instanceof Ev&&t.updateUp()})),this.doPendingExpandCloner(),this.applyPendingCommands()}markNeedsRecomputeInstances(){this.needsRecomputeInstances=!0}markNeedsRecomputeInstancesForChildren(t){t.traverseEntity((t=>{("Component"===t.data.type||"Instance"===t.data.type)&&this.markNeedsRecomputeInstances()}))}markNeedsRecomputeInstancesForAncessors(t){hh.is(t)&&("Component"===t.data.type&&this.markNeedsRecomputeInstances(),t.traverseAncestors((t=>{hh.is(t)&&"Component"===t.data.type&&this.markNeedsRecomputeInstances()})))}relativeizeInner(t,e,r,n,i,a,o){if(t){let s=n.find(t);s&&s!==n&&i.forInstancesRec((n=>{n.data=ca(n.data,(i=>{let s=i.events.data(o.id),l=n.goUp(a);if(l){let n=[...I(l.identity),t].join("-"),i=this.entityIdentityToEntity[n];if(i){let t=i.uuid;oa.zoom(s,e)[r]=t}else console.warn("cannot find instance")}})).data}))}}rewriteActions(t,e,r,n,i,a){t.forEach((t=>{("Transition"===t.data.type||"Animation"===t.data.type)&&this.relativeizeInner(t.data.object,[...e,t.id],"object",r,n,i,a)}))}rewriteEventsBeforeGoToPlayMode(){this.traverseEntity((t=>{if(t instanceof sg&&"string"==typeof t.identity&&"Component"===t.data.type)return t.traverseEntity(((e,r)=>{e.data.events.forEach((n=>{if("GameControl"===n.data.type){let i=!1;if(e.forInstancesRec((t=>{t.data=ca(t.data,(e=>{t.isInstanceRoot||(e.events.delete(n.id),i=!0)})).data})),!1===i)for(let a of xl.list)this.rewriteActions(n.data.gameActions[a],["gameActions",a],t,e,r,n)}else"Conditional"===n.data.type?("Distance"===n.data.condition.type?(this.relativeizeInner(n.data.condition.fromObject,["condition"],"fromObject",t,e,r,n),this.relativeizeInner(n.data.condition.toObject,["condition"],"toObject",t,e,r,n)):"State"===n.data.condition.type?this.relativeizeInner(n.data.condition.object,["condition"],"object",t,e,r,n):"Comparison"===n.data.condition.type&&("Property"===n.data.condition.lOperand.type&&this.relativeizeInner(n.data.condition.lOperand.value[0],["condition","lOperand","value"],0,t,e,r,n),"Property"===n.data.condition.rOperand.type&&this.relativeizeInner(n.data.condition.rOperand.value[0],["condition","rOperand","value"],0,t,e,r,n)),this.rewriteActions(n.data.inActions,["inActions"],t,e,r,n),this.rewriteActions(n.data.outActions,["outActions"],t,e,r,n)):"actions"in n.data&&this.rewriteActions(n.data.actions,["actions"],t,e,r,n)}))})),!0}))}expandInstances(t,e,r){let n=new Set;this.traverseEntity((i=>{if(i instanceof sg&&i.isInstanceRoot)return i.expandInstanceChildren({scene:this,shared:t,pendingDeletes:n}),e||i.resetBBoxNeedsUpdate(),r&&i.traverseEntity((t=>{r.addClip(t)})),!0}));for(let i of n)this.disposeAndUnregisterEntityRecursivelyIfNotReregistered(i),lg(i)}recomputeInstances(t,e){this.needsRecomputeInstances&&(this.needsRecomputeInstances=!1,this.traverseEntity((t=>{t instanceof sg&&t.isInstanceRoot&&(t.component=void 0)})),this.expandInstances(t,!1,e))}disposeAndUnregisterEntityRecursivelyIfNotReregistered(t){t.traverseEntity((t=>{let e="string"==typeof t.identity?t.identity:t.identity.join("-");this.entityIdentityToEntity[e]===t&&(delete this.entityByUuid[t.uuid],delete this.entityIdentityToEntity[e]),t.dispose()}))}clearScene(){for(let t of this.children)hh.is(t)&&t.disposeRecursively();this.children.length=0}resetAfterClear(t,e){this.init(t,e)}raycast(t){return this.raycast1(t,!1)}raycast1(t,e){let r=[],n=i=>{for(let a of i.children){let i=a.cloner;if(hh.is(a)&&!a.raycastLock&&(a.visible||null!==i&&void 0!==i&&i.object.data.visible))if(!0===e&&a.isInstanceRoot){let e=[];if(t.intersectObject(a,!0,e),e.length){let t=e[0];t.object=a,t.point.applyMatrix4(t.object.matrixWorld);let n=a.matrixWorld.clone().invert();t.point.applyMatrix4(n),r.push(t)}}else(Nv(a)||Fv(a)&&this.enableHelpers&&a.objectHelper.visible)&&(t.intersectObject(a,!1,r),yg(a,t,r)),n(a)}};return n(this),r}raycastWithClones(t){let e=[],r=n=>{for(let i of n.children){let n=i.cloner;hh.is(i)&&(i.visible||(null===n||void 0===n?void 0:n.object.data.visible))&&((Nv(i)||Fv(i)&&this.enableHelpers&&i.objectHelper.visible)&&(t.intersectObject(i,!1,e),yg(i,t,e,!0)),r(i))}};return r(this),e}forEachEntity(t){for(let e of this.children)hh.is(e)&&t(e)}traverseConcreteEntity(t){for(let e of this.children)hh.is(e)&&e.isConcreteEntity&&e.traverseEntity(t)}traverseEntity(t){for(let e of this.children)hh.is(e)&&e.traverseEntity(t)}updateFont(t,e){this.traverseEntity((r=>{if(r instanceof Sm&&"Mesh"===r.data.type&&"TextGeometry"===r.data.geometry.type&&r.data.geometry.font===t){let n=r.geometry,i=r.data.geometry;n.updateFont(t,e).then((()=>{n.update(i);let t=r.invalidateDownstreamBooleanData();Rv(t)&&t.recomputeBoolean()}))}}))}traverseObject(t){for(let e of this.children)rh.is(e)&&e.traverseObject(t)}traverseVisibleEntity(t){for(let e of this.children)hh.is(e)&&e.visible&&e.traverseVisibleEntity(t)}dispose(){this.clearScene()}createChildrenObjects(t,e,r){let n=0;for(let i of t)this.createObject(i.id,i.data,i.children,e,n,r),n+=1}registerObjectCreatedInLegacy(t){this.entityByUuid[t.uuid]=t}unregisterObject(t){delete this.entityByUuid[t.uuid];for(let e of t.children)this.unregisterObject(e)}createObject(t,e,r,i,a,o){var s;let l={scene:this,shared:o},h=dg(t,e,l);return h&&(this.entityByUuid[t]=h,i.add(h),i.children.splice(a,0,i.children.pop()),r.length>0&&(h.isInstanceRoot?console.error("instance should not have children!"):this.createChildrenObjects(r,h,o)),h.updateState(e,l),h instanceof Sm&&h.updateGeometryGroupsIfNeeded(),h.updateVisible(),h.cloner&&this.toExpandCloner.add(h),null!==(s=e.pathSnapping)&&void 0!==s&&s.pathId&&this.pathConstraints.setConstraint(t,e.pathSnapping.pathId)),"Empty"===e.type&&e.animations&&h.traverseEntity((t=>{let e=t.dataPatched;if(t instanceof Sm&&e.bones&&e.boneInverses){let r=e.bones.map((t=>this.find(t))),i=e.boneInverses.map((t=>(new n.Matrix4).fromArray(t))),a=new n.Skeleton(r,i);t.bind(a,t.bindMatrix)}else t.matrixAutoUpdate=!0})),h}getCenter(t){let e=[];for(let n=0,i=t.length;n<i;++n){let{id:r,recursive:i}=t[n],a=this.find(r),o=i?a.recursiveBBox:a.singleBBox;e.push(...o.vertices)}let r=new n.Box3;return r.setFromPoints(e),r.getCenter(ry),ry}copyMatrixWorld(t,e){if(null===t)return void e.identity();let r=this.find(t);r?e.copy(r.matrixWorld):e.identity()}copyParentMatrixWorld(t,e){var r;if(null===t)return void e.identity();let n=null===(r=this.find(t))||void 0===r?void 0:r.parent;n?e.copy(n.matrixWorld):e.identity()}traverseMaterial(t){this.traverseEntity((e=>{if(e instanceof Ld)if(Array.isArray(e.material))for(let r=0;r<e.material.length;r++)e.material[r]instanceof Xf&&t(e.material[r]);else e.material instanceof Xf&&t(e.material)}))}updateViewPlaneSize(t,e){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.traverseConcreteEntity((n=>{n instanceof Ev&&n.setViewplaneSize(t,e,r)}))}initializeSplatViewer(t){this.splatViewer=new ty({scene:this,renderer:t}),this.reloadSplats()}reloadSplats(){var t;null===(t=this.splatViewer)||void 0===t||t.reloadSplats()}};async function iy(t){if(ey){let e,r={attributeIDs:ey.defaultAttributeIDs,attributeTypes:ey.defaultAttributeTypes,useUniqueIDs:!1};try{e=await ey.decodeGeometry(new Int8Array(t).buffer,r)}catch(Bi){console.error(Bi)}if(e)return{index:e.index?{array:e.index.array}:void 0,attributes:Object.entries(e.attributes).map((t=>{let[e,r]=t;return{name:e,itemSize:r.itemSize,array:r.array}}))}}return null}async function ay(t,e){let[r,n]=ha(Eo.deserialize(new Uint8Array(t)));Hl(r);let i=[];r.scene.objects.traverse(((t,e)=>{"Mesh"===e.type&&"NonParametricGeometry"===e.geometry.type&&void 0!==e.geometry.data.draco&&i.push(e)})),i.length&&await(ey||(ey=new s).setDecoderPath("https://www.gstatic.com/draco/versioned/decoders/1.5.2/").preload(),ey.decoderPending);for(let a of i){let t=await iy(ua(a.geometry.data.draco));if(t){t.index&&(a.geometry.data.index={array:t.index.array,itemSize:1,normalized:!1,type:"Uint32Array"});let e={};t.attributes.forEach((t=>{let{name:r,array:n,itemSize:i}=t;e[r]={array:n,itemSize:i,type:"Float32Array",normalized:!1}})),a.geometry.data.attributes=e,a.geometry.data.draco=void 0}}return e&&e(r),n.result().data}function oy(t){let e=new Set;return t.traverse((t=>{if(t instanceof gm)if(Z(t.material))t.material.forEach((t=>{let r=t;e.has(r)||e.add(r)}));else{let r=t.material;e.has(r)||e.add(r)}})),e.forEach((t=>{if(t instanceof Array)return;let e=t.onBeforeCompile.bind(t);if(function(t){return t.getLayersOfType("transmission").length>0}(t)){Object.assign(t,{isMeshStandardMaterial:!0,isMeshPhysicalMaterial:!0,transmission:1,attenuationColor:new n.Color,specularColor:new n.Color});let r=0;t.onBeforeCompile=(i,a)=>{e&&e(i,a),i.uniforms=Object.assign({},n.ShaderLib.physical.uniforms,i.uniforms),t.getLayersOfType("transmission").forEach((e=>{if(i.uniforms.transmissionSamplerMap.value){let r=e.color;r&&(r.transmissionSamplerMap.value=i.uniforms.transmissionSamplerMap.value,r.transmissionSamplerSize.value=i.uniforms.transmissionSamplerSize.value,r.aspectRatio.value=function(t,e){return t>=e?new n.Vector2(e/t,1):new n.Vector2(1,t/e)}(window.innerWidth,window.innerHeight),t.defines.IS_THREEJS_EXPORT=!0)}else r++,r<2&&(t.needsUpdate=!0)}))}}else(function(t){let e=0;for(let r of t.layers){if("displace"!==r.data.type&&r.data.isMask)return!0;if("light"!==r.type&&"fresnel"!==r.type){let t=r.uniforms["f"+r.id+"_alpha"];t&&(e+=(1-e)*t.value)}}return e<1})(t)||(t.onBeforeCompile=(r,n)=>{e&&e(r,n),t.transparent=!1})})),t}function sy(t){Object.values(t.shared.materials).forEach((t=>{ly(t)})),t.scene.objects.traverse(((t,e)=>{"material"in e?ly(e.material):"materials"in e&&e.materials.forEach((t=>{ly(t)}))}))}function ly(t){if("string"==typeof t)return;let e=[];t.layers.forEach(((t,r)=>{"outline"===t.type&&e.push(r)})),e.reverse().forEach((e=>{t.layers.delete(e)})),e.length&&console.warn("The Spline Loader currently does not support the outline layer.")}var hy=v(z(),1);var cy="The SplineLoader only accepts .splinecode files that are generated from Spline export panel.",uy=class extends n.Loader{load(t,e,r){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:console.error,a=new n.FileLoader(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),t.endsWith(".spline")?console.warn(cy+" The .spline files are only meant to be used by the Editor."):t.endsWith(".splinecode")||console.warn(cy),a.load(t,(async t=>{try{if("string"==typeof t)throw new Error("The .spline file is not binary!");let r=await this.parse(t);e(r)}catch(Ho){i(Ho)}}),r,i)}async parse(t){let e=await ay(t,sy);e.version&&(0,hy.default)(e.version,"0.9.526")>0&&console.warn("Your .splinecode file is more recent than the library. Please upgrade @splinetool/loader to the latest version."),await Promise.all([Dm(e)&&Qu(),Ym(e)&&om()].filter(Boolean));let r=new mm(e.shared);Object.values(r.getMaterials()).forEach((t=>Object.assign(t,{isAsset:!0})));let n=new ny(e.scene,r),a=n.activeCamera;return a&&Object.assign(a,{makeDefault:!0}),n=function(t){let e=[];return t.traverse((t=>{t instanceof dv&&e.push(t)})),e.forEach((e=>{let r=e.object,n=[...e.children.map((t=>{let e;if(t.updateMatrix(),void 0!==t.geometry)try{e=t.geometry.clone().applyMatrix4(t.matrix)}catch(r){console.error(r)}return void 0!==e&&t.matrix.determinant()<0&&function(t){let e;if(t.index)for(let r=0;r<t.index.array.length;r+=3)e=t.index.array[r],t.index.array[r]=t.index.array[r+2],t.index.array[r+2]=e}(e),e})).filter((t=>void 0!==t))];if(!e.parameters.hideBase&&r instanceof Ld&&n.unshift(r.geometry),n.length){let t=i(n);r instanceof Ld&&(r.geometry=t)}e.removeFromParent(),r.setFromClonerState(null,{scene:t,shared:vm})})),t}(n),n=oy(n),n=function(t){return t.traverse((t=>{if("Camera"===t.type){let e=t;e.type=e.cameraType}})),t}(n),n=function(t){let e=[],r=function(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=n>0?t+n:t;return e.includes(i)?r(t,n+1):i};return t.traverse((t=>{if(e.includes(t.name)){let e=t.name,n=r(t.name);if(t.name=n,t.isMesh){let r=t;r.material instanceof Array?r.material.forEach((t=>{t.name=t.name.replace(e,n)})):r.material.isAsset||(r.material.name=r.material.name.replace(e,n))}}e.push(t.name)})),t}(n),n=function(t){return t.traverse((t=>{t.matrixAutoUpdate=!0})),t}(n),n=function(t){return t.traverseMaterial((t=>{t.needsJitter=!1})),t}(n),n}},dy=r(467);function py(t){const e=(0,dy.F)(uy,t);return(0,dy.D)(e)}}}]);
//# sourceMappingURL=471.f29548e2.chunk.js.map